/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <math.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int sub_401000();
int sub_40101B();
void sub_40114A();
// __int64 __usercall sub_40115F@<edx:eax>(__int64 result@<edx:eax>, __int16@<cx>, __int16@<bp>, __int16@<di>);
void __stdcall __noreturn start(int, int, int, int);
LRESULT __stdcall sub_4012AF(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);

//-------------------------------------------------------------------------
// Data declarations

WCHAR ClassName[] = L"DEMODEMO"; // idb
WCHAR WindowName[] = L" "; // idb
WCHAR Text = 83u; // idb
BITMAPINFO bmi = { { 40u, 320, 200, 1u, 32u, 0u, 0u, 0, 0, 0u, 0u }, { { 0u, 0u, 0u, 0u } } }; // idb
WNDCLASSW WndClass = { 0u, &sub_4012AF, 0, 0, NULL, NULL, NULL, (HBRUSH)2, NULL, L"DEMODEMO" }; // idb
HWND hWnd = NULL; // idb
HDC hDC = NULL; // idb
MSG Msg = { NULL, 0u, 0u, 0, 0u, { 0, 0 } }; // idb
struct tagRECT Rect = { 0, 0, 0, 0 }; // idb
void *lpBits = NULL; // idb
int dword_4020DA = 0; // weak
int dword_4020DE = 0; // weak
HGLOBAL hMem = NULL; // idb
_UNKNOWN unk_4020EE; // weak
_UNKNOWN unk_4020F4; // weak
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern HMODULE (__stdcall *GetModuleHandleW)(LPCWSTR lpModuleName);
// extern HGLOBAL (__stdcall *GlobalAlloc)(UINT uFlags, SIZE_T dwBytes);
// extern HGLOBAL (__stdcall *GlobalFree)(HGLOBAL hMem);
// extern HWND (__stdcall *CreateWindowExW)(DWORD dwExStyle, LPCWSTR lpClassName, LPCWSTR lpWindowName, DWORD dwStyle, int X, int Y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam);
// extern LRESULT (__stdcall *DefWindowProcW)(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// extern LRESULT (__stdcall *DispatchMessageW)(const MSG *lpMsg);
// extern BOOL (__stdcall *GetClientRect)(HWND hWnd, LPRECT lpRect);
// extern HDC (__stdcall *GetDC)(HWND hWnd);
// extern HCURSOR (__stdcall *LoadCursorW)(HINSTANCE hInstance, LPCWSTR lpCursorName);
// extern HICON (__stdcall *LoadIconW)(HINSTANCE hInstance, LPCWSTR lpIconName);
// extern int (__stdcall *MessageBoxW)(HWND hWnd, LPCWSTR lpText, LPCWSTR lpCaption, UINT uType);
// extern BOOL (__stdcall *PeekMessageW)(LPMSG lpMsg, HWND hWnd, UINT wMsgFilterMin, UINT wMsgFilterMax, UINT wRemoveMsg);
// extern void (__stdcall *PostQuitMessage)(int nExitCode);
// extern ATOM (__stdcall *RegisterClassW)(const WNDCLASSW *lpWndClass);
// extern int (__stdcall *ReleaseDC)(HWND hWnd, HDC hDC);
// extern BOOL (__stdcall *TranslateMessage)(const MSG *lpMsg);
// extern int (__stdcall *StretchDIBits)(HDC hdc, int xDest, int yDest, int DestWidth, int DestHeight, int xSrc, int ySrc, int SrcWidth, int SrcHeight, const void *lpBits, const BITMAPINFO *lpbmi, UINT iUsage, DWORD rop);


//----- (00401000) --------------------------------------------------------
int sub_401000()
{
  _BYTE *v0; // edx
  unsigned __int8 v1; // bl
  int result; // eax
  unsigned __int8 *v3; // edx

  v0 = (_BYTE *)dword_4020DA;
  v1 = 0;
  do
  {
    LOBYTE(result) = v1 >> 1;
    *v0 = v1 >> 1;
    v3 = v0 + 1;
    *v3++ = v1;
    *v3 = v1;
    v0 = v3 + 2;
    ++v1;
  }
  while ( v1 );
  return result;
}
// 4020DA: using guessed type int dword_4020DA;

//----- (0040101B) --------------------------------------------------------
int sub_40101B()
{
  _DWORD *v0; // edi
  __int64 v1; // rax
  double v2; // st5
  __int16 v3; // bp
  __int16 v4; // cx
  __int16 v5; // di
  __int64 v6; // rax
  __int16 v7; // cx
  char v8; // cf
  char v10; // [esp-29h] [ebp-29h]
  __int16 v11; // [esp-28h] [ebp-28h]
  __int16 v12; // [esp-26h] [ebp-26h]
  __int16 v13; // [esp-24h] [ebp-24h]

  __asm { finit }
  v0 = (char *)lpBits + 254720;
  unk_4020EE += 2;
  LOWORD(v1) = 320;
  WORD2(v1) = -200;
  do
  {
    LOWORD(v1) = -(__int16)v1;
    v13 = WORD2(v1);
    do
    {
      v12 = v1;
      v2 = (double)(__int16)v1;
      sub_40114A();
      sub_40114A();
      sub_40114A();
      unk_4020F4 = (__int16)-fabs((double)320);
      *((_WORD *)&unk_4020F4 + 1) = (__int16)v2;
      *((_WORD *)&unk_4020F4 + 2) = (__int16)(double)v13;
      LOBYTE(v1) = 127;
      v11 = (__int16)v0;
      v3 = *(_WORD *)((char *)&unk_4020F4 - 7);
      v4 = 0;
      v5 = v3;
      --unk_4020F4;
      do
      {
        v3 += *((_WORD *)&unk_4020F4 + 1);
        v5 += *((_WORD *)&unk_4020F4 + 2);
        BYTE1(v1) = -28;
        v6 = sub_40115F(v1, unk_4020F4 + v4, v3, v5);
        v10 = BYTE5(v6);
        BYTE1(v6) = (*((_BYTE *)&unk_4020F4 - 5) + 39) & 0xF8;
        v1 = sub_40115F(v6, v7, v3, v5);
        BYTE5(v1) += v10 + v8;
        if ( !BYTE5(v1) )
          break;
        LOBYTE(v1) = v1 - 1;
      }
      while ( (_BYTE)v1 );
      LOWORD(v0) = v11;
      *v0++ = *(_DWORD *)(dword_4020DA + 8 * (unsigned __int8)v1);
      LOWORD(v1) = v12 + 2;
    }
    while ( v12 != 318 );
    v0 -= 640;
    WORD2(v1) = v13 + 2;
  }
  while ( v13 != 198 );
  GetClientRect(hWnd, &Rect);
  return StretchDIBits(hDC, 0, 0, Rect.right, Rect.bottom, 0, 0, 320, 200, lpBits, &bmi, 0, 0xCC0020u);
}
// 40109F: variable 'v1' is possibly undefined
// 401092: variable 'v4' is possibly undefined
// 4010AF: variable 'v7' is possibly undefined
// 4010B6: variable 'v8' is possibly undefined
// 4020DA: using guessed type int dword_4020DA;

//----- (0040114A) --------------------------------------------------------
void sub_40114A()
{
  __asm
  {
    fld     st
    fmul    st, st(3)
    fxch    st(2)
    fld     st
    fmul    st, st(5)
    faddp   st(3), st
    fmul    st, st(3)
    fxch    st(1)
    fmul    st, st(4)
    fsubp   st(1), st
  }
}
// 40114A: inconsistent fpu stack

//----- (0040115F) --------------------------------------------------------
__int64 __usercall sub_40115F@<edx:eax>(__int64 result@<edx:eax>, __int16 a2@<cx>, __int16 a3@<bp>, __int16 a4@<di>)
{
  __int16 v4; // bx

  LOBYTE(v4) = a3;
  HIBYTE(v4) = BYTE1(result) + HIBYTE(a3);
  BYTE4(result) = a4;
  BYTE5(result) = BYTE1(result) + HIBYTE(a4);
  WORD2(result) &= a2 & v4;
  BYTE5(result) &= BYTE1(result);
  return result;
}

//----- (00401172) --------------------------------------------------------
void __stdcall __noreturn start(int a1, int a2, int a3, int a4)
{
  char *v4; // eax
  int v5; // eax
  HWND Window; // eax

  v4 = (char *)GlobalAlloc(0, 0x7A120u);
  if ( !v4 )
    goto LABEL_7;
  hMem = v4;
  dword_4020DA = (int)v4;
  lpBits = v4 + 2000;
  WndClass.hInstance = GetModuleHandleW(0);
  WndClass.hIcon = LoadIconW(0, (LPCWSTR)0x7F00);
  WndClass.hCursor = LoadCursorW(0, (LPCWSTR)0x7F00);
  LOWORD(v5) = RegisterClassW(&WndClass);
  if ( !v5 )
    goto LABEL_7;
  Window = CreateWindowExW(0, ClassName, WindowName, 0x10CF0000u, 0x8000, 0x8000, 640, 500, 0, 0, WndClass.hInstance, 0);
  if ( Window )
  {
    hWnd = Window;
    hDC = GetDC(Window);
    sub_401000();
    sub_40101B();
    while ( 1 )
    {
      PeekMessageW(&Msg, 0, 0, 0, 1u);
      if ( Msg.message == 18 )
        break;
      TranslateMessage(&Msg);
      DispatchMessageW(&Msg);
      sub_40101B();
      ++dword_4020DE;
    }
  }
  else
  {
LABEL_7:
    MessageBoxW(0, &Text, 0, 0x10u);
  }
  ReleaseDC(hWnd, hDC);
  GlobalFree(hMem);
  ExitProcess(Msg.wParam);
}
// 4011D9: variable 'v5' is possibly undefined
// 4020DA: using guessed type int dword_4020DA;
// 4020DE: using guessed type int dword_4020DE;

//----- (004012AF) --------------------------------------------------------
LRESULT __stdcall sub_4012AF(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
{
  if ( Msg == 2 )
  {
    PostQuitMessage(0);
    return 0;
  }
  else
  {
    if ( Msg == 5 && (unsigned int)dword_4020DE >= 0xA )
      sub_40101B();
    return DefWindowProcW(hWnd, Msg, wParam, lParam);
  }
}
// 4020DE: using guessed type int dword_4020DE;

// nfuncs=6 queued=6 decompiled=6 lumina nreq=0 worse=0 better=0
// ALL OK, 6 function(s) have been successfully decompiled
