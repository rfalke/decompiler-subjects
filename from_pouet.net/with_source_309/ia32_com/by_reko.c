// subject_code.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0C00:0100: void fn0C00_0100(Register byte ah, Register (ptr16 Eq_4) ds)
void fn0C00_0100(byte ah, struct Eq_4 * ds)
{
	Eq_5 Top_3 = 0;
	__syscall<byte>(0x10);
	cui16 cx_10;
	for (cx_10 = 0x04B0; cx_10 != 0x00; --cx_10)
		ah = SLICE((uint16) fn0C00_0274(cx_10 << 0x01, ah), byte, 8);
	while (true)
	{
		ui16 cx_140 = 0x04B0;
		do
		{
			bool v50_358;
			ui16 si_29 = cx_398 << 0x01;
			if (ds->b029F < 0x04)
			{
				byte v12_37 = ds->a22A2[0].b0000[cx_398].b0000 - 0x01;
				ds->a22A2[0].b0000[cx_398].b0000 = v12_37;
				v50_358 = v12_37 != 0x00;
			}
			else
			{
				byte v15_34 = ds->a22A2[0].b0000[cx_398].b0000 + 0x01;
				ds->a22A2[0].b0000[cx_398].b0000 = v15_34;
				v50_358 = v15_34 != 0x00;
			}
			if (!v50_358)
				fn0C00_0274(cx_398 << 0x01, ah);
			ds->a32A2[0].b0000[cx_398].b0000 = ds->a32A2[0].b0000[cx_398].b0000 + (byte) (((((ds->a32A2))[0].b0000))[cx_398].b0000 < 0x28);
			__fninit();
			struct Eq_84 * Top_66 = Top_3 - 1;
			Top_66->r0000 = 3.141592653589793;
			Top_66->r0000 *= (real64) ds->t029D;
			Top_66->r0000 /= (real64) ds->w029B;
			real64 v18_70 = Top_66->r0000;
			Top_66->r0000 = cos(v18_70);
			Top_66->rFFFFFFFF = sin(v18_70);
			Top_66->rFFFFFFFE = Top_66->r0000;
			Top_66->rFFFFFFFE *= (real64) ds->a12A2[0][cx_398];
			Top_66->rFFFFFFFD = Top_66->rFFFFFFFF;
			Top_66->rFFFFFFFD *= (real64) ds->a02A2[0][cx_398];
			Top_66->rFFFFFFFD -= Top_66->rFFFFFFFE;
			ds->a42A2[0][cx_398] = (int16) Top_66->rFFFFFFFD;
			real64 v21_84 = Top_66->rFFFFFFFD;
			Top_66->rFFFFFFFD = Top_66->rFFFFFFFF;
			Top_66->rFFFFFFFF = v21_84;
			Top_66->rFFFFFFFD *= (real64) ds->a12A2[0][cx_398];
			Top_66->rFFFFFFFC = Top_66->r0000;
			Top_66->rFFFFFFFC *= (real64) ds->a02A2[0][cx_398];
			Top_66->rFFFFFFFC += Top_66->rFFFFFFFD;
			ds->a52A2[0][cx_398] = (int16) Top_66->rFFFFFFFC;
			ds->t62A2 = (int16) (ds->a42A2[0][cx_398] *s32 100 /16 (((ds->a22A2))[0].b0000)[cx_398]) + 0xA0;
			ds->t62A4 = (int16) (ds->a52A2[0][cx_398] *s32 100 /16 (((ds->a22A2))[0].b0000)[cx_398]) + 100;
			Eq_290 ax_115 = (word16) ds->t62A2 + ds->t62A4 *s 0x0140;
			Top_3 = Top_66 - (struct Eq_300 *) 4;
			ah = SLICE(ax_115, byte, 8);
			if (ds->t62A2 <= 0x013F && ds->t62A4 <= 199)
			{
				byte al_121 = ds->a32A2[0].b0000[cx_398].b0000;
				0x9000->*ax_115 = al_121;
				if (ds->b02A1 == 0x01)
				{
					0x9000->*((word16) ax_115 + 1) = al_121;
					0x9000->*((word16) ax_115 + 320) = al_121;
					0x9000->*((word16) ax_115 + 0x0141) = al_121;
				}
			}
			cx_140 = cx_398 - 0x01;
			byte ch_343 = SLICE(cx_140, byte, 8);
			cx_398 = cx_140;
		} while (cx_140 != 0x00);
		if (ds->b029F != 0x02 && ds->b029F != 0x03)
		{
			if (ds->b029F >= 0x06)
			{
				Eq_96 v36_158 = ds->t029D - 0x01;
				ds->t029D = v36_158;
				if (v36_158 == 0x00)
					ds->t029D.u0 = 0x0168;
			}
		}
		else
		{
			ds->t029D = (word16) ds->t029D + 1;
			if (ds->t029D >= 0x0169)
				ds->t029D.u0 = 0x01;
		}
		do
			;
		while ((__in<byte>(0x03DA) & 0x08) == 0x00);
		byte bl_170 = 0x1E;
		struct Eq_407 Eq_330::* di_172 = &Eq_330::t0000;
		cui16 dx_205 = 0x05;
		do
		{
			do
			{
				uint16 cx_192 = SEQ(ch_343, 0x28);
				do
				{
					byte dl_183 = (byte) dx_399;
					byte al_180 = (0x9000->*di_172).b19AA;
					if (al_180 != 0x00)
						al_180 += dl_183;
					(0x9000->*di_172).b0000 = al_180;
					--cx_192;
					dx_205 = dx_399;
					di_172 = &di_172->b0000 + 1;
					ch_343 = SLICE(cx_192, byte, 8);
				} while (cx_192 != 0x00);
				di_172 = &di_172->b0000 + 0x0118;
				--bl_170;
				dx_399 = dx_205;
			} while (bl_170 != 0x00);
			bl_170 = 0x1E;
			++di_172;
			dx_205 = dx_399 - 0x01;
			dx_400 = dx_205;
		} while (dx_399 != 0x01);
		uint32 size_260 = (cx_192 - 0x01) *32 0x02;
		memcpy(cx_398 << 0x01, cx_398 << 0x01, size_260);
		Eq_470 di_263 = si_29 + (word16) size_260;
		word16 cx_270;
		for (cx_270 = ~0x00; cx_270 != 0x00; --cx_270)
		{
			0x9000->*di_263 = 0x00;
			di_263 = (word16) di_263 + 2;
		}
		byte al_277;
		if (bios_kbd_check_keystroke(out al_277, out ah))
			break;
		byte v40_284 = ds->b02A0 + 0x01;
		ds->b02A0 = v40_284;
		if (v40_284 == 0x00)
		{
			++ds->b029F;
			ds->b02A1 = -ds->b02A1;
			if (ds->b029F >= 0x08)
				ds->b029F -= 0x08;
		}
	}
	bios_video_set_mode(0x03);
}

// 0C00:026C: Register byte fn0C00_026C(Register byte ah, Register int16 bx, Register out Eq_540 dxOut)
// Called from:
//      fn0C00_0274
byte fn0C00_026C(byte ah, int16 bx, union Eq_540 & dxOut)
{
	Eq_541 dx_ax_8 = (uint32) SEQ(ah, __in<byte>(0x40));
	dxOut = (int16) (dx_ax_8 % bx) + 0x01;
	return SLICE((int16) (dx_ax_8 /16 bx), byte, 8);
}

// 0C00:0274: Register byte fn0C00_0274(Sequence (ptr32 Eq_16) ds_si, Register byte ah)
// Called from:
//      fn0C00_0100
byte fn0C00_0274(struct Eq_16 * ds_si, byte ah)
{
	ds_si->b32A2 = 0x0F;
	word16 dx_10;
	byte ah_18 = SLICE((uint16) fn0C00_026C(ah, 100, out dx_10), byte, 8);
	ds_si->w02A2 = dx_10 - 0x32;
	word16 dx_20;
	byte ah_29 = SLICE((uint16) fn0C00_026C(ah_18, 100, out dx_20), byte, 8);
	ds_si->w12A2 = dx_20 - 0x32;
	word16 dx_31;
	uint16 ax_30 = (uint16) fn0C00_026C(ah_29, 0xFE, out dx_31);
	ds_si->w22A2 = dx_31;
	return SLICE(ax_30, byte, 8);
}

