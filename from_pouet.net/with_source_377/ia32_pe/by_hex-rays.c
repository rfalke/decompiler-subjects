/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void sub_401000();
int sub_401017();
int sub_401088();
void __stdcall __noreturn start(int, int, int, int);
LRESULT __stdcall sub_401359(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);

//-------------------------------------------------------------------------
// Data declarations

WCHAR ClassName[] = L"DEMODEMO"; // idb
WCHAR WindowName[] = L"<"; // idb
WCHAR Text[] = L"Startup failed."; // idb
BITMAPINFO bmi = { { 40u, 320, 200, 1u, 32u, 0u, 0u, 0, 0, 0u, 0u }, { { 0u, 0u, 0u, 0u } } }; // idb
WNDCLASSW WndClass = { 0u, &sub_401359, 0, 0, NULL, NULL, NULL, (HBRUSH)2, NULL, L"DEMODEMO" }; // idb
HWND hWnd = NULL; // idb
HDC hDC = NULL; // idb
MSG Msg = { NULL, 0u, 0u, 0, 0u, { 0, 0 } }; // idb
struct tagRECT Rect = { 0, 0, 0, 0 }; // idb
void *lpBits = NULL; // idb
int dword_402104 = 0; // weak
int dword_402108 = 0; // weak
HGLOBAL hMem = NULL; // idb
int dword_402118 = 0; // weak
int dword_40211C = 0; // weak
_UNKNOWN unk_402136; // weak
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern HMODULE (__stdcall *GetModuleHandleW)(LPCWSTR lpModuleName);
// extern HGLOBAL (__stdcall *GlobalAlloc)(UINT uFlags, SIZE_T dwBytes);
// extern HGLOBAL (__stdcall *GlobalFree)(HGLOBAL hMem);
// extern HWND (__stdcall *CreateWindowExW)(DWORD dwExStyle, LPCWSTR lpClassName, LPCWSTR lpWindowName, DWORD dwStyle, int X, int Y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam);
// extern LRESULT (__stdcall *DefWindowProcW)(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// extern LRESULT (__stdcall *DispatchMessageW)(const MSG *lpMsg);
// extern BOOL (__stdcall *GetClientRect)(HWND hWnd, LPRECT lpRect);
// extern HDC (__stdcall *GetDC)(HWND hWnd);
// extern HCURSOR (__stdcall *LoadCursorW)(HINSTANCE hInstance, LPCWSTR lpCursorName);
// extern HICON (__stdcall *LoadIconW)(HINSTANCE hInstance, LPCWSTR lpIconName);
// extern int (__stdcall *MessageBoxW)(HWND hWnd, LPCWSTR lpText, LPCWSTR lpCaption, UINT uType);
// extern BOOL (__stdcall *PeekMessageW)(LPMSG lpMsg, HWND hWnd, UINT wMsgFilterMin, UINT wMsgFilterMax, UINT wRemoveMsg);
// extern void (__stdcall *PostQuitMessage)(int nExitCode);
// extern ATOM (__stdcall *RegisterClassW)(const WNDCLASSW *lpWndClass);
// extern int (__stdcall *ReleaseDC)(HWND hWnd, HDC hDC);
// extern BOOL (__stdcall *TranslateMessage)(const MSG *lpMsg);
// extern int (__stdcall *SetStretchBltMode)(HDC hdc, int mode);
// extern int (__stdcall *StretchDIBits)(HDC hdc, int xDest, int yDest, int DestWidth, int DestHeight, int xSrc, int ySrc, int SrcWidth, int SrcHeight, const void *lpBits, const BITMAPINFO *lpbmi, UINT iUsage, DWORD rop);


//----- (00401000) --------------------------------------------------------
void sub_401000()
{
  _BYTE *v0; // edx
  char v1; // bl
  _BYTE *v2; // edx

  v0 = (_BYTE *)dword_402104;
  v1 = 0;
  do
  {
    *v0 = v1;
    v2 = v0 + 1;
    *v2++ = v1;
    *v2 = v1;
    v0 = v2 + 2;
    ++v1;
  }
  while ( v1 );
}
// 402104: using guessed type int dword_402104;

//----- (00401017) --------------------------------------------------------
int sub_401017()
{
  int v0; // ecx
  _BYTE *v1; // esi
  _BYTE *v2; // edi
  int result; // eax
  int v4; // ebx
  int v5; // edi
  char v6; // dl
  __int16 v7; // [esp-2h] [ebp-2h]

  v0 = 3840;
  v1 = &unk_402136;
  v2 = (_BYTE *)dword_402118;
  do
  {
    *v2++ = *v1++;
    --v0;
  }
  while ( v0 );
  result = 0;
  v4 = 0;
  HIWORD(v5) = 0;
  do
  {
    v6 = -5;
    if ( (unsigned __int8)v4 <= 0xFBu && (unsigned __int8)v4 >= 4u )
    {
      v7 = v4;
      LOBYTE(v4) = (unsigned __int8)v4 >> 2;
      BYTE1(v4) >>= 2;
      LOWORD(v5) = v4 + (BYTE1(v4) << 6);
      LOWORD(v4) = v7;
      if ( (*(_BYTE *)(dword_402118 + v5 - 8644) & 0xFB) == 0 )
        v6 = 4 * (((unsigned __int16)(v7 & 0xF0F) >> 8) + (v7 & 0xF));
    }
    *(_BYTE *)(dword_40211C + v4) = v6;
    LOWORD(v4) = v4 - 1;
  }
  while ( (_WORD)v4 );
  return result;
}
// 402118: using guessed type int dword_402118;
// 40211C: using guessed type int dword_40211C;

//----- (00401088) --------------------------------------------------------
int sub_401088()
{
  __int16 v0; // cx
  int v5; // edx
  __int16 v6; // bp
  char v8; // al
  int v10; // edi
  int v11; // ecx
  unsigned __int8 *v12; // esi
  _DWORD *v13; // edi
  unsigned __int8 v14; // al

  v0 = 0;
  _EBX = 1024;
  do
  {
    _ESI = (char *)&unk_402136;
    *(_WORD *)((char *)&unk_402136 + _EBX) += ++v0;
    __asm
    {
      fild    word ptr [esi+ebx]
      fidiv   word_402130
      fsincos
      fstp    dword ptr [esi+ebx+1Fh]
    }
    *(float *)&_ESI[_EBX + 31] = _ET1;
    __asm { fstp    dword ptr [esi+ebx+23h] }
    *(float *)&_ESI[_EBX + 35] = _ET1;
    LOBYTE(_EBX) = _EBX + 8;
  }
  while ( !__SETP__(_EBX, 0) );
  BYTE1(_EBX) = 3;
  v5 = 0;
  do
  {
    v6 = 128;
LABEL_5:
    _EDI = 1053;
    v8 = v5;
    LOBYTE(_EBX) = HIBYTE(v0);
    do
    {
      _ESI = &unk_402136;
      *(_WORD *)((char *)&unk_402136 + _EBX) = (char)(v8 + 0x80);
      v8 = BYTE1(v5);
      LOWORD(_EBX) = _EBX + 2;
      if ( __SETP__(_EBX, 0) )
        LOBYTE(_EBX) = 0;
      LOWORD(_EDI) = _EDI + 1;
    }
    while ( __SETP__(_EDI, 0) );
    *(_WORD *)((char *)&unk_402136 + _EBX) = v6;
    LOBYTE(_EBX) = 0;
    do
    {
      __asm { fild    word ptr [esi+ebx] }
      LOWORD(_EBX) = _EBX + 2;
    }
    while ( !__SETP__(_EBX, 0) );
    do
    {
      __asm
      {
        fld     st(1)
        fmul    dword ptr [esi+edi]
        fld     st(3)
        fmul    dword ptr [esi+edi+4]
        faddp   st(1), st
        fxch    st(2)
        fmul    dword ptr [esi+edi+4]
        fxch    st(3)
        fmul    dword ptr [esi+edi]
        fsubp   st(3), st
        fxch    st(1)
      }
      LOWORD(_EDI) = _EDI + 8;
    }
    while ( __SETP__(_EDI, 0) );
    __asm
    {
      fiadd   word_402132
      fidiv   word_402134
      fdiv    st(2), st
      fdivp   st(1), st
      fistp   dword ptr [esi+ebx]
    }
    v10 = 320 * *(_DWORD *)((char *)&unk_402136 + _EBX);
    __asm { fistp   dword ptr [esi+ebx] }
    *(_BYTE *)(dword_402118 + *(_DWORD *)((char *)&unk_402136 + _EBX) + v10 + 32160) += *(_BYTE *)(dword_40211C + v5) >> 5;
    do
    {
      LOWORD(v5) = v5 + 1;
      if ( (_WORD)v5 )
        goto LABEL_5;
      v6 = -v6;
    }
    while ( v6 < 0 );
    HIBYTE(v0) += 2;
  }
  while ( !__SETP__(HIBYTE(v0), 0) );
  v11 = 64000;
  v12 = (unsigned __int8 *)(dword_402118 + 1280);
  v13 = (char *)lpBits + 1280;
  do
  {
    v14 = *v12;
    *v12 = 0;
    *v13 = *(_DWORD *)(dword_402104 + 4 * v14);
    ++v12;
    ++v13;
    --v11;
  }
  while ( v11 );
  GetClientRect(hWnd, &Rect);
  return StretchDIBits(hDC, 0, 0, Rect.right, Rect.bottom, 0, 0, 320, 200, lpBits, &bmi, 0, 0xCC0020u);
}
// 4010A6: inconsistent fpu stack
// 402104: using guessed type int dword_402104;
// 402118: using guessed type int dword_402118;
// 40211C: using guessed type int dword_40211C;

//----- (004011F5) --------------------------------------------------------
void __stdcall __noreturn start(int a1, int a2, int a3, int a4)
{
  char *v4; // eax
  int v5; // eax
  HWND Window; // eax

  v4 = (char *)GlobalAlloc(0, 0xF4240u);
  if ( !v4 )
    goto LABEL_7;
  hMem = v4;
  dword_402104 = (int)v4;
  lpBits = v4 + 2000;
  dword_40211C = (int)(v4 + 402000);
  dword_402118 = (int)(v4 + 602000);
  WndClass.hInstance = GetModuleHandleW(0);
  WndClass.hIcon = LoadIconW(0, (LPCWSTR)0x7F00);
  WndClass.hCursor = LoadCursorW(0, (LPCWSTR)0x7F00);
  LOWORD(v5) = RegisterClassW(&WndClass);
  if ( !v5 )
    goto LABEL_7;
  Window = CreateWindowExW(0, ClassName, WindowName, 0x10CF0000u, 0x8000, 0x8000, 540, 400, 0, 0, WndClass.hInstance, 0);
  if ( Window )
  {
    hWnd = Window;
    hDC = GetDC(Window);
    sub_401000();
    sub_401017();
    sub_401088();
    SetStretchBltMode(hDC, 4);
    while ( 1 )
    {
      PeekMessageW(&Msg, 0, 0, 0, 1u);
      if ( Msg.message == 18 )
        break;
      TranslateMessage(&Msg);
      DispatchMessageW(&Msg);
      sub_401088();
      ++dword_402108;
    }
  }
  else
  {
LABEL_7:
    MessageBoxW(0, Text, 0, 0x10u);
  }
  ReleaseDC(hWnd, hDC);
  GlobalFree(hMem);
  ExitProcess(Msg.wParam);
}
// 401270: variable 'v5' is possibly undefined
// 402104: using guessed type int dword_402104;
// 402108: using guessed type int dword_402108;
// 402118: using guessed type int dword_402118;
// 40211C: using guessed type int dword_40211C;

//----- (00401359) --------------------------------------------------------
LRESULT __stdcall sub_401359(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
{
  if ( Msg == 2 )
  {
    PostQuitMessage(0);
    return 0;
  }
  else
  {
    if ( Msg == 5 && (unsigned int)dword_402108 >= 0xA )
      sub_401088();
    return DefWindowProcW(hWnd, Msg, wParam, lParam);
  }
}
// 402108: using guessed type int dword_402108;

// nfuncs=5 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
