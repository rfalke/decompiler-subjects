/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int sub_401000();
int sub_401020();
void __stdcall __noreturn start(int a1, int a2, int a3, int a4);
LRESULT __stdcall sub_401324(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// HMODULE __stdcall GetModuleHandleW(LPCWSTR lpModuleName);
// HGLOBAL __stdcall GlobalAlloc(UINT uFlags, SIZE_T dwBytes);
// HGLOBAL __stdcall GlobalFree(HGLOBAL hMem);
// HWND __stdcall CreateWindowExW(DWORD dwExStyle, LPCWSTR lpClassName, LPCWSTR lpWindowName, DWORD dwStyle, int X, int Y, int nWidth, int nHeight, HWND hWndParent, HMENU hMenu, HINSTANCE hInstance, LPVOID lpParam);
// LRESULT __stdcall DefWindowProcW(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
// LRESULT __stdcall DispatchMessageW(const MSG *lpMsg);
// BOOL __stdcall GetClientRect(HWND hWnd, LPRECT lpRect);
// HDC __stdcall GetDC(HWND hWnd);
// HCURSOR __stdcall LoadCursorW(HINSTANCE hInstance, LPCWSTR lpCursorName);
// HICON __stdcall LoadIconW(HINSTANCE hInstance, LPCWSTR lpIconName);
// int __stdcall MessageBoxW(HWND hWnd, LPCWSTR lpText, LPCWSTR lpCaption, UINT uType);
// BOOL __stdcall PeekMessageW(LPMSG lpMsg, HWND hWnd, UINT wMsgFilterMin, UINT wMsgFilterMax, UINT wRemoveMsg);
// void __stdcall PostQuitMessage(int nExitCode);
// ATOM __stdcall RegisterClassW(const WNDCLASSW *lpWndClass);
// int __stdcall ReleaseDC(HWND hWnd, HDC hDC);
// BOOL __stdcall TranslateMessage(const MSG *lpMsg);
// int __stdcall SetStretchBltMode(HDC hdc, int mode);
// int __stdcall StretchDIBits(HDC hdc, int xDest, int yDest, int DestWidth, int DestHeight, int xSrc, int ySrc, int SrcWidth, int SrcHeight, const void *lpBits, const BITMAPINFO *lpbmi, UINT iUsage, DWORD rop);

//-------------------------------------------------------------------------
// Data declarations

WCHAR ClassName[] = L"DEMODEMO"; // idb
WCHAR WindowName[] = L"<"; // idb
WCHAR Text[] = L"Startup failed."; // idb
BITMAPINFO bmi = { { 40u, 320, 200, 1u, 32u, 0u, 0u, 0, 0, 0u, 0u }, { { 0u, 0u, 0u, 0u } } }; // idb
WNDCLASSW WndClass = { 0u, &sub_401324, 0, 0, NULL, NULL, NULL, (HBRUSH)2, NULL, L"DEMODEMO" }; // idb
HWND hWnd = NULL; // idb
HDC hDC = NULL; // idb
MSG Msg = { NULL, 0u, 0u, 0, 0u, { 0, 0 } }; // idb
struct tagRECT Rect = { 0, 0, 0, 0 }; // idb
void *lpBits = NULL; // idb
int dword_402104 = 0; // weak
int dword_402108 = 0; // weak
HGLOBAL hMem = NULL; // idb
int dword_40211C = 0; // weak
int dword_402120 = 0; // weak
__int16 word_40213A = 10432; // weak
__int16 word_40213C = 0; // weak
__int16 word_40213E = 0; // weak


//----- (00401000) --------------------------------------------------------
int sub_401000()
{
  _BYTE *v0; // edx
  unsigned __int8 v1; // bl
  int result; // eax
  _BYTE *v3; // edx

  v0 = (_BYTE *)dword_402104;
  v1 = 0;
  do
  {
    LOBYTE(result) = 2 * v1;
    if ( v1 >= 0x80u )
      *v0 = result;
    v3 = v0 + 1;
    *v3++ = result;
    *v3 = result;
    v0 = v3 + 2;
    ++v1;
  }
  while ( v1 );
  return result;
}
// 402104: using guessed type int dword_402104;

//----- (00401020) --------------------------------------------------------
int sub_401020()
{
  int v0; // ebx
  __int16 v1; // di
  char v2; // al
  __int16 v3; // dx
  __int16 v4; // ax
  char v5; // cl
  unsigned __int8 v6; // al
  char v7; // dh
  unsigned __int8 v8; // t0
  char v9; // dh
  int v10; // edi
  __int16 i; // si
  __int16 v12; // bp
  __int16 v13; // cx
  __int16 v14; // ax
  __int16 v15; // dx
  __int16 v16; // di
  char v17; // ah
  unsigned __int8 v18; // al
  int v20; // [esp-28h] [ebp-28h]
  __int16 v21; // [esp-24h] [ebp-24h]

  v0 = 0;
  --word_40213C;
  do
  {
    v1 = 1026;
    v2 = v0;
    v3 = -3072;
    do
    {
      word_40213E = (char)(v2 + 0x80);
      v3 -= (char)word_40213E * (char)word_40213E;
      __asm { fild    word_40213E }
      v2 = BYTE1(v0);
      ++v1;
    }
    while ( __SETP__(v1, 0) );
    __asm
    {
      fpatan
      fimul   word_40213A
      fistp   word_40213E
    }
    v4 = *(__int16 *)((char *)&word_40213A + 1) + word_40213E;
    v5 = 0;
    LOBYTE(v4) = HIBYTE(v3);
    v8 = HIBYTE(v3);
    v7 = ((unsigned __int16)(v4 & 0x707) >> 8) + (HIBYTE(v3) & 7);
    v6 = v8;
    v9 = v8 + v7;
    if ( v8 >= 0xEFu )
      v5 = 80;
    if ( v6 <= 0xEAu )
    {
      if ( (((unsigned __int16)(*(__int16 *)((char *)&word_40213A + 1) + word_40213E) >> 8) & 0x1Fu) <= 3 )
      {
        if ( v6 >= 0xE9u )
        {
          v9 = __ROR1__(v6, 3) - 101;
          --v5;
        }
        v9 -= 20;
      }
      if ( v6 <= 0xB4u )
        --v5;
    }
    *(_BYTE *)(v0 + dword_40211C) = v5;
    *(_BYTE *)(v0 + dword_402120) = v9 + 0x80;
    LOWORD(v0) = v0 + 1;
  }
  while ( (_WORD)v0 );
  v10 = 256000;
  for ( i = -100; i != 100; ++i )
  {
    v12 = -160;
    do
    {
      v21 = v12;
      v20 = v10;
      v13 = 32576;
      v14 = (char)(((2 * word_40213C) & 0x7F) - 64) * (char)(((2 * word_40213C) & 0x7F) - 64);
      HIBYTE(v14) -= 16;
      v15 = v14 ^ ((unsigned int)(char)(2 * word_40213C) >> 16);
      v14 *= 2;
      HIBYTE(v15) += 36;
      --HIBYTE(v14);
      v16 = v14;
      while ( 1 )
      {
        v13 += v12;
        v15 += i;
        v16 -= 160;
        BYTE1(v0) = HIBYTE(v16);
        LOBYTE(v0) = HIBYTE(v13);
        v17 = *(_BYTE *)(v0 + dword_40211C);
        v18 = *(_BYTE *)(v0 + dword_402120);
        if ( v17 < 0 )
          break;
        if ( v17 )
        {
          if ( HIBYTE(v15) >= (unsigned __int8)v17 )
          {
            if ( SHIBYTE(v15) >= v17 )
              v18 += v17;
            goto LABEL_22;
          }
        }
        else
        {
LABEL_22:
          if ( HIBYTE(v15) > 0x46u )
            break;
        }
      }
      *(_DWORD *)((char *)lpBits + v20) = *(_DWORD *)(dword_402104 + 4 * v18);
      v10 = v20 - 4;
      ++v12;
    }
    while ( v21 != 159 );
  }
  GetClientRect(hWnd, &Rect);
  return StretchDIBits(hDC, 0, 0, Rect.right, Rect.bottom, 0, 0, 320, 200, lpBits, &bmi, 0, 0xCC0020u);
}
// 401052: inconsistent fpu stack
// 402104: using guessed type int dword_402104;
// 40211C: using guessed type int dword_40211C;
// 402120: using guessed type int dword_402120;
// 40213A: using guessed type __int16 word_40213A;
// 40213C: using guessed type __int16 word_40213C;
// 40213E: using guessed type __int16 word_40213E;

//----- (004011C5) --------------------------------------------------------
void __stdcall __noreturn start(int a1, int a2, int a3, int a4)
{
  char *v4; // eax
  int v5; // eax
  HWND v6; // eax

  v4 = (char *)GlobalAlloc(0, 0xF4240u);
  if ( !v4 )
    goto LABEL_7;
  hMem = v4;
  dword_402104 = (int)v4;
  lpBits = v4 + 2000;
  dword_40211C = (int)(v4 + 402000);
  dword_402120 = (int)(v4 + 602000);
  WndClass.hInstance = GetModuleHandleW(0);
  WndClass.hIcon = LoadIconW(0, (LPCWSTR)0x7F00);
  WndClass.hCursor = LoadCursorW(0, (LPCWSTR)0x7F00);
  LOWORD(v5) = RegisterClassW(&WndClass);
  if ( !v5 )
    goto LABEL_7;
  v6 = CreateWindowExW(0, ClassName, WindowName, 0x10CF0000u, 0x8000, 0x8000, 540, 400, 0, 0, WndClass.hInstance, 0);
  if ( v6 )
  {
    hWnd = v6;
    hDC = GetDC(v6);
    sub_401000();
    sub_401020();
    SetStretchBltMode(hDC, 4);
    while ( 1 )
    {
      PeekMessageW(&Msg, 0, 0, 0, 1u);
      if ( Msg.message == 18 )
        break;
      TranslateMessage(&Msg);
      DispatchMessageW(&Msg);
      sub_401020();
      ++dword_402108;
    }
  }
  else
  {
LABEL_7:
    MessageBoxW(0, Text, 0, 0x10u);
  }
  ReleaseDC(hWnd, hDC);
  GlobalFree(hMem);
  ExitProcess(Msg.wParam);
}
// 401240: variable 'v5' is possibly undefined
// 402104: using guessed type int dword_402104;
// 402108: using guessed type int dword_402108;
// 40211C: using guessed type int dword_40211C;
// 402120: using guessed type int dword_402120;

//----- (00401324) --------------------------------------------------------
LRESULT __stdcall sub_401324(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
{
  LRESULT result; // eax

  if ( Msg == 2 )
  {
    PostQuitMessage(0);
    result = 0;
  }
  else
  {
    if ( Msg == 5 && (unsigned int)dword_402108 >= 0xA )
      sub_401020();
    result = DefWindowProcW(hWnd, Msg, wParam, lParam);
  }
  return result;
}
// 402108: using guessed type int dword_402108;

// nfuncs=4 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
