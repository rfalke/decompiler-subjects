// subject_code.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0C00:0100: void fn0C00_0100(Register (ptr16 Eq_3) ds)
void fn0C00_0100(struct Eq_3 * ds)
{
	Eq_4 Top_104 = 0;
	bios_video_set_mode(0x13);
	byte ah_14 = 0x00;
	ui16 cx_11;
	for (cx_11 = 0x0800; cx_11 != 0x00; --cx_11)
	{
		word16 si_340;
		ah_14 = SLICE((uint16) fn0C00_024E(ah_14, cx_11, ds, out si_340), byte, 8);
	}
	while (true)
	{
		ui16 cx_123;
		for (cx_123 = 0x0800; cx_123 != 0x00; --cx_123)
		{
			Eq_66 si_27 = cx_123 << 0x01;
			if (ds->b02FC < 0x04)
			{
				word16 v13_36 = ds->a2300[0][cx_123] - 0x01;
				ds->a2300[0][cx_123] = v13_36;
				if (v13_36 == 0x00)
					goto l0C00_0133;
			}
			else
			{
				ds->a2300[0][cx_123] = ds->a2300[0][cx_123] + 0x01;
				if (ds->a2300[0][cx_123] >= 200)
				{
l0C00_0133:
					fn0C00_024E(ah_14, cx_123, ds, out si_27);
				}
			}
			if (ds->*((word16) si_27 + 0x00003300) != 0x28)
				ds->*((word16) si_27 + 0x00003300) = (word16) (ds->*((word16) si_27 + 0x00003300)) + 1;
			ds->t630A = ds->*((word16) si_27 + 0x00003300);
			__fninit();
			struct Eq_86 * Top_81 = Top_104 - 1;
			Top_81->r0000 = 3.141592653589793;
			Top_81->r0000 *= (real64) ds->t02FA;
			Top_81->r0000 /= (real64) ds->w02F8;
			real64 v20_85 = Top_81->r0000;
			Top_81->r0000 = cos(v20_85);
			Top_81->rFFFFFFFF = sin(v20_85);
			Top_81->rFFFFFFFE = Top_81->r0000;
			Top_81->rFFFFFFFE *= (real64) (ds->*((word16) si_27 + 4864));
			Top_81->rFFFFFFFD = Top_81->rFFFFFFFF;
			Top_81->rFFFFFFFD *= (real64) (ds->*((word16) si_27 + 0x0300));
			Top_81->rFFFFFFFD -= Top_81->rFFFFFFFE;
			ds->*((word16) si_27 + 0x00004300) = (int16) Top_81->rFFFFFFFD;
			real64 v23_99 = Top_81->rFFFFFFFD;
			Top_81->rFFFFFFFD = Top_81->rFFFFFFFF;
			Top_81->rFFFFFFFF = v23_99;
			Top_81->rFFFFFFFD *= (real64) (ds->*((word16) si_27 + 4864));
			Top_81->rFFFFFFFC = Top_81->r0000;
			Top_81->rFFFFFFFC *= (real64) (ds->*((word16) si_27 + 0x0300));
			Top_81->rFFFFFFFC += Top_81->rFFFFFFFD;
			ds->*((word16) si_27 + 0x00005300) = (int16) Top_81->rFFFFFFFC;
			Top_104 = Top_81 - (struct Eq_248 *) 4;
			ah_14 = SLICE((uint16) fn0C00_027D(si_27, 0x9000, ds), byte, 8);
		}
		if (ds->b02FC != 0x02 && ds->b02FC != 0x03)
		{
			if (ds->b02FC >= 0x06)
			{
				Eq_98 v32_137 = ds->t02FA - 0x01;
				ds->t02FA = v32_137;
				if (v32_137 == 0x00)
					ds->t02FA.u0 = 0x0168;
			}
		}
		else
		{
			ds->t02FA = (word16) ds->t02FA + 1;
			if (ds->t02FA >= 0x0169)
				ds->t02FA.u0 = 0x01;
		}
		do
			;
		while ((__in<byte>(0x03DA) & 0x08) != 0x00);
		do
			;
		while ((__in<byte>(0x03DA) & 0x08) == 0x00);
		word16 bx_155 = 0x1E;
		word16 dx_156;
		struct Eq_341 Eq_3::* di_157 = Eq_3::a0000;
		for (dx_156 = 0x03; dx_156 != 0x00; --dx_156)
		{
			do
			{
				word16 cx_161;
				for (cx_161 = 0x28; cx_161 != 0x00; --cx_161)
				{
					byte al_165 = (0x9000->*di_157).b4BB4;
					if (al_165 != 0x00)
						al_165 += 0x34;
					(ds->*di_157).b630B = al_165;
					(0x9000->*di_157).b0000 = al_165;
					di_157 = &di_157->b0000 + 1;
				}
				di_157 = &di_157->b0000 + 0x0118;
				--bx_155;
			} while (bx_155 != 0x00);
			bx_155 = 0x1E;
			++di_157;
		}
		memcpy(A000:0000, 9000:0000, 0xFA00);
		word16 cx_242;
		word16 Eq_3::* di_243 = Eq_3::a0000;
		for (cx_242 = 0x7D00; cx_242 != 0x00; --cx_242)
		{
			0x9000->*di_243 = 0x00;
			++di_243;
		}
		byte al_250;
		if (!bios_kbd_check_keystroke(out al_250, out ah_14))
		{
			byte al_253;
			ah_14 = bios_kbd_get_keystroke(out al_253);
			if (al_253 == 0x1B)
			{
				bios_video_set_mode(0x03);
				return;
			}
			++ds->b02FC;
			if (ds->b02FC >= 0x02 && ds->b02FC >= 0x08)
				ds->b02FC = 0x00;
		}
	}
}

// 0C00:0240: Register byte fn0C00_0240(Register byte ah, Register out Eq_452 dxOut)
// Called from:
//      fn0C00_024E
byte fn0C00_0240(byte ah, union Eq_452 & dxOut)
{
	Eq_453 dx_ax_11 = (uint32) SEQ(ah + __in<byte>(0x40), __in<byte>(0x40));
	dxOut.u0 = (int16) (dx_ax_11 % 100);
	return SLICE((int16) (dx_ax_11 /16 100), byte, 8);
}

// 0C00:024E: Register byte fn0C00_024E(Register byte ah, Register ui16 cx, Register (ptr16 Eq_3) ds, Register out Eq_21 siOut)
// Called from:
//      fn0C00_0100
byte fn0C00_024E(byte ah, ui16 cx, struct Eq_3 * ds, union Eq_21 & siOut)
{
	ds->a3300[0].b0000[cx].b0000 = 0x0F;
	word16 dx_17;
	byte ah_25 = SLICE((uint16) fn0C00_0240(ah, out dx_17), byte, 8);
	ds->a0300[0][cx] = dx_17 - 0x32;
	word16 dx_28;
	byte ah_36 = SLICE((uint16) fn0C00_0240(ah_25, out dx_28), byte, 8);
	ds->a1300[0][cx] = dx_28 - 0x32;
	word16 dx_39;
	uint16 ax_37 = (uint16) fn0C00_0240(ah_36, out dx_39);
	if (ds->b02FC < 0x04)
		dx_39 += 100;
	ds->a2300[0][cx] = dx_39;
	siOut = cx << 0x01;
	return SLICE(ax_37, byte, 8);
}

// 0C00:027D: Register byte fn0C00_027D(Register Eq_66 si, Register (ptr16 Eq_3) es, Register (ptr16 Eq_3) ds)
// Called from:
//      fn0C00_0100
byte fn0C00_027D(Eq_66 si, struct Eq_3 * es, struct Eq_3 * ds)
{
	if (ds->*((word16) si + 0x00002300) == 0x00)
		ds->*((word16) si + 0x00002300) = (word16) (ds->*((word16) si + 0x00002300)) + 1;
	ds->t6306 = (int16) (ds->*((word16) si + 0x00004300) *s32 100 /16 ds->*((word16) si + 0x00002300)) + 0xA0;
	ds->t6308 = (int16) (ds->*((word16) si + 0x00005300) *s32 100 /16 ds->*((word16) si + 0x00002300)) + 100;
	Eq_567 ax_39 = (word16) ds->t6306 + ds->t6308 *s 0x0140;
	byte ah_67 = SLICE(ax_39, byte, 8);
	if (ds->t6306 <= 0x013F && ds->t6308 <= 199)
	{
		Eq_70 al_45 = ds->t630A;
		es->*ax_39 = al_45;
		ax_39 = SEQ(ah_67, al_45);
		if (ds->b02FC != 0x00)
		{
			ax_39 = SEQ(ah_67, al_45);
			if (ds->b02FC != 0x03)
			{
				ax_39 = SEQ(ah_67, al_45);
				if (ds->b02FC != 0x04)
				{
					ax_39 = SEQ(ah_67, al_45);
					if (ds->b02FC != 0x07)
					{
						es->*((word16) ax_39 + 1) = al_45;
						es->*((word16) ax_39 + 320) = al_45;
						es->*((word16) ax_39 + 0x0141) = al_45;
						ax_39 = SEQ(ah_67, al_45);
					}
				}
			}
		}
	}
	return SLICE(ax_39, byte, 8);
}

