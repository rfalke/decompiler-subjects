/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void PROCEDURE_LINKAGE_TABLE_();
// void _cleanup(void); idb
// int atexit(void (*func)(void));
// int __fpstart(void); weak
// void exit(int status);
// int printf(const char *format, ...);
// void *malloc(size_t size);
// void free(void *ptr);
// void abort(void);
// void *memset(void *s, int c, size_t n);
// void __usercall __noreturn start(void (*a1)(void)@<edx>, const char *a2);
void _do_global_dtors_aux();
void fini_dummy();
int frame_dummy();
void init_dummy();
int __cdecl main(int argc, const char **argv, const char **envp);
char *__cdecl decode_uleb128(char *a1, _DWORD *a2);
char *__cdecl decode_sleb128(char *a1, _DWORD *a2);
int __cdecl fde_insert(int a1, int a2, int a3);
int __cdecl count_fdes(_DWORD *a1);
// char *__usercall add_fdes@<eax>(char *result@<eax>, _DWORD *a2, int a3, int *a4, unsigned int *a5, unsigned int *a6);
unsigned int __cdecl frame_init(int a1);
int __cdecl find_fde(unsigned int a1);
char *__cdecl extract_cie_info(int a1, int *a2);
char *__cdecl execute_cfa_insn(unsigned __int8 *a1, int a2, int a3, _DWORD *a4);
int __cdecl _register_frame_info(int a1, _DWORD *a2);
int __cdecl _register_frame_info_table(int a1, _DWORD *a2);
void __cdecl _deregister_frame_info(int a1);
char *__cdecl _frame_state_for(unsigned int a1, int *a2);
int *_do_global_ctors_aux();
void init_dummy_0();
int *init_proc();
void term_proc(void); // idb

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_804948A; // weak
Elf32_Dyn DYNAMIC = { 1, { 316u } }; // weak
int *p_2 = &_DTOR_END__; // weak
int _CTOR_END__ = 0; // weak
_UNKNOWN _EH_FRAME_BEGIN__; // weak
_DWORD object_7[6]; // idb
int objects; // weak
int environ; // weak


//----- (08048770) --------------------------------------------------------
void PROCEDURE_LINKAGE_TABLE_()
{
  JUMPOUT(0);
}
// 8048776: control flows out of bounds to 0

//----- (08048810) --------------------------------------------------------
void __usercall __noreturn start(void (*a1)(void)@<edx>, const char *a2)
{
  int v2; // eax
  _DWORD v4[2]; // [esp-8h] [ebp-8h] BYREF
  int retaddr; // [esp+0h] [ebp+0h]

  v4[1] = 0;
  v4[0] = 0;
  if ( _cleanup )
    atexit(_cleanup);
  if ( &DYNAMIC )
    atexit(a1);
  atexit(term_proc);
  environ = (int)&v4[retaddr + 4];
  init_proc();
  __fpstart();
  v2 = main(retaddr, &a2, (const char **)&v4[retaddr + 4]);
  exit(v2);
}
// 80487A0: using guessed type int __fpstart(void);
// 804A4C0: using guessed type Elf32_Dyn DYNAMIC;
// 804AA88: using guessed type int environ;

//----- (08048880) --------------------------------------------------------
void _do_global_dtors_aux()
{
  void (**v0)(void); // eax

  while ( 1 )
  {
    v0 = (void (**)(void))p_2;
    if ( !*p_2 )
      break;
    ++p_2;
    (*v0)();
  }
  _deregister_frame_info((int)&_EH_FRAME_BEGIN__);
}
// 804A558: using guessed type int *p_2;

//----- (080488C0) --------------------------------------------------------
void fini_dummy()
{
  ;
}

//----- (080488D8) --------------------------------------------------------
int frame_dummy()
{
  return _register_frame_info((int)&_EH_FRAME_BEGIN__, object_7);
}

//----- (08048900) --------------------------------------------------------
void init_dummy()
{
  ;
}

//----- (08048918) --------------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  switch ( argc )
  {
    case 2:
      printf("Two!\n");
      break;
    case 3:
      printf("Three!\n");
      break;
    case 4:
      printf("Four!\n");
      break;
    case 5:
      printf("Five!\n");
      break;
    case 6:
      printf("Six!\n");
      break;
    case 7:
      printf("Seven!\n");
      break;
    default:
      printf("Other!\n");
      break;
  }
  return 0;
}

//----- (0804898C) --------------------------------------------------------
char *__cdecl decode_uleb128(char *a1, _DWORD *a2)
{
  int v2; // edi
  char i; // si
  char v4; // dl

  v2 = 0;
  for ( i = 0; ; i += 7 )
  {
    v4 = *a1++;
    v2 |= (v4 & 0x7F) << i;
    if ( v4 >= 0 )
      break;
  }
  *a2 = v2;
  return a1;
}

//----- (080489C8) --------------------------------------------------------
char *__cdecl decode_sleb128(char *a1, _DWORD *a2)
{
  unsigned int v3; // ecx
  char v4; // si
  int v6; // [esp+8h] [ebp-4h]

  v6 = 0;
  v3 = 0;
  do
  {
    v4 = *a1++;
    v6 |= (v4 & 0x7F) << v3;
    v3 += 7;
  }
  while ( v4 < 0 );
  if ( v3 <= 0x1F && (v4 & 0x40) != 0 )
    v6 |= -1 << v3;
  *a2 = v6;
  return a1;
}

//----- (08048A24) --------------------------------------------------------
int __cdecl fde_insert(int a1, int a2, int a3)
{
  int v3; // edx
  int result; // eax
  int *v5; // ecx
  int v6; // [esp+8h] [ebp-8h]
  int v7; // [esp+Ch] [ebp-4h]

  v3 = a2;
  result = a3;
  *(_DWORD *)(a1 + 4 * a2) = a3;
  if ( a2 )
  {
    v5 = (int *)(a1 + 4 * a2);
    do
    {
      v7 = *v5;
      v6 = *(_DWORD *)(a1 + 4 * v3 - 4);
      result = *(_DWORD *)(*v5 + 8) - *(_DWORD *)(v6 + 8);
      if ( result >= 0 )
        break;
      *v5 = v6;
      *(_DWORD *)(a1 + 4 * v3 - 4) = v7;
      --v5;
      --v3;
    }
    while ( v3 );
  }
  return result;
}

//----- (08048A7C) --------------------------------------------------------
int __cdecl count_fdes(_DWORD *a1)
{
  _DWORD *v1; // edx
  int i; // ecx

  v1 = a1;
  for ( i = 0; *v1; v1 = (_DWORD *)((char *)v1 + *v1 + 4) )
  {
    if ( v1[1] && v1[2] )
      ++i;
  }
  return i;
}

//----- (08048AAC) --------------------------------------------------------
char *__usercall add_fdes@<eax>(char *result@<eax>, _DWORD *a2, int a3, int *a4, unsigned int *a5, unsigned int *a6)
{
  _DWORD *v6; // esi
  int v7; // edi
  unsigned int v8; // eax
  unsigned int v9; // eax
  int v10; // [esp-8h] [ebp-1Ch]
  unsigned int v11; // [esp+Ch] [ebp-8h]
  unsigned int v12; // [esp+10h] [ebp-4h]

  v6 = a2;
  v7 = *a4;
  v12 = *a5;
  v11 = *a6;
  if ( *a2 )
  {
    do
    {
      if ( v6[1] && v6[2] )
      {
        v10 = v7++;
        fde_insert(a3, v10, (int)v6);
        v8 = v6[2];
        if ( v12 > v8 )
          v12 = v6[2];
        v9 = v6[3] + v8;
        if ( v11 < v9 )
          v11 = v9;
      }
      result = (char *)v6 + *v6;
      v6 = result + 4;
    }
    while ( *((_DWORD *)result + 1) );
  }
  *a4 = v7;
  *a5 = v12;
  *a6 = v11;
  return result;
}

//----- (08048B3C) --------------------------------------------------------
unsigned int __cdecl frame_init(int a1)
{
  _DWORD *v1; // eax
  _DWORD **v2; // esi
  int v3; // eax
  void *v4; // edi
  _DWORD *v5; // eax
  _DWORD **v6; // esi
  unsigned int result; // eax
  int v8; // [esp+10h] [ebp-Ch] BYREF
  unsigned int v9; // [esp+14h] [ebp-8h] BYREF
  unsigned int v10; // [esp+18h] [ebp-4h] BYREF

  v1 = *(_DWORD **)(a1 + 12);
  if ( v1 )
  {
    v2 = *(_DWORD ***)(a1 + 12);
    v8 = 0;
    if ( *v1 )
    {
      do
        v8 += count_fdes(*v2++);
      while ( *v2 );
    }
  }
  else
  {
    v8 = count_fdes(*(_DWORD **)(a1 + 8));
  }
  v3 = v8;
  *(_DWORD *)(a1 + 16) = v8;
  v4 = malloc(4 * v3);
  v9 = -1;
  v10 = 0;
  v8 = 0;
  v5 = *(_DWORD **)(a1 + 12);
  if ( v5 )
  {
    v6 = *(_DWORD ***)(a1 + 12);
    if ( *v5 )
    {
      do
        add_fdes((char *)&v8, *v6++, (int)v4, &v8, &v9, &v10);
      while ( *v6 );
    }
  }
  else
  {
    add_fdes((char *)&v8, *(_DWORD **)(a1 + 8), (int)v4, &v8, &v9, &v10);
  }
  *(_DWORD *)(a1 + 12) = v4;
  *(_DWORD *)a1 = v9;
  result = v10;
  *(_DWORD *)(a1 + 4) = v10;
  return result;
}

//----- (08048C28) --------------------------------------------------------
int __cdecl find_fde(unsigned int a1)
{
  unsigned int *v1; // esi
  unsigned int v3; // edi
  unsigned int v4; // esi
  unsigned int v5; // edx
  unsigned int v6; // eax
  int v7; // [esp+Ch] [ebp-8h]
  unsigned int v8; // [esp+10h] [ebp-4h]

  v1 = (unsigned int *)objects;
  if ( objects )
  {
    do
    {
      if ( !*v1 )
        frame_init((int)v1);
      if ( *v1 <= a1 && v1[1] > a1 )
        break;
      v1 = (unsigned int *)v1[5];
    }
    while ( v1 );
    if ( v1 )
    {
      v3 = 0;
      v8 = v1[4];
      if ( v8 )
      {
        v4 = v1[3];
        do
        {
          v5 = (v8 + v3) >> 1;
          v7 = *(_DWORD *)(v4 + 4 * v5);
          v6 = *(_DWORD *)(v7 + 8);
          if ( a1 >= v6 )
          {
            if ( a1 <= *(_DWORD *)(v7 + 12) + v6 )
              return *(_DWORD *)(v4 + 4 * v5);
            v3 = v5 + 1;
          }
          else
          {
            v8 = (v8 + v3) >> 1;
          }
        }
        while ( v8 > v3 );
      }
    }
  }
  return 0;
}
// 804AA84: using guessed type int objects;

//----- (08048CC8) --------------------------------------------------------
char *__cdecl extract_cie_info(int a1, int *a2)
{
  int v2; // edx
  unsigned int v4; // kr04_4
  char *v5; // edx
  char *v6; // eax
  char *v7; // eax
  char *v8; // edx
  char *v9; // eax
  const char *v10; // [esp+14h] [ebp-10h]
  int v11; // [esp+20h] [ebp-4h] BYREF

  v2 = a1 - (*(_DWORD *)(a1 + 4) - 4);
  *a2 = v2 + 9;
  if ( strcmp((const char *)(v2 + 9), (const char *)&unk_804948A)
    && strcmp((const char *)(v2 + 9), "eh")
    && *(_BYTE *)(v2 + 9) != 122 )
  {
    return 0;
  }
  v10 = (const char *)*a2;
  v4 = strlen((const char *)*a2) + 1;
  v5 = (char *)(*a2 + v4);
  if ( !strcmp((const char *)*a2, "eh") )
  {
    a2[1] = *(_DWORD *)&v10[v4];
    v5 = (char *)&v10[v4 + 4];
  }
  else
  {
    a2[1] = 0;
  }
  v6 = decode_uleb128(v5, a2 + 2);
  v7 = decode_sleb128(v6, a2 + 3);
  a2[4] = (unsigned __int8)*v7;
  v8 = v7 + 1;
  if ( *(_BYTE *)*a2 == 122 )
  {
    v9 = decode_uleb128(v8, &v11);
    v8 = &v9[v11];
  }
  return v8;
}

//----- (08048DE0) --------------------------------------------------------
char *__cdecl execute_cfa_insn(unsigned __int8 *a1, int a2, int a3, _DWORD *a4)
{
  int v4; // eax
  char *v5; // eax
  char *v6; // eax
  char *v7; // eax
  void *v8; // edi
  void *v9; // edx
  int v10; // eax
  char *result; // eax
  int v12; // [esp+10h] [ebp-Ch] BYREF
  int v13; // [esp+14h] [ebp-8h] BYREF
  int v14; // [esp+18h] [ebp-4h] BYREF
  char *v15; // [esp+24h] [ebp+8h]

  v4 = *a1;
  v15 = (char *)(a1 + 1);
  if ( (v4 & 0x40) != 0 )
  {
    *a4 += *(_DWORD *)(a3 + 8) * (v4 & 0x3F);
  }
  else if ( (v4 & 0x80u) == 0 )
  {
    if ( (v4 & 0xC0) != 0 )
    {
      *(_BYTE *)((v4 & 0x3F) + a2 + 92) = v4 & 0x40;
    }
    else
    {
      switch ( v4 )
      {
        case 0:
        case 7:
        case 8:
          return v15;
        case 1:
          *a4 = *(_DWORD *)v15;
          v15 += 4;
          break;
        case 2:
          *a4 += (unsigned __int8)*v15++;
          break;
        case 3:
          *a4 += *(unsigned __int16 *)v15;
          v15 += 2;
          break;
        case 4:
          *a4 += *(_DWORD *)v15;
          v15 += 4;
          break;
        case 5:
          v5 = decode_uleb128(v15, &v13);
          v15 = decode_uleb128(v5, &v14);
          v14 *= *(_DWORD *)(a3 + 12);
          *(_BYTE *)(v13 + a2 + 92) = 1;
          *(_DWORD *)(4 * v13 + a2 + 16) = v14;
          break;
        case 6:
          v15 = decode_uleb128(v15, &v13);
          *(_BYTE *)(v13 + a2 + 92) = 0;
          break;
        case 9:
          v6 = decode_uleb128(v15, &v13);
          v15 = decode_uleb128(v6, &v12);
          *(_BYTE *)(v13 + a2 + 92) = 2;
          *(_DWORD *)(4 * v13 + a2 + 16) = v12;
          break;
        case 10:
          v8 = malloc(0x74u);
          qmemcpy(v8, (const void *)a2, 0x74u);
          *(_DWORD *)(a2 + 112) = v8;
          break;
        case 11:
          v9 = *(void **)(a2 + 112);
          qmemcpy((void *)a2, v9, 0x74u);
          free(v9);
          break;
        case 12:
          v7 = decode_uleb128(v15, &v13);
          v15 = decode_uleb128(v7, &v14);
          *(_WORD *)(a2 + 88) = v13;
          *(_DWORD *)(a2 + 8) = v14;
          break;
        case 13:
          v15 = decode_uleb128(v15, &v13);
          *(_WORD *)(a2 + 88) = v13;
          break;
        case 14:
          v15 = decode_uleb128(v15, &v14);
          *(_DWORD *)(a2 + 8) = v14;
          break;
        case 45:
          v13 = 16;
          do
          {
            *(_BYTE *)(v13 + a2 + 92) = 1;
            v10 = v13;
            *(_DWORD *)(a2 + 4 * v13 + 16) = 4 * v13 - 64;
            v13 = v10 + 1;
          }
          while ( (unsigned int)(v10 + 1) <= 0x1F );
          break;
        case 46:
          v15 = decode_uleb128(v15, &v14);
          *(_DWORD *)(a2 + 12) = v14;
          break;
        default:
          abort();
          return result;
      }
    }
  }
  else
  {
    v13 = v4 & 0x3F;
    v15 = decode_uleb128(v15, &v14);
    v14 *= *(_DWORD *)(a3 + 12);
    *(_BYTE *)(v13 + a2 + 92) = 1;
    *(_DWORD *)(4 * v13 + a2 + 16) = v14;
  }
  return v15;
}

//----- (08049170) --------------------------------------------------------
int __cdecl _register_frame_info(int a1, _DWORD *a2)
{
  int result; // eax

  a2[2] = a1;
  a2[1] = 0;
  *a2 = 0;
  a2[3] = 0;
  a2[4] = 0;
  result = objects;
  a2[5] = objects;
  objects = (int)a2;
  return result;
}
// 804AA84: using guessed type int objects;

//----- (080491B8) --------------------------------------------------------
int __cdecl _register_frame_info_table(int a1, _DWORD *a2)
{
  int result; // eax

  a2[2] = a1;
  a2[3] = a1;
  a2[1] = 0;
  *a2 = 0;
  a2[4] = 0;
  result = objects;
  a2[5] = objects;
  objects = (int)a2;
  return result;
}
// 804AA84: using guessed type int objects;

//----- (080491FC) --------------------------------------------------------
void __cdecl _deregister_frame_info(int a1)
{
  int *v1; // ecx
  int v2; // edx

  v1 = &objects;
  if ( !objects )
LABEL_6:
    abort();
  while ( 1 )
  {
    v2 = *v1;
    if ( *(_DWORD *)(*v1 + 8) == a1 )
      break;
    v1 = (int *)(v2 + 20);
    if ( !*(_DWORD *)(v2 + 20) )
      goto LABEL_6;
  }
  *v1 = *(_DWORD *)(v2 + 20);
  if ( *(_DWORD *)v2 )
    free(*(void **)(v2 + 12));
}
// 804AA84: using guessed type int objects;

//----- (08049254) --------------------------------------------------------
char *__cdecl _frame_state_for(unsigned int a1, int *a2)
{
  char *result; // eax
  unsigned __int8 *v3; // esi
  unsigned int i; // edi
  unsigned __int8 *v5; // esi
  char *v6; // eax
  unsigned int v7; // edi
  char *v8; // [esp+20h] [ebp-94h]
  unsigned int j; // [esp+24h] [ebp-90h] BYREF
  int v10; // [esp+28h] [ebp-8Ch] BYREF
  int s[29]; // [esp+2Ch] [ebp-88h] BYREF
  int v12[4]; // [esp+A0h] [ebp-14h] BYREF
  int v13; // [esp+B0h] [ebp-4h]

  result = (char *)find_fde(a1);
  v8 = result;
  if ( result )
  {
    result = extract_cie_info((int)result, v12);
    v3 = (unsigned __int8 *)result;
    if ( result )
    {
      memset(s, 0, sizeof(s));
      HIWORD(s[22]) = v13;
      s[1] = v12[1];
      for ( i = (unsigned int)&v8[*(_DWORD *)&v8[-*((_DWORD *)v8 + 1) + 4] + 4 - *((_DWORD *)v8 + 1) + 4];
            (unsigned int)v3 < i;
            v3 = (unsigned __int8 *)execute_cfa_insn(v3, (int)s, (int)v12, 0) )
      {
        ;
      }
      v5 = (unsigned __int8 *)(v8 + 16);
      if ( *(_BYTE *)v12[0] == 122 )
      {
        v6 = decode_uleb128(v8 + 16, &v10);
        v5 = (unsigned __int8 *)&v6[v10];
      }
      v7 = (unsigned int)&v8[*(_DWORD *)v8 + 4];
      for ( j = *((_DWORD *)v8 + 2);
            (unsigned int)v5 < v7;
            v5 = (unsigned __int8 *)execute_cfa_insn(v5, (int)s, (int)v12, &j) )
      {
        if ( j > a1 )
          break;
      }
      qmemcpy(a2, s, 0x70u);
      result = (char *)a2;
    }
  }
  return result;
}

//----- (080493C0) --------------------------------------------------------
int *_do_global_ctors_aux()
{
  int *result; // eax
  int (**v1)(void); // esi

  result = &_CTOR_END__;
  v1 = (int (**)(void))(&_CTOR_END__ - 1);
  if ( *(&_CTOR_END__ - 1) != -1 )
  {
    do
      result = (int *)(*v1--)();
    while ( *v1 != (int (*)(void))-1 );
  }
  return result;
}
// 804A560: using guessed type int _CTOR_END__;

//----- (080493F4) --------------------------------------------------------
void init_dummy_0()
{
  ;
}

//----- (08049410) --------------------------------------------------------
int *init_proc()
{
  frame_dummy();
  return _do_global_ctors_aux();
}

//----- (08049440) --------------------------------------------------------
void term_proc(void)
{
  _do_global_dtors_aux();
}

// nfuncs=43 queued=24 decompiled=24 lumina nreq=0 worse=0 better=0
// ALL OK, 24 function(s) have been successfully decompiled
