/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn _RUNTIME_PSEUDO_RELOC_LIST_END__(); // weak
int __do_sjlj_init();
int __cdecl main(int argc, const char **argv, const char **envp);
int __w32_sharedptr_default_unexpected();
int __cdecl __w32_eh_shared_initialize(_DWORD *a1);
int __w32_sharedptr_initialize();
int __cdecl __w32_sharedptr_set(int a1);
unsigned int __cdecl __w32_sharedptr_get(ATOM nAtom);
int __w32_sharedptr_fixup_after_fork();
void __cdecl __noreturn cygwin_crt0(int a1);
// int __main(void); weak
// int __cdecl puts(const char *Buffer);
// void __cdecl free(void *Block);
// int __cdecl pthread_atfork(_DWORD, _DWORD, _DWORD); weak
// void *__cdecl malloc(size_t Size);
// void __cdecl __noreturn abort();
int __stdcall _cygwin_crt0_common(int a1, _DWORD *a2);
int __cdecl do_pseudo_reloc(int *a1, unsigned int a2, int a3);
int _pei386_runtime_relocator();
// void *__cdecl calloc(size_t Count, size_t Size);
// void *__cdecl realloc(void *Block, size_t Size);
void cygwin_premain3();
void cygwin_premain2();
void cygwin_premain1();
void cygwin_premain0();
// int __cdecl cygwin_internal(_DWORD); weak
// ATOM __stdcall FindAtomA(LPCSTR lpString);
// ATOM __stdcall AddAtomA(LPCSTR lpString);
// UINT __stdcall GetAtomNameA(ATOM nAtom, LPSTR lpBuffer, int nSize);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
int __sjlj_init_ctor();
// int __cdecl dll_crt0(_DWORD); weak

//-------------------------------------------------------------------------
// Data declarations

int __CTOR_LIST__ = -1; // weak
int _DTOR_LIST__[21] = { -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }; // weak
int _data_start__ = 20; // weak
int sjl_once_2 = 20; // weak
int dword_402008 = 0; // weak
_UNKNOWN _data_end__; // weak
int _bss_start__; // weak
int sjl_fc_key_1; // weak
char **environ;
int _impure_ptr; // weak
int _fmode;
int __w32_sharedptr_terminate; // weak
int __w32_sharedptr; // weak
int __w32_sharedptr_unexpected; // weak
_UNKNOWN _bss_end__; // weak


//----- (00401000) --------------------------------------------------------
void __noreturn _RUNTIME_PSEUDO_RELOC_LIST_END__()
{
  if ( _bss_start__ )
    __debugbreak();
  cygwin_crt0((int)main);
}
// 401000: using guessed type void __noreturn _RUNTIME_PSEUDO_RELOC_LIST_END__();
// 403000: using guessed type int _bss_start__;

//----- (00401040) --------------------------------------------------------
int __do_sjlj_init()
{
  return __w32_sharedptr_initialize();
}

//----- (00401080) --------------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  void *v3; // esp

  v3 = alloca(0);
  __main();
  switch ( argc )
  {
    case 2:
      puts("Two!");
      break;
    case 3:
      puts("Three!");
      break;
    case 4:
      puts("Four!");
      break;
    case 5:
      puts("Five!");
      break;
    case 6:
      puts("Six!");
      break;
    case 7:
      puts("Seven!");
      break;
    default:
      puts("Other!");
      break;
  }
  return 0;
}
// 4014D0: using guessed type int __main(void);

//----- (00401140) --------------------------------------------------------
int __w32_sharedptr_default_unexpected()
{
  return (*(int (**)(void))(__w32_sharedptr + 4))();
}
// 403040: using guessed type int __w32_sharedptr;

//----- (00401160) --------------------------------------------------------
int __cdecl __w32_eh_shared_initialize(_DWORD *a1)
{
  int v1; // eax
  int v2; // eax
  int v3; // edx
  int result; // eax

  memset(a1, 0, 0x30u);
  *a1 = 48;
  v1 = _data_start__;
  a1[9] = -1;
  a1[1] = abort;
  a1[5] = v1;
  v2 = sjl_fc_key_1;
  a1[2] = __w32_sharedptr_default_unexpected;
  v3 = dword_402008;
  a1[7] = 0;
  a1[8] = v2;
  result = sjl_once_2;
  a1[11] = v3;
  a1[10] = result;
  return result;
}
// 402000: using guessed type int _data_start__;
// 402004: using guessed type int sjl_once_2;
// 402008: using guessed type int dword_402008;
// 403010: using guessed type int sjl_fc_key_1;

//----- (004011D0) --------------------------------------------------------
int __w32_sharedptr_initialize()
{
  int result; // eax
  ATOM v1; // ax
  _DWORD *v2; // eax
  void *v3; // esi
  CHAR String[64]; // [esp+10h] [ebp-48h] BYREF

  result = __w32_sharedptr;
  if ( !__w32_sharedptr )
  {
    strcpy(String, "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-LIBGCCW32-EH-SJLJ-GTHR-CYGWIN");
    v1 = FindAtomA(String);
    if ( !v1 )
    {
      v2 = malloc(0x30u);
      v3 = v2;
      if ( !v2 )
        abort();
      __w32_eh_shared_initialize(v2);
      if ( (unsigned __int16)__w32_sharedptr_set((int)v3) )
      {
        pthread_atfork(0, 0, __w32_sharedptr_fixup_after_fork);
LABEL_6:
        __w32_sharedptr = (int)v3;
        __w32_sharedptr_terminate = (int)v3 + 4;
        result = (int)v3 + 8;
        __w32_sharedptr_unexpected = (int)v3 + 8;
        return result;
      }
      free(v3);
      v1 = FindAtomA(String);
    }
    v3 = (void *)__w32_sharedptr_get(v1);
    goto LABEL_6;
  }
  return result;
}
// 401500: using guessed type int __cdecl pthread_atfork(_DWORD, _DWORD, _DWORD);
// 403030: using guessed type int __w32_sharedptr_terminate;
// 403040: using guessed type int __w32_sharedptr;
// 403050: using guessed type int __w32_sharedptr_unexpected;

//----- (00401310) --------------------------------------------------------
int __cdecl __w32_sharedptr_set(int a1)
{
  int v1; // eax
  int v2; // edx
  CHAR v3; // cl
  ATOM v4; // ax
  int v5; // esi
  int v6; // edx
  unsigned int v8; // eax
  CHAR String[32]; // [esp+10h] [ebp-58h] BYREF
  char v10[32]; // [esp+30h] [ebp-38h] BYREF

  v1 = 31;
  v2 = 1;
  do
  {
    v3 = 65;
    if ( (a1 & v2) == 0 )
      v3 = 97;
    String[v1] = v3;
    v2 *= 2;
    --v1;
  }
  while ( v1 >= 0 );
  strcpy(v10, "-LIBGCCW32-EH-SJLJ-GTHR-CYGWIN");
  v4 = AddAtomA(String);
  v5 = v4;
  if ( !v4 || (v8 = __w32_sharedptr_get(v4), v6 = v5, v8 != a1) )
    v6 = 0;
  return v6;
}

//----- (004013A0) --------------------------------------------------------
unsigned int __cdecl __w32_sharedptr_get(ATOM nAtom)
{
  unsigned int v1; // ebx
  int v2; // eax
  int v3; // edx
  CHAR Buffer[68]; // [esp+10h] [ebp-48h] BYREF

  v1 = 0;
  if ( !GetAtomNameA(nAtom, Buffer, 63) )
    goto LABEL_8;
  v2 = 31;
  v3 = 1;
  do
  {
    if ( Buffer[v2] == 65 )
      v1 |= v3;
    v3 *= 2;
    --v2;
  }
  while ( v2 >= 0 );
  if ( *(_DWORD *)v1 != 48 )
LABEL_8:
    abort();
  return v1;
}

//----- (00401410) --------------------------------------------------------
int __w32_sharedptr_fixup_after_fork()
{
  int result; // eax

  result = __w32_sharedptr_set(__w32_sharedptr);
  if ( !(_WORD)result )
    abort();
  return result;
}
// 403040: using guessed type int __w32_sharedptr;

//----- (00401470) --------------------------------------------------------
void __cdecl __noreturn cygwin_crt0(int a1)
{
  int v1[42]; // [esp+8h] [ebp-C0h] BYREF
  int v2; // [esp+B0h] [ebp-18h]

  if ( !_cygwin_crt0_common(a1, 0) )
    goto LABEL_4;
  v2 = 0;
  while ( 1 )
  {
    dll_crt0(v2);
LABEL_4:
    v1[0] = 0;
    _cygwin_crt0_common(a1, v1);
  }
}
// 404098: using guessed type int __cdecl dll_crt0(_DWORD);

//----- (00401530) --------------------------------------------------------
int __stdcall _cygwin_crt0_common(int a1, _DWORD *a2)
{
  int v2; // eax
  _DWORD *v3; // ebx
  int result; // eax
  int v5; // edx
  int vars0; // [esp+8h] [ebp+0h]

  v2 = 0;
  v3 = a2;
  if ( !a2 )
  {
    v5 = cygwin_internal(8);
    result = 0;
    if ( v5 == -1 )
      return result;
    v3 = (_DWORD *)v5;
    v2 = 1;
  }
  v3[1] = 168;
  v3[2] = 1005;
  v3[3] = 9;
  v3[32] = 0;
  v3[33] = 112;
  v3[11] = &__CTOR_LIST__;
  v3[12] = _DTOR_LIST__;
  v3[5] = &environ;
  if ( v2 )
    _impure_ptr = v3[41];
  else
    v3[4] = &_impure_ptr;
  v3[30] = 0;
  v3[18] = cygwin_premain0;
  v3[19] = cygwin_premain1;
  v3[10] = a1;
  v3[20] = cygwin_premain2;
  v3[21] = cygwin_premain3;
  v3[9] = &_fmode;
  *v3 = vars0;
  v3[6] = malloc;
  v3[7] = free;
  v3[8] = realloc;
  v3[17] = calloc;
  v3[31] = GetModuleHandleA(0);
  v3[13] = &_data_start__;
  v3[14] = &_data_end__;
  v3[15] = &_bss_start__;
  v3[16] = &_bss_end__;
  _pei386_runtime_relocator();
  return 1;
}
// 4015C7: variable 'vars0' is possibly undefined
// 401740: using guessed type int __cdecl cygwin_internal(_DWORD);
// 4017A0: using guessed type int __CTOR_LIST__;
// 4017AC: using guessed type int _DTOR_LIST__[21];
// 402000: using guessed type int _data_start__;
// 403000: using guessed type int _bss_start__;
// 403024: using guessed type int _impure_ptr;

//----- (00401670) --------------------------------------------------------
int __cdecl do_pseudo_reloc(int *a1, unsigned int a2, int a3)
{
  int *i; // ecx
  _DWORD *v4; // edx
  int result; // eax

  for ( i = a1; (unsigned int)i < a2; *v4 += result )
  {
    v4 = (_DWORD *)(i[1] + a3);
    result = *i;
    i += 2;
  }
  return result;
}

//----- (004016B0) --------------------------------------------------------
int _pei386_runtime_relocator()
{
  return do_pseudo_reloc(&_bss_start__, (unsigned int)&_bss_start__, 0x400000);
}
// 403000: using guessed type int _bss_start__;

//----- (00401700) --------------------------------------------------------
void cygwin_premain3()
{
  ;
}

//----- (00401710) --------------------------------------------------------
void cygwin_premain2()
{
  ;
}

//----- (00401720) --------------------------------------------------------
void cygwin_premain1()
{
  ;
}

//----- (00401730) --------------------------------------------------------
void cygwin_premain0()
{
  ;
}

//----- (00401790) --------------------------------------------------------
int __sjlj_init_ctor()
{
  return __do_sjlj_init();
}

// nfuncs=35 queued=18 decompiled=18 lumina nreq=0 worse=0 better=0
// ALL OK, 18 function(s) have been successfully decompiled
