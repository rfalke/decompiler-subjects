/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

_BYTE *__fastcall start(_BYTE *);
int *__fastcall sub_7F6872(_DWORD *, __int64, __int64, unsigned int);
_BYTE *__fastcall sub_7F68B0(_DWORD *, _BYTE *, __int64, __int64, char);
__int64 __fastcall sub_7F6A55(__int64, __int64, __int64, __int64, __int64, unsigned __int64);

//-------------------------------------------------------------------------
// Data declarations

int dword_400000 = 1179403647; // weak
_UNKNOWN loc_7F6A40; // weak
_UNKNOWN loc_7F6AC0; // weak


//----- (00000000007F6840) ----------------------------------------------------
_BYTE *__fastcall start(_BYTE *a1)
{
  _DWORD *v1; // rdx
  char v2; // r8

  ((void (__fastcall *)(_BYTE *))loc_7F6AC0)(a1);
  return sub_7F68B0(v1, a1, (__int64)v1, 0LL, v2);
}
// 7F685B: variable 'v1' is possibly undefined
// 7F685B: variable 'v2' is possibly undefined

//----- (00000000007F6872) ----------------------------------------------------
int *__fastcall sub_7F6872(_DWORD *a1, __int64 a2, __int64 a3, unsigned int a4)
{
  unsigned __int64 v4; // rbp
  int *result; // rax
  char v6; // dl
  unsigned int v7; // ecx
  int v8; // edx
  bool v9; // cf
  bool v10; // zf

  result = (_DWORD *)((char *)a1 + v4);
  v6 = *((_BYTE *)a1 + v4);
  if ( a4 <= 5 )
    goto LABEL_9;
  if ( v4 > 0xFFFFFFFFFFFFFFFCLL )
    goto LABEL_9;
  v7 = a4 - 4;
  do
  {
    v8 = *result++;
    v9 = v7 < 4;
    v7 -= 4;
    *a1++ = v8;
  }
  while ( !v9 );
  v10 = v7 == -4;
  a4 = v7 + 4;
  v6 = *(_BYTE *)result;
  if ( !v10 )
  {
LABEL_9:
    do
    {
      result = (int *)((char *)result + 1);
      *(_BYTE *)a1 = v6;
      --a4;
      v6 = *(_BYTE *)result;
      a1 = (_DWORD *)((char *)a1 + 1);
    }
    while ( a4 );
  }
  return result;
}
// 7F6872: variable 'v4' is possibly undefined

//----- (00000000007F68B0) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
_BYTE *__fastcall sub_7F68B0(_DWORD *a1, _BYTE *a2, __int64 a3, __int64 a4, char a5)
{
  int v5; // ebx
  unsigned __int64 v6; // rbp
  __int64 (__fastcall *v7)(_DWORD *, _BYTE *, __int64); // r11
  bool v8; // cf
  int v9; // ebx
  int v10; // ett
  int v11; // eax
  __int64 v12; // rdx
  int v13; // ecx
  void (*v14)(void); // r11
  unsigned int v15; // eax
  bool v16; // cf
  int v17; // ebx
  int v18; // ett
  unsigned int v19; // eax
  int v20; // eax
  bool v21; // cf
  int v22; // ebx
  int v23; // ett
  __int64 v24; // rcx
  bool v25; // cf
  int v26; // ebx
  int v27; // ett
  int v28; // ecx
  bool v29; // cf
  int v30; // ebx
  int v31; // ett
  int v32; // ecx
  int v33; // ecx
  _BYTE *result; // rax
  __int64 (__fastcall *v35)(_DWORD *, _BYTE *, __int64); // [rsp-30h] [rbp-30h]
  __int64 v36; // [rsp-28h] [rbp-28h]
  int v37; // [rsp-20h] [rbp-20h]
  _DWORD *v38; // [rsp-18h] [rbp-18h]

  v7 = v35;
  if ( a5 == 8 )
  {
    while ( 1 )
    {
      while ( 1 )
      {
        LOBYTE(a3) = *a2;
        v8 = __CFADD__(v5, v5);
        v5 *= 2;
        if ( !v5 )
        {
          v9 = *(_DWORD *)a2;
          v8 = (unsigned __int64)a2 < 0xFFFFFFFFFFFFFFFCLL;
          a2 += 4;
          v10 = v8 + v9;
          v8 = __CFADD__(v8, v9) | __CFADD__(v9, v10);
          v5 = v9 + v10;
          LOBYTE(a3) = *a2;
        }
        if ( !v8 )
          break;
        ++a2;
        *(_BYTE *)a1 = a3;
        a1 = (_DWORD *)((char *)a1 + 1);
      }
      while ( 1 )
      {
        v11 = v7(a1, a2, a3);
        v15 = v11 + v8 + v11;
        v16 = __CFADD__(v5, v5);
        v5 *= 2;
        if ( !v5 )
        {
          v17 = *(_DWORD *)a2;
          v8 = (unsigned __int64)a2 < 0xFFFFFFFFFFFFFFFCLL;
          a2 += 4;
          v18 = v8 + v17;
          v16 = __CFADD__(v8, v17) | __CFADD__(v17, v18);
          v5 = v17 + v18;
          LOBYTE(v12) = *a2;
        }
        if ( v16 )
          break;
        v14();
      }
      v8 = v15 < 3;
      v19 = v15 - 3;
      if ( v8 )
      {
        v21 = __CFADD__(v5, v5);
        v5 *= 2;
        if ( !v5 )
        {
          v22 = *(_DWORD *)a2;
          v8 = (unsigned __int64)a2 < 0xFFFFFFFFFFFFFFFCLL;
          a2 += 4;
          v23 = v8 + v22;
          v21 = __CFADD__(v8, v22) | __CFADD__(v22, v23);
          v5 = v22 + v23;
        }
        if ( v21 )
          goto LABEL_26;
      }
      else
      {
        v12 = (unsigned __int8)v12;
        ++a2;
        v20 = ~((unsigned __int8)v12 | (v19 << 8));
        if ( !v20 )
          break;
        v6 = v20 >> 1;
        if ( v20 & 1 )
        {
LABEL_26:
          ((void (__fastcall *)(_DWORD *, _BYTE *))v14)(a1, a2);
          v32 = v33 + v8 + v33;
          goto LABEL_27;
        }
      }
      v24 = (unsigned int)(v13 + 1);
      v25 = __CFADD__(v5, v5);
      v5 *= 2;
      if ( !v5 )
      {
        v26 = *(_DWORD *)a2;
        v8 = (unsigned __int64)a2 < 0xFFFFFFFFFFFFFFFCLL;
        a2 += 4;
        v27 = v8 + v26;
        v25 = __CFADD__(v8, v26) | __CFADD__(v26, v27);
        v5 = v26 + v27;
      }
      if ( v25 )
        goto LABEL_26;
      do
      {
        ((void (__fastcall *)(_DWORD *, _BYTE *, __int64, __int64))v14)(a1, a2, v12, v24);
        v24 = v28 + (unsigned int)v8 + v28;
        v29 = __CFADD__(v5, v5);
        v5 *= 2;
        if ( !v5 )
        {
          v30 = *(_DWORD *)a2;
          v8 = (unsigned __int64)a2 < 0xFFFFFFFFFFFFFFFCLL;
          a2 += 4;
          v31 = v8 + v30;
          v29 = __CFADD__(v8, v30) | __CFADD__(v30, v31);
          v5 = v30 + v31;
        }
      }
      while ( !v29 );
      v32 = v24 + 2;
LABEL_27:
      sub_7F6872(a1, (__int64)a2, v12, (v6 < 0xFFFFFFFFFFFFFB00LL) + v32 + 2);
    }
  }
  result = &a2[-v36];
  *v38 = (_DWORD)a1 - v37;
  return result;
}
// 7F697A: positive sp value 30 has been found
// 7F68B1: variable 'v35' is possibly undefined
// 7F68C8: variable 'v5' is possibly undefined
// 7F68DF: variable 'v14' is possibly undefined
// 7F68E4: variable 'v7' is possibly undefined
// 7F68E4: variable 'a3' is possibly undefined
// 7F68E7: variable 'v8' is possibly undefined
// 7F6901: variable 'v12' is possibly undefined
// 7F6929: variable 'v13' is possibly undefined
// 7F693C: variable 'v28' is possibly undefined
// 7F6954: variable 'v33' is possibly undefined
// 7F6956: variable 'v6' is possibly undefined
// 7F696E: variable 'v36' is possibly undefined
// 7F6972: variable 'v37' is possibly undefined
// 7F6976: variable 'v38' is possibly undefined

//----- (00000000007F6A55) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
__int64 __fastcall sub_7F6A55(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 a5, unsigned __int64 a6)
{
  __int64 v6; // rax
  __int64 v7; // rdx
  __int64 v8; // rcx
  char v9; // sf
  char v10; // of
  __int64 v11; // rax
  __int64 (__fastcall *v12)(_DWORD *, _QWORD, _QWORD, __int64 *, _QWORD); // rbp
  char v13; // r12
  __int64 v14; // r14
  __int64 v15; // r15
  _DWORD *v16; // rbx
  unsigned int v17; // edi
  signed __int64 v19; // rax
  unsigned int v20; // edx
  __int64 v21; // rcx
  __int64 v22; // rax
  __int64 v24; // [rsp-20h] [rbp-40h] BYREF
  __int64 v25; // [rsp-18h] [rbp-38h]
  __int64 v26; // [rsp-10h] [rbp-30h]
  __int64 v27; // [rsp-8h] [rbp-28h]
  __int64 v28; // [rsp+0h] [rbp-20h]
  __int64 v29; // [rsp+8h] [rbp-18h]
  __int64 v30; // [rsp+10h] [rbp-10h]
  _DWORD *v31; // [rsp+18h] [rbp-8h]

  v16 = v31;
  v31 = 0LL;
  v30 = 4194316LL;
  v29 = v11;
  v28 = 13031768LL;
  v27 = a4;
  v26 = v15;
  v17 = 18874368;
  _RSI = 13031768LL;
  v19 = sys_mmap(0x1200000uLL, 0xC6D958uLL, 7uLL, 0x32uLL, 0LL, a6);
  if ( (_DWORD)v19 != 18874368 )
  {
    v6 = ((__int64 (__fastcall *)(__int64, __int64, __int64))((char *)&loc_7F6A40 + 4))(18874368LL, 13031768LL, 30LL);
    v25 = v6;
    if ( v9 == v10 )
    {
      v24 = v7;
      *(_BYTE *)(v14 + 97) &= v13;
      *(_BYTE *)(3 * v8) += BYTE1(v6);
      __asm
      {
        outsb
        outsw
      }
      JUMPOUT(0x7F69BBLL);
    }
    JUMPOUT(0x7F69E1LL);
  }
  v20 = 18874368 - (unsigned int)&dword_400000;
  if ( (unsigned int)&dword_400000 != 18874368 )
  {
    v12 = (__int64 (__fastcall *)(_DWORD *, _QWORD, _QWORD, __int64 *, _QWORD))(v20 + (unsigned int)v12);
    LODWORD(v27) = v20 + v27;
    LODWORD(v29) = v20 + v29;
    v21 = ((unsigned int)v16 - (unsigned int)&dword_400000) >> 3;
    qmemcpy((void *)0x1200000, &dword_400000, 8 * v21);
    v17 = 8 * v21 + 18874368;
  }
  v25 = v17;
  v22 = v20;
  LODWORD(v22) = *v16;
  v24 = v22;
  return v12(v16 + 3, (unsigned int)v16[1], v17, &v24, (unsigned __int8)v16[2]);
}
// 7F6A56: positive sp value 8 has been found
// 7F69B3: control flows out of bounds to 7F69BB
// 7F698D: control flows out of bounds to 7F69E1
// 7F6A55: could not find valid save-restore pair for rbx
// 7F6A5D: variable 'v11' is possibly undefined
// 7F6A64: variable 'v15' is possibly undefined
// 7F6A92: variable 'v12' is possibly undefined
// 7F698D: variable 'v9' is possibly undefined
// 7F698D: variable 'v10' is possibly undefined
// 7F6991: variable 'v7' is possibly undefined
// 7F6999: variable 'v13' is possibly undefined
// 7F6999: variable 'v14' is possibly undefined
// 7F69A5: variable 'v8' is possibly undefined
// 400000: using guessed type int dword_400000;

// nfuncs=4 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
