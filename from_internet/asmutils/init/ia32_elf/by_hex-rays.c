/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void start();
// int __usercall sub_80480B7@<eax>(mode_t@<edx>, int@<ebp>);

//-------------------------------------------------------------------------
// Data declarations

char filename[8] = "/dev/tty"; // idb
int dword_8048208[] = {  }; // weak
int fd; // idb


//----- (0804804C) --------------------------------------------------------
void start()
{
  int v0; // eax
  mode_t v1; // edx
  unsigned int i; // ebp
  int v3; // eax
  mode_t v4; // edx
  int v5; // ebp

  __asm { int     80h; LINUX - sys_fork }
  v0 = sys_wait4(2, 0, 0, 0);
  for ( i = 0; i < 4; sub_80480B7(v1, i) )
    ++i;
  while ( 1 )
  {
    do
LABEL_3:
      v3 = sys_wait4(-1, 0, 0, 0);
    while ( v3 < 0 );
    v5 = 0;
    do
    {
      if ( (unsigned int)++v5 > 4 )
        goto LABEL_3;
    }
    while ( dword_8048208[v5] != v3 );
    sub_80480B7(v4, v5);
  }
}
// 804806C: control flows out of bounds to 80481C7
// 8048081: variable 'v1' is possibly undefined
// 80480B0: variable 'v4' is possibly undefined
// 8048208: using guessed type int dword_8048208[];

//----- (080480B7) --------------------------------------------------------
int __usercall sub_80480B7@<eax>(mode_t a1@<edx>, int a2@<ebp>)
{
  char v2; // al
  int v3; // eax
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // eax
  int v12; // eax
  int result; // eax

  v2 = a2;
  if ( (unsigned __int8)a2 > 9u )
    v2 = 9;
  LOBYTE(dword_8048208[0]) = v2 + 48;
  v3 = sys_open(filename, 2, a1);
  if ( v3 < 0 )
  {
    result = -1;
  }
  else
  {
    fd = v3;
    v4 = sys_dup2(v3, 0);
    v5 = sys_dup2(fd, 1);
    v6 = sys_dup2(fd, 2);
    v7 = sys_fcntl(0, 4, 0);
    v8 = sys_fcntl(1, 4, (struct flock *)1);
    v9 = sys_fcntl(2, 4, (struct flock *)1);
    v10 = sys_ioctl(fd, 21505);
    v11 = sys_ioctl(fd, 21507);
    if ( (unsigned int)fd > 2 )
      v12 = sys_close(fd);
    result = 2;
    __asm { int     80h; LINUX - sys_fork }
  }
  dword_8048208[a2] = result;
  return result;
}
// 8048208: using guessed type int dword_8048208[];

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
