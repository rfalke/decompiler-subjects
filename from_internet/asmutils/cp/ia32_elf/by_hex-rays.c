/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __cdecl __noreturn start(int a1, int a2, int a3);
// void __usercall sub_80480D7(char *a1@<edi>, char *a2@<esi>);
void __cdecl sub_804816B(char *filename, const char *path);
// void __usercall sub_804825F(void *a1@<edi>, const void *a2@<esi>);
// __int16 __usercall sub_8048273@<ax>(int@<edi>);
// void __usercall sub_804828E(const char *a1@<edi>);
// void __usercall sub_80482B5(int@<esi>);
// void __usercall sub_80482C1(void *a1@<edi>, const void *a2@<esi>);
// void __usercall sub_80482CE(int a1@<edi>, const void *a2@<esi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_804804C[6] = { 1734439765, 1663056485, 760946800, 1931500914, 1668445551, 1701060709 }; // weak
char *path; // idb
char byte_80482EA; // weak
char byte_80482EB; // weak
struct stat buf; // idb


//----- (08048067) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start(int a1, int a2, int a3)
{
  char *v4; // eax
  int v5; // eax
  unsigned int v6; // ecx
  char *v7; // edi
  char v8; // zf
  unsigned int v9; // [esp-10h] [ebp-10h]
  _WORD *v10; // [esp-8h] [ebp-8h]
  char *v11; // [esp-4h] [ebp-4h] BYREF

  if ( v9 >= 3 )
  {
    v6 = v9 - 1;
    if ( *v10 == 29229 )
    {
      ++byte_80482EA;
      v6 = v9 - 2;
    }
    v4 = (char *)_InterlockedExchange((volatile __int32 *)&(&v11)[v6 - 1], 0);
    path = v4;
    while ( 1 )
    {
      v7 = v11;
      if ( !v11 )
        break;
      sub_804828E(v11);
      if ( v8 )
      {
        if ( byte_80482EA == 1 )
        {
          sub_804816B(v7, path);
          v4 = v11;
        }
      }
      else
      {
        v11 = v7;
        sub_80480D7(path, v7);
      }
    }
  }
  else
  {
    v4 = (char *)sys_write(1, dword_804804C, 0x1Bu);
  }
  v5 = sys_exit((int)v4);
}
// 80480A4: positive sp value 10 has been found
// 804806B: variable 'v9' is possibly undefined
// 8048082: variable 'v4' is possibly undefined
// 8048087: variable 'v10' is possibly undefined
// 80480AD: variable 'v8' is possibly undefined
// 804804C: using guessed type int dword_804804C[6];
// 80482EA: using guessed type char byte_80482EA;

//----- (080480D7) --------------------------------------------------------
void __usercall sub_80480D7(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // eax
  mode_t v3; // edx
  char v4; // zf
  char *v5; // esi
  int v6; // eax
  mode_t v7; // edx
  int v8; // esi
  int v9; // eax
  int v10; // edi
  signed int v11; // eax
  const void *v12; // ecx
  int v13; // eax
  int v14; // edx
  int v15; // eax
  int v16; // eax
  char *v17; // [esp-28h] [ebp-28h]
  mode_t v18; // [esp-24h] [ebp-24h]

  v2 = sys_newstat(a2, &buf);
  sub_804828E(a1);
  if ( v4 )
  {
    v18 = v3;
    v17 = a2;
    v5 = a1;
    a1 = &byte_80482EB;
    sub_804825F(&byte_80482EB, v5);
    a2 = v17;
    v3 = v18;
  }
  v6 = sys_open(a2, 0, v3);
  if ( v6 >= 0 )
  {
    v8 = v6;
    v9 = sys_open(a1, 577, v7);
    if ( v9 >= 0 )
    {
      v10 = v9;
      while ( 1 )
      {
        v11 = sys_read(v8, &byte_80482EB, 0x1000u);
        if ( v11 < 0 )
          break;
        if ( v11 )
        {
          v13 = sys_write(v10, v12, v11);
          if ( v14 == 4096 )
            continue;
        }
        v15 = sys_close(v8);
        v16 = sys_close(v10);
        return;
      }
    }
  }
}
// 80480D7: could not find valid save-restore pair for esi
// 80480F9: variable 'v4' is possibly undefined
// 80480FB: variable 'v3' is possibly undefined
// 8048128: variable 'v7' is possibly undefined
// 804814D: variable 'v12' is possibly undefined
// 8048155: variable 'v14' is possibly undefined
// 80482EB: using guessed type char byte_80482EB;

//----- (0804816B) --------------------------------------------------------
void __cdecl sub_804816B(char *filename, const char *path)
{
  char v3; // zf
  mode_t v4; // edx
  int v5; // eax
  _BYTE *v6; // edi
  int v7; // ecx
  mode_t v8; // edx
  int v9; // ecx
  unsigned __int16 v10; // ax
  int v11; // [esp-1Ch] [ebp-112Ah]
  char v12[2048]; // [esp+0h] [ebp-110Eh] BYREF
  char v13[2048]; // [esp+800h] [ebp-90Eh] BYREF
  _BYTE dirp[270]; // [esp+1000h] [ebp-10Eh] BYREF

  sub_804828E(filename);
  if ( v3 )
  {
    sub_804828E(path);
    if ( v3 || sys_mkdir(path, 0x1EDu) >= 0 )
    {
      v5 = sys_open(filename, 0, v4);
      if ( v5 >= 0 )
      {
        *(_DWORD *)&dirp[266] = v5;
        while ( 1 )
        {
          __asm { int     80h; LINUX - sys_getdents }
          v6 = dirp;
          v7 = 141;
          do
          {
            if ( v6[10] != 46 || v6[11] && *(_WORD *)(v6 + 11) != 46 )
            {
              sub_804825F(v12, path);
              sub_804825F(v13, filename);
              sub_804828E(v13);
              if ( v3 )
              {
                v11 = v9;
                sub_804816B(v8, v13, v12);
                v7 = v11;
              }
              else
              {
                sub_80480D7(v12, v13);
              }
            }
            v10 = *((_WORD *)v6 + 4);
            v6 += v10;
            v7 -= v10;
          }
          while ( v7 );
        }
      }
    }
  }
}
// 804817C: variable 'v3' is possibly undefined
// 80481AC: variable 'v4' is possibly undefined
// 804821D: variable 'v9' is possibly undefined
// 804822C: variable 'v8' is possibly undefined
// 8048246: variable 'v7' is possibly undefined

//----- (0804825F) --------------------------------------------------------
void __usercall sub_804825F(void *a1@<edi>, const void *a2@<esi>)
{
  const void *v2; // edx

  sub_80482C1(a1, a2);
  sub_8048273((int)a1);
  sub_80482CE((int)a1, v2);
}
// 804826C: variable 'v2' is possibly undefined

//----- (08048273) --------------------------------------------------------
__int16 __usercall sub_8048273@<ax>(int a1@<edi>)
{
  int v1; // edx
  int v2; // edx
  __int16 result; // ax

  sub_80482B5(a1);
  v2 = v1 - 1;
  result = 47;
  if ( *(_BYTE *)(a1 + v2) != 47 )
    *(_WORD *)(a1 + v2 + 1) = 47;
  return result;
}
// 804827C: variable 'v1' is possibly undefined

//----- (0804828E) --------------------------------------------------------
void __usercall sub_804828E(const char *a1@<edi>)
{
  int v1; // eax

  v1 = sys_newstat(a1, &buf);
}

//----- (080482B5) --------------------------------------------------------
void __usercall sub_80482B5(int a1@<esi>)
{
  _BYTE *v1; // edx

  v1 = (_BYTE *)(a1 - 1);
  do
    ++v1;
  while ( *v1 );
}

//----- (080482C1) --------------------------------------------------------
void __usercall sub_80482C1(void *a1@<edi>, const void *a2@<esi>)
{
  int v2; // edx

  sub_80482B5((int)a2);
  qmemcpy(a1, a2, v2 + 1);
}
// 80482C7: variable 'v2' is possibly undefined

//----- (080482CE) --------------------------------------------------------
void __usercall sub_80482CE(int a1@<edi>, const void *a2@<esi>)
{
  int v2; // edx
  void *v3; // edi
  int v4; // edx

  sub_80482B5(a1);
  v3 = (void *)(v2 + a1);
  sub_80482B5((int)a2);
  qmemcpy(v3, a2, v4 + 1);
}
// 80482CE: could not find valid save-restore pair for edi
// 80482CE: could not find valid save-restore pair for esi
// 80482D8: variable 'v2' is possibly undefined
// 80482DF: variable 'v4' is possibly undefined

// nfuncs=9 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
