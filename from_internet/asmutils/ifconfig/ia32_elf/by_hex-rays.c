/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __fastcall start(int, mode_t);
int __fastcall sub_80480E8(int);
// unsigned __int8 __usercall sub_8048141@<al>(int@<edi>, unsigned __int8 *@<esi>);
int sub_8048237();
// char __usercall sub_8048352@<al>(_BYTE *@<edi>, char *@<esi>);
// char __usercall sub_804835A@<al>(unsigned __int8@<al>, _BYTE *@<edi>);
// char __usercall sub_804836D@<al>(char@<al>, _BYTE *@<edi>);
// char __usercall sub_8048437@<al>(unsigned __int8 *@<esi>);
// char __usercall sub_8048455@<al>(unsigned int@<ebp>, _BYTE *@<edi>);
// char __usercall sub_8048480@<al>(unsigned int@<ebp>, _BYTE *@<edi>);
int sub_8048493();

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "/proc/net/route"; // idb
char aDestinationNet[58] = "Destination     Netmask         Gateway         Iface\nUP "; // weak
char aBroadcast[11] = "BROADCAST "; // weak
char aLoopback[10] = "LOOPBACK "; // weak
char aRunning[9] = "RUNNING "; // weak
char aPromisc[9] = "PROMISC "; // weak
char aInetAddr[13] = "\n\tinet addr:"; // weak
char aNetmask[10] = " netmask:"; // weak
char aBroadcast_0[12] = " broadcast:"; // weak
int d; // idb
int dword_804854C[4]; // weak
int dword_804855C; // weak
int dword_8048560; // weak
int dword_8048570; // weak
int dword_8048580[4]; // weak
int dword_8048590[4]; // weak
char byte_80485A0; // weak
int dword_80485B0; // weak
int dword_80485B4[64]; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __fastcall start(int a1, mode_t a2)
{
  signed int v2; // ebp
  int v3; // eax
  bool v4; // cc
  int v5; // ecx
  int v6; // eax
  int v7; // ebx
  unsigned __int8 *v8; // esi
  unsigned __int8 *v9; // esi
  int *v10; // edi
  int *v11; // edi
  int j; // ebp
  int v14; // eax
  int *i; // edi
  unsigned __int8 v16; // al
  unsigned __int8 v17; // al
  unsigned __int8 v18; // al
  unsigned __int8 *v19; // esi
  unsigned __int8 v20; // al
  int v21; // ecx
  unsigned __int8 v22; // al
  unsigned __int8 v23; // al
  int *v24; // edi
  char v25; // al
  int v26; // eax
  int v27; // [esp-14h] [ebp-14h]
  const char *v28; // [esp-10h] [ebp-10h]
  unsigned __int8 *v29; // [esp-Ch] [ebp-Ch]
  int v30; // [esp-8h] [ebp-8h]
  unsigned __int8 *v31; // [esp-4h] [ebp-4h]

  v2 = v27 - 2;
  v3 = 102;
  __asm { int     80h; LINUX - sys_socket }
  d = 102;
  if ( v28[strlen(v28) - 1] == 101 )
  {
    byte_80485A0 |= 4u;
    v7 = 35083;
    v8 = v29;
    if ( !v29 )
    {
      d = sys_open(filename, 0, a2);
      sub_8048493();
      v14 = sys_write(1, aDestinationNet, 0x36u);
      while ( 1 )
      {
        sub_8048493();
        for ( i = dword_804854C; ; i = (int *)((char *)i + 1) )
        {
          v16 = *v8++;
          if ( v16 <= 0x20u )
            break;
          *(_BYTE *)i = v16;
        }
        *(_BYTE *)i = 10;
        sub_8048437(v8);
        dword_8048570 = v27 - 2;
        sub_8048437(v8);
        do
          v17 = *v8++;
        while ( v17 <= 0x20u );
        do
          v18 = *v8++;
        while ( v18 > 0x20u );
        v19 = v8 - 2;
        v20 = *v19;
        v8 = v19 + 1;
        if ( v20 >= 0x41u )
          --v20;
        if ( (v20 & 1) != 0 )
        {
          v21 = 3;
          do
          {
            do
              v22 = *v8++;
            while ( v22 <= 0x20u );
            do
              v23 = *v8++;
            while ( v23 > 0x20u );
            --v21;
          }
          while ( v21 );
          sub_8048437(v8);
          v24 = dword_80485B4;
          sub_8048480(dword_8048570, dword_80485B4);
          sub_8048480(v2, dword_80485B4);
          sub_8048480(v2, dword_80485B4);
          v8 = (unsigned __int8 *)dword_804854C;
          do
          {
            v25 = *v8++;
            *(_BYTE *)v24 = v25;
            v24 = (int *)((char *)v24 + 1);
          }
          while ( v25 != 10 );
          v26 = sys_write(1, dword_80485B4, (char *)v24 - (char *)dword_80485B4);
        }
      }
    }
    if ( *v29 != 97 )
      v7 = 35084;
    while ( 1 )
    {
      do
      {
        v4 = v2-- < 1;
        if ( v4 )
        {
          v3 = sys_ioctl(d, v7);
          goto LABEL_11;
        }
        v9 = (unsigned __int8 *)v30;
        if ( *(_WORD *)v30 == 28205 )
          byte_80485A0 &= ~4u;
      }
      while ( *(_WORD *)v30 == 26669 );
      if ( *(_BYTE *)v30 == 103 )
        break;
      if ( *(_BYTE *)v30 == 110 )
      {
        v10 = dword_8048590;
        goto LABEL_33;
      }
      if ( *(_WORD *)(v30 + 1) == 30309 )
      {
        --v2;
        dword_80485B0 = (int)v31;
      }
      else
      {
        LOWORD(dword_8048570) = 2;
        v11 = &dword_8048570 + 1;
        if ( *(_BYTE *)v30 == 100 )
          byte_80485A0 &= ~4u;
LABEL_31:
        sub_8048141((int)v11, v9);
      }
    }
    byte_80485A0 |= 2u;
    v10 = dword_8048580;
LABEL_33:
    v9 = v31;
    --v2;
    *(_WORD *)v10 = 2;
    v11 = v10 + 1;
    goto LABEL_31;
  }
  if ( !v29 )
  {
    for ( j = 1; ; ++j )
    {
      dword_804855C = j;
      v3 = sub_80480E8(35088);
      if ( v3 < 0 )
        break;
      sub_8048237();
    }
LABEL_11:
    v6 = sys_exit(v3);
  }
  qmemcpy(dword_804854C, v29, sizeof(dword_804854C));
  if ( v27 != 2 )
  {
    while ( 1 )
    {
      v4 = v2-- < 1;
      if ( v4 )
        goto LABEL_11;
      if ( *(char *)v30 <= 57 )
      {
        sub_8048141((int)&dword_8048560, (unsigned __int8 *)v30);
        LOWORD(dword_804855C) = 2;
        sub_80480E8(35094);
      }
      else
      {
        if ( *(_BYTE *)v30 == 98 )
        {
          --v2;
          sub_8048141((int)&dword_8048560, v31);
          LOWORD(dword_804855C) = 2;
          v5 = 35098;
          goto LABEL_10;
        }
        if ( *(_BYTE *)v30 == 110 )
        {
          --v2;
          sub_8048141((int)&dword_8048560, v31);
          LOWORD(dword_804855C) = 2;
          v5 = 35100;
          goto LABEL_10;
        }
      }
      sub_80480E8(35091);
      LOBYTE(dword_804855C) = dword_804855C & 0xFE;
      if ( *(_BYTE *)v30 != 100 )
        LOBYTE(dword_804855C) = dword_804855C | 1;
      v5 = 35092;
LABEL_10:
      v3 = sub_80480E8(v5);
    }
  }
  return sub_8048237();
}
// 80480A2: positive sp value 14 has been found
// 804804E: variable 'v27' is possibly undefined
// 804806B: variable 'v28' is possibly undefined
// 804807A: variable 'v29' is possibly undefined
// 8048097: variable 'v30' is possibly undefined
// 80480A8: variable 'v31' is possibly undefined
// 80480FE: variable 'v3' is possibly undefined
// 804854C: using guessed type int dword_804854C[4];
// 804855C: using guessed type int dword_804855C;
// 8048560: using guessed type int dword_8048560;
// 8048570: using guessed type int dword_8048570;
// 8048580: using guessed type int dword_8048580[4];
// 8048590: using guessed type int dword_8048590[4];
// 80485A0: using guessed type char byte_80485A0;
// 80485B0: using guessed type int dword_80485B0;
// 80485B4: using guessed type int dword_80485B4[64];

//----- (080480E8) --------------------------------------------------------
int __fastcall sub_80480E8(int a1)
{
  return sys_ioctl(d, a1);
}

//----- (08048141) --------------------------------------------------------
unsigned __int8 __usercall sub_8048141@<al>(int a1@<edi>, unsigned __int8 *a2@<esi>)
{
  int i; // ecx
  char j; // dl
  unsigned __int8 v4; // al
  bool v5; // cf
  unsigned __int8 result; // al

  for ( i = 0; i != 4; ++i )
  {
    for ( j = 0; ; j = result + 10 * j )
    {
      v4 = *a2++;
      v5 = v4 < 0x30u;
      result = v4 - 48;
      if ( v5 || result >= 0x31u )
        break;
    }
    *(_BYTE *)(a1 + i) = j;
  }
  return result;
}

//----- (08048237) --------------------------------------------------------
int sub_8048237()
{
  _BYTE *v0; // edi
  __int16 v1; // bx

  sub_8048352(dword_80485B4, (char *)dword_804854C);
  LOBYTE(dword_80485B4[0]) = 9;
  v0 = (char *)dword_80485B4 + 1;
  sub_80480E8(35111);
  sub_804835A(BYTE2(dword_804855C), (_BYTE *)dword_80485B4 + 1);
  sub_804835A(HIBYTE(dword_804855C), (_BYTE *)dword_80485B4 + 1);
  sub_804835A(dword_8048560, (_BYTE *)dword_80485B4 + 1);
  sub_804835A(BYTE1(dword_8048560), (_BYTE *)dword_80485B4 + 1);
  sub_804835A(BYTE2(dword_8048560), (_BYTE *)dword_80485B4 + 1);
  sub_804835A(HIBYTE(dword_8048560), (_BYTE *)dword_80485B4 + 1);
  LOBYTE(dword_80485B4[0]) = 32;
  sub_80480E8(35091);
  v1 = dword_804855C;
  if ( (dword_804855C & 1) != 0 )
    sub_8048352(v0, &aDestinationNet[54]);
  if ( (v1 & 2) != 0 )
    sub_8048352(v0, aBroadcast);
  if ( (v1 & 8) != 0 )
    sub_8048352(v0, aLoopback);
  if ( (v1 & 0x40) != 0 )
    sub_8048352(v0, aRunning);
  if ( (v1 & 0x100) != 0 )
    sub_8048352(v0, aPromisc);
  sub_80480E8(35093);
  sub_8048352(v0, aInetAddr);
  sub_8048455(dword_8048560, v0);
  sub_80480E8(35099);
  sub_8048352(dword_80485B4, aNetmask);
  sub_8048455(dword_8048560, dword_80485B4);
  sub_80480E8(35096);
  sub_8048352((_BYTE *)&dword_80485B4[-1] + 3, aBroadcast_0);
  sub_8048455(dword_8048560, (_BYTE *)&dword_80485B4[-1] + 3);
  BYTE2(dword_80485B4[-1]) = 10;
  HIBYTE(dword_80485B4[-1]) = 10;
  return sys_write(1, dword_80485B4, 0);
}
// 804854C: using guessed type int dword_804854C[4];
// 804855C: using guessed type int dword_804855C;
// 8048560: using guessed type int dword_8048560;
// 80485B4: using guessed type int dword_80485B4[64];

//----- (08048352) --------------------------------------------------------
char __usercall sub_8048352@<al>(_BYTE *a1@<edi>, char *a2@<esi>)
{
  char result; // al
  char *v3; // esi

  result = *a2;
  v3 = a2 + 1;
  do
  {
    *a1++ = result;
    result = *v3++;
  }
  while ( result );
  return result;
}

//----- (0804835A) --------------------------------------------------------
char __usercall sub_804835A@<al>(unsigned __int8 a1@<al>, _BYTE *a2@<edi>)
{
  char result; // al

  sub_804836D(a1 >> 4, a2);
  sub_804836D(a1, a2);
  result = 58;
  *a2 = 58;
  return result;
}

//----- (0804836D) --------------------------------------------------------
char __usercall sub_804836D@<al>(char a1@<al>, _BYTE *a2@<edi>)
{
  unsigned __int8 v2; // al
  char result; // al

  v2 = a1 & 0xF;
  if ( v2 >= 0xAu )
    v2 += 7;
  result = v2 + 48;
  *a2 = result;
  return result;
}

//----- (08048437) --------------------------------------------------------
char __usercall sub_8048437@<al>(unsigned __int8 *a1@<esi>)
{
  unsigned __int8 v1; // al
  unsigned __int8 *v2; // esi
  int v3; // eax
  int v4; // ebp
  int v5; // ecx

  do
    v1 = *a1++;
  while ( v1 <= 0x20u );
  v2 = a1 - 1;
  v3 = 0;
  v4 = 0;
  v5 = 8;
  do
  {
    LOBYTE(v3) = *v2++;
    if ( (unsigned __int8)v3 >= 0x41u )
      LOBYTE(v3) = v3 - 7;
    LOBYTE(v3) = v3 - 48;
    v4 = v3 | (16 * v4);
    --v5;
  }
  while ( v5 );
  return v3;
}

//----- (08048455) --------------------------------------------------------
char __usercall sub_8048455@<al>(unsigned int a1@<ebp>, _BYTE *a2@<edi>)
{
  int v2; // ecx
  unsigned int v3; // eax
  int v4; // ecx
  unsigned int v5; // et2
  char result; // al
  char v7; // [esp-8h] [ebp-8h]
  int v8; // [esp-4h] [ebp-4h]

  v2 = 4;
  do
  {
    LOBYTE(v3) = a1;
    a1 >>= 8;
    v8 = v2;
    v3 = (unsigned __int8)v3;
    v4 = 0;
    do
    {
      v5 = v3 % 0xA;
      v3 /= 0xAu;
      ++v4;
      v7 = v5 + 48;
    }
    while ( v3 );
    do
    {
      *a2++ = v7;
      --v4;
    }
    while ( v4 );
    result = 46;
    *a2++ = 46;
    v2 = v8 - 1;
  }
  while ( v8 != 1 );
  return result;
}

//----- (08048480) --------------------------------------------------------
char __usercall sub_8048480@<al>(unsigned int a1@<ebp>, _BYTE *a2@<edi>)
{
  _BYTE *v2; // edi
  int v3; // ecx
  char result; // al
  int v5; // [esp+0h] [ebp-4h]

  sub_8048455(a1, a2);
  v2 = a2 - 1;
  v3 = v5 - (_DWORD)v2 + 16;
  result = 32;
  do
  {
    *v2++ = 32;
    --v3;
  }
  while ( v3 );
  return result;
}
// 8048488: variable 'v5' is possibly undefined

//----- (08048493) --------------------------------------------------------
int sub_8048493()
{
  int v0; // eax
  int v1; // ebx
  int *v2; // ecx
  size_t v3; // edx
  int result; // eax
  int v5; // ecx

  v1 = d;
  v2 = dword_80485B4;
  v3 = 1;
  do
  {
    result = sys_read(v1, v2, v3);
    if ( !result )
      v0 = sys_exit(0);
    v2 = (int *)(v5 + 1);
  }
  while ( *((_BYTE *)v2 - 1) != 10 );
  return result;
}
// 80484A6: variable 'v3' is possibly undefined
// 80484AC: variable 'v5' is possibly undefined
// 80485B4: using guessed type int dword_80485B4[64];

// nfuncs=11 queued=11 decompiled=11 lumina nreq=0 worse=0 better=0
// ALL OK, 11 function(s) have been successfully decompiled
