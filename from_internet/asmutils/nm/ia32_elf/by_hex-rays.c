/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
// int __usercall sub_8048165@<eax>(int@<eax>, int@<edx>, int@<edi>);
// int __usercall sub_8048211@<eax>(unsigned int@<ecx>, int@<edi>);
void __fastcall sub_804822F(int a1, char a2);
void sub_8048260();
// int __usercall sub_8048274@<eax>(int a1@<eax>);
// void __usercall sub_804831C(int@<ecx>, _DWORD *@<edi>);
// char __usercall sub_8048359@<al>(unsigned int@<ecx>, int@<edi>);
// char __usercall sub_804837F@<al>(unsigned int@<eax>, int@<edi>);

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "a.out"; // idb
__int16 word_8048052 = 29253; // weak
char byte_8048065[3] = { ' ', ' ', ' ' }; // weak
char byte_8048273 = '\n'; // weak
int dword_80483AF; // weak
const void *addr; // idb
int fd; // idb
int dword_80483BB; // weak
int dword_80483BF; // weak
int status; // idb
int dword_80483C7; // weak
int dword_80483CF; // weak
int dword_80483D3; // weak
int dword_80483D7; // weak
char byte_80483DB[]; // weak


//----- (08048097) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // ecx
  int v3; // eax
  char *v4; // ebx
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // ecx
  int v10; // eax
  int v11; // [esp-Ch] [ebp-Ch]
  const char *v12; // [esp-8h] [ebp-8h]
  char *v13; // [esp-4h] [ebp-4h]

  v2 = v11;
  dword_80483BF = (int)sub_8048165;
  if ( *(_WORD *)&v12[strlen(v12) - 2] != 28014 )
  {
    dword_80483BF = (int)sub_8048274;
    v3 = sys_write(1, byte_8048065, 0x32u);
    v2 = v11;
  }
  dword_80483AF = v2 - 1;
  if ( v2 != 1 )
    goto LABEL_8;
  v4 = filename;
  while ( 1 )
  {
    addr = v4;
    v5 = sys_open(v4, 0, a2);
    if ( v5 < 0 )
    {
      v8 = sys_write(1, &word_8048052, 0x13u);
      sub_804822F(v9, 0);
      ++status;
    }
    else
    {
      fd = v5;
      v6 = sys_lseek(v5, 0, 2);
      __asm { int     80h; LINUX - sys_mmap2 }
      dword_80483BB = 192;
      ((void (__fastcall *)(int, int))dword_80483BF)(v6, 1);
      v7 = sys_close(fd);
    }
LABEL_8:
    v4 = v13;
    if ( !v13 )
      v10 = sys_exit(status);
  }
}
// 8048152: positive sp value C has been found
// 8048097: variable 'v11' is possibly undefined
// 804809C: variable 'v12' is possibly undefined
// 80480EB: variable 'a2' is possibly undefined
// 8048146: variable 'v9' is possibly undefined
// 8048151: variable 'v13' is possibly undefined
// 8048052: using guessed type __int16 word_8048052;
// 80483AF: using guessed type int dword_80483AF;
// 80483BB: using guessed type int dword_80483BB;
// 80483BF: using guessed type int dword_80483BF;

//----- (08048165) --------------------------------------------------------
int __usercall sub_8048165@<eax>(int a1@<eax>, int a2@<edx>, int a3@<edi>)
{
  int v3; // ecx
  int v4; // esi
  int v5; // ecx
  int result; // eax
  int v7; // ecx
  _DWORD *v8; // ebx
  char *v9; // esi
  int v10; // edx
  size_t v11; // edx
  char *v12; // edi
  char v13; // al
  int v14; // eax
  int v15; // [esp-28h] [ebp-28h]
  int v16; // [esp-24h] [ebp-24h]
  int v17; // [esp-20h] [ebp-20h]
  int v18; // [esp-10h] [ebp-10h]
  int v19; // [esp-Ch] [ebp-Ch]
  int v20; // [esp-8h] [ebp-8h]
  int v21; // [esp-4h] [ebp-4h]

  if ( (unsigned __int8)dword_80483AF >= 2u )
  {
    sub_8048260();
    sub_804822F(v3, 58);
  }
  v4 = a1;
  v5 = *(unsigned __int16 *)(a1 + 48);
  result = *(_DWORD *)(a1 + 32) + a1 - 40;
  while ( 1 )
  {
    result += 40;
    if ( !--v5 )
      break;
    if ( *(_BYTE *)(result + 4) == 2 )
    {
      v21 = result;
      v20 = v5;
      dword_80483C7 = result;
      v7 = (*(_DWORD *)(result + 20) >> 4) + 1;
      v8 = (_DWORD *)(dword_80483BB + *(_DWORD *)(result + 16) - 16);
      while ( --v7 )
      {
        v8 += 4;
        if ( *v8 )
        {
          v19 = v4;
          v18 = a3;
          v17 = v7;
          v16 = a2;
          v15 = result;
          v9 = (char *)(*v8
                      + dword_80483BB
                      + *(_DWORD *)(40 * *(_DWORD *)(result + 24) + *(_DWORD *)(dword_80483BB + 32) + dword_80483BB + 16));
          sub_8048211(v8[1], (int)byte_80483DB);
          v11 = v10 + 8;
          v12 = &byte_80483DB[v11 + 1];
          v13 = 32;
          do
          {
            *v12++ = v13;
            v13 = *v9++;
            ++v11;
          }
          while ( v13 );
          *v12 = 10;
          v14 = sys_write(1, &v12[-v11 + 1], v11);
          result = v15;
          a2 = v16;
          v7 = v17;
          a3 = v18;
          v4 = v19;
        }
      }
      v5 = v20;
      result = v21;
    }
  }
  return result;
}
// 8048165: could not find valid save-restore pair for edi
// 8048175: variable 'v3' is possibly undefined
// 804817A: variable 'a1' is possibly undefined
// 80481BC: variable 'a2' is possibly undefined
// 80481E9: variable 'v10' is possibly undefined
// 80483AF: using guessed type int dword_80483AF;
// 80483BB: using guessed type int dword_80483BB;
// 80483C7: using guessed type int dword_80483C7;

//----- (08048211) --------------------------------------------------------
int __usercall sub_8048211@<eax>(unsigned int a1@<ecx>, int a2@<edi>)
{
  _BYTE *v2; // edi
  int v3; // edx
  int result; // eax

  v2 = (_BYTE *)(a2 + 7);
  v3 = 8;
  do
  {
    LOBYTE(result) = (a1 & 0xF) + 48;
    if ( (char)result > 57 )
      LOBYTE(result) = (a1 & 0xF) + 87;
    *v2++ = result;
    a1 >>= 4;
    --v3;
  }
  while ( v3 );
  return result;
}

//----- (0804822F) --------------------------------------------------------
void __fastcall sub_804822F(int a1, char a2)
{
  const void *v2; // esi
  size_t v3; // ecx
  char *v4; // edi
  char *v5; // edi
  int v6; // eax

  v2 = addr;
  v3 = strlen((const char *)addr) + 1;
  v4 = (char *)addr + v3;
  if ( a2 )
  {
    v5 = v4 - 1;
    *v5 = a2;
    v4 = v5 + 1;
  }
  v6 = sys_write(1, v2, v3);
  *(v4 - 1) = 0;
  sub_8048260();
}

//----- (08048260) --------------------------------------------------------
void sub_8048260()
{
  int v0; // eax

  v0 = sys_write(1, &byte_8048273, 1u);
}
// 8048273: using guessed type char byte_8048273;

//----- (08048274) --------------------------------------------------------
int __usercall sub_8048274@<eax>(int a1@<eax>)
{
  char *v1; // edi
  char *v2; // esi
  char v3; // al
  unsigned int v5; // [esp-4h] [ebp-4h]

  dword_80483CF = 0;
  dword_80483D3 = 0;
  dword_80483D7 = 0;
  sub_804831C(*(unsigned __int16 *)(a1 + 48), (_DWORD *)(*(_DWORD *)(a1 + 32) + a1 - 40));
  sub_804837F(dword_80483CF, (int)byte_80483DB);
  sub_804837F(dword_80483D3, (int)&byte_80483DB[9]);
  sub_804837F(dword_80483D7, (int)&byte_80483DB[18]);
  v5 = dword_80483D7 + dword_80483D3 + dword_80483CF;
  sub_804837F(v5, (int)&byte_80483DB[27]);
  sub_8048359(v5, (int)&byte_80483DB[36]);
  v1 = &byte_80483DB[45];
  v2 = (char *)addr;
  v3 = 32;
  do
  {
    *v1++ = v3;
    v3 = *v2++;
  }
  while ( v3 );
  *v1 = 10;
  return sys_write(1, byte_80483DB, v1 + 1 - byte_80483DB);
}
// 80483CF: using guessed type int dword_80483CF;
// 80483D3: using guessed type int dword_80483D3;
// 80483D7: using guessed type int dword_80483D7;

//----- (0804831C) --------------------------------------------------------
void __usercall sub_804831C(int a1@<ecx>, _DWORD *a2@<edi>)
{
  int v2; // eax

  while ( --a1 >= 0 )
  {
    a2 += 10;
    v2 = a2[5];
    if ( v2 )
    {
      if ( a2[1] == 8 )
      {
        dword_80483D7 += v2;
      }
      else if ( a2[2] == 6 )
      {
        dword_80483CF += v2;
      }
      else if ( a2[2] == 3 )
      {
        dword_80483D3 += v2;
      }
    }
  }
}
// 80483CF: using guessed type int dword_80483CF;
// 80483D3: using guessed type int dword_80483D3;
// 80483D7: using guessed type int dword_80483D7;

//----- (08048359) --------------------------------------------------------
char __usercall sub_8048359@<al>(unsigned int a1@<ecx>, int a2@<edi>)
{
  char *v2; // edi
  unsigned int v3; // edx
  char v4; // al
  char result; // al

  v2 = (char *)(a2 + 7);
  v3 = 7;
  do
  {
    v4 = (a1 & 0xF) + 48;
    if ( v4 > 57 )
      v4 = (a1 & 0xF) + 87;
    *v2++ = v4;
    a1 >>= 4;
    if ( !a1 )
      break;
    --v3;
  }
  while ( v3 );
  result = 32;
  memset(v2, 32, v3);
  return result;
}

//----- (0804837F) --------------------------------------------------------
char __usercall sub_804837F@<al>(unsigned int a1@<eax>, int a2@<edi>)
{
  int v2; // ecx
  __int64 v3; // rt2
  _BYTE *v4; // edi
  int v5; // ecx
  char result; // al

  v2 = 7;
  if ( a1 )
  {
    do
    {
      if ( !a1 )
        break;
      v3 = a1 % 10LL;
      a1 /= 10LL;
      *(_BYTE *)(a2 + v2--) = v3 + 48;
    }
    while ( v2 );
  }
  else
  {
    *(_BYTE *)(a2 + 7) = 48;
    v2 = 6;
  }
  v4 = (_BYTE *)(v2 + a2);
  v5 = v2 + 1;
  result = 32;
  while ( v5 )
  {
    *v4-- = 32;
    --v5;
  }
  return result;
}

// nfuncs=9 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
