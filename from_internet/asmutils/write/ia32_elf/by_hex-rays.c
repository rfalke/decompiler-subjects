/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __cdecl __noreturn start(int, int, int);

//-------------------------------------------------------------------------
// Data declarations

char aUsageWriteUser[100] = "Usage: write user [ttyname]\nUser not logged in or permission denied\nPermission denied\n/var/run/utmp"; // weak
char directory[] = "/dev"; // idb
__int16 word_8048256 = 20293; // weak
__int16 word_804825A = 25933; // weak
char byte_8048267 = '\x1B'; // weak
int dword_8048270; // weak
int dword_8048274; // weak
int fd; // idb
int dword_804827C; // idb
int dword_8048280[2]; // weak
char filename[36]; // idb
int dword_80482AC[85]; // weak
int dword_8048400[64]; // weak


//----- (08048066) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start(int a1, int a2, int a3)
{
  int v3; // eax
  int v4; // eax
  _DWORD **v5; // esi
  _DWORD *v6; // eax
  int v7; // eax
  _BYTE *v8; // edi
  int v9; // ecx
  bool v10; // zf
  int v11; // ecx
  int v12; // eax
  mode_t v13; // edx
  int *v14; // edi
  _BYTE *v15; // esi
  _BYTE *v16; // ecx
  _BYTE *v17; // esi
  char *v18; // edi
  int v19; // ecx
  int v20; // eax
  _BYTE *v21; // edi
  char *v22; // esi
  char v23; // al
  int v24; // eax
  int v25; // eax
  size_t v26; // eax
  int v27; // eax
  int v28; // ebx
  __int16 *v29; // ecx
  size_t v30; // edx
  int v31; // eax
  int v32; // eax
  int v33; // [esp-10h] [ebp-10h]
  _BYTE *v34; // [esp-8h] [ebp-8h] BYREF
  int v35; // [esp-4h] [ebp-4h]

  if ( v33 > 3 || v33 == 1 )
  {
    v3 = sys_write(1, aUsageWriteUser, 0x1Cu);
    v4 = sys_exit(1);
  }
  v5 = (_DWORD **)&(&v34)[v33];
  while ( 1 )
  {
    v6 = *v5++;
    if ( !v6 )
      goto LABEL_8;
    if ( *v6 == 1380275029 )
    {
      v7 = (int)v6 + 5;
      if ( *(_BYTE *)(v7 - 1) == 61 )
        break;
    }
  }
  dword_8048274 = v7;
LABEL_8:
  v8 = v34;
  dword_8048270 = v35;
  v35 = (int)v34;
  v9 = 32;
  do
  {
    if ( !v9 )
      break;
    v10 = *v8++ == 0;
    --v9;
  }
  while ( !v10 );
  v11 = ~(v9 - 32);
  if ( v11 )
  {
    v34 = (_BYTE *)v11;
    fd = sys_open(&aUsageWriteUser[86], 0, 0);
    v12 = sys_chdir(directory);
    while ( 1 )
    {
      while ( 1 )
      {
        if ( !sys_read(fd, dword_8048280, 0x180u) )
          goto LABEL_33;
        v14 = dword_80482AC;
        v15 = (_BYTE *)v35;
        v16 = v34;
        do
        {
          if ( !v16 )
            break;
          v10 = *v15++ == *(_BYTE *)v14;
          v14 = (int *)((char *)v14 + 1);
          --v16;
        }
        while ( v10 );
        if ( !v16 )
        {
          v17 = (_BYTE *)dword_8048270;
          if ( !dword_8048270 )
            break;
          v18 = filename;
          v19 = 6;
          do
          {
            if ( !v19 )
              break;
            v10 = *v17++ == (unsigned __int8)*v18++;
            --v19;
          }
          while ( v10 );
          if ( !v19 )
            break;
        }
      }
      v20 = sys_open(filename, 1, v13);
      if ( v20 > 0 )
        break;
      if ( dword_8048270 )
      {
        v28 = 2;
        v29 = (_WORD *)(aUsageWriteUser + 68);
        v30 = 18;
        goto LABEL_34;
      }
    }
    dword_804827C = v20;
    qmemcpy(dword_8048400, &word_804825A, 0xDu);
    v21 = (char *)&dword_8048400[3] + 1;
    v22 = (char *)dword_8048274;
    if ( dword_8048274 )
    {
      do
      {
        v23 = *v22++;
        *v21++ = v23;
      }
      while ( v23 );
      *v21 = 10;
      v24 = sys_write(dword_804827C, dword_8048400, v21 - (_BYTE *)dword_8048400);
    }
    v25 = sys_write(dword_804827C, &byte_8048267, 9u);
    while ( 1 )
    {
      v26 = sys_read(0, dword_8048400, 0x100u);
      v28 = dword_804827C;
      if ( !v26 )
        break;
      v27 = sys_write(dword_804827C, dword_8048400, v26);
    }
    v29 = &word_8048256;
    v30 = 4;
  }
  else
  {
LABEL_33:
    v28 = 2;
    v29 = (__int16 *)&aUsageWriteUser[28];
    v30 = 40;
  }
LABEL_34:
  v31 = sys_write(v28, v29, v30);
  v32 = sys_exit(0);
}
// 804809A: positive sp value 10 has been found
// 804806A: variable 'v33' is possibly undefined
// 8048123: variable 'v13' is possibly undefined
// 8048256: using guessed type __int16 word_8048256;
// 804825A: using guessed type __int16 word_804825A;
// 8048267: using guessed type char byte_8048267;
// 8048270: using guessed type int dword_8048270;
// 8048274: using guessed type int dword_8048274;
// 8048280: using guessed type int dword_8048280[2];
// 80482AC: using guessed type int dword_80482AC[85];
// 8048400: using guessed type int dword_8048400[64];

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
