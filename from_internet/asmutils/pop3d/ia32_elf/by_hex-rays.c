/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall sub_8048253@<eax>(char@<al>, char@<dh>, _BYTE *@<ecx>);
// int __usercall sub_8048279@<eax>(unsigned int@<eax>);
// void __usercall sub_8048292(unsigned int a1@<eax>);
void sub_80482D6();
int sub_80482EE();
int sub_80484BF();
// void __usercall __noreturn start(int@<eax>, int@<ebx>);

//-------------------------------------------------------------------------
// Data declarations

int dword_804804C[7] =
{
  541806379,
  1970107233,
  1936484724,
  1886351392,
  1702043699,
  1919252082,
  1634038304
}; // weak
char byte_804806B = '\n'; // weak
char byte_8048071[3] = { '+', 'O', 'K' }; // weak
char byte_8048075[3] = { '+', 'O', 'K' }; // weak
char byte_80480B7 = '+'; // weak
char byte_80480C9[3] = { ' ', 'm', 'e' }; // weak
char byte_80480F8[2] = { '.', '\n' }; // weak
char byte_80480FA = '\n'; // weak
int dword_80480FB = 10; // weak
char byte_80480FF = ' '; // weak
int dword_8048100[6] = { 1734439765, 1881160293, 1681092719, 1869640480, 1768189039, 1869619314 }; // weak
char byte_804811B = '-'; // weak
char byte_804812B = '-'; // weak
__int16 word_8048142 = 17709; // weak
char byte_80481CF = 'E'; // weak
_UNKNOWN loc_8048257; // weak
_UNKNOWN loc_804825B; // weak
char byte_8048CC6 = '\0'; // weak
char byte_8048CC7 = '\0'; // weak
int dword_8048EC8; // weak
char filename[4112]; // idb
int dword_8049EDC[16383]; // weak
char byte_8059EDB; // weak
char byte_8059EE5[3]; // weak
char byte_8059EEF[]; // weak
__int16 word_8059FEE; // weak
char byte_805A0ED; // weak
char byte_805A0EE; // weak
int dword_805A0F9; // weak
int dword_805A105; // idb
int dword_805A109; // weak
int fd; // idb
int dword_805A111; // weak
char byte_805A12F[]; // weak
int dword_805A130; // weak
int dword_805A148; // weak
size_t len; // idb


//----- (08048253) --------------------------------------------------------
int __usercall sub_8048253@<eax>(char a1@<al>, char a2@<dh>, _BYTE *a3@<ecx>)
{
  *a3 ^= a2;
  _AL = a1 ^ 0x35;
  __asm { aaa }
  return sub_8048279(_AL);
}

//----- (08048279) --------------------------------------------------------
int __usercall sub_8048279@<eax>(unsigned int a1@<eax>)
{
  sub_8048292(a1);
  return sys_write(fd, &byte_80480FA, 1u);
}
// 80480FA: using guessed type char byte_80480FA;

//----- (08048292) --------------------------------------------------------
void __usercall sub_8048292(unsigned int a1@<eax>)
{
  char *v1; // edi
  unsigned int v2; // et2
  int v3; // eax

  v1 = byte_805A12F;
  do
  {
    v2 = a1 % dword_80480FB;
    a1 /= (unsigned int)dword_80480FB;
    *v1-- = v2 + 48;
  }
  while ( a1 );
  v3 = sys_write(fd, v1 + 1, byte_805A12F - v1);
}
// 80480FB: using guessed type int dword_80480FB;

//----- (080482D6) --------------------------------------------------------
void sub_80482D6()
{
  int v0; // eax

  v0 = sys_write(fd, dword_804804C, 0x1Fu);
}
// 804804C: using guessed type int dword_804804C[7];

//----- (080482EE) --------------------------------------------------------
int sub_80482EE()
{
  int *v0; // esi
  char *v1; // edi
  int v2; // ecx
  char v3; // al
  int *v4; // ebx
  char *v5; // edi
  int v6; // ecx
  char v7; // al
  int v8; // eax
  int v9; // ecx
  char *v10; // edi
  int (__usercall *v11)@<eax>(char@<al>, char@<dh>, _BYTE *@<ecx>); // esi
  bool v12; // zf
  int v13; // ecx
  int v14; // eax
  int v15; // eax
  char *v16; // edi
  _BYTE *v17; // esi
  int v18; // ecx
  int v19; // ecx
  char *v20; // ebx
  char *v21; // ecx
  char *i; // ecx
  int v23; // eax
  char *v24; // edi
  _BYTE *v25; // esi
  int v26; // ecx

  v0 = dword_8049EDC;
  v1 = &byte_8059EDB;
  v2 = 256;
  while ( 1 )
  {
    v3 = *(_BYTE *)v0;
    v0 = (int *)((char *)v0 + 1);
    if ( v3 == 32 )
      break;
    if ( v3 != 10 )
    {
      *v1++ = v3;
      if ( --v2 )
        continue;
    }
    dword_805A0F9 = (char *)v0 - (char *)dword_8049EDC - 2;
    goto LABEL_13;
  }
  dword_805A0F9 = (char *)v0 - (char *)dword_8049EDC - 1;
  v4 = v0;
  v5 = byte_8059EE5;
  v6 = 256;
  while ( 1 )
  {
    v7 = *(_BYTE *)v0;
    v0 = (int *)((char *)v0 + 1);
    if ( v7 == 32 )
      break;
    if ( v7 == 10 )
    {
      v0 = (int *)((char *)v0 - 1);
      break;
    }
    *v5++ = v7;
    if ( !--v6 )
      goto LABEL_13;
  }
  dword_805A109 = (char *)v0 - (char *)v4 - 1;
LABEL_13:
  if ( (char)dword_805A0F9 < 4 )
  {
    v8 = sys_write(fd, &word_8048142, 0x30u);
    goto LABEL_38;
  }
  if ( byte_805A0ED != 1 )
  {
    v9 = dword_805A0F9;
    v10 = &byte_8059EDB;
    v11 = sub_8048253;
    do
    {
      if ( !v9 )
        break;
      v12 = *(_BYTE *)v11 == (unsigned __int8)*v10;
      v11 = (int (__usercall *)@<eax>(char@<al>, char@<dh>, _BYTE *@<ecx>))((char *)v11 + 1);
      ++v10;
      --v9;
    }
    while ( v12 );
    if ( !v9 )
    {
      byte_805A0EE = 1;
      v13 = dword_805A109;
      qmemcpy(byte_8059EEF, byte_8059EE5, dword_805A109);
      byte_8059EEF[v13] = 0;
      v14 = sys_write(fd, byte_8048071, 4u);
      goto LABEL_38;
    }
    if ( !byte_805A0EE )
    {
      v15 = sys_write(fd, &byte_804811B, 0x10u);
      goto LABEL_38;
    }
    v16 = &byte_8059EDB;
    v17 = &loc_8048257;
    v18 = dword_805A0F9;
    do
    {
      if ( !v18 )
        break;
      v12 = *v17++ == (unsigned __int8)*v16++;
      --v18;
    }
    while ( v12 );
    if ( !v18 )
    {
      v19 = dword_805A109;
      qmemcpy(&word_8059FEE, byte_8059EE5, dword_805A109);
      *((_BYTE *)&word_8059FEE + v19 + 1) = 0;
      byte_805A0ED = 1;
      v20 = filename;
      v21 = (char *)dword_8048EC8;
      do
        *v20++ = *v21++;
      while ( *v21 );
      for ( i = byte_8059EEF; ; ++i )
      {
        *v20 = *i;
        if ( !*v20 )
          break;
        ++v20;
      }
      byte_8048CC6 = 1;
      byte_8048CC7 = 0;
      sub_80484BF();
      sys_write(fd, &byte_80480B7, 0x12u);
      sub_8048292(dword_805A130);
      byte_8048CC6 = 0;
      v23 = sys_write(fd, byte_80480C9, 0xAu);
LABEL_38:
      JUMPOUT(0x8048B3A);
    }
  }
  v24 = &byte_8059EDB;
  v25 = &loc_804825B;
  v26 = dword_805A0F9;
  do
  {
    if ( !v26 )
      break;
    v12 = *v25++ == (unsigned __int8)*v24++;
    --v26;
  }
  while ( v12 );
  if ( v26 )
    JUMPOUT(0x8048659);
  return sub_80484BF();
}
// 804836B: control flows out of bounds to 8048B3A
// 80484B9: control flows out of bounds to 8048659
// 80480B7: using guessed type char byte_80480B7;
// 804811B: using guessed type char byte_804811B;
// 8048142: using guessed type __int16 word_8048142;
// 8048CC6: using guessed type char byte_8048CC6;
// 8048CC7: using guessed type char byte_8048CC7;
// 8048EC8: using guessed type int dword_8048EC8;
// 8049EDC: using guessed type int dword_8049EDC[16383];
// 8059EDB: using guessed type char byte_8059EDB;
// 8059FEE: using guessed type __int16 word_8059FEE;
// 805A0ED: using guessed type char byte_805A0ED;
// 805A0EE: using guessed type char byte_805A0EE;
// 805A0F9: using guessed type int dword_805A0F9;
// 805A109: using guessed type int dword_805A109;
// 805A130: using guessed type int dword_805A130;

//----- (080484BF) --------------------------------------------------------
int sub_80484BF()
{
  int result; // eax
  int v1; // eax
  char *v2; // edi
  int v3; // ebp
  int *v4; // ecx
  int *v5; // ebx
  int *v6; // edx
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // eax
  int v12; // [esp-20h] [ebp-20h]
  int v13; // [esp-20h] [ebp-20h]
  int *v14; // [esp-1Ch] [ebp-1Ch]
  int v15; // [esp-Ch] [ebp-Ch]

  dword_805A105 = sys_open(filename, 0, 0);
  if ( dword_805A105 < 0 )
    return sys_write(fd, &byte_804812B, 0x17u);
  v1 = 0;
  dword_805A130 = 0;
  dword_805A148 = 0;
  v2 = &byte_804806B;
LABEL_4:
  v12 = v1;
  len = sys_read(dword_805A105, dword_8049EDC, 0xFFFFu);
  if ( len )
  {
    v1 = v12;
    v3 = v15;
    v4 = dword_8049EDC;
    v5 = dword_8049EDC;
    v6 = (int *)((char *)dword_8049EDC + len);
    while ( 1 )
    {
      LOBYTE(v1) = *(_BYTE *)v4;
      if ( *(_BYTE *)v4 != *v2 )
        goto LABEL_10;
      if ( ++v2 == &byte_804806B + 6 )
        break;
LABEL_11:
      v4 = (int *)((char *)v4 + 1);
      if ( v4 == v6 )
        goto LABEL_4;
    }
    ++dword_805A130;
    if ( byte_8048CC7 )
    {
      v15 = v3;
      v14 = v6;
      v13 = v1;
      sub_8048292(dword_805A130);
      v7 = sys_write(fd, &byte_80480FF, 1u);
      sub_8048279(dword_805A148);
      v1 = v13;
      v6 = v14;
      dword_805A148 = 0;
    }
LABEL_10:
    v2 = &byte_804806B;
    v4 = v5;
    ++dword_805A148;
    v5 = (int *)((char *)v5 + 1);
    goto LABEL_11;
  }
  result = v12;
  ++dword_805A130;
  if ( byte_8048CC7 )
  {
    sub_8048292(dword_805A130);
    v8 = sys_write(fd, &byte_80480FF, 1u);
    sub_8048279(dword_805A148);
    v9 = sys_write(fd, byte_80480F8, 2u);
    byte_8048CC7 = 0;
  }
  else
  {
    if ( byte_8048CC6 )
    {
      byte_8048CC6 = 0;
      return result;
    }
    v10 = sys_write(fd, byte_8048075, 4u);
    sub_8048292(dword_805A130);
    v11 = sys_write(fd, &byte_80480FF, 1u);
    sub_8048279(dword_805A148);
  }
  return sys_close(dword_805A105);
}
// 80484BF: could not find valid save-restore pair for edi
// 80484BF: could not find valid save-restore pair for esi
// 804852B: variable 'v15' is possibly undefined
// 804806B: using guessed type char byte_804806B;
// 80480FF: using guessed type char byte_80480FF;
// 804812B: using guessed type char byte_804812B;
// 8048CC6: using guessed type char byte_8048CC6;
// 8048CC7: using guessed type char byte_8048CC7;
// 8049EDC: using guessed type int dword_8049EDC[16383];
// 805A130: using guessed type int dword_805A130;
// 805A148: using guessed type int dword_805A148;

//----- (08048B3F) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(int a1@<eax>, int a2@<ebx>)
{
  unsigned __int8 *v2; // esi
  unsigned __int8 v3; // al
  bool v4; // cf
  char v5; // t0
  int v6; // ebx
  _BYTE *v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // [esp-10h] [ebp-10h]
  int v12; // [esp-8h] [ebp-8h]
  unsigned __int8 *v13; // [esp-4h] [ebp-4h]

  if ( v11 == 3 )
  {
    dword_8048EC8 = v12;
    v2 = v13;
    byte_805A0ED = 0;
    byte_805A0EE = 0;
    while ( 1 )
    {
      v3 = *v2++;
      v4 = v3 < 0x30u;
      LOBYTE(a1) = v3 - 48;
      if ( v4 || (unsigned __int8)a1 > 9u )
        break;
      a2 = a1 + 10 * a2;
    }
    v5 = BYTE1(a2);
    BYTE1(a2) = a2;
    LOBYTE(a2) = v5;
    v6 = a2 << 16;
    LOBYTE(v6) = 2;
    dword_805A111 = v6;
    v7 = (_BYTE *)dword_8048EC8;
    do
      ++v7;
    while ( *v7 );
    if ( *(v7 - 1) != 47 )
    {
      v8 = sys_write(1, &byte_80481CF, 0x34u);
      goto LABEL_12;
    }
    __asm
    {
      int     80h; LINUX - sys_socket
      int     80h; LINUX - sys_setsockopt
    }
  }
  v9 = sys_write(1, dword_8048100, 0x1Bu);
LABEL_12:
  v10 = sys_exit(1);
}
// 8048B51: positive sp value 10 has been found
// 8048B43: variable 'v11' is possibly undefined
// 8048B4A: variable 'v12' is possibly undefined
// 8048B50: variable 'v13' is possibly undefined
// 8048100: using guessed type int dword_8048100[6];
// 80481CF: using guessed type char byte_80481CF;
// 8048DC9: using guessed type int dword_8048DC9;
// 8048EC8: using guessed type int dword_8048EC8;
// 805A0ED: using guessed type char byte_805A0ED;
// 805A0EE: using guessed type char byte_805A0EE;
// 805A111: using guessed type int dword_805A111;

// nfuncs=7 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
