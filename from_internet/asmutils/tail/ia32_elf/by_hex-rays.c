/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall start(int, mode_t);
void __fastcall sub_80480FA(int);

//-------------------------------------------------------------------------
// Data declarations

int dword_804818F; // weak
char byte_8048193; // weak
char byte_804C193; // weak
char byte_8050193; // weak
struct stat buf; // idb
int dword_805419B; // weak
int dword_80541A7; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall start(int a1, mode_t a2)
{
  unsigned __int8 *v2; // esi
  int v3; // ebp
  int v4; // ebx
  int v5; // ebx
  int i; // eax
  unsigned __int8 v7; // al
  bool v8; // cf
  int v9; // eax
  int v10; // eax
  int v11; // eax
  char *v12; // ecx
  int v13; // eax
  char *v14; // ecx
  int v15; // eax
  char *v16; // edx
  int v17; // ebx
  char *v18; // ecx
  int v19; // eax
  char *v20; // ecx
  size_t v21; // edx
  int v22; // eax
  int v23; // ecx
  size_t v24; // edx
  char *v25; // ecx
  char *v26; // eax
  int v27; // eax
  int v28; // [esp-14h] [ebp-14h]
  _BYTE *v29; // [esp-Ch] [ebp-Ch]
  unsigned __int8 *v30; // [esp-8h] [ebp-8h]
  int v31; // [esp-4h] [ebp-4h]

  v2 = (_BYTE *)(start + 1);
  LOBYTE(dword_804818F) = 10;
  v3 = 0;
  if ( v28 != 1 )
  {
    v4 = (int)v29;
    if ( *v29 != 45 )
      goto LABEL_10;
    v2 = v29 + 1;
    if ( v29[1] == 110 )
      v2 = v30;
    v5 = 0;
    for ( i = 0; ; v5 = i + 10 * v5 )
    {
      v7 = *v2++;
      v8 = v7 < 0x30u;
      LOBYTE(i) = v7 - 48;
      if ( v8 || (char)i > 9 )
        break;
    }
    dword_804818F = v5;
    v4 = v31;
    if ( v31 )
    {
LABEL_10:
      v9 = sys_open((char *)v4, 0, a2);
      if ( v9 < 0 )
        goto LABEL_20;
      v3 = v9;
    }
  }
  v10 = sys_newfstat(v3, &buf);
  if ( (dword_805419B & 0x8000) != 0 && (unsigned int)dword_80541A7 > 0x4000 )
    v11 = sys_lseek(v3, dword_80541A7 - 0x4000, 0);
  v12 = &byte_8048193;
  if ( *(v2 - 1) == 99 )
  {
    v20 = &byte_8048193;
    v4 = v3;
    v21 = 0x4000;
    while ( 1 )
    {
      v22 = sys_read(v3, v20, v21);
      if ( v22 < 0 )
        goto LABEL_20;
      if ( !v22 )
        break;
      v20 = (char *)(v22 + v23);
      if ( v20 >= &byte_8050193 )
        sub_80480FA((int)v20);
    }
    v24 = dword_804818F;
    v25 = (char *)(v23 - dword_804818F);
    if ( v25 < &byte_8048193 )
    {
      v26 = v25;
      v25 = &byte_8048193;
      v24 = v26 - &byte_8048193 + dword_804818F;
    }
    v4 = 1;
    v27 = sys_write(1, v25, v24);
LABEL_20:
    v15 = sys_exit(v4);
  }
  do
  {
    v4 = v3;
    v13 = sys_read(v3, v12, 0x4000u);
    if ( v13 < 0 )
      goto LABEL_20;
    if ( !v13 )
    {
      if ( v14 != &byte_8048193 )
      {
        v16 = v14;
        v17 = dword_804818F + 1;
        v18 = v14 - 1;
LABEL_23:
        if ( --v17 )
        {
          while ( --v18 != &byte_8048193 )
          {
            if ( *v18 == 10 )
              goto LABEL_23;
          }
        }
        else
        {
          ++v18;
        }
        v4 = 1;
        v19 = sys_write(1, v18, v16 - v18);
      }
      goto LABEL_20;
    }
    v12 = &v14[v13];
  }
  while ( (int)v12 <= (int)&byte_8050193 );
  sub_80480FA((int)v12);
}
// 8048089: positive sp value 14 has been found
// 804805C: variable 'v28' is possibly undefined
// 804805F: variable 'v29' is possibly undefined
// 804806D: variable 'v30' is possibly undefined
// 8048088: variable 'v31' is possibly undefined
// 80480EB: variable 'v14' is possibly undefined
// 8048156: variable 'v20' is possibly undefined
// 8048156: variable 'v21' is possibly undefined
// 804815E: variable 'v23' is possibly undefined
// 804818F: using guessed type int dword_804818F;
// 8048193: using guessed type char byte_8048193;
// 8050193: using guessed type char byte_8050193;
// 805419B: using guessed type int dword_805419B;
// 80541A7: using guessed type int dword_80541A7;

//----- (080480FA) --------------------------------------------------------
void __fastcall sub_80480FA(int a1)
{
  qmemcpy(&byte_8048193, &byte_804C193, a1 - (_DWORD)&byte_804C193);
}
// 8048193: using guessed type char byte_8048193;
// 804C193: using guessed type char byte_804C193;

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
