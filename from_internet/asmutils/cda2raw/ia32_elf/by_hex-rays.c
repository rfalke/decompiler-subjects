/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// char __usercall sub_804804C@<al>(int _EAX@<eax>, _BYTE *@<esi>);
void __fastcall __noreturn start(int, mode_t, int);

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "/dev/cdrom"; // idb
char byte_80482C5[3] = { '$', ' ', 'c' }; // weak
char aTrack00Raw[] = "track00.raw"; // idb
char byte_80482F9[3]; // weak
__int16 word_8048C2A; // weak
char byte_8048C2C; // weak
char byte_8048C2D; // weak


//----- (0804804C) --------------------------------------------------------
char __usercall sub_804804C@<al>(int _EAX@<eax>, _BYTE *a2@<esi>)
{
  _BYTE *v2; // esi
  unsigned __int8 v3; // ah
  bool v4; // cf

  LOBYTE(_EAX) = *a2;
  v2 = a2 + 1;
  if ( (_BYTE)_EAX )
  {
    v3 = _EAX;
    LOBYTE(_EAX) = *v2;
    v4 = v3 < 0x30u;
    BYTE1(_EAX) = v3 - 48;
    if ( !v4 )
    {
      v4 = (unsigned __int8)_EAX < 0x30u;
      LOBYTE(_EAX) = _EAX - 48;
      if ( !v4 && SBYTE1(_EAX) <= 9 && (char)_EAX <= 9 )
        __asm { aad }
    }
  }
  return _EAX;
}

//----- (0804806C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2, int a3)
{
  int v3; // eax
  char *v4; // ebp
  _BYTE *v5; // esi
  int v6; // eax
  char v7; // cf
  char v8; // zf
  _BYTE *v9; // esi
  int v10; // eax
  int v11; // ebp
  int v12; // eax
  int v13; // eax
  char v16; // t1
  int v17; // eax
  int v18; // edi
  int v19; // eax
  unsigned __int32 v20; // eax
  char v21; // al
  int v22; // eax
  int v23; // eax
  int v24; // eax
  int v25; // [esp+4h] [ebp-Ch]
  int v26; // [esp+8h] [ebp-8h]
  unsigned int v27; // [esp+8h] [ebp-8h]
  char *v28; // [esp+Ch] [ebp-4h]

  v3 = v26;
  v4 = filename;
  while ( v28 )
  {
    if ( *v28 == 45 )
    {
      LOBYTE(v3) = v28[1];
      v5 = v28 + 2;
      if ( (_BYTE)v3 == 115 )
      {
        if ( *v5 )
          goto LABEL_49;
        ++byte_8048C2D;
      }
      else
      {
        if ( (_BYTE)v3 != 116 )
          goto LABEL_49;
        ++byte_8048C2C;
        sub_804804C(v3, v5);
        if ( v7 | v8 )
          goto LABEL_49;
        LOBYTE(v6) = *v5;
        v9 = v28 + 3;
        if ( (_BYTE)v6 != 45 )
          goto LABEL_49;
        LOBYTE(v3) = sub_804804C(v6, v9);
        if ( v7 | v8 )
          goto LABEL_49;
        if ( (char)a2 > (char)v3 )
          goto LABEL_50;
        BYTE1(a2) = v3;
        word_8048C2A = a2;
        if ( *v9 )
        {
LABEL_49:
          v22 = sys_write(2, byte_80482C5, 0x28u);
          goto LABEL_50;
        }
      }
    }
    else
    {
      if ( *v28 != 47 )
        goto LABEL_49;
      v4 = v28;
    }
  }
  v10 = sys_open(v4, 2048, a2);
  if ( v10 < 0 )
    goto LABEL_50;
  v11 = v10;
  while ( 1 )
  {
    v12 = sys_ioctl(v11, 21286);
    if ( v12 == 1 )
      goto LABEL_50;
    if ( v12 != 2 )
      break;
    if ( sys_ioctl(v11, 21273) < 0 )
      goto LABEL_50;
  }
  if ( v12 == 3 || (v13 = sys_ioctl(v11, 21253), v13 < 0) )
LABEL_50:
    v23 = sys_exit(1);
  _EAX = 0;
  if ( *((_BYTE *)&word_8048C2A + 2) )
  {
    if ( (word_8048C2A & 0x80u) != 0 )
      goto LABEL_50;
    if ( SHIBYTE(word_8048C2A) <= 0 )
      goto LABEL_33;
  }
  else
  {
    LOBYTE(word_8048C2A) = 0;
  }
  HIBYTE(word_8048C2A) = 0;
LABEL_33:
  *((_BYTE *)&word_8048C2A - 1) = 0;
  if ( *((_BYTE *)&word_8048C2A + 3) )
  {
LABEL_34:
    LOBYTE(_EAX) = word_8048C2A;
    __asm { aam }
    LOWORD(_EAX) = _EAX + 12336;
    v16 = BYTE1(_EAX);
    BYTE1(_EAX) = _EAX;
    LOBYTE(_EAX) = v16;
    *(_WORD *)&aTrack00Raw[5] = _EAX;
  }
  v17 = sys_open(aTrack00Raw, 577, 0x1A4u);
  if ( v17 >= 0 )
  {
    v18 = v17;
    while ( 1 )
    {
      v19 = 0x20000;
      LOBYTE(v19) = word_8048C2A;
      v27 = 0;
      v25 = v19;
      if ( sys_ioctl(v11, 21254) < 0 )
        goto LABEL_50;
      _EAX = v25;
      if ( (v25 & 0x4000) == 0 )
        break;
LABEL_46:
      v21 = HIBYTE(word_8048C2A);
      LOBYTE(word_8048C2A) = word_8048C2A + 1;
      if ( v21 < (char)word_8048C2A )
        v24 = sys_exit(0);
      if ( *((_BYTE *)&word_8048C2A + 3) )
        goto LABEL_34;
    }
    if ( sys_ioctl(v11, 21254) >= 0 )
    {
      while ( sys_ioctl(v11, 21262) >= 0 && sys_write(v18, byte_80482F9, 0x930u) >= 0 )
      {
        v20 = _byteswap_ulong(v27) >> 8;
        LOBYTE(v20) = v20 + 1;
        if ( (char)v20 >= 75 )
        {
          LOBYTE(v20) = 0;
          ++BYTE1(v20);
          if ( SBYTE1(v20) >= 60 )
          {
            BYTE1(v20) = 0;
            v20 += 0x10000;
          }
        }
        _EAX = _byteswap_ulong(v20 << 8);
        v27 = _EAX;
        if ( !_EAX )
          goto LABEL_46;
      }
    }
  }
  goto LABEL_50;
}
// 8048074: positive sp value C has been found
// 804806D: variable 'v26' is possibly undefined
// 8048076: variable 'v28' is possibly undefined
// 80480AB: variable 'v3' is possibly undefined
// 80480B0: variable 'v7' is possibly undefined
// 80480B0: variable 'v8' is possibly undefined
// 80480C1: variable 'v6' is possibly undefined
// 80480CE: variable 'a2' is possibly undefined
// 8048C2A: using guessed type __int16 word_8048C2A;
// 8048C2C: using guessed type char byte_8048C2C;
// 8048C2D: using guessed type char byte_8048C2D;

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
