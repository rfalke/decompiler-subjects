/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall sub_8048B47@<eax>(unsigned int@<ecx>, int@<edi>);
void __cdecl __noreturn start();

//-------------------------------------------------------------------------
// Data declarations

int dword_80487CB[] = { 3421804 }; // weak
char byte_8048D42 = '\n'; // weak
char byte_8048D43 = ' '; // weak
pid_t pid; // idb
char byte_8048D9B; // weak
char byte_804906B; // weak
int dword_8049083; // weak
int dword_8049097; // weak


//----- (08048B47) --------------------------------------------------------
int __usercall sub_8048B47@<eax>(unsigned int a1@<ecx>, int a2@<edi>)
{
  char *v2; // edi
  int v3; // edx
  char v4; // al
  char *v5; // esi
  char *v6; // edi
  int result; // eax
  unsigned int v8; // ecx

  v2 = (char *)(a2 + 7);
  v3 = 8;
  do
  {
    v4 = (a1 & 0xF) + 48;
    if ( v4 > 57 )
      v4 = (a1 & 0xF) + 87;
    *v2++ = v4;
    a1 >>= 4;
    if ( !a1 )
      break;
    --v3;
  }
  while ( v3 );
  v5 = v2;
  v6 = v2 - 1;
  result = 9 - v3;
  v8 = 9 - v3 + 1;
  qmemcpy(v6, v5, v8);
  v6[v8 + 9 - v3] = 0;
  return result;
}

//----- (08048B82) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start()
{
  int v0; // eax
  int v1; // eax
  const char *v2; // edi
  unsigned int v3; // kr04_4
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // eax
  int v12; // eax
  int v13; // [esp-8h] [ebp-8h]

  if ( v13 != 1 )
  {
    __asm { int     80h; LINUX - sys_fork }
    pid = 2;
    if ( sys_wait4(-1, 0, 0, 0) >= 0 )
    {
      v0 = sys_ptrace(24, pid, (void *)1, 0);
      while ( sys_wait4(-1, 0, 0, 0) >= 0 )
      {
        v1 = sys_ptrace(12, pid, 0, &byte_804906B);
        v2 = (const char *)dword_80487CB[dword_8049097];
        v3 = strlen(v2) + 1;
        v4 = sys_write(1, &v2[v3 + 1 + ~v3], v3 - 1);
        v5 = sys_write(1, &byte_8048D43, 4u);
        v6 = sys_ptrace(24, pid, (void *)1, 0);
        v7 = sys_wait4(-1, 0, 0, 0);
        v8 = sys_ptrace(12, pid, 0, &byte_804906B);
        v9 = sys_write(1, &byte_8048D9B, sub_8048B47(dword_8049083, (int)&byte_8048D9B));
        v10 = sys_write(1, &byte_8048D42, 1u);
        v11 = sys_ptrace(24, pid, (void *)1, 0);
      }
    }
  }
  v12 = sys_exit(1);
}
// 8048B8F: positive sp value 8 has been found
// 8048B88: variable 'v13' is possibly undefined
// 80487CB: using guessed type int dword_80487CB[];
// 8048D42: using guessed type char byte_8048D42;
// 8048D43: using guessed type char byte_8048D43;
// 8048D9B: using guessed type char byte_8048D9B;
// 804906B: using guessed type char byte_804906B;
// 8049083: using guessed type int dword_8049083;
// 8049097: using guessed type int dword_8049097;

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
