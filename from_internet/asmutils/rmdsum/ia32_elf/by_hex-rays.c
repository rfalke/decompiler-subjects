/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(int *a1@<esi>);
// void __usercall sub_80482F3(int a1@<ecx>, int a2@<edi>, int a3@<eax>, int a4@<edx>);
void sub_80483E9();
// void __usercall sub_8048440(unsigned int a1@<ecx>, int a2@<esi>, int a3@<eax>);
// void __usercall sub_804846A(int *@<edi>);

//-------------------------------------------------------------------------
// Data declarations

void *off_8048126 = &loc_80482B6; // weak
int dword_80484E4[5]; // weak
int dword_80484F8; // weak
int dword_80484FC; // weak
int dword_8048500[416]; // weak
int dword_8048B80[8192]; // weak
int dword_8050B80[5]; // weak
int dword_8050B94[11]; // weak
int dword_8050BC0; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(int *a1@<esi>)
{
  mode_t v2; // edx
  int v3; // edi
  int v4; // ebp
  int v5; // eax
  int v6; // ecx
  int *v7; // esi
  int *v8; // edi
  char v9; // al
  int v10; // edx
  char v11; // ah
  char v12; // al
  int v13; // eax
  int v14; // ecx
  char *v15; // ecx
  size_t v16; // edx
  int v17; // eax
  int v18; // eax
  int v19; // eax
  char *v20; // [esp-24h] [ebp-24h]
  mode_t v21; // [esp-1Ch] [ebp-1Ch]
  int v22; // [esp-Ch] [ebp-Ch]
  int v23; // [esp-8h] [ebp-8h]
  int *v24; // [esp-4h] [ebp-4h]

  sub_80483E9();
  v3 = 0;
  v4 = 0;
  if ( v22 == 1 )
    goto LABEL_5;
  while ( 1 )
  {
    while ( 1 )
    {
      if ( !v24 )
        v19 = sys_exit(0);
      dword_8050BC0 = (int)v24;
      v4 = sys_open((char *)v24, 0, v2);
      if ( v4 >= 0 )
        break;
LABEL_4:
      ++v3;
    }
    while ( 1 )
    {
LABEL_5:
      v5 = sys_read(v4, dword_8048B80, 0x2000u);
      if ( v5 < 0 )
        goto LABEL_4;
      if ( !v5 )
        break;
      a1 = dword_8048B80;
      sub_8048440(v5, (int)dword_8048B80, v5);
    }
    v24 = a1;
    v23 = v3;
    v21 = v2;
    sub_804846A(dword_8050B80);
    v6 = 20;
    v7 = dword_8050B80;
    v8 = &dword_8050B80[5];
    do
    {
      v9 = *(_BYTE *)v7;
      v7 = (int *)((char *)v7 + 1);
      v10 = 2;
      v11 = v9;
      do
      {
        v11 = __ROL1__(v11, 4);
        v12 = (v11 & 0xF) + 48;
        if ( v12 > 57 )
          v12 = (v11 & 0xF) + 87;
        *(_BYTE *)v8 = v12;
        v8 = (int *)((char *)v8 + 1);
        --v10;
      }
      while ( v10 );
      --v6;
    }
    while ( v6 );
    *v8 = 170729504;
    v13 = sys_write(1, dword_8050B94, 0x2Au);
    sub_80483E9();
    v15 = (char *)(v14 + 42);
    v16 = 2;
    if ( dword_8050BC0 )
    {
      v20 = v15;
      v17 = sys_write(1, (const void *)dword_8050BC0, strlen((const char *)dword_8050BC0));
      v15 = v20 + 1;
      v16 = 1;
    }
    v18 = sys_write(1, v15, v16);
    v2 = v21;
    v3 = v23;
    a1 = v24;
  }
}
// 804805B: positive sp value C has been found
// 8048058: variable 'v22' is possibly undefined
// 804805D: variable 'v24' is possibly undefined
// 804806E: variable 'v2' is possibly undefined
// 80480ED: variable 'v14' is possibly undefined
// 8048B80: using guessed type int dword_8048B80[8192];
// 8050B80: using guessed type int dword_8050B80[5];
// 8050B94: using guessed type int dword_8050B94[11];
// 8050BC0: using guessed type int dword_8050BC0;

//----- (080482F3) --------------------------------------------------------
void __usercall sub_80482F3(int a1@<ecx>, int a2@<edi>, int a3@<eax>, int a4@<edx>)
{
  _DWORD *v4; // ebp
  int *v5; // esi
  int v6; // ecx
  int v7; // ecx
  _DWORD *v8; // ebp
  int v9; // [esp-54h] [ebp-54h]
  int v10; // [esp-50h] [ebp-50h]
  int v11; // [esp-4Ch] [ebp-4Ch]
  _BYTE v12[20]; // [esp-48h] [ebp-48h] BYREF
  _BYTE v13[20]; // [esp-34h] [ebp-34h] BYREF
  _DWORD v14[8]; // [esp-20h] [ebp-20h] BYREF
  void *retaddr; // [esp+0h] [ebp+0h] BYREF

  v14[6] = a2;
  v14[4] = &retaddr;
  v14[2] = a1;
  v14[1] = a4;
  v14[0] = a3;
  v4 = v14;
  v11 = a2;
  v9 = 5;
  qmemcpy(v12, dword_80484E4, sizeof(v12));
  qmemcpy(v13, dword_80484E4, sizeof(v13));
  v5 = &dword_80484E4[23];
  v6 = 2;
  do
  {
    v11 = v6;
    v7 = 16;
    do
    {
      v10 = v7;
      *(v4 - 10) = *(v4 - 6) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 8), *(v4 - 7));
      *(v4 - 8) = __ROL4__(*(v4 - 8), 10);
      *(v4 - 6) = *(v4 - 7) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 9), *(v4 - 8));
      *(v4 - 9) = __ROL4__(*(v4 - 9), 10);
      *(v4 - 7) = *(v4 - 8) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 10), *(v4 - 9));
      *(v4 - 10) = __ROL4__(*(v4 - 10), 10);
      *(v4 - 8) = *(v4 - 9) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 6), *(v4 - 10));
      *(v4 - 6) = __ROL4__(*(v4 - 6), 10);
      *(v4 - 9) = *(v4 - 10) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 7), *(v4 - 6));
      *(v4 - 7) = __ROL4__(*(v4 - 7), 10);
      v7 = v10 - 1;
    }
    while ( v10 != 1 );
    v4 += 5;
    v6 = v11 - 1;
  }
  while ( v11 != 1 );
  v8 = v4 - 10;
  v11 = dword_80484E4[1] + *(v8 - 8) + *(v8 - 2);
  dword_80484E4[1] = dword_80484E4[2] + *(v8 - 7) + *(v8 - 1);
  dword_80484E4[2] = dword_80484E4[3] + *(v8 - 6) + *(v8 - 5);
  dword_80484E4[3] = dword_80484E4[4] + *(v8 - 10) + *(v8 - 4);
  dword_80484E4[4] = dword_80484E4[0] + *(v8 - 9) + *(v8 - 3);
  dword_80484E4[0] = v11;
}
// 80482F3: could not find valid save-restore pair for edi
// 80484E4: using guessed type int dword_80484E4[5];

//----- (080483E9) --------------------------------------------------------
void sub_80483E9()
{
  int *v0; // edi
  void **v1; // esi
  int v2; // ecx
  void *v3; // ebx
  void *v4; // edx
  int v5; // ecx
  __int16 v6; // ax
  int v7; // [esp-24h] [ebp-24h]

  dword_80484E4[0] = 1732584193;
  dword_80484E4[1] = -271733879;
  dword_80484E4[2] = -1732584194;
  dword_80484E4[3] = 271733878;
  dword_80484E4[4] = -1009589776;
  dword_80484E4[5] = 0;
  dword_80484E4[6] = 0;
  memset(&dword_80484E4[7], 0, 0x40u);
  v0 = &dword_80484E4[23];
  v1 = &off_8048126;
  v2 = 10;
  do
  {
    v7 = v2;
    v3 = *v1;
    v4 = v1[1];
    v1 += 2;
    v5 = 16;
    do
    {
      v6 = *(_WORD *)v1;
      v1 = (void **)((char *)v1 + 2);
      *v0 = (int)v3;
      v0[1] = (int)v4;
      *((_WORD *)v0 + 4) = v6;
      v0 = (int *)((char *)v0 + 10);
      --v5;
    }
    while ( v5 );
    v2 = v7 - 1;
  }
  while ( v7 != 1 );
}
// 8048126: using guessed type void *off_8048126;
// 80484E4: using guessed type int dword_80484E4[5];

//----- (08048440) --------------------------------------------------------
void __usercall sub_8048440(unsigned int a1@<ecx>, int a2@<esi>, int a3@<eax>)
{
  int v4; // edx
  int i; // ecx
  int v6; // ecx
  int v7; // eax

  v4 = a1;
  for ( i = a1 >> 6; i; i = v6 - 1 )
  {
    sub_80482F3(i, a2, a3, v4);
    a2 += 64;
  }
  v7 = v4 + dword_80484F8;
  if ( v4 + dword_80484F8 < dword_80484F8 )
    ++*(&dword_80484F8 + 1);
  dword_80484F8 = v7;
}
// 804844A: variable 'a3' is possibly undefined
// 804844A: variable 'v4' is possibly undefined
// 8048452: variable 'v6' is possibly undefined
// 80484F8: using guessed type int dword_80484F8;

//----- (0804846A) --------------------------------------------------------
void __usercall sub_804846A(int *a1@<edi>)
{
  unsigned int v1; // edx
  char v2; // bl
  char v3; // cl
  int v4; // edx
  int v5; // ecx
  int v6; // eax
  int v7; // [esp-28h] [ebp-28h]

  v7 = dword_80484F8;
  v1 = dword_80484F8;
  qmemcpy(dword_8048500, (char *)dword_8048B80 + (dword_80484F8 & 0x1FC0), dword_80484F8 & 0x3F);
  v2 = v1;
  v3 = v1;
  v4 = (v1 >> 2) & 0xF;
  v5 = 8 * (v3 & 3) + 7;
  dword_8048500[v4] ^= 1 << v5;
  if ( (v2 & 0x3Fu) > 0x37 )
  {
    sub_80482F3(v5, (int)dword_8048500, 1 << v5, v4);
    memset(dword_8048500, 0, 0x40u);
    v5 = 0;
  }
  dword_8048500[14] = 8 * v7;
  v6 = (unsigned int)dword_80484FC >> 29;
  dword_8048500[15] = (unsigned int)dword_80484FC >> 29;
  sub_80482F3(v5, (int)dword_8048500, v6, v4);
  qmemcpy(a1, dword_80484E4, 0x14u);
}
// 804846A: could not find valid save-restore pair for edi
// 80484D2: variable 'v4' is possibly undefined
// 80484E4: using guessed type int dword_80484E4[5];
// 80484F8: using guessed type int dword_80484F8;
// 80484FC: using guessed type int dword_80484FC;
// 8048500: using guessed type int dword_8048500[416];
// 8048B80: using guessed type int dword_8048B80[8192];

// nfuncs=5 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
