/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(char@<ah>, mode_t@<edx>);
// char __usercall sub_80481E2@<al>(int@<ebp>, int@<esi>);
// char __usercall sub_8048202@<al>(__int16@<ax>);

//-------------------------------------------------------------------------
// Data declarations

int dword_80482AC[2048]; // weak
int dword_804A2AC[2048]; // weak
int dword_804C2AC; // weak
int dword_804C2B0; // weak
int dword_804C2B4; // weak
char byte_804C2B8; // weak
char byte_804C2B9; // weak
char byte_804C2BA; // weak
char byte_804C2BB; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(char a1@<ah>, mode_t a2@<edx>)
{
  int v2; // edi
  int v3; // ebp
  char *v4; // esi
  char v5; // al
  signed int v6; // eax
  const void *v7; // ecx
  int v8; // eax
  int v9; // eax
  int v10; // eax
  char *v11; // eax
  char v12; // sf
  __int16 v13; // ax
  char v14; // bl
  int v15; // [esp-10h] [ebp-10h]
  _BYTE *v16; // [esp-8h] [ebp-8h]
  char *v17; // [esp-4h] [ebp-4h]

  v2 = 0;
  v3 = 0;
  if ( v15 == 1 )
    goto LABEL_32;
LABEL_2:
  if ( !v16 )
  {
    byte_804C2B8 = a1;
    goto LABEL_32;
  }
  v4 = v16 + 1;
  if ( *v16 == 45 && *v4 )
  {
    do
    {
      v5 = *v4++;
      if ( !v5 )
        goto LABEL_2;
      if ( v5 == 65 )
        a1 |= 7u;
      if ( v5 == 98 )
        a1 |= 0x30u;
      if ( v5 == 101 )
        a1 |= 6u;
      if ( v5 == 69 )
        a1 |= 2u;
      if ( v5 == 110 )
        a1 |= 0x10u;
      if ( v5 == 115 )
        a1 |= 8u;
      if ( v5 == 116 )
        a1 |= 5u;
      if ( v5 == 84 )
        a1 |= 1u;
      if ( v5 == 118 )
        a1 |= 4u;
    }
    while ( v5 != 45 );
    byte_804C2B8 = a1;
  }
  else
  {
    byte_804C2B8 = a1;
  }
  while ( 1 )
  {
LABEL_28:
    if ( !v17 )
    {
      if ( dword_804C2B0 )
        v9 = sys_write(1, dword_804A2AC, dword_804C2B0);
      v10 = sys_exit(v2);
    }
    v3 = 0;
    if ( *(_WORD *)v17 == 45 )
      break;
    v3 = sys_open(v17, 0, a2);
    if ( v3 >= 0 )
      break;
LABEL_31:
    ++v2;
  }
LABEL_32:
  while ( !byte_804C2B8 )
  {
    v6 = sys_read(v3, dword_80482AC, 0x2000u);
    if ( v6 < 0 )
      goto LABEL_31;
    if ( !v6 )
      goto LABEL_28;
    v8 = sys_write(1, v7, v6);
  }
  while ( 1 )
  {
    while ( 1 )
    {
      LOBYTE(v11) = sub_80481E2(v3, (int)dword_80482AC);
      if ( v12 )
        goto LABEL_28;
      BYTE1(v11) = byte_804C2B8;
      if ( (_BYTE)v11 != 10 )
        break;
      if ( (byte_804C2B8 & 8) == 0 || byte_804C2BA != 10 || byte_804C2BB != 10 )
      {
        if ( (byte_804C2B8 & 2) != 0 )
        {
          v14 = byte_804C2BA;
          LOBYTE(v11) = 36;
          sub_8048202((__int16)v11);
          byte_804C2BA = v14;
          LOBYTE(v11) = 10;
        }
        if ( (BYTE1(v11) & 0x20) != 0 && byte_804C2BA == 10 )
          ++byte_804C2B9;
        sub_8048202((__int16)v11);
        --byte_804C2B9;
      }
    }
    if ( (_BYTE)v11 == 9 )
      break;
    if ( (byte_804C2B8 & 4) != 0 )
    {
      if ( (unsigned __int8)v11 >= 0x80u )
      {
        v17 = v11;
        LOBYTE(v11) = 77;
        sub_8048202((__int16)v11);
        LOBYTE(v13) = 45;
        sub_8048202(v13);
        v11 = v17;
        LOBYTE(v11) = (unsigned __int8)v17 & 0x7F;
      }
      if ( (unsigned __int8)v11 < 0x20u )
        goto LABEL_48;
    }
LABEL_46:
    sub_8048202((__int16)v11);
  }
  if ( (byte_804C2B8 & 1) == 0 )
    goto LABEL_46;
LABEL_48:
  v17 = v11;
  LOBYTE(v11) = 94;
  sub_8048202((__int16)v11);
  BYTE1(v11) = BYTE1(v17);
  LOBYTE(v11) = (_BYTE)v17 + 64;
  goto LABEL_46;
}
// 80480CB: positive sp value 10 has been found
// 8048053: variable 'v15' is possibly undefined
// 804805C: variable 'v16' is possibly undefined
// 80480CD: variable 'v17' is possibly undefined
// 80480DC: variable 'a2' is possibly undefined
// 804810D: variable 'v7' is possibly undefined
// 8048139: variable 'v12' is possibly undefined
// 8048156: variable 'v11' is possibly undefined
// 8048160: variable 'v13' is possibly undefined
// 80482AC: using guessed type int dword_80482AC[2048];
// 804A2AC: using guessed type int dword_804A2AC[2048];
// 804C2B0: using guessed type int dword_804C2B0;
// 804C2B8: using guessed type char byte_804C2B8;
// 804C2B9: using guessed type char byte_804C2B9;
// 804C2BA: using guessed type char byte_804C2BA;
// 804C2BB: using guessed type char byte_804C2BB;

//----- (080481E2) --------------------------------------------------------
char __usercall sub_80481E2@<al>(int a1@<ebp>, int a2@<esi>)
{
  int v3; // eax
  int v4; // ecx

  while ( 1 )
  {
    if ( --dword_804C2AC >= 0 )
      return *(_BYTE *)a2;
    v3 = sys_read(a1, dword_80482AC, 0x2000u);
    if ( !v3 )
      break;
    a2 = v4;
    dword_804C2AC = v3;
  }
  return -1;
}
// 80481DB: variable 'v4' is possibly undefined
// 80482AC: using guessed type int dword_80482AC[2048];
// 804C2AC: using guessed type int dword_804C2AC;

//----- (08048202) --------------------------------------------------------
char __usercall sub_8048202@<al>(__int16 a1@<ax>)
{
  unsigned int v1; // eax
  unsigned int v2; // edi
  __int16 v3; // dx
  unsigned int v4; // et2
  unsigned int v5; // ebx
  __int16 v6; // ax
  __int16 v7; // ax
  int v8; // edi
  char result; // al
  char v10; // t0
  int v11; // eax
  unsigned int v12; // [esp-Ch] [ebp-10h]
  __int16 v13; // [esp-8h] [ebp-Ch]
  __int16 v14; // [esp-4h] [ebp-8h]

  if ( (a1 & 0x1000) != 0 && !byte_804C2B9 )
  {
    HIBYTE(a1) = byte_804C2BA;
    v14 = a1;
    ++byte_804C2B9;
    v1 = ++dword_804C2B4;
    v2 = 0;
    do
    {
      v4 = v1 % 0xA;
      v1 /= 0xAu;
      HIBYTE(v3) = BYTE1(v4);
      LOBYTE(v3) = v4 + 48;
      v13 = v3;
      ++v2;
    }
    while ( v1 );
    v5 = 6 - v2;
    if ( v2 < 6 )
    {
      do
      {
        LOBYTE(v1) = 32;
        v12 = v5;
        sub_8048202(v1);
        --v5;
      }
      while ( v12 != 1 );
    }
    do
    {
      sub_8048202(v13);
      --v2;
    }
    while ( v2 );
    LOBYTE(v6) = 32;
    sub_8048202(v6);
    LOBYTE(v7) = 32;
    sub_8048202(v7);
    byte_804C2BA = HIBYTE(v14);
    LOBYTE(a1) = v14;
  }
  v8 = dword_804C2B0 + 134521516;
  *(_BYTE *)(dword_804C2B0 + 134521516) = a1;
  ++dword_804C2B0;
  v10 = a1;
  result = byte_804C2BA;
  byte_804C2BA = v10;
  byte_804C2BB = result;
  if ( v8 + 1 >= (unsigned int)&dword_804C2AC )
  {
    v11 = sys_write(1, dword_804A2AC, 0x2000u);
    result = 0;
    dword_804C2B0 = 0;
  }
  return result;
}
// 8048245: variable 'v1' is possibly undefined
// 8048259: variable 'v6' is possibly undefined
// 8048260: variable 'v7' is possibly undefined
// 804A2AC: using guessed type int dword_804A2AC[2048];
// 804C2AC: using guessed type int dword_804C2AC;
// 804C2B0: using guessed type int dword_804C2B0;
// 804C2B4: using guessed type int dword_804C2B4;
// 804C2B9: using guessed type char byte_804C2B9;
// 804C2BA: using guessed type char byte_804C2BA;
// 804C2BB: using guessed type char byte_804C2BB;

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
