// subject_seg08048000.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0804804C: Register word32 fn0804804C(Register word32 eax, Register uint16 bx, Register out ptr32 ebxOut)
// Called from:
//      fn0804816C
word32 fn0804804C(word32 eax, uint16 bx, ptr32 & ebxOut)
{
	word32 ebx;
	uint16 bx = (word16) ebx;
	uint16 ax_11 = (word16) eax;
	word16 eax_16_16_44 = SLICE(eax, word16, 16);
	if (eax != 0x00)
	{
		if (bx != 0x00)
		{
			uint32 dx_ax_31 = bx *32 ax_11;
			Eq_22 edx_34 = (uint32) SLICE(dx_ax_31, word16, 16);
			ebxOut = <invalid>;
			uint64 edx_eax_49 = SEQ(eax_16_16_44, edx_34 << 0x10, edx_34, (word16) dx_ax_31);
			return SEQ(SLICE((uint32) (edx_eax_49 /u 0x00010001), word16, 16), (word16) (edx_eax_49 % 0x00010001));
		}
	}
	else
		ax_11 = bx;
	ebxOut = <invalid>;
	return SEQ(eax_16_16_44, -ax_11 + 0x01);
}

// 08048077: Register uint32 fn08048077(Register uint32 eax)
// Called from:
//      fn080480E3
uint32 fn08048077(uint32 eax)
{
	uint32 eax_50 = eax & 0xFFFF;
	if ((eax & 0xFFFF) != 0x00)
	{
		uint32 ecx_26 = 0xFFFF;
		while ((uint32) (ecx_26 *64 (eax & 0xFFFF) % 0x00010001) != 0x01)
		{
			--ecx_26;
			if (ecx_26 == 0x00)
				break;
		}
		eax_50 = ecx_26;
	}
	return eax_50;
}

// 0804809C: void fn0804809C(Register (ptr32 Eq_58) esi, Register (arr cu16) edi)
// Called from:
//      fn0804824E
void fn0804809C(<unknown>* esi, cu16 edi[])
{
	memcpy(edi, esi, 0x10);
	word16 * edi_36 = edi + 8;
	int32 ecx_39 = 0x01;
	word32 ebx_40 = 0x00;
	do
	{
		ui32 ecx_48 = ecx_117 & 0x07;
		*edi_36 = edi[ebx_40 + ecx_48] << 0x09 | edi[ebx_40 + (ecx_48 + 0x01 & 0x07)] >> 0x07;
		++edi_36;
		ebx_40 += (uint32) (int8) (((byte) ecx_117 & 0x07) < 0x01) << 0x03;
		ecx_39 = ecx_117 + 0x01;
		ecx_117 = ecx_39;
	} while (ecx_117 <= 0x2B);
}

// 080480E3: void fn080480E3(Register (ptr32 Eq_114) esi, Register (ptr32 Eq_115) edi)
// Called from:
//      fn0804824E
void fn080480E3(struct Eq_114 * esi, struct Eq_115 * edi)
{
	word32 eax_35 = fn08048077((uint32) esi->w0060);
	edi->w0000 = (word16) eax_35;
	edi->w0002 = -esi->w0062;
	edi->w0004 = -esi->w0064;
	edi->w0006 = (word16) fn08048077(SEQ(SLICE(eax_35, word16, 16), esi->w0066));
	struct Eq_153 * edi_106 = &edi->w0006 + 1;
	ui32 ecx_107;
	for (ecx_107 = 0x2A; ecx_107 != 0x00; ecx_107 -= 0x06)
	{
		word32 eax_71 = esi->a0008[ecx_107].dw0000;
		edi_106->dw0000 = eax_71;
		word32 eax_78 = fn08048077(SEQ(SLICE(eax_71, word16, 16), esi[ecx_107 * 0x02 / 0x0068]));
		struct Eq_175 * edi_74 = &edi_106->dw0000 + 1;
		edi_74->w0000 = (word16) eax_78;
		edi_74->w0002 = -esi->a0004[ecx_107];
		edi_74->w0004 = -esi->a0002[ecx_107];
		edi_74->w0006 = (word16) fn08048077(SEQ(SLICE(eax_78, word16, 16), esi->a0006[ecx_107]));
		edi_106 = (struct Eq_153 *) &edi_74->t0008.u0;
	}
	Eq_219 eax_110 = esi->a0008[0].dw0000;
	edi_74->t0008.u0 = (word32) eax_110;
	word32 eax_117 = fn08048077(SEQ(SLICE(eax_110, word16, 16), esi->a0000[0]));
	edi_74->w000C = (word16) eax_117;
	edi_74->t000E.u0 = (word16) -esi->a0002[0];
	edi_74->t0010.u0 = (word16) -esi->a0004[0];
	edi_74->w0012 = (word16) fn08048077(SEQ(SLICE(eax_117, word16, 16), esi->a0006[0]));
}

// 0804816C: void fn0804816C(Register (ptr32 char) ebx, Register (ptr32 word16) esi, Register (ptr32 Eq_264) edi)
// Called from:
//      fn0804820A
void fn0804816C(char * ebx, word16 * esi, struct Eq_264 * edi)
{
	word16 ebx_16_16_198 = SLICE(ebx, word16, 16);
	ui16 dx_133 = edi->w0002;
	ui16 bp_134 = edi->w0004;
	uint16 di_130 = edi->w0006;
	word32 eax_137 = 0x08;
	word32 ebx_16_16_cx_220 = SEQ(ebx_16_16_198, edi->w0000);
	do
	{
		word32 ebx_52;
		word32 eax_51 = fn0804804C(SEQ(SLICE(eax_225, word16, 16), *esi), (word16) ebx_16_16_cx_220, out ebx_52);
		struct Eq_299 * esi_44 = esi + 1;
		word16 dx_63 = dx_133 + esi_44->w0000;
		word16 bp_67 = bp_134 + esi_44->w0002;
		word32 ebx_78;
		word32 eax_77 = fn0804804C(SEQ(SLICE(eax_51, word16, 16), esi_44->w0004), di_130, out ebx_78);
		word16 ax_58 = (word16) eax_51;
		word32 ebx_98;
		word32 eax_97 = fn0804804C(SEQ(SLICE(eax_77, word16, 16), esi_44->w0006), bp_67 ^ ax_58, out ebx_98);
		word16 ax_84 = (word16) eax_77;
		word32 ebx_223;
		word16 ax_125 = (word16) fn0804804C(SEQ(SLICE(eax_97, word16, 16), esi_44->w0008), (ax_84 ^ dx_63) + (word16) eax_97, out ebx_223);
		word16 bx_126 = (word16) eax_97 + ax_125;
		ui16 bp_128 = bp_67 ^ ax_125;
		ui16 dx_129 = dx_63 ^ bx_126;
		word16 ebx_16_16_143 = SLICE(eax_97, word16, 16);
		uint16 cx_127 = ax_58 ^ ax_125;
		esi = &esi_44->w000A;
		di_130 = ax_84 ^ bx_126;
		dx_133 = bp_128;
		bp_134 = dx_129;
		eax_137 = eax_225 - 0x01;
		word16 eax_16_16_145 = SLICE(eax_225 - 0x01, word16, 16);
		ebx_16_16_cx_220 = SEQ(ebx_16_16_143, cx_127);
		eax_225 = eax_137;
	} while (eax_225 != 0x01);
	word32 ebx_148;
	word32 eax_147 = fn0804804C(SEQ(eax_16_16_145, esi_44->w000A), cx_127, out ebx_148);
	ui16 bp_158 = dx_129 + esi_44->w000C;
	ui16 dx_161 = bp_128 + esi_44->w000E;
	word32 ebx_224;
	uint16 ax_181 = (word16) fn0804804C(SEQ(SLICE(eax_147, word16, 16), esi_44->w0010), di_130, out ebx_224);
	edi->w0000 = (word16) eax_147;
	edi->w0002 = bp_158;
	edi->w0004 = dx_161;
	edi->w0006 = ax_181;
}

// 0804820A: Register Eq_414 fn0804820A(Register (ptr32 char) eax, Register (ptr32 word16) esi, Register (ptr32 char) edi)
// Called from:
//      fn0804824E
Eq_414 fn0804820A(char * eax, word16 * esi, char * edi)
{
	Eq_418 tLoc08;
	tLoc08.ptr0004 = eax;
	tLoc08.ptr0000 = eax;
	while (true)
	{
		int32 eax_12;
		for (eax_12 = 0x07; eax_12 >= 0x00; --eax_12)
			(&tLoc08)[eax_12 / 8] = (struct Eq_428) 0x2A;
		Eq_414 edx_22 = 0x08;
		struct Eq_438 * ecx_24 = &tLoc08;
		do
		{
			Eq_440 eax_34 = sys_read(edi, ecx_24, edx_22);
			ecx_24 += eax_34;
			edx_22 -= eax_34;
			if (eax_34 < 0x00)
				return edx_22;
		} while (eax_34 != 0x00);
		if (edx_22 == 0x08)
			break;
		fn0804816C(edi, esi, &tLoc08);
		sys_write(0x01, &tLoc08, 0x08);
	}
	return edx_22;
}

// 0804824E: void fn0804824E(Register Eq_469 edx, Stack (ptr32 byte) dwArg08, Stack (ptr32 byte) dwArg0C, Stack word32 dwArg10)
void fn0804824E(Eq_469 edx, byte * dwArg08, byte * dwArg0C, word32 dwArg10)
{
	ptr32 fp;
	struct Eq_474 * esp_102;
	char * eax_103;
	ptr32 esp_10 = fp + 0x0C;
	if (dwArg08 != null)
	{
		byte al_16 = *dwArg08;
		if (al_16 != 101 && al_16 != 100)
			goto l080482BF;
		g_b80483CF = al_16;
		esp_10 = fp + 16;
		byte * esi_27 = dwArg0C;
		if (dwArg0C != null)
		{
			byte * edi_47 = g_a80482EF;
			word32 ecx_50;
			for (ecx_50 = 0x10; ecx_50 != 0x00; --ecx_50)
			{
				byte al_56 = *esi_27;
				++esi_27;
				if (al_56 == 0x00)
					break;
				*edi_47 = al_56;
				++edi_47;
			}
			fn0804809C(g_a80482EF, g_a80482FF);
			char * edi_121 = g_a80482FF;
			word16 * ebp_129 = g_a80482FF;
			if (g_b80483CF != 101)
			{
				fn080480E3(g_a80482FF, &g_t8048367);
				edi_121 = (char *) &g_t8048367;
				ebp_129 = (word16 *) &g_t8048367;
			}
			esp_102 = fp + 16;
			eax_103 = null;
			if (dwArg10 == 0x00)
			{
l080482B1:
				edi_121 = eax_103;
				edx = fn0804820A(edi_121, ebp_129, eax_103);
				eax_103 = edi_121;
				if (edi_121 < null)
					goto l080482CF;
				goto l0804829F;
			}
			else
			{
l0804829F:
				char * eax_101 = esp_102->dw0000;
				++esp_102;
				eax_103 = eax_101;
				if (eax_101 != null)
				{
					esp_102->dwFFFFFFFC = 0x05;
					char * eax_115 = sys_open(eax_101, 0x00, edx);
					eax_103 = eax_115;
					if (eax_115 >= null)
						goto l080482B1;
				}
l080482CF:
				esp_102->dwFFFFFFFC = 0x01;
				sys_exit(eax_103);
			}
		}
	}
l080482BF:
	size_t * esp_33 = esp_10 - 4;
	*esp_33 = (uint32) 0x19;
	Eq_414 edx_35 = *esp_33;
	*esp_33 = (uint32) 0x02;
	Eq_414 ebx_40 = *esp_33;
	*esp_33 = (uint32) 0x04;
	esp_102 = (struct Eq_474 *) (esp_33 + 1);
	eax_103 = sys_write(ebx_40, &g_b80482D6, edx_35);
	goto l080482CF;
}

char g_b80482D6 = '$'; // 080482D6
byte g_a80482EF[] = // 080482EF
	{
	};
cu16 g_a80482FF[] = // 080482FF
	{
	};
Eq_115 g_t8048367 = // 08048367
	{
		0x00,
		0x00,
		0x00,
		0x00,
	};
byte g_b80483CF = 0x00; // 080483CF
