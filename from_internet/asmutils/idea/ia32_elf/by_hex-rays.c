/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// __int16 __usercall __spoils<> sub_804804C@<ax>(unsigned int@<eax>, unsigned __int16@<bx>);
// int __usercall __spoils<ecx> sub_8048077@<eax>(int result@<eax>);
// void __usercall sub_804809C(_WORD *@<edi>, _WORD *@<esi>);
// void __usercall sub_80480E3(_WORD *a1@<edi>, int a2@<esi>);
// void __usercall sub_804816C(unsigned __int16 *a1@<edi>, _WORD *a2@<esi>);
// int __usercall sub_804820A@<eax>(int@<eax>, int@<edi>, _WORD *@<esi>);
void __noreturn start(); // weak

//-------------------------------------------------------------------------
// Data declarations

__int16 word_80482D6 = 8228; // weak
char byte_80482EF; // weak
char byte_80483CF; // weak


//----- (0804804C) --------------------------------------------------------
__int16 __usercall __spoils<> sub_804804C@<ax>(unsigned int a1@<eax>, unsigned __int16 a2@<bx>)
{
  unsigned int v2; // edx
  __int16 v3; // t0

  if ( a1 )
  {
    if ( a2 )
    {
      v2 = (a2 * (unsigned int)(unsigned __int16)a1) >> 16 << 16;
      v3 = a2 * a1;
      LOWORD(a1) = 0;
      LOWORD(v2) = v3;
      return __PAIR64__(a1, v2) % 0x10001;
    }
  }
  else
  {
    LOWORD(a1) = a2;
  }
  return 1 - a1;
}

//----- (08048077) --------------------------------------------------------
int __usercall __spoils<ecx> sub_8048077@<eax>(int result@<eax>)
{
  int v1; // ecx

  result = (unsigned __int16)result;
  if ( (_WORD)result )
  {
    v1 = 0xFFFF;
    do
    {
      if ( (unsigned int)v1 * (unsigned __int64)(unsigned __int16)result % 0x10001 == 1 )
        break;
      --v1;
    }
    while ( v1 );
    return v1;
  }
  return result;
}

//----- (0804809C) --------------------------------------------------------
void __usercall sub_804809C(_WORD *a1@<edi>, _WORD *a2@<esi>)
{
  int i; // ecx
  _WORD *v3; // esi
  int v4; // ecx
  int v5; // ebx
  _WORD *v6; // [esp-24h] [ebp-24h]
  int v7; // [esp-24h] [ebp-24h]

  v6 = a1;
  for ( i = 8; i; --i )
    *a1++ = *a2++;
  v3 = v6;
  v4 = 1;
  v5 = 0;
  do
  {
    v7 = v4;
    *a1++ = (v3[v5 + (((v4 & 7) + 1) & 7)] >> 7) | (v3[v5 + (v4 & 7)] << 9);
    v5 += 8 * ((v4++ & 7) == 0);
  }
  while ( v7 + 1 <= 44 );
}
// 804809C: could not find valid save-restore pair for edi

//----- (080480E3) --------------------------------------------------------
void __usercall sub_80480E3(_WORD *a1@<edi>, int a2@<esi>)
{
  int v2; // eax
  _WORD *v3; // edi
  int *v4; // edi
  int v5; // ecx
  int v6; // eax
  _WORD *v7; // edi
  int v8; // eax
  int v9; // ecx
  int v10; // ecx
  int v11; // eax
  _WORD *v12; // edi
  _WORD *v13; // esi
  int v14; // eax

  v2 = sub_8048077(*(unsigned __int16 *)(a2 + 96));
  *a1 = v2;
  v3 = a1 + 1;
  *v3++ = -*(_WORD *)(a2 + 98);
  *v3++ = -*(_WORD *)(a2 + 100);
  LOWORD(v2) = *(_WORD *)(a2 + 102);
  *v3 = sub_8048077(v2);
  v4 = (int *)(v3 + 1);
  v5 = 42;
  do
  {
    v6 = *(_DWORD *)(a2 + 2 * v5 + 8);
    *v4 = v6;
    v7 = v4 + 1;
    LOWORD(v6) = *(_WORD *)(a2 + 2 * v5);
    v8 = sub_8048077(v6);
    *v7++ = v8;
    *v7++ = -*(_WORD *)(a2 + 2 * v9 + 4);
    *v7++ = -*(_WORD *)(a2 + 2 * v9 + 2);
    LOWORD(v8) = *(_WORD *)(a2 + 2 * v9 + 6);
    *v7 = sub_8048077(v8);
    v4 = (int *)(v7 + 1);
    v5 = v10 - 6;
  }
  while ( v5 );
  v11 = *(_DWORD *)(a2 + 8);
  *v4 = v11;
  v12 = v4 + 1;
  LOWORD(v11) = *(_WORD *)a2;
  v13 = (_WORD *)(a2 + 2);
  v14 = sub_8048077(v11);
  *v12++ = v14;
  LOWORD(v14) = *v13++;
  *v12++ = -(__int16)v14;
  *v12 = -*v13;
  LOWORD(v14) = v13[1];
  v12[1] = sub_8048077(v14);
}
// 80480E3: could not find valid save-restore pair for esi
// 8048121: variable 'v9' is possibly undefined
// 8048141: variable 'v10' is possibly undefined

//----- (0804816C) --------------------------------------------------------
void __usercall sub_804816C(unsigned __int16 *a1@<edi>, _WORD *a2@<esi>)
{
  unsigned __int16 v2; // cx
  unsigned __int16 v3; // dx
  unsigned __int16 v4; // bp
  unsigned __int16 v5; // di
  unsigned int v6; // eax
  _WORD *v7; // esi
  __int16 v8; // cx
  __int16 v9; // dx
  __int16 v10; // bp
  __int16 v11; // di
  __int16 v12; // ax
  unsigned __int16 v13; // t2
  _WORD *v14; // esi
  __int16 v15; // cx
  unsigned __int16 v16; // bp
  unsigned __int16 v17; // dx
  __int16 v18; // ax
  __int16 v19; // [esp-2Ch] [ebp-2Ch]
  unsigned int v20; // [esp-28h] [ebp-28h]

  v2 = *a1;
  v3 = a1[1];
  v4 = a1[2];
  v5 = a1[3];
  v6 = 8;
  do
  {
    v20 = v6;
    LOWORD(v6) = *a2;
    v7 = a2 + 1;
    v8 = sub_804804C(v6, v2);
    LOWORD(v6) = *v7++;
    v9 = v6 + v3;
    LOWORD(v6) = *v7++;
    v10 = v6 + v4;
    LOWORD(v6) = *v7++;
    v11 = sub_804804C(v6, v5);
    LOWORD(v6) = *v7++;
    v19 = sub_804804C(v6, v8 ^ v10);
    LOWORD(v6) = *v7;
    a2 = v7 + 1;
    v12 = sub_804804C(v6, v19 + (v9 ^ v11));
    v2 = v12 ^ v8;
    v5 = (v12 + v19) ^ v11;
    v13 = v12 ^ v10;
    v4 = (v12 + v19) ^ v9;
    v3 = v13;
    v6 = v20 - 1;
  }
  while ( v20 != 1 );
  LOWORD(v6) = *a2;
  v14 = a2 + 1;
  v15 = sub_804804C(v6, v2);
  LOWORD(v6) = *v14++;
  v16 = v6 + v4;
  v17 = *v14 + v3;
  LOWORD(v6) = v14[1];
  v18 = sub_804804C(v6, v5);
  *a1 = v15;
  a1[1] = v16;
  a1[2] = v17;
  a1[3] = v18;
}
// 804816C: could not find valid save-restore pair for edi

//----- (0804820A) --------------------------------------------------------
int __usercall sub_804820A@<eax>(int a1@<eax>, int a2@<edi>, _WORD *a3@<esi>)
{
  int i; // eax
  size_t v4; // edx
  _DWORD *v5; // ecx
  int result; // eax
  int v7; // ecx
  int v8; // edx
  int v9; // eax
  _DWORD addr[2]; // [esp+0h] [ebp-8h] BYREF

  addr[1] = a1;
  addr[0] = a1;
LABEL_2:
  for ( i = 7; i >= 0; --i )
    *((_BYTE *)addr + i) = 42;
  v4 = 8;
  v5 = addr;
  while ( 1 )
  {
    result = sys_read(a2, v5, v4);
    v5 = (_DWORD *)(result + v7);
    v4 = v8 - result;
    if ( result < 0 )
      return result;
    if ( !result )
    {
      if ( v4 == 8 )
        return result;
      sub_804816C((unsigned __int16 *)addr, a3);
      v9 = sys_write(1, addr, 8u);
      goto LABEL_2;
    }
  }
}
// 8048222: variable 'v7' is possibly undefined
// 8048224: variable 'v8' is possibly undefined

//----- (0804824E) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __noreturn start()
{
  char *v0; // esi
  char *v1; // edi
  int v2; // ecx
  char v3; // al
  char *v4; // edi
  mode_t v5; // edx
  char *v6; // ebp
  int v7; // eax
  int v8; // eax
  int v9; // et0
  int v10; // eax
  char *v11; // [esp-Ch] [ebp-Ch]
  char *v12; // [esp-8h] [ebp-8h]
  char *v13; // [esp-4h] [ebp-4h]

  if ( v11 && (*v11 == 101 || *v11 == 100) && (byte_80483CF = *v11, (v0 = v12) != 0) )
  {
    v1 = &byte_80482EF;
    v2 = 16;
    do
    {
      v3 = *v0++;
      if ( !v3 )
        break;
      *v1++ = v3;
      --v2;
    }
    while ( v2 );
    v4 = &byte_80482EF + 16;
    sub_804809C((_WORD *)&byte_80482EF + 8, &byte_80482EF);
    v6 = &byte_80482EF + 16;
    if ( byte_80483CF != 101 )
    {
      v4 = &byte_80482EF + 120;
      sub_80480E3((_WORD *)&byte_80482EF + 60, (int)(&byte_80482EF + 16));
      v6 = &byte_80482EF + 120;
    }
    v7 = 0;
    if ( !v13 )
      goto LABEL_13;
    do
    {
      v7 = (int)v13;
      if ( !v13 )
        break;
      v7 = sys_open(v13, 0, v5);
      if ( v7 < 0 )
        break;
LABEL_13:
      v9 = v7;
      v8 = (int)v4;
      v4 = (char *)v9;
      v7 = sub_804820A(v8, v9, v6);
    }
    while ( v7 >= 0 );
  }
  else
  {
    v7 = sys_write(2, &word_80482D6, 0x19u);
  }
  v10 = sys_exit(v7);
}
// 804829A: positive sp value 14 has been found
// 8048253: variable 'v11' is possibly undefined
// 8048263: variable 'v12' is possibly undefined
// 804829D: variable 'v13' is possibly undefined
// 80482AB: variable 'v5' is possibly undefined
// 804824E: using guessed type void __noreturn start();
// 80482D6: using guessed type __int16 word_80482D6;
// 80482EF: using guessed type char byte_80482EF;
// 80483CF: using guessed type char byte_80483CF;

// nfuncs=7 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
