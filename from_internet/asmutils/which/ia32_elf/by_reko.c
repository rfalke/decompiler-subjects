// subject_seg08048000.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0804804C: void fn0804804C(Stack ui32 dwArg00)
void fn0804804C(ui32 dwArg00)
{
	struct Eq_3 * fp;
	g_dw80487F5 = 0x01;
	ui32 ebp_122 = dwArg00;
	do
	{
		++ebp_122;
		struct Eq_30 * esi_17 = fp->a0004[ebp_122];
		if (esi_17 == null)
			goto l0804809E;
	} while (esi_17->dw0000 != 0x48544150 || esi_17->b0004 != 0x3D);
	ebp_122 = dwArg00;
	byte * esi_124 = &esi_17->b0004 + 1;
	word32 * ebx_31 = &g_dw80482ED;
	byte cl_32 = 0x40;
	while (true)
	{
		byte al_35 = *esi_124;
		if (al_35 == 0x00)
			break;
		if (al_35 != 0x3A)
		{
			*ebx_31 = esi_124;
			++ebx_31;
			do
			{
				++esi_124;
				byte al_50 = *esi_124;
				if (al_50 == 0x00)
					goto l0804809E;
			} while (al_50 != 0x3A);
			*esi_124 = 0x00;
			++esi_124;
			--cl_32;
			if (cl_32 == 0x00)
				break;
			continue;
		}
		++esi_124;
	}
l0804809E:
	g_dw80481E1 = sys_getuid();
	g_dw80481E5 = sys_getgid();
	g_dw80481E9 = sys_getgroups(0x40, &g_t80481ED);
	struct Eq_27 * esp_100 = fp->a0004 + 1;
	while (true)
	{
		ui32 ebp_95 = ebp_122 - 0x01;
		if (ebp_95 == 0x00)
			break;
		g_ptr80487F9 = esp_100->dw0000;
		struct Eq_27 * esp_107 = esp_100 + 1;
		esp_107->dwFFFFFFFC = ebp_95;
		fn080480E3();
		ebp_122 = esp_107->dwFFFFFFFC;
		esp_100 = esp_107;
	}
	int32 ebx_99 = g_dw80487F5;
	esp_100->dwFFFFFFFC = 0x01;
	sys_exit(ebx_99);
}

// 080480E3: void fn080480E3()
// Called from:
//      fn0804804C
void fn080480E3()
{
	word32 * ebp_101 = &g_dw80482ED;
	byte * esi_10 = g_ptr80487F9;
	do
	{
		struct Eq_137 * edi_127;
		byte al_9 = *esi_10;
		++esi_10;
		if (al_9 == 0x00)
			goto l08048103;
	} while (al_9 != 0x2F);
	ebp_101 = &g_dw80483ED;
	edi_127 = &g_t80483F5;
	while (true)
	{
		struct Eq_137 * edi_23 = fn080481DA(g_ptr80487F9, edi_127);
		if (Test(UGE,sys_stat(&g_t80483F5, &g_t80487FD) != 0x00))
		{
			ui32 ecx_42 = g_dw8048803 >> 0x1C & ~0x04;
			word16 ecx_16_16_63 = SLICE(ecx_42, word16, 16);
			if (ecx_42 != 0x00)
			{
				ui32 eax_47 = g_dw8048805;
				if ((eax_47 & 0x49) != 0x00)
				{
					int32 ebx_53 = g_dw80481E1;
					word16 bx_59 = (word16) ebx_53;
					if (ebx_53 == 0x00)
					{
l08048172:
						g_dw80487F5 = 0x00;
						edi_23->b0000 = 0x0A;
						sys_write(0x01, &g_t80483F5, edi_23 - 0x080483F4);
						return;
					}
					if (bx_59 == g_w8048809)
					{
						if ((eax_47 & 0x49 & 0x40) != 0x00)
							goto l08048172;
					}
					else
					{
						word16 cx_62 = g_w804880B;
						if (SEQ(ecx_16_16_63, cx_62) != g_dw80481E5)
						{
							int32 edx_67 = g_dw80481E9;
							word16 * ebx_68 = &g_t80481ED;
							do
							{
								if (cx_62 == *ebx_68)
									goto l080481CD;
								++ebx_68;
								--edx_67;
							} while (edx_67 != 0x00);
							if ((eax_47 & 0x49 & 0x01) != 0x00)
								goto l08048172;
						}
						else
						{
l080481CD:
							if ((eax_47 & 0x49 & 0x0A) != 0x00)
								goto l08048172;
						}
					}
				}
			}
		}
		++ebp_101;
l08048103:
		byte * esi_108 = *ebp_101;
		if (esi_108 == null || *esi_108 == 0x00)
			return;
		struct Eq_137 * edi_121 = fn080481DA(esi_108, &g_t80483F5);
		edi_127 = edi_121 - 0x01;
		if (edi_121->bFFFFFFFF != 0x2F)
		{
			edi_121->bFFFFFFFF = 0x2F;
			edi_127 = edi_121;
		}
	}
}

// 080481DA: Register (ptr32 Eq_137) fn080481DA(Register (ptr32 byte) esi, Register (ptr32 Eq_137) edi)
// Called from:
//      fn080480E3
struct Eq_137 * fn080481DA(byte * esi, struct Eq_137 * edi)
{
	do
	{
		byte al_6 = *esi;
		edi->b0000 = al_6;
		++esi;
		++edi;
	} while (al_6 != 0x00);
	return edi;
}

int32 g_dw80481E1 = 0; // 080481E1
int32 g_dw80481E5 = 0; // 080481E5
int32 g_dw80481E9 = 0; // 080481E9
Eq_21 g_t80481ED = 0; // 080481ED
word16 g_a80481EF[] = // 080481EF
	{
	};
word32 g_dw80482ED = 0x00; // 080482ED
word32 g_dw80483ED = 0x00; // 080483ED
Eq_137 g_t80483F5 = // 080483F5
	{
		0x00,
		0x00,
	};
int32 g_dw80487F5 = 0; // 080487F5
byte * g_ptr80487F9 = null; // 080487F9
Eq_157 g_t80487FD = // 080487FD
	{
	};
uint32 g_dw8048803 = 0x00; // 08048803
ui32 g_dw8048805 = 0x00; // 08048805
word16 g_w8048809 = 0x00; // 08048809
word16 g_w804880B = 0x00; // 0804880B
