/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __cdecl __noreturn start(int);
char sub_80480E3();
// char __usercall sub_80481DA@<al>(_BYTE *@<edi>, char *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_80481E1; // weak
int dword_80481E5; // weak
int dword_80481E9; // weak
gid_t list; // idb
char byte_80482ED[3]; // weak
char byte_80483ED[3]; // weak
char addr[1024]; // idb
int status; // idb
int dword_80487F9; // weak
struct stat byte_80487FD; // idb
int dword_8048803; // weak
__int16 word_8048809; // weak
__int16 word_804880B; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start(int a1)
{
  int v1; // ebp
  int v2; // esi
  _BYTE *v3; // esi
  char *v4; // ebx
  char v5; // cl
  int v6; // ebp
  int v7; // eax
  int v8; // [esp-Ch] [ebp-Ch]
  int v9; // [esp-8h] [ebp-8h]
  int v10; // [esp-4h] [ebp-4h]

  v1 = v8;
  status = 1;
  do
  {
    ++v1;
    v2 = *(&v9 + v1);
    if ( !v2 )
      goto LABEL_13;
  }
  while ( *(_DWORD *)v2 != 1213481296 || *(_BYTE *)(v2 + 4) != 61 );
  v1 = v8;
  v3 = (_BYTE *)(v2 + 5);
  v4 = byte_80482ED;
  v5 = 64;
  while ( *v3 )
  {
    if ( *v3 == 58 )
    {
      ++v3;
    }
    else
    {
      *(_DWORD *)v4 = v3;
      v4 += 4;
      do
      {
        if ( !*++v3 )
          goto LABEL_13;
      }
      while ( *v3 != 58 );
      *v3++ = 0;
      if ( !--v5 )
        break;
    }
  }
LABEL_13:
  __asm { int     80h; LINUX - sys_getuid }
  dword_80481E1 = 24;
  __asm { int     80h; LINUX - sys_getgid }
  dword_80481E5 = 47;
  dword_80481E9 = sys_getgroups(64, &list);
  while ( 1 )
  {
    v6 = v1 - 1;
    if ( !v6 )
      break;
    dword_80487F9 = v10;
    v10 = v6;
    sub_80480E3();
    v1 = v10;
  }
  v7 = sys_exit(status);
}
// 80480C9: positive sp value C has been found
// 804804C: variable 'v8' is possibly undefined
// 80481E1: using guessed type int dword_80481E1;
// 80481E5: using guessed type int dword_80481E5;
// 80481E9: using guessed type int dword_80481E9;
// 80487F9: using guessed type int dword_80487F9;

//----- (080480E3) --------------------------------------------------------
char sub_80480E3()
{
  char *v0; // ebp
  _BYTE *v1; // esi
  int v2; // eax
  char *v3; // edi
  char *v4; // esi
  unsigned int v5; // ecx
  int v6; // edx
  gid_t *v7; // ebx

  v0 = byte_80482ED;
  v1 = (_BYTE *)dword_80487F9;
  do
  {
    LOBYTE(v2) = *v1++;
    if ( !(_BYTE)v2 )
      goto LABEL_5;
  }
  while ( (_BYTE)v2 != 47 );
  v0 = byte_80483ED;
  v3 = addr;
  while ( 1 )
  {
    sub_80481DA(v3, (char *)dword_80487F9);
    v2 = -sys_newstat(addr, &byte_80487FD);
    if ( v2 )
      goto LABEL_25;
    v5 = ((unsigned int)dword_8048803 >> 28) & 0xFFFFFFFB;
    if ( !v5 )
      goto LABEL_25;
    LOBYTE(v2) = BYTE2(dword_8048803) & 0x49;
    if ( (dword_8048803 & 0x490000) == 0 )
      goto LABEL_25;
    if ( !dword_80481E1 )
      goto LABEL_13;
    if ( (_WORD)dword_80481E1 != word_8048809 )
      break;
    LOBYTE(v2) = BYTE2(dword_8048803) & 0x40;
    if ( (dword_8048803 & 0x400000) != 0 )
      goto LABEL_13;
LABEL_25:
    v0 += 4;
LABEL_5:
    v4 = *(char **)v0;
    if ( !*(_DWORD *)v0 )
      return v2;
    LOBYTE(v2) = *v4;
    if ( !*v4 )
      return v2;
    sub_80481DA(addr, v4);
    v3 = &addr[-1];
    if ( addr[-1] != 47 )
    {
      *v3 = 47;
      v3 = addr;
    }
  }
  LOWORD(v5) = word_804880B;
  if ( v5 != dword_80481E5 )
  {
    v6 = dword_80481E9;
    v7 = &list;
    while ( word_804880B != *(_WORD *)v7 )
    {
      v7 = (gid_t *)((char *)v7 + 2);
      if ( !--v6 )
      {
        LOBYTE(v2) = BYTE2(dword_8048803) & 1;
        if ( (dword_8048803 & 0x10000) != 0 )
          goto LABEL_13;
        goto LABEL_25;
      }
    }
  }
  LOBYTE(v2) = BYTE2(dword_8048803) & 8;
  if ( (dword_8048803 & 0x80000) == 0 )
    goto LABEL_25;
LABEL_13:
  status = 0;
  *v3 = 10;
  return sys_write(1, addr, v3 + 1 - addr);
}
// 80481E1: using guessed type int dword_80481E1;
// 80481E5: using guessed type int dword_80481E5;
// 80481E9: using guessed type int dword_80481E9;
// 80487F9: using guessed type int dword_80487F9;
// 8048803: using guessed type int dword_8048803;
// 8048809: using guessed type __int16 word_8048809;
// 804880B: using guessed type __int16 word_804880B;

//----- (080481DA) --------------------------------------------------------
char __usercall sub_80481DA@<al>(_BYTE *a1@<edi>, char *a2@<esi>)
{
  char result; // al

  do
  {
    result = *a2++;
    *a1++ = result;
  }
  while ( result );
  return result;
}

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
