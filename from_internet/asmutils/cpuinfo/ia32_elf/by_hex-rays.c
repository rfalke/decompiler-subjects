/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall sub_8048060@<eax>(int@<eax>, const char *@<edi>);
void __cdecl __noreturn start(int, int);
// int __usercall sub_8048142@<eax>(int@<eax>, int@<ebp>, int@<esi>);
// void __usercall sub_8048157(int@<eax>, int@<ebp>, __int16@<di>, int@<esi>);
void __fastcall sub_80481C8(char *a1);
// void __usercall sub_80481DE(unsigned int@<eax>, int@<ebp>);
void sub_8048203();

//-------------------------------------------------------------------------
// Data declarations

const struct timespec req = { 1, 995000000 }; // idb


//----- (08048060) --------------------------------------------------------
int __usercall sub_8048060@<eax>(int a1@<eax>, const char *a2@<edi>)
{
  const char *v2; // edi

  v2 = &a2[strlen(a2) + 1];
  if ( *(_DWORD *)(v2 - 5) == 1684366704 && *(_DWORD *)(v2 - 9) == 1937076323 )
    return 0;
  return a1;
}

//----- (0804807F) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start(int a1, int a2)
{
  _DWORD *v2; // ebp
  int v3; // eax
  unsigned int v4; // kr00_4
  unsigned int v5; // kr04_4
  bool v21; // cc
  unsigned __int8 v22; // al
  int v23; // eax
  unsigned __int64 v24; // rax
  unsigned __int64 v25; // rax
  unsigned int v26; // eax
  char *v27; // ecx
  unsigned int v28; // et2
  int v29; // [esp-Ch] [ebp-Ch]
  const char *v30; // [esp-8h] [ebp-8h]
  _DWORD *v31; // [esp-4h] [ebp-4h] BYREF

  v2 = &(&v31)[v29];
  v3 = sub_8048060(v29, v30);
  *((_BYTE *)v2 + 11) = v3 - 1;
  if ( v3 > 1 && ((unsigned __int16)*v31 == 29741 || *v31 == 1769221421) )
    *((_BYTE *)v2 + 11) = -*((_BYTE *)v2 + 11);
  v4 = __readeflags();
  __writeeflags(v4 ^ 0x200000);
  v5 = __readeflags();
  if ( v5 == v4 )
  {
    sub_80481C8((char *)&req + 8);
  }
  else
  {
    _EAX = 0;
    if ( *((char *)v2 + 11) < 0 )
    {
      v24 = __rdtsc();
      v31 = (_DWORD *)v24;
      __asm { int     80h; LINUX - sys_nanosleep }
      v25 = __rdtsc();
      v26 = (unsigned int)(v25 - (_DWORD)v31) >> 1;
      v31 = 0;
      v27 = (char *)v2 + 9;
      *(_WORD *)((char *)v2 + 9) = 10;
      do
      {
        --v27;
        v31 = (_DWORD *)((char *)v31 + 1);
        v28 = v26 % 0xA;
        v26 /= 0xAu;
        *v27 = v28 | 0x30;
      }
      while ( v26 );
      sub_80481C8(v27);
    }
    else
    {
      __asm { cpuid }
      v31 = (_DWORD *)_EAX;
      sub_8048142(_EAX, (int)v2, (int)&req);
      _EAX = 0x80000000;
      __asm { cpuid }
      if ( _EAX < 0 )
        sub_8048142(_EAX, (int)v2, (int)&req);
      _EAX = v31;
      if ( (unsigned int)v31 >= 2 )
      {
        LOBYTE(_EAX) = 2;
        __asm { cpuid }
        v21 = (char)_EAX <= 1;
        v22 = _EAX - 1;
        if ( !v21 )
          sub_8048142(v22 | 0x10000000, (int)v2, (int)&req);
      }
    }
  }
  v23 = sys_exit(0);
}
// 8048099: positive sp value C has been found
// 8048085: variable 'v29' is possibly undefined
// 804808C: variable 'v30' is possibly undefined

//----- (08048142) --------------------------------------------------------
int __usercall sub_8048142@<eax>(int a1@<eax>, int a2@<ebp>, int a3@<esi>)
{
  int v3; // edi
  int v5; // [esp+0h] [ebp-4h]

  v5 = a1;
  LOWORD(a1) = 0;
  v3 = a1;
  do
  {
    sub_8048157(v3, a2, v3, a3);
    ++v3;
    LOBYTE(v5) = v5 - 1;
  }
  while ( (v5 & 0x80u) == 0 );
  return v5;
}

//----- (08048157) --------------------------------------------------------
void __usercall sub_8048157(int a1@<eax>, int a2@<ebp>, __int16 a3@<di>, int a4@<esi>)
{
  int v10; // eax
  unsigned int v11; // eax
  int v12; // ebx
  int v13; // et0
  unsigned int v14; // ecx
  unsigned int v15; // edx
  int v16; // ecx
  char *v17; // ecx
  char *v18; // ecx
  int v19; // edx
  char *v20; // ecx
  int v21; // eax
  char *v22; // ecx
  char *v23; // ecx
  int v24; // [esp-4h] [ebp-4h]

  sub_8048203();
  _EAX = a1 & 0xEFFFFFFF;
  __asm { cpuid }
  sub_80481DE(_EAX, a2);
  v13 = v10;
  v11 = _EBX;
  v12 = v13;
  sub_80481DE(v11, a2);
  sub_80481DE(v14, a2);
  sub_80481DE(v15, a2);
  if ( *(char *)(a2 + 11) > 0 )
  {
    v24 = v16;
    *(_DWORD *)(a2 + 1) = 10016;
    sub_80481C8((char *)(a2 + 1));
    *(_DWORD *)--v17 = v12;
    sub_80481C8(v17);
    *(_DWORD *)v18 = v24;
    sub_80481C8(v18);
    *(_DWORD *)v20 = v19;
    sub_80481C8(v20);
    *(_DWORD *)v22 = v21;
    sub_80481C8(v22);
    *(_WORD *)v23 = 39;
    sub_80481C8(v23);
  }
  sub_80481C8((char *)(a4 + 18));
}
// 8048171: variable 'v10' is possibly undefined
// 8048178: variable 'v14' is possibly undefined
// 804817E: variable 'v15' is possibly undefined
// 804818F: variable 'v16' is possibly undefined
// 804819E: variable 'v17' is possibly undefined
// 80481A6: variable 'v18' is possibly undefined
// 80481AD: variable 'v19' is possibly undefined
// 80481AD: variable 'v20' is possibly undefined
// 80481B4: variable 'v21' is possibly undefined
// 80481B4: variable 'v22' is possibly undefined
// 80481BB: variable 'v23' is possibly undefined

//----- (080481C8) --------------------------------------------------------
void __fastcall sub_80481C8(char *a1)
{
  char *v1; // edx
  int v2; // eax

  v1 = a1 - 1;
  do
    ++v1;
  while ( *v1 >= 9 );
  v2 = sys_write(1, a1, v1 - a1);
}

//----- (080481DE) --------------------------------------------------------
void __usercall sub_80481DE(unsigned int a1@<eax>, int a2@<ebp>)
{
  int v3; // ebx
  _BYTE *v4; // ecx
  unsigned __int8 v5; // al

  v3 = 8;
  v4 = (_BYTE *)(a2 + 8);
  *(_BYTE *)(a2 + 8) = 32;
  do
  {
    v5 = a1 & 0xF;
    a1 >>= 4;
    --v4;
    _AL = v5 - ((v5 < 0xAu) + 105);
    __asm { das }
    *v4 = _AL;
  }
  while ( v3-- > 1 );
  JUMPOUT(0x80481D4);
}
// 8048201: control flows out of bounds to 80481D4

//----- (08048203) --------------------------------------------------------
void sub_8048203()
{
  JUMPOUT(0x80481E1);
}
// 8048206: control flows out of bounds to 80481E1

// nfuncs=7 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
