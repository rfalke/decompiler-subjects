/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __cdecl main(int argc, const char **argv, const char **envp);
void _get_GOT();
// int __usercall _system_call@<eax>(int@<ebx>);
// void __usercall close(int@<ebx>, _DWORD *@<esi>);
// void __usercall read(int@<ebx>);
// void __usercall lseek(int@<ebx>);
// void __usercall chmod(int@<ebx>);
// void __usercall pipe(int@<ebx>, int@<ebp>);
// void __usercall link(int@<ebx>);
// void __usercall __noreturn unlink(int@<ebx>, _DWORD *@<edi>, int@<ebp>);
// void __usercall __noreturn mkdir(int@<ebx>, _DWORD *@<edi>, int@<ebp>);
// void __usercall __noreturn rmdir(int@<ebx>, int@<ebp>);
// void __usercall __noreturn exit(int@<ebx>);
// void __usercall fork(int@<ebx>);
// void __usercall execve(int@<ebx>);
// void __usercall ioctl(int@<ebx>);
// void __usercall alarm(int@<ebx>);
// void __usercall signal(int@<ebx>);
// void __usercall wait4(int@<ebx>);
// void __usercall __noreturn getuid(int@<ebx>, _BYTE *edi0@<edi>, int _4, int, char);
// void __usercall __noreturn getgid(int ebx0@<ebx>, _BYTE *edi0@<edi>, int, int, char);
void __cdecl __noreturn _start_main(int, int, char);
// int __usercall fastcall@<eax>(int result@<eax>);
// void *__usercall memset@<eax>(void *@<eax>, char@<dl>, unsigned int@<ecx>, void *, char, unsigned int);
// void *__usercall memcpy@<eax>(void *result@<eax>, const void *@<edx>, unsigned int@<ecx>, void *, const void *, unsigned int);
// int __usercall memcmp@<eax>(unsigned int@<ecx>, const void *@<edi>, const void *@<esi>, const void *, const void *, unsigned int);
// const char *__usercall getenv@<eax>(const char *result@<eax>, const char *);
// int __usercall strlen@<eax>(int@<eax>, int);
// void __usercall itoa(unsigned int a1@<eax>, char *a2@<edx>, unsigned int a3@<ecx>, unsigned int a4, char *a5, unsigned int a6);
// int __usercall itoa_printB@<eax>(unsigned int@<eax>, unsigned int@<ecx>, char *@<edi>);
// void __usercall sprintf(int a1@<eax>, char *a2, _BYTE *a3, char a4);
_DWORD printf(); // weak
// int __usercall strtol@<eax>(_BYTE *@<eax>, _BYTE *@<edx>, int@<ecx>, _BYTE *, _BYTE *, int);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN open; // weak
_UNKNOWN write; // weak
char *fname = "_tst_"; // weak
char *s = "Hello,world!\nType something, then press [Enter]\n"; // weak
int fd; // weak
int len; // weak
_DWORD _envp; // weak
_UNKNOWN _cc; // weak


//----- (08049000) --------------------------------------------------------
int __cdecl __noreturn main(int argc, const char **argv, const char **envp)
{
  int v3; // ebx
  _DWORD *v4; // edi
  _DWORD *v5; // esi
  int v6; // eax
  int savedregs; // [esp+8h] [ebp+0h] BYREF

  fastcall(0);
  len = strlen((int)s, (int)s);
  fd = ((int (__cdecl *)(char *, int, int))open)(fname, 66, 384);
  ((void (__cdecl *)(int, char *, int))write)(fd, s, len);
  close(v3, v5);
  fd = ((int (__cdecl *)(char *, _DWORD))open)(fname, 0);
  lseek(v3);
  read(v3);
  len = v6;
  close(v3, v5);
  unlink(v3, v4, (int)&savedregs);
}
// 8049077: variable 'v3' is possibly undefined
// 8049077: variable 'v5' is possibly undefined
// 80490CA: variable 'v6' is possibly undefined
// 80490E9: variable 'v4' is possibly undefined
// 804C00C: using guessed type char *fname;
// 804C010: using guessed type char *s;
// 804C084: using guessed type int fd;
// 804C088: using guessed type int len;

//----- (0804919F) --------------------------------------------------------
void _get_GOT()
{
  ;
}

//----- (080491A3) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __usercall _system_call@<eax>(int a1@<ebx>)
{
  int result; // eax

  result = *(unsigned __int8 *)(*(_DWORD *)a1 + 1);
  __asm { int     80h; LINUX - }
  return result;
}
// 8049226: positive sp value 4 has been found
// 80491A3: could not find valid save-restore pair for ebx
// 80491A3: could not find valid save-restore pair for esi

//----- (0804922E) --------------------------------------------------------
void __usercall close(int a1@<ebx>, _DWORD *a2@<esi>)
{
  *a2 += _system_call(a1);
  read(a1);
}

//----- (08049235) --------------------------------------------------------
void __usercall read(int a1@<ebx>)
{
  _system_call(a1);
  JUMPOUT(0x804923C);
}
// 804923A: control flows out of bounds to 804923C

//----- (08049243) --------------------------------------------------------
void __usercall lseek(int a1@<ebx>)
{
  _system_call(a1);
  chmod(a1);
}

//----- (0804924A) --------------------------------------------------------
void __usercall chmod(int a1@<ebx>)
{
  _system_call(a1);
  JUMPOUT(0x8049251);
}
// 804924F: control flows out of bounds to 8049251

//----- (08049258) --------------------------------------------------------
void __usercall pipe(int a1@<ebx>, int a2@<ebp>)
{
  _DWORD *v2; // edx

  _system_call(a1);
  *v2 += a2;
  link(a1);
}
// 804925D: variable 'v2' is possibly undefined

//----- (0804925F) --------------------------------------------------------
void __usercall link(int a1@<ebx>)
{
  _system_call(a1);
  JUMPOUT(0x8049266);
}
// 8049264: control flows out of bounds to 8049266

//----- (0804926D) --------------------------------------------------------
void __usercall __noreturn unlink(int a1@<ebx>, _DWORD *a2@<edi>, int a3@<ebp>)
{
  _DWORD *v3; // edx
  int v4; // ecx

  _system_call(a1);
  *v3 += v4;
  mkdir(a1, a2, a3);
}
// 8049272: variable 'v4' is possibly undefined
// 8049272: variable 'v3' is possibly undefined

//----- (08049274) --------------------------------------------------------
void __usercall __noreturn mkdir(int a1@<ebx>, _DWORD *a2@<edi>, int a3@<ebp>)
{
  void *retaddr; // [esp+0h] [ebp+0h] BYREF

  _system_call(a1);
  *a2 += &retaddr;
  rmdir(a1, a3);
}

//----- (0804927B) --------------------------------------------------------
void __usercall __noreturn rmdir(int a1@<ebx>, int a2@<ebp>)
{
  _DWORD *v2; // eax

  v2 = (_DWORD *)_system_call(a1);
  *v2 += a2;
  exit(a1);
}

//----- (08049282) --------------------------------------------------------
void __usercall __noreturn exit(int a1@<ebx>)
{
  int v1; // eax
  _DWORD *v2; // ecx

  v1 = _system_call(a1);
  *v2 += v1;
  fork(a1);
}
// 8049287: variable 'v2' is possibly undefined

//----- (08049289) --------------------------------------------------------
void __usercall fork(int a1@<ebx>)
{
  char v1; // al
  _BYTE *v2; // edx

  v1 = _system_call(a1);
  *v2 += v1;
  execve(a1);
}
// 804928E: variable 'v2' is possibly undefined

//----- (08049290) --------------------------------------------------------
void __usercall execve(int a1@<ebx>)
{
  _system_call(a1);
  JUMPOUT(0x8049297);
}
// 8049295: control flows out of bounds to 8049297

//----- (0804929E) --------------------------------------------------------
void __usercall ioctl(int a1@<ebx>)
{
  _system_call(a1);
  alarm(a1);
}

//----- (080492A5) --------------------------------------------------------
void __usercall alarm(int a1@<ebx>)
{
  _system_call(a1);
  *(_DWORD *)a1 += a1;
  JUMPOUT(0x80492AC);
}
// 80492AA: control flows out of bounds to 80492AC

//----- (080492BA) --------------------------------------------------------
void __usercall signal(int a1@<ebx>)
{
  _system_call(a1);
  wait4(a1);
}

//----- (080492C1) --------------------------------------------------------
void __usercall wait4(int a1@<ebx>)
{
  _system_call(a1);
  JUMPOUT(0x80492C8);
}
// 80492C6: control flows out of bounds to 80492C8

//----- (080492D6) --------------------------------------------------------
void __usercall __noreturn getuid(int ebx0@<ebx>, _BYTE *edi0@<edi>, int _4, int a4, char a5)
{
  _BYTE *v5; // eax

  v5 = (_BYTE *)_system_call(ebx0);
  *v5 += ebx0;
  getgid(ebx0, edi0, _4, a4, a5);
}

//----- (080492DD) --------------------------------------------------------
void __usercall __noreturn getgid(int ebx0@<ebx>, _BYTE *edi0@<edi>, int a3, int a4, char a5)
{
  char v5; // ch

  _system_call(ebx0);
  *edi0 += v5;
  _start_main(a3, a4, a5);
}
// 80492E2: variable 'v5' is possibly undefined

//----- (080492E4) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn _start_main(int a1, int a2, char a3)
{
  void (__cdecl *v3)(); // [esp-8h] [ebp-8h]
  int v4; // [esp-4h] [ebp-4h]

  _envp = &a1 + v4;
  v3();
  exit((int)&_envp);
}
// 80492E6: positive sp value 8 has been found
// 80492E6: variable 'v4' is possibly undefined
// 8049302: variable 'v3' is possibly undefined
// 804C08C: using guessed type _DWORD _envp;

//----- (0804930A) --------------------------------------------------------
int __usercall fastcall@<eax>(int result@<eax>)
{
  _cc = result;
  return result;
}

//----- (08049320) --------------------------------------------------------
void *__usercall memset@<eax>(void *a1@<eax>, char a2@<dl>, unsigned int a3@<ecx>, void *a4, char a5, unsigned int a6)
{
  void *v7; // edx

  v7 = a1;
  if ( !_cc )
  {
    v7 = a4;
    a2 = a5;
    a3 = a6;
  }
  memset(v7, a2, a3);
  return a1;
}

//----- (08049353) --------------------------------------------------------
void *__usercall memcpy@<eax>(
        void *result@<eax>,
        const void *a2@<edx>,
        unsigned int a3@<ecx>,
        void *a4,
        const void *a5,
        unsigned int a6)
{
  void *v6; // edi

  v6 = result;
  if ( !_cc )
  {
    v6 = a4;
    a2 = a5;
    a3 = a6;
  }
  qmemcpy(v6, a2, a3);
  return result;
}
// 8049353: could not find valid save-restore pair for ebx

//----- (08049381) --------------------------------------------------------
int __usercall memcmp@<eax>(
        unsigned int a1@<ecx>,
        const void *a2@<edi>,
        const void *a3@<esi>,
        const void *a4,
        const void *a5,
        unsigned int a6)
{
  int result; // eax

  if ( !_cc )
  {
    a3 = a4;
    a2 = a5;
    a1 = a6;
  }
  if ( memcmp(a3, a2, a1) )
    return 1;
  return result;
}

//----- (080493B6) --------------------------------------------------------
const char *__usercall getenv@<eax>(const char *result@<eax>, const char *a2)
{
  const char *v2; // edi
  const void **v3; // ebx
  const char *v4; // edx
  unsigned int v5; // kr04_4

  v2 = result;
  if ( !_cc )
    v2 = a2;
  v3 = (const void **)_envp;
  v4 = v2;
  v5 = strlen(v2) + 1;
  while ( *v3 && memcmp(v4, *v3, v5 - 1) )
    ++v3;
  return result;
}
// 80493B6: could not find valid save-restore pair for ebx
// 80493B6: could not find valid save-restore pair for esi
// 804C08C: using guessed type _DWORD _envp;

//----- (08049411) --------------------------------------------------------
int __usercall strlen@<eax>(int a1@<eax>, int a2)
{
  int v2; // edx
  int v3; // eax

  if ( !_cc )
    a1 = a2;
  v2 = a1;
  v3 = 0;
  while ( *(_BYTE *)(v2 + v3++) != 0 )
    ;
  return v3 - 1;
}

//----- (0804943C) --------------------------------------------------------
void __usercall itoa(
        unsigned int a1@<eax>,
        char *a2@<edx>,
        unsigned int a3@<ecx>,
        unsigned int a4,
        char *a5,
        unsigned int a6)
{
  if ( !_cc )
  {
    a1 = a4;
    a2 = a5;
    a3 = a6;
  }
  itoa_printB(a1, a3, a2);
  *a2 = 0;
}
// 804943C: could not find valid save-restore pair for ebx

//----- (0804946D) --------------------------------------------------------
int __usercall itoa_printB@<eax>(unsigned int a1@<eax>, unsigned int a2@<ecx>, char *a3@<edi>)
{
  int result; // eax
  char v4; // dl
  unsigned int v5; // et2
  char v6; // dl
  char v7; // [esp-4h] [ebp-4h]

  v5 = a1 % a2;
  result = a1 / a2;
  v4 = v5;
  if ( result )
  {
    v7 = v4;
    result = itoa_printB(result, a2, a3);
    v4 = v7;
  }
  v6 = v4 + 48;
  if ( v6 > 57 )
    v6 += 39;
  *a3 = v6;
  return result;
}

//----- (0804948B) --------------------------------------------------------
void __usercall sprintf(int a1@<eax>, char *a2, _BYTE *a3, char a4)
{
  char *v4; // edx
  char *v7; // ebx
  unsigned int v8; // ecx
  int v10; // [esp-40h] [ebp-44h]
  char *v11; // [esp-3Ch] [ebp-40h]

  v4 = &a4;
  while ( 1 )
  {
    LOBYTE(a1) = *a3++;
    if ( !(_BYTE)a1 )
      break;
    if ( (_BYTE)a1 != 37 )
      goto sprintf_store;
    v7 = *(char **)v4;
    LOBYTE(a1) = *a3++;
    v8 = 10;
    if ( (_BYTE)a1 == 100 || (v8 = 16, (_BYTE)a1 == 120) || (v8 = 8, (_BYTE)a1 == 111) || (v8 = 2, (_BYTE)a1 == 98) )
    {
      v11 = v4;
      v10 = a1;
      itoa_printB((unsigned int)v7, v8, a2);
      *a2 = 0;
      a1 = v10;
      v4 = v11;
      while ( *a2++ != 0 )
        ;
      --a2;
      goto sprintf_allok;
    }
    if ( (_BYTE)a1 == 99 )
    {
sprintf_store:
      *a2++ = a1;
    }
    else if ( (_BYTE)a1 == 115 )
    {
      if ( v7 )
      {
        while ( *v7 )
          *a2++ = *v7++;
      }
sprintf_allok:
      v4 += 4;
    }
  }
  *a2 = 0;
}
// 804948B: could not find valid save-restore pair for esi

//----- (08049500) --------------------------------------------------------
#error "804951B: call analysis failed (funcsize=20)"

//----- (0804958A) --------------------------------------------------------
int __usercall strtol@<eax>(_BYTE *a1@<eax>, _BYTE *a2@<edx>, int a3@<ecx>, _BYTE *a4, _BYTE *a5, int a6)
{
  int result; // eax
  int v9; // ebx

  if ( !_cc )
  {
    a1 = a4;
    a2 = a5;
    a3 = a6;
  }
  if ( !a3 )
    a3 = 10;
  result = 0;
  v9 = 0;
  while ( *a1 == 32 )
    ++a1;
  if ( *(_WORD *)a1 == 30768 )
  {
    a3 = 16;
    a1 += 2;
  }
  do
  {
    LOBYTE(v9) = *a1 - 48;
    if ( *a1 < 0x30u )
      break;
    if ( (unsigned __int8)v9 > 9u )
    {
      LOBYTE(v9) = *a1 - 55;
      if ( (unsigned __int8)v9 > 0x23u )
        LOBYTE(v9) = *a1 - 87;
    }
    result = v9 + a3 * result;
    ++a1;
  }
  while ( a1 != a2 );
  return result;
}

// nfuncs=34 queued=33 decompiled=33 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 33 function(s)"
