/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(int@<ebx>);
__int64 __fastcall sub_8048484(int, unsigned __int8);
// void __usercall sub_8048491(__int64 a1@<edx:eax>, int a2@<ecx>, _BYTE *a3@<edi>);
// void __usercall sub_80484B9(int@<edi>);
// void __usercall sub_80484C9(unsigned int a1@<ecx>, void *a2@<edi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_804804C = 1024; // weak
char filename[] = "/etc/mtab"; // idb
__int16 word_804805A = 29525; // weak
int dword_8048130[4] = { 673212004, 1970107233, 1936484724, 774905897 }; // weak
char byte_8048143 = 'F'; // weak
__int16 word_8048186 = 29253; // weak
int dword_80481A4[5] = { 1869771333, 1914714738, 1768186213, 1713399662, 1701603681 }; // weak
struct statfs buf; // idb
size_t len; // idb
char addr[31]; // idb
char byte_8048559[3]; // weak


//----- (080481BB) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(int a1@<ebx>)
{
  __int16 *v1; // ecx
  size_t v2; // edx
  int v3; // eax
  mode_t v4; // edx
  int v5; // eax
  char *v6; // esi
  int v7; // ecx
  bool v8; // zf
  char *v9; // edi
  _BYTE *v10; // edi
  char *v11; // esi
  int v12; // ecx
  char *v13; // edi
  int v14; // eax
  int v15; // eax
  size_t v16; // edx
  int v17; // eax
  __int64 v18; // rax
  int v19; // ecx
  size_t v20; // ecx
  int v21; // eax
  int v22; // eax
  __int64 v23; // rax
  int v24; // ecx
  size_t v25; // ecx
  int v26; // eax
  int v27; // eax
  __int64 v28; // rax
  int v29; // ecx
  size_t v30; // ecx
  int v31; // eax
  int v32; // eax
  __int64 v33; // rax
  size_t v34; // ecx
  int v35; // eax
  int v36; // eax
  int v37; // eax
  int v38; // edx
  int v39; // eax
  int v40; // eax
  int v41; // eax
  char v42; // [esp-Ch] [ebp-Ch]
  int v43; // [esp-4h] [ebp-4h]
  int v44; // [esp-4h] [ebp-4h]

  if ( v43 && *(_WORD *)v43 == 11565 )
  {
    if ( *(_DWORD *)(v43 + 2) == 1886152040 )
    {
      v1 = &word_804805A;
      v2 = 214;
    }
    else
    {
      if ( *(_DWORD *)(v43 + 2) != 1936876918 )
        goto LABEL_28;
      v1 = (__int16 *)dword_8048130;
      v2 = 19;
    }
  }
  else
  {
    v3 = sys_write(1, &byte_8048143, 0x43u);
    v5 = sys_open(filename, 0, v4);
    if ( v5 >= 0 )
    {
      v6 = byte_8048559;
      a1 = v5;
      v7 = sys_read(v5, byte_8048559, 0x4000u);
      if ( v7 >= 0 )
      {
        do
        {
          v10 = (_BYTE *)(&len + 1);
          do
          {
            if ( !v7 )
              goto LABEL_28;
            --v7;
            *v10++ = *v6++;
          }
          while ( *v6 != 32 );
          *v10 = 0;
          v11 = v6 + 1;
          v12 = v7 - 1;
          v13 = addr;
          do
          {
            if ( !v12 )
              v14 = sys_exit(a1);
            --v12;
            *v13++ = *v11++;
          }
          while ( *v11 != 32 );
          *v13 = 0;
          v44 = v12;
          v15 = sys_statfs(addr, &buf);
          sub_80484B9((int)&len + 1);
          v42 = v16;
          v17 = sys_write(1, (char *)&len + 1, v16);
          LODWORD(v18) = (unsigned int)buf.f_bsize * (unsigned __int64)buf.f_blocks / (unsigned int)dword_804804C;
          HIDWORD(v18) = (unsigned int)buf.f_bsize * (unsigned __int64)buf.f_blocks % (unsigned int)dword_804804C;
          sub_8048491(v18, v19, &buf.f_spare[4]);
          sub_80484C9((unsigned __int8)(30 - len - v42), (char *)&len + 1);
          v21 = sys_write(1, (char *)&len + 1, v20);
          v22 = sys_write(1, &buf.f_spare[4], (unsigned __int8)len);
          LODWORD(v23) = (unsigned int)buf.f_bsize
                       * (unsigned __int64)(buf.f_blocks - buf.f_bfree)
                       / (unsigned int)dword_804804C;
          HIDWORD(v23) = (unsigned int)buf.f_bsize * (unsigned __int64)(buf.f_blocks - buf.f_bfree)
                       % (unsigned int)dword_804804C;
          sub_8048491(v23, v24, &buf.f_spare[4]);
          sub_80484C9((unsigned __int8)(10 - len), (char *)&len + 1);
          v26 = sys_write(1, (char *)&len + 1, v25);
          v27 = sys_write(1, &buf.f_spare[4], (unsigned __int8)len);
          LODWORD(v28) = (unsigned int)buf.f_bsize * (unsigned __int64)buf.f_bavail / (unsigned int)dword_804804C;
          HIDWORD(v28) = (unsigned int)buf.f_bsize * (unsigned __int64)buf.f_bavail % (unsigned int)dword_804804C;
          sub_8048491(v28, v29, &buf.f_spare[4]);
          sub_80484C9((unsigned __int8)(10 - len), (char *)&len + 1);
          v31 = sys_write(1, (char *)&len + 1, v30);
          v32 = sys_write(1, &buf.f_spare[4], (unsigned __int8)len);
          if ( buf.f_blocks )
          {
            LODWORD(v33) = 100 * (unsigned __int64)(buf.f_blocks - buf.f_bavail) / buf.f_blocks;
            HIDWORD(v33) = 100 * (unsigned __int64)(buf.f_blocks - buf.f_bavail) % buf.f_blocks;
            if ( HIDWORD(v33) >= (int)buf.f_blocks >> 1 )
              LODWORD(v33) = v33 + 1;
            sub_8048491(v33, (int)buf.f_blocks >> 1, &buf.f_spare[4]);
            *(_BYTE *)(len + 134513937) = 37;
          }
          else
          {
            len = 1;
            LOWORD(buf.f_spare[4]) = 8237;
          }
          sub_80484C9((unsigned __int8)(4 - len), (char *)&len + 1);
          v35 = sys_write(1, (char *)&len + 1, v34);
          v36 = sys_write(1, &buf.f_spare[4], (unsigned __int8)(len + 1));
          v37 = sys_write(1, (char *)&len + 1, 1u);
          sub_80484B9((int)addr);
          addr[v38] = 10;
          a1 = 1;
          v39 = sys_write(1, addr, v38 + 1);
          v9 = v11;
          v7 = v44;
          do
          {
            if ( !v7 )
              break;
            v8 = *v9++ == 10;
            --v7;
          }
          while ( !v8 );
          v6 = v9;
        }
        while ( v7 );
LABEL_28:
        v41 = sys_exit(a1);
      }
      v1 = (__int16 *)dword_80481A4;
      v2 = 23;
    }
    else
    {
      v1 = &word_8048186;
      v2 = 30;
    }
  }
  a1 = 2;
  v40 = sys_write(2, v1, v2);
  goto LABEL_28;
}
// 80481BE: positive sp value C has been found
// 80481C0: variable 'v43' is possibly undefined
// 8048219: variable 'v4' is possibly undefined
// 80482AD: variable 'v16' is possibly undefined
// 80482D0: variable 'v19' is possibly undefined
// 80482F8: variable 'v20' is possibly undefined
// 804832B: variable 'v24' is possibly undefined
// 8048352: variable 'v25' is possibly undefined
// 804837F: variable 'v29' is possibly undefined
// 80483A4: variable 'v30' is possibly undefined
// 804842B: variable 'v34' is possibly undefined
// 804845E: variable 'v38' is possibly undefined
// 804804C: using guessed type int dword_804804C;
// 804805A: using guessed type __int16 word_804805A;
// 8048130: using guessed type int dword_8048130[4];
// 8048143: using guessed type char byte_8048143;
// 8048186: using guessed type __int16 word_8048186;
// 80481A4: using guessed type int dword_80481A4[5];

//----- (08048484) --------------------------------------------------------
__int64 __fastcall sub_8048484(int a1, unsigned __int8 a2)
{
  __int64 result; // rax

  if ( a2 < 0xAu )
    BYTE4(result) = a2 | 0x30;
  else
    BYTE4(result) = a2 + 55;
  return result;
}

//----- (08048491) --------------------------------------------------------
void __usercall sub_8048491(__int64 a1@<edx:eax>, int a2@<ecx>, _BYTE *a3@<edi>)
{
  size_t v3; // esi

  v3 = 0;
  do
  {
    a1 = sub_8048484(a2, (unsigned int)a1 % 0xA);
    ++v3;
  }
  while ( (_DWORD)a1 );
  len = v3;
  do
  {
    *a3++ = BYTE4(a1);
    --v3;
  }
  while ( v3 );
}
// 804849E: variable 'a2' is possibly undefined

//----- (080484B9) --------------------------------------------------------
void __usercall sub_80484B9(int a1@<edi>)
{
  _BYTE *v1; // edi

  v1 = (_BYTE *)(a1 - 1);
  do
    ++v1;
  while ( *v1 );
}

//----- (080484C9) --------------------------------------------------------
void __usercall sub_80484C9(unsigned int a1@<ecx>, void *a2@<edi>)
{
  memset(a2, 32, a1);
}

// nfuncs=5 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
