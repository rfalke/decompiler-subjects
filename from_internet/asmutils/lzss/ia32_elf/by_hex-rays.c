/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(mode_t@<edx>, char *@<esi>);
// void __usercall sub_80480DF(int@<edi>);
// int __usercall sub_8048104@<eax>(int result@<eax>, int@<edi>);
// int __usercall sub_804813E@<eax>(int result@<eax>, int@<edi>);
// int __usercall sub_8048180@<eax>(int result@<eax>, int@<edi>);
// void __usercall sub_8048203(char *a1@<esi>);
// int __usercall sub_8048312@<eax>(int@<eax>, char@<cl>, int@<edi>);
// int __usercall __spoils<ecx> sub_804832B@<eax>(char@<al>, int@<edi>);
// int __usercall sub_80483A0@<eax>(int@<edi>);
int sub_80483BF();

//-------------------------------------------------------------------------
// Data declarations

int dword_804804C[5] = { 1734439765, 1814051429, 544437114, 543456357, 1701603686 }; // weak
char byte_8048061[3] = { 'C', 'a', 'n' }; // weak
int dword_80483EB; // idb
int fd; // idb
char byte_80483F3; // weak
char byte_804C3F3; // weak
char byte_80503FF[]; // weak


//----- (08048077) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(mode_t a1@<edx>, char *a2@<esi>)
{
  int v2; // ebp
  int v3; // eax
  int v4; // eax
  void (__usercall *v5)(char *@<esi>); // eax
  int v6; // eax
  int v7; // [esp-10h] [ebp-10h]
  _BYTE *v8; // [esp-8h] [ebp-8h]
  char *v9; // [esp-4h] [ebp-4h]

  v2 = 0;
  LOBYTE(fd) = 1;
  if ( v7 - 2 < 0 )
    goto LABEL_5;
  if ( v7 - 3 >= 0 )
  {
    v2 = sys_open(v9, 0, a1);
    if ( v2 < 0 )
    {
      v3 = sys_write(1, byte_8048061, 0x16u);
      goto LABEL_9;
    }
  }
  dword_80483EB = v2;
  v5 = sub_8048203;
  if ( *v8 == 101 || (v5 = (void (__usercall *)(char *@<esi>))sub_8048312, *v8 == 100) )
    v5(a2);
  else
LABEL_5:
    v4 = sys_write(1, dword_804804C, 0x15u);
LABEL_9:
  v6 = sys_exit(0);
}
// 804808B: positive sp value 10 has been found
// 8048083: variable 'v7' is possibly undefined
// 8048090: variable 'v9' is possibly undefined
// 80480C7: variable 'v8' is possibly undefined
// 804804C: using guessed type int dword_804804C[5];

//----- (080480DF) --------------------------------------------------------
void __usercall sub_80480DF(int a1@<edi>)
{
  *(_DWORD *)(a1 - 8) = 31;
  *(_DWORD *)(a1 - 4) = 0;
  *(_DWORD *)(a1 - 12) = 0;
  memset((void *)a1, 0, 0x8010u);
  memset32((void *)(a1 + 32784), 0x8000, 0x18002u);
}
// 80480DF: could not find valid save-restore pair for edi

//----- (08048104) --------------------------------------------------------
int __usercall sub_8048104@<eax>(int result@<eax>, int a2@<edi>)
{
  int v2; // ebx
  int v3; // ecx

  v2 = *(_DWORD *)(a2 + 4 * result + 294932);
  if ( v2 != 0x8000 )
  {
    v3 = *(_DWORD *)(a2 + 4 * result + 32784);
    *(_DWORD *)(a2 + 4 * v2 + 32784) = v3;
    *(_DWORD *)(a2 + 4 * v3 + 294932) = v2;
    *(_DWORD *)(a2 + 4 * result + 32784) = 0x8000;
    *(_DWORD *)(a2 + 4 * result + 294932) = 0x8000;
  }
  return result;
}

//----- (0804813E) --------------------------------------------------------
int __usercall sub_804813E@<eax>(int result@<eax>, int a2@<edi>)
{
  int v2; // ebx
  int v3; // ecx

  v2 = *(_WORD *)(a2 + result) & 0x7FFF;
  v3 = *(_DWORD *)(a2 + 4 * v2 + 163860);
  *(_DWORD *)(a2 + 4 * v2 + 163860) = result;
  *(_DWORD *)(a2 + 4 * result + 294932) = v2 + 32769;
  *(_DWORD *)(a2 + 4 * result + 32784) = v3;
  if ( v3 != 0x8000 )
    *(_DWORD *)(a2 + 4 * v3 + 294932) = result;
  return result;
}

//----- (08048180) --------------------------------------------------------
int __usercall sub_8048180@<eax>(int result@<eax>, int a2@<edi>)
{
  int i; // ecx
  unsigned int j; // edx

  *(_DWORD *)(a2 + 426008) = 0;
  *(_DWORD *)(a2 + 426012) = 0;
  for ( i = *(_DWORD *)(a2 + 4 * (*(_WORD *)(a2 + result) & 0x7FFF) + 163860);
        i != 0x8000;
        i = *(_DWORD *)(a2 + 4 * i + 32784) )
  {
    for ( j = 0; j <= 0x10; ++j )
    {
      if ( *(_BYTE *)(a2 + i + j) != *(_BYTE *)(a2 + result + j) )
        break;
    }
    if ( j > *(_DWORD *)(a2 + 426012) )
    {
      *(_DWORD *)(a2 + 426012) = j;
      *(_DWORD *)(a2 + 426008) = ((_WORD)result - (_WORD)i) & 0x7FFF;
    }
    if ( j == 16 )
      return sub_8048104(i, a2);
  }
  return result;
}
// 80481F5: conditional instruction was optimized away because edx.4!=10

//----- (08048203) --------------------------------------------------------
void __usercall sub_8048203(char *a1@<esi>)
{
  int v1; // ebx
  int v2; // edx
  int v3; // ecx
  char v4; // al
  int v5; // edx
  int v6; // eax
  int v7; // ecx
  int v8; // ecx
  char v9; // al
  int v10; // ebx
  int v11; // [esp-24h] [ebp-24h]

  sub_80480DF((int)byte_80503FF);
  v1 = 0;
  sub_80483BF();
  while ( v2 < 16 )
  {
    if ( !v3 )
    {
      sub_80483BF();
      if ( !v3 )
        break;
    }
    v4 = *a1++;
    --v3;
    byte_80503FF[v2] = v4;
    byte_80503FF[v2++ + 0x8000] = v4;
  }
  while ( v2 )
  {
    sub_8048180(v1, (int)byte_80503FF);
    if ( v5 < *(_DWORD *)&byte_80503FF[426012] )
      *(_DWORD *)&byte_80503FF[426012] = v5;
    if ( *(int *)&byte_80503FF[426012] >= 3 )
    {
      sub_804832B(1, (int)byte_80503FF);
      sub_8048312(*(_DWORD *)&byte_80503FF[426008], 15, (int)byte_80503FF);
      sub_8048312(*(_DWORD *)&byte_80503FF[426012] - 1, 4, (int)byte_80503FF);
    }
    else
    {
      sub_804832B(0, (int)byte_80503FF);
      *(_DWORD *)&byte_80503FF[426012] = 1;
      sub_8048312((unsigned __int8)byte_80503FF[v1], 8, (int)byte_80503FF);
    }
    while ( 1 )
    {
      v6 = *(_DWORD *)&byte_80503FF[426012];
      if ( !v6 )
        break;
      *(_DWORD *)&byte_80503FF[426012] = v6 - 1;
      sub_8048104(((_WORD)v1 + 16) & 0x7FFF, (int)byte_80503FF);
      v11 = v1;
      if ( v7 || (sub_80483BF(), v8) )
      {
        v9 = *a1++;
        v10 = v1 + 16;
        if ( v10 >= 0x8000 )
          byte_80503FF[v10] = v9;
        byte_80503FF[v10 & 0x7FFF] = v9;
      }
      v1 = ((unsigned __int16)sub_804813E(v11, (int)byte_80503FF) + 1) & 0x7FFF;
    }
  }
  sub_804832B(1, (int)byte_80503FF);
  sub_8048312(0, 15, (int)byte_80503FF);
  sub_80483A0((int)byte_80503FF);
}
// 804821B: variable 'v2' is possibly undefined
// 804821F: variable 'v3' is possibly undefined
// 804824E: variable 'v5' is possibly undefined
// 80482C3: variable 'v7' is possibly undefined
// 80482CC: variable 'v8' is possibly undefined

//----- (08048312) --------------------------------------------------------
int __usercall sub_8048312@<eax>(int a1@<eax>, char a2@<cl>, int a3@<edi>)
{
  int i; // ecx
  int result; // eax
  int v6; // ecx

  for ( i = (a2 - 1) & 0x1F; i >= 0; i = v6 - 1 )
    result = sub_804832B(_bittest(&a1, i), a3);
  return result;
}
// 8048326: variable 'v6' is possibly undefined

//----- (0804832B) --------------------------------------------------------
int __usercall __spoils<ecx> sub_804832B@<eax>(char a1@<al>, int a2@<edi>)
{
  int v2; // eax
  _DWORD *v3; // edi
  int v4; // ecx
  int result; // eax
  int v6; // ecx
  int v7; // ecx
  int v8; // eax

  v2 = a1 & 1;
  v3 = (_DWORD *)(a2 - 16396);
  v4 = v3[4097];
  if ( v4 )
  {
    result = v2 << v4;
    v3[4098] |= result;
    --v3[4097];
  }
  else
  {
    v6 = v3[4096];
    v3[v6] = _byteswap_ulong(v3[4098] | v2);
    v7 = ((_WORD)v6 + 1) & 0xFFF;
    if ( !v7 )
    {
      v8 = sys_write(fd, &byte_804C3F3, 0x4000u);
      v7 = 0;
    }
    result = 0;
    v3[4096] = v7;
    v3[4097] = 31;
    v3[4098] = 0;
  }
  return result;
}
// 804C3F3: using guessed type char byte_804C3F3;

//----- (080483A0) --------------------------------------------------------
int __usercall sub_80483A0@<eax>(int a1@<edi>)
{
  int v1; // ebx
  int v2; // edx

  v1 = *(_DWORD *)(a1 - 32784);
  v2 = *(_DWORD *)(a1 - 12);
  *(_DWORD *)(a1 - 16396 + 4 * v2) = *(_DWORD *)(a1 - 4);
  return sys_write(v1, (const void *)(a1 - 16396), 4 * (v2 + 1));
}

//----- (080483BF) --------------------------------------------------------
int sub_80483BF()
{
  return sys_read(dword_80483EB, &byte_80483F3, 0x4000u);
}
// 80483F3: using guessed type char byte_80483F3;

// nfuncs=10 queued=10 decompiled=10 lumina nreq=0 worse=0 better=0
// ALL OK, 10 function(s) have been successfully decompiled
