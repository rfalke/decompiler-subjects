/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
// int __usercall sub_8048106@<eax>(_BYTE *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_804811A; // weak
size_t len; // idb
__int16 word_8048122; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // edi
  int v3; // ebp
  int v4; // eax
  int v5; // eax
  int v6; // eax
  _BYTE *v7; // ecx
  size_t v8; // esi
  int v9; // esi
  int v10; // eax
  int v11; // [esp-10h] [ebp-10h]
  char *v12; // [esp-8h] [ebp-8h]
  _BYTE *v13; // [esp-4h] [ebp-4h]

  len = 0;
  dword_804811A = 10;
  v2 = 0;
  v3 = 0;
  if ( v11 == 1 )
    goto LABEL_13;
  while ( 1 )
  {
    while ( !v12 )
    {
      if ( v3 )
        v5 = sys_exit(v2);
LABEL_13:
      v6 = sys_read(v3, &word_8048122, 0x2000u);
      if ( v6 < 0 )
      {
LABEL_12:
        ++v2;
      }
      else if ( v6 )
      {
        v8 = len;
        if ( (int)len <= 0 )
        {
          v9 = -1;
          while ( ++v9 <= v6 )
          {
            if ( v7[v9] == 10 && !--dword_804811A )
              break;
          }
          v8 = v9 + 1;
        }
        v10 = sys_write(1, v7, v8);
      }
      else
      {
        v4 = sys_close(v3++);
      }
    }
    if ( *(_WORD *)v12 == 28205 )
    {
      dword_804811A = sub_8048106(v13);
    }
    else
    {
      if ( *(_WORD *)v12 != 25389 )
      {
        v3 = sys_open(v12, 0, a2);
        if ( v3 < 0 )
          goto LABEL_12;
        goto LABEL_13;
      }
      len = sub_8048106(v13);
    }
  }
}
// 804806C: positive sp value 10 has been found
// 8048067: variable 'v11' is possibly undefined
// 804806C: variable 'v13' is possibly undefined
// 8048090: variable 'v12' is possibly undefined
// 80480B0: variable 'a2' is possibly undefined
// 80480E4: variable 'v7' is possibly undefined
// 804811A: using guessed type int dword_804811A;
// 8048122: using guessed type __int16 word_8048122;

//----- (08048106) --------------------------------------------------------
int __usercall sub_8048106@<eax>(_BYTE *a1@<esi>)
{
  int v1; // eax
  int i; // ebx

  v1 = 0;
  for ( i = 0; ; i = v1 + 10 * i )
  {
    LOBYTE(v1) = *a1++;
    if ( !(_BYTE)v1 )
      break;
    LOBYTE(v1) = v1 - 48;
  }
  return i;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
