/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
// void __usercall sub_8048120(_BYTE *a1@<esi>);
// void __usercall sub_804813C(_BYTE *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "/etc/passwd"; // idb


//----- (0804804C) --------------------------------------------------------
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // eax
  int v3; // eax
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // edi
  size_t v8; // ecx
  bool v9; // zf
  _BYTE *v10; // esi
  int v11; // eax
  _BYTE *v12; // edi
  _BYTE *v13; // edi
  size_t v14; // eax
  int v15; // eax
  int v16; // eax
  _BYTE *v17; // [esp-4h] [ebp-14h]
  int v18; // [esp+8h] [ebp-8h]
  size_t v19; // [esp+Ch] [ebp-4h]

  __asm { int     80h; LINUX - sys_getuid }
  v2 = sys_open(filename, 0, a2);
  if ( v2 >= 0 )
  {
    v18 = v2;
    v19 = sys_lseek(v2, 0, 2);
    v3 = sys_lseek(v18, 0, 0);
    v4 = sys_brk((void *)(v19 + 134512994));
    MEMORY[0x8048161] = 10;
    v5 = sys_read(v18, (void *)0x8048162, v19);
    v6 = sys_close(v18);
    v7 = 134512993;
    v8 = v19;
    while ( 1 )
    {
      do
      {
        if ( !v8 )
          break;
        v9 = *(_BYTE *)v7++ == 58;
        --v8;
      }
      while ( !v9 );
      do
      {
        if ( !v8 )
          break;
        v9 = *(_BYTE *)v7++ == 58;
        --v8;
      }
      while ( !v9 );
      v10 = (_BYTE *)v7;
      do
      {
        if ( !v8 )
          break;
        v9 = *(_BYTE *)v7++ == 58;
        --v8;
      }
      while ( !v9 );
      *(_BYTE *)--v7 = 0;
      sub_8048120(v10);
      if ( v11 == 24 )
        break;
      do
      {
        if ( !v8 )
          break;
        v9 = *(_BYTE *)v7++ == 10;
        --v8;
      }
      while ( !v9 );
    }
    v12 = v10;
    do
    {
      if ( !v8 )
        break;
      v9 = *v12-- == 10;
      --v8;
    }
    while ( !v9 );
    v13 = v12 + 2;
    v17 = v13;
    do
    {
      if ( !v8 )
        break;
      v9 = *v13++ == 58;
      --v8;
    }
    while ( !v9 );
    *(_WORD *)(v13 - 1) = 10;
    sub_804813C(v17);
    v15 = sys_write(1, v17, v14);
  }
  v16 = sys_exit(0);
}
// 80480D3: variable 'v8' is possibly undefined
// 80480E8: variable 'v11' is possibly undefined
// 8048115: variable 'v14' is possibly undefined

//----- (08048120) --------------------------------------------------------
void __usercall sub_8048120(_BYTE *a1@<esi>)
{
  int v1; // eax
  int v2; // ebx

  v1 = 0;
  v2 = 0;
  while ( *a1 )
  {
    LOBYTE(v2) = *a1 & 0xCF;
    v1 = v2 + 10 * v1;
    ++a1;
  }
}
// 8048120: could not find valid save-restore pair for esi

//----- (0804813C) --------------------------------------------------------
void __usercall sub_804813C(_BYTE *a1@<esi>)
{
  int v1; // ecx
  bool v3; // zf

  v1 = 200;
  do
  {
    if ( !v1 )
      break;
    v3 = *a1++ == 0;
    --v1;
  }
  while ( !v3 );
}
// 804813C: could not find valid save-restore pair for esi

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
