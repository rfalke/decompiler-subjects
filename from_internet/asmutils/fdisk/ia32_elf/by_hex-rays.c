/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
int sub_80481A6();
// int __usercall sub_80481EB@<eax>(int@<edx>, int@<edi>);
// int __usercall sub_80482E2@<eax>(size_t@<edx>, const void *@<ecx>, int@<ebp>);
// int __usercall sub_80483DF@<eax>(unsigned int@<eax>);
// void __usercall sub_80483FF(unsigned int@<eax>, _BYTE *@<edi>);

//-------------------------------------------------------------------------
// Data declarations

char byte_804804C = '\n'; // weak
char byte_8048417 = 'C'; // weak
char byte_8048421[3] = { ' ', 's', 't' }; // weak
char byte_8048427 = 'p'; // weak
char byte_8048431[3] = { 'l', 'i', 'n' }; // weak
char byte_804843F = ' '; // weak
int dword_8048454[2] = { 1935763488, 1211056928 }; // weak
char byte_804845C[3] = { '/', 'S', ' ' }; // weak
int dword_80484A8[15] =
{
  543449410,
  1952671091,
  1931506287,
  1634625385,
  1701999988,
  757080352,
  544162848,
  544501614,
  1768841584,
  1768759395,
  544499815,
  1713399138,
  1802725732,
  1735746080,
  170798638
}; // weak
int fd; // idb
int dword_80484F0; // weak
int dword_80484F4; // weak
char byte_80484F8; // weak
char byte_80484F9; // weak
__int16 word_80484FA; // weak
char byte_8048500; // weak
char byte_8048501[3]; // weak
int dword_8048510[111]; // weak
__int16 word_80486CE; // weak
__int16 word_804870E; // weak


//----- (08048054) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // eax
  char *v3; // ebx
  int v4; // eax
  char *v5; // edx
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // eax
  __int16 *v12; // edi
  int v13; // edx
  int v14; // ebp
  int v15; // eax
  int v16; // edx
  __int16 *v17; // edi
  int v18; // esi
  int v19; // eax
  int v20; // eax
  int v21; // [esp-Ch] [ebp-Ch]
  char *v22; // [esp-4h] [ebp-4h]
  int v23; // [esp-4h] [ebp-4h]
  int v24; // [esp-4h] [ebp-4h]
  int v25; // [esp-4h] [ebp-4h]

  if ( v21 == 2 )
  {
    v3 = v22;
    v4 = sys_open(v22, 0x8000, a2);
    if ( v4 >= 0 )
    {
      v23 = v4;
      v5 = v3;
      while ( *v5++ != 0 )
        ;
      v7 = sys_write(1, v3, v5 - v3 - 1);
      v8 = sys_ioctl(v23, 769);
      v9 = sys_write(1, dword_8048454, 0xBu);
      sub_80481A6();
      v10 = sys_write(1, &byte_804804C, 1u);
      v11 = sys_read(v23, dword_8048510, 0x200u);
      fd = v23;
      v12 = &word_80486CE;
      v13 = 0;
      do
      {
        v24 = v13;
        sub_80481EB(v13, (int)v12);
        v13 = v24;
        LOBYTE(v13) = v24 + 1;
        v12 += 8;
      }
      while ( v12 != &word_804870E );
      v14 = v13;
      if ( dword_80484F0 )
      {
        dword_80484F4 = dword_80484F0;
        do
        {
          __asm { int     80h; LINUX - sys_llseek }
          v15 = sys_read(fd, dword_8048510, 0x200u);
          v16 = v14;
          v17 = &word_80486CE;
          v18 = 0;
          do
          {
            if ( *((_BYTE *)v17 + 4) == 5 || *((_BYTE *)v17 + 4) == 15 || *((_BYTE *)v17 + 4) == 0x85 )
            {
              ++v18;
              dword_80484F4 = dword_80484F0 + *((_DWORD *)v17 + 2);
              v16 = dword_80484F4 << 9;
            }
            else if ( *((_BYTE *)v17 + 4) )
            {
              v25 = v16;
              sub_80481EB(v16, (int)v17);
              v16 = v25;
              LOBYTE(v16) = v25 + 1;
              v14 = v16;
            }
            v17 += 8;
          }
          while ( v17 != &word_804870E );
        }
        while ( v18 );
      }
      v19 = sys_close(fd);
      v20 = sys_exit(0);
    }
  }
  v2 = sys_exit(0);
}
// 804804D: positive sp value C has been found
// 8048058: variable 'v21' is possibly undefined
// 804805B: variable 'v22' is possibly undefined
// 804804C: using guessed type char byte_804804C;
// 8048454: using guessed type int dword_8048454[2];
// 80484F0: using guessed type int dword_80484F0;
// 80484F4: using guessed type int dword_80484F4;
// 8048510: using guessed type int dword_8048510[111];
// 80486CE: using guessed type __int16 word_80486CE;
// 804870E: using guessed type __int16 word_804870E;

//----- (080481A6) --------------------------------------------------------
int sub_80481A6()
{
  int v0; // eax
  int v1; // eax

  sub_80483DF((unsigned __int16)word_80484FA);
  v0 = sys_write(1, byte_804845C, 1u);
  sub_80483DF((unsigned __int8)byte_80484F8);
  v1 = sys_write(1, byte_804845C, 1u);
  return sub_80483DF((unsigned __int8)byte_80484F9);
}
// 80484F8: using guessed type char byte_80484F8;
// 80484F9: using guessed type char byte_80484F9;
// 80484FA: using guessed type __int16 word_80484FA;

//----- (080481EB) --------------------------------------------------------
int __usercall sub_80481EB@<eax>(int a1@<edx>, int a2@<edi>)
{
  int v2; // eax
  int v3; // eax
  int v5; // eax
  int result; // eax

  if ( word_804870E != 21930 && word_804870E != -21931 )
  {
    v2 = sys_write(1, dword_80484A8, 0x3Cu);
    v3 = sys_exit(255);
  }
  v5 = sys_write(1, &byte_8048427, 0xAu);
  result = sub_80483DF(a1 + 1);
  if ( *(_BYTE *)(a2 + 4) != 6
    && *(_BYTE *)(a2 + 4) != 11
    && *(_BYTE *)(a2 + 4) != 12
    && *(_BYTE *)(a2 + 4) != 0xA5
    && *(_BYTE *)(a2 + 4) != 0xA6
    && *(_BYTE *)(a2 + 4) != 0x82
    && *(_BYTE *)(a2 + 4) != 0x83
    && *(_BYTE *)(a2 + 4)
    && (*(_BYTE *)(a2 + 4) == 5 || *(_BYTE *)(a2 + 4) == 15 || *(_BYTE *)(a2 + 4) == 0x85) )
  {
    result = *(_DWORD *)(a2 + 8);
    dword_80484F0 = result;
  }
  return result;
}
// 8048427: using guessed type char byte_8048427;
// 80484A8: using guessed type int dword_80484A8[15];
// 80484F0: using guessed type int dword_80484F0;
// 804870E: using guessed type __int16 word_804870E;

//----- (080482E2) --------------------------------------------------------
int __usercall sub_80482E2@<eax>(size_t a1@<edx>, const void *a2@<ecx>, int a3@<ebp>)
{
  int v3; // eax
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax

  v3 = sys_write(1, a2, a1);
  if ( *(_BYTE *)(a3 + 4) )
  {
    if ( *(_BYTE *)a3 == 0x80 )
      v4 = sys_write(1, &byte_804843F, 0x15u);
    v5 = sys_write(1, &byte_804804C, 1u);
    v6 = sys_write(1, &byte_8048417, 0xAu);
    byte_80484F8 = *(_BYTE *)(a3 + 1);
    byte_80484F9 = *(_BYTE *)(a3 + 2) & 0x3F;
    BYTE1(v6) = *(_BYTE *)(a3 + 2) >> 6;
    LOBYTE(v6) = *(_BYTE *)(a3 + 3);
    word_80484FA = v6;
    sub_80481A6();
    v7 = sys_write(1, byte_8048421, 6u);
    byte_80484F8 = *(_BYTE *)(a3 + 5);
    byte_80484F9 = *(_BYTE *)(a3 + 6) & 0x3F;
    BYTE1(v7) = *(_BYTE *)(a3 + 6) >> 6;
    LOBYTE(v7) = *(_BYTE *)(a3 + 7);
    word_80484FA = v7;
    sub_80481A6();
    v8 = sys_write(1, &byte_804804C, 1u);
    v9 = sys_write(1, byte_8048431, 0xEu);
    sub_80483DF(dword_80484F4 + *(_DWORD *)(a3 + 8));
    v10 = sys_write(1, byte_804845C, 1u);
    sub_80483DF(*(_DWORD *)(a3 + 12));
  }
  return sys_write(1, &byte_804804C, 1u);
}
// 804804C: using guessed type char byte_804804C;
// 8048417: using guessed type char byte_8048417;
// 804843F: using guessed type char byte_804843F;
// 80484F4: using guessed type int dword_80484F4;
// 80484F8: using guessed type char byte_80484F8;
// 80484F9: using guessed type char byte_80484F9;
// 80484FA: using guessed type __int16 word_80484FA;

//----- (080483DF) --------------------------------------------------------
int __usercall sub_80483DF@<eax>(unsigned int a1@<eax>)
{
  sub_80483FF(a1, &byte_8048500);
  return sys_write(1, &byte_8048500, &byte_8048500 - byte_8048501);
}
// 8048500: using guessed type char byte_8048500;

//----- (080483FF) --------------------------------------------------------
void __usercall sub_80483FF(unsigned int a1@<eax>, _BYTE *a2@<edi>)
{
  unsigned int v2; // et2
  char v3; // dl

  do
  {
    v2 = a1 % 0xA;
    a1 /= 0xAu;
    v3 = v2 | 0x30;
  }
  while ( a1 );
  while ( 1 )
    *a2++ = v3;
}
// 8048414: conditional instruction was optimized away because dl.1>=30u

// nfuncs=6 queued=6 decompiled=6 lumina nreq=0 worse=0 better=0
// ALL OK, 6 function(s) have been successfully decompiled
