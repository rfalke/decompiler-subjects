/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

char __fastcall sub_804806A(int a1, mode_t a2);
char __fastcall sub_8048070(int, mode_t);
// void __usercall __noreturn start(int@<edi>, int, char);

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "/etc/issue"; // idb
char directory[] = "/dev"; // idb
char file[] = "/bin/login"; // idb
char asc_8048067[3] = "--"; // weak
char *dword_804826B; // idb
const char **envp; // idb
struct utsname utsbuf; // idb
char byte_80483F9[3]; // weak


//----- (0804806A) --------------------------------------------------------
char __fastcall sub_804806A(int a1, mode_t a2)
{
  return sub_8048070(a1, a2);
}

//----- (08048070) --------------------------------------------------------
char __fastcall sub_8048070(int a1, mode_t a2)
{
  char *v2; // edi
  int v3; // eax
  int v4; // eax
  int v5; // esi
  char v6; // al
  struct utsname *nodename; // eax
  struct utsname *v8; // esi
  char v9; // al
  int v10; // eax
  int v11; // eax
  char *v12; // esi
  char result; // al
  char *v14; // edi
  int v15; // [esp-10h] [ebp-10h]
  int v16; // [esp-8h] [ebp-8h]
  int v17; // [esp-4h] [ebp-4h]

  v2 = byte_80483F9;
  v3 = sys_open(filename, 0, a2);
  if ( v3 >= 0 )
  {
    v17 = v3;
    v4 = sys_lseek(v3, 0, 2);
    if ( v4 >= 0 )
    {
      v16 = v4;
      __asm { int     80h; LINUX - sys_mmap2 }
      v5 = 192;
      byte_80483F9[0] = 10;
      v2 = &byte_80483F9[1];
      while ( 1 )
      {
        v6 = *(_BYTE *)v5++;
        if ( !v6 )
        {
          v10 = sys_munmap((void *)0xC0, v16);
          v11 = sys_close(v17);
          break;
        }
        if ( v6 != 92 )
          goto LABEL_23;
        v6 = *(_BYTE *)v5++;
        switch ( v6 )
        {
          case 's':
            nodename = &utsbuf;
LABEL_20:
            v15 = v5;
            v8 = nodename;
            do
            {
              v9 = v8->sysname[0];
              v8 = (struct utsname *)((char *)v8 + 1);
              *v2++ = v9;
            }
            while ( v9 );
            --v2;
            v5 = v15;
            break;
          case 'n':
            nodename = (struct utsname *)utsbuf.nodename;
            goto LABEL_20;
          case 'm':
            nodename = (struct utsname *)utsbuf.machine;
            goto LABEL_20;
          case 'o':
            nodename = (struct utsname *)utsbuf.__domainname;
            goto LABEL_20;
          case 'r':
            nodename = (struct utsname *)utsbuf.release;
            goto LABEL_20;
          case 'v':
            nodename = (struct utsname *)utsbuf.version;
            goto LABEL_20;
          case 'l':
            nodename = (struct utsname *)dword_804826B;
            goto LABEL_20;
          default:
LABEL_23:
            *v2++ = v6;
            break;
        }
      }
    }
  }
  v12 = utsbuf.nodename;
  do
  {
    result = *v12++;
    *v2++ = result;
  }
  while ( result );
  v14 = v2 - 1;
  *(_DWORD *)v14 = 1735355424;
  *((_DWORD *)v14 + 1) = 540700265;
  return result;
}

//----- (08048164) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(int a1@<edi>, int a2, char a3)
{
  int v3; // eax
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // eax
  mode_t v8; // edx
  int v9; // eax
  int v10; // eax
  int v11; // eax
  int v12; // eax
  int v13; // eax
  mode_t v14; // edx
  int v15; // ecx
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // eax
  char *v20; // [esp-10h] [ebp-10h] BYREF
  char *v21; // [esp-Ch] [ebp-Ch]
  char *v22; // [esp-8h] [ebp-8h]
  char *v23; // [esp-4h] [ebp-4h] BYREF

  envp = (const char **)&(&v23)[(_DWORD)v21];
  if ( v21 != (char *)1 )
  {
    dword_804826B = v23;
    v3 = sys_newuname(&utsbuf);
    __asm
    {
      int     80h; LINUX - sys_signal
      int     80h; LINUX - sys_vhangup
    }
    v4 = sys_close(0);
    v5 = sys_close(1);
    v6 = sys_close(2);
    v7 = sys_chdir(directory);
    v9 = sys_open(dword_804826B, 2, v8);
    if ( v9 >= 0 && !v9 )
    {
      v10 = sys_dup(0);
      v11 = sys_dup(0);
      v12 = sys_fchmod(0, 0x258u);
      v13 = sys_write(1, sub_804806A, 6u);
      sub_8048070(v15, v14);
      v16 = sys_write(1, byte_80483F9, a1 - (_DWORD)byte_80483F9);
      __asm { int     80h; LINUX - sys_setsid }
      v17 = sys_read(0, byte_80483F9, 0x200u);
      if ( v17 >= 0 )
      {
        *(_BYTE *)(v17 + 134513656) = 0;
        v23 = 0;
        v22 = byte_80483F9;
        v21 = asc_8048067;
        v20 = file;
        v18 = sys_execve(file, (const char **)&v20, envp);
      }
    }
  }
  v19 = sys_exit(0);
}
// 804817C: positive sp value C has been found
// 80481C3: variable 'v8' is possibly undefined
// 80481FD: variable 'v15' is possibly undefined
// 80481FD: variable 'v14' is possibly undefined

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
