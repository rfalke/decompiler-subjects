/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(off_t@<edi>);
void __cdecl sub_80482B7(int a1);
int *__cdecl sub_8048329(int, unsigned int);
void __cdecl sub_80483DE(int *a1, _DWORD *a2);
void __cdecl sub_8048460(_DWORD *a1, int *a2);
// void __usercall sub_80486AF(int a1@<ecx>, int a2@<edi>, int a3@<eax>, int a4@<edx>);
void sub_80487A5();
// void __usercall sub_80487FC(unsigned int a1@<ecx>, int a2@<esi>, int a3@<eax>);
// void __usercall sub_8048826(int *@<edi>);

//-------------------------------------------------------------------------
// Data declarations

char aCopyrightC1999[175] = "Copyright (c) 1999-2000 Cecchinel Stephan\nUsage:\trc6crypt e|d KEY FILE...\n\te - encrypt\n\td - decrypt\n\tKEY is an ascii string of unlimited lenght\nAn error occured..\n/dev/random"; // weak
void *off_80484E2 = &loc_8048672; // weak
int dword_80488A0[5]; // weak
int dword_80488B4; // weak
int dword_80488B8; // weak
int dword_80488BC[416]; // weak
int dword_8048F3C[8192]; // weak
int dword_8050F3C[42]; // weak
int dword_8050FE4[3]; // weak
int dword_8050FF0[9]; // weak
int dword_8051014[2048]; // weak
int dword_8053014[2048]; // weak
char byte_8055014; // weak
int dword_8055015; // weak
char byte_8055019[3]; // weak
char byte_805502D[3]; // weak
char byte_8055041[3]; // weak


//----- (080480FB) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(off_t a1@<edi>)
{
  int *v1; // esi
  int v2; // eax
  int v3; // eax
  char v4; // al
  mode_t v5; // edx
  int v6; // ebp
  int v7; // eax
  int v8; // eax
  int *v9; // esi
  int *v10; // edi
  int v11; // eax
  int v12; // edx
  int v13; // ecx
  int v14; // edx
  size_t v15; // esi
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // eax
  int v20; // eax
  int v21; // eax
  mode_t v22; // edx
  int v23; // eax
  int v24; // eax
  int v25; // eax
  int v26; // eax
  int v27; // [esp-20h] [ebp-20h]
  unsigned int v28; // [esp-14h] [ebp-14h]
  char *v29; // [esp-Ch] [ebp-Ch]
  int v30; // [esp-8h] [ebp-8h]
  off_t v31; // [esp-8h] [ebp-8h]
  char *v32; // [esp-4h] [ebp-4h]

  v1 = (int *)v28;
  if ( v28 >= 4 )
  {
    v4 = *v29;
    byte_8055014 = v4;
    if ( v4 == 100 || v4 == 101 )
    {
      sub_80482B7(v30);
      sub_8048329((int)byte_8055041, 0x100u);
      while ( 1 )
      {
        do
        {
          if ( !v32 )
            goto LABEL_3;
          v6 = sys_open(v32, 2, v5);
        }
        while ( v6 < 0 );
        dword_8055015 = 0;
        do
        {
          v7 = sys_read(v6, dword_8051014, 0x2000u);
          if ( v7 < 0 )
          {
            v8 = sys_write(1, &aCopyrightC1999[144], 0x13u);
LABEL_3:
            v3 = sys_exit(0);
          }
          if ( v7 )
          {
            v32 = (char *)v1;
            v31 = a1;
            v27 = v7;
            if ( (unsigned int)v7 >> 4 )
            {
              v9 = dword_8051014;
              v10 = dword_8053014;
              do
              {
                if ( byte_8055014 == 100 )
                  sub_8048460(v9, v10);
                else
                  sub_80483DE(v9, v10);
                v9 += 4;
                v10 += 4;
              }
              while ( v13 != 1 );
              v14 = 16 * v12;
              dword_8055015 += v14;
              v15 = v14;
              v16 = sys_lseek(v6, -v11, 1);
              v17 = sys_write(v6, dword_8053014, v15);
            }
            v7 = v27;
            a1 = v31;
            v1 = (int *)v32;
          }
        }
        while ( v7 == 0x2000 );
        if ( byte_8055014 == 101 )
        {
          v19 = v7 & 0xF;
          if ( v19 )
          {
            dword_8055015 += v19;
            a1 = v19;
            v20 = sys_read(v6, dword_8051014, v19);
            v21 = sys_lseek(v6, -a1, 1);
            v23 = sys_read(sys_open(&aCopyrightC1999[163], 0, v22), (char *)dword_8051014 + a1, 16 - a1);
            sub_80483DE(dword_8051014, dword_8053014);
            v24 = sys_write(v6, dword_8053014, 0x10u);
          }
          v1 = dword_8053014;
          dword_8053014[0] = dword_8055015;
          v25 = sys_write(v6, dword_8053014, 4u);
        }
        else
        {
          v1 = dword_8051014;
          a1 = *(int *)((char *)dword_8051014 + (v7 & 0xFFFFFFF0));
          v18 = sys_ftruncate(v6, a1);
        }
        v26 = sys_close(v6);
      }
    }
  }
  v2 = sys_write(1, aCopyrightC1999, 0x90u);
  goto LABEL_3;
}
// 8048147: positive sp value 14 has been found
// 80480FB: variable 'v28' is possibly undefined
// 804811B: variable 'v29' is possibly undefined
// 804812C: variable 'v30' is possibly undefined
// 8048149: variable 'v32' is possibly undefined
// 8048151: variable 'v5' is possibly undefined
// 80481C6: variable 'v13' is possibly undefined
// 80481C8: variable 'v12' is possibly undefined
// 80481DB: variable 'v11' is possibly undefined
// 804825C: variable 'v22' is possibly undefined
// 8051014: using guessed type int dword_8051014[2048];
// 8053014: using guessed type int dword_8053014[2048];
// 8055014: using guessed type char byte_8055014;
// 8055015: using guessed type int dword_8055015;

//----- (080482B7) --------------------------------------------------------
void __cdecl sub_80482B7(int a1)
{
  int v1; // ecx
  unsigned int v3; // ecx
  int v4; // eax
  int v5; // eax
  unsigned int v6; // ecx
  unsigned int v7; // ebx
  char v8; // dl

  v1 = 0;
  while ( *(_BYTE *)(a1 + v1++) != 0 )
    ;
  sub_80487A5();
  sub_80487FC(v3 >> 1, a1, v4);
  sub_8048826((int *)byte_8055019);
  sub_80487A5();
  v7 = v6;
  if ( (v8 & 1) != 0 )
    ++v6;
  sub_80487FC(v6, a1 + v7, v5);
  sub_8048826((int *)byte_805502D);
  *(_DWORD *)byte_8055041 = *(_DWORD *)byte_8055019;
  *(_DWORD *)&byte_8055041[4] = *(_DWORD *)&byte_8055019[4];
  *(_DWORD *)&byte_8055041[8] = *(_DWORD *)&byte_8055019[8];
  *(_DWORD *)&byte_8055041[12] = *(_DWORD *)&byte_8055019[20] ^ *(_DWORD *)&byte_8055019[12];
  *(_DWORD *)&byte_8055041[16] = *(_DWORD *)&byte_8055019[24] ^ *(_DWORD *)&byte_8055019[16];
  *(_DWORD *)&byte_8055041[20] = *(_DWORD *)&byte_8055019[28];
  *(_DWORD *)&byte_8055041[24] = *(_DWORD *)&byte_8055019[32];
  *(_DWORD *)&byte_8055041[28] = *(_DWORD *)&byte_8055019[36];
}
// 80482CF: variable 'v3' is possibly undefined
// 80482D3: variable 'v4' is possibly undefined
// 80482EB: variable 'v6' is possibly undefined
// 80482ED: variable 'v8' is possibly undefined
// 80482F9: variable 'v5' is possibly undefined

//----- (08048329) --------------------------------------------------------
int *__cdecl sub_8048329(int a1, unsigned int a2)
{
  unsigned int i; // ecx
  unsigned int v3; // ecx
  unsigned int v4; // edx
  unsigned int v5; // edx
  int v6; // ecx
  int v7; // eax
  int v8; // eax
  int v10; // [esp-4h] [ebp-14h]
  int v11; // [esp+0h] [ebp-10h]
  int v12; // [esp+4h] [ebp-Ch]
  int v13; // [esp+8h] [ebp-8h]
  int v14; // [esp+Ch] [ebp-4h]

  dword_8050F3C[0] = -1209970333;
  for ( i = 1; i < 0x2C; ++i )
    dword_8050F3C[i] = dword_8050F3C[i - 1] - 1640531527;
  v3 = 0;
  v4 = a2 >> 5;
  do
  {
    dword_8050F3C[v3] = *(_DWORD *)(a1 + 4 * v3);
    ++v3;
  }
  while ( v3 < v4 );
  v5 = v4 - 1;
  v6 = 0;
  v14 = 0;
  v13 = 0;
  v12 = 0;
  v11 = 0;
  do
  {
    v10 = v6;
    v14 = __ROL4__(v13 + v14 + dword_8050F3C[v12], 3);
    v13 = __ROL4__(v14 + v13 + dword_8050FF0[v11], v14 + v13);
    dword_8050F3C[v12] = v14;
    dword_8050FF0[v11] = v13;
    v7 = v12 + 1;
    if ( v12 == 42 )
      v7 = 0;
    v12 = v7;
    v8 = v11 + 1;
    if ( v11 + 1 == v5 )
      v8 = 0;
    v11 = v8;
    ++v6;
  }
  while ( (unsigned int)(v10 + 1) < 0x84 );
  return dword_8050F3C;
}
// 8048329: could not find valid save-restore pair for ebx
// 8050F3C: using guessed type int dword_8050F3C[42];
// 8050FF0: using guessed type int dword_8050FF0[9];

//----- (080483DE) --------------------------------------------------------
void __cdecl sub_80483DE(int *a1, _DWORD *a2)
{
  int v2; // eax
  int v3; // ebx
  int v4; // ecx
  int v5; // edx
  int v6; // esi
  int v7; // edi
  int v8; // [esp-28h] [ebp-28h]
  int vars0; // [esp+0h] [ebp+0h] BYREF
  char *retaddr; // [esp+4h] [ebp+4h]

  v2 = *a1;
  v3 = dword_8050F3C[0] + a1[1];
  v4 = a1[2];
  v5 = dword_8050F3C[1] + a1[3];
  do
  {
    v6 = __ROL4__(v5 * (2 * v5 + 1), 5);
    v7 = __ROL4__(v3 * (2 * v3 + 1), 5);
    v8 = vars0 + __ROL4__(v7 ^ v2, v6);
    v2 = v3;
    v3 = (int)&retaddr[__ROL4__(v6 ^ v4, v7)];
    v4 = v5;
    v5 = v8;
  }
  while ( &vars0 != dword_8050FE4 );
  *a2 = dword_8050F3C[42] + v2;
  a2[1] = v3;
  a2[2] = dword_8050F3C[43] + v4;
  a2[3] = v8;
}
// 8050F3C: using guessed type int dword_8050F3C[42];
// 8050FE4: using guessed type int dword_8050FE4[3];

//----- (08048460) --------------------------------------------------------
void __cdecl sub_8048460(_DWORD *a1, int *a2)
{
  int v2; // edx
  int v3; // ecx
  int v4; // ebx
  int v5; // eax
  int v6; // ecx
  int v7; // esi
  int v8; // edi
  int v9; // [esp-28h] [ebp-28h]
  int vars0; // [esp+0h] [ebp+0h] BYREF
  void *retaddr; // [esp+4h] [ebp+4h]

  v2 = a1[3];
  v3 = a1[2] - dword_8050F3C[43];
  v4 = a1[1];
  v5 = *a1 - dword_8050F3C[42];
  do
  {
    v9 = v2;
    v2 = v3;
    v6 = v4;
    v4 = v5;
    v7 = __ROL4__(v2 * (2 * v2 + 1), 5);
    v8 = __ROL4__(v4 * (2 * v4 + 1), 5);
    v3 = v7 ^ __ROR4__(v6 - (_DWORD)retaddr, v8);
    v5 = v8 ^ __ROR4__(v9 - vars0, v7);
  }
  while ( &vars0 != dword_8050F3C );
  a2[3] = v2 - (_DWORD)retaddr;
  a2[2] = v3;
  a2[1] = v4 - vars0;
  *a2 = v5;
}
// 8050F3C: using guessed type int dword_8050F3C[42];

//----- (080486AF) --------------------------------------------------------
void __usercall sub_80486AF(int a1@<ecx>, int a2@<edi>, int a3@<eax>, int a4@<edx>)
{
  _DWORD *v4; // ebp
  int *v5; // esi
  int v6; // ecx
  int v7; // ecx
  _DWORD *v8; // ebp
  int v9; // [esp-54h] [ebp-54h]
  int v10; // [esp-50h] [ebp-50h]
  int v11; // [esp-4Ch] [ebp-4Ch]
  _BYTE v12[20]; // [esp-48h] [ebp-48h] BYREF
  _BYTE v13[20]; // [esp-34h] [ebp-34h] BYREF
  _DWORD v14[8]; // [esp-20h] [ebp-20h] BYREF
  void *retaddr; // [esp+0h] [ebp+0h] BYREF

  v14[6] = a2;
  v14[4] = &retaddr;
  v14[2] = a1;
  v14[1] = a4;
  v14[0] = a3;
  v4 = v14;
  v11 = a2;
  v9 = 5;
  qmemcpy(v12, dword_80488A0, sizeof(v12));
  qmemcpy(v13, dword_80488A0, sizeof(v13));
  v5 = &dword_80488A0[23];
  v6 = 2;
  do
  {
    v11 = v6;
    v7 = 16;
    do
    {
      v10 = v7;
      *(v4 - 10) = *(v4 - 6) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 8), *(v4 - 7));
      *(v4 - 8) = __ROL4__(*(v4 - 8), 10);
      *(v4 - 6) = *(v4 - 7) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 9), *(v4 - 8));
      *(v4 - 9) = __ROL4__(*(v4 - 9), 10);
      *(v4 - 7) = *(v4 - 8) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 10), *(v4 - 9));
      *(v4 - 10) = __ROL4__(*(v4 - 10), 10);
      *(v4 - 8) = *(v4 - 9) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 6), *(v4 - 10));
      *(v4 - 6) = __ROL4__(*(v4 - 6), 10);
      *(v4 - 9) = *(v4 - 10) + ((int (__fastcall *)(_DWORD, _DWORD))*v5)(*(v4 - 7), *(v4 - 6));
      *(v4 - 7) = __ROL4__(*(v4 - 7), 10);
      v7 = v10 - 1;
    }
    while ( v10 != 1 );
    v4 += 5;
    v6 = v11 - 1;
  }
  while ( v11 != 1 );
  v8 = v4 - 10;
  v11 = dword_80488A0[1] + *(v8 - 8) + *(v8 - 2);
  dword_80488A0[1] = dword_80488A0[2] + *(v8 - 7) + *(v8 - 1);
  dword_80488A0[2] = dword_80488A0[3] + *(v8 - 6) + *(v8 - 5);
  dword_80488A0[3] = dword_80488A0[4] + *(v8 - 10) + *(v8 - 4);
  dword_80488A0[4] = dword_80488A0[0] + *(v8 - 9) + *(v8 - 3);
  dword_80488A0[0] = v11;
}
// 80486AF: could not find valid save-restore pair for edi
// 80488A0: using guessed type int dword_80488A0[5];

//----- (080487A5) --------------------------------------------------------
void sub_80487A5()
{
  int *v0; // edi
  void **v1; // esi
  int v2; // ecx
  void *v3; // ebx
  void *v4; // edx
  int v5; // ecx
  __int16 v6; // ax
  int v7; // [esp-24h] [ebp-24h]

  dword_80488A0[0] = 1732584193;
  dword_80488A0[1] = -271733879;
  dword_80488A0[2] = -1732584194;
  dword_80488A0[3] = 271733878;
  dword_80488A0[4] = -1009589776;
  dword_80488A0[5] = 0;
  dword_80488A0[6] = 0;
  memset(&dword_80488A0[7], 0, 0x40u);
  v0 = &dword_80488A0[23];
  v1 = &off_80484E2;
  v2 = 10;
  do
  {
    v7 = v2;
    v3 = *v1;
    v4 = v1[1];
    v1 += 2;
    v5 = 16;
    do
    {
      v6 = *(_WORD *)v1;
      v1 = (void **)((char *)v1 + 2);
      *v0 = (int)v3;
      v0[1] = (int)v4;
      *((_WORD *)v0 + 4) = v6;
      v0 = (int *)((char *)v0 + 10);
      --v5;
    }
    while ( v5 );
    v2 = v7 - 1;
  }
  while ( v7 != 1 );
}
// 80484E2: using guessed type void *off_80484E2;
// 80488A0: using guessed type int dword_80488A0[5];

//----- (080487FC) --------------------------------------------------------
void __usercall sub_80487FC(unsigned int a1@<ecx>, int a2@<esi>, int a3@<eax>)
{
  int v4; // edx
  int i; // ecx
  int v6; // ecx
  int v7; // eax

  v4 = a1;
  for ( i = a1 >> 6; i; i = v6 - 1 )
  {
    sub_80486AF(i, a2, a3, v4);
    a2 += 64;
  }
  v7 = v4 + dword_80488B4;
  if ( v4 + dword_80488B4 < dword_80488B4 )
    ++*(&dword_80488B4 + 1);
  dword_80488B4 = v7;
}
// 8048806: variable 'a3' is possibly undefined
// 8048806: variable 'v4' is possibly undefined
// 804880E: variable 'v6' is possibly undefined
// 80488B4: using guessed type int dword_80488B4;

//----- (08048826) --------------------------------------------------------
void __usercall sub_8048826(int *a1@<edi>)
{
  unsigned int v1; // edx
  char v2; // bl
  char v3; // cl
  int v4; // edx
  int v5; // ecx
  int v6; // eax
  int v7; // [esp-28h] [ebp-28h]

  v7 = dword_80488B4;
  v1 = dword_80488B4;
  qmemcpy(dword_80488BC, (char *)dword_8048F3C + (dword_80488B4 & 0x1FC0), dword_80488B4 & 0x3F);
  v2 = v1;
  v3 = v1;
  v4 = (v1 >> 2) & 0xF;
  v5 = 8 * (v3 & 3) + 7;
  dword_80488BC[v4] ^= 1 << v5;
  if ( (v2 & 0x3Fu) > 0x37 )
  {
    sub_80486AF(v5, (int)dword_80488BC, 1 << v5, v4);
    memset(dword_80488BC, 0, 0x40u);
    v5 = 0;
  }
  dword_80488BC[14] = 8 * v7;
  v6 = (unsigned int)dword_80488B8 >> 29;
  dword_80488BC[15] = (unsigned int)dword_80488B8 >> 29;
  sub_80486AF(v5, (int)dword_80488BC, v6, v4);
  qmemcpy(a1, dword_80488A0, 0x14u);
}
// 8048826: could not find valid save-restore pair for edi
// 804888E: variable 'v4' is possibly undefined
// 80488A0: using guessed type int dword_80488A0[5];
// 80488B4: using guessed type int dword_80488B4;
// 80488B8: using guessed type int dword_80488B8;
// 80488BC: using guessed type int dword_80488BC[416];
// 8048F3C: using guessed type int dword_8048F3C[8192];

// nfuncs=9 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
