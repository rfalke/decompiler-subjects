/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void start();
// void __usercall sub_8048144(char *@<edi>, char *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_80480A0[3] = { 1852534357, 544110447, 1769238639 }; // weak
char directory[] = "/proc/sys/"; // idb
char filename[] = "/etc/sysctl.conf"; // idb
char aCouldNotWriteT[24] = "Could not write to key\n"; // weak
char addr[61440]; // idb


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void start()
{
  int v0; // eax
  mode_t v1; // edx
  int i; // ebp
  char *v3; // esi
  char v4; // al
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // esi
  char v9; // al
  char v10; // al
  int v11; // eax
  char *v12; // esi
  char *v13; // edi
  char v14; // al
  int v15; // eax
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // eax
  int v20; // [esp-10h] [ebp-10h]
  char *v21; // [esp-8h] [ebp-8h]
  char *v22; // [esp-4h] [ebp-4h]

  if ( v20 == 1 )
    goto LABEL_35;
  v0 = sys_chdir(directory);
  for ( i = 0; ; ++i )
  {
    if ( !v21 )
      goto LABEL_35;
    v3 = v21 + 1;
    if ( *v21 != 45 )
    {
      v12 = v21;
      v13 = addr;
      do
      {
        while ( 1 )
        {
          v14 = *v12++;
          if ( v14 != 46 )
            break;
          *v13++ = 47;
        }
        *v13++ = v14;
      }
      while ( v14 );
      v15 = sys_open(addr, 0, v1);
      if ( v15 >= 0 )
      {
        v16 = sys_write(1, addr, sys_read(v15, addr, 0xF000u));
        v17 = sys_exit(0);
      }
      goto LABEL_34;
    }
    v4 = *v3;
    if ( *v3 != 110 )
      break;
  }
  if ( v4 != 119 )
  {
    if ( v4 != 112 )
    {
      v5 = sys_write(1, dword_80480A0, 0xFu);
      v6 = sys_exit(1);
    }
    if ( v22 )
      v7 = sys_open(v22, 0, v1);
    else
      v7 = sys_open(filename, 0, v1);
    if ( sys_lseek(v7, 0, 2) >= 0 )
    {
      __asm { int     80h; LINUX - sys_mmap2 }
      v8 = 192;
LABEL_15:
      while ( 2 )
      {
        while ( 1 )
        {
          v9 = *(_BYTE *)v8++;
          if ( v9 == 59 || v9 == 35 )
            break;
          if ( !v9 )
            v11 = sys_exit(0);
          if ( v9 > 32 )
            goto LABEL_23;
        }
        while ( 1 )
        {
          v10 = *(_BYTE *)v8++;
          if ( !v10 )
            break;
          if ( v10 == 10 )
            goto LABEL_15;
        }
LABEL_23:
        sub_8048144(addr, (char *)--v8);
        continue;
      }
    }
LABEL_34:
    v18 = sys_exit(1);
  }
  if ( !v22 )
LABEL_35:
    v19 = sys_exit(255);
  sub_8048144(addr, v22);
}
// 80480B3: positive sp value 10 has been found
// 804804C: could not find valid save-restore pair for esi
// 804804E: variable 'v20' is possibly undefined
// 8048064: variable 'v21' is possibly undefined
// 80480B5: variable 'v22' is possibly undefined
// 80480BE: variable 'v1' is possibly undefined
// 80480A0: using guessed type int dword_80480A0[3];

//----- (08048144) --------------------------------------------------------
void __usercall sub_8048144(char *a1@<edi>, char *a2@<esi>)
{
  char v2; // al
  char *v3; // esi
  char *v4; // edi
  char v5; // al
  char v6; // al
  char *v7; // esi
  char *v8; // ecx
  mode_t v9; // edx
  char v10; // al
  int v11; // eax
  int v12; // edx
  int v13; // eax
  char *v14; // [esp-4h] [ebp-4h]

  while ( 1 )
  {
    while ( 1 )
    {
      v2 = *a2++;
      if ( v2 != 46 )
        break;
      *a1++ = 47;
    }
    if ( v2 == 61 || v2 <= 32 )
      break;
    *a1++ = v2;
  }
  v3 = a2 - 1;
  *a1 = 0;
  v4 = a1 + 1;
  do
  {
    v5 = *v3++;
    if ( !v5 )
      goto LABEL_18;
  }
  while ( v5 != 61 );
  do
    v6 = *v3++;
  while ( v6 <= 32 );
  v7 = v3 - 1;
  v8 = v4;
  v9 = 0;
  while ( 1 )
  {
    v10 = *v7++;
    ++v9;
    if ( v10 <= 32 || v10 == 59 || v10 == 35 )
      break;
    *v4++ = v10;
  }
  *v4 = 0;
  v14 = v8;
  v11 = sys_open(addr, 2, v9);
  if ( v11 < 0 )
    v11 = sys_write(1, aCouldNotWriteT, 0x18u);
  v13 = sys_write(v11, v14, v12 - 1);
LABEL_18:
  JUMPOUT(0x8048061);
}
// 8048156: control flows out of bounds to 8048086
// 80481BC: control flows out of bounds to 8048061
// 8048154: conditional instruction was optimized away because al.1 is in (21..2D|2F..3C|>=3E)
// 80481B4: variable 'v12' is possibly undefined

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
