/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
// void __usercall sub_8048160(_WORD *a1@<edi>);
void __fastcall sub_80481FE(int a1, mode_t a2);
void sub_80482A7();
// void __usercall sub_80482C6(_WORD *a1@<edi>, _BYTE *a2@<esi>);
void sub_80482F0();
void sub_804830A();
void sub_8048318();
void sub_8048326();

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_804804C; // weak
int dword_804807C[16] =
{
  18351362,
  18897673,
  1936933262,
  1818389861,
  1226863205,
  1684632430,
  537461093,
  319226461,
  1768622593,
  18901859,
  1953383792,
  167866981,
  544175136,
  1935766115,
  1701519464,
  1634689657
}; // weak
char byte_80480BF = '\x02'; // weak
int dword_80481E8[2] = { 661545283, 1886330996 }; // weak
char filename[] = "/dev/vcsa"; // idb
char byte_804833F; // weak
int dword_8048343; // weak
int fd; // idb
char byte_804834B; // weak
char byte_804834F; // weak
int dword_805BBCF; // weak
int dword_805BBD3; // weak
int dword_805BBDB; // weak
char byte_805BBE5; // weak
char byte_805BBE6; // weak


//----- (080480DD) --------------------------------------------------------
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // edx
  int v3; // ecx
  char *v4; // edi
  int v5; // eax
  int v6; // eax

  sub_80481FE(a1, a2);
  sub_804830A();
  v3 = v2;
  v4 = &byte_804834F;
  while ( v3 )
  {
    *(_WORD *)v4 = 7088;
    v4 += 2;
    --v3;
  }
  sub_8048160(v4);
  sub_8048318();
  while ( 1 )
  {
    while ( sys_read(0, &byte_804834B, 1u) < 0 )
      ;
    if ( byte_804834B == 27 || byte_804834B == 13 )
    {
      sub_8048318();
      sub_80482A7();
      v6 = sys_exit(v5);
    }
  }
}
// 80480FB: variable 'v2' is possibly undefined
// 804815E: variable 'v5' is possibly undefined
// 8048343: using guessed type int dword_8048343;
// 804834B: using guessed type char byte_804834B;
// 804834F: using guessed type char byte_804834F;

//----- (08048160) --------------------------------------------------------
void __usercall sub_8048160(_WORD *a1@<edi>)
{
  int i; // ecx
  int v2; // ecx
  _WORD *v3; // edi
  int v4; // ecx
  __int16 v5; // ax
  char *v6; // edi
  int j; // ecx
  _BYTE *v8; // edi
  _WORD *v9; // edi
  char v10; // al
  int v11; // ecx
  _BYTE *v12; // edi
  int v13; // [esp-4h] [ebp-4h]

  sub_80482F0();
  for ( i = 64; i; --i )
    *a1++ = 475;
  v2 = 10;
  do
  {
    v13 = v2;
    sub_80482F0();
    *a1 = 221;
    v3 = a1 + 1;
    v4 = 62;
    HIBYTE(v5) = 0;
    while ( v4 )
    {
      *v3++ = 32;
      --v4;
    }
    LOBYTE(v5) = -34;
    *v3 = v5;
    v6 = (char *)v3 + 3;
    *v6 = 3;
    v6 += 2;
    *v6 = 3;
    a1 = v6 + 1;
    v2 = v13 - 1;
  }
  while ( v13 != 1 );
  sub_80482F0();
  for ( j = 64; j; --j )
    *a1++ = 475;
  v8 = (char *)a1 + 1;
  *v8 = 3;
  v8 += 2;
  *v8 = 3;
  v9 = v8 + 1;
  sub_80482F0();
  v11 = 64;
  do
  {
    v12 = (char *)v9 + 1;
    *v12 = v10;
    v9 = v12 + 1;
    --v11;
  }
  while ( v11 );
  sub_80482C6(v9, &unk_804804C);
  sub_80482C6(v9, dword_804807C);
  sub_80482C6(v9, &byte_80480BF);
}
// 80481C6: variable 'v10' is possibly undefined
// 804807C: using guessed type int dword_804807C[16];
// 80480BF: using guessed type char byte_80480BF;

//----- (080481FE) --------------------------------------------------------
void __fastcall sub_80481FE(int a1, mode_t a2)
{
  int v2; // eax
  int v3; // eax
  _WORD *v4; // ecx
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // ecx
  int v9; // eax
  int v10; // eax
  int v11; // eax

  v2 = sys_open(filename, 2, a2);
  fd = v2;
  if ( v2 < 0 )
  {
    v11 = sys_write(0, dword_80481E8, 0x16u);
    JUMPOUT(0x8048159);
  }
  v3 = sys_read(v2, &byte_804833F, 4u);
  v5 = (unsigned __int16)*v4;
  LOWORD(v5) = (unsigned __int8)HIBYTE(*v4) * (unsigned __int8)v5;
  dword_8048343 = v5;
  v6 = sys_fcntl(0, 4, (struct flock *)0x800);
  v7 = sys_ioctl(0, 21505);
  v9 = sys_ioctl(0, v8);
  dword_805BBDB &= 0xFFFFFFF4;
  dword_805BBD3 |= 5u;
  dword_805BBCF &= 0xFFFFFACF;
  byte_805BBE5 = 0;
  byte_805BBE6 = 1;
  v10 = sys_ioctl(0, 21506);
}
// 80482A2: control flows out of bounds to 8048159
// 8048224: variable 'v4' is possibly undefined
// 8048256: variable 'v8' is possibly undefined
// 80481E8: using guessed type int dword_80481E8[2];
// 804833F: using guessed type char byte_804833F;
// 8048343: using guessed type int dword_8048343;
// 805BBCF: using guessed type int dword_805BBCF;
// 805BBD3: using guessed type int dword_805BBD3;
// 805BBDB: using guessed type int dword_805BBDB;
// 805BBE5: using guessed type char byte_805BBE5;
// 805BBE6: using guessed type char byte_805BBE6;

//----- (080482A7) --------------------------------------------------------
void sub_80482A7()
{
  int v0; // eax
  int v1; // eax

  v0 = sys_ioctl(0, 21506);
  v1 = sys_close(fd);
}

//----- (080482C6) --------------------------------------------------------
void __usercall sub_80482C6(_WORD *a1@<edi>, _BYTE *a2@<esi>)
{
  int v2; // eax
  int v3; // [esp-24h] [ebp-24h]

  v2 = 1792;
  while ( 1 )
  {
    LOBYTE(v2) = *a2++;
    if ( !(_BYTE)v2 )
      break;
    if ( (_BYTE)v2 == 1 )
    {
      LOBYTE(v2) = *a2++;
      BYTE1(v2) = v2;
    }
    else if ( (_BYTE)v2 == 2 )
    {
      v3 = v2;
      a2 += 2;
      sub_80482F0();
      v2 = v3;
    }
    else
    {
      *a1++ = v2;
    }
  }
}

//----- (080482F0) --------------------------------------------------------
void sub_80482F0()
{
  ;
}

//----- (0804830A) --------------------------------------------------------
void sub_804830A()
{
  sub_8048326();
  __asm { int     80h; LINUX - sys_pread }
}

//----- (08048318) --------------------------------------------------------
void sub_8048318()
{
  sub_8048326();
  __asm { int     80h; LINUX - sys_pwrite }
}

//----- (08048326) --------------------------------------------------------
void sub_8048326()
{
  sub_80482F0();
}

// nfuncs=9 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
