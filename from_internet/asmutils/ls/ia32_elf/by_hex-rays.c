/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __cdecl __noreturn start(int, int);
// int __usercall sub_80480C7@<eax>(char *@<ebp>, char *@<esi>);
// int __usercall sub_80480F2@<eax>(int@<ebp>, char *@<esi>);
// int __usercall sub_804810A@<eax>(int@<ebp>, int@<edi>, _BYTE *@<esi>);
// int __usercall sub_804827F@<eax>(const char *@<ebx>, char *@<ebp>, int@<edi>, char *@<esi>);
// int __usercall sub_80482A0@<eax>(char *@<ebp>);
// char __usercall sub_8048354@<al>(int _EAX@<eax>, int@<ecx>, int@<ebp>, _BYTE *@<edi>, _BYTE *@<esi>);
// void __usercall sub_8048395(char *@<ebp>, char *@<esi>);
// int __usercall sub_80483B9@<eax>(int result@<eax>, unsigned int@<edx>, char *@<edi>);

//-------------------------------------------------------------------------
// Data declarations

char byte_80483D5[] = { '|' }; // weak
char a1lfssirbnadhms[15] = "1lFsSiRbNadhms"; // weak
char byte_804845B[]; // weak
int dword_804946C[8208]; // weak
struct dirent dirp; // idb
int dword_80534AC[1024]; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start(int a1, int a2)
{
  int v2; // eax
  char *v3; // esi
  char *v4; // esi
  char v5; // al
  char *v6; // edi
  int v7; // ecx
  bool v8; // zf
  int v9; // eax
  char *v10; // [esp-8h] [ebp-8h]
  int v11; // [esp-4h] [ebp-4h] BYREF

  *(_DWORD *)&byte_804845B[-27] = dword_80534AC;
  v2 = sys_ioctl(1, 21505);
  byte_804845B[-4] = v2;
  while ( 1 )
  {
    v3 = v10;
    if ( !v10 )
      goto LABEL_12;
    if ( *v10 != 45 )
      goto LABEL_13;
    v4 = v10 + 1;
    if ( *v10 == v10[1] )
      break;
    while ( 1 )
    {
      v5 = *v4++;
      if ( !v5 )
        break;
      v6 = a1lfssirbnadhms;
      v7 = 12;
      do
      {
        if ( !v7 )
          break;
        v8 = *v6++ == v5;
        --v7;
      }
      while ( !v8 );
      byte_804845B[v7 - 15] = v5;
      if ( v5 == 67 )
        *(_DWORD *)&byte_804845B[-5] = 0;
    }
  }
  v3 = (char *)v11;
  if ( !v11 )
  {
LABEL_12:
    v11 = 46;
    v3 = (char *)&v11;
  }
  do
  {
LABEL_13:
    sub_80480C7(byte_804845B, v3);
    v3 = (char *)v11;
  }
  while ( v11 );
  byte_804845B[-3] = 58;
  sub_8048395(byte_804845B, (char *)dword_80534AC);
  v9 = sys_exit(*(_DWORD *)&byte_804845B[-19]);
}
// 804809A: positive sp value 10 has been found
// 804806E: variable 'v10' is possibly undefined
// 80534AC: using guessed type int dword_80534AC[1024];

//----- (080480C7) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __usercall sub_80480C7@<eax>(char *a1@<ebp>, char *a2@<esi>)
{
  char *v2; // edi
  char *v3; // ebx
  char v4; // al
  char *v5; // esi
  int v6; // edi
  bool v7; // zf
  char v8; // al
  int v9; // edx
  int v10; // ecx
  char v11; // cf
  int v13; // eax
  int v14; // eax
  int v15; // eax
  char *v16; // ecx
  size_t v17; // edx
  int v18; // eax
  int v19; // edi
  int v20; // ebx
  struct dirent *v21; // ecx
  int v22; // eax
  __int64 v23; // rax
  char *v24; // edi
  char *v25; // ebx
  unsigned __int8 *p_d_type; // esi
  int v27; // edi
  _BYTE *v28; // esi
  char v29; // zf
  char v30; // al
  char *v31; // esi
  char v32; // al
  int d_reclen; // edx
  char *v34; // [esp-2Ch] [ebp-2Ch]
  int v35; // [esp-28h] [ebp-28h]
  struct dirent *v36; // [esp-20h] [ebp-20h]
  int v37; // [esp-1Ch] [ebp-1Ch]
  int v38; // [esp-10h] [ebp-10h]
  int v39; // [esp-Ch] [ebp-Ch]
  char *v40; // [esp-Ch] [ebp-Ch]

  *a1 = 10;
  v2 = a1 + 1;
  v3 = a1 + 1;
  do
  {
    v4 = *a2++;
    *v2++ = v4;
  }
  while ( v4 );
  v5 = a1 + 1;
  v6 = v2 - v3 - 1;
  v8 = sub_804827F(v3, a1, v6, a1 + 1);
  if ( v11 )
    JUMPOUT(0x8048109);
  if ( !v7 || v8 != *(a1 - 14) )
    return sub_804810A((int)a1, v6, v5);
  if ( v9 )
    return sub_80480F2((int)a1, v5);
  v14 = sys_open(v3, v10, 0);
  if ( v14 >= 0 )
  {
    v39 = v14;
    v15 = *(_DWORD *)(a1 - 3);
    if ( (_BYTE)v15 )
    {
      *(a1 - 2) = v15;
      v16 = a1 + 1;
      v17 = v6 + 2;
      v7 = BYTE1(v15) == 0;
      BYTE1(v15) = 10;
      *(_DWORD *)&v3[v6] = v15;
      if ( !v7 )
      {
        v16 = a1;
        v17 = v6 + 3;
      }
      v18 = sys_write(1, v16, v17);
    }
    v5[v6] = 47;
    v19 = v6 + 1;
    v20 = v39;
    while ( 1 )
    {
      v21 = &dirp;
      v22 = 141;
      __asm { int     80h; LINUX - sys_getdents }
      do
      {
        v40 = v5;
        v38 = v19;
        v37 = v20;
        v36 = v21;
        v35 = v22;
        v23 = v22;
        v24 = &v5[v19];
        v25 = v5;
        p_d_type = &v21->d_type;
        v34 = (char *)&v21->d_type;
        do
        {
          LOBYTE(v23) = *p_d_type++;
          *v24++ = v23;
          ++HIDWORD(v23);
        }
        while ( (_BYTE)v23 );
        v27 = HIDWORD(v23) - 1;
        v28 = &v21->d_type;
        if ( *v34 != 46 || *(a1 - 13) )
        {
          v30 = sub_804827F(v25, a1, v27, v34);
          if ( !v11 )
          {
            if ( v29 && v30 != *(a1 - 10) )
            {
              v31 = v34 + 1;
              if ( *v34 != 46 )
                goto LABEL_29;
              v32 = *v31;
              if ( *v31 == 46 )
                v32 = v34[2];
              if ( v32 )
LABEL_29:
                sub_80480F2((int)a1, v25);
              v28 = v34;
            }
            sub_804810A((int)a1, v27, v28);
          }
        }
        v20 = v37;
        v19 = v38;
        v5 = v40;
        d_reclen = v36->d_reclen;
        v21 = (struct dirent *)((char *)v36 + d_reclen);
        v22 = v35 - d_reclen;
      }
      while ( v35 > d_reclen );
    }
  }
  v13 = -v14;
  if ( !v13 )
    return sub_80482A0(a1);
  *(_DWORD *)(a1 - 19) = v13;
  sub_80482A0(a1);
  *(_DWORD *)&v3[v6] = 171917088;
  return sys_write(2, v5, v6 + 4);
}
// 80480D5: positive sp value 4 has been found
// 80480E1: control flows out of bounds to 8048109
// 80480E1: variable 'v11' is possibly undefined
// 80480E3: variable 'v7' is possibly undefined
// 80480EC: variable 'v9' is possibly undefined
// 80482B9: variable 'v10' is possibly undefined
// 8048321: variable 'v29' is possibly undefined

//----- (080480F2) --------------------------------------------------------
int __usercall sub_80480F2@<eax>(int a1@<ebp>, char *a2@<esi>)
{
  _BYTE *v2; // edi
  char v3; // al

  v2 = *(_BYTE **)(a1 - 27);
  do
  {
    v3 = *a2++;
    *v2++ = v3;
  }
  while ( v3 );
  *(_DWORD *)(a1 - 27) = v2;
  return sys_brk(v2 + 4096);
}

//----- (0804810A) --------------------------------------------------------
int __usercall sub_804810A@<eax>(int a1@<ebp>, int a2@<edi>, _BYTE *a3@<esi>)
{
  char *v3; // edi
  struct timeval *v7; // edi
  unsigned int v9; // ecx
  char v10; // cf
  int v14; // ebx
  int v15; // esi
  int v16; // eax
  int v17; // ecx
  int v18; // eax
  _BYTE *v20; // edi
  int v21; // eax
  int v22; // ett
  _BYTE *v23; // ecx
  char v24; // al
  char v25; // al
  unsigned int v26; // edx
  int (__usercall *v28)@<eax>(int@<eax>, unsigned int@<edx>, char *@<edi>); // [esp+0h] [ebp-14h]
  char v29; // [esp+4h] [ebp-10h]
  int v30; // [esp+8h] [ebp-Ch]

  v30 = a2;
  LODWORD(_RAX) = a2;
  v3 = (char *)dword_804946C;
  _RAX = (int)_RAX;
  if ( (unsigned __int16)((int)_RAX >> 31) >> 8 != *(_BYTE *)(a1 - 9) )
  {
    BYTE4(_RAX) = 8;
    LODWORD(_RAX) = sub_80483B9(*(_DWORD *)(a1 - 87), HIDWORD(_RAX), (char *)dword_804946C);
    LOBYTE(_RAX) = 32;
    LOBYTE(dword_804946C[0]) = 32;
    v3 = (char *)dword_804946C + 1;
  }
  if ( BYTE5(_RAX) != *(_BYTE *)(a1 - 7) )
  {
    BYTE4(_RAX) = 4;
    LODWORD(_RAX) = sub_80483B9(*(_DWORD *)(a1 - 63) >> 1, HIDWORD(_RAX), v3);
    LOBYTE(_RAX) = 32;
    *v3++ = 32;
  }
  if ( BYTE5(_RAX) != *(_BYTE *)(a1 - 5) )
  {
    _EDX = *(_DWORD *)(a1 - 83);
    v29 = BYTE1(_EDX) >> 4;
    _EBX = (char *)sub_80483B9 + 38;
    __asm { xlat }
    *v3 = _AL;
    v7 = (struct timeval *)(v3 + 1);
    _EBX = (char *)sub_80483B9 + 34;
    v9 = 292;
    v10 = BYTE1(_EDX) & 1;
    BYTE1(_EDX) = (BYTE1(_EDX) >> 1) | (__CFSHR__(BYTE1(_EDX), 4) << 7);
    while ( 1 )
    {
      _AL = 7;
      if ( v10 )
        _AL = v9 & 7;
      if ( (v9 & 1) != 0 )
      {
        BYTE1(_EDX) *= 2;
        if ( (_EDX & 0x800) != 0 )
          _AL = ((v9 + _AL) & 0x1F) + 1;
      }
      __asm { xlat }
      LOBYTE(v7->tv_sec) = _AL;
      v7 = (struct timeval *)((char *)v7 + 1);
      v10 = v9 & 1;
      v9 >>= 1;
      if ( !v9 )
        break;
      __asm { rcl     dl, 1 }
    }
    v14 = 3;
    v28 = sub_80483B9;
    v15 = a1 - 81 + 2;
    do
    {
      ((void (__cdecl *)(int (__usercall *)@<eax>(int@<eax>, unsigned int@<edx>, char *@<edi>)))v28)(v28);
      v15 += 2;
      --v14;
    }
    while ( v14 );
    if ( (v29 & 0xFB) == 2 )
      ((void (__cdecl *)(int))v28)(v30);
    v16 = sys_gettimeofday(v7, (struct timezone *)((int (*)(void))v28)());
    v18 = v7->tv_sec - *(_DWORD *)(a1 - 51);
    _EBX = (char *)v28 + 61;
    do
    {
      LOBYTE(v17) = (--_EBX)[4];
      if ( !v17 )
        break;
      v18 /= v17;
    }
    while ( v18 );
    LODWORD(_RAX) = ((int (*)(void))v28)();
    __asm { xlat }
    LOBYTE(v7->tv_sec) = _RAX;
    v20 = (char *)&v7->tv_sec + 1;
    LOBYTE(_RAX) = 32;
    *v20 = 32;
    v3 = v20 + 1;
  }
  sub_8048354(_RAX, v30, a1, v3, a3);
  v21 = *(_DWORD *)(a1 - 85) >> 29;
  if ( (_BYTE)v21 != 5 || BYTE1(v21) == *(_BYTE *)(a1 - 5) )
  {
    if ( BYTE1(v21) != *(_BYTE *)(a1 - 6) )
    {
      v24 = byte_80483D5[v21];
      if ( v24 != 42 || (*(_BYTE *)(a1 - 83) & 0x49) != 0 )
        *v3++ = v24;
    }
  }
  else
  {
    *(_DWORD *)v3 = 540945696;
    v3 += 4;
    v22 = sys_readlink((const char *)(a1 + 1), *(char **)(a1 - 27), 0x1000u);
    sub_8048354((int)a3, v22, a1, v3, v23);
  }
  v25 = 10;
  if ( !*(_BYTE *)(a1 - 4) )
  {
    LOBYTE(v26) = ((unsigned int)(v3 - (char *)dword_804946C) >> 3) + 1 + *(_BYTE *)(a1 - 1);
    if ( (unsigned __int8)v26 > 0xAu )
    {
      sub_80482A0((char *)a1);
      v26 = ((unsigned int)(v3 - (char *)dword_804946C) >> 3) + 1;
    }
    v25 = 9;
    if ( (unsigned __int8)v26 >= 9u )
    {
      v25 = 10;
      LOBYTE(v26) = 0;
    }
    if ( (v26 & 1) != 0 )
    {
      *v3++ = v25;
      LOBYTE(v26) = v26 + 1;
    }
    *(_BYTE *)(a1 - 1) = v26;
  }
  *v3 = v25;
  *(_BYTE *)(a1 - 2) = v25;
  return sys_write(1, dword_804946C, v3 + 1 - (char *)dword_804946C);
}
// 804812B: variable '_RAX' is possibly undefined
// 8048185: variable 'v28' is possibly undefined
// 80481C0: variable 'v17' is possibly undefined
// 80481D4: variable 'v30' is possibly undefined
// 80481FE: variable 'v23' is possibly undefined
// 804946C: using guessed type int dword_804946C[8208];

//----- (0804827F) --------------------------------------------------------
int __usercall sub_804827F@<eax>(const char *a1@<ebx>, char *a2@<ebp>, int a3@<edi>, char *a4@<esi>)
{
  int result; // eax

  result = -sys_newlstat(a1, (struct stat *)(a2 - 91));
  if ( result )
  {
    *(_DWORD *)(a2 - 19) = result;
    sub_80482A0(a2);
    *(_DWORD *)&a4[a3] = 171917088;
    return sys_write(2, a4, a3 + 4);
  }
  return result;
}

//----- (080482A0) --------------------------------------------------------
int __usercall sub_80482A0@<eax>(char *a1@<ebp>)
{
  int result; // eax

  if ( *(a1 - 1) )
  {
    *(a1 - 1) = 0;
    return sys_write(1, a1, 1u);
  }
  return result;
}

//----- (08048354) --------------------------------------------------------
char __usercall sub_8048354@<al>(int _EAX@<eax>, int a2@<ecx>, int a3@<ebp>, _BYTE *a4@<edi>, _BYTE *a5@<esi>)
{
  int v5; // edx
  int v6; // eax
  _BYTE *v7; // edi

  v5 = *(_DWORD *)(a3 - 12);
  do
  {
    LOBYTE(_EAX) = *a5++;
    if ( (_BYTE)v5 )
      goto LABEL_12;
    BYTE1(_EAX) = 92;
    if ( (_BYTE)_EAX != 92 && (_BYTE)_EAX != 34 )
    {
      if ( (unsigned __int8)_EAX <= 0x7Eu && (unsigned __int8)_EAX >= 0x20u )
        goto LABEL_12;
      if ( !BYTE1(v5) )
      {
        LOBYTE(_EAX) = 63;
        goto LABEL_12;
      }
      v6 = __ROR4__(_EAX, 8);
      *a4 = v6;
      v7 = a4 + 1;
      LOBYTE(v6) = 12;
      _EAX = __ROL4__(v6, 2);
      *v7 = _EAX;
      a4 = v7 + 1;
      _EAX >>= 26;
      __asm { aam     8 }
      LOWORD(_EAX) = _EAX + 12336;
    }
    if ( BYTE1(v5) )
      *a4++ = BYTE1(_EAX);
LABEL_12:
    *a4++ = _EAX;
    --a2;
  }
  while ( a2 );
  return _EAX;
}

//----- (08048395) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_8048395(char *a1@<ebp>, char *a2@<esi>)
{
  unsigned int v2; // edx
  char *v3; // [esp-8h] [ebp-8h]
  char *v4; // [esp-4h] [ebp-4h]

  sub_80482A0(a1);
  v2 = *(_DWORD *)(a1 - 27);
  while ( (unsigned int)a2 < v2 )
  {
    v3 = (char *)v2;
    sub_80480C7(a1, a2);
    sub_8048395(a1, v4);
    a2 = v3;
    v2 = (unsigned int)v4;
    *(_DWORD *)(a1 - 27) = v4;
  }
  JUMPOUT(0x8048394);
}
// 80483B4: positive sp value 4 has been found
// 804839F: control flows out of bounds to 8048394
// 80483AD: variable 'v4' is possibly undefined

//----- (080483B9) --------------------------------------------------------
int __usercall sub_80483B9@<eax>(int result@<eax>, unsigned int a2@<edx>, char *a3@<edi>)
{
  char *v3; // edi
  int v4; // et2

  memset(a3, 32, a2);
  v3 = &a3[a2];
  do
  {
    v4 = result % 10;
    result /= 10;
    *--v3 = v4 + 48;
  }
  while ( result );
  return result;
}

// nfuncs=9 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
