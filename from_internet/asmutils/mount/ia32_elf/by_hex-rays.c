/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(mode_t@<edx>, int@<edi>);
// int __usercall sub_8048140@<eax>(const char *@<edx>, const char *@<ecx>, const char *@<ebx>);

//-------------------------------------------------------------------------
// Data declarations

__int16 *off_8048156 = &word_804818E; // weak
char filename[] = "/proc/mounts"; // idb
char aEtcMtab[] = "/etc/mtab"; // idb
unsigned int mountflags; // idb
char byte_80481D5; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(mode_t a1@<edx>, int a2@<edi>)
{
  const char *v2; // ebx
  int v3; // eax
  int v4; // eax
  mode_t v5; // edx
  int v6; // ecx
  size_t v7; // eax
  const void *v8; // ecx
  int v9; // eax
  char *v10; // ebp
  char *v11; // esi
  char v12; // al
  unsigned int v13; // ebx
  int v14; // ecx
  __int16 **v15; // edx
  bool v16; // zf
  const char *v17; // edx
  const char *v18; // edx
  const char *v19; // ecx
  const char *v20; // edx
  const char *v21; // ecx
  const char *v22; // edx
  const char *v23; // ecx
  int v24; // [esp-28h] [ebp-28h]
  int v25; // [esp-20h] [ebp-20h]
  const char *v26; // [esp-1Ch] [ebp-1Ch]
  const char *v27; // [esp-18h] [ebp-18h]
  int v28; // [esp-18h] [ebp-18h]
  char *v29; // [esp-14h] [ebp-14h]
  char *v30; // [esp-14h] [ebp-14h]
  const char *v31; // [esp-10h] [ebp-10h]
  const char *v32; // [esp-Ch] [ebp-Ch]
  const char *v33; // [esp-8h] [ebp-8h]
  const char *v34; // [esp-4h] [ebp-4h]

  if ( v25 == 1 )
    goto LABEL_5;
  v2 = v27;
  if ( v26[strlen(v26) - 6] == 117 )
  {
    v3 = sys_oldumount(v27);
    goto LABEL_4;
  }
  if ( (unsigned __int8)(v25 - 1) < 2u )
  {
LABEL_5:
    v3 = sys_open(filename, 0, a1);
    if ( v3 >= 0 || (v3 = sys_open(aEtcMtab, v6, v5), v3 >= 0) )
    {
      v7 = sys_read(v3, &byte_80481D5, 0x2000u);
      v9 = sys_write(1, v8, v7);
      v3 = 0;
    }
  }
  else
  {
    if ( *(_WORD *)v27 == 28461 )
    {
      v10 = v29;
      do
      {
        v11 = v10;
        do
        {
          v12 = *v11++;
          if ( v12 == 44 )
            goto LABEL_15;
        }
        while ( v12 );
        ++byte_80481D5;
LABEL_15:
        v13 = v11 - v10 - 1;
        v14 = 7;
        v15 = &off_8048156;
        while ( 1 )
        {
          v30 = v11;
          v28 = a2;
          v24 = v14;
          v16 = memcmp(v10, *v15, v13) == 0;
          a2 = v28;
          v11 = v30;
          if ( v16 )
            break;
          v15 += 2;
          v14 = v24 - 1;
          if ( v24 == 1 )
            goto LABEL_19;
        }
        mountflags |= (unsigned int)v15[1];
LABEL_19:
        v10 = v30;
      }
      while ( byte_80481D5 != 1 );
      v2 = v31;
    }
    v17 = &byte_80481D5;
    if ( *(_WORD *)v2 == 29741 )
    {
      v17 = v32;
      v2 = v33;
    }
    sub_8048140(v17, v34, v2);
    mountflags |= 1u;
    sub_8048140(v18, v19, v2);
    mountflags &= ~1u;
    mountflags |= 4u;
    sub_8048140(v20, v21, v2);
    mountflags |= 1u;
    v3 = sub_8048140(v22, v23, v2);
  }
LABEL_4:
  v4 = sys_exit(v3);
}
// 804810B: positive sp value 20 has been found
// 804804E: variable 'v25' is possibly undefined
// 8048051: variable 'v27' is possibly undefined
// 8048055: variable 'v26' is possibly undefined
// 8048083: variable 'v6' is possibly undefined
// 8048083: variable 'v5' is possibly undefined
// 80480A1: variable 'v8' is possibly undefined
// 80480B3: variable 'v29' is possibly undefined
// 80480FB: variable 'v31' is possibly undefined
// 8048108: variable 'v32' is possibly undefined
// 8048109: variable 'v33' is possibly undefined
// 804810B: variable 'v34' is possibly undefined
// 8048117: variable 'v18' is possibly undefined
// 8048117: variable 'v19' is possibly undefined
// 804812A: variable 'v20' is possibly undefined
// 804812A: variable 'v21' is possibly undefined
// 8048136: variable 'v22' is possibly undefined
// 8048136: variable 'v23' is possibly undefined
// 8048156: using guessed type __int16 *off_8048156;
// 80481D5: using guessed type char byte_80481D5;

//----- (08048140) --------------------------------------------------------
int __usercall sub_8048140@<eax>(const char *a1@<edx>, const char *a2@<ecx>, const char *a3@<ebx>)
{
  int result; // eax

  result = sys_mount(a3, a2, a1, mountflags, 0);
  if ( result >= 0 )
    JUMPOUT(0x8048064);
  return result;
}
// 804814F: control flows out of bounds to 8048064

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
