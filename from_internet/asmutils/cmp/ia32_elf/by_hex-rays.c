/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// unsigned int __usercall sub_804804C@<eax>(unsigned int result@<eax>, char *@<esi>);
// char __usercall sub_8048070@<al>(_BYTE *@<edi>, char *@<esi>);
void __fastcall __noreturn start(int, mode_t);

//-------------------------------------------------------------------------
// Data declarations

char aCmpEofOnDiffer[25] = "cmp: EOF on differ: char"; // weak
char aLine[7] = ", line"; // weak
int dword_8048286[]; // weak
int dword_804828A; // weak
int fd; // idb
int dword_8048296[]; // weak
int dword_804829A; // weak
int dword_804829E[]; // weak
int dword_80482A2; // weak
int dword_80482A6; // weak
int dword_80482AA; // weak
__int16 word_80482AE; // weak


//----- (0804804C) --------------------------------------------------------
unsigned int __usercall sub_804804C@<eax>(unsigned int result@<eax>, char *a2@<esi>)
{
  int v2; // ecx
  char *v4; // esi
  __int64 v5; // rt2

  v2 = 16;
  v4 = a2 + 16;
  do
  {
    v5 = result % 10LL;
    result /= 10LL;
    v4[v2--] = v5 + 48;
  }
  while ( result );
  qmemcpy(a2, &v4[v2 + 1], 16 - v2);
  return result;
}

//----- (08048070) --------------------------------------------------------
char __usercall sub_8048070@<al>(_BYTE *a1@<edi>, char *a2@<esi>)
{
  char v2; // al
  char *v3; // esi
  char result; // al

  v2 = *a2;
  v3 = a2 + 1;
  do
  {
    *a1++ = v2;
    v2 = *v3++;
  }
  while ( v2 );
  result = 32;
  *a1 = 32;
  return result;
}

//----- (0804807B) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // ebp
  char *v3; // esi
  char v4; // al
  int v5; // eax
  int v6; // ebp
  int v7; // eax
  int v8; // ecx
  char *v9; // esi
  int v10; // eax
  size_t v11; // edx
  void *v12; // ecx
  int v13; // eax
  int v14; // ecx
  int v15; // edx
  int v16; // eax
  _BYTE *v17; // esi
  _BYTE *v18; // edi
  int v19; // ecx
  bool v20; // zf
  int *v21; // edi
  int v22; // edx
  int v23; // eax
  const char *v24; // edi
  unsigned int v25; // esi
  int v26; // eax
  int v27; // ebx
  int v28; // eax
  int v29; // ecx
  _BYTE *v30; // edi
  unsigned int v31; // ebx
  int v32; // eax
  int v33; // [esp-Ch] [ebp-Ch]
  char *v34; // [esp-4h] [ebp-4h]
  int v35; // [esp-4h] [ebp-4h]
  int *v36; // [esp-4h] [ebp-4h]
  unsigned int v37; // [esp-4h] [ebp-4h]

  if ( v33 <= 2 )
  {
LABEL_32:
    v27 = 2;
  }
  else
  {
    v2 = 0;
    while ( v34 )
    {
      v3 = v34 + 1;
      if ( *v34 == 45 )
      {
        v4 = *v3;
        if ( *v3 )
        {
          if ( v4 == 115 )
          {
            dword_80482AA |= 8u;
          }
          else
          {
            if ( v4 != 108 )
              goto LABEL_32;
            dword_80482AA |= 0x10u;
          }
        }
        else
        {
          dword_8048286[v2] = (int)v34;
          if ( v2 )
            break;
          v2 = 1;
        }
      }
      else
      {
        dword_8048286[v2] = (int)v34;
        v5 = sys_open(v34, 0, a2);
        if ( v5 < 0 )
          goto LABEL_32;
        *(&fd + v2) = v5;
        if ( v2 )
          break;
        v2 = 1;
      }
    }
    dword_80482A6 = 134513838;
    v6 = -1;
    do
    {
      ++v6;
      v7 = sys_lseek(*(&fd + v6), 0, 2);
      if ( v7 )
      {
        __asm { int     80h; LINUX - sys_mmap2 }
        v8 = 192;
      }
      else
      {
        v9 = (char *)dword_80482A6;
        v35 = dword_80482A6;
        do
        {
          v9 += 4096;
          v10 = sys_brk(v9);
          v13 = sys_read(*(&fd + v6), v12, v11);
        }
        while ( v15 == v13 );
        dword_80482A6 = (int)v9;
        v16 = v14 + v13;
        v8 = v35;
        v7 = v16 - v35;
      }
      dword_8048296[v6] = v8;
      dword_804829E[v6] = v7;
    }
    while ( !v6 );
    v36 = dword_8048296;
    v17 = (_BYTE *)dword_8048296[0];
    v18 = (_BYTE *)dword_804829A;
    v19 = dword_804829E[0];
    if ( dword_804829E[0] >= dword_80482A2 )
    {
      v36 = &dword_804829A;
      v19 = dword_80482A2;
    }
    do
    {
      if ( !v19 )
        break;
      v20 = *v17++ == *v18++;
      --v19;
    }
    while ( v20 );
    v21 = v36;
    v22 = v19;
    if ( v19 )
    {
      v29 = v36[2] - v19;
      v37 = v36[2] - v22;
      v30 = (_BYTE *)*v21;
      v31 = 0;
      do
      {
        ++v31;
        do
        {
          if ( !v29 )
            break;
          v20 = *v30++ == 10;
          --v29;
        }
        while ( !v20 );
      }
      while ( v29 );
      sub_8048070(&word_80482AE, (char *)dword_8048286[0]);
      sub_8048070(&word_80482AE, (char *)dword_804828A);
      sub_8048070(&word_80482AE, &aCmpEofOnDiffer[12]);
      sub_804804C(v37, (char *)&word_80482AE);
      sub_8048070(&word_80482AE, aLine);
      sub_804804C(v31, (char *)&word_80482AE);
      LOBYTE(word_80482AE) = 10;
      v32 = sys_write(1, &word_80482AE, 1u);
      goto LABEL_29;
    }
    if ( dword_804829E[0] != dword_80482A2 )
    {
      v23 = sys_write(1, aCmpEofOnDiffer, 0xCu);
      v24 = (const char *)*(v36 - 4);
      v25 = (unsigned int)&v24[strlen(v24) + 1];
      *(_BYTE *)(v25 - 1) = 10;
      v26 = sys_write(1, v24, v25 - (_DWORD)v24);
LABEL_29:
      v27 = 1;
      goto LABEL_30;
    }
    v27 = 0;
  }
LABEL_30:
  v28 = sys_exit(v27);
}
// 8048089: positive sp value C has been found
// 804807F: variable 'v33' is possibly undefined
// 804808B: variable 'v34' is possibly undefined
// 80480D8: variable 'a2' is possibly undefined
// 8048154: variable 'v12' is possibly undefined
// 8048154: variable 'v11' is possibly undefined
// 8048158: variable 'v15' is possibly undefined
// 8048160: variable 'v14' is possibly undefined
// 8048286: using guessed type int dword_8048286[];
// 804828A: using guessed type int dword_804828A;
// 8048296: using guessed type int dword_8048296[];
// 804829A: using guessed type int dword_804829A;
// 804829E: using guessed type int dword_804829E[];
// 80482A2: using guessed type int dword_80482A2;
// 80482A6: using guessed type int dword_80482A6;
// 80482AA: using guessed type int dword_80482AA;
// 80482AE: using guessed type __int16 word_80482AE;

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
