/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn start();
void __cdecl sub_8048094(char *filename);
// void __usercall sub_8048148(char *a1@<edi>, char *a2@<esi>);
// __int16 __usercall sub_804815C@<ax>(char *@<edi>);
// void __usercall sub_8048177(const char *a1@<edi>);
// char __usercall sub_804819E@<al>(char *@<esi>);
// void __usercall sub_80481AE(char *a1@<edi>, char *a2@<esi>);
// void __usercall sub_80481BB(char *a1@<edi>, char *a2@<esi>);

//-------------------------------------------------------------------------
// Data declarations

struct stat buf; // idb


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __noreturn start()
{
  _BOOL4 v2; // ebp
  char v3; // zf
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // [esp-10h] [ebp-10h]
  _WORD *v8; // [esp-8h] [ebp-8h]
  char *v9; // [esp-4h] [ebp-4h]

  if ( v7 >= 2 )
  {
    v2 = *v8 == 29229;
    while ( v9 )
    {
      sub_8048177(v9);
      if ( v3 )
      {
        if ( v2 )
        {
          sub_8048094(v9);
          v4 = sys_rmdir(v9);
        }
      }
      else
      {
        v5 = sys_unlink(v9);
      }
    }
  }
  v6 = sys_exit(0);
}
// 8048067: positive sp value 10 has been found
// 8048050: variable 'v7' is possibly undefined
// 804805B: variable 'v8' is possibly undefined
// 8048069: variable 'v9' is possibly undefined
// 8048070: variable 'v3' is possibly undefined

//----- (08048094) --------------------------------------------------------
void __cdecl sub_8048094(char *filename)
{
  mode_t v2; // edx
  char v3; // zf
  int v4; // eax
  _BYTE *v5; // edi
  int v6; // ecx
  mode_t v7; // edx
  int v8; // ecx
  int v9; // eax
  int v10; // eax
  unsigned __int16 v11; // ax
  const char *v12; // [esp-28h] [ebp-1136h]
  int v13; // [esp-1Ch] [ebp-112Ah]
  char v14[4096]; // [esp+0h] [ebp-110Eh] BYREF
  _BYTE dirp[270]; // [esp+1000h] [ebp-10Eh] BYREF

  sub_8048177(filename);
  if ( v3 )
  {
    v4 = sys_open(filename, 0, v2);
    if ( v4 >= 0 )
    {
      *(_DWORD *)&dirp[266] = v4;
      while ( 1 )
      {
        __asm { int     80h; LINUX - sys_getdents }
        v5 = dirp;
        v6 = 141;
        do
        {
          if ( v5[10] != 46 || v5[11] && *(_WORD *)(v5 + 11) != 46 )
          {
            sub_8048148(v14, filename);
            sub_8048177(v14);
            if ( v3 )
            {
              v13 = v8;
              sub_8048094(v7, v14);
              v9 = sys_rmdir(v12);
              v6 = v13;
            }
            else
            {
              v10 = sys_unlink(v14);
            }
          }
          v11 = *((_WORD *)v5 + 4);
          v5 += v11;
          v6 -= v11;
        }
        while ( v6 );
      }
    }
  }
}
// 80480A5: variable 'v3' is possibly undefined
// 80480B3: variable 'v2' is possibly undefined
// 8048112: variable 'v8' is possibly undefined
// 8048114: variable 'v7' is possibly undefined
// 804811D: variable 'v12' is possibly undefined
// 8048132: variable 'v6' is possibly undefined

//----- (08048148) --------------------------------------------------------
void __usercall sub_8048148(char *a1@<edi>, char *a2@<esi>)
{
  char *v2; // edx

  sub_80481AE(a1, a2);
  sub_804815C(a1);
  sub_80481BB(a1, v2);
}
// 8048155: variable 'v2' is possibly undefined

//----- (0804815C) --------------------------------------------------------
__int16 __usercall sub_804815C@<ax>(char *a1@<edi>)
{
  int v1; // edx
  int v2; // edx
  __int16 result; // ax

  sub_804819E(a1);
  v2 = v1 - 1;
  result = 47;
  if ( a1[v2] != 47 )
    *(_WORD *)&a1[v2 + 1] = 47;
  return result;
}
// 8048165: variable 'v1' is possibly undefined

//----- (08048177) --------------------------------------------------------
void __usercall sub_8048177(const char *a1@<edi>)
{
  int v1; // eax

  v1 = sys_newlstat(a1, &buf);
}

//----- (0804819E) --------------------------------------------------------
char __usercall sub_804819E@<al>(char *a1@<esi>)
{
  int v1; // edx
  char result; // al

  v1 = -1;
  do
  {
    ++v1;
    result = *a1++;
  }
  while ( result );
  return result;
}

//----- (080481AE) --------------------------------------------------------
void __usercall sub_80481AE(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // edx

  sub_804819E(a2);
  qmemcpy(a1, a2, v2 + 1);
}
// 80481B4: variable 'v2' is possibly undefined

//----- (080481BB) --------------------------------------------------------
void __usercall sub_80481BB(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // edx
  char *v3; // edi
  int v4; // edx

  sub_804819E(a1);
  v3 = &a1[v2];
  sub_804819E(a2);
  qmemcpy(v3, a2, v4 + 1);
}
// 80481BB: could not find valid save-restore pair for edi
// 80481BB: could not find valid save-restore pair for esi
// 80481C5: variable 'v2' is possibly undefined
// 80481CC: variable 'v4' is possibly undefined

// nfuncs=8 queued=8 decompiled=8 lumina nreq=0 worse=0 better=0
// ALL OK, 8 function(s) have been successfully decompiled
