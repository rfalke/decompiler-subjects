// subject_seg08048000.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0804804C: void fn0804804C(Register Eq_2 edx, Stack int32 dwArg00, Stack (ptr32 word16) dwArg08)
void fn0804804C(Eq_2 edx, int32 dwArg00, word16 * dwArg08)
{
	ptr32 fp;
	struct Eq_6 * esp_14 = fp + 4;
	if (dwArg00 >= 0x02)
	{
		word32 ebp_12 = 0x00;
		esp_14 = fp + 0x0C;
		if (*dwArg08 == 29229)
			ebp_12 = 0x01;
		else
			esp_14 = fp + 8;
		while (true)
		{
			Eq_2 edi_23 = esp_14->dw0000;
			++esp_14;
			if (edi_23 == 0x00)
				break;
			if (!fn08048177(edi_23))
			{
				if (ebp_12 != 0x00)
				{
					esp_14->dwFFFFFFFC = (word32) edi_23;
					edx = fn08048094(edx, esp_14->dwFFFFFFFC);
					char * ebx_68 = esp_14->dwFFFFFFFC;
					esp_14->dwFFFFFFFC = 0x28;
					sys_rmdir(ebx_68);
				}
			}
			else
			{
				esp_14->dwFFFFFFFC = 0x0A;
				sys_unlink(edi_23);
			}
		}
	}
	esp_14->dwFFFFFFFC = 0x01;
	sys_exit(0x00);
}

// 08048094: Register Eq_2 fn08048094(Register Eq_2 edx, Stack Eq_2 dwArg04)
// Called from:
//      fn0804804C
//      fn08048094
Eq_2 fn08048094(Eq_2 edx, Eq_2 dwArg04)
{
	ptr32 fp;
	if (!fn08048177(dwArg04))
	{
		Eq_80 eax_23 = sys_open(dwArg04, 0x00, edx);
		if (eax_23 >= 0x00)
		{
			while (true)
			{
				&edx.u0->a0000->b0000 = 266;
				int32 eax_36 = sys_getdents(eax_23, fp - 0x0112, 266);
				if (eax_36 < 0x00)
					break;
				if (eax_36 == 0x00)
				{
					sys_close(eax_23);
					return edx;
				}
				struct Eq_97 * edi_160 = fp - 0x0112;
				int32 ecx_104 = eax_36;
				do
				{
					Eq_2 edx_58 = &edi_160->w0008 + 1;
					if (*edx_58.u1 != 0x2E || ((edx_58.u0)->t0001).u0 != 0x00 && ((edx_58.u0)->t0001).u1 != 0x2E)
					{
						fn08048148(edx_58, dwArg04, fp + ~0x1111);
						if (!fn08048177(fp + ~0x1111))
						{
							fn08048094(edx_58, fp + ~0x1111);
							sys_rmdir(fp + ~0x1111);
						}
						else
							sys_unlink(fp + ~0x1111);
					}
					Eq_118 eax_159 = (uint32) edi_160->w0008;
					edi_160 += eax_159;
					ecx_104 -= eax_159;
				} while (ecx_104 != 0x00);
			}
		}
	}
	return edx;
}

// 08048148: void fn08048148(Register Eq_2 edx, Register Eq_2 esi, Register Eq_2 edi)
// Called from:
//      fn08048094
void fn08048148(Eq_2 edx, Eq_2 esi, Eq_2 edi)
{
	fn080481AE(esi, edi);
	fn0804815C(edi);
	fn080481BB(edx, edi);
}

// 0804815C: void fn0804815C(Register Eq_2 edi)
// Called from:
//      fn08048148
void fn0804815C(Eq_2 edi)
{
	int32 edx_12 = fn0804819E(edi);
	if (edi.u1[edx_12 - 0x01] != 0x2F)
		&((word32) edi + edx_12)->u0->a0000->b0000 = 0x2F;
}

// 08048177: FlagGroup bool fn08048177(Register Eq_2 edi)
// Called from:
//      fn0804804C
//      fn08048094
bool fn08048177(Eq_2 edi)
{
	int32 eax_34 = sys_lstat(edi, &g_t80481D3);
	bool Z_86 = SLICE(cond(eax_34), bool, 2);
	if (eax_34 >= 0x00)
		Z_86 = SLICE(cond(((word32) g_w80481DB & 0x4000) - 0x4000), bool, 2);
	return Z_86;
}

// 0804819E: Register word32 fn0804819E(Register Eq_2 esi)
// Called from:
//      fn0804815C
//      fn080481AE
//      fn080481BB
word32 fn0804819E(Eq_2 esi)
{
	word32 edx_13 = ~0x00;
	do
	{
		++edx_13;
		&esi.u0->a0000->b0000 = &esi_37.u0->t0001.u0;
		esi_37 = esi;
	} while (*esi_37.u1 != 0x00);
	return edx_13;
}

// 080481AE: void fn080481AE(Register Eq_2 esi, Register Eq_2 edi)
// Called from:
//      fn08048148
void fn080481AE(Eq_2 esi, Eq_2 edi)
{
	memcpy(edi, esi, fn0804819E(esi) + 0x01);
}

// 080481BB: void fn080481BB(Register Eq_2 esi, Register Eq_2 edi)
// Called from:
//      fn08048148
void fn080481BB(Eq_2 esi, Eq_2 edi)
{
	memcpy(edi.u0 + fn0804819E(edi) / 3, esi, fn0804819E(esi) + 0x01);
}

Eq_196 g_t80481D3 = // 080481D3
	{
	};
word16 g_w80481DB = 0x00; // 080481DB
