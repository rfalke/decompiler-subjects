/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <math.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall sub_804804C(int *@<edi>, long double@<st0>);
// char __usercall sub_8048068@<al>(long double *_EDI@<edi>, unsigned __int8 *@<esi>, long double@<st0>);
int sub_804814F(void); // weak
// int __usercall sub_8048151@<eax>(char@<bl>, char *@<edi>, long double@<st0>);
// void __usercall __noreturn start(long double@<st0>);

//-------------------------------------------------------------------------
// Data declarations

int dword_80481FD = ; // weak
int dword_8048204[30]; // weak


//----- (0804804C) --------------------------------------------------------
void __usercall sub_804804C(int *a1@<edi>, long double a2@<st0>)
{
  long double v2; // fst6

  v2 = (long double)*a1;
  while ( 1 )
  {
    _FST4 = a2 / v2;
    __asm { frndint }
    if ( _FST4 != a2 / v2 )
      break;
    a2 = a2 / v2;
    sub_804814F();
  }
  JUMPOUT(0x804808B);
}
// 804805D: control flows out of bounds to 804808B
// 804814F: using guessed type int sub_804814F(void);

//----- (08048068) --------------------------------------------------------
char __usercall sub_8048068@<al>(long double *_EDI@<edi>, unsigned __int8 *a2@<esi>, long double a3@<st0>)
{
  int v3; // eax
  unsigned __int8 v4; // al
  bool v5; // cf
  char result; // al
  int v10; // ebp
  unsigned int v11; // esi
  int v12; // eax
  __int64 v14; // rax
  int v15; // ecx
  int v16; // ecx

  v3 = 0;
  __asm
  {
    fild    dword_80481FD
    fldz
  }
  while ( 1 )
  {
    v4 = *a2++;
    if ( !v4 )
      break;
    __asm { fmul    st, st(1) }
    v5 = v4 < 0x30u;
    LOBYTE(v3) = v4 - 48;
    if ( v5 || (unsigned __int8)v3 >= 0xAu )
      goto LABEL_6;
    *((_DWORD *)_EDI + 3) = v3;
    __asm { fiadd   dword ptr [edi+0Ch] }
  }
  __asm
  {
    fld     st
    fstp    tbyte ptr [edi+0Ch]
  }
  _EDI[1] = _RT1;
  if ( (__int16)*((_DWORD *)_EDI + 5) < 16447 )
  {
    sub_8048151(58, (char *)_EDI, a3);
    __asm
    {
      fxch    st(1)
      fld1
      fcom    st(2)
      fstsw   ax
    }
    if ( (HIBYTE(_AX) & 0x45) == 1 )
    {
      __asm { fcompp }
      *(_DWORD *)_EDI = 2;
      sub_804804C((int *)_EDI, a3);
      ++*(_DWORD *)_EDI;
      sub_804804C((int *)_EDI, a3);
      *(_BYTE *)_EDI = 5;
      sub_804804C((int *)_EDI, a3);
      __asm
      {
        fld1
        fcom    st(1)
        fnstsw  ax
      }
      if ( (_AX & 0x4000) != 0 )
      {
LABEL_15:
        __asm { fcompp }
        JUMPOUT(0x804818B);
      }
      *(_BYTE *)_EDI = 7;
      __asm
      {
        fild    qword ptr [edi]
        fdivr   st, st(2)
      }
      v10 = 1111639590;
LABEL_11:
      v11 = *(_DWORD *)_EDI;
      v10 = __ROL4__(v10, 4);
      v12 = v10 & 0xF;
      v5 = __CFADD__(v12, *(_DWORD *)_EDI);
      *(_DWORD *)_EDI += v12;
      if ( !v5 )
      {
        while ( 1 )
        {
          __asm
          {
            fst     st(1)
            fstp    tbyte ptr [edi+0Ch]
          }
          _EDI[1] = _RT1;
          __asm
          {
            fild    qword ptr [edi]
            fdivr   st, st(2)
          }
          HIDWORD(v14) = *((_DWORD *)_EDI + 4);
          v15 = 16414 - *((_DWORD *)_EDI + 5);
          if ( v15 >= 0 && HIDWORD(v14) >> v15 < v11 )
            break;
          LODWORD(v14) = *((_DWORD *)_EDI + 3);
          v16 = *((_DWORD *)_EDI + 5) - 16414;
          if ( v16 >= 0 )
          {
            HIDWORD(v14) = *((_DWORD *)_EDI + 3);
            LODWORD(v14) = 0;
          }
          if ( v14 << v16 )
            goto LABEL_11;
          if ( *(_DWORD *)_EDI != v11 )
          {
            v10 = __ROR4__(v10, 4);
            *(_DWORD *)_EDI = v11;
          }
          __asm
          {
            ffree   st(2)
            fild    qword ptr [edi]
          }
          sub_804814F();
          __asm { fdivr   st, st(2) }
          v11 = *(_DWORD *)_EDI;
        }
      }
    }
    __asm { fxch    st(2) }
    sub_804814F();
    __asm { fstp    st }
    goto LABEL_15;
  }
LABEL_6:
  result = 1;
  __asm { fcompp }
  return result;
}
// 804806A: inconsistent fpu stack
// 8048122: control flows out of bounds to 804818B
// 804814F: using guessed type int sub_804814F(void);
// 80481FD: using guessed type int dword_80481FD;

//----- (08048151) --------------------------------------------------------
int __usercall sub_8048151@<eax>(char a1@<bl>, char *a2@<edi>, long double a3@<st0>)
{
  long double v4; // fst5
  char *v5; // edx
  char *v6; // ecx
  long double v7; // fst4
  long double v8; // fst4

  v4 = (long double)dword_80481FD;
  v5 = a2 + 56;
  v6 = a2 + 55;
  do
  {
    v7 = __FPREM__(a3, v4);
    *(_DWORD *)v5 = (int)v7;
    v8 = a3 - v7;
    a3 = v8 / v4;
    *v6-- = *v5 + 48;
  }
  while ( v8 != 0.0 );
  *v6 = a1;
  if ( a1 != 32 )
  {
    *v5 = a1;
    v5 = a2 + 57;
    ++v6;
  }
  return sys_write(1, v6, v5 - v6) - 1;
}
// 80481FD: using guessed type int dword_80481FD;

//----- (08048195) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(long double a1@<st0>)
{
  unsigned __int8 *v1; // esi
  int v2; // eax
  int v3; // eax
  int *v4; // ecx
  int v5; // esi
  size_t v6; // edx
  unsigned __int8 v7; // al
  unsigned __int8 v8; // al
  unsigned __int8 *v9; // [esp-8h] [ebp-8h]
  unsigned __int8 *v10; // [esp-4h] [ebp-4h]

  v1 = v9;
  if ( v9 )
  {
    do
    {
      LOBYTE(v2) = sub_8048068((long double *)dword_8048204, v1, a1);
      v1 = v10;
    }
    while ( v10 );
LABEL_3:
    v3 = sys_exit(v2);
  }
  while ( 1 )
  {
    v4 = &dword_8048204[6];
    v5 = 95;
    do
    {
      v2 = -sys_read(0, v4, 1u);
      if ( v2 >= 0 )
        goto LABEL_3;
      v7 = *(_BYTE *)v4;
    }
    while ( *(_BYTE *)v4 == 32 || v7 >= 9u && v7 < 0xEu );
    do
    {
      v4 = (int *)((char *)v4 + 1);
      if ( !--v5 )
        break;
      if ( sys_read(0, v4, v6) <= 0 )
        break;
      v8 = *(_BYTE *)v4;
      if ( *(_BYTE *)v4 == 32 )
        break;
    }
    while ( v8 < 9u || v8 >= 0xEu );
    *(_BYTE *)v4 = 0;
    sub_8048068((long double *)dword_8048204, (unsigned __int8 *)&dword_8048204[6], a1);
  }
}
// 80481A7: positive sp value 10 has been found
// 804819C: variable 'v9' is possibly undefined
// 80481A6: variable 'v10' is possibly undefined
// 80481AF: variable 'v2' is possibly undefined
// 80481BF: variable 'v4' is possibly undefined
// 80481DC: variable 'v6' is possibly undefined
// 8048204: using guessed type int dword_8048204[30];

// nfuncs=5 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
