/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(mode_t@<edx>, int@<ecx>, int@<ebp>);
// char __usercall sub_8048289@<al>(int@<edi>, int@<esi>);
void sub_80482AB();
// int __usercall sub_804830A@<eax>(int@<eax>);
// unsigned int __usercall sub_804832D@<eax>(unsigned int result@<eax>, _BYTE *@<edi>);
// unsigned __int8 __usercall sub_8048348@<al>(unsigned __int8 result@<al>, _BYTE *@<edi>);
char __fastcall sub_804835A(int, mode_t);

//-------------------------------------------------------------------------
// Data declarations

int dword_804804C[11] =
{
  1734439765,
  1746942565,
  544502639,
  1949114459,
  544435488,
  1869095005,
  1634628723,
  1528849773,
  1601400420,
  1987208563,
  1767862885
}; // weak
char byte_804807B = 'C'; // weak
char filename[] = "/etc/resolv.conf"; // idb
int dword_80483CC; // weak
int dword_80483D0; // weak
int timeout; // idb
int dword_80483EC[2]; // weak
__int16 word_80483F6; // weak
__int16 word_80483F8; // weak
__int16 word_80483FA; // weak
__int16 word_80483FC; // weak
int dword_8048404[128]; // weak
_UNKNOWN ufds; // weak
__int16 word_8048608; // weak
__int16 word_804860A; // weak
int dword_804860C[4]; // weak
int dword_804861C[128]; // weak


//----- (0804809F) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(mode_t a1@<edx>, int a2@<ecx>, int a3@<ebp>)
{
  unsigned int v3; // ebx
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax
  unsigned __int8 *v10; // esi
  int v11; // ebx
  int i; // eax
  unsigned __int8 v13; // al
  bool v14; // cf
  int v15; // esi
  bool v16; // sf
  unsigned __int16 v17; // dx
  int v18; // eax
  const char *v19; // esi
  const char *v20; // esi
  _WORD *v21; // esi
  _BYTE *v22; // esi
  int *v23; // esi
  int v24; // [esp-18h] [ebp-18h]
  _BYTE *v25; // [esp-10h] [ebp-10h]
  unsigned __int8 *v26; // [esp-Ch] [ebp-Ch]
  int v27; // [esp-8h] [ebp-8h]
  int v28; // [esp-4h] [ebp-4h]

  v3 = v24 - 1;
  if ( v24 == 1 )
    goto LABEL_2;
  timeout = 60000;
  v9 = (int)v25;
  if ( *v25 == 45 )
  {
    if ( v3 <= 2 )
    {
LABEL_2:
      v4 = sys_write(1, dword_804804C, 0x2Fu);
      v5 = 0;
      goto LABEL_3;
    }
    v10 = v26;
    v11 = 0;
    for ( i = 0; ; v11 = i + 10 * v11 )
    {
      v13 = *v10++;
      v14 = v13 < 0x30u;
      LOBYTE(i) = v13 - 48;
      if ( v14 || (unsigned __int8)i > 9u )
        break;
    }
    timeout = v11;
    v3 = v24 - 3;
    v9 = v27;
  }
  dword_80483CC = v9;
  if ( v3 != 1 )
    dword_80483D0 = v28;
  v15 = dword_80483D0;
  if ( dword_80483D0 || (LOBYTE(v5) = sub_804835A(a2, a1), v15) )
  {
    sub_80482AB();
    sub_8048289((int)dword_804860C, v15);
    dword_804860C[0] = 2;
    HIBYTE(dword_804860C[0]) = 53;
    __asm { int     80h; LINUX - sys_socket }
    a3 = 102;
    __asm
    {
      int     80h; LINUX - sys_setsockopt
      int     80h; LINUX - sys_connect
      int     80h; LINUX - sys_setsockopt
    }
    v16 = sys_ioctl(102, 21537) < 0;
    v5 = 1;
    if ( !v16 )
    {
      LOBYTE(v17) = HIBYTE(word_80483F6);
      HIBYTE(v17) = word_80483F6;
      v18 = sys_write(102, &word_80483F8, v17);
      ufds = 102;
      word_8048608 = 3;
      v5 = 168;
      __asm { int     80h; LINUX - sys_poll }
      if ( (word_804860A & 3) != 0 )
      {
        v19 = (const char *)&word_80483F6;
        v5 = sys_read(102, &word_80483F6, 0x200u);
        if ( v5 )
        {
          LOBYTE(v5) = HIBYTE(word_80483FC);
          BYTE1(v5) = word_80483FC;
          if ( (_WORD)v5 )
            v19 = (char *)&dword_8048404[1] + strlen((const char *)dword_8048404) + 1;
          while ( 1 )
          {
            v20 = &v19[strlen(v19) + 1];
            do
              LOBYTE(v5) = *v20++;
            while ( !(_BYTE)v5 );
            if ( (_BYTE)v5 == 1 )
              break;
            if ( (_BYTE)v5 != 5 )
              goto LABEL_3;
            v21 = v20 + 6;
            HIWORD(v5) = 0;
            BYTE1(v5) = *v21;
            LOBYTE(v5) = HIBYTE(*v21);
            v19 = (char *)v21 + (unsigned __int16)v5 + 2;
          }
          v22 = v20 + 7;
          LOBYTE(v5) = *v22;
          v23 = (int *)(v22 + 1);
          if ( (_BYTE)v5 == 4 )
            v5 = sub_804830A(*v23);
        }
      }
    }
  }
LABEL_3:
  if ( v5 )
  {
    if ( v5 == -111 )
      v6 = sys_write(1, &byte_804807B, 0x24u);
  }
  v7 = sys_close(a3);
  v8 = sys_exit(0);
}
// 804811E: positive sp value 18 has been found
// 80480A0: variable 'v24' is possibly undefined
// 80480B7: variable 'v5' is possibly undefined
// 80480E7: variable 'v25' is possibly undefined
// 80480F2: variable 'v26' is possibly undefined
// 804810F: variable 'v27' is possibly undefined
// 8048118: variable 'v28' is possibly undefined
// 804804C: using guessed type int dword_804804C[11];
// 804807B: using guessed type char byte_804807B;
// 80483CC: using guessed type int dword_80483CC;
// 80483D0: using guessed type int dword_80483D0;
// 80483F6: using guessed type __int16 word_80483F6;
// 80483F8: using guessed type __int16 word_80483F8;
// 80483FC: using guessed type __int16 word_80483FC;
// 8048404: using guessed type int dword_8048404[128];
// 8048608: using guessed type __int16 word_8048608;
// 804860A: using guessed type __int16 word_804860A;
// 804860C: using guessed type int dword_804860C[4];

//----- (08048289) --------------------------------------------------------
char __usercall sub_8048289@<al>(int a1@<edi>, int a2@<esi>)
{
  int v2; // edx
  int i; // ecx
  char j; // bl
  unsigned __int8 v5; // al
  bool v6; // cf
  char result; // al

  v2 = 0;
  for ( i = 0; i != 4; ++i )
  {
    for ( j = 0; ; j = result + 10 * j )
    {
      v5 = *(_BYTE *)(a2 + v2++);
      v6 = v5 < 0x30u;
      result = v5 - 48;
      if ( v6 )
        break;
    }
    *(_BYTE *)(a1 + i + 4) = j;
  }
  return result;
}

//----- (080482AB) --------------------------------------------------------
void sub_80482AB()
{
  char *v0; // esi
  int *v1; // edi
  char i; // cl
  char v3; // al
  _WORD *v4; // edi
  __int16 v5; // dx
  int *v6; // [esp-24h] [ebp-24h]

  v0 = (char *)dword_80483CC;
  v6 = dword_8048404;
  v1 = (int *)((char *)dword_8048404 + 1);
LABEL_2:
  for ( i = 0; ; ++i )
  {
    v3 = *v0++;
    if ( !v3 )
      break;
    if ( v3 == 46 )
    {
      *(_BYTE *)v6 = i;
      v6 = v1;
      v1 = (int *)((char *)v1 + 1);
      goto LABEL_2;
    }
    *(_BYTE *)v1 = v3;
    v1 = (int *)((char *)v1 + 1);
  }
  *(_BYTE *)v1 = 0;
  v4 = (_WORD *)((char *)v1 + 1);
  *v4++ = 256;
  *v4 = 256;
  *(_BYTE *)v6 = i;
  LOBYTE(v5) = (unsigned __int16)((char *)(v4 + 1) - (char *)&word_80483F8) >> 8;
  HIBYTE(v5) = (char *)(v4 + 1) - (char *)&word_80483F8;
  word_80483F6 = v5;
  word_80483F8 = 19794;
  word_80483FC = 256;
  word_80483FA = 1;
}
// 80483CC: using guessed type int dword_80483CC;
// 80483F6: using guessed type __int16 word_80483F6;
// 80483F8: using guessed type __int16 word_80483F8;
// 80483FA: using guessed type __int16 word_80483FA;
// 80483FC: using guessed type __int16 word_80483FC;
// 8048404: using guessed type int dword_8048404[128];

//----- (0804830A) --------------------------------------------------------
int __usercall sub_804830A@<eax>(int a1@<eax>)
{
  char v1; // t0
  unsigned int v2; // eax
  char v3; // t1

  v1 = BYTE1(a1);
  BYTE1(a1) = a1;
  LOBYTE(a1) = v1;
  v2 = __ROR4__(a1, 16);
  v3 = BYTE1(v2);
  BYTE1(v2) = v2;
  LOBYTE(v2) = v3;
  sub_804832D(v2, dword_80483EC);
  return sys_write(1, (char *)dword_80483EC + 1, 0);
}
// 80483EC: using guessed type int dword_80483EC[2];

//----- (0804832D) --------------------------------------------------------
unsigned int __usercall sub_804832D@<eax>(unsigned int result@<eax>, _BYTE *a2@<edi>)
{
  _BYTE *v2; // edi
  unsigned int v3; // ebx
  unsigned int v4; // eax

  *a2 = 10;
  v2 = a2 - 1;
  do
  {
    v3 = result;
    sub_8048348(result, v2);
    v4 = v3;
    LOBYTE(v4) = 46;
    *v2++ = 46;
    result = v4 >> 8;
  }
  while ( result );
  v2[1] = 32;
  return result;
}

//----- (08048348) --------------------------------------------------------
unsigned __int8 __usercall sub_8048348@<al>(unsigned __int8 result@<al>, _BYTE *a2@<edi>)
{
  do
  {
    *a2++ = result % 0xAu + 48;
    result /= 0xAu;
  }
  while ( result );
  return result;
}

//----- (0804835A) --------------------------------------------------------
char __fastcall sub_804835A(int a1, mode_t a2)
{
  int v2; // eax
  int v3; // ebx
  int v4; // eax
  int v5; // eax
  _BYTE *v6; // ecx
  _BYTE *v7; // esi
  unsigned __int8 *v8; // esi
  unsigned __int8 v9; // al
  unsigned __int8 *v10; // esi

  v2 = sys_open(filename, 0, a2);
  if ( v2 >= 0 )
  {
    v3 = v2;
    v4 = sys_read(v2, dword_804861C, 0x200u);
    v5 = sys_close(v3);
    v7 = v6;
    while ( 1 )
    {
      LOBYTE(v2) = *v7++;
      if ( !(_BYTE)v2 )
        break;
      if ( (_BYTE)v2 == 110 && *(_DWORD *)v7 == 1936026977 )
      {
        v7 += 4;
        if ( *(_DWORD *)v7 == 1702261349 )
        {
          v7 += 4;
          if ( *v7 == 114 )
          {
            v8 = v7 + 1;
            do
              v9 = *v8++;
            while ( v9 <= 0x20u );
            v10 = v8 - 1;
            do
              LOBYTE(v2) = *v10++;
            while ( (unsigned __int8)v2 >= 0x2Eu );
            *(v10 - 1) = 0;
            return v2;
          }
        }
      }
    }
  }
  return v2;
}
// 804837F: variable 'v6' is possibly undefined
// 804861C: using guessed type int dword_804861C[128];

// nfuncs=7 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
