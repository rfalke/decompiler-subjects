/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
// void __usercall sub_8048374(char *@<ebx>);
// char __usercall sub_804838B@<al>(unsigned int@<eax>, _BYTE *@<edi>);

//-------------------------------------------------------------------------
// Data declarations

char byte_80483A1[3] = { 'a', 's', 'm' }; // weak
char byte_80483B5[3] = { ' ', 'i', 'n' }; // weak
__int16 word_80483BE = 31264; // weak
char byte_80483C5[3] = { 'w', 'r', 'i' }; // weak
char byte_80483D1[3] = { '\x01', '\0', '.' }; // weak
char byte_80483F5[3]; // weak
char byte_80487F5[3]; // weak
const void *addr; // idb
int fd; // idb
int dword_804880D; // weak
int dword_8048811; // weak
int dword_8048815; // weak
int dword_8048819; // weak
int dword_804881D; // weak
const void *dword_8048821; // idb
int dword_8048825; // weak
int dword_8048829; // weak
__int16 word_804882D; // weak
__int16 word_804882F; // weak
__int16 word_8048831; // weak
__int16 word_8048833; // weak
__int16 word_8048835; // weak
__int16 word_8048837; // weak
int dword_8048839; // weak
__int16 word_804883D; // weak
__int16 word_804883F; // weak
char byte_8048C2D[3]; // weak


//----- (08048092) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // ebx
  int v3; // eax
  unsigned int v4; // eax
  int v5; // eax
  int v6; // eax
  char *v7; // ebx
  int v8; // eax
  int v9; // eax
  int v10; // eax
  unsigned int v11; // eax
  int v12; // eax
  __int64 v13; // rax
  unsigned __int64 v14; // rtt
  int v15; // eax
  int v16; // eax
  int v17; // eax
  int v18; // eax
  int v19; // eax
  char *v20; // edi
  char *v21; // ebx
  char *v22; // edi
  char *v23; // edi
  int v24; // eax
  int v25; // edi
  int v26; // ebx
  _BYTE *v27; // edi
  _DWORD *v28; // edi
  int v29; // ebx
  size_t v30; // edx
  int v31; // edx
  int v32; // ecx
  _BYTE *v33; // edi
  char *v34; // ecx
  size_t v35; // edx
  unsigned int v36; // esi
  int v37; // eax
  int v38; // eax
  int v39; // eax
  int v40; // eax
  int v41; // eax
  char *v42; // [esp-10h] [ebp-10h]
  char *v43; // [esp-Ch] [ebp-Ch]
  char *v44; // [esp-8h] [ebp-8h]
  int v45; // [esp-4h] [ebp-4h]
  char *v46; // [esp-4h] [ebp-4h]
  int v47; // [esp-4h] [ebp-4h]
  char *v48; // [esp-4h] [ebp-4h]

  v7 = v42;
  if ( !v42 )
    goto LABEL_27;
  if ( *(_WORD *)v42 == 26925 )
  {
    if ( !v43 )
      goto LABEL_27;
    sub_8048374(v43);
    dword_804880D = v8;
    v7 = v44;
    if ( !v44 )
      goto LABEL_27;
  }
  v9 = sys_open(v7, 2, a2);
  if ( v9 < 0 )
    goto LABEL_27;
  fd = v9;
  addr = v7;
  if ( v46 )
  {
    sub_8048374(v46);
  }
  else
  {
    v2 = v9;
    v3 = sys_ioctl(v9, 4704);
    v4 = dword_8048811 << 9;
    if ( !(dword_8048811 << 9) )
      v4 = sys_lseek(v2, 0, 2);
    if ( (int)(v4 - 6144) < 0 )
LABEL_27:
      v6 = sys_exit(1);
    v45 = v4 >> 10;
    v5 = sys_lseek(v2, 0, 0);
    v10 = v45;
  }
  if ( v10 >= 6 )
  {
    dword_8048811 = v10;
    v11 = sys_write(1, byte_80483A1, 0x14u);
    word_8048837 = 1024;
    word_804883F = 1;
    word_804883D = 5007;
    dword_8048839 = 268966912;
    LOWORD(v11) = dword_804880D;
    if ( !dword_804880D )
    {
      word_804882F = dword_8048811;
      v11 = dword_8048811 / 3u;
    }
    dword_804880D = ((_WORD)v11 + 31) & 0xFFE0;
    word_804882D = (v11 + 31) & 0xFFE0;
    word_8048831 = (dword_804880D + 0x2000) / 0x2000u;
    dword_8048815 = ((dword_804880D + 0x2000) / 0x2000u) << 10;
    v12 = dword_8048811 - ((unsigned __int16)((v11 + 31) & 0xFFE0) >> 5) - 2;
    LOWORD(v12) = v12 - word_8048831;
    v47 = v12;
    v13 = 0x1FFFLL * (unsigned int)v12;
    LODWORD(v14) = v13 + 1;
    HIDWORD(v14) = HIDWORD(v13);
    LODWORD(v13) = v14 / 0x2001;
    dword_804881D = v13;
    word_8048833 = v47 - v13;
    dword_8048819 = (v47 - (_DWORD)v13) << 10;
    dword_8048821 = byte_8048C2D;
    dword_8048825 = (int)&byte_8048C2D[dword_8048815];
    v15 = sys_write(1, addr, strlen((const char *)addr));
    *(_WORD *)byte_80487F5 = 8250;
    sub_804838B(dword_804880D, &byte_80487F5[2]);
    v16 = sys_write(1, byte_80487F5, 2u);
    v17 = sys_write(1, byte_80483B5, 9u);
    sub_804838B(dword_804881D, byte_80487F5);
    v18 = sys_write(1, byte_80487F5, 0);
    v19 = sys_write(1, &word_80483BE, 7u);
    v20 = (char *)dword_8048821;
    *(_BYTE *)dword_8048821 = 3;
    v21 = &v20[dword_8048815];
    v22 = &v20[(unsigned int)dword_804880D >> 3];
    *v22 = -2;
    v23 = v22 + 1;
    do
      *v23++ = -1;
    while ( v23 < v21 );
    v24 = (unsigned __int16)(word_8048831 + 2);
    LOWORD(v24) = word_8048833 + v24;
    dword_8048829 = ((unsigned int)dword_804880D >> 5) + v24;
    word_8048835 = ((unsigned int)dword_804880D >> 5) + v24;
    v25 = dword_8048825;
    *(_BYTE *)dword_8048825 = 3;
    v26 = v25 + dword_8048819;
    v27 = (_BYTE *)((dword_804881D + 1) / 8u + v25);
    *v27 |= ~((1 << ((dword_804881D + 1) % 8u)) - 1);
    v28 = v27 + 1;
    do
      *v28++ = -1;
    while ( (int)v28 <= v26 );
    v29 = fd;
    if ( sys_write(fd, byte_80483F5, 0x400u) >= 0
      && sys_write(v29, &word_804882D, v30) >= 0
      && sys_write(v29, dword_8048821, dword_8048819 + dword_8048815) >= 0 )
    {
      v48 = (char *)(v31 + v32);
      *(_WORD *)(v31 + v32) = 16877;
      __asm { int     80h; LINUX - sys_getuid }
      *(_WORD *)(v31 + v32 + 2) = 24;
      *(_DWORD *)(v31 + v32 + 4) = 64;
      v33 = (_BYTE *)(v31 + v32 + 8);
      *(_DWORD *)v33 = sys_time(0);
      v33 += 4;
      __asm { int     80h; LINUX - sys_getgid }
      *v33++ = 47;
      *v33 = 2;
      *(_WORD *)(v33 + 1) = dword_8048829;
      v34 = v48;
      v35 = 1024;
      v36 = (unsigned int)dword_804880D >> 5;
      while ( 1 )
      {
        v37 = sys_write(v29, v34, v35);
        v34 = byte_80483F5;
        if ( v37 < 0 )
          break;
        if ( !--v36 )
        {
          v38 = sys_write(v29, byte_80483D1, 0x40u);
          v39 = sys_exit(0);
        }
      }
    }
    v40 = sys_write(2, byte_80483C5, 0xCu);
    v41 = sys_exit(1);
  }
  goto LABEL_27;
}
// 804804C: positive sp value 18 has been found
// 8048094: variable 'v42' is possibly undefined
// 80480A3: variable 'v43' is possibly undefined
// 80480AA: variable 'v8' is possibly undefined
// 80480AF: variable 'v44' is possibly undefined
// 80480BA: variable 'a2' is possibly undefined
// 80480CE: variable 'v46' is possibly undefined
// 80480DC: variable 'v10' is possibly undefined
// 80482CC: variable 'v30' is possibly undefined
// 80482F9: variable 'v31' is possibly undefined
// 80482F9: variable 'v32' is possibly undefined
// 8048338: variable 'v35' is possibly undefined
// 80483BE: using guessed type __int16 word_80483BE;
// 804880D: using guessed type int dword_804880D;
// 8048811: using guessed type int dword_8048811;
// 8048815: using guessed type int dword_8048815;
// 8048819: using guessed type int dword_8048819;
// 804881D: using guessed type int dword_804881D;
// 8048825: using guessed type int dword_8048825;
// 8048829: using guessed type int dword_8048829;
// 804882D: using guessed type __int16 word_804882D;
// 804882F: using guessed type __int16 word_804882F;
// 8048831: using guessed type __int16 word_8048831;
// 8048833: using guessed type __int16 word_8048833;
// 8048835: using guessed type __int16 word_8048835;
// 8048837: using guessed type __int16 word_8048837;
// 8048839: using guessed type int dword_8048839;
// 804883D: using guessed type __int16 word_804883D;
// 804883F: using guessed type __int16 word_804883F;

//----- (08048374) --------------------------------------------------------
void __usercall sub_8048374(char *a1@<ebx>)
{
  int v2; // ebx
  int i; // eax
  char v4; // bl

  v2 = 0;
  for ( i = 0; ; i = v2 + 10 * i )
  {
    v4 = *a1++;
    LOBYTE(v2) = v4 - 48;
    if ( (v2 & 0x80u) != 0 )
      break;
  }
  JUMPOUT(0x80483A0);
}
// 8048383: control flows out of bounds to 80483A0

//----- (0804838B) --------------------------------------------------------
char __usercall sub_804838B@<al>(unsigned int a1@<eax>, _BYTE *a2@<edi>)
{
  int v2; // ecx
  unsigned int v3; // et2
  char result; // al
  char v5; // [esp-4h] [ebp-4h]

  v2 = 0;
  do
  {
    v3 = a1 % 0xA;
    a1 /= 0xAu;
    ++v2;
    v5 = v3;
  }
  while ( a1 );
  do
  {
    result = v5 + 48;
    *a2++ = v5 + 48;
    --v2;
  }
  while ( v2 );
  return result;
}

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
