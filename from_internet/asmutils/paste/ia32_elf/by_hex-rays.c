/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
// char __usercall sub_8048156@<al>(char result@<al>);
int sub_8048172();

//-------------------------------------------------------------------------
// Data declarations

char aPasteDDelimFil[39] = "paste [-d delim] file file [file ...]\n"; // weak
size_t len = 38u; // idb
char aUnableToReadIn[27] = "Unable to read input file\n"; // weak
size_t dword_80481D8 = 26u; // idb
char byte_80481DC[]; // weak
int fd; // idb
size_t dword_80495DC; // idb
int dword_80495E0; // weak
char byte_80495E4; // weak
char byte_80495E5; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // ebp
  int v3; // esi
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // eax
  int v8; // ebp
  int v9; // edi
  int v10; // eax
  int v11; // eax
  int v12; // [esp-10h] [ebp-10h]
  char *v13; // [esp-8h] [ebp-8h]
  char *v14; // [esp-4h] [ebp-4h]

  v2 = v12 - 1;
  if ( v12 == 1 )
    goto LABEL_11;
  v3 = 0;
  byte_80495E5 = 9;
  while ( 1 )
  {
    if ( *(_WORD *)v13 == 25645 )
    {
      if ( !--v2 )
        goto LABEL_11;
      byte_80495E5 = *v14;
    }
    else
    {
      v4 = sys_open(v13, 0, a2);
      if ( v4 < 0 )
      {
LABEL_13:
        v7 = sys_write(2, aUnableToReadIn, dword_80481D8);
        goto LABEL_12;
      }
      *(int *)((char *)&fd + v3) = v4;
      v3 += 4;
    }
    if ( !--v2 )
    {
      if ( v3 )
      {
        dword_80495E0 = v3;
        dword_80495DC = 0;
        v8 = 0;
        v9 = fd;
        while ( 1 )
        {
          if ( *(int *)((char *)&fd + v8) )
          {
            while ( 1 )
            {
              v10 = sys_read(v9, &byte_80495E4, 1u);
              if ( v10 < 0 )
                goto LABEL_13;
              if ( !v10 )
                break;
              if ( byte_80495E4 == 10 )
                goto LABEL_21;
              sub_8048156(byte_80495E4);
            }
            dword_80495E0 -= 4;
            if ( !dword_80495E0 )
              v11 = sys_exit(0);
            *(int *)((char *)&fd + v8) = 0;
          }
LABEL_21:
          v8 += 4;
          if ( v8 == v3 )
          {
            sub_8048156(10);
            sub_8048172();
            v8 = 0;
            v9 = fd;
          }
          else
          {
            v9 = *(int *)((char *)&fd + v8);
            sub_8048156(byte_80495E5);
          }
        }
      }
LABEL_11:
      v5 = sys_write(2, aPasteDDelimFil, len);
LABEL_12:
      v6 = sys_exit(1);
    }
  }
}
// 8048085: positive sp value 10 has been found
// 804804D: variable 'v12' is possibly undefined
// 804805B: variable 'v13' is possibly undefined
// 8048069: variable 'a2' is possibly undefined
// 8048087: variable 'v14' is possibly undefined
// 80495E0: using guessed type int dword_80495E0;
// 80495E4: using guessed type char byte_80495E4;
// 80495E5: using guessed type char byte_80495E5;

//----- (08048156) --------------------------------------------------------
char __usercall sub_8048156@<al>(char result@<al>)
{
  size_t v1; // ebx
  size_t v2; // ebx

  v1 = dword_80495DC;
  byte_80481DC[dword_80495DC] = result;
  v2 = v1 + 1;
  if ( v2 == 1024 )
    JUMPOUT(0x8048178);
  dword_80495DC = v2;
  return result;
}
// 8048169: control flows out of bounds to 8048178

//----- (08048172) --------------------------------------------------------
int sub_8048172()
{
  int result; // eax

  result = sys_write(1, byte_80481DC, dword_80495DC);
  dword_80495DC = 0;
  return result;
}

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
