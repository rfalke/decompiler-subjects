/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall sub_804804C@<eax>(unsigned int@<eax>, _BYTE *@<edi>);
// int __usercall sub_804805F@<eax>(unsigned int@<eax>, _BYTE *@<edi>);
// int __usercall sub_804806E@<eax>(unsigned int@<eax>, _BYTE *@<edi>);
void __cdecl __noreturn start(unsigned int, unsigned int, unsigned int);

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "/var/run/utmp"; // idb
char byte_804821A; // weak
char byte_804821B; // weak
int fd; // idb


//----- (0804804C) --------------------------------------------------------
int __usercall sub_804804C@<eax>(unsigned int a1@<eax>, _BYTE *a2@<edi>)
{
  int v2; // eax
  int v3; // edx
  __int64 v4; // rt2
  int result; // eax

  v4 = a1 % 10LL;
  v2 = a1 / 10LL;
  v3 = v4;
  if ( v2 )
    *a2++ = v2 + 48;
  result = v3 + 48;
  *a2 = v3 + 48;
  return result;
}

//----- (0804805F) --------------------------------------------------------
int __usercall sub_804805F@<eax>(unsigned int a1@<eax>, _BYTE *a2@<edi>)
{
  int v2; // edx
  int result; // eax

  v2 = a1 % 10LL;
  *a2 = a1 / 10LL + 48;
  result = v2 + 48;
  a2[1] = v2 + 48;
  return result;
}

//----- (0804806E) --------------------------------------------------------
int __usercall sub_804806E@<eax>(unsigned int a1@<eax>, _BYTE *a2@<edi>)
{
  signed int v3; // [esp-4h] [ebp-4h]

  v3 = (a1 >> 5) + 10;
  sub_804804C(v3 >> 11, a2);
  *a2 = 46;
  return sub_804805F((100 * (v3 & 0x7FF)) >> 11, a2 + 1);
}

//----- (08048092) --------------------------------------------------------
void __cdecl __noreturn start(unsigned int a1, unsigned int a2, unsigned int a3)
{
  int v3; // eax
  int v4; // ebp
  signed int v5; // eax
  __int16 v6; // ax
  char *v7; // edi
  int v8; // eax
  unsigned int v9; // eax
  unsigned int v10; // eax
  __int64 v11; // rt2
  unsigned int v12; // eax
  _BYTE *v13; // edi
  _BYTE *v14; // edi
  unsigned int v15; // ebp
  mode_t v16; // edx
  int v17; // eax
  int v18; // eax
  _BYTE *v19; // edi
  int v20; // eax
  int v21[95]; // [esp+0h] [ebp-180h] BYREF
  unsigned int v22; // [esp+17Ch] [ebp-4h]
  unsigned int retaddr; // [esp+180h] [ebp+0h] BYREF

  v3 = sys_gettimeofday((struct timeval *)&retaddr, 0);
  *(&byte_804821B - 1) = 32;
  v4 = 0;
  v5 = (unsigned int)((unsigned int)(retaddr % 31536000LL) % 86400LL) / 3600LL;
  if ( v5 > 12 )
  {
    v5 -= 12;
    v4 = 1;
  }
  sub_804804C(v5, &byte_804821B);
  byte_804821B = 58;
  sub_804805F(
    (unsigned int)((unsigned int)((unsigned int)(retaddr % 31536000LL) % 86400LL) % 3600LL) / 60LL,
    &byte_804821B + 1);
  v6 = 28001;
  if ( v4 )
    v6 = 28016;
  *(_WORD *)(&byte_804821B + 1) = v6;
  *(_DWORD *)(&byte_804821B + 3) = 1886724128;
  *(_WORD *)(&byte_804821B + 7) = 8224;
  v7 = &byte_804821B + 9;
  v8 = sys_sysinfo((struct sysinfo *)&retaddr);
  v9 = retaddr % 31536000LL;
  v11 = v9 % 86400LL;
  v10 = v9 / 86400LL;
  v22 = v11;
  if ( v10 )
  {
    sub_804804C(v10, v7);
    *(_DWORD *)v7 = 2036425760;
    *(_DWORD *)(&byte_804821B + 13) = 538979443;
    v7 = &byte_804821B + 17;
  }
  v12 = v22 / 3600LL;
  v22 %= 3600LL;
  sub_804804C(v12, v7);
  *v7 = 58;
  v13 = v7 + 1;
  sub_804805F(v22 / 60LL, v13);
  *(_WORD *)v13 = 8236;
  v14 = v13 + 2;
  v15 = 0;
  v17 = sys_open(filename, 0, v16);
  if ( v17 >= 0 )
  {
    fd = v17;
    do
    {
      v18 = sys_read(fd, v21, 0x180u);
      if ( v21[0] == 7 )
        ++v15;
    }
    while ( v18 );
  }
  sub_804804C(v15, v14);
  qmemcpy(v14, " users, load average", 20);
  *(_WORD *)(v14 + 21) = 8250;
  v19 = v14 + 23;
  sub_804806E(a1, v19);
  *(_WORD *)v19 = 8236;
  v19 += 2;
  sub_804806E(a2, v19);
  *(_WORD *)v19 = 8236;
  v19 += 2;
  sub_804806E(a3, v19);
  *v19 = 10;
  v20 = sys_exit(sys_write(1, &byte_804821A, 0x50u));
}
// 8048165: variable 'v16' is possibly undefined
// 804821A: using guessed type char byte_804821A;
// 804821B: using guessed type char byte_804821B;
// 8048092: using guessed type int var_180[95];

// nfuncs=4 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
