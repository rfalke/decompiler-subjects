/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int sub_80480A4();
void __fastcall __noreturn start(int, mode_t);
void sub_8048289();
void sub_80482D0();
int sub_804831E();
// int __usercall sub_804836C@<eax>(unsigned int@<eax>, _BYTE *@<edi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_804804C[22] =
{
  113,
  134512821,
  81,
  134512821,
  4283163,
  134513192,
  4348699,
  134513202,
  10,
  134513202,
  32,
  134513216,
  2117491483,
  134513216,
  2117425947,
  134513256,
  98,
  134513256,
  2117360411,
  134513273,
  2117163803,
  134513285
}; // weak
char byte_8048394 = '\n'; // weak
char byte_8048395[3] = { '\x1B', '[', '2' }; // weak
__int16 word_804839E = 23323; // weak
char byte_80483A3 = ']'; // weak
int fd; // idb
char byte_80483AD[3]; // weak
__int16 word_80483FD; // weak
__int16 word_80483FF; // weak
int dword_8048435; // weak
char byte_804844D[3]; // weak
int dword_8048451; // weak
int dword_8048455; // weak
int dword_8048459; // weak
char byte_804845D[3]; // weak


//----- (080480A4) --------------------------------------------------------
int sub_80480A4()
{
  return sys_write(1, &byte_8048394, 1u);
}
// 8048394: using guessed type char byte_8048394;

//----- (080480D3) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // eax
  int v3; // eax
  int v4; // eax
  _WORD *v5; // edx
  int v6; // eax
  int v7; // ecx
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int v11; // eax
  int v12; // edx
  int v13; // edx
  int v14; // eax
  int v15; // eax
  int v16; // eax
  _DWORD *v17; // ecx
  int *v18; // ebx
  int v19; // ecx
  int v20; // edx
  int v21; // [esp-Ch] [ebp-Ch]
  char *v22; // [esp-4h] [ebp-4h]
  int v23; // [esp-4h] [ebp-4h]

  if ( v21 != 1 )
  {
    fd = sys_open(v22, 0, a2);
    if ( fd < 0 )
      v3 = sys_exit(1);
  }
  if ( sys_ioctl(fd, 21505) >= 0 )
    v2 = sys_exit(0);
  v4 = sys_ioctl(1, 21523);
  --*v5;
  if ( v4 )
    *(_DWORD *)v5 = 5242904;
  v6 = sys_ioctl(2, 21505);
  v8 = sys_ioctl(2, v7);
  dword_8048435 &= 0xFFFFFFF4;
  v9 = sys_ioctl(2, 21506);
  sub_8048289();
  sub_80482D0();
  while ( 1 )
  {
    v10 = sys_write(1, byte_8048395, 8u);
    sub_804831E();
    v11 = sys_write(1, &word_804839E, 5u);
    sub_804836C(dword_8048459, byte_80483AD);
    v23 = v12 + 1;
    byte_80483AD[0] = 47;
    sub_804836C(dword_8048455, &byte_80483AD[1]);
    v14 = sys_write(1, byte_80483AD, v23 + v13);
    v15 = sys_write(1, &byte_80483A3, 6u);
LABEL_9:
    *(_DWORD *)byte_804844D = 0;
    v16 = sys_read(2, byte_804844D, 4u);
    v18 = dword_804804C;
    while ( *v17 != *v18 )
    {
      v18 += 2;
      if ( v18 == (int *)sub_80480A4 )
        goto LABEL_9;
    }
    ((void (__fastcall *)(int, int))v18[1])(dword_8048459, dword_8048455);
    dword_8048459 = v19;
    dword_8048455 = v20;
  }
}
// 80480CC: positive sp value C has been found
// 80480D6: variable 'v21' is possibly undefined
// 80480DE: variable 'v22' is possibly undefined
// 804811C: variable 'v5' is possibly undefined
// 8048146: variable 'v7' is possibly undefined
// 80481A4: variable 'v12' is possibly undefined
// 80481B4: variable 'v13' is possibly undefined
// 80481E9: variable 'v17' is possibly undefined
// 8048217: variable 'v19' is possibly undefined
// 804821D: variable 'v20' is possibly undefined
// 804804C: using guessed type int dword_804804C[22];
// 804839E: using guessed type __int16 word_804839E;
// 80483A3: using guessed type char byte_80483A3;
// 80483FD: using guessed type __int16 word_80483FD;
// 8048435: using guessed type int dword_8048435;
// 8048455: using guessed type int dword_8048455;
// 8048459: using guessed type int dword_8048459;

//----- (08048289) --------------------------------------------------------
void sub_8048289()
{
  int v0; // ebp
  int v1; // eax
  int v2; // eax
  int v3; // edx
  unsigned int v4; // [esp-2Ch] [ebp-2Ch]
  int v5; // [esp-28h] [ebp-28h]

  v0 = 134521949;
  do
  {
    v1 = sys_read(fd, byte_804845D, 0x2000u);
    if ( !v1 )
      break;
    v5 = v1;
    v4 = v1;
    v2 = sys_brk((void *)(v0 + v1));
    qmemcpy((void *)v0, byte_804845D, v4);
    v0 += v4;
  }
  while ( v3 == v5 );
  dword_8048451 = v0;
  *(_DWORD *)v0 = 134521949;
}
// 80482C3: variable 'v3' is possibly undefined
// 8048451: using guessed type int dword_8048451;

//----- (080482D0) --------------------------------------------------------
void sub_80482D0()
{
  int v0; // esi
  int *v1; // ebp
  int v2; // ecx
  int v3; // edx
  char *v4; // edi
  char v5; // al
  int v6; // eax

  v0 = 134521949;
  v1 = (int *)dword_8048451;
  v2 = dword_8048451 - 134521949;
  v3 = 0;
  v4 = (char *)dword_8048451;
  do
  {
    v5 = *(_BYTE *)v0++;
    if ( v5 == 10 )
      goto LABEL_6;
    if ( v5 == 9 )
      v3 |= 7u;
    if ( (__int16)++v3 >= word_80483FF )
    {
LABEL_6:
      if ( (int)v4 <= (int)++v1 )
      {
        v4 += 1024;
        v6 = sys_brk(v4);
      }
      *v1 = v0;
      ++dword_8048455;
      v3 = 0;
    }
    --v2;
  }
  while ( v2 );
}
// 804831A: variable 'v2' is possibly undefined
// 80483FF: using guessed type __int16 word_80483FF;
// 8048451: using guessed type int dword_8048451;
// 8048455: using guessed type int dword_8048455;

//----- (0804831E) --------------------------------------------------------
int sub_804831E()
{
  int v0; // ecx
  int v1; // edx
  int v2; // ebp
  int result; // eax
  int v4; // [esp-Ch] [ebp-Ch]
  int v5; // [esp-8h] [ebp-8h]
  int v6; // [esp-4h] [ebp-4h]

  v0 = dword_8048455 - dword_8048459;
  v1 = 4 * dword_8048459;
  v2 = 4 * dword_8048459 + dword_8048451;
  if ( dword_8048455 - dword_8048459 > (unsigned __int16)word_80483FD )
    v0 = (unsigned __int16)word_80483FD;
  do
  {
    v6 = v0;
    v5 = v1;
    v4 = *(_DWORD *)(v2 + 4);
    result = sys_write(1, *(const void **)v2, v4 - *(_DWORD *)v2);
    if ( *(_BYTE *)(v4 - 1) != 10 )
      result = sub_80480A4();
    v2 += 4;
    v1 = v5;
    v0 = v6 - 1;
  }
  while ( v6 != 1 );
  return result;
}
// 80483FD: using guessed type __int16 word_80483FD;
// 8048451: using guessed type int dword_8048451;
// 8048455: using guessed type int dword_8048455;
// 8048459: using guessed type int dword_8048459;

//----- (0804836C) --------------------------------------------------------
int __usercall sub_804836C@<eax>(unsigned int a1@<eax>, _BYTE *a2@<edi>)
{
  int v2; // ecx
  int v3; // edx
  __int64 v4; // rt2
  int result; // eax
  int v6; // [esp-4h] [ebp-4h]

  v2 = 0;
  if ( a1 )
  {
    while ( a1 )
    {
      v4 = a1 % 10LL;
      a1 /= 10LL;
      v3 = v4;
      LOBYTE(v3) = v4 | 0x30;
      v6 = v3;
      ++v2;
    }
  }
  else
  {
    v6 = 48;
    v2 = 1;
  }
  do
  {
    result = v6;
    *a2++ = v6;
    --v2;
  }
  while ( v2 );
  return result;
}
// 804838B: variable 'v6' is possibly undefined

// nfuncs=6 queued=6 decompiled=6 lumina nreq=0 worse=0 better=0
// ALL OK, 6 function(s) have been successfully decompiled
