// subject_seg08048000.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0804804C: Register uipr32 fn0804804C(Register (ptr32 byte) esi)
// Called from:
//      fn0804808E
uipr32 fn0804804C(byte * esi)
{
	uipr32 eax_29 = 0x00;
	while (true)
	{
		word16 eax_16_16_24 = SLICE(eax_29, word16, 16);
		uint16 ax_22 = (word16) eax_29;
		cu8 cl_15 = *esi;
		if (cl_15 < 0x30)
			break;
		uint32 ecx_28 = (uint32) (cl_15 - 0x30);
		if (cl_15 > 0x39 || cl_15 < 0x30)
			return eax_29;
		eax_29 = SEQ(eax_16_16_24, ax_22 * 0x0A) + ecx_28;
		++esi;
	}
	return eax_29;
}

// 08048068: FlagGroup bool fn08048068(Register Eq_30 edx, Register (ptr32 char) ebx, Register out ptr32 edxOut, Register out Eq_33 ebxOut)
// Called from:
//      fn0804808E
bool fn08048068(Eq_30 edx, char * ebx, ptr32 & edxOut, union Eq_33 & ebxOut)
{
	ptr32 fp;
	Eq_33 eax_11 = sys_open(ebx, 0x00, edx);
	if (eax_11 < 0x00)
		fn08048086();
	else
	{
		bool Z_32 = SLICE(cond(sys_ioctl(eax_11, 0x4B33, fp - 16)), bool, 2);
		edxOut = fp - 16;
		ebxOut = eax_11;
		return Z_32;
	}
}

// 08048086: void fn08048086()
// Called from:
//      fn08048068
//      fn0804808E
void fn08048086()
{
	sys_exit(0x01);
}

// 0804808E: void fn0804808E(Register Eq_30 edx, Stack word32 dwArg00, Stack (ptr32 Eq_68) dwArg04, Stack (ptr32 byte) dwArg08)
void fn0804808E(Eq_30 edx, word32 dwArg00, struct Eq_68 * dwArg04, byte * dwArg08)
{
	ptr32 fp;
	Eq_30 edx_8;
	uint32 ebx_15;
	if (!fn08048068(edx, "/dev/tty0", out edx_8, out ebx_15))
	{
		word32 edx_132;
		if (fn08048068(edx_8, "/dev/console", out edx_132, out ebx_15))
			fn08048086();
	}
	struct Eq_68 * esi_30 = dwArg04;
	struct Eq_80 * esp_111 = fp + 8;
	do
	{
		esi_30 = esi_133 + 1;
		esi_133 = esi_30;
	} while (esi_133->b0000 != 0x00);
	if (esi_30->dwFFFFFFFB == 0x74766863)
	{
		if (dwArg00 != 0x02)
			fn08048086();
		esp_111 = fp + 0x0C;
		if (dwArg08 != null)
		{
			uint32 eax_90 = fn0804804C(dwArg08);
			sys_ioctl(ebx_15, 22022, eax_90);
			sys_ioctl(ebx_15, 22023, eax_90);
			esp_111 = fp + 0x0C;
		}
l080480DF:
		esp_111->dwFFFFFFFC = 0x01;
		sys_exit(0x00);
	}
	uint32 eax_43 = 0x00;
	if (dwArg00 != 0x01)
	{
l080480EB:
		byte * esi_51 = esp_111->dw0000;
		++esp_111;
		if (esi_51 == null)
			goto l080480DF;
		eax_43 = fn0804804C(esi_51);
	}
	word32 * esp_76 = esp_111 - 4;
	*esp_76 = 0x36;
	sys_ioctl(ebx_15, 22024, eax_43);
	esp_111 = (struct Eq_80 *) (esp_76 + 1);
	goto l080480EB;
}

char g_str8048105[] = "/dev/tty0"; // 08048105
char g_str804810F[] = "/dev/console"; // 0804810F
