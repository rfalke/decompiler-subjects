// subject_seg08048000.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 0804804C: Register int32 fn0804804C(Register (ptr32 byte) esi)
// Called from:
//      fn08048072
int32 fn0804804C(byte * esi)
{
	int32 edx_21 = 0x00;
	do
	{
		ci8 al_11 = *esi;
		++esi;
	} while (al_11 <= 33);
	while (al_11 > 0x2F && al_11 <= 0x3A)
	{
		edx_21 += (uint32) (al_11 - 0x30);
		al_11 = *esi;
		++esi;
		if (al_11 <= 0x2F || al_11 > 0x3A)
			return edx_21;
		edx_21 *= 0x0A;
	}
	return edx_21;
}

// 08048072: void fn08048072(Stack ui32 dwArg00, Stack (ptr32 Eq_34) dwArg08, Stack (ptr32 byte) dwArg0C)
void fn08048072(ui32 dwArg00, struct Eq_34 * dwArg08, byte * dwArg0C)
{
	ptr32 fp;
	char ** esp_46 = fp + 4;
	struct Eq_40 * ebp_7 = fp + 4 + dwArg00 * 0x04;
	if (dwArg00 == 0x01)
	{
l0804810B:
		int32 * esp_63 = esp_46 - 4;
		*esp_63 = 0x7F;
		int32 ebx_65 = *esp_63;
		*esp_63 = 0x01;
		sys_exit(ebx_65);
	}
	else
	{
		int32 eax_21;
		ptr32 esp_14 = fp + 0x0C;
		if (dwArg08->b0000 == 0x2D)
		{
			byte * esi_24 = &dwArg08->b0001;
			if (dwArg08->b0001 == 110)
			{
				esi_24 = dwArg0C;
				esp_14 = fp + 16;
			}
			eax_21 = fn0804804C(esi_24);
		}
		else
		{
			esp_14 = fp + 0x08;
			eax_21 = 0x0A;
		}
		struct Eq_120 * esp_43 = esp_14 - 4;
		esp_43->dw0000 = 0x61;
		sys_setpriority(0x00, 0x00, eax_21);
		esp_46 = &esp_43->ptr0004;
		ui32 ecx_48 = 0x00;
		do
		{
			struct Eq_94 * esi_55 = ebp_7->a0004[ecx_48];
			if (esi_55 == null)
				goto l0804810B;
			++ecx_48;
			if (esi_55->dw0000 != 0x48544150)
				continue;
			byte * esi_102 = &esi_55->b0004 + 1;
		} while (esi_55->b0004 != 0x3D);
		int32 ecx_94 = ~0x00 - (strlen(esp_43->ptr0004) + 1) + (~0x00 - (strlen(&esi_55->b0004 + 1) + 1));
		while (true)
		{
			byte * edi_105 = esp_14 + ecx_94;
			do
			{
				byte al_101 = *esi_102;
				++esi_102;
				if (al_101 == 0x3A)
					break;
				*edi_105 = al_101;
				++edi_105;
			} while (al_101 != 0x00);
			struct Eq_138 * esp_115 = esp_14 - 4;
			esp_115->ptr0000 = esi_102;
			byte * esi_118 = esp_115->ptr0004;
			*edi_105 = 0x2F;
			byte * edi_122 = edi_105 + 1;
			do
			{
				byte al_125 = *esi_118;
				*edi_122 = al_125;
				++esi_118;
				++edi_122;
			} while (al_125 != 0x00);
			esi_102 = esp_115->ptr0000;
			esp_115->ptr0000 = (byte *) 11;
			sys_execve((char *) &esp_115->ptr0004 + ecx_94, &esp_115->ptr0004, ebp_7->a0004);
		}
	}
}

