/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __fastcall sub_804804C(int, mode_t);
void __fastcall start(int, mode_t);
// char __usercall sub_8048364@<al>(int@<ecx>, _BYTE *@<edi>, char *@<esi>);
// __int64 __usercall sub_80484FE@<edx:eax>(unsigned int@<eax>, unsigned int@<edx>, _BYTE *@<edi>);
_BYTE *__fastcall sub_804851A(int);
// char __usercall sub_8048538@<al>(int@<ecx>, _BYTE *@<edi>, char *@<esi>);
// char __usercall sub_8048560@<al>(char *@<esi>, _BYTE *);

//-------------------------------------------------------------------------
// Data declarations

char filename[] = "/var/run/utmp"; // idb
char aEtcPasswd[] = "/etc/passwd"; // idb
char byte_80485BF = 'L'; // weak
char directory[] = "/dev"; // idb
char byte_80485FF = 'L'; // weak
__int16 word_8048606 = 24910; // weak
int dword_804860C[2] = { 1701996868, 1919906915 }; // weak
char byte_8048617 = 'S'; // weak
__int16 word_8048632 = 28492; // weak
char byte_804863F = 'T'; // weak
int dword_8048656; // weak
time_t time; // idb
int dword_804865E; // idb
int fd; // idb
int dword_8048666; // weak
struct stat buf; // idb
__int16 word_80486D6; // weak
__int16 word_80486F6; // weak
__int16 word_804882A; // weak


//----- (0804804C) --------------------------------------------------------
int __fastcall sub_804804C(int a1, mode_t a2)
{
  int v2; // eax
  mode_t v3; // edx
  int v4; // eax

  dword_804865E = sys_open(filename, 0, a2);
  v2 = sys_chdir(directory);
  fd = sys_open(aEtcPasswd, 0, v3);
  v4 = sys_newfstat(fd, &buf);
  __asm { int     80h; LINUX - sys_mmap2 }
  dword_8048666 = 192;
  return sys_time(&time);
}
// 8048071: variable 'v3' is possibly undefined
// 8048666: using guessed type int dword_8048666;

//----- (080480B0) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall start(int a1, mode_t a2)
{
  int v2; // eax
  __int16 *v3; // edi
  unsigned int v4; // ecx
  char v5; // al
  char *v6; // esi
  char *v7; // edi
  unsigned int v8; // ecx
  char *v9; // edi
  unsigned int v10; // ecx
  char tv_sec; // al
  char *v12; // esi
  char *v13; // edi
  int v14; // eax
  unsigned int v15; // eax
  unsigned int v16; // edx
  __int64 v17; // rt2
  __int64 v18; // rax
  _BYTE *v19; // edi
  unsigned int v20; // eax
  unsigned int v21; // edx
  __int64 v22; // rt2
  __int64 v23; // rax
  _BYTE *v24; // edi
  _BYTE *v25; // edi
  char v26; // al
  char *v27; // esi
  __int16 *v28; // edi
  int v29; // ecx
  bool v30; // zf
  int v31; // eax
  int v32; // eax
  int v33; // esi
  char *v34; // ebp
  char *v35; // edi
  unsigned int v36; // ecx
  char v37; // al
  char *v38; // esi
  char *v39; // edi
  _BYTE *v40; // edi
  int v41; // ecx
  char *v42; // esi
  char v43; // al
  int v44; // eax
  _BYTE *v45; // edi
  char v46; // al
  unsigned int v47; // ecx
  _BYTE *v48; // edi
  _BYTE *v49; // edi
  char v50; // al
  int v51; // eax
  int v52; // ecx
  __int16 *v53; // esi
  char *v54; // edi
  _BYTE *v55; // edi
  int v56; // ecx
  char v57; // al
  char *v58; // esi
  int v59; // eax
  int v60; // eax
  int v61; // eax
  char *v62; // [esp+F4h] [ebp-Ch]
  int v63; // [esp+F8h] [ebp-8h]
  const char *v64; // [esp+FCh] [ebp-4h]

  sub_804804C(a1, a2);
  if ( v63 == 1 )
  {
    if ( v64[strlen(v64) - 1] == 100 )
    {
      __asm
      {
        int     80h; LINUX - sys_signal
        int     80h; LINUX - sys_socket
      }
      dword_8048656 = 102;
      __asm
      {
        int     80h; LINUX - sys_bind
        int     80h; LINUX - sys_listen
      }
      v32 = sys_close(1);
      while ( 1 )
      {
        __asm
        {
          int     80h; LINUX - sys_accept
          int     80h; LINUX - sys_fork
        }
      }
    }
    v2 = sys_write(1, &byte_80485BF, 0x3Bu);
    while ( sys_read(dword_804865E, &buf.st_mtim, 0x180u) )
    {
      if ( buf.st_mtim.tv_sec == 7 )
      {
        v3 = &word_804882A;
        v4 = 11;
        v5 = word_80486D6;
        v6 = (char *)&word_80486D6 + 1;
        do
        {
          *(_BYTE *)v3 = v5;
          v3 = (__int16 *)((char *)v3 + 1);
          --v4;
          v5 = *v6++;
        }
        while ( v5 );
        memset(v3, 32, v4);
        v7 = (char *)v3 + v4;
        sub_804851A(11 - v4);
        v8 = 22 - v8;
        memset(v7, 32, v8);
        v9 = &v7[v8];
        v10 = 8;
        tv_sec = buf.st_ctim.tv_sec;
        v12 = (_BYTE *)(&buf + 73);
        do
        {
          *v9++ = tv_sec;
          --v10;
          tv_sec = *v12++;
        }
        while ( tv_sec );
        memset(v9, 32, v10);
        v13 = &v9[v10];
        if ( sys_newstat((const char *)&buf.st_ctim, &buf) >= 0 )
        {
          v14 = time - LODWORD(buf.st_rdev);
          if ( time - LODWORD(buf.st_rdev) <= 60 )
          {
            *(_DWORD *)v13 = 538976288;
            *((_DWORD *)v13 + 1) = 538976288;
            *((_WORD *)v13 + 3) = 8224;
            v13[7] = 45;
            v25 = v13 + 8;
          }
          else
          {
            v17 = (unsigned int)v14 % 86400LL;
            v15 = (unsigned int)v14 / 86400LL;
            v16 = v17;
            if ( v15 )
            {
              v18 = sub_80484FE(v15, v16, v13);
            }
            else
            {
              v18 = v16;
              *(_DWORD *)v13 = 538976288;
            }
            v19 = v13 + 3;
            v22 = v18 % 3600;
            v20 = v18 / 3600;
            v21 = v22;
            if ( v20 )
            {
              v23 = sub_80484FE(v20, v21, v19);
            }
            else
            {
              v23 = v21;
              *(_DWORD *)v19 = 538976288;
            }
            v24 = v19 + 3;
            sub_80484FE(v23 / 60, v23 % 60, v24);
            v25 = v24 + 2;
          }
          v26 = word_80486F6;
          v27 = (char *)&word_80486F6 + 1;
          if ( (_BYTE)word_80486F6 )
          {
            *(_DWORD *)v25 = 538976288;
            *((_DWORD *)v25 + 1) = 538976288;
            v25 += 4;
            do
            {
              *v25++ = v26;
              v26 = *v27++;
            }
            while ( v26 );
          }
          *v25 = 10;
          v25[1] = 0;
        }
        v28 = &word_804882A;
        v29 = 80;
        do
        {
          if ( !v29 )
            break;
          v30 = *(_BYTE *)v28 == 0;
          v28 = (__int16 *)((char *)v28 + 1);
          --v29;
        }
        while ( !v30 );
        v31 = sys_write(1, &word_804882A, ~(v29 - 80));
      }
    }
  }
  else
  {
    v33 = dword_8048666;
    sub_8048538(strlen(v62), v62, (char *)dword_8048666);
    v34 = (char *)v33;
    if ( !v33 )
    {
      v60 = sys_write(1, &byte_804863F, 0x17u);
      if ( dword_8048656 )
        __asm { int     80h; LINUX - sys_shutdown }
      v61 = sys_exit(1);
    }
    qmemcpy(&word_804882A, &byte_80485FF, 7u);
    v35 = (char *)&word_804882A + 7;
    v36 = 33;
    v37 = *v62;
    v38 = v62 + 1;
    do
    {
      --v36;
      *v35++ = v37;
      v37 = *v38++;
    }
    while ( v37 );
    memset(v35, 32, v36);
    v39 = &v35[v36];
    qmemcpy(v39, &word_8048606, 6u);
    v40 = v39 + 6;
    v41 = 4;
    v42 = v34;
    do
    {
      do
        v43 = *v42++;
      while ( v43 != 58 );
      --v41;
    }
    while ( v41 );
    sub_8048364(0, v40, v42);
    v40[1] = 10;
    v44 = sys_write(1, &word_804882A, 0x50u);
    qmemcpy(&word_804882A, dword_804860C, 0xBu);
    v45 = (char *)&word_804882A + 11;
    do
      v46 = *v42++;
    while ( v46 != 58 );
    sub_8048364(29, v45, v42);
    memset(v45, 32, v47);
    v48 = &v45[v47];
    qmemcpy(v48, &byte_8048617, 7u);
    v49 = v48 + 7;
    do
      v50 = *v42++;
    while ( v50 != 58 );
    sub_8048364(33, v49, v42);
    *v49 = 10;
    v51 = sys_write(1, &word_804882A, v49 + 1 - (_BYTE *)&word_804882A);
    while ( sys_read(dword_804865E, &buf.st_mtim, 0x180u) )
    {
      if ( buf.st_mtim.tv_sec == 7 )
      {
        v53 = &word_80486D6;
        v54 = v62;
        do
        {
          if ( !v52 )
            break;
          v30 = *(_BYTE *)v53 == (unsigned __int8)*v54;
          v53 = (__int16 *)((char *)v53 + 1);
          ++v54;
          --v52;
        }
        while ( v30 );
        if ( !*(_BYTE *)v53 )
        {
          qmemcpy(&word_804882A, &word_8048632, 0xDu);
          v55 = (char *)&word_804882A + 13;
          v56 = 67;
          v57 = buf.st_ctim.tv_sec;
          v58 = (_BYTE *)(&buf + 73);
          do
          {
            --v56;
            *v55++ = v57;
            v57 = *v58++;
          }
          while ( v57 );
          *v55 = 10;
          v59 = sys_write(1, &word_804882A, 81 - v56);
        }
      }
    }
  }
  JUMPOUT(0x8048584);
}
// 80480BE: positive sp value 8 has been found
// 80480F6: control flows out of bounds to 8048584
// 80480B7: variable 'v63' is possibly undefined
// 80480C1: variable 'v64' is possibly undefined
// 8048130: variable 'v8' is possibly undefined
// 8048387: variable 'v62' is possibly undefined
// 8048422: variable 'v47' is possibly undefined
// 8048487: variable 'v52' is possibly undefined
// 80485BF: using guessed type char byte_80485BF;
// 80485FF: using guessed type char byte_80485FF;
// 8048606: using guessed type __int16 word_8048606;
// 804860C: using guessed type int dword_804860C[2];
// 8048617: using guessed type char byte_8048617;
// 8048632: using guessed type __int16 word_8048632;
// 804863F: using guessed type char byte_804863F;
// 8048656: using guessed type int dword_8048656;
// 8048666: using guessed type int dword_8048666;
// 80486D6: using guessed type __int16 word_80486D6;
// 80486F6: using guessed type __int16 word_80486F6;
// 804882A: using guessed type __int16 word_804882A;

//----- (08048364) --------------------------------------------------------
char __usercall sub_8048364@<al>(int a1@<ecx>, _BYTE *a2@<edi>, char *a3@<esi>)
{
  char result; // al

  while ( 1 )
  {
    result = *a3++;
    if ( result == 58 || result == 44 || result == 10 || !result )
      break;
    --a1;
    *a2++ = result;
  }
  return result;
}

//----- (080484FE) --------------------------------------------------------
__int64 __usercall sub_80484FE@<edx:eax>(unsigned int a1@<eax>, unsigned int a2@<edx>, _BYTE *a3@<edi>)
{
  *a3 = a1 / 10LL + 48;
  a3[1] = a1 % 10LL + 48;
  a3[2] = 58;
  return a2;
}

//----- (0804851A) --------------------------------------------------------
_BYTE *__fastcall sub_804851A(int a1)
{
  char *v1; // esi
  _BYTE *v3; // [esp+0h] [ebp-4h]

  v1 = (char *)dword_8048666;
  sub_8048538(a1, &word_80486D6, (char *)dword_8048666);
  if ( v1 )
    sub_8048560(v1, v3);
  return v3;
}
// 8048531: variable 'v3' is possibly undefined
// 8048666: using guessed type int dword_8048666;
// 80486D6: using guessed type __int16 word_80486D6;

//----- (08048538) --------------------------------------------------------
char __usercall sub_8048538@<al>(int a1@<ecx>, _BYTE *a2@<edi>, char *a3@<esi>)
{
  char result; // al
  int v4; // edx
  bool v5; // zf
  _BYTE *v6; // [esp-4h] [ebp-4h]

  while ( 1 )
  {
    result = *a3++;
    if ( result != *a2 )
      goto LABEL_2;
    v4 = a1;
    --a3;
    v6 = a2;
    do
    {
      if ( !a1 )
        break;
      v5 = *a3++ == *a2++;
      --a1;
    }
    while ( v5 );
    a2 = v6;
    if ( !a1 && *a3 == 58 )
      return result;
    a1 = v4;
LABEL_2:
    while ( 1 )
    {
      result = *a3++;
      if ( result == 10 )
        break;
      if ( !result )
        return result;
    }
  }
}

//----- (08048560) --------------------------------------------------------
char __usercall sub_8048560@<al>(char *a1@<esi>, _BYTE *a2)
{
  int v2; // ecx
  char v3; // al
  int v4; // ecx
  char result; // al
  int v7; // eax

  v2 = 4;
  do
  {
    v3 = *a1++;
    if ( !v3 )
    {
      if ( dword_8048656 )
        __asm { int     80h; LINUX - sys_shutdown }
      v7 = sys_exit(0);
    }
  }
  while ( v3 != 58 || --v2 );
  v4 = -1;
  while ( 1 )
  {
    ++v4;
    result = *a1++;
    if ( result == 58 || result == 44 )
      break;
    *a2++ = result;
  }
  return result;
}
// 8048656: using guessed type int dword_8048656;

// nfuncs=7 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
