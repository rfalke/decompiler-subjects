/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);

//-------------------------------------------------------------------------
// Data declarations

__int16 word_80482CE = 21333; // weak
__int16 word_8048342 = 28245; // weak
char byte_804837F = '\n'; // weak
char byte_8048387 = '\0'; // weak
char byte_8048393 = '.'; // weak
pid_t pid; // idb
int dword_8048398; // weak
int dword_804839C; // weak
int dword_80483A0; // weak
int dword_80483A4; // weak
int dword_80483A8[17]; // weak
int dword_80483EC[17]; // weak
int dword_8048430; // weak
int dword_8048534[64]; // weak
int dword_8048634[5]; // weak
int dword_8048648; // weak
int dword_804864C[16383]; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // eax
  int v3; // eax
  int v4; // eax
  int v12; // et0
  void *v13; // edi
  int v14; // esi
  int v15; // eax
  int v16; // ebx
  int v17; // eax
  void *v18; // et1
  int v19; // eax
  void *v20; // edx
  int v21; // eax
  _DWORD *v22; // ebp
  void *v23; // edx
  int v24; // eax
  void *v25; // ebp
  int v26; // ecx
  int v27; // eax
  int v28; // eax
  int v29; // eax
  int v30; // eax
  int v31; // eax
  int v32; // eax
  char v33; // bl
  int v34; // eax
  int v35; // eax
  int v36; // eax
  int v37; // eax
  int v38; // eax
  int v39; // [esp-Ch] [ebp-Ch]
  char *v40; // [esp-4h] [ebp-4h]
  int v41; // [esp-4h] [ebp-4h]

  if ( v39 == 3 )
  {
    memset(dword_804864C, 0x90u, sizeof(dword_804864C));
    __asm { int     80h; LINUX - sys_getpid }
    _EAX = 1310740;
    _CL = 20;
    __asm { rcr     eax, cl }
    _EDI = _EAX ^ 0xDEADBEEF;
    _ESI = _EAX ^ 0xBEEFDEAD;
    __asm
    {
      rcl     edi, cl
      rcr     esi, cl
    }
    v12 = (unsigned __int16)_EDI;
    v13 = (void *)((unsigned __int16)_ESI + 134514252);
    v14 = v12 + 134514252;
    while ( 1 )
    {
      if ( !v40 )
      {
        __asm { int     80h; LINUX - sys_fork }
        pid = 2;
        v19 = sys_wait4(-1, 0, 2, 0);
        dword_8048430 = (int)dword_80483EC;
        v21 = sys_ptrace(12, pid, v20, dword_80483A8);
        dword_80483A8[12] = v14;
        dword_80483A8[15] = (int)dword_8048534;
        dword_80483A8[0] = (int)&dword_80483A0;
        dword_80483A8[6] = (int)dword_804864C;
        v22 = (_DWORD *)_InterlockedExchange(&dword_8048430, (__int32)dword_80483A8);
        v24 = sys_ptrace(12, pid, v23, v22);
        v22[12] = v13;
        v22[15] = dword_8048634;
        *v22 = &dword_80483A4;
        v22[6] = dword_804864C;
        v25 = (void *)_InterlockedExchange(&dword_8048430, (__int32)v22);
        v26 = 40;
        dword_8048398 = 0;
        for ( dword_804839C = 0; ; dword_804839C = dword_8048648 )
        {
          do
          {
            v41 = v26;
            v27 = sys_ptrace(13, pid, 0, v25);
            v28 = sys_ptrace(9, pid, 0, 0);
            v29 = sys_wait4(-1, 0, 2, 0);
            v30 = sys_ptrace(12, pid, 0, v25);
            v25 = (void *)_InterlockedExchange(&dword_8048430, (__int32)v25);
            v26 = v41 - 1;
          }
          while ( v41 != 1 );
          v31 = sys_write(1, &byte_8048393, 1u);
          v32 = sys_ptrace(2, pid, &dword_80483A0, &dword_8048648);
          v33 = 50;
          if ( dword_8048648 > (unsigned int)dword_8048398 )
          {
            dword_8048398 = dword_8048648;
            v34 = sys_ptrace(2, pid, &dword_80483A4, &dword_8048648);
            v33 = 49;
            if ( dword_8048648 > (unsigned int)dword_804839C )
              continue;
          }
          byte_8048387 = v33;
          v35 = sys_ptrace(8, pid, 0, 0);
          v36 = sys_wait4(-1, 0, 2, 0);
          v37 = sys_write(1, &byte_804837F, 0x14u);
          v38 = sys_exit(0);
        }
      }
      v15 = sys_open(v40, 0, a2);
      if ( v15 < 0 )
        break;
      v16 = v15;
      dword_80483A0 = sys_read(v15, v13, 0x1000u);
      v17 = sys_close(v16);
      v18 = (void *)v14;
      v14 = (int)v13;
      v13 = v18;
    }
    v4 = sys_write(1, &word_8048342, 0x3Du);
  }
  else
  {
    v2 = sys_write(1, &word_80482CE, 0x74u);
  }
  v3 = sys_exit(255);
}
// 804806D: positive sp value C has been found
// 8048050: variable 'v39' is possibly undefined
// 80480D7: variable 'v40' is possibly undefined
// 80480DE: variable 'a2' is possibly undefined
// 804816F: variable 'v20' is possibly undefined
// 804819D: variable 'v23' is possibly undefined
// 80481CE: variable 'v26' is possibly undefined
// 80482CE: using guessed type __int16 word_80482CE;
// 8048342: using guessed type __int16 word_8048342;
// 804837F: using guessed type char byte_804837F;
// 8048387: using guessed type char byte_8048387;
// 8048393: using guessed type char byte_8048393;
// 8048398: using guessed type int dword_8048398;
// 804839C: using guessed type int dword_804839C;
// 80483A0: using guessed type int dword_80483A0;
// 80483A4: using guessed type int dword_80483A4;
// 80483A8: using guessed type int dword_80483A8[17];
// 80483EC: using guessed type int dword_80483EC[17];
// 8048430: using guessed type int dword_8048430;
// 8048534: using guessed type int dword_8048534[64];
// 8048634: using guessed type int dword_8048634[5];
// 8048648: using guessed type int dword_8048648;
// 804864C: using guessed type int dword_804864C[16383];

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
