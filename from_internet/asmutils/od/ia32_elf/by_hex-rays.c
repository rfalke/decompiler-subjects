/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __fastcall __noreturn start(int, mode_t);
int sub_80480F8();
// int __usercall sub_8048138@<eax>(int result@<eax>);
int sub_804817C();
// int __usercall sub_8048264@<eax>(int@<eax>, unsigned __int8@<cl>);
int sub_8048281();
int sub_80482F0();
// int __usercall sub_804835D@<eax>(int@<eax>, char@<cl>);

//-------------------------------------------------------------------------
// Data declarations

char byte_8048381[] = { '0' }; // weak
char byte_8048391[3] = { '\\', '0', ' ' }; // weak
char byte_80483A9[3] = { 'F', 'i', 'l' }; // weak
int fd; // idb
int dword_80483BF; // weak
size_t len; // idb
int dword_80483C7; // weak
__int16 word_80483CB; // weak
char byte_80487CC[]; // weak
char byte_804881C; // weak


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(int a1, mode_t a2)
{
  int v2; // ebp
  _BYTE *v3; // ebx
  int v4; // eax
  int v5; // eax
  int v6; // eax
  int v7; // [esp-Ch] [ebp-Ch]
  int v8; // [esp-8h] [ebp-8h]
  char *v9; // [esp-4h] [ebp-4h]

  v2 = v7;
  v3 = (_BYTE *)(v8 - 1);
  do
    ++v3;
  while ( *v3 );
  if ( *(v3 - 2) == 120 )
    byte_804881C = 2;
  while ( --v2 )
  {
    switch ( *(_WORD *)v9 )
    {
      case 0x6F2D:
        byte_804881C = 0;
        break;
      case 0x632D:
        byte_804881C = 1;
        break;
      case 0x782D:
        byte_804881C = 2;
        break;
      default:
        v4 = sys_open(v9, 0, a2);
        if ( v4 < 0 )
        {
          v5 = sys_write(2, byte_80483A9, 0x12u);
          v6 = sys_exit(1);
        }
        fd = v4;
        break;
    }
  }
  if ( byte_804881C == 1 )
  {
    while ( 1 )
    {
      sub_80480F8();
      sub_804817C();
    }
  }
  if ( !byte_804881C )
  {
    while ( 1 )
    {
      sub_80480F8();
      sub_8048281();
    }
  }
  while ( 1 )
  {
    sub_80480F8();
    sub_80482F0();
  }
}
// 8048066: positive sp value C has been found
// 804804C: variable 'v7' is possibly undefined
// 804804E: variable 'v8' is possibly undefined
// 8048066: variable 'v9' is possibly undefined
// 8048080: variable 'a2' is possibly undefined
// 804881C: using guessed type char byte_804881C;

//----- (080480F8) --------------------------------------------------------
int sub_80480F8()
{
  int result; // eax
  int v1; // eax
  int v2; // eax

  result = sys_read(fd, &word_80483CB, 0x400u);
  if ( result < 0 )
    JUMPOUT(0x80480DE);
  if ( !result )
  {
    if ( byte_804881C == 2 )
      v1 = sub_804835D(dword_80483BF, 32);
    else
      v1 = sub_8048264(dword_80483BF, 0x15u);
    LOBYTE(v1) = 10;
    sub_8048138(v1);
    v2 = sys_exit(0);
  }
  dword_80483C7 = result;
  return result;
}
// 804810F: control flows out of bounds to 80480DE
// 80483BF: using guessed type int dword_80483BF;
// 80483C7: using guessed type int dword_80483C7;
// 80483CB: using guessed type __int16 word_80483CB;
// 804881C: using guessed type char byte_804881C;

//----- (08048138) --------------------------------------------------------
int __usercall sub_8048138@<eax>(int result@<eax>)
{
  size_t v1; // ebx

  v1 = len;
  byte_80487CC[len] = result;
  len = v1 + 1;
  if ( (_BYTE)result == 10 )
  {
    if ( sys_write(1, byte_80487CC, len) < 0 )
      JUMPOUT(0x804810F);
    result = 0;
    len = 0;
  }
  return result;
}
// 804812E: control flows out of bounds to 804810F

//----- (0804817C) --------------------------------------------------------
int sub_804817C()
{
  int v0; // edi
  int v1; // eax
  int v2; // eax
  int v3; // eax
  int result; // eax
  char *v5; // esi
  unsigned int v6; // eax
  int v7; // esi
  int v8; // eax
  int v9; // [esp-4h] [ebp-4h]
  int v10; // [esp-4h] [ebp-4h]

  v0 = 0;
  do
  {
    v9 = v0 + dword_80483BF;
    if ( (((_BYTE)v0 + (_BYTE)dword_80483BF) & 0xF) == 0 )
      v9 = sub_8048264(v9, 0x15u);
    v1 = v9;
    do
    {
      LOBYTE(v1) = *((_BYTE *)&word_80483CB + v0);
      if ( (char)v1 < 32 )
      {
        v5 = byte_8048391;
        if ( (_BYTE)v1 == 10 )
        {
          v5 = &byte_8048391[12];
        }
        else if ( (_BYTE)v1 == 9 )
        {
          v5 = &byte_8048391[20];
        }
        else if ( (_BYTE)v1 )
        {
          if ( (_BYTE)v1 == 12 )
          {
            v5 = &byte_8048391[8];
          }
          else
          {
            if ( (_BYTE)v1 != 8 )
            {
LABEL_17:
              v6 = *((unsigned __int8 *)&word_80483CB + v0);
              v7 = v6 & 0x3F;
              v6 >>= 6;
              LOBYTE(v6) = v6 + 48;
              sub_8048138(v6);
              v8 = v7;
              LOBYTE(v8) = ((unsigned __int8)v7 >> 3) + 48;
              sub_8048138(v8);
              v1 = sub_8048138((unsigned __int8)((v7 & 7) + 48));
              goto LABEL_8;
            }
            v5 = &byte_8048391[4];
          }
        }
        BYTE1(v1) = 4;
        do
        {
          LOBYTE(v1) = *v5;
          v1 = sub_8048138(v1);
          ++v5;
          --BYTE1(v1);
        }
        while ( BYTE1(v1) );
      }
      else
      {
        if ( (_BYTE)v1 == 127 )
          goto LABEL_17;
        v10 = v1;
        LOBYTE(v1) = 32;
        sub_8048138(v1);
        v2 = sub_8048138(v10);
        LOBYTE(v2) = 32;
        v3 = sub_8048138(v2);
        LOBYTE(v3) = 32;
        v1 = sub_8048138(v3);
      }
LABEL_8:
      if ( ++v0 == dword_80483C7 )
        break;
      v1 = v0;
    }
    while ( (v0 & 0xF) != 0 );
    LOBYTE(v1) = 10;
    sub_8048138(v1);
  }
  while ( v0 != dword_80483C7 );
  result = v0 + dword_80483BF;
  dword_80483BF += v0;
  return result;
}
// 80481FA: conditional instruction was optimized away because al.1 is in (<9u|B..1F|<0)
// 80483BF: using guessed type int dword_80483BF;
// 80483C7: using guessed type int dword_80483C7;
// 80483CB: using guessed type __int16 word_80483CB;

//----- (08048264) --------------------------------------------------------
int __usercall sub_8048264@<eax>(int a1@<eax>, unsigned __int8 a2@<cl>)
{
  unsigned int v2; // esi
  bool v3; // cf
  char v4; // cl
  int v5; // eax

  v2 = a1;
  while ( 1 )
  {
    v3 = a2 < 3u;
    v4 = a2 - 3;
    if ( v3 )
      break;
    v5 = v2 >> v4;
    LOBYTE(v5) = ((v2 >> v4) & 7) + 48;
    a1 = sub_8048138(v5);
  }
  LOBYTE(a1) = 32;
  return sub_8048138(a1);
}
// 8048266: variable 'a2' is possibly undefined

//----- (08048281) --------------------------------------------------------
int sub_8048281()
{
  int v0; // edi
  int v1; // eax
  int v2; // eax

  *((_BYTE *)&word_80483CB + dword_80483C7) = 0;
  v0 = 0;
LABEL_2:
  if ( (((_BYTE)v0 + (_BYTE)dword_80483BF) & 0xF) == 0 )
    sub_8048264(v0 + dword_80483BF, 0x15u);
  while ( 1 )
  {
    sub_8048264(*(unsigned __int16 *)((char *)&word_80483CB + v0), 0x12u);
    v0 += 2;
    if ( v0 >= dword_80483C7 )
      break;
    v1 = ((_BYTE)dword_80483BF + (_BYTE)v0) & 0xF;
    if ( (((_BYTE)dword_80483BF + (_BYTE)v0) & 0xF) == 0 )
    {
      LOBYTE(v1) = 10;
      sub_8048138(v1);
      goto LABEL_2;
    }
  }
  v2 = dword_80483C7 & 1;
  if ( (dword_80483C7 & 1) != 0 )
    --v0;
  dword_80483BF += v0;
  LOBYTE(v2) = 10;
  return sub_8048138(v2);
}
// 80483BF: using guessed type int dword_80483BF;
// 80483C7: using guessed type int dword_80483C7;
// 80483CB: using guessed type __int16 word_80483CB;

//----- (080482F0) --------------------------------------------------------
int sub_80482F0()
{
  int v0; // edi
  int v1; // eax
  int v2; // eax
  int v4; // [esp-4h] [ebp-4h]

  *((_BYTE *)&word_80483CB + dword_80483C7) = 0;
  v0 = 0;
LABEL_2:
  v4 = v0 + dword_80483BF;
  if ( (((_BYTE)v0 + (_BYTE)dword_80483BF) & 0xF) == 0 )
    v4 = sub_804835D(v4, 32);
  HIWORD(v1) = HIWORD(v4);
  while ( 1 )
  {
    LOWORD(v1) = *(__int16 *)((char *)&word_80483CB + v0);
    sub_804835D(v1, 16);
    v0 += 2;
    if ( v0 >= dword_80483C7 )
      break;
    v1 = ((_BYTE)dword_80483BF + (_BYTE)v0) & 0xF;
    if ( (((_BYTE)dword_80483BF + (_BYTE)v0) & 0xF) == 0 )
    {
      LOBYTE(v1) = 10;
      sub_8048138(v1);
      goto LABEL_2;
    }
  }
  v2 = dword_80483C7 & 1;
  if ( (dword_80483C7 & 1) != 0 )
    --v0;
  dword_80483BF += v0;
  LOBYTE(v2) = 10;
  return sub_8048138(v2);
}
// 80483BF: using guessed type int dword_80483BF;
// 80483C7: using guessed type int dword_80483C7;
// 80483CB: using guessed type __int16 word_80483CB;

//----- (0804835D) --------------------------------------------------------
int __usercall sub_804835D@<eax>(int a1@<eax>, char a2@<cl>)
{
  unsigned int v2; // esi

  v2 = a1;
  do
  {
    LOBYTE(a1) = byte_8048381[(v2 >> (a2 - 4)) & 0xF];
    a1 = sub_8048138(a1);
  }
  while ( a2 );
  LOBYTE(a1) = 32;
  return sub_8048138(a1);
}
// 804835F: variable 'a2' is possibly undefined

// nfuncs=8 queued=8 decompiled=8 lumina nreq=0 worse=0 better=0
// ALL OK, 8 function(s) have been successfully decompiled
