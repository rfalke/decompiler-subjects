/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __cdecl __noreturn start(int, int);
// void __usercall sub_8048071(timespec *p_st_mtim@<edi>, char *a2@<esi>);
// void __usercall sub_80480B8(char *a1@<edi>, char *a2@<esi>);
// __int16 __usercall sub_80480CC@<ax>(char *@<edi>);
// void __usercall sub_80480E7(const char *a1@<edi>);
// char __usercall sub_804810E@<al>(char *@<esi>);
// void __usercall sub_804811F(char *a1@<edi>, char *a2@<esi>);
// void __usercall sub_804812C(char *a1@<edi>, char *a2@<esi>);

//-------------------------------------------------------------------------
// Data declarations

struct stat buf; // idb


//----- (0804804C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __cdecl __noreturn start(int a1, int a2)
{
  timespec *v2; // edi
  int v3; // eax
  int v4; // [esp-Ch] [ebp-Ch]
  char *v5; // [esp-4h] [ebp-4h] BYREF

  if ( v4 >= 3 )
  {
    v2 = (timespec *)_InterlockedExchange((volatile __int32 *)&(&v5)[v4 - 2], 0);
    while ( v5 )
      sub_8048071(v2, v5);
  }
  v3 = sys_exit(0);
}
// 8048060: positive sp value C has been found
// 8048050: variable 'v4' is possibly undefined

//----- (08048071) --------------------------------------------------------
void __usercall sub_8048071(timespec *p_st_mtim@<edi>, char *a2@<esi>)
{
  bool v2; // zf
  int v3; // edx
  int v4; // ecx
  char *v5; // edi
  int v6; // eax
  char *v7; // [esp-24h] [ebp-24h]

  sub_80480E7((const char *)p_st_mtim);
  if ( v2 )
  {
    v7 = (char *)p_st_mtim;
    sub_804810E(a2);
    v4 = v3;
    v5 = &a2[v3 - 1];
    if ( *v5 == 47 )
      *v5 = 0;
    do
    {
      if ( !v4 )
        break;
      v2 = *v5-- == 47;
      --v4;
    }
    while ( !v2 );
    p_st_mtim = &buf.st_mtim;
    sub_80480B8((char *)&buf.st_mtim, v7);
  }
  v6 = sys_rename(a2, (const char *)p_st_mtim);
}
// 8048071: could not find valid save-restore pair for edi
// 8048077: variable 'v2' is possibly undefined
// 8048083: variable 'v3' is possibly undefined

//----- (080480B8) --------------------------------------------------------
void __usercall sub_80480B8(char *a1@<edi>, char *a2@<esi>)
{
  char *v2; // edx

  sub_804811F(a1, a2);
  sub_80480CC(a1);
  sub_804812C(a1, v2);
}
// 80480C5: variable 'v2' is possibly undefined

//----- (080480CC) --------------------------------------------------------
__int16 __usercall sub_80480CC@<ax>(char *a1@<edi>)
{
  int v1; // edx
  int v2; // edx
  __int16 result; // ax

  sub_804810E(a1);
  v2 = v1 - 1;
  result = 47;
  if ( a1[v2] != 47 )
    *(_WORD *)&a1[v2 + 1] = 47;
  return result;
}
// 80480D5: variable 'v1' is possibly undefined

//----- (080480E7) --------------------------------------------------------
void __usercall sub_80480E7(const char *a1@<edi>)
{
  int v1; // eax

  v1 = sys_newstat(a1, &buf);
}

//----- (0804810E) --------------------------------------------------------
char __usercall sub_804810E@<al>(char *a1@<esi>)
{
  int v1; // edx
  char result; // al

  v1 = -1;
  do
  {
    ++v1;
    result = *a1++;
  }
  while ( result );
  return result;
}

//----- (0804811F) --------------------------------------------------------
void __usercall sub_804811F(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // edx

  sub_804810E(a2);
  qmemcpy(a1, a2, v2 + 1);
}
// 8048125: variable 'v2' is possibly undefined

//----- (0804812C) --------------------------------------------------------
void __usercall sub_804812C(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // edx
  char *v3; // edi
  int v4; // edx

  sub_804810E(a1);
  v3 = &a1[v2];
  sub_804810E(a2);
  qmemcpy(v3, a2, v4 + 1);
}
// 804812C: could not find valid save-restore pair for edi
// 804812C: could not find valid save-restore pair for esi
// 8048136: variable 'v2' is possibly undefined
// 804813D: variable 'v4' is possibly undefined

// nfuncs=8 queued=8 decompiled=8 lumina nreq=0 worse=0 better=0
// ALL OK, 8 function(s) have been successfully decompiled
