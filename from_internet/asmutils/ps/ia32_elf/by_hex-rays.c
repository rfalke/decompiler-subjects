/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn start();
// void __usercall sub_8048111(int@<ecx>, const char *@<edi>);
// void __usercall sub_8048132(const char *a1@<edi>);
// __int16 __usercall sub_804815A@<ax>(char *@<esi>);
void __fastcall sub_8048176(char *a1);
// char __usercall sub_8048188@<al>(char *@<esi>);
// void __usercall sub_8048196(char *a1@<edi>, char *a2@<esi>);
// void __usercall sub_80481A3(char *a1@<edi>, char *a2@<esi>);

//-------------------------------------------------------------------------
// Data declarations

char aPidTtyStatRssC[26] = "PID\tTTY\tSTAT\tRSS\tCOMMAND\n"; // weak
char filename[] = "/proc/"; // idb
char aStat[6] = "/stat"; // weak
char asc_80481E2[2] = "\n"; // weak
char asc_80481E4[2] = "\t"; // weak
__int16 word_80481E6 = 1793; // weak
char byte_80481EC[1280]; // idb
struct dirent dirp; // idb


//----- (0804804C) --------------------------------------------------------
void __noreturn start()
{
  mode_t v2; // edx
  int v3; // edx
  struct dirent *v4; // ebx
  int v5; // ecx
  int v6; // eax
  mode_t v7; // edx
  int v8; // eax
  int v9; // ebx
  int v10; // eax
  const char *v11; // ecx
  unsigned __int16 d_reclen; // ax
  int v13; // eax
  int v14; // [esp-1Ch] [ebp-1Ch]
  int v15; // [esp-18h] [ebp-18h]
  struct dirent *v16; // [esp-14h] [ebp-14h]

  sub_8048176(aPidTtyStatRssC);
  if ( sys_open(filename, 0, v2) >= 0 )
  {
    while ( 1 )
    {
      v3 = 4096;
      __asm { int     80h; LINUX - sys_getdents }
      v4 = &dirp;
      v5 = 141;
      do
      {
        v16 = v4;
        v15 = v5;
        v14 = v3;
        LOWORD(v6) = sub_804815A((char *)&v4->d_type);
        if ( !v6 )
        {
          sub_8048196(byte_80481EC, filename);
          sub_80481A3(byte_80481EC, (char *)&v4->d_type);
          sub_80481A3(byte_80481EC, aStat);
          v8 = sys_open(byte_80481EC, 0, v7);
          if ( v8 >= 0 )
          {
            v9 = v8;
            if ( sys_read(v8, &byte_80481EC[256], 0x400u) >= 0 )
            {
              v10 = sys_close(v9);
              sub_8048132(v11);
              sub_8048176(asc_80481E2);
            }
          }
        }
        v3 = v14;
        d_reclen = v16->d_reclen;
        v4 = (struct dirent *)((char *)v16 + d_reclen);
        v5 = v15 - d_reclen;
      }
      while ( v15 != d_reclen );
    }
  }
  v13 = sys_exit(0);
}
// 8048060: variable 'v2' is possibly undefined
// 804809A: variable 'v6' is possibly undefined
// 80480C7: variable 'v7' is possibly undefined
// 80480E8: variable 'v11' is possibly undefined

//----- (08048111) --------------------------------------------------------
void __usercall sub_8048111(int a1@<ecx>, const char *a2@<edi>)
{
  char *v2; // esi
  int v3; // [esp-24h] [ebp-24h]

  do
  {
    v3 = a1;
    v2 = (char *)a2;
    a2 += strlen(a2) + 1;
    a1 = v3 - 1;
  }
  while ( v3 != 1 );
  sub_8048176(v2);
  sub_8048176(asc_80481E4);
}

//----- (08048132) --------------------------------------------------------
void __usercall sub_8048132(const char *a1@<edi>)
{
  const char *v1; // esi
  char v2; // al
  __int16 *v3; // esi
  unsigned __int8 v4; // al

  v1 = a1;
  while ( 1 )
  {
    v2 = *v1++;
    if ( !v2 )
      break;
    if ( v2 == 32 )
      *((_BYTE *)v1 - 1) = 0;
  }
  v3 = &word_80481E6;
  while ( 1 )
  {
    v4 = *(_BYTE *)v3;
    v3 = (__int16 *)((char *)v3 + 1);
    if ( !v4 )
      break;
    sub_8048111(v4, a1);
  }
}
// 80481E6: using guessed type __int16 word_80481E6;

//----- (0804815A) --------------------------------------------------------
__int16 __usercall sub_804815A@<ax>(char *a1@<esi>)
{
  unsigned __int8 v1; // ah
  char v2; // al

  v1 = 0;
  while ( 1 )
  {
    v2 = *a1++;
    if ( !v2 )
      break;
    if ( (unsigned __int8)v2 < 0x30u )
      return 1;
    if ( v2 > 57 )
      return 1;
  }
  return v1;
}

//----- (08048176) --------------------------------------------------------
void __fastcall sub_8048176(char *a1)
{
  size_t v1; // edx
  const void *v2; // ecx
  int v3; // eax

  sub_8048188(a1);
  v3 = sys_write(1, v2, v1);
}
// 8048184: variable 'v2' is possibly undefined
// 8048184: variable 'v1' is possibly undefined

//----- (08048188) --------------------------------------------------------
char __usercall sub_8048188@<al>(char *a1@<esi>)
{
  int v1; // edx
  char result; // al

  v1 = -1;
  do
  {
    ++v1;
    result = *a1++;
  }
  while ( result );
  return result;
}

//----- (08048196) --------------------------------------------------------
void __usercall sub_8048196(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // edx

  sub_8048188(a2);
  qmemcpy(a1, a2, v2 + 1);
}
// 804819C: variable 'v2' is possibly undefined

//----- (080481A3) --------------------------------------------------------
void __usercall sub_80481A3(char *a1@<edi>, char *a2@<esi>)
{
  int v2; // edx
  char *v3; // edi
  int v4; // edx

  sub_8048188(a1);
  v3 = &a1[v2];
  sub_8048188(a2);
  qmemcpy(v3, a2, v4 + 1);
}
// 80481A3: could not find valid save-restore pair for edi
// 80481A3: could not find valid save-restore pair for esi
// 80481AD: variable 'v2' is possibly undefined
// 80481B4: variable 'v4' is possibly undefined

// nfuncs=8 queued=8 decompiled=8 lumina nreq=0 worse=0 better=0
// ALL OK, 8 function(s) have been successfully decompiled
