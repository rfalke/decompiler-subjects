//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
//

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>

// ------------------------ Structures ------------------------

struct _IO_FILE {
    int32_t e0;
};

// ------------------- Function Prototypes --------------------

void dumpline(char * p, int64_t offset, int32_t cnt);
int32_t hexdump(char * fname);

// --------------------- Global Variables ---------------------

int64_t g1; // 0x400b92

// ------------------------ Functions -------------------------

// From module:   /home/gcaprino/backerstreet.com/rec/tests/src/hd.c
// Address range: 0x400794 - 0x400942
// Line range:    5 - 27
void dumpline(char * p, int64_t offset, int32_t cnt) {
    char buff[80]; // bp-128, 0x400794
    char buff2[80]; // bp-136, 0x400794
    char v1[80]; // 0x4007a0
    char v2[80]; // 0x4007a4
    // 0x400794
    v1[0] = (int64_t)p;
    buff = v1;
    v2[0] = offset;
    buff2 = v2;
    int64_t str; // bp-120, 0x400794
    sprintf((char *)&str, "%08lX:", (int32_t)*(int64_t *)&buff2);
    int32_t v3 = cnt < 16 ? cnt : 16;
    int32_t v4 = 0; // 0x400830
    if (cnt > 0) {
        int64_t v5 = (int64_t)&str + 9; // 0x400806
        int64_t v6 = 0; // 0x400794
        unsigned char v7 = *(char *)(v6 + *(int64_t *)&buff); // 0x4007f0
        sprintf((char *)(v5 + 3 * v6), " %02lX", (int32_t)v7);
        int64_t v8 = v6 + 1;
        v6 = v8;
        while (v8 < (int64_t)v3) {
            // 0x4007e7
            v7 = *(char *)(v6 + *(int64_t *)&buff);
            sprintf((char *)(v5 + 3 * v6), " %02lX", (int32_t)v7);
            v8 = v6 + 1;
            v6 = v8;
        }
        // 0x400827
        v4 = v8;
    }
    int32_t v9 = v4;
    int32_t v10 = v9 - 15; // 0x400848
    if (v10 == 0 || v10 < 0 != (14 - v9 & v9) < 0) {
        int32_t v11 = v9;
        int32_t v12 = v11 + 1; // 0x40084f
        strcat((char *)&str, "   ");
        while (v11 == 14 || v11 < 14 != (13 - v11 & v12) < 0) {
            // 0x400834
            v11 = v12;
            v12 = v11 + 1;
            strcat((char *)&str, "   ");
        }
    }
    // 0x400857
    int64_t v13; // bp-8, 0x400794
    int64_t v14 = &v13; // 0x400795
    int32_t len = strlen((char *)&str); // 0x40085e
    int64_t v15 = &str; // 0x400871
    memcpy((int64_t *)((int64_t)len + v15), (int64_t *)"  |", 4);
    int32_t v16 = len + 3; // 0x400888
    int64_t v17; // 0x400794
    int64_t v18; // 0x400794
    if (cnt > 0) {
        int64_t v19 = v14 - 112;
        int64_t v20 = 0; // 0x400794
        unsigned char v21 = *(char *)(*(int64_t *)&buff + v20); // 0x4008a6
        char v22 = v21 < 32 ? 46 : v21 < 127 ? v21 : 46;
        *(char *)(v19 + (int64_t)(v16 + (int32_t)v20)) = v22;
        int64_t v23 = v20 + 1;
        v20 = v23;
        while (v23 < (int64_t)v3) {
            // 0x400895
            v21 = *(char *)(*(int64_t *)&buff + v20);
            v22 = v21 < 32 ? 46 : v21 < 127 ? v21 : 46;
            *(char *)(v19 + (int64_t)(v16 + (int32_t)v20)) = v22;
            v23 = v20 + 1;
            v20 = v23;
        }
        // 0x4008fc
        v17 = v19;
        v18 = v23;
        if ((int32_t)v23 >= 16) {
            // 0x400902
            memcpy((int64_t *)((int64_t)v16 + v15 + (0x100000000 * v23 >> 32)), &g1, 2);
            puts((char *)&str);
            return;
        }
    } else {
        // 0x400857
        v17 = v14 - 112;
        v18 = 0;
    }
    int64_t v24 = v18 & 0xffffffff;
    *(char *)(v17 + (int64_t)(v16 + (int32_t)v24)) = 32;
    v24++;
    while (v24 != 16) {
        // 0x4008e8
        *(char *)(v17 + (int64_t)(v16 + (int32_t)v24)) = 32;
        v24++;
    }
    // 0x400902
    memcpy((int64_t *)((int64_t)v16 + v15 + 16), &g1, 2);
    puts((char *)&str);
}

// From module:   /home/gcaprino/backerstreet.com/rec/tests/src/hd.c
// Address range: 0x400942 - 0x400a34
// Line range:    29 - 56
int32_t hexdump(char * fname) {
    // 0x400942
    int64_t v1; // 0x400942
    uint64_t v2 = v1;
    int64_t buf; // bp-200, 0x400942
    if ((int32_t)stat((int64_t)fname, &buf) != 0) {
        // 0x400971
        perror(fname);
        // 0x400a32
        return 1;
    }
    struct _IO_FILE * file = fopen(fname, "rb"); // 0x40099c
    if (file == NULL) {
        // 0x4009ac
        perror(fname);
        // 0x400a32
        return 1;
    }
    if (v2 == 0) {
        // 0x400a21
        fclose(file);
        // 0x400a32
        return 0;
    }
    int64_t v3 = 0; // 0x400a0d
    int64_t data; // bp-56, 0x400942
    int32_t items_read = fread(&data, 1, 16, file); // 0x4009e4
    while (items_read != 0) {
        // 0x4009f2
        dumpline((char *)&data, v3, items_read);
        v3 += (int64_t)items_read;
        if (v2 <= v3) {
            // break -> 0x400a21
            break;
        }
        items_read = fread(&data, 1, 16, file);
    }
    // 0x400a21
    fclose(file);
    // 0x400a32
    return 0;
}

// From module:   /home/gcaprino/backerstreet.com/rec/tests/src/hd.c
// Address range: 0x400a34 - 0x400a7f
// Line range:    58 - 67
int main(int argc, char ** argv) {
    // 0x400a34
    if (argc <= 1) {
        // 0x400a7a
        return 0;
    }
    int64_t v1 = 1;
    int32_t result = 0; // 0x400a6b
    int64_t v2 = *(int64_t *)(8 * v1 + (int64_t)argv); // 0x400a60
    result += hexdump((char *)v2);
    v1++;
    while (v1 != (int64_t)argc) {
        // 0x400a53
        v2 = *(int64_t *)(8 * v1 + (int64_t)argv);
        result += hexdump((char *)v2);
        v1++;
    }
    // 0x400a7a
    return result;
}

// --------------- Statically Linked Functions ----------------

// int64_t stat(int64_t a1, int64_t * a2);

// --------------- Dynamically Linked Functions ---------------

// int __xstat(int ver, const char * filename, struct stat * stat_buf);
// int fclose(FILE * stream);
// FILE * fopen(const char * restrict filename, const char * restrict modes);
// size_t fread(void * restrict ptr, size_t size, size_t n, FILE * restrict stream);
// void * memcpy(void * restrict dest, const void * restrict src, size_t n);
// void perror(const char * s);
// int puts(const char * s);
// int sprintf(char * restrict s, const char * restrict format, ...);
// char * strcat(char * restrict dest, const char * restrict src);
// size_t strlen(const char * s);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: gcc (4.6.3)
// Detected functions: 3

