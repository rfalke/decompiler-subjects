/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <windows.h>
#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

// void __mingw_CRTStartup(); idb
int __stdcall _gnu_exception_handler(EXCEPTION_POINTERS *exception_data);
void __noreturn WinMainCRTStartup();
int __cdecl atexit(void (*pfn)(void));
_onexit_t __cdecl _onexit(_onexit_t pfn);
FARPROC __gcc_register_frame();
void __cdecl __gcc_deregister_frame(); // idb
int __cdecl main(int argc, const char **argv, const char **envp);
void __tcf_0(); // idb
void __cdecl __static_initialization_and_destruction_0(int __initialize_p, int __priority);
void _GLOBAL__sub_I_main(); // idb
// int __stdcall std::operator<<<std::char_traits<char>>(_DWORD); weak
// int __thiscall std::ostream::operator<<(_DWORD, _DWORD); weak
// void __cdecl std::ios_base::Init::~Init(std::ios_base::Init *__hidden this); idb
// _DWORD std::ios_base::Init::Init(std::ios_base::Init *__hidden this); idb
BOOL __stdcall __dyn_tls_dtor(HANDLE hDllHandle, DWORD dwReason, LPVOID lpreserved);
BOOL __stdcall __dyn_tls_init(HANDLE hDllHandle, DWORD dwReason, LPVOID lpreserved);
int __cdecl __tlregdtor(_PVFV func);
void __cpu_features_init(); // idb
void fpreset(); // idb
void __report_error(const char *msg, ...);
// void __usercall __write_memory(void *addr@<eax>, const void *src@<edx>, size_t len@<ecx>); idb
void _pei386_runtime_relocator(); // idb
void __do_global_dtors(); // idb
void __do_global_ctors(); // idb
void __main(); // idb
void __mingwthr_run_key_dtors(); // idb
int __cdecl ___w64_mingwthr_add_key_dtor(DWORD key, void (*dtor)(void *));
int __cdecl ___w64_mingwthr_remove_key_dtor(DWORD key);
WINBOOL __cdecl __mingw_TLScallback(HANDLE hDllHandle, DWORD reason, LPVOID reserved);
// _crt_signal_t __cdecl signal(int Signal, _crt_signal_t Function);
// size_t __cdecl fwrite(const void *Buffer, size_t ElementSize, size_t ElementCount, FILE *Stream);
// int __cdecl vfprintf(FILE *const Stream, const char *const Format, va_list ArgList);
// void __cdecl __noreturn abort();
// void *__cdecl calloc(size_t Count, size_t Size);
// void __cdecl free(void *Block);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// SIZE_T __stdcall VirtualQuery(LPCVOID lpAddress, PMEMORY_BASIC_INFORMATION lpBuffer, SIZE_T dwLength);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// void __stdcall EnterCriticalSection(LPCRITICAL_SECTION lpCriticalSection);
// LPVOID __stdcall TlsGetValue(DWORD dwTlsIndex);
// DWORD __stdcall GetLastError();
// void __stdcall LeaveCriticalSection(LPCRITICAL_SECTION lpCriticalSection);
// void __stdcall DeleteCriticalSection(LPCRITICAL_SECTION lpCriticalSection);
// void __stdcall InitializeCriticalSection(LPCRITICAL_SECTION lpCriticalSection);
int register_frame_ctor();
// void __cdecl ___set_app_type(_crt_app_type Type);
// _onexit_t __cdecl __onexit(_onexit_t Func);
// int __cdecl _atexit(void (__cdecl *)());

//-------------------------------------------------------------------------
// Data declarations

// extern _UNKNOWN std::endl<char,std::char_traits<char>>; weak
// extern _UNKNOWN __deregister_frame_info; weak
// extern _UNKNOWN __register_frame_info; weak
int __CTOR_LIST__[] = { -1 }; // weak
func_ptr *p_1615 = &dword_401C74; // idb
int data = 0; // weak
int _rt_psrelocs_start = 0; // weak
int _rt_psrelocs_end[944] =
{
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  
}; // idb
_UNKNOWN __EH_FRAME_BEGIN__; // weak
_UNKNOWN obj; // weak
unsigned int __cpu_features; // idb
int was_init_30902; // idb
int initialized; // idb
int _CRT_MT; // idb
volatile int __mingwthr_cs_init; // idb
CRITICAL_SECTION __mingwthr_cs; // idb
volatile __mingwthr_key_t *key_dtor_list; // idb
// extern FILE __iob[];
// extern _UNKNOWN std::cerr; weak


//----- (00401110) --------------------------------------------------------
int __stdcall _gnu_exception_handler(EXCEPTION_POINTERS *exception_data)
{
  DWORD v1; // eax
  int v2; // ebx
  _crt_signal_t v3; // eax
  int result; // eax
  _crt_signal_t v5; // eax
  _crt_signal_t v6; // eax

  v1 = exception_data->ExceptionRecord->ExceptionCode;
  if ( v1 <= 0xC0000091 )
  {
    if ( v1 >= 0xC000008D )
    {
LABEL_3:
      v2 = 1;
      goto LABEL_4;
    }
    if ( v1 == -1073741819 )
    {
      v6 = signal(11, 0);
      if ( v6 == (_crt_signal_t)1 )
      {
        signal(11, (_crt_signal_t)1);
        result = -1;
      }
      else
      {
        if ( !v6 )
          return 0;
        v6(11);
        result = -1;
      }
      return result;
    }
    if ( v1 != -1073741795 )
      return 0;
    goto LABEL_13;
  }
  if ( v1 != -1073741676 )
  {
    if ( v1 != -1073741674 )
    {
      if ( v1 != -1073741677 )
        return 0;
      goto LABEL_3;
    }
LABEL_13:
    v5 = signal(4, 0);
    if ( v5 == (_crt_signal_t)1 )
    {
      signal(4, (_crt_signal_t)1);
      result = -1;
    }
    else
    {
      if ( !v5 )
        return 0;
      v5(4);
      result = -1;
    }
    return result;
  }
  v2 = 0;
LABEL_4:
  v3 = signal(8, 0);
  if ( v3 == (_crt_signal_t)1 )
  {
    signal(8, (_crt_signal_t)1);
    if ( v2 )
      fpreset();
    result = -1;
  }
  else
  {
    if ( !v3 )
      return 0;
    v3(8);
    result = -1;
  }
  return result;
}

//----- (00401284) --------------------------------------------------------
void __noreturn WinMainCRTStartup()
{
  ___set_app_type(_crt_gui_app);
  __mingw_CRTStartup();
}

//----- (0040129C) --------------------------------------------------------
int __cdecl atexit(void (*pfn)(void))
{
  return _atexit(pfn);
}

//----- (004012AC) --------------------------------------------------------
_onexit_t __cdecl _onexit(_onexit_t pfn)
{
  return __onexit(pfn);
}

//----- (004012BC) --------------------------------------------------------
FARPROC __gcc_register_frame()
{
  HMODULE v0; // eax
  FARPROC result; // eax
  HMODULE v2; // eax

  v0 = GetModuleHandleA("libgcc_s_dw2-1.dll");
  if ( v0 )
    result = GetProcAddress(v0, "__register_frame_info");
  else
    result = (FARPROC)&__register_frame_info;
  if ( result )
    result = (FARPROC)((int (__cdecl *)(void *, void *))result)(&__EH_FRAME_BEGIN__, &obj);
  if ( data )
  {
    v2 = GetModuleHandleA("libgcj-13.dll");
    if ( v2 )
      result = GetProcAddress(v2, "_Jv_RegisterClasses");
    else
      result = 0;
    if ( result )
      result = (FARPROC)((int (__cdecl *)(int *))result)(&data);
  }
  return result;
}
// 40200C: using guessed type int data;

//----- (00401348) --------------------------------------------------------
void __cdecl __gcc_deregister_frame()
{
  HMODULE v0; // eax
  FARPROC __deregister_frame_info; // eax

  v0 = GetModuleHandleA("libgcc_s_dw2-1.dll");
  if ( v0 )
    __deregister_frame_info = GetProcAddress(v0, "__deregister_frame_info");
  else
    __deregister_frame_info = (FARPROC)&::__deregister_frame_info;
  if ( __deregister_frame_info )
    ((void (__cdecl *)(void *))__deregister_frame_info)(&__EH_FRAME_BEGIN__);
}

//----- (0040138C) --------------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  int v3; // eax

  __main();
  v3 = std::operator<<<std::char_traits<char>>(&std::cerr);
  std::ostream::operator<<(v3, &std::endl<char,std::char_traits<char>>);
  return 0;
}
// 401438: using guessed type int __stdcall std::operator<<<std::char_traits<char>>(_DWORD);
// 401440: using guessed type int __thiscall std::ostream::operator<<(_DWORD, _DWORD);

//----- (004013D4) --------------------------------------------------------
void __tcf_0()
{
  std::ios_base::Init *v0; // [esp+0h] [ebp-8h]

  std::ios_base::Init::~Init(v0);
}
// 4013DF: variable 'v0' is possibly undefined

//----- (004013E6) --------------------------------------------------------
void __cdecl __static_initialization_and_destruction_0(int __initialize_p, int __priority)
{
  std::ios_base::Init *v2; // [esp+0h] [ebp-18h]

  if ( __initialize_p == 1 && __priority == 0xFFFF )
  {
    std::ios_base::Init::Init(v2);
    atexit(__tcf_0);
  }
}
// 401400: variable 'v2' is possibly undefined

//----- (00401413) --------------------------------------------------------
void _GLOBAL__sub_I_main()
{
  __static_initialization_and_destruction_0(1, 0xFFFF);
}

//----- (00401458) --------------------------------------------------------
BOOL __stdcall __dyn_tls_dtor(HANDLE hDllHandle, DWORD dwReason, LPVOID lpreserved)
{
  if ( dwReason == 3 || !dwReason )
    __mingw_TLScallback(hDllHandle, dwReason, lpreserved);
  return 1;
}

//----- (0040148C) --------------------------------------------------------
BOOL __stdcall __dyn_tls_init(HANDLE hDllHandle, DWORD dwReason, LPVOID lpreserved)
{
  if ( _CRT_MT != 2 )
    _CRT_MT = 2;
  if ( dwReason != 2 && dwReason == 1 )
    __mingw_TLScallback(hDllHandle, 1u, lpreserved);
  return 1;
}

//----- (0040150C) --------------------------------------------------------
int __cdecl __tlregdtor(_PVFV func)
{
  return 0;
}

//----- (00401514) --------------------------------------------------------
void __cpu_features_init()
{
  unsigned int v0; // kr00_4
  unsigned int v1; // kr04_4
  unsigned int v2; // kr08_4
  unsigned int v23; // [esp-4h] [ebp-8h]

  v0 = __readeflags();
  v23 = v0;
  v1 = __readeflags();
  __writeeflags(v1 ^ 0x200000);
  v2 = __readeflags();
  __writeeflags(v23);
  if ( ((v1 ^ v2) & 0x200000) != 0 )
  {
    _EAX = 0;
    __asm { cpuid }
    if ( _EAX )
    {
      _EAX = 1;
      __asm { cpuid }
      if ( (_EDX & 0x100) != 0 )
        __cpu_features |= 1u;
      if ( (_EDX & 0x8000) != 0 )
        __cpu_features |= 2u;
      if ( (_EDX & 0x800000) != 0 )
        __cpu_features |= 4u;
      if ( (_EDX & 0x1000000) != 0 )
        __cpu_features |= 8u;
      if ( (_EDX & 0x2000000) != 0 )
        __cpu_features |= 0x10u;
      if ( (_EDX & 0x4000000) != 0 )
        __cpu_features |= 0x20u;
      if ( (_ECX & 1) != 0 )
        __cpu_features |= 0x40u;
      if ( (_ECX & 0x2000) != 0 )
        __cpu_features |= 0x80u;
      _EAX = 0x80000000;
      __asm { cpuid }
      if ( _EAX > 0x80000000 )
      {
        _EAX = -2147483647;
        __asm { cpuid }
        if ( _EDX < 0 )
          __cpu_features |= 0x100u;
        if ( (_EDX & 0x40000000) != 0 )
          __cpu_features |= 0x200u;
      }
    }
  }
}

//----- (004015F4) --------------------------------------------------------
void fpreset()
{
  __asm { fninit }
}

//----- (004015FC) --------------------------------------------------------
void __noreturn __report_error(const char *msg, ...)
{
  va_list ArgList; // [esp+24h] [ebp+Ch] BYREF

  va_start(ArgList, msg);
  fwrite("Mingw runtime failure:\n", 1u, 0x17u, &__iob[2]);
  vfprintf(&__iob[2], msg, ArgList);
  abort();
}

//----- (00401648) --------------------------------------------------------
void __usercall __write_memory(void *addr@<eax>, const void *src@<edx>, size_t len@<ecx>)
{
  DWORD v5; // eax
  MEMORY_BASIC_INFORMATION b; // [esp+20h] [ebp-38h] BYREF
  DWORD oldprot[7]; // [esp+3Ch] [ebp-1Ch] BYREF

  if ( len )
  {
    if ( !VirtualQuery(addr, &b, 0x1Cu) )
      __report_error("  VirtualQuery failed for %d bytes at address %p", 28, addr);
    if ( b.Protect == 64 || b.Protect == 4 )
    {
      qmemcpy(addr, src, len);
    }
    else
    {
      VirtualProtect(b.BaseAddress, b.RegionSize, 0x40u, oldprot);
      v5 = b.Protect;
      qmemcpy(addr, src, len);
      if ( v5 != 64 && v5 != 4 )
        VirtualProtect(b.BaseAddress, b.RegionSize, oldprot[0], oldprot);
    }
  }
}

//----- (0040172C) --------------------------------------------------------
void _pei386_runtime_relocator()
{
  int *v0; // ebx
  _DWORD *v1; // eax
  int *v2; // ebx
  _DWORD *v3; // eax
  int v4; // ecx
  int v5; // esi
  int v6; // edx
  int v7; // edi
  int src; // [esp+18h] [ebp-20h] BYREF
  int v9[7]; // [esp+1Ch] [ebp-1Ch] BYREF

  if ( was_init_30902 )
    return;
  was_init_30902 = 1;
  if ( (char *)_rt_psrelocs_end - (char *)&_rt_psrelocs_start <= 7 )
    return;
  v0 = &_rt_psrelocs_start;
  if ( (char *)_rt_psrelocs_end - (char *)&_rt_psrelocs_start <= 11 )
  {
    if ( _rt_psrelocs_start || *(&_rt_psrelocs_start + 1) )
    {
LABEL_6:
      if ( &_rt_psrelocs_start < _rt_psrelocs_end )
      {
        do
        {
          v1 = (_DWORD *)(v0[1] + 0x400000);
          src = *v0 + *v1;
          __write_memory(v1, &src, 4u);
          v0 += 2;
        }
        while ( v0 < _rt_psrelocs_end );
      }
      return;
    }
  }
  else if ( _rt_psrelocs_start )
  {
    goto LABEL_6;
  }
  if ( *(&_rt_psrelocs_start + 2) != 1 )
    __report_error("  Unknown pseudo relocation protocol version %d.\n", *(&_rt_psrelocs_start + 2));
  v2 = &_rt_psrelocs_start + 3;
  if ( &_rt_psrelocs_start + 3 < _rt_psrelocs_end )
  {
    while ( 1 )
    {
      v3 = (_DWORD *)(v2[1] + 0x400000);
      v4 = *v2;
      v5 = *(_DWORD *)(*v2 + 0x400000);
      v6 = (unsigned __int8)v2[2];
      if ( v6 == 16 )
        break;
      if ( v6 == 32 )
      {
        v9[0] = v5 + *v3 - v4 - 0x400000;
        __write_memory(v3, v9, 4u);
        goto LABEL_23;
      }
      if ( v6 != 8 )
      {
        v9[0] = 0;
        __report_error("  Unknown pseudo relocation bit size %d.\n", v6);
      }
      v7 = *(unsigned __int8 *)v3;
      if ( (v7 & 0x80) == 0 )
        goto LABEL_20;
      v9[0] = (v7 | 0xFFFFFF00) - v4 - 0x400000 + v5;
LABEL_21:
      __write_memory(v3, v9, 1u);
LABEL_23:
      v2 += 3;
      if ( _rt_psrelocs_end <= v2 )
        return;
    }
    v7 = *(unsigned __int16 *)v3;
    if ( (v7 & 0x8000) != 0 )
    {
      v9[0] = (v7 | 0xFFFF0000) - v4 - 0x400000 + v5;
LABEL_26:
      __write_memory(v3, v9, 2u);
      goto LABEL_23;
    }
LABEL_20:
    v9[0] = v5 + v7 - v4 - 0x400000;
    if ( v6 == 16 )
      goto LABEL_26;
    goto LABEL_21;
  }
}
// 40187A: conditional instruction was optimized away because of 'edx.4==8'
// 40187F: conditional instruction was optimized away because of 'edx.4==8'
// 403128: using guessed type int _rt_psrelocs_start;

//----- (004018F8) --------------------------------------------------------
void __do_global_dtors()
{
  void (*i)(void); // eax

  for ( i = *p_1615; *p_1615; i = *p_1615 )
  {
    i();
    ++p_1615;
  }
}

//----- (00401928) --------------------------------------------------------
void __do_global_ctors()
{
  int i; // ebx

  i = __CTOR_LIST__[0];
  if ( __CTOR_LIST__[0] == -1 )
  {
    for ( i = 0; __CTOR_LIST__[i + 1]; ++i )
      ;
  }
  for ( ; i; --i )
    ((void (*)(void))__CTOR_LIST__[i])();
  atexit(__do_global_dtors);
}
// 401C60: using guessed type int __CTOR_LIST__[];

//----- (00401974) --------------------------------------------------------
void __main()
{
  if ( !initialized )
  {
    initialized = 1;
    __do_global_ctors();
  }
}

//----- (00401998) --------------------------------------------------------
void __mingwthr_run_key_dtors()
{
  volatile __mingwthr_key_t *i; // ebx
  LPVOID v1; // esi

  if ( __mingwthr_cs_init )
  {
    EnterCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
    for ( i = key_dtor_list; i; i = i->next )
    {
      v1 = TlsGetValue(i->key);
      if ( !GetLastError() )
      {
        if ( v1 )
          i->dtor(v1);
      }
    }
    LeaveCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
  }
}

//----- (00401A08) --------------------------------------------------------
int __cdecl ___w64_mingwthr_add_key_dtor(DWORD key, void (*dtor)(void *))
{
  volatile __mingwthr_key_t *v3; // eax
  volatile __mingwthr_key_t *v4; // ebx

  if ( !__mingwthr_cs_init )
    return 0;
  v3 = (volatile __mingwthr_key_t *)calloc(1u, 0xCu);
  v4 = v3;
  if ( !v3 )
    return -1;
  v3->key = key;
  v3->dtor = dtor;
  EnterCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
  v4->next = key_dtor_list;
  key_dtor_list = v4;
  LeaveCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
  return 0;
}

//----- (00401A78) --------------------------------------------------------
int __cdecl ___w64_mingwthr_remove_key_dtor(DWORD key)
{
  volatile __mingwthr_key_t *v2; // edx
  volatile __mingwthr_key_t *v3; // eax

  if ( !__mingwthr_cs_init )
    return 0;
  EnterCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
  v2 = key_dtor_list;
  if ( key_dtor_list )
  {
    if ( key_dtor_list->key == key )
    {
      key_dtor_list = key_dtor_list->next;
      v3 = v2;
LABEL_12:
      free((void *)v3);
      LeaveCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
      return 0;
    }
    while ( 1 )
    {
      v3 = v2->next;
      if ( !v3 )
        break;
      if ( v3->key == key )
      {
        v2->next = v3->next;
        goto LABEL_12;
      }
      v2 = v2->next;
    }
  }
  LeaveCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
  return 0;
}

//----- (00401B04) --------------------------------------------------------
WINBOOL __cdecl __mingw_TLScallback(HANDLE hDllHandle, DWORD reason, LPVOID reserved)
{
  WINBOOL result; // eax

  if ( reason == 1 )
  {
    if ( !__mingwthr_cs_init )
      InitializeCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
    __mingwthr_cs_init = 1;
    result = 1;
  }
  else
  {
    if ( reason )
    {
      if ( reason == 3 )
        __mingwthr_run_key_dtors();
    }
    else
    {
      __mingwthr_run_key_dtors();
      if ( __mingwthr_cs_init == 1 )
      {
        __mingwthr_cs_init = 0;
        DeleteCriticalSection((LPCRITICAL_SECTION)&__mingwthr_cs);
      }
    }
    result = 1;
  }
  return result;
}

//----- (00401C44) --------------------------------------------------------
int register_frame_ctor()
{
  __gcc_register_frame();
  return atexit(__gcc_deregister_frame);
}

// nfuncs=58 queued=26 decompiled=26 lumina nreq=0 worse=0 better=0
// ALL OK, 26 function(s) have been successfully decompiled
