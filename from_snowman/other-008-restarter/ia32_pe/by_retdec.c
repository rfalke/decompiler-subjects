//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
//

#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>
#include <windows.h>

// ------------------------ Structures ------------------------

struct _FILETIME {
    int32_t e0;
    int32_t e1;
};

struct _STARTUPINFOW {
    int32_t e0;
    int16_t * e1;
    int16_t * e2;
    int16_t * e3;
    int32_t e4;
    int32_t e5;
    int32_t e6;
    int32_t e7;
    int32_t e8;
    int32_t e9;
    int32_t e10;
    int32_t e11;
    int16_t e12;
    int16_t e13;
    char * e14;
    int32_t * e15;
    int32_t * e16;
    int32_t * e17;
};

struct _WIN32_FIND_DATAW {
    int32_t e0;
    struct _FILETIME e1;
    struct _FILETIME e2;
    struct _FILETIME e3;
    int32_t e4;
    int32_t e5;
    int32_t e6;
    int32_t e7;
    int16_t e8[1];
    int16_t e9[14];
    int32_t e10;
    int32_t e11;
    int16_t e12;
};

// ------------------- Function Prototypes --------------------

int32_t entry_point(void);
int32_t function_401000(int32_t * a1);
int32_t function_4010a0(void);

// --------------------- Global Variables ---------------------

int32_t g1 = 0; // 0x40207c
int32_t g2;

// ------------------------ Functions -------------------------

// Address range: 0x401000 - 0x40109d
int32_t function_401000(int32_t * a1) {
    int32_t errorCode = GetLastError(); // 0x40100b
    int16_t * lpBuffer = (int16_t *)errorCode; // 0x401020
    int32_t dwMessageId; // bp-8, 0x401000
    FormatMessageW(0, NULL, (int32_t)&dwMessageId, 1024, lpBuffer, 0, (int32_t *)0x1300);
    int32_t lpString = lstrlenW((int16_t *)dwMessageId); // 0x401038
    int32_t * memoryHandle = LocalAlloc(2 * (lstrlenW((int16_t *)lpString) + lpString) + 0x2000, 64); // 0x40104f
    wsprintfW((int16_t *)dwMessageId, lpBuffer);
    *(int16_t *)((int32_t)memoryHandle + 2048) = 0;
    MessageBoxW(NULL, L"Error", (int16_t *)memoryHandle, 0);
    LocalFree((int32_t *)dwMessageId);
    LocalFree(memoryHandle);
    ExitProcess(errorCode);
    // UNREACHABLE
}

// Address range: 0x4010a0 - 0x401124
int32_t function_4010a0(void) {
    // 0x4010a0
    int32_t lpFileName; // 0x4010a0
    if (DeleteFileW((int16_t *)lpFileName)) {
        // 0x4010ba
        return 1;
    }
    // 0x4010c5
    SetFileAttributesW((int16_t *)128, lpFileName);
    int16_t * lpFileName2 = (int16_t *)lpFileName; // 0x4010d1
    int16_t * v1 = lpFileName2; // bp-620, 0x4010d1
    if (DeleteFileW(lpFileName2)) {
        // 0x4010ba
        return 1;
    }
    int32_t v2 = 0; // 0x401116
    int32_t v3 = (int32_t)&v1;
    bool v4 = DeleteFileW((int16_t *)&g2); // 0x4010e1
    int32_t result = 1; // 0x4010e9
    while (!v4) {
        // 0x4010eb
        int32_t v5; // bp-596, 0x4010a0
        *(int32_t *)(v3 - 8) = (int32_t)&v5;
        int32_t v6 = v3 - 12; // 0x4010f2
        int32_t * v7 = FindFirstFileW((int16_t *)&g2, (struct _WIN32_FIND_DATAW *)&g2); // 0x4010f3
        int32_t v8; // 0x4010a0
        if (v7 != (int32_t *)-1) {
            int32_t v9 = v3 - 16; // 0x40110b
            *(int32_t *)v9 = (int32_t)v7;
            FindClose(&g2);
            v8 = v9;
        } else {
            // 0x4010fe
            result = 1;
            v8 = v6;
            if (GetLastError() == 2) {
                // break -> 0x4010ba
                break;
            }
        }
        int32_t v10 = v8 - 4; // 0x401112
        *(int32_t *)v10 = 100;
        Sleep((int32_t)&g2);
        v2++;
        result = 0;
        if (v2 >= 10) {
            // break -> 0x4010ba
            break;
        }
        v3 = v10;
        v4 = DeleteFileW((int16_t *)&g2);
        result = 1;
    }
    // 0x4010ba
    return result;
}

// Address range: 0x401130 - 0x4012a6
int32_t entry_point(void) {
    int16_t * v1 = GetCommandLineW(); // 0x401141
    int16_t * lpCommandLine = v1; // bp-120, 0x401147
    int16_t ** v2 = CommandLineToArgvW(v1, &g2); // 0x401148
    if (v2 == NULL) {
        // 0x401154
        function_401000(&g1);
        // UNREACHABLE
    }
    int32_t v3; // 0x401130
    if (v3 != 5) {
        // 0x40116c
        return v3 + 1000;
    }
    int32_t v4 = (int32_t)v2; // 0x401148
    int32_t * v5 = (int32_t *)(v4 + 4); // 0x40117a
    int32_t v6 = *v5; // 0x40117a
    int32_t v7 = v6; // 0x401181
    int32_t dwDesiredAccess = 0; // 0x401181
    if (v6 != 0) {
        int32_t v8 = 20;
        while (*(int16_t *)v7 != 0) {
            int32_t v9 = v8 - 1; // 0x401190
            v7 += 2;
            dwDesiredAccess = 0;
            if (v9 == 0) {
                goto lab_0x4011b0;
            }
            v8 = v9;
        }
        int32_t v10 = 20 - v8;
        int32_t v11 = 0; // 0x401130
        dwDesiredAccess = 0;
        if (v8 != 0 && v10 != 0) {
            int32_t v12 = v11 + 1; // 0x4011a4
            int32_t v13 = (int32_t)*(int16_t *)(2 * v11 + v6) - 48; // 0x4011a8
            v11 = v12;
            int32_t v14 = v13; // 0x4011ae
            dwDesiredAccess = v13;
            while (v12 != v10) {
                // 0x4011a0
                v12 = v11 + 1;
                v13 = 10 * v14 - 48 + (int32_t)*(int16_t *)(2 * v11 + v6);
                v11 = v12;
                v14 = v13;
                dwDesiredAccess = v13;
            }
        }
    }
  lab_0x4011b0:;
    int32_t * uExitCode = OpenProcess(dwDesiredAccess, false, 1); // 0x4011b5
    int32_t lpApplicationName; // bp-136, 0x401130
    if (uExitCode == NULL) {
        int32_t v15 = *v5; // 0x4011c1
        lpApplicationName = v15;
        function_401000((int32_t *)v15);
        // UNREACHABLE
    }
    // 0x4011dc
    lpApplicationName = 0;
    if (!TerminateProcess(NULL, (int32_t)uExitCode)) {
        // 0x4011e9
        function_401000(&g1);
        // UNREACHABLE
    }
    // 0x4011f8
    CloseHandle(uExitCode);
    int32_t lpExistingFileName = *(int32_t *)((function_4010a0() != 0 ? 12 : 16) + v4);
    int32_t * lpNewFileName = (int32_t *)(v4 + 8); // 0x401213
    if (!MoveFileW((int16_t *)lpExistingFileName, (int16_t *)*lpNewFileName)) {
        // 0x401222
        function_401000((int32_t *)*lpNewFileName);
        // UNREACHABLE
    }
    int32_t v16 = (int32_t)&lpCommandLine; // 0x401235
    int32_t v17 = v16;
    *(char *)v17 = 0;
    int32_t v18 = v17 + 1; // 0x401245
    while (v17 != v16 + 67) {
        // 0x401240
        v17 = v18;
        *(char *)v17 = 0;
        v18 = v17 + 1;
    }
    // 0x401247
    lpCommandLine = (int16_t *)68;
    int32_t v19 = &lpApplicationName; // 0x401254
    int32_t v20 = v19;
    *(char *)v20 = 0;
    int32_t v21 = v20 + 1; // 0x40125d
    while (v20 != v19 + 15) {
        // 0x401258
        v20 = v21;
        *(char *)v20 = 0;
        v21 = v20 + 1;
    }
    bool v22 = CreateProcessW((int16_t *)&lpApplicationName, (int16_t *)&lpCommandLine, NULL, NULL, false, 0, NULL, NULL, (struct _STARTUPINFOW *)lpExistingFileName, NULL); // 0x401271
    if (!v22) {
        // 0x40127b
        function_401000((int32_t *)lpExistingFileName);
        // UNREACHABLE
    }
    // 0x401286
    if (lpExistingFileName == *(int32_t *)(v4 + 12)) {
        // 0x40129b
        return 0;
    }
    // 0x401286
    function_4010a0();
    int32_t v23 = 99; // 0x401298
    int32_t v24 = v23; // 0x401299
    while (v23 != 0) {
        // 0x401290
        function_4010a0();
        v23 = v24 - 1;
        v24 = v23;
    }
    // 0x40129b
    return 0;
}

// --------------- Dynamically Linked Functions ---------------

// BOOL CloseHandle(_In_ HANDLE hObject);
// LPWSTR * CommandLineToArgvW(_In_ LPCWSTR lpCmdLine, _Out_ int * pNumArgs);
// BOOL CreateProcessW(_In_opt_ LPCWSTR lpApplicationName, _Inout_opt_ LPWSTR lpCommandLine, _In_opt_ LPSECURITY_ATTRIBUTES lpProcessAttributes, _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes, _In_ BOOL bInheritHandles, _In_ DWORD dwCreationFlags, _In_opt_ LPVOID lpEnvironment, _In_opt_ LPCWSTR lpCurrentDirectory, _In_ LPSTARTUPINFOW lpStartupInfo, _Out_ LPPROCESS_INFORMATION lpProcessInformation);
// BOOL DeleteFileW(_In_ LPCWSTR lpFileName);
// VOID ExitProcess(_In_ UINT uExitCode);
// BOOL FindClose(_Inout_ HANDLE hFindFile);
// HANDLE FindFirstFileW(_In_ LPCWSTR lpFileName, _Out_ LPWIN32_FIND_DATAW lpFindFileData);
// DWORD FormatMessageW(_In_ DWORD dwFlags, _In_opt_ LPCVOID lpSource, _In_ DWORD dwMessageId, _In_ DWORD dwLanguageId, _Out_ LPWSTR lpBuffer, _In_ DWORD nSize, _In_opt_ va_list * Arguments);
// LPWSTR GetCommandLineW(VOID);
// DWORD GetLastError(VOID);
// HLOCAL LocalAlloc(_In_ UINT uFlags, _In_ SIZE_T uBytes);
// HLOCAL LocalFree(HLOCAL hMem);
// int lstrlenW(_In_ LPCWSTR lpString);
// int MessageBoxW(_In_opt_ HWND hWnd, _In_opt_ LPCWSTR lpText, _In_opt_ LPCWSTR lpCaption, _In_ UINT uType);
// BOOL MoveFileW(_In_ LPCWSTR lpExistingFileName, _In_ LPCWSTR lpNewFileName);
// HANDLE OpenProcess(_In_ DWORD dwDesiredAccess, _In_ BOOL bInheritHandle, _In_ DWORD dwProcessId);
// BOOL SetFileAttributesW(_In_ LPCWSTR lpFileName, _In_ DWORD dwFileAttributes);
// VOID Sleep(_In_ DWORD dwMilliseconds);
// BOOL TerminateProcess(_In_ HANDLE hProcess, _In_ UINT uExitCode);
// int wsprintfW(_Out_ LPWSTR, _In_ LPCWSTR, ...);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: microsoft linker (10.0)
// Detected functions: 3

