// subject.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 003E1000: Register word32 fn003E1000(Stack (ptr Eq_3) dwArg04)
word32 fn003E1000(Eq_3 * dwArg04)
{
	return dwArg04 + Mem0[dwArg04 + 0x3C:word32];
}

// 003E101C: void fn003E101C(Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08, Stack Eq_10 dwArg0C)
void fn003E101C(Eq_3 * dwArg04, Eq_9 dwArg08, SIZE_T dwArg0C)
{
	fn003E1944(dwArg08, dwArg04, dwArg0C);
	VirtualProtect(dwArg08, dwArg0C, 0x02, fp - 0x08);
}

// 003E10B3: Register Eq_28 fn003E10B3(Stack Eq_9 dwArg04, Stack (ptr Eq_3) dwArg08, Stack Eq_9 dwArg0C)
FARPROC fn003E10B3(Eq_9 dwArg04, Eq_3 * dwArg08, Eq_9 dwArg0C)
{
	Eq_28 eax_39;
	Eq_28 eax_17 = GetProcAddress(dwArg04, dwArg0C);
	if (fn003E1A34(dwArg08, &globals->b3E2030) == 0x00)
	{
		if (fn003E19B0(0x003E2030, dwArg0C, &globals->b3E2040) == 0x00)
		{
			globals->t3E8810 = eax_17;
			eax_39 = (Eq_28) &globals->t3E1050;
			return eax_39;
		}
		if (fn003E19B0(0x003E2040, dwArg0C, &globals->b3E2054) == 0x00)
		{
			globals->t3E8814 = eax_17;
			eax_39 = (Eq_28) &globals->t3E1081;
			return eax_39;
		}
	}
	eax_39 = eax_17;
	return eax_39;
}

// 003E1125: Register byte fn003E1125(Stack Eq_9 dwArg04)
byte fn003E1125(Eq_9 dwArg04)
{
	return (byte) (-(dwArg04 & 0x80000000) == 0x00);
}

// 003E1138: void fn003E1138(Register ptr32 ebp, Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08)
void fn003E1138(ptr32 ebp, Eq_3 * dwArg04, Eq_9 dwArg08)
{
	globals->t3E8818 = GetModuleHandleA(0x00);
	globals->t3E881C = dwArg08;
	ptr32 esp_11 = fp - 44;
	word32 dwLoc08_203 = dwArg08 + Mem17[dwArg04 + 0x80:word32];
	while (true)
	{
		union Eq_9 * esp_53 = esp_11 - 0x04;
		*esp_53 = (union Eq_9 *) dwLoc08_203;
		if (*((char *) *esp_53 + 0x0C) == 0x00)
			break;
		Eq_9 dwLoc10_106;
		*esp_53 = (union Eq_9 *) dwLoc08_203;
		Eq_9 eax_68 = *esp_53;
		*esp_53 = (union Eq_9 *) dwArg08;
		word32 ecx_75 = Mem72[esp_53 + 0x00:word32] + Mem72[eax_68 + 0x0C:word32];
		*esp_53 = (union Eq_9 *) ecx_75;
		Eq_9 eax_80 = LoadLibraryA(*esp_53);
		if (*((word32) dwLoc08_203 + 0x04) == 0x00)
			dwLoc10_106 = dwArg08 + Mem79[dwLoc08_203 + 0x10:word32];
		else
		{
			*(esp_53 - 0x04) = (union Eq_9 *) dwLoc08_203;
			word32 * eax_212 = *(esp_53 - 0x04);
			*(esp_53 - 0x04) = (union Eq_9 *) dwArg08;
			dwLoc10_106 = *(esp_53 - 0x04) + *eax_212;
		}
		*(esp_53 - 0x04) = (union Eq_9 *) dwLoc08_203;
		union Eq_9 * esp_104 = esp_53;
		word32 dwLoc18_105 = dwArg08 + Mem89[Mem89[(esp_53 - 0x04) + 0x00:word32] + 0x10:word32];
		while (true)
		{
			union Eq_9 * esp_108 = esp_104 - 0x04;
			*esp_108 = (union Eq_9 *) dwLoc10_106;
			if (**esp_108 == 0x00)
				break;
			ptr32 esp_141;
			Eq_28 dwLoc14_140;
			*esp_108 = (union Eq_9 *) eax_80;
			*(esp_108 - 0x04) = (union Eq_9 *) dwLoc10_106;
			*(esp_108 - 0x04) = **(esp_108 - 0x04);
			if ((word32) fn003E1125(dwArg00) != 0x00)
			{
				*esp_108 = (union Eq_9 *) (word32) (word16) (*dwLoc10_106 & 0xFFFF);
				*(esp_108 - 0x04) = (union Eq_9 *) eax_80;
				esp_141 = esp_108 - 0x04;
				dwLoc14_140 = GetProcAddress(*(esp_108 - 0x04), *esp_108);
			}
			else
			{
				Mem178[esp_108 + 0x00:word32] = dwArg08 + Mem124[dwLoc10_106 + 0x00:word32];
				Mem185[esp_108 + 0x00:word32] = Mem178[esp_108 + 0x00:word32] + 0x02;
				*(esp_108 - 0x04) = (union Eq_9 *) ecx_75;
				*(esp_108 - 0x08) = (union Eq_9 *) eax_80;
				esp_141 = (char *) esp_108 + 0x04;
				dwLoc14_140 = fn003E10B3(dwArg00, dwArg04, dwArg08);
			}
			*dwLoc18_105 = (FARPROC *) dwLoc14_140;
			FARPROC ** esp_146 = esp_141 - 0x04;
			*esp_146 = (FARPROC **) dwLoc18_105;
			esp_104 = (union Eq_9 *) ((char *) esp_146 + 0x04);
			dwLoc18_105 = (FARPROC *) ((char *) *esp_146 + 0x04);
			dwLoc10_106 = (word32) dwLoc10_106 + 0x04;
		}
		*esp_108 = (union Eq_9 *) dwLoc08_203;
		esp_11 = (char *) esp_108 + 0x04;
		dwLoc08_203 = (char *) *esp_108 + 0x0014;
	}
}

// 003E1260: void fn003E1260(Register ui32 ecx, Stack word32 dwArg04, Stack word32 dwArg08, Stack word32 dwArg0C)
void fn003E1260(ui32 ecx, word32 dwArg04, word32 dwArg08, word32 dwArg0C)
{
	ptr32 esp_15 = fp - 0x08;
	do
	{
		LPOVERLAPPED * esp_16 = esp_15 - 0x04;
		*esp_16 = (LPOVERLAPPED *) null;
		*(esp_16 - 0x04) = fp - 0x08;
		*(esp_16 - 0x08) = dwArg0C;
		*(esp_16 - 0x08) = *(esp_16 - 0x08) - (ecx & 0x00);
		*(esp_16 - 0x0C) = dwArg08;
		*(esp_16 - 0x10) = dwArg04;
		if (ReadFile(*(esp_16 - 0x10), *(esp_16 - 0x0C), *(esp_16 - 0x08), *(esp_16 - 0x04), *esp_16) == 0x00)
			return;
		*(esp_16 - 0x14) = ecx & 0x00;
		esp_15 = esp_16 - 0x10;
	} while (*(esp_16 - 0x14) != dwArg0C);
}

// 003E1297: void fn003E1297(Register ui32 ecx, Stack word32 dwArg04, Stack word32 dwArg08, Stack word32 dwArg0C)
void fn003E1297(ui32 ecx, word32 dwArg04, word32 dwArg08, word32 dwArg0C)
{
	ptr32 esp_15 = fp - 0x08;
	do
	{
		LPOVERLAPPED * esp_16 = esp_15 - 0x04;
		*esp_16 = (LPOVERLAPPED *) null;
		*(esp_16 - 0x04) = fp - 0x08;
		*(esp_16 - 0x08) = dwArg0C;
		*(esp_16 - 0x08) = *(esp_16 - 0x08) - (ecx & 0x00);
		*(esp_16 - 0x0C) = dwArg08;
		*(esp_16 - 0x10) = dwArg04;
		if (WriteFile(*(esp_16 - 0x10), *(esp_16 - 0x0C), *(esp_16 - 0x08), *(esp_16 - 0x04), *esp_16) == 0x00)
			return;
		*(esp_16 - 0x14) = ecx & 0x00;
		esp_15 = esp_16 - 0x10;
	} while (*(esp_16 - 0x14) != dwArg0C);
}

// 003E12CE: void fn003E12CE(Register ui32 ecx, Stack (ptr Eq_506) dwArg04, Stack ui32 dwArg08, Stack uint32 dwArg0C)
void fn003E12CE(ui32 ecx, Eq_506 * dwArg04, ui32 dwArg08, uint32 dwArg0C)
{
	uint32 dwLoc08_14 = ecx & 0x00;
	while (dwLoc08_14 < dwArg0C)
	{
		fn003E1297(dwArg08, dwArg04->dw0004, dwArg08 + dwLoc08_14 * 0x04, 0x08);
		fn003E1260(dwArg08, dwArg04->dw0000, dwArg08 + dwLoc08_14 * 0x04, 0x08);
		dwLoc08_14 = dwLoc08_14 + 0x02;
	}
}

// 003E1415: Register Eq_380 fn003E1415(Stack (ptr Eq_3) dwArg04)
HANDLE fn003E1415(Eq_3 * dwArg04)
{
	CloseHandle(dwArg04->b0000);
	Eq_380 v7_18 = dwArg04[0x04];
	CloseHandle(v7_18);
	return v7_18;
}

// 003E1432: Register word32 fn003E1432(Register ui32 ecx, Register ptr32 ebp)
word32 fn003E1432(ui32 ecx, ptr32 ebp)
{
	if ((word32) fn003E15D0()->ptr0030->b0002 == 0x00)
	{
		globals->dw40FF0E = 5900;
		globals->dw40FF0E = globals->dw40FF0E + 22702;
		globals->dw40FF12 = 0x24C5;
		globals->dw40FF16 = 0x17F4;
		globals->dw40FF16 = globals->dw40FF16 + 22574;
		globals->dw40FF1A = 0x4BC0;
		if (CreatePipe(fp - 0x24, fp - 0x14, null, 0x10) != 0x00 && CreatePipe(fp - 0x18, fp - 0x20, null, 0x10) != 0x00)
		{
			CreateThread(null, 0x00, &globals->t3E1322, fp - 0x24, 0x00, fp - 0x0C);
			fn003E12CE(ecx, fp - 0x18, 0x003E3000, globals->dw3E8803 >> 0x02);
			*(fp - 0x70) = fn003E1415(fp - 0x18) - 0x20;
			ptr32 ebp_156 = fn003E1415(dwArg00);
			*(fp - 0x70) = *(ebp_156 - 0x24);
			CloseHandle(*(fp - 0x70));
			*(fp - 116) = 0x003E3000;
			*(ebp_156 - 0x0C) = fn003E1000(dwArg00);
			if (*(ebp_156 - 0x0C) != 0x00)
			{
				*(ebp_156 - 44) = *((char *) *(ebp_156 - 0x0C) + 0x0034);
				*(fp - 116) = *((char *) *(ebp_156 - 0x0C) + 0x0054);
				*(fp - 0x78) = *(ebp_156 - 44);
				*(fp - 0x7C) = 0x003E3000;
				fn003E101C(dwArg00, dwArg04, dwArg08);
				*(fp - 116) = *(ebp_156 - 44);
				*(fp - 0x78) = 0x003E3000;
				*(fp - 0x7C) = *(ebp_156 - 0x0C);
				fn003E15E0(dwArg00, dwArg04, dwArg08);
				*(fp - 116) = *(ebp_156 - 44);
				*(ebp_156 - 0x28) = fn003E1000(dwArg00);
				if (*(ebp_156 - 0x28) != 0x00)
				{
					*(fp - 116) = *(ebp_156 - 44);
					*(fp - 0x78) = *(ebp_156 - 0x28);
					fn003E1138(ebp_156, dwArg00, dwArg04);
					*(fp - 116) = *(ebp_156 - 44);
					*(fp - 0x78) = *(ebp_156 - 0x28);
					fn003E1778(ebp_156, dwArg00, dwArg04);
					*((char *) *(ebp_156 - 0x18) + 0x08) = *(ebp_156 - 44);
					*(fp - 116) = *(ebp_156 - 0x0C);
					struct Eq_869 * eax_240 = *(fp - 116);
					*(fp - 116) = *(ebp_156 - 44);
					word32 ecx_247 = *(fp - 116) + eax_240->dw0028;
					*(ebp_156 - 0x30) = ecx_247;
					word32 esp_250;
					word32 ebp_251;
					byte SCZO_252;
					word32 eax_253;
					byte SZO_254;
					byte C_255;
					byte Z_256;
					word32 ecx_257;
					(*(ebp_156 - 0x30))();
				}
			}
		}
	}
	return 0x00;
}

// 003E15B6: Register Eq_21 Win32CrtStartup()
DWORD Win32CrtStartup()
{
	*(fp - 0x08) = fn003E1432(ecx, fp - 0x04);
	*(fp - 0x0C) = *(fp - 0x08);
	ExitProcess(*(fp - 0x0C));
}

// 003E15D0: Register word32 fn003E15D0()
word32 fn003E15D0()
{
	return fs->dw0018;
}

// 003E15E0: void fn003E15E0(Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08, Stack Eq_10 dwArg0C)
void fn003E15E0(Eq_3 * dwArg04, Eq_9 dwArg08, SIZE_T dwArg0C)
{
	word16 ax_21 = dwArg04[0x06];
	cui16 wLoc14_138 = wLoc14 & 0x00;
	while ((word32) wLoc14_138 < (word32) ax_21)
	{
		Eq_10 dwLoc2C_140;
		Eq_10 v15_64 = (dwArg04 + 0x00F8)[(word32) wLoc14_138 *s 0x28 + 0x08];
		Eq_10 eax_77 = (dwArg04 + 0x00F8)[(word32) wLoc14_138 *s 0x28 + 0x10];
		if (v15_64 < eax_77)
			dwLoc2C_140 = v15_64;
		else
			dwLoc2C_140 = eax_77;
		fn003E1944(dwArg0C + Mem0[((word32) wLoc14_138 *s 0x28 + 0x0C) + (dwArg04 + 0xF8):word32], dwArg08 + Mem0[((word32) wLoc14_138 *s 0x28 + 0x14) + (dwArg04 + 0xF8):word32], dwLoc2C_140);
		wLoc14_138 = wLoc14_138 + 0x01;
	}
}

// 003E16AE: Register ui32 fn003E16AE(Register Eq_1001 ecx, Stack ui32 dwArg04)
ui32 fn003E16AE(Eq_1001 ecx, ui32 dwArg04)
{
	ui32 dwLoc08_14 = ecx & 0x00;
	if ((dwArg04 & 0x04000000) != 0x00)
		dwLoc08_14 = ecx & 0x00 | 0x0200;
	ui32 dwLoc08_108;
	if ((dwArg04 & 0x20000000) != 0x00)
	{
		if ((dwArg04 & 0x40000000) != 0x00)
		{
			if ((dwArg04 & 0x80000000) != 0x00)
				dwLoc08_108 = dwLoc08_14 | 0x40;
			else
				dwLoc08_108 = dwLoc08_14 | 0x20;
		}
		else if ((dwArg04 & 0x80000000) != 0x00)
			dwLoc08_108 = dwLoc08_14 | 0x80;
		else
			dwLoc08_108 = dwLoc08_14 | 0x10;
	}
	else if ((dwArg04 & 0x40000000) != 0x00)
	{
		if ((dwArg04 & 0x80000000) != 0x00)
			dwLoc08_108 = dwLoc08_14 | 0x04;
		else
			dwLoc08_108 = dwLoc08_14 | 0x02;
	}
	else if ((dwArg04 & 0x80000000) != 0x00)
		dwLoc08_108 = dwLoc08_14 | 0x08;
	else
		dwLoc08_108 = dwLoc08_14 | 0x01;
	return dwLoc08_108;
}

// 003E1778: void fn003E1778(Register ptr32 ebp, Stack (ptr Eq_3) dwArg04, Stack Eq_9 dwArg08)
void fn003E1778(ptr32 ebp, Eq_3 * dwArg04, Eq_9 dwArg08)
{
	ptr32 esp_16 = fp - 0x20;
	word16 ax_21 = dwArg04[0x06];
	cui16 wLoc14_27 = wLoc14 & 0x00;
	while ((word32) wLoc14_27 < (word32) ax_21)
	{
		word32 edx_48 = dwArg08 + Mem0[((word32) wLoc14_27 *s 0x28 + 0x0C) + (dwArg04 + 0xF8):word32];
		word32 eax_53 = (dwArg04 + 0x00F8)[(word32) wLoc14_27 *s 0x28 + 0x08];
		PDWORD * esp_56 = esp_16 - 0x04;
		*esp_56 = (PDWORD *) (fp - 0x18);
		*(esp_56 - 0x04) = (word32) (dwArg04 + 0x00F8)[(word32) wLoc14_27 *s 0x28 + 0x24];
		*(esp_56 - 0x04) = fn003E16AE(dwArg04 + 0x00F8, dwArg00);
		*(esp_56 - 0x08) = eax_53;
		*(esp_56 - 0x0C) = edx_48;
		VirtualProtect(*(esp_56 - 0x0C), *(esp_56 - 0x08), *(esp_56 - 0x04), *esp_56);
		esp_16 = esp_56 - 0x0C;
		wLoc14_27 = wLoc14_27 + 0x01;
	}
}

// 003E1810: Register int32 fn003E1810(Stack int32 dwArg04)
int32 fn003E1810(int32 dwArg04)
{
	int32 eax_12;
	if (dwArg04 >= 0x41 && dwArg04 <= 0x5A)
		eax_12 = dwArg04 + 0x20;
	else
		eax_12 = dwArg04;
	return eax_12;
}

// 003E1944: void fn003E1944(Stack Eq_9 dwArg04, Stack (ptr Eq_3) dwArg08, Stack Eq_10 dwArg0C)
void fn003E1944(Eq_9 dwArg04, Eq_3 * dwArg08, SIZE_T dwArg0C)
{
	while (true)
	{
		dwArg0C = dwArg0C - 0x01;
		if (dwArg0C == 0x00)
			break;
		*dwArg04 = dwArg08->b0000;
		dwArg04 = (word32) dwArg04 + 0x01;
		dwArg08 = dwArg08 + 0x01;
	}
}

// 003E19B0: Register int32 fn003E19B0(Register word32 ecx, Stack Eq_9 dwArg04, Stack (ptr byte) dwArg08)
int32 fn003E19B0(word32 ecx, Eq_9 dwArg04, byte * dwArg08)
{
	while (true)
	{
		int32 eax_28 = (word32) *dwArg04 - (word32) (*dwArg08);
		int32 dwLoc08_31 = eax_28;
		if (eax_28 != 0x00 || (int32) (*dwArg08) == 0x00)
			break;
		dwArg04 = (word32) dwArg04 + 0x01;
		dwArg08 = dwArg08 + 0x01;
	}
	if (eax_28 < 0x00)
		dwLoc08_31 = eax_28 | ~0x00;
	else if (eax_28 > 0x00)
		dwLoc08_31 = 0x01;
	return dwLoc08_31;
}

// 003E1A34: Register word32 fn003E1A34(Stack (ptr Eq_3) dwArg04, Stack (ptr byte) dwArg08)
word32 fn003E1A34(Eq_3 * dwArg04, byte * dwArg08)
{
	do
	{
		word32 eax_23 = fn003E1810((word32) dwArg04->b0000);
		dwArg04 = dwArg04 + 0x01;
		word32 eax_37 = fn003E1810((word32) *dwArg08);
		dwArg08 = dwArg08 + 0x01;
	} while (eax_23 != 0x00 && eax_23 == eax_37);
	return eax_23 - eax_37;
}

