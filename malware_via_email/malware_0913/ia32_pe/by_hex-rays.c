/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __cdecl start(int a1, int a2, int a3, char a4);
// void __usercall sub_4010CE(int a1@<ecx>, int a2@<ebx>, int a3@<ebp>, int a4@<edi>);
void sub_401695();


//----- (00401005) --------------------------------------------------------
void __cdecl start(int a1, int a2, int a3, char a4)
{
  JUMPOUT(0x401378);
}
// 40103F: control flows out of bounds to 401378

//----- (004010CE) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_4010CE(int a1@<ecx>, int a2@<ebx>, int a3@<ebp>, int a4@<edi>)
{
  int v4; // ebx
  _WORD *v5; // eax
  int v6; // ebp
  int v7; // eax
  int v8; // ecx
  int v9; // eax
  unsigned int v10; // eax
  unsigned int v11; // edi
  int v12; // eax
  unsigned __int16 v13; // cx
  int v14; // edi
  int v15; // esi
  int v16; // ebp
  unsigned int v17; // eax
  __int16 v18; // bx
  int v19; // edx
  char *v20; // edx
  unsigned int i; // eax
  int v22; // eax
  int j; // edi
  unsigned __int8 v24; // cl
  char v25; // dh
  int v26; // ebp
  int v27; // esi
  _DWORD v28[2]; // [esp-8h] [ebp-154h]
  int v29; // [esp+0h] [ebp-14Ch]
  int *v30; // [esp+4h] [ebp-148h]
  int v31; // [esp+8h] [ebp-144h]
  int v32[64]; // [esp+Ch] [ebp-140h] BYREF
  int v33; // [esp+10Ch] [ebp-40h] BYREF
  int v34; // [esp+110h] [ebp-3Ch]
  int *v35; // [esp+114h] [ebp-38h]
  int *v36; // [esp+118h] [ebp-34h]
  int v37; // [esp+11Ch] [ebp-30h] BYREF
  int v38; // [esp+120h] [ebp-2Ch]
  int v39; // [esp+124h] [ebp-28h]
  int *v40; // [esp+128h] [ebp-24h]
  int v41; // [esp+12Ch] [ebp-20h]
  int v42; // [esp+130h] [ebp-1Ch]
  int v43; // [esp+134h] [ebp-18h]
  int v44; // [esp+138h] [ebp-14h]
  _WORD *v45; // [esp+13Ch] [ebp-10h]
  _WORD *v46; // [esp+140h] [ebp-Ch]
  _WORD *v47; // [esp+144h] [ebp-8h]

  v46 = (_WORD *)a3;
  LOWORD(v5) = 0;
  HIWORD(v5) = HIWORD(v47);
  LOWORD(a1) = *v5;
  LOWORD(v5) = 0;
  v47 = v5 + 12312;
  v46 = v5 + 13886;
  v45 = v5 + 12312;
  v43 = a2;
  v42 = a4;
  v41 = 0;
  v40 = 0;
  v39 = 16711681;
  v38 = a4 - (a1 + 42418) + 2;
  v37 = 16711686;
  v6 = a3 + 1;
  v36 = &v37;
  sub_401695();
  v40 = &v37;
  v39 = v7;
  v38 = v7;
  v37 = v7;
  (*(void (**)(void))(a2 + 24))();
  v36 = (int *)((*(int (**)(void))(a2 + 28))() + 6);
  v35 = v36;
  v34 = (*(int (**)(void))a2)();
  v33 = v8;
  v32[63] = (int)&v33;
  v32[62] = 64;
  v41 = 0;
  v9 = (*(int (__cdecl **)(int, int *, int))(a2 - 4 + 16))(-1, v40, v43);
  v10 = __readfsdword(v9 + 47) + v9;
  v40 = (int *)((char *)v40 + *(_DWORD *)(v10 + 3));
  v43 ^= *(_DWORD *)(v10 + 3);
  v30 = v35;
  v31 = v39;
  v29 = v32[61];
  for ( i = 0; i < 0x100; ++i )
    *((_BYTE *)v32 + i) = i;
  v14 = v29;
  if ( (_BYTE)v45 != 121 )
  {
    v14 = v44;
    do
    {
      (*(void (**)(void))(v14 + 24))();
      (*(void (**)(void))(v14 + 16))();
      (*(void (**)(void))(v14 + 24))();
      (*(void (**)(void))(v14 + 24))();
      (*(void (**)(void))(v14 + 24))();
      (*(void (**)(void))(v14 + 24))();
      (*(void (**)(void))(v14 + 24))();
      v12 = (*(int (**)(void))(v14 + 16))() + 1;
    }
    while ( (unsigned __int16)v12 < v13 );
  }
  v29 = v6;
  v28[1] = &v33;
  v28[0] = v14;
  v11 = v37;
  v17 = 0;
  v15 = 0;
  v16 = 0;
  while ( 1 )
  {
    LOBYTE(v18) = *((_BYTE *)v32 + v16);
    v19 = v15 + (unsigned __int8)v18 + *(unsigned __int8 *)(v31 + v17);
    BYTE1(v19) = 0;
    ++v17;
    v15 = v19;
    if ( v17 >= v11 )
      v17 = 0;
    *((_BYTE *)v32 + v16++) = *((_BYTE *)v32 + v19);
    v20 = (char *)v32 + v19 - v17;
    HIBYTE(v18) = v20[v17 + 1];
    *(_WORD *)&v20[v17] = v18;
    if ( BYTE1(v16) == 1 )
    {
      v27 = 0;
      v22 = 0;
      v26 = v38;
      for ( j = (int)v30; v26; --v26 )
      {
        ++v22;
        BYTE1(v22) = 0;
        v24 = *((_BYTE *)v32 + v22);
        v4 = v27 + v24;
        BYTE1(v4) = 0;
        v25 = *((_BYTE *)&v28[5] + v4);
        *((_BYTE *)v32 + v22) = v25;
        *((_BYTE *)&v28[5] + v4) = v24;
        v27 = v4;
        *(_WORD *)(j++ - 1) ^= *(_WORD *)((char *)&v28[5] + (unsigned __int8)(v24 + v25)) << 8;
      }
      __asm { retn }
    }
  }
}
// 40176B: positive sp value 8 has been found
// 401222: variable 'v7' is possibly undefined
// 4012AC: variable 'v8' is possibly undefined
// 40143C: variable 'v13' is possibly undefined

//----- (00401695) --------------------------------------------------------
void sub_401695()
{
  JUMPOUT(0x401165);
}
// 4016CC: control flows out of bounds to 401165

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
