/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

unsigned int __cdecl sub_1310D000(_BYTE *, int, int, _DWORD *, unsigned int, int);
// int __userpurge start@<eax>(int, int, int, int, int, int);
int sub_1310D5CD();
// int __stdcall WahOpenNotificationHandleHelper(_DWORD); weak
// int __stdcall WahOpenHandleHelper(_DWORD); weak
// int __stdcall WahCloseHandleHelper(_DWORD); weak

//-------------------------------------------------------------------------
// Data declarations

char byte_1310D5F7 = '\0'; // weak
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);


//----- (1310D000) --------------------------------------------------------
unsigned int __cdecl sub_1310D000(_BYTE *a1, int a2, int a3, _DWORD *a4, unsigned int a5, int a6)
{
  unsigned int result; // eax
  __int16 v8; // [esp+14h] [ebp-Ch]
  _BYTE *i; // [esp+2Ch] [ebp+Ch]

  *a4 = a3;
  result = a5 / 5;
  v8 = a5 % 5;
  for ( i = (_BYTE *)(a5 + a2); a3--; ++i )
  {
    *a1 = *(_BYTE *)(a6 + v8++) ^ *i;
    if ( v8 == 5 )
      v8 = 0;
    result = (unsigned int)++a1;
  }
  return result;
}

//----- (1310D09B) --------------------------------------------------------
int __userpurge start@<eax>(int a1, int a2, int a3, int a4, int a5, int a6)
{
  int v7; // [esp+10h] [ebp-2C0h]
  unsigned int v8; // [esp+70h] [ebp-260h]
  _BYTE *v9; // [esp+74h] [ebp-25Ch]
  int v10; // [esp+78h] [ebp-258h] BYREF
  int v11[3]; // [esp+7Ch] [ebp-254h] BYREF
  unsigned int v12; // [esp+88h] [ebp-248h]
  _BYTE *v13; // [esp+8Ch] [ebp-244h] BYREF
  unsigned int v14; // [esp+90h] [ebp-240h]
  int v15; // [esp+94h] [ebp-23Ch]
  int v16; // [esp+98h] [ebp-238h] BYREF
  int v17; // [esp+9Ch] [ebp-234h] BYREF
  char v18[520]; // [esp+A0h] [ebp-230h] BYREF
  unsigned int v19; // [esp+2A8h] [ebp-28h]
  void **v20; // [esp+2ACh] [ebp-24h] BYREF
  int *v21; // [esp+2B0h] [ebp-20h]
  HMODULE ModuleHandleA; // [esp+2B4h] [ebp-1Ch]
  _BYTE *v23; // [esp+2B8h] [ebp-18h] BYREF
  int v24; // [esp+2BCh] [ebp-14h]
  int v25; // [esp+2C0h] [ebp-10h] BYREF
  int v26; // [esp+2C4h] [ebp-Ch] BYREF
  _BYTE *v27; // [esp+2C8h] [ebp-8h]
  int v28; // [esp+2CCh] [ebp-4h]
  void *retaddr; // [esp+2D4h] [ebp+4h] BYREF

  v18[3] = 102;
  v15 = WahOpenNotificationHandleHelper(0);
  WahOpenHandleHelper(0);
  WahOpenNotificationHandleHelper(0);
  v7 = WahOpenHandleHelper(0) - 2147221182 + v15;
  v18[0] = -112;
  v18[1] = 48;
  v18[4] = -34;
  v15 = v7 - 1827875568;
  v16 = *(_DWORD *)(v7 - 1827875568);
  sub_1310D000(&v16, (int)&v16, 4, &v26, 0, (int)v18);
  v20 = &retaddr;
  v18[2] = -126;
  v11[0] = *(_DWORD *)(v7 - 1827875568 + 4);
  sub_1310D000(v11, (int)&v10, 4, &v26, 4u, (int)v18);
  v25 = *(_DWORD *)(v15 + 8);
  sub_1310D000(&v25, (int)&v23, 4, &v26, 8u, (int)v18);
  v21 = (int *)(v15 + 12);
  ModuleHandleA = GetModuleHandleA(0);
  v11[1] = (int)(ModuleHandleA + 1024);
  v12 = 12;
  v23 = (_BYTE *)*v21;
  sub_1310D000(&v23, (int)&v20, 4, &v26, 0xCu, (int)v18);
  v23 = &v23[(_DWORD)ModuleHandleA];
  v12 += 4;
  v13 = (_BYTE *)*++v21;
  sub_1310D000(&v13, (int)&(&v13)[v12 / 0xFFFFFFFC], 4, &v26, v12, (int)v18);
  v12 += 4;
  ++v21;
  v19 = 8 * v25 + 12;
  v9 = VirtualAlloc((LPVOID)(v7 + 2147221008), v16 + v11[0] + v19, 0x3000u, 0x40u);
  v27 = &v23[v19];
  v14 = v19;
  v8 = v19;
  v28 = 0;
  v24 = 0;
  while ( 1 )
  {
    if ( (_BYTE *)v8 != v13 )
      goto LABEL_5;
    if ( ++v28 == v25 )
      break;
    v23 = (_BYTE *)*v21;
    sub_1310D000(&v23, (int)&(&v23)[v12 / 0xFFFFFFFC], 4, &v26, v12, (int)v18);
    v23 = &v23[(_DWORD)ModuleHandleA];
    v12 += 4;
    v13 = (_BYTE *)*++v21;
    sub_1310D000(&v13, (int)&(&v13)[v12 / 0xFFFFFFFC], 4, &v26, v12, (int)v18);
    v12 += 4;
    ++v21;
    v8 = 0;
    v27 = v23;
LABEL_5:
    v9[v24++] = *v27++;
    ++v8;
    ++v14;
  }
  sub_1310D000(v9, (int)&v9[-v19], v11[0], &v17, v19, (int)v18);
  return ((int (__stdcall *)(_BYTE *, _BYTE *, int, int, char *, void **, int, int, int, int, int, int, int, int))(v9 + 3920))(
           &v9[v11[0]],
           v9,
           v16,
           v11[0],
           v18,
           v20,
           20709376,
           30277632,
           12928,
           105472,
           120320,
           258048,
           281018368,
           1610612736);
}
// 1310D09B: could not find valid save-restore pair for ebx
// 13111168: using guessed type int __stdcall WahOpenNotificationHandleHelper(_DWORD);
// 1311116C: using guessed type int __stdcall WahOpenHandleHelper(_DWORD);

//----- (1310D5CD) --------------------------------------------------------
int sub_1310D5CD()
{
  ((void (__cdecl *)(int, int))byte_1310D5F7)(0x10000, 196608);
  return WahCloseHandleHelper(0);
}
// 1310D5F7: using guessed type char byte_1310D5F7;
// 13111170: using guessed type int __stdcall WahCloseHandleHelper(_DWORD);

// nfuncs=4 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
