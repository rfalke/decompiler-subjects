/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// DWORD __stdcall GetCurrentProcessId();
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// HANDLE __stdcall CreateFileMappingA(HANDLE hFile, LPSECURITY_ATTRIBUTES lpFileMappingAttributes, DWORD flProtect, DWORD dwMaximumSizeHigh, DWORD dwMaximumSizeLow, LPCSTR lpName);
// SIZE_T __stdcall VirtualQuery(LPCVOID lpAddress, PMEMORY_BASIC_INFORMATION lpBuffer, SIZE_T dwLength);
// LPVOID __stdcall MapViewOfFile(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap);
// BOOL __stdcall VirtualFree(LPVOID lpAddress, SIZE_T dwSize, DWORD dwFreeType);
HANDLE start();
SIZE_T __stdcall sub_401364(LPCVOID lpAddress);
void __noreturn sub_401A98(); // weak
int __fastcall sub_401AB6(_DWORD, _DWORD); // weak

//-------------------------------------------------------------------------
// Data declarations

int dword_4012E8[11] =
{
  -1957405565,
  48955531,
  1364381579,
  206828416,
  -621418616,
  274471215,
  2064387216,
  273684783,
  354028688,
  269228335,
  2093288592
}; // weak


//----- (00401314) --------------------------------------------------------
HANDLE start()
{
  HANDLE result; // eax
  void *v1; // [esp-4h] [ebp-4h]

  result = CreateFileMappingA((HANDLE)0xFFFFFFFF, 0, 4u, 0, 0x4000u, 0);
  if ( result )
  {
    v1 = result;
    GetCurrentProcessId();
    result = MapViewOfFile(v1, 6u, 0, 0, 0);
    if ( result )
      result = (HANDLE)sub_401364(result);
  }
  return result;
}

//----- (00401364) --------------------------------------------------------
SIZE_T __stdcall sub_401364(LPCVOID lpAddress)
{
  SIZE_T result; // eax
  struct _MEMORY_BASIC_INFORMATION v2; // [esp+0h] [ebp-1Ch] BYREF

  VirtualQuery(lpAddress, &v2, 0x1Cu);
  result = v2.RegionSize >> 12;
  *(PVOID *)((char *)&v2.BaseAddress + (v2.RegionSize >> 12)) = *(char **)((char *)&v2.BaseAddress
                                                                         + (v2.RegionSize >> 12))
                                                              + (v2.RegionSize >> 12);
  return result;
}

//----- (00401A98) --------------------------------------------------------
void __noreturn sub_401A98()
{
  int *v0; // edi
  int *v1; // esi
  int v2; // ecx
  int v3; // eax
  int *v4; // [esp+0h] [ebp-18h]

  v1 = dword_4012E8;
  v4 = (int *)VirtualAlloc(0, 0x8B8u, 0x3000u, 0x40u);
  v0 = v4;
  v2 = 559;
  do
  {
    v3 = *v1++;
    *v0++ = v3 ^ 0xCD0;
    --v2;
  }
  while ( v2 );
  sub_401AB6(v4, 0x400000);
}
// 4012E8: using guessed type int dword_4012E8[11];
// 401A98: using guessed type void __noreturn sub_401A98();
// 401AB6: using guessed type int __fastcall sub_401AB6(_DWORD, _DWORD);

// nfuncs=4 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
