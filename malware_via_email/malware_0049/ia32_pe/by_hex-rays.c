/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// SIZE_T __stdcall VirtualQuery(LPCVOID lpAddress, PMEMORY_BASIC_INFORMATION lpBuffer, SIZE_T dwLength);
// BOOL __stdcall VirtualFree(LPVOID lpAddress, SIZE_T dwSize, DWORD dwFreeType);
// LPVOID __stdcall MapViewOfFile(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap);
// DWORD __stdcall GetCurrentProcessId();
// HANDLE __stdcall CreateFileMappingA(HANDLE hFile, LPSECURITY_ATTRIBUTES lpFileMappingAttributes, DWORD flProtect, DWORD dwMaximumSizeHigh, DWORD dwMaximumSizeLow, LPCSTR lpName);
int __fastcall nullsub_1(_DWORD, _DWORD); // weak
int sub_4014B2();
HANDLE start();
SIZE_T __stdcall sub_401AC7(LPCVOID lpAddress);

//-------------------------------------------------------------------------
// Data declarations

char byte_4012AF = 'R'; // weak


//----- (004014B2) --------------------------------------------------------
int sub_4014B2()
{
  int *v0; // edi
  int v2; // ecx
  int v3; // eax
  char *v4; // esi
  int *v5; // [esp+0h] [ebp-18h]

  v4 = &byte_4012AF;
  v5 = (int *)VirtualAlloc(0, 0x8BCu, 0x3000u, 0x40u);
  v0 = v5;
  v2 = 560;
  do
  {
    v3 = *(_DWORD *)v4;
    v4 += 4;
    *v0++ = v3 ^ 0x1000;
    --v2;
  }
  while ( v2 );
  return nullsub_1(v5, 0x400000);
}
// 4014B2: could not find valid save-restore pair for edi
// 4012AF: using guessed type char byte_4012AF;
// 40147B: using guessed type int __fastcall nullsub_1(_DWORD, _DWORD);

//----- (00401A77) --------------------------------------------------------
HANDLE start()
{
  HANDLE result; // eax
  void *v1; // [esp-4h] [ebp-4h]

  result = CreateFileMappingA((HANDLE)0xFFFFFFFF, 0, 4u, 0, 0x4000u, 0);
  if ( result )
  {
    v1 = result;
    GetCurrentProcessId();
    result = MapViewOfFile(v1, 6u, 0, 0, 0);
    if ( result )
      result = (HANDLE)sub_401AC7(result);
  }
  return result;
}

//----- (00401AC7) --------------------------------------------------------
SIZE_T __stdcall sub_401AC7(LPCVOID lpAddress)
{
  SIZE_T result; // eax
  struct _MEMORY_BASIC_INFORMATION v2; // [esp+0h] [ebp-1Ch] BYREF

  VirtualQuery(lpAddress, &v2, 0x1Cu);
  result = v2.RegionSize >> 12;
  *(PVOID *)((char *)&v2.BaseAddress + (v2.RegionSize >> 12)) = *(char **)((char *)&v2.BaseAddress
                                                                         + (v2.RegionSize >> 12))
                                                              + (v2.RegionSize >> 12);
  return result;
}

// nfuncs=4 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
