/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// HRESULT __stdcall CoRegisterPSClsid(const IID *const riid, const IID *const rclsid);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// DWORD __stdcall GetTickCount();
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// HANDLE __stdcall GetProcessHeap();
// DWORD __stdcall SizeofResource(HMODULE hModule, HRSRC hResInfo);
// HGLOBAL __stdcall LoadResource(HMODULE hModule, HRSRC hResInfo);
// DWORD __stdcall GetVersion();
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall GetFileType(HANDLE hFile);
// HWND __stdcall GetFocus();
// void __usercall start(double@<st0>);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_1310107F; // weak
CHAR FileName[] = "Qw4Cg0yVQvbxkK678XXtTAM3iL.z1d"; // idb
CHAR aJ1ptsq3lbcA08[] = "J1PTSq3lBc.A08"; // idb


//----- (13102A6C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall start(double a1@<st0>)
{
  _DWORD *v2; // et0
  unsigned int *v3; // edi
  __int64 v4; // rax
  unsigned int v5; // ett
  DWORD v6; // ett
  unsigned int v8; // edi
  unsigned int v9; // et0
  unsigned int v10; // edx
  char v11; // t1
  _DWORD *v13; // eax
  _DWORD *v14; // edi
  char *v15; // ebp
  int v17; // ecx
  _BYTE *v18; // eax
  int v19; // ecx
  HRESULT v20; // edi
  _DWORD *v21; // esi
  int v22; // ebx
  _DWORD *v23; // esi
  int v24; // edi
  _WORD *v25; // ebx
  bool v27; // cf
  char v28; // zf
  DWORD FileSize; // eax
  unsigned int v30; // ecx
  const IID *v31; // [esp-10h] [ebp-38h]
  const IID *v32; // [esp-Ch] [ebp-34h]
  _DWORD *v33; // [esp-8h] [ebp-30h]
  int v34; // [esp-4h] [ebp-2Ch]
  _WORD *v35; // [esp+0h] [ebp-28h]
  DWORD Version; // [esp+4h] [ebp-24h]
  HRSRC FileA; // [esp+Ch] [ebp-1Ch]
  HRSRC hResInfo; // [esp+24h] [ebp-4h]
  _DWORD *savedregs; // [esp+28h] [ebp+0h] BYREF
  char *retaddr; // [esp+2Ch] [ebp+4h]

  v32 = 0;
  GetTickCount();
  v31 = 0;
  FileA = (HRSRC)CreateFileA(FileName, 0xE0000000, 1u, 0, 3u, 0x24u, 0);
  do
  {
    v20 = CoRegisterPSClsid(v31, v32);
    v21 = (_DWORD *)((char *)&loc_1310107F + 1);
    GetTickCount();
    CloseHandle(FileA);
    CloseHandle(FileA);
  }
  while ( CreateFileA(aJ1ptsq3lbcA08, 0x20000000u, 3u, 0, 3u, 0xA2u, 0) != (HANDLE)-1 );
  v22 = 1390;
  do
  {
    *v21 += v20;
    Version = GetVersion();
    *v21 = __ROR4__(*v21, 72);
    GetFocus();
    *v21 += v20;
    GetFileType(FileA);
    *v21 = -*v21;
    SizeofResource(0, (HRSRC)0xFFFFFFFF);
    GetVersion();
    *v21 += v20;
    *v21 += v20;
    GetProcessHeap();
    *v21 = -*v21;
    *v21 ^= v20;
    GetVersion();
    *v21 ^= 0x4F14E84Bu;
    GetTickCount();
    *v21 = __ROR4__(*v21, 229);
    LoadResource(0, (HRSRC)0xFFFFFFFF);
    ++v21;
    --v22;
  }
  while ( v22 );
  GetFileSize((HANDLE)0xFFFFFFFF, 0);
  v23 = v33;
  SizeofResource(0, FileA);
  v24 = v34;
  GetVersion();
  SizeofResource(0, FileA);
  v25 = v35;
  CloseHandle((HANDLE)0xFFFFFFFF);
  _EBP = Version;
  FileSize = GetFileSize(*(HANDLE *)(Version - 4), 0);
  if ( v27 | v28 )
  {
    v13 = &savedregs;
    __outdword(0x94u, (unsigned int)&savedregs);
    v14 = savedregs;
    v15 = retaddr;
    *(double *)((char *)savedregs + 2 * (_DWORD)v25 + 1603594153) = a1;
    *(_DWORD *)((char *)v23 - 852926570) -= &savedregs;
    *v14 = *v23;
    _ESI = v23 + 1;
    ++v14;
    v17 = -1321402095;
    LOBYTE(v13) = (unsigned __int8)&savedregs ^ 0xED;
    *((_BYTE *)_ESI + 90324750) ^= 0x81u;
    v18 = (char *)v13 + 576108606;
    v27 = *v18 > 0x11u;
    LOBYTE(v17) = 17 - *v18;
    __inbyte(0x15u);
    LOBYTE(v18) = v27;
    *(_BYTE *)v14 = v27;
    __asm { outsd }
    *(v15 - 12) += v27 + 107;
    v19 = v17 - 1;
    if ( !(*((_BYTE *)v14 - 22) + (_BYTE)v25) || !v19 )
    {
      *v18 = ~*v18;
      JUMPOUT(0x62FEA5D4);
    }
    JUMPOUT(0x13101078);
  }
  v2 = (_DWORD *)FileSize;
  _EAX = v24;
  *v2 = v24;
  LOWORD(v3) = (_WORD)v2 + 4;
  __asm { frstor  byte ptr [eax+ebp*2-62h] }
  BYTE1(v30) = 41;
  LOBYTE(v25) = *(_BYTE *)v30;
  while ( 1 )
  {
    v27 = BYTE1(v30) < *(_BYTE *)(v30 + Version + 893888447);
    BYTE1(v30) -= *(_BYTE *)(v30 + Version + 893888447);
    __ES__ = (_WORD)hResInfo;
    LODWORD(v4) = v25;
    v25 = (_WORD *)MEMORY[0x6E100764];
    v4 = (int)v4;
    v5 = v4;
    _EAX = v30;
    v30 = v5;
    v6 = v27 + Version;
    v27 = HIDWORD(v4) < v5;
    v10 = HIDWORD(v4) - v5;
    v9 = _EAX;
    BYTE1(_EAX) = BYTE1(v3);
    v8 = v9;
    __asm { rcl     dword ptr ds:0FFBD4D49h, 0B4h }
    hResInfo = (HRSRC)&savedregs;
    v11 = BYTE1(v30);
    BYTE1(v30) = BYTE1(v10);
    BYTE1(v10) = v11;
    LOBYTE(v25) = *(_BYTE *)(v9 - 1026241096);
    *(_BYTE *)(v10 + 75) = v27 + *(_BYTE *)(v10 + 75) - 88;
    if ( !v30 )
      break;
    LOBYTE(_EAX) = *(_BYTE *)((unsigned __int16)__DS__ - 117);
    v3 = (unsigned int *)(v8 + 1);
    *(_DWORD *)(9 * v10 - 394859776) |= (unsigned __int16)__DS__;
    _EAX = (__int16)_EAX;
    __asm { das }
    if ( __OFSUB__(*(_DWORD *)(v30 + 18), v25) )
    {
      BYTE1(_EAX) = -95;
      *(char *)(v30 - 44) >>= 7;
      LOBYTE(_EAX) = v30 + _EAX;
      if ( *v3 > _EAX )
      {
        __asm { icebp }
        *v25 = (__int16)a1;
        __asm { into }
        JUMPOUT(0x131010A2);
      }
      JUMPOUT(0x13101075);
    }
  }
  JUMPOUT(0x13100FF7);
}
// 131010AD: positive sp value 8 has been found
// 131010A1: control flows out of bounds to 131010A2
// 131010F1: control flows out of bounds to 62FEA5D4
// 13101066: control flows out of bounds to 13100FF7
// 1310108B: control flows out of bounds to 13101075
// 1310109F: control flows out of bounds to 13101088
// 131010E2: control flows out of bounds to 13101078
// 13102AA6: variable 'v31' is possibly undefined
// 13102AA6: variable 'v32' is possibly undefined
// 13102B94: variable 'v33' is possibly undefined
// 13102BA2: variable 'v34' is possibly undefined
// 13102BBB: variable 'v35' is possibly undefined
// 13101036: variable 'v30' is possibly undefined
// 13101046: variable 'hResInfo' is possibly undefined
// 131010A6: variable 'v27' is possibly undefined
// 131010A6: variable 'v28' is possibly undefined

// nfuncs=12 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
