/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall start@<eax>(int (*)(void)@<eax>, int@<edx>, int@<ecx>, __int32 *@<ebx>);
// int __usercall sub_4092F3@<eax>(int@<edx>, int@<ebp>, _DWORD *@<esi>);
void __cdecl sub_40934F(char *a1, _BYTE *a2);
int __stdcall sub_40951C(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int __fastcall sub_409522(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int __stdcall sub_409528(_DWORD); // weak
int __stdcall sub_40952E(_DWORD); // weak
int __stdcall sub_409534(_DWORD, _DWORD); // weak

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_409000; // weak


//----- (00401E14) --------------------------------------------------------
int __usercall start@<eax>(int (*a1)(void)@<eax>, int a2@<edx>, int a3@<ecx>, __int32 *a4@<ebx>)
{
  char *v4; // eax
  int v5; // eax
  int v6; // edx
  unsigned int v7; // ecx
  _DWORD *v8; // esi
  int v9; // eax
  unsigned int *v10; // esi
  char *v11; // edi
  unsigned int v12; // eax
  int *v13; // esi
  int v14; // eax
  int v15; // eax
  int v16; // eax
  int v17; // edx
  int v18; // edx
  __int16 v19; // bx
  int v20; // esi
  _DWORD *v21; // esi
  int v22; // ecx
  int *i; // edx
  int v24; // eax
  int v25; // eax
  int v26; // ebx
  int *v27; // edx
  int v28; // esi
  int v29; // edi
  int *v30; // esi
  int *j; // edi
  int v32; // eax
  bool v33; // sf
  _WORD *v34; // eax
  int v35; // eax
  char *v37; // edi
  int v38; // [esp-38h] [ebp-3Ch]
  int v39; // [esp-30h] [ebp-34h]
  int *v40; // [esp-2Ch] [ebp-30h]
  int v41; // [esp-28h] [ebp-2Ch]
  int v42; // [esp-24h] [ebp-28h]
  int *v43; // [esp-24h] [ebp-28h]
  int *v44; // [esp-20h] [ebp-24h]
  int v45; // [esp-20h] [ebp-24h]
  int (*v46)(void); // [esp-1Ch] [ebp-20h]
  __int32 *v47; // [esp-1Ch] [ebp-20h]
  int v48; // [esp-18h] [ebp-1Ch]
  int v49; // [esp-18h] [ebp-1Ch]
  int v50; // [esp-14h] [ebp-18h]

  v50 = a3;
  v48 = a2;
  v46 = a1;
  if ( *((_BYTE *)&loc_409000 + 1342) != 1 )
  {
    *((_BYTE *)&loc_409000 + 1342) = 1;
    v4 = (char *)&loc_409000 - *(_DWORD *)((char *)&loc_409000 + 1355);
    *((_DWORD *)&loc_409000 + 325) = &loc_409000;
    *(_DWORD *)((char *)&loc_409000 + 1419) = v4;
    *(_DWORD *)((char *)&loc_409000 + 1347) = *(_DWORD *)((char *)&loc_409000 + 1391)
                                            + *(_DWORD *)((char *)&loc_409000 + 1419);
    if ( *((_BYTE *)&loc_409000 + 1340) == 1 )
    {
      a4 = (__int32 *)(*(_DWORD *)((char *)&loc_409000 + 1419) + *(_DWORD *)((char *)&loc_409000 + 1383));
      *(_DWORD *)((char *)&loc_409000 + 1383) = a4;
      *a4 = _InterlockedExchange((volatile __int32 *)((char *)&loc_409000 + 1395), *a4);
    }
    v5 = sub_40951C(0, *(_DWORD *)((char *)&loc_409000 + 1375), 4096, 4, v46, a2, a3);
    if ( !v5 )
LABEL_45:
      __asm { jmp     ecx }
    *(_DWORD *)((char *)&loc_409000 + 1379) = v5;
    v8 = (_DWORD *)((char *)&loc_409000 + *(_DWORD *)((char *)&loc_409000 + 1371));
    while ( 1 )
    {
      v9 = *v8;
      v10 = v8 + 1;
      if ( !v9 )
        break;
      v11 = (char *)(*(_DWORD *)((char *)&loc_409000 + 1419) + v9);
      v12 = *v10;
      v13 = (int *)(v10 + 1);
      v7 = v12;
      v14 = *v13;
      v8 = v13 + 1;
      if ( v14 )
      {
        qmemcpy(*(void **)((char *)&loc_409000 + 1379), v11, v7);
        sub_40934F(*(char **)((char *)&loc_409000 + 1379), v11);
        v16 = v15 - 5;
        v7 = 0;
        v49 = v17;
        v47 = a4;
        v18 = 0;
        while ( --v16 && v16 >= 0 )
        {
          v19 = *(_WORD *)&v11[v7];
          if ( (_BYTE)v19 == 0xE8 || (_BYTE)v19 == 0xE9 )
          {
            *(_DWORD *)&v11[v7 + 1] -= v7;
            v7 += 5;
            v16 -= 4;
          }
          else if ( v19 == 9727 )
          {
            *(_DWORD *)&v11[v7 + 2] -= v18;
            v7 += 6;
            v18 -= 4;
            v16 -= 5;
          }
          else
          {
            ++v7;
          }
        }
        *((_BYTE *)&loc_409000 + 211) = -8;
        a4 = v47;
        v6 = v49;
      }
    }
    sub_409522(v7, v6, *(_DWORD *)((char *)&loc_409000 + 1379), *(_DWORD *)((char *)&loc_409000 + 1375), 4);
    if ( *((_BYTE *)&loc_409000 + 1340) == 1 )
      **(_DWORD **)((char *)&loc_409000 + 1383) = *(_DWORD *)((char *)&loc_409000 + 1395);
    *(_DWORD *)((char *)&loc_409000 + 1343) = *(_DWORD *)((char *)&loc_409000 + 1347);
    *(_DWORD *)((char *)&loc_409000 + 1351) = *(_DWORD *)((char *)&loc_409000 + 1419)
                                            + *(_DWORD *)((char *)&loc_409000 + 1347)
                                            - *(_DWORD *)((char *)&loc_409000 + 1343);
    v20 = *(_DWORD *)((char *)&loc_409000 + 1387);
    if ( v20 )
    {
      v21 = (_DWORD *)(*(_DWORD *)((char *)&loc_409000 + 1419) + v20 + 16);
      if ( *(_DWORD *)((char *)&loc_409000 + 1347) != *(_DWORD *)((char *)&loc_409000 + 1415) )
        sub_4092F3(
          *(_DWORD *)((char *)&loc_409000 + 1347) - *(_DWORD *)((char *)&loc_409000 + 1415),
          (int)&loc_409000,
          v21);
      if ( *(_DWORD *)((char *)&loc_409000 + 1419) != *(_DWORD *)((char *)&loc_409000 + 1423) )
        sub_4092F3(
          *(_DWORD *)((char *)&loc_409000 + 1419) - *(_DWORD *)((char *)&loc_409000 + 1423),
          (int)&loc_409000,
          v21);
    }
    v22 = *(_DWORD *)((char *)&loc_409000 + 1419);
    for ( i = *(int **)((char *)&loc_409000 + 1347); ; i = v27 + 5 )
    {
      v24 = i[3];
      if ( !v24 )
        break;
      i[3] = v22;
      v44 = i;
      v42 = v22;
      v41 = *(_DWORD *)((char *)&loc_409000 + 1351) + v24;
      *(_DWORD *)((char *)&loc_409000 + 1363) = v41;
      v25 = sub_409528(v41);
      v26 = v41;
      v22 = v42;
      v27 = v44;
      if ( !v25 )
      {
        v25 = sub_40952E(v41);
        if ( !v25 )
        {
          (*(void (__stdcall **)(char *, char *, int, char *, int))((char *)&loc_409000 + 1465))(
            (char *)&loc_409000 + 1486,
            (char *)&loc_409000 + 1233,
            v26,
            (char *)&loc_409000 + 1486,
            v42);
          goto LABEL_45;
        }
        v22 = v42;
        v27 = v44;
      }
      *(_DWORD *)((char *)&loc_409000 + 569) = v25;
      v28 = *v27;
      *v27 = v22;
      v29 = v27[4];
      v27[4] = v22;
      if ( !v28 )
        v28 = v29;
      v30 = (int *)(*(_DWORD *)((char *)&loc_409000 + 1351) + v28);
      for ( j = (int *)(*(_DWORD *)((char *)&loc_409000 + 1351) + v29); ; ++j )
      {
        v32 = *v30;
        v33 = *v30 < 0;
        if ( !*v30 )
          break;
        *v30 = v22;
        if ( v33 )
        {
          v32 = (unsigned __int16)v32;
        }
        else
        {
          v34 = (_WORD *)(*(_DWORD *)((char *)&loc_409000 + 1351) + v32);
          *v34 = 0;
          v32 = (int)(v34 + 1);
        }
        v45 = v32;
        v43 = v27;
        v40 = j;
        v39 = v22;
        v38 = v32;
        v35 = sub_409534(305419896, v32);
        if ( !v35 )
        {
          v37 = (char *)&loc_409000 + 1270;
          if ( (v38 & 0xFFFF0000) != 0 )
            v37 = (char *)&loc_409000 + 1251;
          (*(void (__stdcall **)(char *, char *, int, _DWORD, char *, int, int, int *, int *))((char *)&loc_409000 + 1465))(
            (char *)&loc_409000 + 1486,
            v37,
            v38,
            *(_DWORD *)((char *)&loc_409000 + 1363),
            (char *)&loc_409000 + 1486,
            v26,
            v39,
            v40,
            v30);
          goto LABEL_45;
        }
        v22 = v39;
        *j = v35;
        v27 = v43;
        v26 = v45;
        ++v30;
      }
    }
  }
  return ((int (__fastcall *)(int, int))v46)(v50, v48);
}
// 401E14: could not find valid save-restore pair for esi
// 4090CA: variable 'v15' is possibly undefined
// 4090CF: variable 'v17' is possibly undefined
// 40912B: variable 'v7' is possibly undefined
// 40912B: variable 'v6' is possibly undefined
// 409270: variable 'v46' is possibly undefined
// 409270: variable 'v50' is possibly undefined
// 409270: variable 'v48' is possibly undefined
// 40951C: using guessed type int __stdcall sub_40951C(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 409522: using guessed type int __fastcall sub_409522(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 409528: using guessed type int __stdcall sub_409528(_DWORD);
// 40952E: using guessed type int __stdcall sub_40952E(_DWORD);
// 409534: using guessed type int __stdcall sub_409534(_DWORD, _DWORD);

//----- (004092F3) --------------------------------------------------------
int __usercall sub_4092F3@<eax>(int a1@<edx>, int a2@<ebp>, _DWORD *a3@<esi>)
{
  int result; // eax
  int *v4; // esi
  _DWORD *v5; // ebx
  unsigned __int8 v6; // al
  int *v7; // esi
  int v8; // ecx
  unsigned __int16 v9; // ax
  int v10; // eax
  unsigned __int8 v11; // al

  result = *a3;
  v4 = a3 + 1;
  if ( result )
  {
    v5 = (_DWORD *)(*(_DWORD *)(a2 + 1419) + result);
    *v5 += a1;
    while ( 1 )
    {
      LOBYTE(result) = *(_BYTE *)v4;
      v4 = (int *)((char *)v4 + 1);
      *((_BYTE *)v4 - 1) = a1;
      result = (unsigned __int8)result;
      if ( !(_BYTE)result )
        return result;
      if ( (_BYTE)result == 1 )
        break;
      if ( (_BYTE)result == 2 )
      {
        result = *v4++;
LABEL_7:
        v5 = (_DWORD *)((char *)v5 + result);
        *v5 += a1;
      }
      else
      {
        if ( (_BYTE)result != 3 )
          goto LABEL_7;
        v6 = *(_BYTE *)v4;
        v7 = (int *)((char *)v4 + 1);
        v8 = v6;
        if ( v6 )
        {
          if ( v6 == 1 )
          {
            v10 = *v7++;
            v8 = v10;
          }
        }
        else
        {
          v9 = *(_WORD *)v7;
          v7 = (int *)((char *)v7 + 2);
          v8 = v9;
        }
        v11 = *(_BYTE *)v7;
        v4 = (int *)((char *)v7 + 1);
        do
        {
          v5 = (_DWORD *)((char *)v5 + v11);
          *v5 += a1;
          --v8;
        }
        while ( v8 );
      }
    }
    LOWORD(result) = *(_WORD *)v4;
    v4 = (int *)((char *)v4 + 2);
    result = (unsigned __int16)result;
    goto LABEL_7;
  }
  return result;
}

//----- (0040934F) --------------------------------------------------------
void __cdecl sub_40934F(char *a1, _BYTE *a2)
{
  char v4; // dl
  char v5; // al
  bool v6; // cf
  char v7; // dl
  char v8; // tt
  bool v9; // cf
  char v10; // dl
  char v11; // tt
  int v12; // eax
  bool v13; // cf
  char v14; // dl
  char v15; // tt
  bool v16; // cf
  char v17; // dl
  char v18; // dl
  char v19; // tt
  BOOL v20; // eax
  bool v21; // cf
  char v22; // dl
  char v23; // dl
  char v24; // tt
  int v25; // eax
  bool v26; // cf
  char v27; // dl
  char v28; // dl
  char v29; // tt
  int v30; // eax
  bool v31; // cf
  char v32; // dl
  char v33; // tt
  int v34; // eax
  int v35; // eax
  bool v36; // cf
  char v37; // dl
  char v38; // dl
  char v39; // tt
  bool v40; // cf
  char v41; // dl
  char v42; // tt
  int v43; // eax
  unsigned int v44; // ecx
  bool v45; // cf
  char v46; // dl
  char v47; // dl
  char v48; // tt
  bool v49; // cf
  char v50; // dl
  char v51; // tt
  unsigned int v52; // eax
  unsigned int v53; // ecx
  bool v54; // cf
  char v55; // dl
  char v56; // dl
  char v57; // tt
  bool v58; // cf
  char v59; // dl
  char v60; // tt
  unsigned int v61; // ecx
  unsigned __int8 v62; // al
  char v63; // cf
  unsigned int v64; // ecx
  int savedregs; // [esp+4h] [ebp+0h] BYREF

  v4 = 0x80;
LABEL_2:
  v5 = *a1++;
  *a2++ = v5;
  while ( 1 )
  {
    while ( 1 )
    {
      while ( 1 )
      {
        v6 = __CFADD__(v4, v4);
        v4 *= 2;
        if ( !v4 )
        {
          v7 = *a1++;
          v8 = v6 + v7;
          v6 = __CFADD__(v6, v7) | __CFADD__(v7, v6 + v7);
          v4 = v7 + v8;
        }
        if ( !v6 )
          goto LABEL_2;
        v9 = __CFADD__(v4, v4);
        v4 *= 2;
        if ( !v4 )
        {
          v10 = *a1++;
          v11 = v9 + v10;
          v9 = __CFADD__(v9, v10) | __CFADD__(v10, v9 + v10);
          v4 = v10 + v11;
        }
        if ( v9 )
          break;
        v35 = 1;
        do
        {
          v36 = __CFADD__(v4, v4);
          v37 = 2 * v4;
          if ( !v37 )
          {
            v38 = *a1++;
            v39 = v36 + v38;
            v36 = __CFADD__(v36, v38) | __CFADD__(v38, v36 + v38);
            v37 = v38 + v39;
          }
          v35 += v36 + v35;
          v40 = __CFADD__(v37, v37);
          v4 = 2 * v37;
          if ( !v4 )
          {
            v41 = *a1++;
            v42 = v40 + v41;
            v40 = __CFADD__(v40, v41) | __CFADD__(v41, v40 + v41);
            v4 = v41 + v42;
          }
        }
        while ( v40 );
        v43 = v35 - 2;
        if ( v43 )
        {
          v52 = (v43 - 1) << 8;
          LOBYTE(v52) = *a1++;
          v53 = 1;
          do
          {
            v54 = __CFADD__(v4, v4);
            v55 = 2 * v4;
            if ( !v55 )
            {
              v56 = *a1++;
              v57 = v54 + v56;
              v54 = __CFADD__(v54, v56) | __CFADD__(v56, v54 + v56);
              v55 = v56 + v57;
            }
            v53 += v54 + v53;
            v58 = __CFADD__(v55, v55);
            v4 = 2 * v55;
            if ( !v4 )
            {
              v59 = *a1++;
              v60 = v58 + v59;
              v58 = __CFADD__(v58, v59) | __CFADD__(v59, v58 + v59);
              v4 = v59 + v60;
            }
          }
          while ( v58 );
          if ( v52 >= 0x7D00 )
          {
LABEL_47:
            v53 += 2;
LABEL_48:
            qmemcpy(a2, &a2[-v52], v53);
            a2 += v53;
          }
          else
          {
            if ( v52 < 0x500 )
            {
              if ( v52 > 0x7F )
                goto LABEL_48;
              goto LABEL_47;
            }
            v61 = v53 + 1;
            qmemcpy(a2, &a2[-v52], v61);
            a2 += v61;
          }
        }
        else
        {
          v44 = 1;
          do
          {
            v45 = __CFADD__(v4, v4);
            v46 = 2 * v4;
            if ( !v46 )
            {
              v47 = *a1++;
              v48 = v45 + v47;
              v45 = __CFADD__(v45, v47) | __CFADD__(v47, v45 + v47);
              v46 = v47 + v48;
            }
            v44 += v45 + v44;
            v49 = __CFADD__(v46, v46);
            v4 = 2 * v46;
            if ( !v4 )
            {
              v50 = *a1++;
              v51 = v49 + v50;
              v49 = __CFADD__(v49, v50) | __CFADD__(v50, v49 + v50);
              v4 = v50 + v51;
            }
          }
          while ( v49 );
          qmemcpy(a2, (const void *)(a2 - (_BYTE *)&savedregs), v44);
          a2 += v44;
        }
      }
      v12 = 0;
      v13 = __CFADD__(v4, v4);
      v4 *= 2;
      if ( !v4 )
      {
        v14 = *a1++;
        v15 = v13 + v14;
        v13 = __CFADD__(v13, v14) | __CFADD__(v14, v13 + v14);
        v4 = v14 + v15;
      }
      if ( !v13 )
        break;
      v16 = __CFADD__(v4, v4);
      v17 = 2 * v4;
      if ( !v17 )
      {
        v18 = *a1++;
        v19 = v16 + v18;
        v16 = __CFADD__(v16, v18) | __CFADD__(v18, v16 + v18);
        v17 = v18 + v19;
      }
      v20 = v16;
      v21 = __CFADD__(v17, v17);
      v22 = 2 * v17;
      if ( !v22 )
      {
        v23 = *a1++;
        v24 = v21 + v23;
        v21 = __CFADD__(v21, v23) | __CFADD__(v23, v21 + v23);
        v22 = v23 + v24;
      }
      v25 = v20 + v21 + v20;
      v26 = __CFADD__(v22, v22);
      v27 = 2 * v22;
      if ( !v27 )
      {
        v28 = *a1++;
        v29 = v26 + v28;
        v26 = __CFADD__(v26, v28) | __CFADD__(v28, v26 + v28);
        v27 = v28 + v29;
      }
      v30 = v25 + v26 + v25;
      v31 = __CFADD__(v27, v27);
      v4 = 2 * v27;
      if ( !v4 )
      {
        v32 = *a1++;
        v33 = v31 + v32;
        v31 = __CFADD__(v31, v32) | __CFADD__(v32, v31 + v32);
        v4 = v32 + v33;
      }
      v34 = v30 + v31 + v30;
      if ( v34 )
        LOBYTE(v34) = a2[-v34];
      *a2++ = v34;
    }
    v62 = *a1++;
    v63 = v62 & 1;
    LOBYTE(v12) = v62 >> 1;
    if ( !(_BYTE)v12 )
      break;
    v64 = v63 + 2;
    qmemcpy(a2, &a2[-v12], v64);
    a2 += v64;
  }
}
// 40934F: could not find valid save-restore pair for esi

// nfuncs=8 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
