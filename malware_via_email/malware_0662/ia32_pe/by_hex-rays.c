/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// DWORD __usercall start@<eax>(int@<edi>, int@<esi>);
// void __usercall sub_401DB8(__int64 _RAX@<edx:eax>, unsigned int@<ecx>, int@<ebp>, _DWORD *@<edi>, int@<esi>);

//-------------------------------------------------------------------------
// Data declarations

char byte_4015D8[] = { '€' }; // weak
int dword_4028D8[202] =
{
  -2060637603,
  127520221,
  1413808683,
  333595012,
  -555949268,
  1868308716,
  -921818349,
  1225980773,
  -1549054910,
  926332615,
  -1309336045,
  830535909,
  1358890724,
  401950185,
  -613816581,
  1799234731,
  -840421471,
  1302003598,
  -1489286914,
  880653731,
  -1292034595,
  813628140,
  1586235258,
  425478996,
  -707401651,
  1683827651,
  -1036836771,
  1136783435,
  -1452128590,
  980859796,
  -1129639134,
  1044247682,
  1598359871,
  418794122,
  -731452934,
  1713711547,
  -1060887922,
  1089663616,
  -1441839639,
  963492011,
  -1079046105,
  1024391041,
  1546324510,
  463817183,
  -683349324,
  1724983635,
  -1071504779,
  1103295408,
  -1421720393,
  942127568,
  -1107160716,
  127530555,
  1719804033,
  555512698,
  -591732437,
  1829708435,
  -873846350,
  2060437683,
  -1873117276,
  50627279,
  -2060637603,
  127520013,
  1719808129,
  555512686,
  -308359157,
  1545802683,
  -86108030,
  2060437683,
  -1873117276,
  50627279,
  -2060637603,
  127520013,
  1719808129,
  555512686,
  -308359157,
  1545802683,
  -86108030,
  2060437683,
  -1873117276,
  50627279,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
// extern BOOL (__stdcall *AreAllAccessesGranted)(DWORD GrantedAccess, DWORD DesiredAccess);
// extern DWORD (__stdcall *AddUsersToEncryptedFile)(LPCWSTR lpFileName, PENCRYPTION_CERTIFICATE_LIST pEncryptionCertificates);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
const WCHAR FileName = 0u; // idb
char byte_404000[512] =
{
  '_',
  '„',
  'Ê',
  '¹',
  'ï',
  'G',
  'w',
  '\b',
  'Ö',
  'L',
  'Š',
  '®',
  'ç',
  'œ',
  '›',
  '.',
  'ð',
  '+',
  '\x0E',
  'Ä',
  '›',
  'Ö',
  'P',
  'W',
  '\t',
  '~',
  'y',
  'Ñ',
  'Y',
  '™',
  'Í',
  'S',
  'Õ',
  'd',
  'Ö',
  '2',
  ':',
  '\'',
  'H',
  'u',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0'
}; // weak


//----- (00401000) --------------------------------------------------------
DWORD __usercall start@<eax>(int a1@<edi>, int a2@<esi>)
{
  int v2; // ebx
  int v3; // ebp
  DWORD result; // eax
  int v5; // esi
  int v6; // edx
  int v7; // edi
  unsigned int v8; // eax
  char *v9; // esi
  int *v10; // ecx
  int v11; // ebp
  _WORD *v12; // edx
  unsigned int v13; // ebx
  __int64 v14; // rax
  bool v15; // zf
  char *v16; // ebx
  int v17; // ebp
  DWORD flOldProtect; // [esp+4h] [ebp-10h] BYREF
  char *i; // [esp+8h] [ebp-Ch]
  int v20; // [esp+Ch] [ebp-8h]
  char *v21; // [esp+10h] [ebp-4h]

  v2 = 0;
  v3 = 40;
  result = AddUsersToEncryptedFile(&FileName, 0);
  if ( result )
  {
    v5 = result + 4 * a2;
    if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
      v3 = 38;
    VirtualProtect(start, 0x3000u, 0x40u, &flOldProtect);
    v7 = v5 + 2 * a1;
    v8 = 0;
    while ( 1 )
    {
      v6 = v2 + 4 * v6;
      if ( v2 == v3 )
        v2 = 0;
      byte_4015D8[v8] ^= byte_404000[v2] ^ 0x54;
      v5 = v6 + 8 * v5;
      ++v8;
      ++v2;
      if ( v8 >= 0x1440 )
      {
        v9 = &byte_4015D8[-640];
        v10 = dword_4028D8;
        v21 = &byte_4015D8[-640];
        v11 = (int)&byte_4015D8[-268436096];
        i = 0;
        while ( 1 )
        {
          v12 = v10 + 2;
          if ( (unsigned int)(v10[1] - 8) >> 1 )
          {
            v13 = (unsigned int)(v10[1] - 8) >> 1;
            do
            {
              v7 = *v12 & 0xF000;
              if ( v7 == 12288 )
                *(_DWORD *)&v9[*v10 + (*v12 & 0xFFF)] += v11;
              ++v12;
              --v13;
            }
            while ( v13 );
          }
          LODWORD(v14) = v10[1];
          HIDWORD(v14) = &i[v14];
          v10 = (int *)((char *)v10 + v14);
          i += v14;
          if ( (unsigned int)i >= 0xE4 )
          {
            v15 = *(_DWORD *)&byte_4015D8[2812] == 0;
            v16 = &byte_4015D8[2796];
            for ( i = &byte_4015D8[2796]; !v15; i = v16 )
            {
              LODWORD(v14) = LoadLibraryA(&v9[*((_DWORD *)v16 + 3)]);
              HIDWORD(v14) = v14;
              v20 = v14;
              v7 = (int)&v16[2 * v7];
              if ( (_DWORD)v14 )
              {
                v17 = *(_DWORD *)v16;
                if ( !*(_DWORD *)v16 )
                  v17 = *((_DWORD *)v16 + 4);
                v11 = (int)&v9[v17];
                LODWORD(v14) = *(_DWORD *)v11;
                v7 = (int)&v9[*((_DWORD *)i + 4)];
                if ( *(_DWORD *)v11 )
                {
                  while ( 1 )
                  {
                    if ( (int)v14 >= 0 )
                    {
                      LODWORD(v14) = GetProcAddress((HMODULE)HIDWORD(v14), &v9[v14 + 2]);
                    }
                    else
                    {
                      LODWORD(v14) = GetProcAddress((HMODULE)HIDWORD(v14), (LPCSTR)*(unsigned __int16 *)v11);
                      v9 = v21;
                    }
                    v11 += 4;
                    *(_DWORD *)v7 = v14;
                    LODWORD(v14) = *(_DWORD *)v11;
                    v7 += 4;
                    if ( !*(_DWORD *)v11 )
                      break;
                    HIDWORD(v14) = v20;
                  }
                }
                v16 = i;
              }
              v16 += 20;
              v15 = *((_DWORD *)v16 + 4) == 0;
            }
            sub_401DB8(v14, (unsigned int)sub_401DB8, v11, (_DWORD *)v7, (int)v9);
            ExitProcess(0);
          }
        }
      }
    }
  }
  return result;
}
// 401060: variable 'v6' is possibly undefined
// 4011B5: variable 'v14' is possibly undefined
// 4028D8: using guessed type int dword_4028D8[202];

//----- (00401DB8) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_401DB8(__int64 _RAX@<edx:eax>, unsigned int a2@<ecx>, int a3@<ebp>, _DWORD *a4@<edi>, int a5@<esi>)
{
  bool v5; // cf
  _DWORD *v6; // esi
  _DWORD *v7; // esi
  __int64 v8; // rax
  __int16 v9; // cx
  int v10; // ebp

  v5 = MEMORY[0x4934BF8] < a2;
  MEMORY[0x4934BF8] -= a2;
  v6 = (_DWORD *)(MEMORY[0x1D853C6A] + v5 + a5);
  v5 = *v6 < *a4;
  v7 = v6 + 1;
  _RAX = (int)_RAX;
  __asm { insd }
  *(_DWORD *)(HIDWORD(_RAX) - 122) -= v5 + 471428620;
  v9 = a2 - 1;
  v10 = a3 + 1;
  if ( (int)_RAX <= -659297378 )
  {
    MEMORY[0x5C130493] = v10;
    if ( HIBYTE(v9) <= MEMORY[0x9C0A6B85] )
    {
      *(_BYTE *)(HIDWORD(v8) + 160198244) ^= BYTE4(v8);
      *((_BYTE *)v7 + 588431237) = __ROR1__(*((_BYTE *)v7 + 588431237), 1);
      JUMPOUT(0xA407C9A0);
    }
    JUMPOUT(0x401D81);
  }
  JUMPOUT(0x492256CB);
}
// 401E00: positive sp value 8 has been found
// 401E00: control flows out of bounds to A407C9A0
// 401D82: control flows out of bounds to 492256CB
// 401DEF: control flows out of bounds to 401D81

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
