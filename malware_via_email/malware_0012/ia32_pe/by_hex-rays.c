/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// BOOL __stdcall CreateJobSet(ULONG NumJob, PJOB_SET_ARRAY UserJobSet, ULONG Flags);
char start();
char __stdcall sub_40113F(int a1, char *a2, _BYTE *a3);
// unsigned int __usercall sub_40115C@<eax>(int a1@<ebp>);

//-------------------------------------------------------------------------
// Data declarations

int dword_401174[3] = { -1430532899, 60, 0 }; // weak


//----- (00401010) --------------------------------------------------------
char start()
{
  SIZE_T v0; // ecx
  _DWORD *v1; // ebx
  int v2; // eax
  signed int v3; // ecx
  bool v4; // cc
  char *v5; // ebx
  _DWORD *v6; // esi
  _BYTE *v7; // eax
  signed int v9; // [esp+0h] [ebp-1Ch]
  int v10; // [esp+4h] [ebp-18h]
  char *lpAddress; // [esp+8h] [ebp-14h]
  SIZE_T dwSize; // [esp+Ch] [ebp-10h]
  DWORD flOldProtect; // [esp+18h] [ebp-4h] BYREF
  int savedregs; // [esp+1Ch] [ebp+0h] BYREF
  DWORD retaddr; // [esp+20h] [ebp+4h]

  sub_40115C((int)&savedregs);
  dwSize = *(_DWORD *)((v9 << 8) + ((unsigned int)start >> 16 << 16) - 22272 + 8395 - v9);
  lpAddress = (char *)((v9 << 8) + ((unsigned int)start >> 16 << 16) - 22272 + 8415 - v9);
  VirtualProtect(lpAddress, dwSize, 4u, &flOldProtect);
  v0 = dwSize;
  v1 = lpAddress;
  v2 = v9 + 283374031;
  for ( flOldProtect = 1; ; flOldProtect = -flOldProtect )
  {
    *v1 ^= v2;
    v3 = v0 + 83;
    v4 = v3 < v9;
    v0 = v3 - v9;
    if ( v4 )
      break;
    v2 += flOldProtect + 263671972;
    v1 = (_DWORD *)((char *)v1 - v9 + 91);
  }
  v5 = &lpAddress[*(_DWORD *)&lpAddress[-v9 + 147]];
  v10 = (unsigned __int8)v5[6];
  flOldProtect = (DWORD)VirtualAlloc(*((LPVOID *)v5 + 13), *((_DWORD *)v5 + 20), 0x3000u, 0x40u);
  sub_40113F(*((_DWORD *)v5 + 21), lpAddress, (_BYTE *)flOldProtect);
  v6 = v5 + 248;
  do
  {
    sub_40113F(v6[4], &lpAddress[v6[5]], (_BYTE *)(v6[3] + flOldProtect));
    v6 += 10;
    --v10;
  }
  while ( v10 );
  retaddr = flOldProtect + *((_DWORD *)v5 + 10);
  v7 = (_BYTE *)flOldProtect;
  do
    v7 += 4;
  while ( *(_DWORD *)v7 != -1430532899 );
  return sub_40113F(56, (char *)dword_401174, v7);
}
// 401049: variable 'v9' is possibly undefined
// 401174: using guessed type int dword_401174[3];

//----- (0040113F) --------------------------------------------------------
char __stdcall sub_40113F(int a1, char *a2, _BYTE *a3)
{
  char result; // al

  do
  {
    result = *a2;
    *a3++ = *a2++;
    --a1;
  }
  while ( a1 );
  return result;
}

//----- (0040115C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
unsigned int __usercall sub_40115C@<eax>(int a1@<ebp>)
{
  unsigned int result; // eax
  ULONG v2; // [esp-Ch] [ebp-Ch]
  struct _JOB_SET_ARRAY *v3; // [esp-8h] [ebp-8h]
  ULONG v4; // [esp-4h] [ebp-4h]

  CreateJobSet(v2, v3, v4);
  result = NtCurrentTeb()->LastErrorValue;
  *(_DWORD *)(a1 - 28) = result;
  return result;
}
// 401162: positive sp value C has been found
// 40115C: variable 'v2' is possibly undefined
// 40115C: variable 'v3' is possibly undefined
// 40115C: variable 'v4' is possibly undefined

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
