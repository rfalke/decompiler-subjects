/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
void __stdcall sub_40B018(int a1);
// int __userpurge TlsCallback_1@<eax>(DWORD a1@<edx>, int a2@<ecx>, int a3@<ebx>, int a4@<ebp>, int a5@<edi>, int a6@<esi>, int a7, int a8, int a9);
_DWORD __stdcall TlsCallback_0(_DWORD, _DWORD, _DWORD); // weak

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN sub_40B012; // weak
char byte_40B033 = 'r'; // weak


//----- (0040B018) --------------------------------------------------------
void __stdcall sub_40B018(int a1)
{
  ;
}

//----- (0040B07C) --------------------------------------------------------
// bad sp value at call has been detected, the output may be wrong!
// positive sp value has been detected, the output may be wrong!
int __userpurge TlsCallback_1@<eax>(DWORD a1@<edx>, int a2@<ecx>, int a3@<ebx>, int a4@<ebp>, int a5@<edi>, int a6@<esi>, int a7, int a8, int a9)
{
  int v10; // edi
  char v12; // cf
  int v13; // ecx
  int v14; // edx
  char *v15; // esi
  int v16; // ecx
  char v17; // al
  int *v18; // esi
  int v19; // eax
  int v20; // ebx
  int v21; // eax
  int v22; // ecx
  int v23; // edi
  char v24; // al
  _BYTE *v25; // ebx
  int i; // ecx
  int v27; // [esp-B6E6h] [ebp-B716h]
  _BYTE *v28; // [esp-B6E6h] [ebp-B716h]
  int v29; // [esp-B6E2h] [ebp-B712h]
  DWORD v30; // [esp-B6DEh] [ebp-B70Eh] BYREF
  int v31; // [esp-B6DAh] [ebp-B70Ah]
  int v32; // [esp-B6D6h] [ebp-B706h]
  int v33; // [esp-B6D2h] [ebp-B702h]
  _DWORD *v34; // [esp-B6CEh] [ebp-B6FEh]
  int v35; // [esp-B6CAh] [ebp-B6FAh]
  int v36; // [esp-B6C6h] [ebp-B6F6h]
  int v37; // [esp-B6C2h] [ebp-B6F2h]
  _DWORD v38[11695]; // [esp-B6BEh] [ebp-B6EEh] BYREF

  if ( v38[2] == 1 )
  {
    v37 = a6;
    v36 = a5;
    v35 = a4;
    v34 = v38;
    v33 = a3;
    v32 = a2;
    v31 = 1;
    v30 = a1;
    v10 = 882438157;
    do
    {
      sub_40B018(a2 - 653889601);
      v10 -= v12 - 653889601;
    }
    while ( v13 != 1 );
    VirtualProtect((LPVOID)(v10 ^ 0xF2B6C09F), v10 ^ 0xF2F6709F, 4u, &v30);
    v15 = &byte_40B033;
    v16 = 5;
    do
    {
      v29 = v16;
      v17 = *v15;
      v18 = (int *)(v15 + 1);
      LOBYTE(v14) = v17;
      v19 = *v18++;
      v20 = v19;
      v21 = *v18++;
      v22 = v21;
      v23 = *v18;
      v15 = (char *)v18 + 5;
      do
      {
        v27 = v22;
        sub_40B018(v14);
        LOBYTE(v14) = v24 ^ v14;
        v22 = v27 - 1;
      }
      while ( v27 != 1 );
      LOBYTE(v28) = v14 ^ v20;
      BYTE1(v28) = v14 ^ BYTE1(v20);
      BYTE2(v28) = v14 ^ BYTE2(v20);
      HIBYTE(v28) = v14 ^ HIBYTE(v20);
      v25 = v28;
      for ( i = v23; i; --i )
      {
        BYTE1(v14) = v14 ^ *v25;
        *v25++ = BYTE1(v14);
      }
      v16 = v29 - 1;
    }
    while ( v29 != 1 );
    ((void (__fastcall *)(int, int, DWORD, int, int, int, _DWORD *, int, int, int))sub_40B012)(
      v16,
      v14 + 66,
      v30,
      v31,
      v32,
      v33,
      v34,
      v35,
      v36,
      v37);
  }
  return TlsCallback_0(a7, a8, a9);
}
// 40B131: positive sp value B6EE has been found
// 40B12C: bad sp value at call
// 40B0A9: variable 'a2' is possibly undefined
// 40B0AF: variable 'v12' is possibly undefined
// 40B0B1: variable 'v13' is possibly undefined
// 40B0F0: variable 'v14' is possibly undefined
// 40B0F5: variable 'v24' is possibly undefined
// 40B033: using guessed type char byte_40B033;
// 40B137: using guessed type _DWORD __stdcall TlsCallback_0(_DWORD, _DWORD, _DWORD);

//----- (0040B14A) --------------------------------------------------------
#error "40B195: cannot convert to microcode (funcsize=30)"

// nfuncs=6 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 3 function(s)"
