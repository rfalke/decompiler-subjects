/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall sub_403AA1(signed int a1@<eax>, signed int _EDX@<edx>, __int16 a3@<bx>, _DWORD *a4@<edi>);


//----- (00403AA1) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_403AA1(signed int a1@<eax>, signed int _EDX@<edx>, __int16 a3@<bx>, _DWORD *a4@<edi>)
{
  int v5; // esi
  char v9; // cc
  int v10; // eax
  __int16 v11; // cx
  __int16 v12; // si
  bool v13; // cf
  bool v14; // pf
  __int16 v15; // ax
  __int64 v16; // rt2
  unsigned int v17; // kr00_4
  int savedregs; // [esp+0h] [ebp+0h]

  LOBYTE(_ECX) = savedregs;
  v5 = savedregs + 1;
  *a4 ^= 0x348B9732u;
  _CF = 0;
  _SF = (savedregs & HIBYTE(a3) & 0x80u) != 0;
  if ( ((unsigned __int8)savedregs & HIBYTE(a3)) == 0 )
  {
    _OF = __OFSUB__(v5, 1);
    v5 = savedregs;
    _SF = savedregs < 0;
    v9 = (savedregs < 0) ^ _OF;
    a3 = 11842;
    if ( __SETP__(savedregs, 0) )
    {
      _ECX = __ROL4__(savedregs, 240);
      v10 = a1 + 1;
      v5 = -_ECX;
      _CF = _ECX != 0;
      a3 = -11843;
      LOBYTE(_ECX) = _ECX + 1;
      _SF = v10 + 1 < 0;
      v9 = _SF ^ __OFADD__(1, v10);
      a1 = v10 + 1;
    }
    if ( !v9 )
      v5 = a1;
  }
  _ECX = (char)_ECX;
  if ( _SF )
    v5 = a1;
  _OF = __OFADD__(_CF, (_WORD)_ECX);
  v11 = _CF + (_WORD)_ECX;
  _OF |= __OFADD__(a3, v11);
  LOWORD(_ECX) = a3 + v11;
  if ( ((_ECX & 0x8000u) != 0) ^ _OF | ((_WORD)_ECX == 0) )
    _ECX = _EDX;
  v12 = __ROR4__(v5, 82);
  v17 = a1;
  v16 = _ECX * (__int64)a1;
  v15 = _ECX * a1;
  v13 = HIDWORD(v16) != 0;
  if ( is_mul_ok(_ECX, v17) )
  {
    v14 = __SETP__(v15 + v13 + v12 - 1, 0);
    __asm { repne dec ecx }
  }
  if ( !v14 )
    __asm { fmul    st(4), st }
  __asm
  {
    fadd    st(7), st
    fmul    st(1), st
  }
  if ( (int)(a4 + 1) >= _EDX )
  {
    __asm
    {
      repne fsubr st(1), st
      insb
    }
    --MEMORY[0x6D941333];
    JUMPOUT(0xE35E934B);
  }
  sub_403AA1();
  MEMORY[0xF2016B13]();
  JUMPOUT(0x403A86);
}
// 403A7C: positive sp value 4 has been found
// 403B03: inconsistent fpu stack
// 403A81: control flows out of bounds to 403A86
// 403BA2: control flows out of bounds to E35E934B
// 403AA9: variable 'savedregs' is possibly undefined
// 403B01: variable 'v14' is possibly undefined

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
