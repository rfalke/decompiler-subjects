/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPVOID __stdcall HeapAlloc(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
// HANDLE __stdcall HeapCreate(DWORD flOptions, SIZE_T dwInitialSize, SIZE_T dwMaximumSize);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// int __usercall start@<eax>(int a1@<ebp>, int a2@<edi>, int a3@<esi>);
int sub_401068();
int __stdcall sub_4011A2(int, int); // weak
int sub_4012D9();
int sub_40144C(); // weak
// char *__usercall sub_401469@<eax>(int a1@<ebp>, int a2@<edi>, int a3@<esi>);
void __stdcall sub_401685(int a1, int a2, int a3);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_4016A5; // weak
_UNKNOWN unk_402000; // weak
_UNKNOWN unk_402008; // weak
_UNKNOWN unk_40200C; // weak
_UNKNOWN unk_402100; // weak
_UNKNOWN unk_402120; // weak
_UNKNOWN unk_40246D; // weak
_UNKNOWN unk_402D52; // weak
_UNKNOWN unk_4057DA; // weak
_DWORD dword_406A48[366]; // idb


//----- (00401030) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebp>, int a2@<edi>, int a3@<esi>)
{
  char *v3; // eax

  sub_401068();
  v3 = ((char *(__usercall *)@<eax>(int@<ebp>, int@<edi>, int@<esi>))((char *)&unk_40246D - 4100))(a1, a2, a3);
  return ((int (__stdcall *)(char *))sub_40144C)(v3);
}
// 40144C: using guessed type int sub_40144C();

//----- (00401068) --------------------------------------------------------
int sub_401068()
{
  HANDLE v0; // eax

  unk_402000 = MEMORY[0x407074];
  v0 = HeapCreate(1u, 0, 0);
  unk_402008 = HeapAlloc(v0, 8u, *(_DWORD *)((char *)&unk_402D52 - 3410));
  unk_40200C = unk_402000 + unk_402008;
  ((void (__stdcall *)(_DWORD, int, _DWORD))loc_4016A5)(unk_402008, 4223112, unk_402000);
  return sub_4011A2(unk_402008, *(_DWORD *)((char *)&unk_4057DA - 14298));
}
// 4011A2: using guessed type int __stdcall sub_4011A2(int, int);

//----- (004012D9) --------------------------------------------------------
int sub_4012D9()
{
  void *v0; // esp
  _DWORD *v1; // ebx
  _DWORD *v2; // esi
  FARPROC *v3; // edi
  HMODULE v5; // [esp+DCh] [ebp-8h]

  v0 = alloca(4);
  v1 = (_DWORD *)(unk_402120 + *(_DWORD *)(unk_402120 + *(_DWORD *)(unk_402120 - 53886 + 53946) + 128));
  do
  {
    v5 = LoadLibraryA((LPCSTR)(unk_402120 + v1[3]));
    v2 = (_DWORD *)(unk_402120 + *v1);
    v3 = (FARPROC *)(unk_402120 + v1[4]);
    do
      *v3++ = GetProcAddress(v5, (LPCSTR)(unk_402120 + *v2++ + 2));
    while ( *v2 );
    v1 += 5;
  }
  while ( v1[3] );
  return 0;
}
// 4012D9: could not find valid save-restore pair for ebp

//----- (00401469) --------------------------------------------------------
char *__usercall sub_401469@<eax>(int a1@<ebp>, int a2@<edi>, int a3@<esi>)
{
  void *v3; // esp
  int v4; // ebx
  char *v5; // esi
  int v6; // edi
  char v8; // [esp+4D54h] [ebp-9BE8h] BYREF
  int v9; // [esp+E918h] [ebp-24h]
  int v10; // [esp+E91Ch] [ebp-20h]
  char *v11; // [esp+E920h] [ebp-1Ch]
  int v12; // [esp+E934h] [ebp-8h]
  int v13; // [esp+E938h] [ebp-4h]

  v13 = a1;
  v3 = alloca(20);
  v11 = &v8;
  v10 = a3;
  v9 = a2;
  v4 = *(_DWORD *)(unk_402100 - 43344 + 43404) + unk_402100;
  unk_402120 = *(_DWORD *)(v4 - 11256 + 11308);
  v12 = *(unsigned __int8 *)(v4 + 6);
  v5 = (char *)VirtualAlloc(*(LPVOID *)(v4 + 52), *(_DWORD *)(v4 - 42446 + 42526), 0x3000u, 0x40u);
  ((void (__stdcall *)(char *, _DWORD, _DWORD, char *))loc_4016A5)(
    v5,
    dword_406A48[-4690],
    *(_DWORD *)(v4 - 31836 + 31920),
    v5);
  v6 = v4 - 48606 + 48854;
  do
  {
    ((void (__stdcall *)(char *, int, _DWORD))loc_4016A5)(
      &v5[*(_DWORD *)(v6 + 12)],
      *(_DWORD *)(v6 + 20) + unk_402100,
      *(_DWORD *)(v6 - 9458 + 9474));
    v6 += 40;
    --v12;
  }
  while ( v12 );
  return &v5[*(_DWORD *)(v4 - 18568 + 18608)];
}
// 401469: could not find valid save-restore pair for ebx
// 401469: could not find valid save-restore pair for ebp
// 401469: could not find valid save-restore pair for edi

//----- (00401685) --------------------------------------------------------
void __stdcall sub_401685(int a1, int a2, int a3)
{
  ExitProcess(0);
}
// 401685: could not find valid save-restore pair for ebx
// 401685: could not find valid save-restore pair for ebp
// 401685: could not find valid save-restore pair for edi
// 401685: could not find valid save-restore pair for esi

// nfuncs=7 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
