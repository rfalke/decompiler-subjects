/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

// int __usercall start@<eax>(int@<ebp>, int@<edi>, int@<esi>);
// int __usercall sub_401068@<eax>(int a1@<ebp>);
// int __userpurge sub_4011A2@<eax>(int a1@<ebp>, int a2, int a3);
int sub_4012D9();
int sub_40144C();
// char *__usercall sub_401469@<eax>(int@<ebp>, int@<edi>, int@<esi>);
int __thiscall sub_401643(_DWORD, _DWORD, _DWORD, _DWORD); // weak
void __stdcall __noreturn sub_401685(int, int, int);

//-------------------------------------------------------------------------
// Data declarations

// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern LPVOID (__stdcall *HeapAlloc)(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
// extern HANDLE (__stdcall *HeapCreate)(DWORD flOptions, SIZE_T dwInitialSize, SIZE_T dwMaximumSize);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
_UNKNOWN loc_4016A5; // weak
_UNKNOWN unk_402000; // weak
int dword_402008; // weak
_UNKNOWN unk_40200C; // weak
_UNKNOWN unk_402100; // weak
_UNKNOWN unk_402120; // weak
_UNKNOWN unk_40246D; // weak
_UNKNOWN unk_402D52; // weak
_UNKNOWN unk_4039B4; // weak
_UNKNOWN unk_40533B; // weak
_UNKNOWN unk_4057DA; // weak
_DWORD dword_406A48[366]; // weak


//----- (00401030) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebp>, int a2@<edi>, int a3@<esi>)
{
  sub_401068(a1);
  ((void (__usercall *)(int@<ebp>, int@<edi>, int@<esi>))((char *)&unk_40246D - 4100))(a1, a2, a3);
  return sub_40144C();
}

//----- (00401068) --------------------------------------------------------
int __usercall sub_401068@<eax>(int a1@<ebp>)
{
  HANDLE v1; // eax

  unk_402000 = MEMORY[0x407074];
  v1 = HeapCreate(1u, 0, 0);
  dword_402008 = (int)HeapAlloc(v1, 8u, *(_DWORD *)((char *)&unk_402D52 - 3410));
  unk_40200C = unk_402000 + dword_402008;
  ((void (__stdcall *)(int, int, _DWORD))loc_4016A5)(dword_402008, 4223112, unk_402000);
  return sub_4011A2(a1, dword_402008, *(_DWORD *)((char *)&unk_4057DA - 14298));
}
// 402008: using guessed type int dword_402008;

//----- (004011A2) --------------------------------------------------------
int __userpurge sub_4011A2@<eax>(int a1@<ebp>, int a2, int a3)
{
  void *v3; // esp
  _BYTE *v4; // ecx
  int v5; // edx
  int result; // eax
  int *v7; // esi
  _BYTE *v8; // ecx
  int v10; // [esp-10h] [ebp-14h]
  int v11; // [esp-Ch] [ebp-10h]
  int v12; // [esp-8h] [ebp-Ch]
  int v13; // [esp+0h] [ebp-4h] BYREF

  v13 = a1;
  v3 = alloca(16);
  *(&v13 - 4) = 1466043501;
  v11 = -1823209568;
  *(&v13 - 2) = 0;
  v4 = (_BYTE *)*(&v13 + 2);
  v5 = *(&v13 + 3);
  do
  {
    *v4++ -= 28;
    --v5;
  }
  while ( v5 );
  dword_402008 += 3;
  result = sub_401643(v4, v10, v11, v12);
  v7 = &v13 - 4;
  *(&v13 - 4) = result + *v7;
  v8 = (_BYTE *)dword_402008;
  do
  {
    LOBYTE(result) = *(_BYTE *)v7 ^ *v8;
    *v8 = result;
    v7 = (int *)((char *)v7 + 1);
    if ( !*(_BYTE *)v7 )
      v7 = &v13 - 4;
    ++v8;
    --a3;
  }
  while ( a3 );
  unk_402100 = dword_402008;
  return result;
}
// 4011A2: could not find valid save-restore pair for ebp
// 401643: using guessed type int __thiscall sub_401643(_DWORD, _DWORD, _DWORD, _DWORD);
// 402008: using guessed type int dword_402008;

//----- (004012D9) --------------------------------------------------------
int sub_4012D9()
{
  void *v0; // esp
  _DWORD *v1; // ebx
  _DWORD *v2; // esi
  FARPROC *v3; // edi
  HMODULE LibraryA; // [esp+DCh] [ebp-8h]

  v0 = alloca(4);
  v1 = (_DWORD *)(unk_402120 + *(_DWORD *)(unk_402120 + *(_DWORD *)(unk_402120 - 53886 + 53946) + 128));
  do
  {
    LibraryA = LoadLibraryA((LPCSTR)(unk_402120 + v1[3]));
    v2 = (_DWORD *)(unk_402120 + *v1);
    v3 = (FARPROC *)(unk_402120 + v1[4]);
    do
      *v3++ = GetProcAddress(LibraryA, (LPCSTR)(unk_402120 + *v2++ + 2));
    while ( *v2 );
    v1 += 5;
  }
  while ( v1[3] );
  return 0;
}
// 4012D9: could not find valid save-restore pair for ebp

//----- (0040144C) --------------------------------------------------------
int sub_40144C()
{
  ((void (__stdcall *)())((char *)&unk_40533B - 16482))();
  return ((int (*)(void))((char *)&unk_4039B4 - 9626))();
}
// 40141A: using guessed type int (*word_40141A)(void);

//----- (00401469) --------------------------------------------------------
char *__usercall sub_401469@<eax>(int a1@<ebp>, int a2@<edi>, int a3@<esi>)
{
  void *v3; // esp
  int v4; // ebx
  char *v5; // esi
  int v6; // edi
  char v8; // [esp+4D54h] [ebp-9BE8h] BYREF
  int v9; // [esp+E918h] [ebp-24h]
  int v10; // [esp+E91Ch] [ebp-20h]
  char *v11; // [esp+E920h] [ebp-1Ch]
  int v12; // [esp+E934h] [ebp-8h]
  int v13; // [esp+E938h] [ebp-4h]

  v13 = a1;
  v3 = alloca(20);
  v11 = &v8;
  v10 = a3;
  v9 = a2;
  v4 = *(_DWORD *)(unk_402100 - 43344 + 43404) + unk_402100;
  unk_402120 = *(_DWORD *)(v4 - 11256 + 11308);
  v12 = *(unsigned __int8 *)(v4 + 6);
  v5 = (char *)VirtualAlloc(*(LPVOID *)(v4 + 52), *(_DWORD *)(v4 - 42446 + 42526), 0x3000u, 0x40u);
  ((void (__stdcall *)(char *, _DWORD, _DWORD, char *))loc_4016A5)(
    v5,
    dword_406A48[-4690],
    *(_DWORD *)(v4 - 31836 + 31920),
    v5);
  v6 = v4 - 48606 + 48854;
  do
  {
    ((void (__stdcall *)(char *, int, _DWORD))loc_4016A5)(
      &v5[*(_DWORD *)(v6 + 12)],
      *(_DWORD *)(v6 + 20) + unk_402100,
      *(_DWORD *)(v6 - 9458 + 9474));
    v6 += 40;
    --v12;
  }
  while ( v12 );
  return &v5[*(_DWORD *)(v4 - 18568 + 18608)];
}
// 401469: could not find valid save-restore pair for ebx
// 401469: could not find valid save-restore pair for ebp
// 401469: could not find valid save-restore pair for edi
// 406A48: using guessed type _DWORD dword_406A48[366];

//----- (00401685) --------------------------------------------------------
void __stdcall __noreturn sub_401685(int a1, int a2, int a3)
{
  ExitProcess(0);
}
// 401685: could not find valid save-restore pair for ebx
// 401685: could not find valid save-restore pair for ebp
// 401685: could not find valid save-restore pair for edi
// 401685: could not find valid save-restore pair for esi

// nfuncs=8 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
