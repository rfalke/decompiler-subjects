/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int start();
int __stdcall sub_4011DC(_DWORD *, unsigned int, int);

//-------------------------------------------------------------------------
// Data declarations

char byte_4010B7[] = { '\x90' }; // weak
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern DWORD (__stdcall *GetCurrentProcessId)();
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern DWORD (__stdcall *GetTickCount)();
// extern LPWSTR (__stdcall *GetCommandLineW)();
// extern DWORD (__stdcall *GetCurrentThreadId)();
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
CHAR ProcName[] = "ZwOpenTimer"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb


//----- (00401002) --------------------------------------------------------
int start()
{
  int v1; // [esp+0h] [ebp-24h]
  int v2; // [esp+0h] [ebp-24h]
  int v3; // [esp+4h] [ebp-20h]
  int v4; // [esp+8h] [ebp-1Ch]
  int v5; // [esp+Ch] [ebp-18h]
  HANDLE hFile; // [esp+10h] [ebp-14h]
  FARPROC hFilea; // [esp+10h] [ebp-14h]
  int v8; // [esp+14h] [ebp-10h]
  HMODULE ModuleHandleA; // [esp+18h] [ebp-Ch]
  int v10; // [esp+1Ch] [ebp-8h]
  int v11; // [esp+20h] [ebp-4h]
  int savedregs; // [esp+24h] [ebp+0h]

  GetFileType(hFile);
  ModuleHandleA = GetModuleHandleA(ModuleName);
  GetCurrentThreadId();
  GetCommandLineW();
  GetFileSize(ModuleHandleA, 0);
  hFilea = GetProcAddress(ModuleHandleA, ProcName);
  GetTickCount();
  GetCommandLineW();
  v2 = ((int (__stdcall *)(_DWORD, _DWORD, _DWORD, int, int, int, int, FARPROC, int, HMODULE, int, int, int))hFilea)(
         0,
         0,
         0,
         v1,
         v3,
         v4,
         v5,
         hFilea,
         v8,
         ModuleHandleA,
         v10,
         v11,
         savedregs);
  GetCurrentProcessId();
  return ((int (*)(void))&byte_4010B7[v2 ^ 0xC0000005])();
}
// 40100E: variable 'hFile' is possibly undefined
// 401068: variable 'v1' is possibly undefined
// 401068: variable 'v3' is possibly undefined
// 401068: variable 'v4' is possibly undefined
// 401068: variable 'v5' is possibly undefined
// 401068: variable 'v8' is possibly undefined
// 401068: variable 'v10' is possibly undefined
// 401068: variable 'v11' is possibly undefined
// 401068: variable 'savedregs' is possibly undefined

//----- (004011DC) --------------------------------------------------------
int __stdcall sub_4011DC(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // ecx
  int result; // eax

  v4 = a2 >> 2;
  result = a3;
  do
  {
    *a1 ^= a3;
    *a1 = __ROR4__(*a1, 186);
    *a1 -= a3;
    *a1 = -*a1;
    *a1 += a3;
    *a1 += a3;
    *a1++ ^= a3;
    --v4;
  }
  while ( v4 );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
