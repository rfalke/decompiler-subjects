/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall _ImageBase@<eax>(int@<eax>, int@<ecx>, int@<ebx>, int@<ebp>, int@<edi>, int@<esi>);
// int __usercall sub_400256@<eax>(int@<ebp>, _BYTE *@<edi>, _BYTE *@<esi>);
// __int64 __usercall sub_4002D2@<edx:eax>(char@<dl>, _BYTE *@<esi>);
int __fastcall sub_4002DC(_DWORD, _DWORD); // weak
// __int64 __usercall sub_4002DE@<edx:eax>(__int64 result@<edx:eax>, _BYTE *@<esi>);

//-------------------------------------------------------------------------
// Data declarations

int dword_400094[14] = { 4176, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }; // weak
int _IMPORT_DESCRIPTOR_KERNEL32 = 0; // weak
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
char byte_411058 = '\0'; // weak
int dword_41105C[8315]; // weak
int TlsEnd[18282]; // weak


//----- (00400000) --------------------------------------------------------
// write access to const memory has been detected, the output may be wrong!
// positive sp value has been detected, the output may be wrong!
int __usercall _ImageBase@<eax>(int a1@<eax>, int a2@<ecx>, int a3@<ebx>, int a4@<ebp>, int a5@<edi>, int a6@<esi>)
{
  int v6; // edx
  int *i; // esi
  int v8; // ecx
  int v9; // edi
  int v10; // ecx
  int *v11; // ecx
  int j; // edx
  int v13; // eax
  int v14; // eax
  int v15; // eax
  int *v17; // [esp-24h] [ebp-48h]
  int v18; // [esp-20h] [ebp-44h]
  _DWORD v19[9]; // [esp-4h] [ebp-28h] BYREF
  int v20; // [esp+20h] [ebp-4h]
  void *retaddr; // [esp+24h] [ebp+0h] BYREF

  v6 = v20;
  v20 = a6;
  v19[8] = a5;
  v19[7] = a4 - 1;
  v19[6] = &retaddr;
  v19[5] = a3;
  v19[4] = a2;
  v19[3] = v6;
  v19[2] = a1;
  v19[1] = v6;
  v19[0] = v19;
  ((void (__cdecl *)(int, int, int))VirtualProtect)(0x400000, 4096, 4);
  dword_400094[0] = 98304;
  qmemcpy((char *)&TlsEnd[1875] + 3, &_IMPORT_DESCRIPTOR_KERNEL32, 0x10058u);
  qmemcpy((char *)&TlsEnd[18281] + 3, &byte_411058, sizeof(char));
  sub_400256(0x400000, &_IMPORT_DESCRIPTOR_KERNEL32, (_BYTE *)&TlsEnd[2126] + 3);
  for ( i = dword_41105C + 29848; ; i += 5 )
  {
    v8 = i[3];
    if ( !v8 )
      JUMPOUT(0x403D1C);
    v9 = (*(int (__cdecl **)(int))((char *)&TlsEnd[1885] + 3))(v8 + 0x400000);
    v10 = *i;
    if ( !*i )
      v10 = i[4];
    if ( !v10 )
      break;
    v11 = (int *)(v10 + 0x400000);
    for ( j = i[4] + 0x400000; ; j = (int)(v17 + 1) )
    {
      v13 = *v11;
      if ( !*v11 )
        break;
      if ( v13 >= 0 )
        v14 = v13 + 4194306;
      else
        v14 = (unsigned __int16)*v11;
      v15 = (*(int (__cdecl **)(int, int, int, int *))((char *)&TlsEnd[1886] + 3))(v9, v14, j, v11);
      if ( !v15 )
        return -1;
      *v17 = v15;
      v11 = (int *)(v18 + 4);
    }
  }
  return -1;
}
// 400002: positive sp value 4 has been found
// 400195: write access to const memory at 400094 has been detected
// 40023A: variable 'v17' is possibly undefined
// 40023C: variable 'v18' is possibly undefined
// 400094: using guessed type int dword_400094[14];
// 401000: using guessed type int _IMPORT_DESCRIPTOR_KERNEL32;
// 403BC0: using guessed type int[512];
// 411058: using guessed type char byte_411058;
// 41105C: using guessed type int dword_41105C[8315];
// 419258: using guessed type int TlsEnd[18282];

//----- (00400256) --------------------------------------------------------
int __usercall sub_400256@<eax>(int a1@<ebp>, _BYTE *a2@<edi>, _BYTE *a3@<esi>)
{
  __int64 v3; // rax
  int v4; // ebx
  __int64 v5; // rax
  int v6; // ecx
  unsigned int v7; // ecx
  char v8; // tt
  __int64 v9; // rax
  int v10; // ecx
  char v11; // cf

  BYTE4(v3) = 0x80;
  v4 = 0;
LABEL_2:
  *a2++ = *a3++;
  LOBYTE(v4) = 2;
  while ( 1 )
  {
    v3 = sub_4002D2(SBYTE4(v3), a3);
    if ( !v11 )
      goto LABEL_2;
    v5 = sub_4002D2(SBYTE4(v3), a3);
    if ( !v11 )
    {
      v9 = sub_4002DE(v5, a3);
      if ( v10 == v4 )
      {
        sub_4002DC(0, HIDWORD(v9));
LABEL_20:
        LODWORD(v3) = a1;
        LOBYTE(v4) = 1;
        goto LABEL_21;
      }
      ++a3;
      LODWORD(v3) = sub_4002DC(v9, HIDWORD(v9));
      if ( (unsigned int)v3 < 0x7D00 )
      {
        if ( BYTE1(v3) >= 5u )
        {
LABEL_18:
          ++v7;
          goto LABEL_19;
        }
        if ( (unsigned int)v3 > 0x7F )
        {
LABEL_19:
          a1 = v3;
          goto LABEL_20;
        }
      }
LABEL_17:
      ++v7;
      goto LABEL_18;
    }
    v3 = sub_4002D2(SBYTE4(v5), a3);
    if ( !v11 )
      break;
    LOBYTE(v4) = 2;
    do
    {
      v3 = sub_4002D2(SBYTE4(v3), a3);
      v8 = v11 + v3;
      v11 = __CFADD__(v11, (_BYTE)v3) | __CFADD__((_BYTE)v3, v11 + v3);
      LOBYTE(v3) = v3 + v8;
    }
    while ( !v11 );
    if ( (_BYTE)v3 )
    {
LABEL_21:
      qmemcpy(a2, &a2[-v3], v7);
      a2 += v7;
    }
    else
    {
      *a2++ = 0;
    }
  }
  LOBYTE(v3) = *a3++;
  v11 = v3 & 1;
  LODWORD(v3) = (unsigned int)v3 >> 1;
  if ( (_DWORD)v3 )
  {
    v7 = v6 + v11 + v6;
    goto LABEL_17;
  }
  return v3;
}
// 400260: variable 'v3' is possibly undefined
// 400265: variable 'v11' is possibly undefined
// 400291: variable 'v10' is possibly undefined
// 4002A1: variable 'v6' is possibly undefined
// 4002C1: variable 'v7' is possibly undefined
// 4002DC: using guessed type int __fastcall sub_4002DC(_DWORD, _DWORD);

//----- (004002D2) --------------------------------------------------------
__int64 __usercall sub_4002D2@<edx:eax>(char a1@<dl>, _BYTE *a2@<esi>)
{
  bool v2; // cf
  __int64 result; // rax

  v2 = __CFADD__(a1, a1);
  BYTE4(result) = 2 * a1;
  if ( !BYTE4(result) )
    BYTE4(result) = *a2 + v2 + *a2;
  return result;
}

//----- (004002DE) --------------------------------------------------------
__int64 __usercall sub_4002DE@<edx:eax>(__int64 result@<edx:eax>, _BYTE *a2@<esi>)
{
  __int64 v2; // rax
  char v3; // cf

  do
  {
    v2 = sub_4002D2(SBYTE4(result), a2);
    result = sub_4002D2(SBYTE4(v2), a2);
  }
  while ( v3 );
  return result;
}
// 4002EB: variable 'v3' is possibly undefined

// nfuncs=5 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
