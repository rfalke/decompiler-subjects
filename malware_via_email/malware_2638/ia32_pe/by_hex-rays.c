/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int start();
int __stdcall sub_4013C8(int, int, _DWORD *);

//-------------------------------------------------------------------------
// Data declarations

// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern HANDLE (__stdcall *OpenMutexA)(DWORD dwDesiredAccess, BOOL bInheritHandle, LPCSTR lpName);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
_UNKNOWN unk_42D027; // weak
CHAR aXtrkb5oib[] = "xTRKb5oib"; // idb
CHAR aAatzpyt3qw[] = "aAtZPYt3QW"; // idb
CHAR aC30toslf7y1bj9[] = "c30TOsLf7y1Bj9"; // idb
CHAR aN5qkjspw7[] = "N5qKJSpW7"; // idb
CHAR a2yx58[] = "2yX58"; // idb
CHAR aXjbzvbracbmbfs[] = "xjbzVbRacBMbFS42"; // idb
CHAR aIeyux[] = "IEYuX"; // idb
CHAR aHv1gfnwwd3lqja[] = "HV1GFnwWd3LQjabX"; // idb
CHAR aXzn5bj[] = "XzN5Bj"; // idb
CHAR LibFileName[] = "ddraw.DLL"; // idb
CHAR Name[] = "bjyVo9OZ"; // idb
CHAR aAe8k9s4y8rtzyz[] = "Ae8K9s4Y8rTzyZc"; // idb
CHAR aOub3mwunqxi7g[] = "OUb3MWunQxI7G"; // idb
CHAR ProcName[] = "DirectDrawEnumerateExA"; // idb


//----- (00401010) --------------------------------------------------------
int start()
{
  int v1; // [esp-Ch] [ebp-60h]
  int v2; // [esp-8h] [ebp-5Ch]
  int v3; // [esp-4h] [ebp-58h]
  int v4; // [esp+0h] [ebp-54h]
  HRESULT (__stdcall *DirectDrawEnumerateExA)(LPDDENUMCALLBACKEXA, LPVOID, DWORD); // [esp+8h] [ebp-4Ch]
  HANDLE v6; // [esp+Ch] [ebp-48h]
  HANDLE v7; // [esp+10h] [ebp-44h]
  int v8; // [esp+18h] [ebp-3Ch]
  HANDLE v9; // [esp+20h] [ebp-34h]
  HANDLE hObject; // [esp+24h] [ebp-30h]
  HMODULE hModule; // [esp+28h] [ebp-2Ch]
  HANDLE v12; // [esp+2Ch] [ebp-28h]
  HANDLE v13; // [esp+38h] [ebp-1Ch]
  HANDLE v14; // [esp+3Ch] [ebp-18h]
  HANDLE v15; // [esp+4Ch] [ebp-8h]

  hObject = OpenMutexA(0x1F0001u, 0, Name);
  CloseHandle(hObject);
  GetFileType(hObject);
  CloseHandle(hObject);
  CloseHandle(hObject);
LABEL_2:
  GetFileSize(hObject, 0);
  GetFileType(hObject);
  v9 = OpenMutexA(0x1F0001u, 1, aAatzpyt3qw);
  while ( 1 )
  {
    if ( OpenMutexA(0x1F0001u, 0, aAe8k9s4y8rtzyz) )
      goto LABEL_2;
    if ( OpenMutexA(0x1F0001u, 1, aOub3mwunqxi7g) )
    {
      CloseHandle(v6);
      GetFileType(v13);
      ExitProcess(0);
    }
    CloseHandle(hObject);
    GetFileSize(0, 0);
    GetFileSize(hObject, 0);
    CloseHandle(v9);
    GetFileType(v9);
    if ( OpenMutexA(0x1F0001u, 1, aXzn5bj) )
      break;
    v12 = OpenMutexA(0x1F0001u, 0, a2yx58);
    if ( v12 )
      goto LABEL_13;
    hModule = LoadLibraryA(LibFileName);
    v14 = OpenMutexA(0x1F0001u, 1, aXtrkb5oib);
    CloseHandle(0);
    DirectDrawEnumerateExA = (HRESULT (__stdcall *)(LPDDENUMCALLBACKEXA, LPVOID, DWORD))GetProcAddress(
                                                                                          hModule,
                                                                                          ProcName);
    v7 = OpenMutexA(0x1F0001u, 0, aC30toslf7y1bj9);
    GetFileSize(v9, 0);
    CloseHandle(0);
    CloseHandle(0);
    v6 = OpenMutexA(0x1F0001u, 1, aHv1gfnwwd3lqja);
    if ( !v6 )
    {
      GetFileSize(v9, 0);
      GetFileType(0);
      OpenMutexA(0x1F0001u, 1, aIeyux);
      v3 = 0;
      GetFileType(0);
      GetFileSize(0, 0);
      v2 = 0;
      v1 = 0;
      GetFileType(0);
      do
      {
        v4 = ((int (__cdecl *)(int, int, int))DirectDrawEnumerateExA)(v1, v2, v3);
        GetFileSize(v9, 0);
        CloseHandle(0);
        CloseHandle(v7);
      }
      while ( OpenMutexA(0x1F0001u, 1, aN5qkjspw7) );
      __asm { jmp     [ebp+var_3C] }
    }
  }
  v8 += (int)&unk_42D027;
  GetFileType(v13);
LABEL_13:
  CloseHandle(v15);
  GetFileType(v12);
  GetFileSize(v14, 0);
  return ((int (*)(void))(v8 - (_DWORD)sub_4013C8))();
}
// 4011F5: variable 'v1' is possibly undefined
// 4011F5: variable 'v2' is possibly undefined
// 4011F5: variable 'v3' is possibly undefined
// 40125C: variable 'v6' is possibly undefined
// 401265: variable 'v13' is possibly undefined
// 401376: variable 'v8' is possibly undefined
// 401389: variable 'v15' is possibly undefined
// 401399: variable 'v12' is possibly undefined
// 4013A4: variable 'v14' is possibly undefined

//----- (004013C8) --------------------------------------------------------
int __stdcall sub_4013C8(int a1, int a2, _DWORD *a3)
{
  int result; // eax
  HANDLE hObject; // [esp+0h] [ebp-8h]

  hObject = OpenMutexA(0x1F0001u, 1, aXjbzvbracbmbfs);
  CloseHandle(hObject);
  GetFileType(hObject);
  result = a2;
  do
  {
    *a3 += a2;
    *a3 += 404834396;
    *a3 = -*a3;
    *a3 += 1030763199;
    *a3 -= 667671548;
    *a3 += a2;
    *a3 -= 941293281;
    *a3 -= 1635718574;
    *a3 ^= 0x22D1529Fu;
    *a3++ ^= a2;
    --a1;
  }
  while ( a1 );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
