/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __cdecl sub_40100A(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
void __stdcall sub_40100C(int, int, int, int);
// void __userpurge sub_401028(_DWORD *a1@<ebp>, double a2@<st0>, int a3, int a4, int a5, int a6);
// void __userpurge start(int, int, int, int);
// DWORD __usercall sub_401217@<eax>(DWORD result@<eax>);

//-------------------------------------------------------------------------
// Data declarations

// extern HWND (__stdcall *CreateToolbarEx)(HWND hwnd, DWORD ws, UINT wID, int nBitmaps, HINSTANCE hBMInst, UINT_PTR wBMID, LPCTBBUTTON lpButtons, int iNumButtons, int dxButton, int dyButton, int dxBitmap, int dyBitmap, UINT uStructSize);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// extern DWORD (__stdcall *GetLastError)();
_UNKNOWN unk_40AE8A; // weak
_UNKNOWN unk_429000; // weak


//----- (0040100C) --------------------------------------------------------
void __stdcall sub_40100C(int a1, int a2, int a3, int a4)
{
  JUMPOUT(0x401032);
}
// 401026: control flows out of bounds to 401032

//----- (00401028) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __userpurge sub_401028(_DWORD *a1@<ebp>, double a2@<st0>, int a3, int a4, int a5, int a6)
{
  int v6; // edx
  int v7; // ebx
  int v8; // ebx
  int *v9; // ebx
  int v10; // ebx
  _DWORD *v11; // edx
  _DWORD *v12; // ecx
  char v13; // cf
  int v14; // [esp-10h] [ebp-10h]
  int v15; // [esp-Ch] [ebp-Ch]
  int v16; // [esp-8h] [ebp-8h]
  int v17; // [esp-4h] [ebp-4h]

  *(a1 - 2) -= *(a1 - 3);
  if ( *(a1 - 2) < a1[4] )
  {
    v6 = ~*(a1 - 3);
    *(a1 - 5) = ~*(_DWORD *)(*(a1 - 2) + a1[3]);
    LOBYTE(v6) = ~(*((_BYTE *)a1 - 20) | v6);
    v7 = *(_DWORD *)(*(a1 - 1) + a1[5]);
    *(a1 - 5) = 255;
    v8 = *(a1 - 5) & v7;
    *(a1 - 5) = -1;
    LOBYTE(v6) = (*((_BYTE *)a1 - 20) ^ v8) + 1 + v6;
    v9 = (int *)(*(a1 - 2) + a1[2]);
    *(a1 - 4) = v9;
    v10 = *v9;
    LOBYTE(v10) = v6;
    v11 = (_DWORD *)*(a1 - 4);
    *v11 = 0;
    *v11 -= v10;
    *v11 = (*(a1 - 5) ^ *v11) + 1;
    if ( ++*(a1 - 1) == 1 )
      *(a1 - 1) = 0;
    if ( *(a1 - 1) != 29952 )
    {
      sub_401028(a1, v14, v15, v16, v17);
      *v12 = (int)a2;
      if ( !v13 )
        JUMPOUT(0x401263);
      JUMPOUT(0x401240);
    }
  }
}
// 40125F: positive sp value 14 has been found
// 401261: control flows out of bounds to 401263
// 401261: control flows out of bounds to 401240
// 40125A: variable 'v14' is possibly undefined
// 40125A: variable 'v15' is possibly undefined
// 40125A: variable 'v16' is possibly undefined
// 40125A: variable 'v17' is possibly undefined
// 40125F: variable 'v12' is possibly undefined
// 401261: variable 'v13' is possibly undefined

//----- (004010D0) --------------------------------------------------------
void __userpurge start(int a1, int a2, int a3, int a4)
{
  HWND Toolbar; // eax
  int *v5; // [esp-4h] [ebp-1ECh]
  unsigned int i; // [esp+3Ch] [ebp-1ACh]
  char v7[12]; // [esp+40h] [ebp-1A8h] BYREF
  int v8; // [esp+50h] [ebp-198h] BYREF
  void *v9; // [esp+1C0h] [ebp-28h]
  SIZE_T dwSize; // [esp+1C4h] [ebp-24h]
  int v11; // [esp+1C8h] [ebp-20h]
  int *v12; // [esp+1CCh] [ebp-1Ch]
  DWORD v13; // [esp+1D0h] [ebp-18h]
  char *v14; // [esp+1D4h] [ebp-14h]
  char *v15; // [esp+1D8h] [ebp-10h]
  int iNumButtons; // [esp+1DCh] [ebp-Ch] BYREF
  char *v17; // [esp+1E0h] [ebp-8h]
  int v18; // [esp+1E4h] [ebp-4h]
  int savedregs; // [esp+1E8h] [ebp+0h] BYREF

  v9 = 0;
  v5 = &savedregs;
  iNumButtons = -1;
  Toolbar = CreateToolbarEx(0, 0, 0, 0, 0, 0, (LPCTBBUTTON)&iNumButtons, (int)&iNumButtons, 0, 0, 0, 0, 0);
  v13 = -sub_401217((DWORD)Toolbar) ^ 0xFFFFFA82;
  if ( !v13 )
  {
    LOBYTE(v18) = 0;
    __writeeflags(0);
    iNumButtons = (int)&unk_40AE8A + (unsigned __int8)v18 + (unsigned __int8)v13;
    v15 = v7;
    v9 = &unk_429000;
    v12 = &v8;
    v18 = (unsigned __int8)v18 - 48;
    v18 = ~v18;
    sub_40100C((int)v7, iNumButtons, ++v18, (int)&unk_429000);
    dwSize = *(_DWORD *)v15 + *((_DWORD *)v15 + 1);
    v13 = 0;
    v17 = (char *)VirtualAlloc(0, dwSize, 0x3000u, 0x40u);
    v11 = 0x400000;
    for ( i = 0; i < *((_DWORD *)v15 + 2); ++i )
    {
      sub_40100A(&v17[v13], *v12 + v11, v12[1], v9, v5);
      v13 += v12[1];
      v12 += 2;
    }
    v14 = v17 + 4976;
    __asm { retn    4 }
  }
  sub_40100C(a1, a2, a3, a4);
}
// 401204: variable 'v5' is possibly undefined
// 40100A: using guessed type int __cdecl sub_40100A(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (00401217) --------------------------------------------------------
DWORD __usercall sub_401217@<eax>(DWORD result@<eax>)
{
  if ( !result )
    return GetLastError();
  return result;
}

// nfuncs=5 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
