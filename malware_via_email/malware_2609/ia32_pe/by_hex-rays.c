/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int start();
DWORD __stdcall sub_413101(int a1, int a2, _DWORD *a3);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// DWORD __stdcall GetFileType(HANDLE hFile);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// HANDLE __stdcall OpenMutexA(DWORD dwDesiredAccess, BOOL bInheritHandle, LPCSTR lpName);

//-------------------------------------------------------------------------
// Data declarations

__int16 word_401026 = 4959; // weak
CHAR LibFileName[] = "ddraw.DLL"; // idb
CHAR ProcName[] = "DirectDrawCreate"; // idb
CHAR aSafvst3wj[] = "SAfvSt3wJ"; // idb
CHAR aRt4lacivqfkxmn[] = "rT4lACivqfKxmNU"; // idb
CHAR aQrwndsnsnu[] = "QrwNDsnSnu"; // idb
CHAR aMggyde3nx7yxrz[] = "MggYdE3NX7yxrZa"; // idb
CHAR aSeoun88vbgl7hy[] = "sEoUN88vBgl7HYxh"; // idb
CHAR aKp7dq1z70pwb[] = "kP7dQ1z70PWb"; // idb
CHAR a4nimfmkwtum[] = "4nImfMkwTUm"; // idb
CHAR Name[] = "VbUCGPJ"; // idb
CHAR aVuqwoa[] = "VUqWoA"; // idb
CHAR aNrjxj[] = "NRJXJ"; // idb
CHAR aSurnf7bdoluh[] = "SuRNf7bDoLuH"; // idb


//----- (00412CF9) --------------------------------------------------------
int start()
{
  HRESULT (__stdcall *DirectDrawCreate)(GUID *, LPDIRECTDRAW *, IUnknown *); // [esp+0h] [ebp-40h]
  int v2; // [esp+4h] [ebp-3Ch]
  int v3; // [esp+4h] [ebp-3Ch]
  HANDLE v4; // [esp+8h] [ebp-38h]
  HANDLE v5; // [esp+10h] [ebp-30h]
  HMODULE hModule; // [esp+14h] [ebp-2Ch]
  HANDLE hFile; // [esp+18h] [ebp-28h]
  HANDLE v8; // [esp+1Ch] [ebp-24h]
  HANDLE hObject; // [esp+28h] [ebp-18h]
  HANDLE v10; // [esp+34h] [ebp-Ch]

  hObject = OpenMutexA(0x1F0001u, 1, Name);
  CloseHandle(hObject);
  while ( 1 )
  {
    GetFileType(hObject);
    GetFileType(hObject);
    GetFileSize(hObject, 0);
    CloseHandle(hObject);
    v4 = OpenMutexA(0x1F0001u, 0, aVuqwoa);
    if ( v4 )
      break;
    hFile = OpenMutexA(0x1F0001u, 1, aMggyde3nx7yxrz);
    if ( hFile )
      ExitProcess((UINT)DirectDrawCreate);
    GetFileSize(0, 0);
    GetFileSize(0, 0);
    GetFileSize(0, 0);
    GetFileSize(0, 0);
    v8 = OpenMutexA(0x1F0001u, 1, aSafvst3wj);
    GetFileSize(0, 0);
    GetFileSize(0, 0);
    CloseHandle(0);
    GetFileType(v8);
    GetFileType(0);
    GetFileType(hObject);
    hModule = LoadLibraryA(LibFileName);
    GetFileSize(0, 0);
    GetFileSize(0, 0);
    v10 = OpenMutexA(0x1F0001u, 1, aSeoun88vbgl7hy);
    DirectDrawCreate = (HRESULT (__stdcall *)(GUID *, LPDIRECTDRAW *, IUnknown *))GetProcAddress(hModule, ProcName);
    CloseHandle(hObject);
    GetFileType(0);
    if ( !OpenMutexA(0x1F0001u, 0, a4nimfmkwtum) )
    {
      CloseHandle(0);
      GetFileType(hObject);
      v5 = OpenMutexA(0x1F0001u, 0, aSurnf7bdoluh);
      GetFileSize(0, 0);
      v3 = ((int (__cdecl *)(_DWORD, _DWORD, _DWORD, HRESULT (__stdcall *)(GUID *, LPDIRECTDRAW *, IUnknown *)))DirectDrawCreate)(
             0,
             0,
             0,
             DirectDrawCreate);
      OpenMutexA(0x1F0001u, 1, aQrwndsnsnu);
      CloseHandle(hObject);
      CloseHandle(0);
      GetFileType(v5);
      GetFileType(0);
      GetFileType(v5);
      __asm { jmp     [ebp+var_20] }
    }
  }
  GetFileSize(v10, 0);
  OpenMutexA(0x1F0001u, 1, aNrjxj);
  GetFileSize(v10, 0);
  ((void (__cdecl *)(HRESULT (__stdcall *)(GUID *, LPDIRECTDRAW *, IUnknown *)))((char *)sub_413101 + v2 + 2147024809))(DirectDrawCreate);
  OpenMutexA(0x1F0001u, 0, aRt4lacivqfkxmn);
  GetFileType(hFile);
  CloseHandle(v4);
  return ((int (*)(void))((char *)&word_401026 + v2 + 2147024809))();
}
// 412FAB: variable 'DirectDrawCreate' is possibly undefined
// 413052: variable 'v10' is possibly undefined
// 413058: variable 'v2' is possibly undefined
// 4130C0: variable 'hFile' is possibly undefined
// 401026: using guessed type __int16 word_401026;

//----- (00413101) --------------------------------------------------------
DWORD __stdcall sub_413101(int a1, int a2, _DWORD *a3)
{
  DWORD result; // eax
  HANDLE hFile; // [esp+0h] [ebp-4h]

  hFile = OpenMutexA(0x1F0001u, 0, aKp7dq1z70pwb);
  GetFileType(hFile);
  result = GetFileType(hFile);
  do
  {
    *a3 += a2;
    *a3 = __ROR4__(*a3, 172);
    *a3 -= 294103899;
    *a3 = __ROR4__(*a3, 52);
    *a3 += 1763244604;
    *a3++ ^= 0x69030328u;
    --a1;
  }
  while ( a1 );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
