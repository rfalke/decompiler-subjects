/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
void start();
// char __usercall sub_40125F@<al>(int a1@<ecx>, _BYTE *a2@<edi>, char *a3@<esi>);


//----- (0040103A) --------------------------------------------------------
void start()
{
  HMODULE v0; // eax
  FARPROC ZwFsControlFile; // eax
  int v2; // ecx
  char v3; // al
  _BYTE *v4; // edi
  _DWORD *i; // edx
  int v6; // ecx
  int v7; // edx
  int v8; // [esp-20h] [ebp-44h]
  int v9; // [esp-1Ch] [ebp-40h]
  int v10; // [esp-18h] [ebp-3Ch]
  int v11; // [esp-14h] [ebp-38h]
  int v12; // [esp-10h] [ebp-34h]
  int v13; // [esp-Ch] [ebp-30h]
  int v14; // [esp-8h] [ebp-2Ch]
  int v15; // [esp-4h] [ebp-28h]
  HMODULE hModule; // [esp+0h] [ebp-24h]
  LPCSTR lpProcName; // [esp+4h] [ebp-20h]
  int v18; // [esp+8h] [ebp-1Ch]
  _BYTE *v19; // [esp+8h] [ebp-1Ch]
  int v20; // [esp+Ch] [ebp-18h]
  int v21; // [esp+10h] [ebp-14h]
  int v22; // [esp+10h] [ebp-14h]
  int v23; // [esp+10h] [ebp-14h]
  int v24; // [esp+14h] [ebp-10h]
  int v25; // [esp+14h] [ebp-10h]
  int v26; // [esp+18h] [ebp-Ch]
  DWORD v27[2]; // [esp+1Ch] [ebp-8h] BYREF

  v0 = GetModuleHandleA("ntdll.dll");
  ZwFsControlFile = GetProcAddress(v0, "ZwFsControlFile");
  LOBYTE(v27[0]) = ((int (__stdcall *)(int, int, int, int, int, int, int, int, HMODULE, LPCSTR, int, int, int, int, int, DWORD))ZwFsControlFile)(
                     v8,
                     v9,
                     v10,
                     v11,
                     v12,
                     v13,
                     v14,
                     v15,
                     hModule,
                     lpProcName,
                     v18,
                     v20,
                     v21,
                     v24,
                     v26,
                     v27[0]) & 0xF;
  v27[0] = LOBYTE(v27[0]);
  VirtualProtect((LPVOID)4, 4u, 4u, v27);
  v2 = v25;
  v3 = v27[0];
  v4 = (_BYTE *)v22;
  do
  {
    *v4++ ^= v3;
    --v2;
  }
  while ( v2 );
  v19 = VirtualAlloc(
          *(LPVOID *)(*(_DWORD *)(v22 + 60) + v22 + 52),
          *(_DWORD *)(*(_DWORD *)(v22 + 60) + v22 + 80),
          0x3000u,
          0x40u);
  sub_40125F(*(_DWORD *)(*(_DWORD *)(v23 + 60) + v23 + 84), v19, (char *)v23);
  for ( i = (_DWORD *)(*(_DWORD *)(v23 + 60) + v23 + 248); ; i = (_DWORD *)(v7 + 40) )
  {
    v6 = i[4];
    if ( !v6 )
      break;
    sub_40125F(v6, &v19[i[3]], (char *)(i[5] + v23));
  }
  __asm { jmp     ebx }
}
// 40109E: variable 'v8' is possibly undefined
// 40109E: variable 'v9' is possibly undefined
// 40109E: variable 'v10' is possibly undefined
// 40109E: variable 'v11' is possibly undefined
// 40109E: variable 'v12' is possibly undefined
// 40109E: variable 'v13' is possibly undefined
// 40109E: variable 'v14' is possibly undefined
// 40109E: variable 'v15' is possibly undefined
// 40109E: variable 'hModule' is possibly undefined
// 40109E: variable 'lpProcName' is possibly undefined
// 40109E: variable 'v18' is possibly undefined
// 40109E: variable 'v20' is possibly undefined
// 40109E: variable 'v21' is possibly undefined
// 40109E: variable 'v24' is possibly undefined
// 40109E: variable 'v26' is possibly undefined
// 401144: variable 'v25' is possibly undefined
// 40114A: variable 'v22' is possibly undefined
// 4011BA: variable 'v23' is possibly undefined
// 40122F: variable 'v7' is possibly undefined

//----- (0040125F) --------------------------------------------------------
char __usercall sub_40125F@<al>(int a1@<ecx>, _BYTE *a2@<edi>, char *a3@<esi>)
{
  char result; // al

  do
  {
    result = *a3++;
    *a2++ = result;
    --a1;
  }
  while ( a1 );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
