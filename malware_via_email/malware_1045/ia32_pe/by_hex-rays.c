/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

int __stdcall sub_406F25(int a1, int a2, int a3);
struct _LIST_ENTRY *__stdcall sub_406FC7(struct _LIST_ENTRY *, struct _LIST_ENTRY *, struct _LIST_ENTRY *);
void __stdcall sub_40712D(int);
void __thiscall sub_40714A(unsigned int this, _BYTE *a2, _BYTE *a3);
unsigned int __stdcall sub_407162(char *, int, unsigned int);
int __stdcall sub_407182(int, char);
int __stdcall sub_40719F(int);
void __cdecl sub_40720C(int, int);
int __stdcall sub_4072C5(int a1, char a2);
void __stdcall sub_40736A(int);
// int __userpurge sub_4073D1@<eax>(int@<ebp>, int, int);
// int __userpurge sub_407447@<eax>(int@<ebp>, int, int);
// int __usercall sub_40746C@<eax>(char@<dl>, int@<ecx>, _BYTE *@<esi>);
int __cdecl sub_4075DC(int, int);
int __stdcall sub_4075F1(void *, unsigned int);
int __fastcall nullsub_1(_DWORD, _DWORD); // weak
int __thiscall sub_4076BE(_DWORD); // weak
// int __usercall sub_4076C0@<eax>(char@<dl>, int@<ecx>, _BYTE *@<esi>);
char *__stdcall sub_407806(char *, const void *, unsigned int);
char *__stdcall sub_40782B(char *, int, int);
int __stdcall sub_407854(int);
// void __userpurge sub_4078FF(int@<ebp>, int, int);
void sub_40797C();
int __stdcall sub_407A7B(int, int);


//----- (00406F25) --------------------------------------------------------
int __stdcall sub_406F25(int a1, int a2, int a3)
{
  int v3; // eax
  void (__stdcall *v4)(int, int *, int *, int, int *); // eax
  int v6; // [esp-8h] [ebp-Ch]
  int v7; // [esp+0h] [ebp-4h] BYREF

  v6 = a3;
  sub_40712D(580463056);
  v4 = (void (__stdcall *)(int, int *, int *, int, int *))sub_407A7B(v3, -1321239836);
  v4(-1, &a1, &a2, v6, &v7);
  return v7;
}
// 407846: variable 'v3' is possibly undefined

//----- (00406FC7) --------------------------------------------------------
struct _LIST_ENTRY *__stdcall sub_406FC7(struct _LIST_ENTRY *a1, struct _LIST_ENTRY *a2, struct _LIST_ENTRY *a3)
{
  struct _LIST_ENTRY *Flink; // edx
  struct _LIST_ENTRY *v4; // esi
  struct _LIST_ENTRY *result; // eax

  Flink = NtCurrentPeb()->Ldr->InLoadOrderModuleList.Flink;
  v4 = Flink;
  while ( 1 )
  {
    result = v4[3].Blink;
    if ( result == a2 )
      break;
    v4 = v4->Flink;
    if ( v4 == Flink )
      return result;
  }
  v4[3].Flink = a1;
  v4[3].Blink = a3;
  return result;
}

//----- (0040712D) --------------------------------------------------------
void __stdcall sub_40712D(int a1)
{
  struct _LIST_ENTRY *p_InLoadOrderModuleList; // ebx
  struct _LIST_ENTRY *i; // edx
  struct _LIST_ENTRY *Flink; // ecx
  int v4; // eax

  p_InLoadOrderModuleList = &NtCurrentPeb()->Ldr->InLoadOrderModuleList;
  for ( i = p_InLoadOrderModuleList->Flink->Flink; i != p_InLoadOrderModuleList; i = i->Flink )
  {
    Flink = i[6].Flink;
    v4 = 0;
    while ( LOWORD(Flink->Flink) )
    {
      v4 = __ROL4__(v4, 7);
      LOBYTE(v4) = LOBYTE(Flink->Flink) ^ v4;
      Flink = (struct _LIST_ENTRY *)((char *)Flink + 2);
    }
    if ( (v4 ^ 0x89A98CDA) == a1 )
      break;
  }
}

//----- (0040714A) --------------------------------------------------------
void __thiscall sub_40714A(unsigned int this, _BYTE *a2, _BYTE *a3)
{
  int *v3; // ebp
  char v6; // dl
  int v7; // ebx
  char v8; // dl
  int v9; // ecx
  unsigned int v10; // eax
  int v11; // ecx
  int v12; // eax
  char v13; // tt
  unsigned int v14; // eax
  int v15; // eax
  int v16; // ecx
  char v17; // cf
  int v18; // [esp+4h] [ebp-4h] BYREF

  v3 = &v18;
  v6 = 0x80;
  v7 = 0;
LABEL_3:
  *a2++ = *a3++;
  LOBYTE(v7) = 2;
  while ( 1 )
  {
    sub_40746C(v6, this, a3);
    if ( !v17 )
      goto LABEL_3;
    sub_40746C(v6, 0, a3);
    if ( !v17 )
    {
      v15 = sub_4076C0(v8, v9, a3);
      if ( v16 == v7 )
      {
        sub_4076BE(0);
      }
      else
      {
        ++a3;
        v14 = sub_4076BE(v15);
        if ( v14 >= 0x7D00 )
          goto LABEL_12;
        if ( BYTE1(v14) >= 5u )
        {
LABEL_13:
          ++this;
        }
        else if ( v14 <= 0x7F )
        {
          goto LABEL_12;
        }
        v3 = (int *)v14;
      }
      v12 = (int)v3;
      LOBYTE(v7) = 1;
      goto LABEL_16;
    }
    v10 = sub_40746C(v8, v9, a3);
    if ( !v17 )
      break;
    LOBYTE(v7) = 2;
    this = v11 + 1;
    do
    {
      v12 = sub_40746C(v6, this, a3);
      v13 = v17 + v12;
      v17 = __CFADD__(v17, (_BYTE)v12) | __CFADD__((_BYTE)v12, v17 + v12);
      LOBYTE(v12) = v12 + v13;
    }
    while ( !v17 );
    if ( (_BYTE)v12 )
    {
LABEL_16:
      qmemcpy(a2, &a2[-v12], this);
      a2 += this;
      this = 0;
    }
    else
    {
      *a2++ = 0;
    }
  }
  LOBYTE(v10) = *a3++;
  v17 = v10 & 1;
  v14 = v10 >> 1;
  if ( v14 )
  {
    this = v11 + v17 + v11;
LABEL_12:
    ++this;
    goto LABEL_13;
  }
}
// 40714A: could not find valid save-restore pair for esi
// 407246: variable 'v6' is possibly undefined
// 407246: variable 'this' is possibly undefined
// 4073A5: variable 'v17' is possibly undefined
// 4073BA: variable 'v8' is possibly undefined
// 4073BA: variable 'v9' is possibly undefined
// 407550: variable 'v11' is possibly undefined
// 4078DE: variable 'v16' is possibly undefined
// 4076BE: using guessed type int __thiscall sub_4076BE(_DWORD);

//----- (00407162) --------------------------------------------------------
unsigned int __stdcall sub_407162(char *a1, int a2, unsigned int a3)
{
  unsigned int v3; // eax
  char *v5; // edi
  char *v6; // esi
  char *v7; // edi
  char *v8; // esi
  unsigned int v9; // edx
  unsigned int v10; // ebx
  unsigned int v11; // [esp+4h] [ebp-8h]
  unsigned int v12; // [esp+18h] [ebp+Ch]

  v3 = a2 - HIWORD(a3);
  v12 = v3;
  v11 = v3;
  if ( (_BYTE)a3 )
  {
    v8 = a1;
    v7 = a1;
    v10 = BYTE1(a3);
    while ( v12 )
    {
      if ( v12 < 0xA )
      {
        qmemcpy(v7, v8, v12);
        return v11;
      }
      v9 = v10 % 0xA;
      v10 += v10 % 0xA + v10 / 0xA + 10;
      qmemcpy(v7, v8, v9);
      v5 = &v7[v9];
      v6 = &v8[v9 + (unsigned __int8)a3];
      v9 = 10 - v9;
      qmemcpy(v5, v6, v9);
      v8 = &v6[v9];
      v7 = &v5[v9];
      v11 -= (unsigned __int8)a3;
      v12 -= (unsigned __int8)a3 + 10;
    }
  }
  return v11;
}

//----- (00407182) --------------------------------------------------------
int __stdcall sub_407182(int a1, char a2)
{
  int v2; // eax
  void (__stdcall *v3)(int, int *, _DWORD, char *, int, int); // eax

  sub_40712D(580463056);
  v3 = (void (__stdcall *)(int, int *, _DWORD, char *, int, int))sub_407A7B(v2, -2131024578);
  v3(-1, &a1, 0, &a2, 12288, 64);
  return a1;
}
// 4072B7: variable 'v2' is possibly undefined

//----- (0040719F) --------------------------------------------------------
int __stdcall sub_40719F(int a1)
{
  int v1; // eax
  void (__stdcall *v2)(int *, int, int, int *, int); // eax
  int v3; // eax
  void (__stdcall *v4)(int *, int, int, int); // eax
  int v6; // eax
  void (__cdecl *v7)(int **, int *, int); // eax
  int v8; // eax
  void (__stdcall *v9)(_DWORD, _DWORD, int **, int *, int, int *); // eax
  int v10; // [esp+0h] [ebp-10h] BYREF
  int *v11; // [esp+4h] [ebp-Ch] BYREF
  int v12[2]; // [esp+8h] [ebp-8h] BYREF
  int savedregs; // [esp+10h] [ebp+0h]

  sub_40712D(580463056);
  v2 = (void (__stdcall *)(int *, int, int, int *, int))sub_407A7B(v1, 739160582);
  v2(v12, a1, v10, v11, v12[0]);
  v12[0] = 1;
  v11 = v12;
  sub_40712D(580463056);
  v7 = (void (__cdecl *)(int **, int *, int))sub_407A7B(v6, 1945241419);
  v7(&v11, v11, v12[0]);
  sub_40712D(580463056);
  v9 = (void (__stdcall *)(_DWORD, _DWORD, int **, int *, int, int *))sub_407A7B(v8, -237139474);
  v9(0, 0, &v11, &v10, v10, v11);
  v11 = (int *)&v11;
  sub_40712D(580463056);
  v4 = (void (__stdcall *)(int *, int, int, int))sub_407A7B(v3, 857823385);
  v4(v11, v12[0], v12[1], savedregs);
  return v10;
}
// 4072D4: variable 'v1' is possibly undefined
// 40779D: variable 'v6' is possibly undefined
// 407867: variable 'v8' is possibly undefined
// 4075CE: variable 'v3' is possibly undefined
// 40719F: using guessed type _DWORD var_8[2];

//----- (0040720C) --------------------------------------------------------
// bad sp value at call has been detected, the output may be wrong!
void __cdecl sub_40720C(int a1, int a2)
{
  int savedregs; // [esp+0h] [ebp+0h] BYREF

  sub_4078FF((int)&savedregs, a1, a2);
}
// 40720F: bad sp value at call

//----- (004072C5) --------------------------------------------------------
int __stdcall sub_4072C5(int a1, char a2)
{
  int v2; // eax
  int (__stdcall *v3)(int, int *, char *, int); // eax

  sub_40712D(580463056);
  v3 = (int (__stdcall *)(int, int *, char *, int))sub_407A7B(v2, 922361587);
  return v3(-1, &a1, &a2, 0x8000);
}
// 406F1A: variable 'v2' is possibly undefined

//----- (0040736A) --------------------------------------------------------
void __stdcall sub_40736A(int a1)
{
  int v1; // esi
  int *v2; // esi
  int *v3; // edi
  int v4; // eax
  int *i; // ebx
  int v6; // eax
  int v7; // ebx
  int v8; // [esp+4h] [ebp-4h]

  v7 = *(_DWORD *)(*(_DWORD *)(a1 + 60) + a1 + 128);
  if ( v7 )
  {
    for ( i = (int *)(a1 + v7); i[3]; i += 5 )
    {
      v8 = sub_40719F(a1 + i[3]);
      if ( *i )
        v1 = *i;
      else
        v1 = i[4];
      v2 = (int *)(a1 + v1);
      v3 = (int *)(a1 + i[4]);
      while ( *v2 )
      {
        v4 = *v2++;
        if ( v4 >= 0 )
          v6 = sub_4075DC(v8, a1 + v4 + 2);
        else
          v6 = sub_4075DC(v8, v4 ^ 0x80000000);
        *v3++ = v6;
      }
    }
  }
}

//----- (004073D1) --------------------------------------------------------
int __userpurge sub_4073D1@<eax>(int a1@<ebp>, int a2, int a3)
{
  int v3; // eax
  void (__stdcall *v4)(int, int, int, int); // eax
  int v6; // eax
  void (__stdcall *v7)(int, int); // eax
  int v8; // [esp-10h] [ebp-1Ch]
  int v9; // [esp-10h] [ebp-1Ch]
  int v10; // [esp-Ch] [ebp-18h]
  int v11; // [esp-8h] [ebp-14h]

  if ( *(_DWORD *)(a1 + 12) > 0xFFFFu )
  {
    v11 = 0;
    v10 = a1 - 12;
    v9 = *(_DWORD *)(a1 + 12);
    sub_40712D(580463056);
    v7 = (void (__stdcall *)(int, int))sub_407A7B(v6, 739160582);
    v7(a1 - 12, v9);
  }
  else
  {
    v11 = *(_DWORD *)(a1 + 12);
    v10 = 0;
  }
  v8 = *(_DWORD *)(a1 + 8);
  sub_40712D(580463056);
  v4 = (void (__stdcall *)(int, int, int, int))sub_407A7B(v3, -1147820881);
  v4(v8, v10, v11, a1 - 4);
  return *(_DWORD *)(a1 - 4);
}
// 407154: variable 'v3' is possibly undefined
// 407287: variable 'v6' is possibly undefined

//----- (00407447) --------------------------------------------------------
int __userpurge sub_407447@<eax>(int a1@<ebp>, int a2, int a3)
{
  int v3; // edx
  int v4; // eax
  _BYTE *v5; // ecx
  int result; // eax
  _DWORD *v7; // esi
  unsigned int i; // ecx
  unsigned int v9; // [esp-4h] [ebp-14h]

  v3 = *(_DWORD *)(a1 + 8);
  result = v3 + *(_DWORD *)(*(_DWORD *)(v3 + 60) + v3 + 120);
  v7 = (_DWORD *)(v3 + *(_DWORD *)(result + 32));
  *(_DWORD *)(a1 - 4) = *(_DWORD *)(result + 24);
  for ( i = 0; i < *(_DWORD *)(a1 - 4); i = v9 + 1 )
  {
    v9 = i;
    v5 = (_BYTE *)(v3 + *v7);
    v4 = 0;
    while ( *v5 )
    {
      v4 = __ROL4__(v4, 7);
      LOBYTE(v4) = *v5++ ^ v4;
    }
    if ( (v4 ^ 0x89A98CDA) == *(_DWORD *)(a1 + 12) )
      JUMPOUT(0x406E9C);
    result = 0;
    ++v7;
  }
  return result;
}
// 407358: control flows out of bounds to 406E9C

//----- (0040746C) --------------------------------------------------------
int __usercall sub_40746C@<eax>(char a1@<dl>, int a2@<ecx>, _BYTE *a3@<esi>)
{
  bool v3; // cf
  char v4; // dl

  v3 = __CFADD__(a1, a1);
  v4 = 2 * a1;
  if ( !v4 )
    v4 = *a3 + v3 + *a3;
  return nullsub_1(a2, v4);
}
// 4076BD: using guessed type int __fastcall nullsub_1(_DWORD, _DWORD);

//----- (004075DC) --------------------------------------------------------
// bad sp value at call has been detected, the output may be wrong!
int __cdecl sub_4075DC(int a1, int a2)
{
  int savedregs; // [esp+0h] [ebp+0h] BYREF

  return sub_4073D1((int)&savedregs, a1, a2);
}
// 4075DF: bad sp value at call

//----- (004075F1) --------------------------------------------------------
int __stdcall sub_4075F1(void *a1, unsigned int a2)
{
  int result; // eax

  result = 0;
  memset(a1, 0, a2);
  return result;
}

//----- (004076C0) --------------------------------------------------------
int __usercall sub_4076C0@<eax>(char a1@<dl>, int a2@<ecx>, _BYTE *a3@<esi>)
{
  char v3; // cf
  int v4; // ecx
  char v5; // dl
  int result; // eax
  int v7; // ecx

  v7 = a2 + 1;
  do
  {
    sub_40746C(a1, v7, a3);
    result = sub_40746C(v5, v4 + v3 + v4, a3);
  }
  while ( v3 );
  return result;
}
// 4076C1: variable 'a1' is possibly undefined
// 4076C1: variable 'v7' is possibly undefined
// 406F36: variable 'v5' is possibly undefined
// 406F34: variable 'v4' is possibly undefined
// 406F34: variable 'v3' is possibly undefined

//----- (00407806) --------------------------------------------------------
char *__stdcall sub_407806(char *a1, const void *a2, unsigned int a3)
{
  qmemcpy(a1, a2, a3);
  return &a1[a3];
}

//----- (0040782B) --------------------------------------------------------
char *__stdcall sub_40782B(char *a1, int a2, int a3)
{
  char *result; // eax
  int v4; // ecx
  int v5; // edx
  char v6; // al
  char *v7; // esi
  char *v8; // edi

  v7 = a1;
  v8 = a1;
  v4 = a2;
  v5 = a3;
  while ( v4 )
  {
    v6 = *v7++;
    *v8++ = __ROR1__(__ROL1__(v6, BYTE1(v5) + (v5 ^ 0x13)), v5);
    v5 = __ROL4__(v4 + v5, 3);
    --v4;
  }
  result = a1;
  *(_DWORD *)a1 ^= a2;
  *(_DWORD *)a1 ^= a3;
  return result;
}

//----- (00407854) --------------------------------------------------------
int __stdcall sub_407854(int a1)
{
  int v1; // eax
  int (__stdcall *v2)(int, int); // eax

  sub_40712D(580463056);
  v2 = (int (__stdcall *)(int, int))sub_407A7B(v1, 394091963);
  return v2(-1, a1);
}
// 40711B: variable 'v1' is possibly undefined

//----- (004078FF) --------------------------------------------------------
void __userpurge sub_4078FF(int a1@<ebp>, int a2, int a3)
{
  _DWORD *v3; // edi
  unsigned __int16 *v4; // esi
  int v5; // ebx
  int v6; // ecx
  _DWORD *i; // ebx
  int v8; // eax
  int v9; // edi
  int v10; // edx

  v10 = *(_DWORD *)(a1 + 8) - *(_DWORD *)(a1 + 12);
  v5 = *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a1 + 8) + 60) + *(_DWORD *)(a1 + 8) + 160);
  if ( v5 && *(_DWORD *)(a1 + 8) != *(_DWORD *)(a1 + 12) )
  {
    for ( i = (_DWORD *)(*(_DWORD *)(a1 + 8) + v5); i[1] > 8u; i = (_DWORD *)((char *)i + i[1]) )
    {
      v6 = i[1] - 8;
      v4 = (unsigned __int16 *)(i + 2);
      while ( v6 )
      {
        v8 = *v4;
        v9 = (unsigned __int16)v8;
        LOWORD(v9) = v8 & 0xFFF;
        LOWORD(v8) = (unsigned __int16)v8 >> 12;
        if ( v8 == 3 )
        {
          v3 = (_DWORD *)(*(_DWORD *)(a1 + 8) + *i + v9);
          *v3 += v10;
        }
        ++v4;
        v6 -= 2;
      }
    }
  }
}

//----- (0040797C) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void sub_40797C()
{
  __asm { retn }
}
// 4071D6: positive sp value 4 has been found

//----- (00407A7B) --------------------------------------------------------
// bad sp value at call has been detected, the output may be wrong!
int __stdcall sub_407A7B(int a1, int a2)
{
  int savedregs; // [esp+0h] [ebp+0h] BYREF

  return sub_407447((int)&savedregs, a1, a2);
}
// 407A7E: bad sp value at call

// nfuncs=24 queued=22 decompiled=22 lumina nreq=0 worse=0 better=0
// ALL OK, 22 function(s) have been successfully decompiled
