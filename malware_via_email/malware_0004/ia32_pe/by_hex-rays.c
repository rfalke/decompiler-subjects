/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// _BYTE *__usercall sub_401113@<eax>(int@<esi>, int);
// void __userpurge sub_40157D(int _EAX@<eax>, __int16@<dx>, int _ECX@<ecx>, int _EBX@<ebx>, int _ESI@<esi>, ULONG_PTR Parameter, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int);
void __stdcall pfnAPC(ULONG_PTR Parameter); // idb
void __stdcall __noreturn StartAddress(LPVOID lpThreadParameter);
int __stdcall start(int, int, int, int);

//-------------------------------------------------------------------------
// Data declarations

// extern DWORD (__stdcall *SleepEx)(DWORD dwMilliseconds, BOOL bAlertable);
// extern DWORD (__stdcall *QueueUserAPC)(PAPCFUNC pfnAPC, HANDLE hThread, ULONG_PTR dwData);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern HANDLE (__stdcall *CreateThread)(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId);
// extern LPSTR (__stdcall *lstrcpyA)(LPSTR lpString1, LPCSTR lpString2);


//----- (00401113) --------------------------------------------------------
_BYTE *__usercall sub_401113@<eax>(int a1@<esi>, int a2)
{
  int v2; // eax
  _DWORD *v3; // ecx
  _BYTE *result; // eax
  char v5; // dl
  _BYTE *v6; // edi
  int v7; // ebx
  unsigned int v8; // [esp+8h] [ebp-Ch]
  unsigned int v9; // [esp+Ch] [ebp-8h]
  int v10; // [esp+10h] [ebp-4h]

  v9 = 0;
  v2 = a1 + *(_DWORD *)(*(_DWORD *)(a1 + 60) + a1 + 120);
  v3 = (_DWORD *)(a1 + *(_DWORD *)(v2 + 32));
  v8 = *(_DWORD *)(v2 + 24);
  if ( !v8 )
    return 0;
  while ( 1 )
  {
    result = (_BYTE *)(a1 + *v3);
    v10 = 0;
    v5 = *result;
    v6 = result;
    while ( v5 )
    {
      v7 = v5 ^ __ROL4__(v10, 13);
      v5 = *++v6;
      v10 = v7;
    }
    if ( v10 == a2 )
      break;
    ++v9;
    ++v3;
    if ( v9 >= v8 )
      return 0;
  }
  return result;
}

//----- (0040157D) --------------------------------------------------------
void __userpurge sub_40157D(
        int _EAX@<eax>,
        __int16 a2@<dx>,
        int _ECX@<ecx>,
        int _EBX@<ebx>,
        int _ESI@<esi>,
        ULONG_PTR Parameter,
        int a7,
        int a8,
        int a9,
        int a10,
        int a11,
        int a12,
        int a13,
        int a14,
        int a15,
        int a16,
        int a17,
        int a18,
        int a19,
        int a20,
        int a21,
        int a22,
        int a23,
        int a24,
        int a25,
        int a26,
        int a27,
        int a28,
        int a29,
        int a30,
        int a31,
        int a32,
        int a33,
        int a34,
        int a35,
        int a36,
        int a37,
        int a38,
        int a39,
        int a40,
        int a41,
        int a42,
        int a43,
        int a44,
        int a45,
        int a46,
        int a47,
        int a48,
        int a49,
        int a50,
        int a51,
        int a52,
        int a53,
        int a54,
        int a55,
        int a56,
        int a57,
        int a58,
        int a59,
        int a60,
        int a61,
        int a62,
        int a63)
{
  _BYTE *v64; // [esp+0h] [ebp-C10h]

  __asm { xlat }
  LOBYTE(_ECX) = HIBYTE(a2) + _ECX + 1;
  __asm
  {
    outsd
    arpl    [ecx-11h], ax
  }
  LOBYTE(_EAX) = _EAX & 0x7E;
  __outbyte(a2 + 1, _EAX);
  MEMORY[0xAC4F5CCB] = _EAX;
  *v64 -= __CFADD__(*(_DWORD *)(_EAX + 61), _EAX) + BYTE1(v64);
}
// 4015AF: variable 'v64' is possibly undefined
// 40157D: too many input arguments, some ignored

//----- (0040204B) --------------------------------------------------------
void __stdcall pfnAPC(ULONG_PTR Parameter)
{
  void (__userpurge *i)(int@<eax>, __int16@<dx>, int@<ecx>, int@<ebx>, int@<esi>, ULONG_PTR, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int); // edi
  _BYTE *v2; // edi
  struct _LIST_ENTRY *Flink; // esi
  const CHAR *v4; // eax
  const CHAR *v5; // eax
  unsigned int v6; // esi
  char v7; // al
  int v8; // ebx
  unsigned int v9; // eax
  char v10[32]; // [esp+Ch] [ebp-44h] BYREF
  char String1[32]; // [esp+2Ch] [ebp-24h] BYREF
  unsigned int j; // [esp+4Ch] [ebp-4h]

  for ( i = sub_40157D;
        *(_DWORD *)i != -1873260400 || *((_DWORD *)i + 1) != -1873063024;
        i = (void (__userpurge *)(int@<eax>, __int16@<dx>, int@<ecx>, int@<ebx>, int@<esi>, ULONG_PTR, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int))((char *)i + 1) )
  {
    ;
  }
  v2 = (char *)i + 8;
  Flink = NtCurrentPeb()->Ldr->InInitializationOrderModuleList.Flink->Flink[1].Flink;
  v4 = sub_401113((int)Flink, -735774209);
  lstrcpyA(String1, v4);
  v5 = sub_401113((int)Flink, 59021819);
  lstrcpyA(v10, v5);
  v6 = 0;
  while ( *(_DWORD *)v2 != -1869574000 || *((_DWORD *)v2 + 1) != -1869574000 )
  {
    v7 = *v2;
    v8 = 3303;
    do
    {
      v7 ^= String1[v6];
      --v8;
    }
    while ( v8 );
    ++v6;
    *v2++ = v7;
    if ( v6 >= 0xE )
    {
      v9 = 0;
      v6 = 0;
      for ( j = 0; j < 0xE; ++j )
      {
        String1[j] += v10[v9++];
        if ( v9 >= 0xB )
          v9 = 0;
      }
    }
  }
}
// 40204B: using guessed type CHAR String1[32];
// 40204B: using guessed type CHAR var_44[32];

//----- (00402105) --------------------------------------------------------
void __stdcall __noreturn StartAddress(LPVOID lpThreadParameter)
{
  while ( 1 )
    SleepEx(0x84Bu, 1);
}

//----- (00402114) --------------------------------------------------------
int __stdcall start(int a1, int a2, int a3, int a4)
{
  HANDLE Thread; // esi

  Thread = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)StartAddress, 0, 0, 0);
  QueueUserAPC(pfnAPC, Thread, 0);
  SleepEx(0xECu, 0);
  QueueUserAPC((PAPCFUNC)sub_40157D, Thread, 0);
  CloseHandle(Thread);
  SleepEx(0xFFFFFFFF, 1);
  return 0;
}

// nfuncs=5 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
