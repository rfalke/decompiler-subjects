/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn start();
void __noreturn sub_4010D5();
// void __usercall sub_404107(int@<eax>, unsigned int@<edx>, int@<ecx>, __int16@<bx>);
// void __usercall sub_4041A9(int@<edx>, int@<ecx>, unsigned int@<esi>);
// void __usercall sub_4041C0(bool _CF@<cf>, bool _ZF@<zf>, bool _OF@<of>, bool _PF@<pf>, int@<edx>, int@<ecx>, int@<edi>);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_4043E4; // weak


//----- (004010AB) --------------------------------------------------------
void __noreturn start()
{
  sub_4010D5();
}

//----- (004010D5) --------------------------------------------------------
void __noreturn sub_4010D5()
{
  struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList; // [esp-4h] [ebp-4h] BYREF

  ExceptionList = NtCurrentTeb()->NtTib.ExceptionList;
  __writefsdword(0, (unsigned int)&ExceptionList);
  __halt();
}

//----- (00404107) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_404107(int a1@<eax>, unsigned int a2@<edx>, int a3@<ecx>, __int16 a4@<bx>)
{
  unsigned int v4; // esi
  bool v5; // cf
  int v6; // edi
  int v7; // edi
  int v8; // edx
  int v9; // esi
  int v10; // edx
  int v11; // ecx
  unsigned __int8 v12; // al
  int v13; // edx
  int v14; // ecx
  int savedregs; // [esp+0h] [ebp+0h]
  unsigned int savedregsa; // [esp+0h] [ebp+0h]

  __asm
  {
    fcomp   st(5)
    fmul    st(4), st
  }
  v4 = a2;
  v5 = BYTE1(a3) < BYTE1(a1);
  if ( (char)(BYTE1(a3) - BYTE1(a1)) < 0 )
  {
    if ( __SETP__(BYTE1(a3), BYTE1(a1)) )
      a1 = a3;
    v4 = a1 + v5 + a2;
    __asm { fsub    st(5), st }
    if ( !__SETP__(v4 & a4, 0) )
      v4 = -2114435862;
    __asm { fcom    st(6) }
    _BitScanReverse((unsigned int *)&a3, a2);
  }
  v6 = -1102712303;
  if ( (BYTE1(a2) & BYTE1(a3)) == 0 )
    v6 = a3;
  if ( (BYTE1(a2) & BYTE1(a3)) == 0 )
    v4 = v6;
  __asm
  {
    fcom    st
    fcomp   st(6)
  }
  v7 = a3 >> 28;
  v8 = savedregs;
  savedregsa = v4;
  v9 = (a3 >> 28) ^ (v4 + 1);
  __asm { fcom    st(2) }
  sub_4041C0(0, v9 == 0, 0, __SETP__(v9, 0), v8, (a3 >> 28) + 1, a3 >> 28);
  sub_4041A9(v10, v11, v9);
  __outbyte(v13, v12);
  _BitScanReverse((unsigned int *)&v9, v7);
  sub_4041A9(-v13, v14, v9 + 483498232);
}
// 40418C: positive sp value 8 has been found
// 404111: inconsistent fpu stack
// 40418B: variable 'savedregs' is possibly undefined
// 404198: variable 'v10' is possibly undefined
// 404198: variable 'v11' is possibly undefined
// 40419D: variable 'v13' is possibly undefined
// 40419D: variable 'v12' is possibly undefined
// 4041A8: variable 'v14' is possibly undefined

//----- (004041A9) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_4041A9(int a1@<edx>, int a2@<ecx>, unsigned int a3@<esi>)
{
  int savedregs; // [esp+0h] [ebp+0h]

  sub_4041C0(a3 >= 0xFFF91CDE, a3 == -451362, __OFSUB__(a3, -451362), __SETP__(a3 + 451362, 0), a1, a2, savedregs);
}
// 4041BF: positive sp value 4 has been found
// 4041A9: could not find valid save-restore pair for edi
// 4041BF: variable 'savedregs' is possibly undefined

//----- (004041C0) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_4041C0(
        bool _CF@<cf>,
        bool _ZF@<zf>,
        bool _OF@<of>,
        bool _PF@<pf>,
        int a5@<edx>,
        int a6@<ecx>,
        int a7@<edi>)
{
  int v7; // eax
  int v8; // edi
  int v9; // esi
  bool v10; // zf
  char v12; // pf
  int v13; // edi
  char v14; // cc
  int v15; // esi
  int v16; // edi
  int v17; // edi
  int v18; // esi
  _DWORD *v19; // ebx
  int v22; // ecx
  int v25; // [esp-8h] [ebp-8h]
  int v26; // [esp-4h] [ebp-4h]

  v7 = a5;
  if ( _OF )
  {
    v25 = a7;
    __asm { fsubr   st(1), st }
    a7 += _CF + a5 + 1;
    _CF = __CFSHL__(v25, -99);
    v7 = v25 << 29;
    _ZF = v25 << 29 == 0;
    _PF = __SETP__(v25 << 29, 0);
    __asm { fcom    st(4) }
  }
  if ( !_PF )
  {
    __asm { fcomp   st }
    v8 = ~(_CF + a7 + 1558694351);
    _CF = _bittestandreset(&v8, v7);
    a7 = a5;
    v7 += 2;
    _ZF = v7 == 0;
  }
  if ( _CF || _ZF )
  {
    v7 = ~v7;
    a7 = ~a7;
    __asm { fsub    st(2), st }
  }
  v9 = a5;
  v13 = a7 & ~(1 << v7);
  if ( !(_SF ^ _OF | v10) )
  {
    if ( !v12 )
      v9 = v13;
    _OF = __OFADD__(1, v9);
    v15 = v9 + 1;
    v14 = (v15 < 0) ^ _OF | (v15 == 0);
    v16 = v15;
    if ( !_OF )
      v15 = v7;
    if ( v14 )
      v16 = a6;
    v9 = v15 - 1;
    v17 = v16 + 1;
    v10 = v17 == 0;
    _SF = v17 < 0;
  }
  if ( !v10 )
  {
    v18 = 1087374111;
    if ( !_SF )
      v18 = v7;
    _ZF = v18 == 1;
    v9 = 10;
    if ( !_ZF )
      v9 = v7;
  }
  __asm { fsub    st(3), st }
  v19 = (_DWORD *)(v26 + 649);
  _ESI = v9 - 2;
  __asm
  {
    rep inc esi
    fmul    st(2), st
  }
  v22 = v26 + 1615;
  while ( 1 )
  {
    _EDI = -476897774;
    __asm { rcl     edi, 57h }
    *v19 ^= 0x85C83B3D;
    __asm { fsubr   st(4), st }
    ++v19;
    if ( (unsigned __int8)v22 > 0x5Eu )
      __asm { fadd    st, st }
    __asm
    {
      fsubr   st(5), st
      fsub    st(5), st
    }
    if ( (int)v19 >= v22 )
    {
      ((__int64 (*)(void))loc_4043E4)();
      __asm { repne pop edi }
      JUMPOUT(0x4043E4);
    }
  }
}
// 404212: positive sp value 4 has been found
// 4041CE: inconsistent fpu stack
// 4043E1: control flows out of bounds to 4043E4
// 404217: variable '_SF' is possibly undefined
// 404217: variable '_OF' is possibly undefined
// 404214: variable 'v10' is possibly undefined
// 404219: variable 'v12' is possibly undefined
// 40426A: variable 'v26' is possibly undefined

// nfuncs=5 queued=5 decompiled=5 lumina nreq=0 worse=0 better=0
// ALL OK, 5 function(s) have been successfully decompiled
