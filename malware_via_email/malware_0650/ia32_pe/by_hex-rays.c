/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __cdecl start(int, int, int);
// int __usercall sub_401111@<eax>(int result@<eax>);
// void __usercall sub_4040F7(char@<cf>, char@<al>);
// void __usercall sub_404122(char _SF@<sf>, char _OF@<of>, int@<ecx>);
// void __usercall sub_404182(__int16@<ax>, __int16@<dx>, int@<ecx>, int@<ebx>, __int16@<di>, unsigned int@<esi>);
// void __usercall sub_404253(__int16@<ax>, int@<ecx>);

//-------------------------------------------------------------------------
// Data declarations

// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
_UNKNOWN loc_4043A8; // weak


//----- (004010BC) --------------------------------------------------------
int __cdecl start(int a1, int a2, int a3)
{
  int v3; // edx

  GetModuleHandleA(0);
  GetModuleHandleA(0);
  GetModuleHandleA(0);
  GetModuleHandleA(0);
  GetModuleHandleA(0);
  sub_401111(0x10000);
  v3 = *(_DWORD *)(a3 + 176) - 1;
  if ( *(_DWORD *)(a3 + 176) == 1 )
    *(_DWORD *)(a3 + 184) += 3;
  *(_DWORD *)(a3 + 176) = v3;
  return 0;
}

//----- (00401111) --------------------------------------------------------
int __usercall sub_401111@<eax>(int result@<eax>)
{
  int v1; // [esp-4h] [ebp-4h] BYREF

  __writefsdword(0, (unsigned int)&v1);
  MEMORY[0] &= result;
  return result;
}

//----- (004040F7) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_4040F7(char a1@<cf>, char a2@<al>)
{
  char v2; // of
  int v3; // eax
  int v4; // ecx
  bool v5; // sf
  int savedregs; // [esp+0h] [ebp+0h]

  if ( a1 )
    ++a2;
  sub_404122((a2 & 8) != 0, v2, savedregs);
  *(_DWORD *)(v4 + 1980345811) = v3;
  v2 = __OFSUB__(*(_BYTE *)(v4 - 220203053), (_BYTE)v4);
  v5 = (char)(*(_BYTE *)(v4 - 220203053) - v4) < 0;
  *(_BYTE *)(v4 - 220203053) -= v4;
  sub_404122(v5, v2, v4);
}
// 404111: positive sp value 4 has been found
// 404111: variable 'v2' is possibly undefined
// 404111: variable 'savedregs' is possibly undefined
// 404116: variable 'v3' is possibly undefined
// 404116: variable 'v4' is possibly undefined

//----- (00404122) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_404122(char _SF@<sf>, char _OF@<of>, int a3@<ecx>)
{
  int v8; // edi
  __int16 v9; // dx
  unsigned int v10; // ecx
  int v11; // ebx
  int v12; // [esp-4h] [ebp-4h]
  __int16 savedregs; // [esp+0h] [ebp+0h]

  if ( _SF == _OF )
    ++a3;
  _ESI = -167693354;
  __asm { repne inc esi }
  v8 = -(a3 + 1);
  sub_404182(33179, savedregs, v12, -870431937, v8, _ESI);
  __asm { outsd }
  v11 = __ROR4__(-870431937, 8);
  if ( !__CFSHR__(-870431937, 8) )
    LOWORD(v8) = 15835;
  sub_404182(v10 + 1, v9 + 8618, v10, v11, v8, v10);
}
// 40414A: positive sp value 4 has been found
// 404151: variable 'savedregs' is possibly undefined
// 404151: variable 'v12' is possibly undefined
// 404180: variable 'v10' is possibly undefined
// 404175: variable 'v9' is possibly undefined

//----- (00404182) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_404182(
        __int16 a1@<ax>,
        __int16 a2@<dx>,
        int a3@<ecx>,
        int a4@<ebx>,
        __int16 a5@<di>,
        unsigned int a6@<esi>)
{
  __int16 v6; // dx
  __int16 v7; // bx
  __int16 v8; // di
  bool v10; // cf
  bool v11; // of
  _BOOL2 v13; // tt
  unsigned int v14; // esi
  int v15; // ebx
  __int16 v16; // ax
  unsigned int savedregs; // [esp+0h] [ebp+0h]

  v6 = a6 & a2;
  v7 = __ROR4__(a4, 184);
  v8 = ~a5;
  if ( v6 )
    v8 = a1;
  LOWORD(a6) = v8 ^ a6;
  __asm { fmul    st(6), st }
  if ( !(_WORD)a6 )
    _BitScanReverse((unsigned int *)&a3, v6);
  _EDI = a3;
  v10 = _bittestandreset(&_EDI, a6);
  __asm { rcl     edi, 0F9h }
  v13 = v10;
  v10 = __CFADD__(v10, (_WORD)_EDI);
  v11 = __OFADD__(v13, (_WORD)_EDI);
  LOWORD(_EDI) = v13 + _EDI;
  v10 |= __CFADD__((_WORD)_EDI, -22584);
  v11 |= __OFADD__(-22584, (_WORD)_EDI);
  LOWORD(_EDI) = _EDI - 22584;
  v14 = ~a6;
  if ( v11 )
  {
    LOWORD(a3) = v7 + a3;
    ++_EDI;
    __asm { fmul    st(5), st }
    v10 = 0;
  }
  if ( v10 )
    v14 = _EDI;
  __asm
  {
    fadd    st(6), st
    fcomp   st(3)
  }
  savedregs = v14 - 1;
  v15 = a3 - 1;
  sub_404253(42952, a3 + 1);
  _ESI = v10 + v15 + 1035172603;
  if ( !(__OFADD__(v10, v15) | __OFADD__(1035172603, v10 + v15)) )
    __asm { rcr     esi, 80h }
  __asm
  {
    fadd    st(7), st
    repne fmul st, st
  }
  sub_404253(v16, 404175690);
}
// 4041D4: positive sp value 8 has been found
// 404194: inconsistent fpu stack
// 4041F8: variable 'v10' is possibly undefined
// 404252: variable 'v16' is possibly undefined

//----- (00404253) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_404253(__int16 a1@<ax>, int a2@<ecx>)
{
  _DWORD *v2; // edx
  unsigned int v3; // ebx
  __int16 v4; // di
  __int16 v5; // cx
  int v6; // ebx
  int v7; // ecx
  int v8; // esi
  int v9; // esi
  __int16 v10; // bx
  int v11; // edi
  int v12; // esi
  int v13; // ebx
  char v14; // cc
  int v15; // [esp-8h] [ebp-8h]

  __asm
  {
    fadd    st(3), st
    fcom    st(7)
  }
  v2 = (_DWORD *)(v15 + 483);
  __asm { repne push 0FFFFFF98h }
  v3 = __ROR4__(v15, 181);
  v4 = -14341;
  if ( (((a2 - 751015368) | 0x20000) + 1364460804 < 0) ^ __OFADD__(1364460804, (a2 - 751015368) | 0x20000) | (((a2 - 751015368) | 0x20000) == -1364460804) )
    v4 = a1;
  __asm { fadd    st(6), st }
  LOWORD(v3) = v4 + v3;
  _BitScanReverse((unsigned int *)&v7, v3);
  __asm { fcomp   st }
  v6 = __ROR4__(v3, 248) | 0x3DEBC1A9;
  LOWORD(v7) = v5 - 29234 + v4;
  v8 = (unsigned __int16)v7;
  while ( 1 )
  {
    v9 = -v8;
    if ( v9 >= 1 && v9 != 0 )
    {
      HIWORD(v7) = HIWORD(v9);
      v10 = v6 - 1;
      LOWORD(v7) = v10 + v9;
      v11 = v7 << 29;
      __asm { rep stc }
      LOBYTE(v7) = v10;
      v6 = v11;
    }
    __asm { fmul    st, st }
    v12 = (unsigned __int16)v6;
    v13 = v6 | (1 << v7);
    __asm { fsubr   st(5), st }
    if ( v12 <= 1 )
      __asm { fcomp   st(6) }
    v6 = ~v13;
    *v2 -= 1059098840;
    v14 = ((int)(v2 + 1) < 0) ^ __OFADD__(4, v2) | (v2 + 1 == 0);
    ++v2;
    if ( v14 )
      __asm { repne cld }
    LOBYTE(v7) = v6;
    v8 = v6;
    if ( (int)v2 >= v15 + 1447 )
    {
      ((void (*)(void))loc_4043A8)();
      JUMPOUT(0x4043A8);
    }
  }
}
// 404366: positive sp value 8 has been found
// 404253: inconsistent fpu stack
// 4043A6: control flows out of bounds to 4043A8
// 404282: variable 'v15' is possibly undefined

// nfuncs=6 queued=6 decompiled=6 lumina nreq=0 worse=0 better=0
// ALL OK, 6 function(s) have been successfully decompiled
