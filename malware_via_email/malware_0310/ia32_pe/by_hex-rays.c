/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall __noreturn start(struct _SECURITY_ATTRIBUTES *@<edi>);
// struct _SECURITY_ATTRIBUTES *__userpurge sub_401160@<eax>(struct _SECURITY_ATTRIBUTES *@<edi>, int, int);
// void __usercall sub_4011B0(int@<ecx>, int@<edi>);
// int __usercall sub_4011C0@<eax>(int@<ecx>, int@<edi>);
// int __usercall sub_4011E0@<eax>(int@<eax>, int@<ecx>);
int __stdcall sub_401260(int);
// unsigned int __usercall sub_401280@<eax>(int@<ebx>);

//-------------------------------------------------------------------------
// Data declarations

// extern HANDLE (__stdcall *CreateEventW)(LPSECURITY_ATTRIBUTES lpEventAttributes, BOOL bManualReset, BOOL bInitialState, LPCWSTR lpName);


//----- (00401040) --------------------------------------------------------
void __usercall __noreturn start(struct _SECURITY_ATTRIBUTES *a1@<edi>)
{
  unsigned int v1; // edx
  int v2; // eax
  _DWORD *v3; // ecx
  int v4; // ecx
  char v5[189066]; // [esp+0h] [ebp-2E2EEh] BYREF
  int v6; // [esp+2E28Ah] [ebp-64h]
  int v7; // [esp+2E28Eh] [ebp-60h]
  char *v8; // [esp+2E292h] [ebp-5Ch]
  int v9; // [esp+2E2D2h] [ebp-1Ch]
  char v10[4]; // [esp+2E2D6h] [ebp-18h] BYREF
  char *v11; // [esp+2E2DAh] [ebp-14h]
  int v12; // [esp+2E2DEh] [ebp-10h]
  char v13; // [esp+2E2EAh] [ebp-4h] BYREF

  sub_401160(a1, 0, (int)v10);
  *(unsigned int *)((char *)&STACK[0x5C564] - v1 + 64) = v1;
  v2 = (48353792 - (v1 << 8)) & ((v1 << 8) - 44220864);
  v3 = (_DWORD *)((v1 << 10) + v2 - 193669044);
  *(_DWORD *)&v5[v9 + 12] = *v3 - 40;
  v11 = (char *)(*(v3 - 1) + v2 + 189178 - v9);
  sub_401280(*(_DWORD *)&v5[v9]);
  v8 = &v13;
  v7 = 4;
  v6 = v4;
  sub_4011B0(*(_DWORD *)&v5[v9], (int)a1);
  ((void (__cdecl *)(char *, int, int))(v9 + 4009518))(v11, v12, v9);
  v11 += 189186;
  v11 -= v9;
  ((void (__cdecl *)(char *, _DWORD))v11)(v11 + 3018, 0);
}
// 401059: variable 'v1' is possibly undefined
// 4010B7: variable 'v4' is possibly undefined
// 401040: using guessed type char var_18[4];

//----- (00401160) --------------------------------------------------------
struct _SECURITY_ATTRIBUTES *__userpurge sub_401160@<eax>(struct _SECURITY_ATTRIBUTES *a1@<edi>, int a2, int a3)
{
  int v3; // eax

  v3 = sub_401260(23);
  ((HANDLE (__stdcall *)(LPSECURITY_ATTRIBUTES, BOOL, BOOL, LPCWSTR))((char *)CreateEventW + v3 + 2))(
    a1,
    0,
    v3 + 2,
    (LPCWSTR)(v3 + 2));
  return a1;
}

//----- (004011B0) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_4011B0(int a1@<ecx>, int a2@<edi>)
{
  int v2; // eax
  int v3; // ecx
  void (*v4)(void); // eax

  v2 = sub_4011C0(a1, a2);
  v4 = (void (*)(void))sub_4011E0(v2, v3);
  v4();
  __asm { retn }
}
// 4011BC: positive sp value 4 has been found
// 4011BF: unbalanced stack, ignored a potential tail call
// 4011B6: variable 'v3' is possibly undefined

//----- (004011C0) --------------------------------------------------------
int __usercall sub_4011C0@<eax>(int a1@<ecx>, int a2@<edi>)
{
  return *(_DWORD *)(**(_DWORD **)(*(_DWORD *)(*(_DWORD *)(a2 + 48 + a1) + 12) + 28) + 8);
}

//----- (004011E0) --------------------------------------------------------
int __usercall sub_4011E0@<eax>(int a1@<eax>, int a2@<ecx>)
{
  int v2; // esi
  int v3; // edi
  int i; // [esp+0h] [ebp-8h]
  int v6; // [esp+4h] [ebp-4h]

  v2 = a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + 2 * a2 - 189078 - a2) + 120) + 32);
  v3 = a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + 2 * a2 - 189078 - a2) + 120) + 28);
  *(unsigned int *)((char *)&STACK[0x2E2D6] - a2) = 1443059509 - a2;
  for ( i = 0; v6 != *(_DWORD *)(a2 + a1 + *(_DWORD *)(v2 + i) - 189126); i += 4 )
    ;
  return a1 + *(_DWORD *)(i + v3);
}
// 401243: variable 'v6' is possibly undefined

//----- (00401260) --------------------------------------------------------
int __stdcall sub_401260(int a1)
{
  return -2;
}

//----- (00401280) --------------------------------------------------------
unsigned int __usercall sub_401280@<eax>(int a1@<ebx>)
{
  return (unsigned int)((a1 << 10) - 189478272) >> 16 << 16;
}

// nfuncs=7 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
