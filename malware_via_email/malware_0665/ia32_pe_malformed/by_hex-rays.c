/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// int __userpurge start@<eax>(__int32 a1@<eax>, int a2, int a3, int a4);
DWORD sub_400329();
int __stdcall sub_40036A(int a1, int a2, int a3);
// HMODULE __userpurge sub_4003B3@<eax>(__int32 a1@<eax>, const CHAR *a2);
// int __usercall sub_4004B5@<eax>(int a1@<eax>);
// char __usercall sub_4004C2@<al>(char *a1@<eax>, int a2@<ecx>, _BYTE *a3@<edi>);
// HANDLE __stdcall GetCurrentProcess();
// DWORD __stdcall GetLastError();
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_4004A9; // weak
// extern _UNKNOWN EnumPageFilesA; weak
int dword_400800 = 0; // weak
char byte_40082C[4] = { '•', 'z', '\x7F', '*' }; // idb
int dword_400830 = 23869; // weak
int dword_400834 = 5888; // weak


//----- (00400300) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __userpurge start@<eax>(__int32 a1@<eax>, int a2, int a3, int a4)
{
  const CHAR *v5; // [esp-4h] [ebp-4h]

  sub_4003B3(a1, v5);
  dword_400800 = 20;
  ((void (__stdcall *)(int (__stdcall *)(int, int, int), _DWORD))EnumPageFilesA)(sub_40036A, 0);
  return 0;
}
// 400305: positive sp value 4 has been found
// 400300: variable 'v5' is possibly undefined
// 400800: using guessed type int dword_400800;

//----- (00400329) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
DWORD sub_400329()
{
  return GetLastError();
}
// 40033E: positive sp value 4 has been found

//----- (0040036A) --------------------------------------------------------
int __stdcall sub_40036A(int a1, int a2, int a3)
{
  int v3; // esi
  unsigned int v4; // ecx
  int v5; // edx
  char v6; // al
  char v7; // bl

  v3 = ((int (*)(void))loc_4004A9)();
  v4 = 0;
  v5 = 0;
  do
  {
    v6 = byte_40082C[v5];
    v7 = *(_BYTE *)(v4 + v3);
    if ( v7 && v7 != v6 )
      *(_BYTE *)(v4 + v3) = v6 ^ v7;
    ++v4;
    if ( (unsigned int)++v5 >= 4 )
      v5 = 0;
  }
  while ( v4 < dword_400830 );
  return 0;
}
// 400830: using guessed type int dword_400830;

//----- (004003B3) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
HMODULE __userpurge sub_4003B3@<eax>(__int32 a1@<eax>, const CHAR *a2)
{
  void *v2; // esp
  __int32 v4; // [esp-4h] [ebp-20h] BYREF

  v4 = a1;
  v2 = alloca(4);
  _InterlockedExchange(&v4, 4);
  GetCurrentProcess();
  return GetModuleHandleA(a2);
}
// 400495: positive sp value 14 has been found

//----- (004004B5) --------------------------------------------------------
int __usercall sub_4004B5@<eax>(int a1@<eax>)
{
  return dword_400834 + a1;
}
// 400834: using guessed type int dword_400834;

//----- (004004C2) --------------------------------------------------------
char __usercall sub_4004C2@<al>(char *a1@<eax>, int a2@<ecx>, _BYTE *a3@<edi>)
{
  char result; // al

  do
  {
    result = *a1++;
    *a3++ = result;
    --a2;
  }
  while ( a2 );
  return result;
}

// nfuncs=13 queued=6 decompiled=6 lumina nreq=0 worse=0 better=0
// ALL OK, 6 function(s) have been successfully decompiled
