/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

unsigned int __cdecl sub_1310D000(int a1, int a2, int String, int a4, int a5, int a6);
void __noreturn start(); // weak
int sub_1310D6AF();
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// BOOL __stdcall FreeLibrary(HMODULE hLibModule);
// HRSRC __stdcall FindResourceExW(HMODULE hModule, LPCWSTR lpType, LPCWSTR lpName, WORD wLanguage);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// ATOM __stdcall AddAtomW(LPCWSTR lpString);
// HRSRC __stdcall FindResourceW(HMODULE hModule, LPCWSTR lpName, LPCWSTR lpType);
// DWORD __stdcall GetCurrentProcessId();
// DWORD __stdcall GetLastError();
// HRSRC __stdcall FindResourceExA(HMODULE hModule, LPCSTR lpType, LPCSTR lpName, WORD wLanguage);
// int __stdcall ImageList_AddMasked(HIMAGELIST himl, HBITMAP hbmImage, COLORREF crMask);
// BOOL __stdcall ImageList_GetImageInfo(HIMAGELIST himl, int i, IMAGEINFO *pImageInfo);
// BOOL __stdcall ImageList_Remove(HIMAGELIST himl, int i);
// HIMAGELIST __stdcall ImageList_LoadImageA(HINSTANCE hi, LPCSTR lpbmp, int cx, int cGrow, COLORREF crMask, UINT uType, UINT uFlags);
// PVOID __stdcall DSA_GetItemPtr(HDSA hdsa, int i);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_1310E7D0; // weak
_UNKNOWN unk_1310E7D4; // weak


//----- (1310D000) --------------------------------------------------------
unsigned int __cdecl sub_1310D000(int a1, int a2, int String, int a4, int a5, int a6)
{
  unsigned int result; // eax
  _BYTE v8[5]; // [esp+Bh] [ebp-19h]
  _BYTE *i; // [esp+30h] [ebp+Ch]

  *(_DWORD *)a4 = String;
  result = a5 / 5u;
  *(_DWORD *)&v8[1] = a5 % 5u;
  for ( i = (_BYTE *)(a5 + a2); String--; ++i )
  {
    AddAtomW((LPCWSTR)&String);
    v8[0] = *i;
    *(_DWORD *)v8 ^= *(unsigned __int8 *)(a6 + *(unsigned __int16 *)&v8[1]);
    *(_BYTE *)a1 = v8[0];
    *(_DWORD *)&v8[1] = *(unsigned __int16 *)&v8[1] + 1;
    if ( *(__int16 *)&v8[1] == 5 )
      *(_WORD *)&v8[1] = 0;
    result = a1 + 1;
    if ( a1 == -1207959553 )
      break;
    ++a1;
  }
  return result;
}

//----- (1310D0B2) --------------------------------------------------------
void __noreturn start()
{
  int v0; // [esp+74h] [ebp-260h]
  int v1; // [esp+78h] [ebp-25Ch]
  int v2; // [esp+7Ch] [ebp-258h] BYREF
  WCHAR String[2]; // [esp+80h] [ebp-254h] BYREF
  int v4; // [esp+84h] [ebp-250h]
  int v5; // [esp+8Ch] [ebp-248h]
  int v6; // [esp+90h] [ebp-244h] BYREF
  int v7; // [esp+94h] [ebp-240h]
  int v8; // [esp+98h] [ebp-23Ch]
  int v9; // [esp+9Ch] [ebp-238h] BYREF
  int v10; // [esp+A0h] [ebp-234h] BYREF
  char v11[44]; // [esp+A4h] [ebp-230h] BYREF
  int i[119]; // [esp+D0h] [ebp-204h] BYREF
  int v13; // [esp+2ACh] [ebp-28h]
  void **v14; // [esp+2B0h] [ebp-24h] BYREF
  int *v15; // [esp+2B4h] [ebp-20h]
  int v16; // [esp+2B8h] [ebp-1Ch]
  int v17; // [esp+2BCh] [ebp-18h] BYREF
  int v18; // [esp+2C0h] [ebp-14h]
  int v19; // [esp+2C4h] [ebp-10h] BYREF
  int v20; // [esp+2C8h] [ebp-Ch] BYREF
  _BYTE *v21; // [esp+2CCh] [ebp-8h]
  int v22; // [esp+2D0h] [ebp-4h]
  void *retaddr; // [esp+2D8h] [ebp+4h] BYREF

  FindResourceW(0, (LPCWSTR)0xAA00000, (LPCWSTR)0x268);
  ImageList_AddMasked((HIMAGELIST)0x3F400, (HBITMAP)0x80000, 0xBD0000u);
  DSA_GetItemPtr((HDSA)i, 876544);
  FindResourceExA((HMODULE)0x234000, (LPCSTR)0x460000, (LPCSTR)0x40000000, 0x3C00u);
  ImageList_GetImageInfo((HIMAGELIST)0x73000, (int)i, (IMAGEINFO *)0xF094A83);
  GetCurrentProcessId();
  v11[0] = -98;
  *(_DWORD *)&v11[1] = -1291242224;
  ImageList_LoadImageA((HINSTANCE)0x550, 0, 12032, 3152, 0x3B0000u, 0x2600000u, 0x20000u);
  v8 = 319875024;
  FindResourceW((HMODULE)0xDA0000, (LPCWSTR)0x8F00000, (LPCWSTR)0x24000000);
  v9 = unk_1310E7D0;
  ImageList_Remove((HIMAGELIST)0x1580000, 18350080);
  sub_1310D000((int)&v9, (int)&v9, 4, (int)&v20, 0, (int)v11);
  v14 = &retaddr;
  *(_DWORD *)String = unk_1310E7D4;
  FindResourceExW((HMODULE)0x1EA0000, (LPCWSTR)0xF300000, (LPCWSTR)0x3440000, 0);
  sub_1310D000((int)String, (int)&v2, 4, (int)&v20, 4, (int)v11);
  v19 = *(_DWORD *)(v8 + 8);
  sub_1310D000((int)&v19, (int)&v17, 4, (int)&v20, 8, (int)v11);
  FreeLibrary((HMODULE)0x6F00);
  v15 = (int *)(v8 + 12);
  v16 = 319815680;
  v4 = 319819776;
  v5 = 12;
  v17 = *(_DWORD *)(v8 + 12);
  sub_1310D000((int)&v17, (int)&v14, 4, (int)&v20, 12, (int)v11);
  v17 += GetLastError() - 123;
  v17 += v16;
  FindResourceW(0, (LPCWSTR)0x28000, (LPCWSTR)0x3A000000);
  v5 += 4;
  v6 = *++v15;
  sub_1310D000((int)&v6, (int)&v6 - v5, 4, (int)&v20, v5, (int)v11);
  v5 += 4;
  FindResourceW((HMODULE)0x180, (LPCWSTR)0x1E0, (LPCWSTR)0x7B00);
  ++v15;
  v13 = 8 * v19 + 12;
  v1 = (int)VirtualAlloc(0, v9 + *(_DWORD *)String + v13, 0x3000u, 0x40u);
  v21 = (_BYTE *)(v13 + v17);
  v7 = v13;
  v0 = v13;
  v22 = 0;
  v18 = 0;
  while ( 1 )
  {
    if ( v0 == v6 )
    {
      if ( ++v22 == v19 )
      {
        sub_1310D000(v1, v1 - v13, *(int *)String, (int)&v10, v13, (int)v11);
        ((void (__cdecl *)(int, int, int, _DWORD, char *, void **))(v1 + 3920))(
          *(_DWORD *)String + v1,
          v1,
          v9,
          *(_DWORD *)String,
          v11,
          v14);
        ExitProcess(0);
      }
      v17 = *v15;
      sub_1310D000((int)&v17, (int)&v17 - v5, 4, (int)&v20, v5, (int)v11);
      v17 += v16;
      v5 += 4;
      v6 = *++v15;
      sub_1310D000((int)&v6, (int)&v6 - v5, 4, (int)&v20, v5, (int)v11);
      v5 += 4;
      ++v15;
      v0 = 0;
      v21 = (_BYTE *)v17;
    }
    *(_BYTE *)(v18 + v1) = *v21++;
    ++v18;
    ++v0;
    ++v7;
  }
}
// 1310D0B2: using guessed type void __noreturn start();

//----- (1310D6AF) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int sub_1310D6AF()
{
  return 0;
}
// 1310D6B6: positive sp value 4 has been found

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
