/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void start();
char *sub_4003F8();
// char __usercall sub_40040C@<al>(char *a1@<eax>, int a2@<ecx>, _BYTE *a3@<edi>);
char *sub_400415();
BOOL __stdcall sub_40046D(LPSTR); // idb
int sub_400493();
BOOL __stdcall TimeFmtEnumProc(LPSTR); // idb
BOOL __stdcall j_EnumTimeFormatsA(TIMEFMT_ENUMPROCA lpTimeFmtEnumProc, LCID Locale, DWORD dwFlags);
DWORD __stdcall j_GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
DWORD __stdcall j_GetLastError();
HMODULE __stdcall j_GetModuleHandleA(LPCSTR lpModuleName);

//-------------------------------------------------------------------------
// Data declarations

int dword_400308 = -1537; // weak
_UNKNOWN loc_400316; // weak
_UNKNOWN loc_400319; // weak
_UNKNOWN loc_40031C; // weak
int dword_400359 = -23702; // weak
int dword_40050C = 0; // weak
int dword_400510[3] = { 988066988, -1596411670, -1310837032 }; // weak
const CHAR ModuleName[4] = "µÊ9Ü"; // idb


//----- (00400300) --------------------------------------------------------
void start()
{
  char *v2; // kr00_4
  int savedregs; // [esp+8h] [ebp+0h] BYREF

  _EBP = &savedregs;
  sub_400493();
  __asm { arpl    [edx+0], bp }
  j_GetFileSize(&loc_40031C, (LPDWORD)((char *)&loc_400319 + 1));
  j_GetLastError();
  sub_4003F8();
  v2 = sub_400415();
  __asm { jmp     eax }
}

//----- (004003F8) --------------------------------------------------------
char *sub_4003F8()
{
  return (char *)j_GetModuleHandleA(0) - 1537;
}

//----- (0040040C) --------------------------------------------------------
char __usercall sub_40040C@<al>(char *a1@<eax>, int a2@<ecx>, _BYTE *a3@<edi>)
{
  char result; // al

  do
  {
    result = *a1++;
    *a3++ = result;
    --a2;
  }
  while ( a2 );
  return result;
}

//----- (00400415) --------------------------------------------------------
char *sub_400415()
{
  int v0; // ecx
  int *v1; // eax
  _BYTE *v2; // eax
  HMODULE v3; // ebx
  _DWORD *v4; // edx
  int v5; // ebp

  v0 = 13;
  v1 = dword_400510;
  do
  {
    *(_BYTE *)v1 = __ROR1__(*(_BYTE *)v1, 1);
    v2 = (char *)v1 + 1;
    *v2 = __ROL1__(*v2, 1);
    v1 = (int *)(v2 + 1);
    --v0;
  }
  while ( v0 );
  v3 = j_GetModuleHandleA(ModuleName);
  v4 = (_DWORD *)((char *)v3 + *(_DWORD *)((char *)v3 + *((_DWORD *)v3 + 15) + 120));
  v5 = 0;
  do
  {
    if ( !memcmp((char *)v3 + *(_DWORD *)((char *)v3 + 4 * v5 + v4[8]), dword_400510, 0xDu) )
      break;
    ++v5;
  }
  while ( v5 != v4[6] );
  return (char *)v3 + *(_DWORD *)((char *)v3 + 4 * v5 + v4[7]);
}
// 400510: using guessed type int dword_400510[3];

//----- (0040046D) --------------------------------------------------------
// write access to const memory has been detected, the output may be wrong!
BOOL __stdcall sub_40046D(LPSTR a1)
{
  dword_40050C = 20;
  j_EnumTimeFormatsA(TimeFmtEnumProc, 0, 0);
  return 0;
}
// 40047C: write access to const memory at 40050C has been detected
// 40050C: using guessed type int dword_40050C;

//----- (00400493) --------------------------------------------------------
// write access to const memory has been detected, the output may be wrong!
// positive sp value has been detected, the output may be wrong!
int sub_400493()
{
  loc_400316 = ~loc_400316;
  dword_400359 = 23701;
  dword_400308 = 1536;
  j_EnumTimeFormatsA(sub_40046D, 0, 0);
  return 0;
}
// 4004C2: positive sp value 4 has been found
// 400493: write access to const memory at 400316 has been detected
// 400499: write access to const memory at 400359 has been detected
// 40049F: write access to const memory at 400308 has been detected
// 400308: using guessed type int dword_400308;
// 400359: using guessed type int dword_400359;
// 40050C: using guessed type int dword_40050C;

//----- (004004C3) --------------------------------------------------------
BOOL __stdcall TimeFmtEnumProc(LPSTR a1)
{
  char *v1; // esi
  unsigned int v2; // ecx
  int v3; // edx
  char v4; // al
  char v5; // bl

  v1 = sub_4003F8();
  v2 = 0;
  v3 = 0;
  do
  {
    v4 = *((_BYTE *)&loc_400316 + v3);
    v5 = v1[v2];
    if ( v5 && v5 != v4 )
      v1[v2] = v4 ^ v5;
    ++v2;
    if ( (unsigned int)++v3 >= 4 )
      v3 = 0;
  }
  while ( v2 < 0xFFFFA36A );
  return 0;
}

// nfuncs=12 queued=7 decompiled=7 lumina nreq=0 worse=0 better=0
// ALL OK, 7 function(s) have been successfully decompiled
