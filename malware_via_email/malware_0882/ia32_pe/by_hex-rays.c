/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// BOOL __stdcall ChooseColorW(LPCHOOSECOLORW);
// BOOL __stdcall ConvertSidToStringSidW(PSID Sid, LPWSTR *StringSid);
// HANDLE __stdcall GetCurrentProcess();
// DWORD __stdcall GetCurrentProcessId();
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// DWORD __stdcall GetLastError();
// DWORD __stdcall GetCurrentThreadId();
// void __stdcall GetSystemTimeAsFileTime(LPFILETIME lpSystemTimeAsFileTime);
// LPSTR __stdcall GetCommandLineA();
// BOOL __stdcall GetExitCodeProcess(HANDLE hProcess, LPDWORD lpExitCode);
// HANDLE __stdcall GetProcessHeap();
// HANDLE __stdcall GetStdHandle(DWORD nStdHandle);
// DWORD __stdcall GetVersion();
// HANDLE __usercall sub_402198@<eax>(int a1@<ebx>, int a2@<edi>, int a3@<esi>, PSID a4, LPWSTR *a5);
DWORD start();

//-------------------------------------------------------------------------
// Data declarations

__int16 word_406B52 = -30508; // weak
__int16 word_407DF6 = 6980; // weak


//----- (00402198) --------------------------------------------------------
HANDLE __usercall sub_402198@<eax>(int a1@<ebx>, int a2@<edi>, int a3@<esi>, PSID a4, LPWSTR *a5)
{
  BOOL v5; // eax
  int v6; // ecx
  __int16 *v7; // ebx
  int *v8; // edi
  int v9; // ecx
  int v11; // [esp+0h] [ebp-57Ch]
  int v12; // [esp+20h] [ebp-55Ch]
  BOOL v13; // [esp+1B4h] [ebp-3C8h]
  int v14; // [esp+1BCh] [ebp-3C0h]
  int v17; // [esp+1D4h] [ebp-3A8h] BYREF
  int *v18; // [esp+21Ch] [ebp-360h]
  int v19; // [esp+254h] [ebp-328h]
  struct _FILETIME SystemTimeAsFileTime; // [esp+50Ch] [ebp-70h] BYREF
  DWORD ExitCode[17]; // [esp+52Ch] [ebp-50h] BYREF
  int savedregs; // [esp+57Ch] [ebp+0h] BYREF

  GetExitCodeProcess(0, ExitCode);
  GetSystemTimeAsFileTime(&SystemTimeAsFileTime);
  v5 = ChooseColorW(0);
  if ( v12 != 1 )
    return (HANDLE)((BOOL (__stdcall *)(PSID, LPWSTR *))((char *)&ConvertSidToStringSidW + 1))(a4, a5);
  v14 = v6;
  v13 = v5;
  v18 = (int *)VirtualAlloc(0, 0x14A0u, 0x1000u, 0x40u);
  ChooseColorW(0);
  if ( v11 != 1 )
    JUMPOUT(0x401F26);
  v7 = &word_406B52;
  v8 = v18;
  v19 = 874722284;
  do
  {
    v9 = v19 ^ ((v19 ^ ((v19 ^ ((v19 ^ (*(_DWORD *)v7 + 257427237)) + 409980668)) + 1968118160)) - 633564764);
    v19 += 1077822478;
    *v8 = v9;
    v7 += 2;
    ++v8;
  }
  while ( v7 != &word_407DF6 );
  ((void (__stdcall *)(BOOL, int, int, int, int *, int *, int, int))v18)(v13, 52470, v14, a1, &v17, &savedregs, a2, a3);
  return GetProcessHeap();
}
// 40221E: control flows out of bounds to 401F26
// 4021C7: variable 'v12' is possibly undefined
// 4021E0: variable 'v6' is possibly undefined
// 40221E: variable 'v11' is possibly undefined
// 406B52: using guessed type __int16;
// 407DF6: using guessed type __int16;

//----- (004022E8) --------------------------------------------------------
DWORD start()
{
  GetCurrentProcessId();
  GetCurrentThreadId();
  GetVersion();
  GetCurrentProcess();
  GetCommandLineA();
  GetStdHandle(0);
  GetLastError();
  return GetCurrentThreadId();
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
