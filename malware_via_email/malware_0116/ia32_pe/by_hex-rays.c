/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

_DWORD __cdecl start(_DWORD, _DWORD); // weak
int __cdecl sub_403390(int a1, int a2);
int sub_403590();
// int __usercall sub_403640@<eax>(unsigned int@<eax>, int@<ecx>, int);

//-------------------------------------------------------------------------
// Data declarations

int dword_406028; // weak
int dword_40603C; // weak


//----- (00401020) --------------------------------------------------------
#error "401536: call analysis failed (funcsize=717)"

//----- (00403390) --------------------------------------------------------
int __cdecl sub_403390(int a1, int a2)
{
  unsigned int v2; // ebx
  _DWORD *v3; // edx
  _BYTE *v4; // ecx
  signed int v5; // esi
  unsigned int v6; // eax
  signed int v7; // edi
  int v8; // ecx
  char *v9; // eax
  int v10; // ecx
  unsigned int v11; // eax
  int v12; // edx
  int v13; // edx
  unsigned int v15; // eax
  int v16; // [esp+14h] [ebp-94h]
  _BYTE *v17; // [esp+18h] [ebp-90h]
  _DWORD *v18; // [esp+1Ch] [ebp-8Ch]
  unsigned __int16 *v19; // [esp+20h] [ebp-88h]
  int v20; // [esp+24h] [ebp-84h]
  int v21; // [esp+28h] [ebp-80h]
  int v22[25]; // [esp+36h] [ebp-72h] BYREF
  char v23[14]; // [esp+9Ah] [ebp-Eh] BYREF

  v2 = dword_40603C;
  v21 = dword_40603C;
  v3 = (_DWORD *)(*(_DWORD *)((dword_40603C | a2) + *(_DWORD *)(a2 + 60) + 120) + a2 - dword_40603C * (a2 | 1));
  v18 = v3;
  if ( !(v3[6] / (unsigned int)(dword_40603C + 1)) )
    return 0;
  v20 = 0;
  v19 = (unsigned __int16 *)(v3[9] + (dword_40603C | a2));
  v16 = a2 + v3[8] - dword_40603C * (v3[8] | 1);
  while ( 1 )
  {
    v4 = (_BYTE *)(*(_DWORD *)(v16 + 4 * v20) + a2);
    v5 = 0;
    v23[1] = 0;
    v17 = v4;
    LOBYTE(v6) = *v4;
    if ( *v4 )
    {
      v7 = 0;
      do
      {
        if ( v2 )
          v6 = (char)v6 / v2;
        v23[0] = v6;
        v8 = dword_406028 * (v2 + 1);
        if ( v8 )
        {
          ((void (__stdcall *)(char *, unsigned int))v8)((char *)&v22[1] + v7, (unsigned int)v23 / (v2 + 1));
          v2 = dword_40603C;
        }
        else
        {
          *((_BYTE *)&v22[1] + v5) = v6 - v2 * (v6 | 1);
        }
        v7 = ++v5;
        LOBYTE(v6) = v17[v5];
      }
      while ( (_BYTE)v6 );
    }
    if ( (int)(v2 + 48) > v5 )
    {
      v9 = (char *)&v22[1] + v5;
      do
      {
        ++v5;
        *v9++ = 0;
      }
      while ( (int)(v2 + 48) > v5 );
    }
    v10 = 1;
    v11 = a1 | v21;
    do
    {
      v12 = v22[v10];
      if ( v2 )
        v12 *= 2;
      ++v10;
      v11 ^= v12;
    }
    while ( v10 != 13 );
    if ( v11 != -1 && v11 % (v2 - 1) == -1989060957 )
      break;
    if ( v18[6] / (v2 + 1) <= ++v20 )
      return 0;
    ++v19;
    v21 = v2;
  }
  v13 = -1;
  v15 = a2 + *(_DWORD *)((v18[7] + a2) * (v2 + 1) + 4 * *v19);
  if ( v15 == -1 )
    return v13;
  return v15 % (v2 - 1);
}
// 406028: using guessed type int dword_406028;
// 40603C: using guessed type int dword_40603C;

//----- (00403590) --------------------------------------------------------
int sub_403590()
{
  struct _TEB *v0; // eax
  int v1; // edi
  unsigned int v2; // ebx
  _DWORD *v3; // ecx
  unsigned int v4; // ebx
  int v5; // edx

  v0 = NtCurrentTeb();
  v1 = *(int *)((char *)&v0->ProcessEnvironmentBlock->Ldr->InInitializationOrderModuleList.Flink
              + dword_40603C / ((int)v0->ProcessEnvironmentBlock->Ldr | 1u));
  v3 = (_DWORD *)(v1 - dword_40603C * (v1 | 1));
  while ( 1 )
  {
    v2 = dword_40603C + 1;
    if ( *(_BYTE *)(v3[8] / (unsigned int)(dword_40603C + 1)) == 107 * ((_BYTE)dword_40603C + 1)
      && *(_BYTE *)(v3[8] / v2 + 2) == (unsigned __int8)(dword_40603C / 0x65u) + 101
      && *(_BYTE *)(v3[8] / v2 + 4) == 114 * ((_BYTE)dword_40603C + 1) )
    {
      break;
    }
    v3 = (_DWORD *)(dword_40603C | *v3);
    if ( v1 == *v3 )
      return 0;
  }
  v4 = v3[2];
  v5 = -1;
  if ( v4 != -1 )
    return v4 % (dword_40603C - 1);
  return v5;
}
// 40603C: using guessed type int dword_40603C;

//----- (00403640) --------------------------------------------------------
int __usercall sub_403640@<eax>(unsigned int a1@<eax>, int a2@<ecx>, int a3)
{
  int *v3; // ecx
  int v5; // [esp-4h] [ebp-4h]
  int (__thiscall *retaddr)(int); // [esp+0h] [ebp+0h]

  v5 = a2;
  v3 = &a3;
  while ( a1 >= 0x1000 )
  {
    v3 -= 1024;
    *v3 = *v3;
    a1 -= 4096;
  }
  *(int *)((char *)v3 - a1) = *(int *)((char *)v3 - a1);
  return retaddr(v5);
}

// nfuncs=4 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 4 function(s)"
