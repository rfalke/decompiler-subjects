/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// HANDLE __stdcall CreateThread(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId);
// HANDLE __stdcall GetCurrentThread();
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// BOOL __stdcall GetThreadContext(HANDLE hThread, LPCONTEXT lpContext);
// LPVOID __stdcall HeapAlloc(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
// HANDLE __stdcall HeapCreate(DWORD flOptions, SIZE_T dwInitialSize, SIZE_T dwMaximumSize);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// DWORD __stdcall ResumeThread(HANDLE hThread);
// DWORD __stdcall SuspendThread(HANDLE hThread);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
_BYTE *__stdcall sub_401030(_BYTE *a1, _BYTE *a2, int a3);
// int __usercall sub_40104F@<eax>(int a1@<ebx>, int a2@<esi>);
int sub_40105A();
void __stdcall sub_4010D8(_BYTE *a1, int a2);
void sub_4010FD();
int sub_4011EC();
void __spoils<ecx> sub_4011FC();
int sub_401291();
FARPROC __stdcall sub_4012A6(int a1, FARPROC *a2);
LPVOID __stdcall sub_4012FC(int a1, SIZE_T dwBytes);
int sub_401320();
// int __usercall sub_401344@<eax>(int a1@<esi>);
void __stdcall sub_4013A0(int a1);
int sub_4013CA();
void sub_4013E4();
unsigned __int8 sub_40140E();
void sub_40141F();
void sub_401442();
// int __usercall sub_401486@<eax>(int a1@<esi>);
int sub_40153D();
// HANDLE __usercall sub_401549@<eax>(int a1@<ebp>);
// int __usercall sub_401575@<eax>(int a1@<ebp>);
int nullsub_1(void); // weak
// int __usercall sub_401588@<eax>(int a1@<ebp>);
int __stdcall sub_4015D6(int a1);
// int __usercall start@<eax>(int a1@<esi>);
int nullsub_2(void); // weak

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_401276; // weak
int dword_402000; // weak
int dword_402004; // weak
int dword_402008; // weak
int dword_40200C; // weak
unsigned __int8 byte_402010[240]; // idb
int dword_402100; // idb
int dword_402104; // idb
int dword_402108; // weak
int dword_40210C; // weak
int dword_402110; // weak
int dword_402114; // weak
int dword_402118; // weak
char byte_40211C; // weak
int (__stdcall *dword_402124)(_DWORD, _DWORD); // weak
int dword_402128; // weak


//----- (00401030) --------------------------------------------------------
_BYTE *__stdcall sub_401030(_BYTE *a1, _BYTE *a2, int a3)
{
  _BYTE *result; // eax
  int i; // ecx

  result = a2;
  for ( i = a3; i; --i )
    *a1++ = *result++;
  return result;
}

//----- (0040104F) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
int __usercall sub_40104F@<eax>(int a1@<ebx>, int a2@<esi>)
{
  return a2 + *(_DWORD *)(a1 + 40);
}
// 401059: positive sp value 14 has been found
// 40104F: could not find valid save-restore pair for ebp
// 40104F: could not find valid save-restore pair for edi

//----- (0040105A) --------------------------------------------------------
int sub_40105A()
{
  int v0; // ebx
  _BYTE *v1; // esi
  _DWORD *v2; // edi
  int v4; // [esp+1Ch] [ebp-4h]

  v0 = *(_DWORD *)(dword_402100 + 60) + dword_402100;
  dword_402128 = *(_DWORD *)(v0 + 52);
  v4 = *(unsigned __int8 *)(v0 + 6);
  v1 = VirtualAlloc(*(LPVOID *)(v0 + 52), *(_DWORD *)(v0 + 80), 0x3000u, 0x40u);
  sub_401030(v1, (_BYTE *)dword_402100, *(_DWORD *)(v0 + 84));
  v2 = (_DWORD *)(v0 + 248);
  do
  {
    sub_401030(&v1[v2[3]], (_BYTE *)(v2[5] + dword_402100), v2[4]);
    v2 += 10;
    --v4;
  }
  while ( v4 );
  return sub_40104F(v0, (int)v1);
}
// 402128: using guessed type int dword_402128;

//----- (004010D8) --------------------------------------------------------
void __stdcall sub_4010D8(_BYTE *a1, int a2)
{
  do
  {
    *a1 += 4;
    --*a1;
    *a1 += 47;
    ++*a1++;
    --a2;
  }
  while ( a2 );
  dword_402008 += 4;
}
// 402008: using guessed type int dword_402008;

//----- (004010FD) --------------------------------------------------------
void sub_4010FD()
{
  unsigned int v0; // esi
  HANDLE v1; // eax
  void *v2; // esp
  HANDLE v3; // eax
  int v4; // ecx
  void *v5; // esp
  int v6; // ecx
  _BYTE *v7; // [esp+0h] [ebp-28h]
  _BYTE *v8; // [esp+4h] [ebp-24h]
  int v9; // [esp+8h] [ebp-20h]
  SIZE_T v10; // [esp+14h] [ebp-14h]

  v0 = ((unsigned int)sub_4010FD & 0xFFFF0000) + 20616;
  dword_402000 = *(_DWORD *)(((unsigned int)sub_4010FD & 0xFFFF0000) + 0x5074);
  dword_402004 = 8 * dword_402000;
  v1 = HeapCreate(1u, 0, v10);
  v2 = alloca(4);
  v3 = HeapCreate(8u, (SIZE_T)v1, dword_402000);
  v4 = dword_40200C + dword_402000;
  do
  {
    ++dword_40200C;
    --v4;
  }
  while ( v4 );
  dword_402008 = (int)v3;
  v5 = alloca(4);
  v6 = 2;
  do
  {
    v7 = (_BYTE *)v0;
    v0 = dword_402008;
    --v6;
  }
  while ( v6 );
  sub_401030(v7, v8, v9);
  sub_4010D8((_BYTE *)dword_402008, dword_402000);
}
// 401151: variable 'v10' is possibly undefined
// 4011D2: variable 'v8' is possibly undefined
// 4011D2: variable 'v9' is possibly undefined
// 402000: using guessed type int dword_402000;
// 402004: using guessed type int dword_402004;
// 402008: using guessed type int dword_402008;
// 40200C: using guessed type int dword_40200C;

//----- (004011EC) --------------------------------------------------------
int sub_4011EC()
{
  return 0;
}

//----- (004011FC) --------------------------------------------------------
void __spoils<ecx> sub_4011FC()
{
  _DWORD *v0; // ebx
  _DWORD *v1; // esi
  FARPROC *v2; // edi
  HMODULE hModule; // [esp+0h] [ebp-4h]

  v0 = (_DWORD *)(dword_402128 + *(_DWORD *)(dword_402128 + *(_DWORD *)(dword_402128 + 60) + 128));
  do
  {
    hModule = LoadLibraryA((LPCSTR)(dword_402128 + v0[3]));
    v1 = (_DWORD *)(dword_402128 + *v0);
    v2 = (FARPROC *)(dword_402128 + v0[4]);
    do
      *v2++ = GetProcAddress(hModule, (LPCSTR)(dword_402128 + *v1++ + 2));
    while ( *v1 );
    v0 += 5;
  }
  while ( v0[3] );
}
// 402128: using guessed type int dword_402128;

//----- (00401291) --------------------------------------------------------
int sub_401291()
{
  sub_4011FC();
  return ((int (*)(void))loc_401276)();
}

//----- (004012A6) --------------------------------------------------------
FARPROC __stdcall sub_4012A6(int a1, FARPROC *a2)
{
  HMODULE v2; // eax
  FARPROC result; // eax

  v2 = LoadLibraryA("ntdll.dll");
  if ( a1 )
    result = GetProcAddress(v2, "ZwSetContextThread");
  else
    result = GetProcAddress(v2, "ZwGetContextThread");
  *a2 = result;
  return result;
}

//----- (004012FC) --------------------------------------------------------
LPVOID __stdcall sub_4012FC(int a1, SIZE_T dwBytes)
{
  HANDLE v2; // eax
  LPVOID result; // eax

  v2 = HeapCreate(1u, 0, 0);
  result = HeapAlloc(v2, 8u, dwBytes);
  *(_DWORD *)a1 = result;
  return result;
}

//----- (00401320) --------------------------------------------------------
int sub_401320()
{
  _BYTE *v0; // ebx
  int v1; // edx
  int result; // eax

  v0 = (_BYTE *)dword_402104;
  v1 = 256;
  result = 160;
  do
  {
    *v0 = 1;
    v0[1] = v1;
    v0 += 160;
    LOBYTE(v1) = v1 + 1;
  }
  while ( (_BYTE)v1 );
  dword_402110 = v1;
  return result;
}
// 402110: using guessed type int dword_402110;

//----- (00401344) --------------------------------------------------------
int __usercall sub_401344@<eax>(int a1@<esi>)
{
  unsigned int *v1; // ebx
  int result; // eax
  int v3; // edx
  unsigned __int32 v4; // edi
  int v5; // [esp-10h] [ebp-14h]

  v1 = (unsigned int *)dword_402008;
  result = sub_4011EC();
  v5 = a1;
  do
  {
    --a1;
    v4 = _byteswap_ulong(*v1) << v3 >> 31;
    if ( v4 )
      result += v4 << a1;
    if ( ++v3 == 32 )
    {
      ++v1;
      v3 = 0;
    }
  }
  while ( a1 );
  dword_40210C += v5;
  return result;
}
// 401374: variable 'v3' is possibly undefined
// 402008: using guessed type int dword_402008;
// 40210C: using guessed type int dword_40210C;

//----- (004013A0) --------------------------------------------------------
void __stdcall sub_4013A0(int a1)
{
  qmemcpy(byte_402010, (const void *)(160 * a1 + dword_402104), *(unsigned __int8 *)(160 * a1 + dword_402104) + 1);
}

//----- (004013CA) --------------------------------------------------------
int sub_4013CA()
{
  int result; // eax

  ++byte_402010[0];
  result = (unsigned __int8)byte_40211C;
  byte_402010[byte_402010[0]] = byte_40211C;
  return result;
}
// 40211C: using guessed type char byte_40211C;

//----- (004013E4) --------------------------------------------------------
void sub_4013E4()
{
  unsigned __int8 *v0; // edi
  int v1; // ecx

  v0 = (unsigned __int8 *)(dword_402114 + dword_402100);
  v1 = byte_402010[0];
  dword_402114 += byte_402010[0];
  qmemcpy(v0, &byte_402010[1], byte_402010[0]);
  dword_402118 = (int)&v0[v1];
}
// 402114: using guessed type int dword_402114;
// 402118: using guessed type int dword_402118;

//----- (0040140E) --------------------------------------------------------
unsigned __int8 sub_40140E()
{
  unsigned __int8 result; // al

  result = byte_402010[1];
  byte_40211C = result;
  return result;
}
// 40211C: using guessed type char byte_40211C;

//----- (0040141F) --------------------------------------------------------
void sub_40141F()
{
  if ( dword_402110 == 512 )
  {
    dword_402110 = 256;
    dword_402108 = 9;
  }
}
// 402108: using guessed type int dword_402108;
// 402110: using guessed type int dword_402110;

//----- (00401442) --------------------------------------------------------
void sub_401442()
{
  _BYTE *v0; // ebx
  unsigned int v1; // ecx

  v0 = (_BYTE *)(160 * dword_402110 + dword_402104);
  v1 = byte_402010[0];
  *v0 = byte_402010[0];
  qmemcpy(v0 + 1, &byte_402010[1], v1);
  ++dword_402110;
  sub_40141F();
}
// 402110: using guessed type int dword_402110;

//----- (00401486) --------------------------------------------------------
int __usercall sub_401486@<eax>(int a1@<esi>)
{
  int result; // eax
  int v2; // [esp+Ch] [ebp-8h]
  int v3; // [esp+10h] [ebp-4h]

  sub_4012FC((int)&dword_402100, 0xEA60u);
  sub_4012FC((int)&dword_402104, 0xC35000u);
  sub_401320();
  dword_402108 = 9;
  v2 = sub_401344(a1);
  sub_4013A0(v2);
  sub_4013E4();
  LOBYTE(result) = sub_40140E();
  while ( dword_402004 - dword_40210C >= dword_402108 )
  {
    v3 = sub_401344(a1);
    if ( v3 <= dword_402110 - 1 )
    {
      sub_4013A0(v3);
    }
    else
    {
      sub_4013A0(v2);
      sub_4013CA();
    }
    sub_4013E4();
    sub_40140E();
    sub_4013A0(v2);
    sub_4013CA();
    sub_401442();
    result = v3;
    v2 = v3;
  }
  return result;
}
// 402004: using guessed type int dword_402004;
// 402108: using guessed type int dword_402108;
// 40210C: using guessed type int dword_40210C;
// 402110: using guessed type int dword_402110;

//----- (0040153D) --------------------------------------------------------
int sub_40153D()
{
  sub_40105A();
  return sub_401291();
}

//----- (00401549) --------------------------------------------------------
HANDLE __usercall sub_401549@<eax>(int a1@<ebp>)
{
  HANDLE result; // eax

  *(_DWORD *)(a1 - 8) = GetCurrentThread();
  result = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)(*(_DWORD *)(a1 + 12) + 1), 0, 4u, 0);
  *(_DWORD *)(a1 - 4) = result;
  return result;
}

//----- (00401575) --------------------------------------------------------
int __usercall sub_401575@<eax>(int a1@<ebp>)
{
  ResumeThread(*(HANDLE *)(a1 - 4));
  SuspendThread(*(HANDLE *)(a1 - 8));
  return nullsub_1();
}
// 401587: using guessed type int nullsub_1(void);

//----- (00401588) --------------------------------------------------------
int __usercall sub_401588@<eax>(int a1@<ebp>)
{
  int v2; // [esp-8h] [ebp-8h]

  *(_DWORD *)(a1 - 724) = 65538;
  GetThreadContext(*(HANDLE *)(a1 - 4), (LPCONTEXT)(a1 - 724));
  *(_DWORD *)(a1 - 724 + 176) = *(_DWORD *)(a1 + 12);
  v2 = *(_DWORD *)(a1 - 4);
  sub_4012A6(1, (FARPROC *)&dword_402124);
  dword_402124 = (int (__stdcall *)(_DWORD, _DWORD))((char *)dword_402124 + 5);
  return dword_402124(v2, a1 - 724);
}
// 402124: using guessed type int (__stdcall *dword_402124)(_DWORD, _DWORD);

//----- (004015D6) --------------------------------------------------------
int __stdcall sub_4015D6(int a1)
{
  int savedregs; // [esp+2D8h] [ebp+0h] BYREF

  sub_401549((int)&savedregs);
  sub_401588((int)&savedregs);
  return sub_401575((int)&savedregs);
}

//----- (004015F5) --------------------------------------------------------
int __usercall start@<eax>(int a1@<esi>)
{
  sub_4015D6((int)nullsub_2);
  sub_4010FD();
  sub_401486(a1);
  sub_40153D();
  return nullsub_2();
}
// 401616: using guessed type int nullsub_2(void);

// nfuncs=27 queued=25 decompiled=25 lumina nreq=0 worse=0 better=0
// ALL OK, 25 function(s) have been successfully decompiled
