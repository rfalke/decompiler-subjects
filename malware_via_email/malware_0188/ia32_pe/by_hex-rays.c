/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void __noreturn start(); // weak
void sub_401060();
void sub_401097();
void sub_4010D5();
char sub_4010F8();
int sub_401109();
int __cdecl sub_4011DA(int, int, int);
char *__stdcall sub_4011F4(_DWORD *);
void sub_401262();
int __stdcall sub_401293(int);
void __stdcall sub_4012BA(int);
char sub_4012E2();
int __stdcall sub_4012F8(int);
// int __usercall sub_401316@<eax>(int@<ebp>);
// int __usercall sub_401340@<eax>(int@<ebp>);
// int __usercall sub_40136A@<eax>(int@<ebp>);
int nullsub_2(void); // weak
void __stdcall sub_40137D(void *, const void *, unsigned int);
void __stdcall sub_401393(int a1);
void sub_4013FE();
_WORD *sub_40142A();
void __stdcall sub_401447(int a1, int (__stdcall *a2)(int, const char *));
void __stdcall sub_40148B(int, _DWORD *, int);
void sub_401579();
int sub_40157F();
void sub_4015E2();
void sub_4015E7();
void sub_4015EC();
void __stdcall sub_401672(_BYTE *, int);
int sub_401690();

//-------------------------------------------------------------------------
// Data declarations

// extern void (__stdcall *Sleep)(DWORD dwMilliseconds);
// extern void (__stdcall __noreturn *ExitProcess)(UINT uExitCode);
_UNKNOWN loc_40101F; // weak
_UNKNOWN loc_4010BA; // weak
char byte_401578 = '\0'; // weak
int (__stdcall *dword_402000)(_DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_402004)(_DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_402008)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_40200C)(_DWORD); // weak
int (__stdcall *dword_402010)(_DWORD); // weak
int (__stdcall *dword_402014)(_DWORD, _DWORD, _DWORD, _DWORD); // weak
int (*dword_402018)(void); // weak
int (__stdcall *dword_40201C)(_DWORD, _DWORD); // weak
int (__stdcall *dword_402020)(_DWORD, _DWORD); // weak
int (__cdecl *dword_402024)(_DWORD); // weak
int (__stdcall *dword_402028)(_DWORD, _DWORD); // weak
int (__stdcall *dword_40202C)(_DWORD); // weak
_UNKNOWN unk_402030; // weak
_BYTE byte_402080[240]; // weak
int dword_402170; // weak
int dword_402174; // weak
int dword_402178; // weak
int dword_40217C; // weak
int dword_402180; // weak
int dword_402184; // weak
int dword_40218C; // weak
int dword_402190; // weak
int dword_402194; // weak
int dword_402198; // weak
int dword_40219C; // weak
int dword_4021A0; // weak
int dword_4021A4; // weak
int dword_4021A8; // weak
char byte_4021AC; // weak


//----- (00401010) --------------------------------------------------------
void __noreturn start()
{
  char *v0; // [esp-4h] [ebp-4h]

  sub_4013FE();
  sub_4012F8((int)&loc_40101F);
  sub_4015EC();
  sub_401109();
  v0 = sub_4011F4((_DWORD *)dword_402178);
  sub_401393(dword_402174);
  sub_401690();
  ((void (*)(void))loc_4010BA)();
  sub_401293((int)v0);
  Sleep(0x64u);
  ExitProcess(0);
}
// 401010: using guessed type void __noreturn start();
// 402174: using guessed type int dword_402174;
// 402178: using guessed type int dword_402178;

//----- (00401060) --------------------------------------------------------
void sub_401060()
{
  _BYTE *v0; // ebx
  unsigned int v1; // ecx

  v0 = (_BYTE *)(160 * dword_4021A4 + dword_4021A0);
  v1 = byte_402080[0];
  *v0 = byte_402080[0];
  qmemcpy(v0 + 1, &byte_402080[1], v1);
  ++dword_4021A4;
  sub_401097();
}
// 402080: using guessed type _BYTE byte_402080[240];
// 4021A0: using guessed type int dword_4021A0;
// 4021A4: using guessed type int dword_4021A4;

//----- (00401097) --------------------------------------------------------
void sub_401097()
{
  if ( dword_4021A4 == 512 )
  {
    dword_4021A4 = 256;
    dword_4021A8 = 9;
  }
}
// 4021A4: using guessed type int dword_4021A4;
// 4021A8: using guessed type int dword_4021A8;

//----- (004010D5) --------------------------------------------------------
void sub_4010D5()
{
  _BYTE *v0; // ebx
  int v1; // ecx

  v0 = (_BYTE *)dword_4021A0;
  v1 = 256;
  do
  {
    *v0 = 1;
    v0[1] = v1;
    v0 += 160;
    LOBYTE(v1) = v1 + 1;
  }
  while ( (_BYTE)v1 );
  dword_4021A4 = v1;
}
// 4021A0: using guessed type int dword_4021A0;
// 4021A4: using guessed type int dword_4021A4;

//----- (004010F8) --------------------------------------------------------
char sub_4010F8()
{
  char result; // al

  result = byte_402080[1];
  byte_4021AC = result;
  return result;
}
// 402080: using guessed type _BYTE byte_402080[240];
// 4021AC: using guessed type char byte_4021AC;

//----- (00401109) --------------------------------------------------------
int sub_401109()
{
  int result; // eax
  int v1; // [esp+0h] [ebp-14h]
  int v2; // [esp+4h] [ebp-10h]
  int v3; // [esp+8h] [ebp-Ch]
  int v4; // [esp+Ch] [ebp-8h]
  int v5; // [esp+10h] [ebp-4h]

  dword_402184 = dword_402004(1, 0, 0);
  dword_402178 = dword_402000(dword_402184, 8, 60000);
  dword_40218C = dword_402004(1, 0, 0);
  dword_4021A0 = sub_4011DA(v1, v2, v3);
  sub_4010D5();
  dword_4021A8 = 9;
  v4 = sub_40157F();
  sub_4012BA(v4);
  sub_401262();
  LOBYTE(result) = sub_4010F8();
  while ( dword_40219C - dword_402170 >= dword_4021A8 )
  {
    v5 = sub_40157F();
    if ( v5 <= dword_4021A4 - 1 )
    {
      sub_4012BA(v5);
    }
    else
    {
      sub_4012BA(v4);
      sub_4012E2();
    }
    sub_401262();
    sub_4010F8();
    sub_4012BA(v4);
    sub_4012E2();
    sub_401060();
    result = v5;
    v4 = v5;
  }
  return result;
}
// 401143: variable 'v1' is possibly undefined
// 401143: variable 'v2' is possibly undefined
// 401143: variable 'v3' is possibly undefined
// 402000: using guessed type int (__stdcall *dword_402000)(_DWORD, _DWORD, _DWORD);
// 402004: using guessed type int (__stdcall *dword_402004)(_DWORD, _DWORD, _DWORD);
// 402170: using guessed type int dword_402170;
// 402178: using guessed type int dword_402178;
// 402184: using guessed type int dword_402184;
// 40218C: using guessed type int dword_40218C;
// 40219C: using guessed type int dword_40219C;
// 4021A0: using guessed type int dword_4021A0;
// 4021A4: using guessed type int dword_4021A4;
// 4021A8: using guessed type int dword_4021A8;

//----- (004011DA) --------------------------------------------------------
int __cdecl sub_4011DA(int a1, int a2, int a3)
{
  return dword_402000(a1, a2, a3);
}
// 402000: using guessed type int (__stdcall *dword_402000)(_DWORD, _DWORD, _DWORD);

//----- (004011F4) --------------------------------------------------------
char *__stdcall sub_4011F4(_DWORD *a1)
{
  char *v1; // ebx
  char *v2; // esi
  _DWORD *v3; // edi
  int v5; // [esp+1Ch] [ebp-4h]

  v1 = (char *)a1 + a1[15];
  dword_402174 = *((_DWORD *)v1 + 13);
  v5 = (unsigned __int8)v1[6];
  v2 = (char *)dword_402014(*((_DWORD *)v1 + 13), *((_DWORD *)v1 + 20), 12288, 64);
  sub_40137D(v2, a1, *((_DWORD *)v1 + 21));
  v3 = v1 + 248;
  do
  {
    sub_40137D(&v2[v3[3]], (char *)a1 + v3[5], v3[4]);
    v3 += 10;
    --v5;
  }
  while ( v5 );
  return &v2[*((_DWORD *)v1 + 10)];
}
// 402014: using guessed type int (__stdcall *dword_402014)(_DWORD, _DWORD, _DWORD, _DWORD);
// 402174: using guessed type int dword_402174;

//----- (00401262) --------------------------------------------------------
void sub_401262()
{
  void *v0; // edi

  v0 = (void *)(dword_40217C + dword_402178);
  dword_40217C += byte_402080[0];
  qmemcpy(v0, &byte_402080[1], byte_402080[0]);
}
// 402080: using guessed type _BYTE byte_402080[240];
// 402178: using guessed type int dword_402178;
// 40217C: using guessed type int dword_40217C;

//----- (00401293) --------------------------------------------------------
int __stdcall sub_401293(int a1)
{
  int v1; // eax

  dword_402008(0, 0, a1, 0, 0, 0);
  v1 = dword_402018();
  return dword_40200C(v1);
}
// 402008: using guessed type int (__stdcall *dword_402008)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 40200C: using guessed type int (__stdcall *dword_40200C)(_DWORD);
// 402018: using guessed type int (*dword_402018)(void);

//----- (004012BA) --------------------------------------------------------
void __stdcall sub_4012BA(int a1)
{
  qmemcpy(byte_402080, (const void *)(160 * a1 + dword_4021A0), *(unsigned __int8 *)(160 * a1 + dword_4021A0) + 1);
}
// 402080: using guessed type _BYTE byte_402080[240];
// 4021A0: using guessed type int dword_4021A0;

//----- (004012E2) --------------------------------------------------------
char sub_4012E2()
{
  char result; // al

  ++byte_402080[0];
  result = byte_4021AC;
  byte_402080[byte_402080[0]] = byte_4021AC;
  return result;
}
// 402080: using guessed type _BYTE byte_402080[240];
// 4021AC: using guessed type char byte_4021AC;

//----- (004012F8) --------------------------------------------------------
int __stdcall sub_4012F8(int a1)
{
  int savedregs; // [esp+2D8h] [ebp+0h] BYREF

  sub_401316((int)&savedregs);
  sub_401340((int)&savedregs);
  return sub_40136A((int)&savedregs);
}

//----- (00401316) --------------------------------------------------------
int __usercall sub_401316@<eax>(int a1@<ebp>)
{
  int result; // eax

  *(_DWORD *)(a1 - 8) = dword_402018();
  result = dword_402008(0, 0, *(_DWORD *)(a1 + 8) + 1, 0, 4, 0);
  *(_DWORD *)(a1 - 4) = result;
  return result;
}
// 402008: using guessed type int (__stdcall *dword_402008)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 402018: using guessed type int (*dword_402018)(void);

//----- (00401340) --------------------------------------------------------
int __usercall sub_401340@<eax>(int a1@<ebp>)
{
  *(_DWORD *)(a1 - 724) = 65538;
  dword_40201C(*(_DWORD *)(a1 - 4), a1 - 724);
  *(_DWORD *)(a1 - 724 + 176) = *(_DWORD *)(a1 + 8);
  return dword_402020(*(_DWORD *)(a1 - 4), a1 - 724);
}
// 40201C: using guessed type int (__stdcall *dword_40201C)(_DWORD, _DWORD);
// 402020: using guessed type int (__stdcall *dword_402020)(_DWORD, _DWORD);

//----- (0040136A) --------------------------------------------------------
int __usercall sub_40136A@<eax>(int a1@<ebp>)
{
  dword_402024(*(_DWORD *)(a1 - 4));
  dword_40200C(*(_DWORD *)(a1 - 8));
  return nullsub_2();
}
// 40137C: using guessed type int nullsub_2(void);
// 40200C: using guessed type int (__stdcall *dword_40200C)(_DWORD);
// 402024: using guessed type int (__cdecl *dword_402024)(_DWORD);

//----- (0040137D) --------------------------------------------------------
void __stdcall sub_40137D(void *a1, const void *a2, unsigned int a3)
{
  qmemcpy(a1, a2, a3);
}

//----- (00401393) --------------------------------------------------------
void __stdcall sub_401393(int a1)
{
  _DWORD *v1; // ebx
  _DWORD *v2; // esi
  _DWORD *v3; // edi
  int v4; // [esp+0h] [ebp-4h]

  v1 = (_DWORD *)(a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + 60) + 128));
  do
  {
    v4 = dword_40202C(a1 + v1[3]);
    v2 = (_DWORD *)(a1 + *v1);
    v3 = (_DWORD *)(a1 + v1[4]);
    do
      *v3++ = dword_402028(v4, a1 + *v2++ + 2);
    while ( *v2 );
    v1 += 5;
  }
  while ( v1[3] );
}
// 402028: using guessed type int (__stdcall *dword_402028)(_DWORD, _DWORD);
// 40202C: using guessed type int (__stdcall *dword_40202C)(_DWORD);

//----- (004013FE) --------------------------------------------------------
void sub_4013FE()
{
  int (__stdcall *v0)(int, const char *); // [esp+4h] [ebp-8h] BYREF
  _WORD *v1; // [esp+8h] [ebp-4h]

  v1 = sub_40142A();
  sub_40148B(1097035634, &v0, (int)v1);
  sub_401447((int)v1, v0);
}

//----- (0040142A) --------------------------------------------------------
_WORD *sub_40142A()
{
  _WORD *result; // eax

  result = (_WORD *)((int)NtCurrentTeb()->NtTib.ExceptionList->Handler & 0xFFFF0000);
  do
    result -= 0x8000;
  while ( *result != 23117 );
  return result;
}

//----- (00401447) --------------------------------------------------------
void __stdcall sub_401447(int a1, int (__stdcall *a2)(int, const char *))
{
  const char *v2; // esi
  _DWORD *v3; // ebx

  sub_40137D(&unk_402030, "HeapAlloc", &byte_401578 - "HeapAlloc");
  v2 = "HeapAlloc";
  v3 = &dword_402000;
  do
  {
    *v3++ = a2(a1, v2);
    do
      ++v2;
    while ( *v2 );
    ++v2;
  }
  while ( *v2 );
}
// 401578: using guessed type char byte_401578;
// 402000: using guessed type int (__stdcall *dword_402000)(_DWORD, _DWORD, _DWORD);

//----- (0040148B) --------------------------------------------------------
void __stdcall sub_40148B(int a1, _DWORD *a2, int a3)
{
  int v3; // edi
  int v4; // ecx
  _DWORD *i; // ebx

  v3 = a3 + *(_DWORD *)(a3 + *(_DWORD *)(a3 + 60) + 120);
  v4 = 0;
  for ( i = (_DWORD *)(a3 + *(_DWORD *)(v3 + 32)); a1 != *(_DWORD *)(a3 + *i + 4); ++i )
    ++v4;
  *a2 = a3 + *(_DWORD *)(4 * v4 + a3 + *(_DWORD *)(v3 + 28));
}

//----- (00401579) --------------------------------------------------------
void sub_401579()
{
  ;
}

//----- (0040157F) --------------------------------------------------------
int sub_40157F()
{
  unsigned int *v0; // ebx
  int v1; // edi
  unsigned __int32 v2; // esi
  int result; // eax
  int v4; // edx
  char v5; // zf
  int v6; // eax
  int v7; // [esp-4h] [ebp-10h]

  v0 = (unsigned int *)(4 * (dword_402170 / 0x20u) + dword_402190);
  v1 = dword_4021A8;
  v7 = dword_4021A8;
  do
  {
    --v1;
    v2 = _byteswap_ulong(*v0);
    sub_4015E7();
    sub_401579();
    if ( !v5 )
    {
      sub_4015E2();
      result = v2 + v6;
    }
    if ( v4 == 31 )
      ++v0;
  }
  while ( v1 );
  dword_402170 += v7;
  return result;
}
// 4015BC: variable 'v5' is possibly undefined
// 4015C3: variable 'v6' is possibly undefined
// 4015C9: variable 'v4' is possibly undefined
// 402170: using guessed type int dword_402170;
// 402190: using guessed type int dword_402190;
// 4021A8: using guessed type int dword_4021A8;

//----- (004015E2) --------------------------------------------------------
void sub_4015E2()
{
  ;
}

//----- (004015E7) --------------------------------------------------------
void sub_4015E7()
{
  ;
}

//----- (004015EC) --------------------------------------------------------
void sub_4015EC()
{
  dword_402198 = *(_DWORD *)(((unsigned int)&dword_402198 & 0xFFFF0000) + 0x5074);
  dword_40219C = 8 * dword_402198;
  dword_402180 = dword_402004(1, 0, 0);
  dword_402190 = dword_402000(dword_402180, 8, dword_402198);
  dword_402194 = dword_402198 + dword_402190;
  sub_40137D((void *)dword_402190, (const void *)(((unsigned int)&dword_402198 & 0xFFFF0000) + 20616), dword_402198);
  sub_401672((_BYTE *)dword_402190, dword_402198);
}
// 402000: using guessed type int (__stdcall *dword_402000)(_DWORD, _DWORD, _DWORD);
// 402004: using guessed type int (__stdcall *dword_402004)(_DWORD, _DWORD, _DWORD);
// 402180: using guessed type int dword_402180;
// 402190: using guessed type int dword_402190;
// 402194: using guessed type int dword_402194;
// 402198: using guessed type int dword_402198;
// 40219C: using guessed type int dword_40219C;

//----- (00401672) --------------------------------------------------------
void __stdcall sub_401672(_BYTE *a1, int a2)
{
  do
  {
    *a1++ += 64;
    --a2;
  }
  while ( a2 );
  dword_402190 += 4;
}
// 402190: using guessed type int dword_402190;

//----- (00401690) --------------------------------------------------------
int sub_401690()
{
  dword_402010(dword_402184);
  return dword_402010(dword_40218C);
}
// 402010: using guessed type int (__stdcall *dword_402010)(_DWORD);
// 402184: using guessed type int dword_402184;
// 40218C: using guessed type int dword_40218C;

// nfuncs=31 queued=29 decompiled=29 lumina nreq=0 worse=0 better=0
// ALL OK, 29 function(s) have been successfully decompiled
