/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// double __usercall sub_4014A1@<st0>(int@<edi>, double@<st0>);
void __noreturn sub_4015FA(); // weak
void __fastcall __noreturn sub_401643(_DWORD, _DWORD); // weak
HANDLE start();
SIZE_T __stdcall sub_4019B0(LPCVOID lpAddress);

//-------------------------------------------------------------------------
// Data declarations

// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// extern HANDLE (__stdcall *CreateFileMappingA)(HANDLE hFile, LPSECURITY_ATTRIBUTES lpFileMappingAttributes, DWORD flProtect, DWORD dwMaximumSizeHigh, DWORD dwMaximumSizeLow, LPCSTR lpName);
// extern LPVOID (__stdcall *MapViewOfFile)(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap);
// extern DWORD (__stdcall *GetCurrentProcessId)();
// extern SIZE_T (__stdcall *VirtualQuery)(LPCVOID lpAddress, PMEMORY_BASIC_INFORMATION lpBuffer, SIZE_T dwLength);
int dword_40129C[123] =
{
  -402098535,
  509,
  -326955781,
  1792839228,
  -399970800,
  654,
  -349388397,
  13233420,
  1979909392,
  -1982206420,
  327747923,
  69266816,
  -370473712,
  -339440016,
  -1983683391,
  1133319507,
  -437981692,
  268701935,
  785319248,
  199972163,
  1477203695,
  1359736395,
  1425403456,
  1376542363,
  -490475269,
  271323375,
  -1305934512,
  1575537667,
  1912603924,
  -398342638,
  324,
  650832891,
  273682671,
  -2131360432,
  -1185354341,
  1328,
  -520151557,
  52970907,
  274959891,
  539247001,
  -1947865487,
  1010828819,
  7008251,
  -998114830,
  1424,
  2022562299,
  274469103,
  -1872558768,
  270012655,
  -1419639472,
  124120455,
  183174416,
  50392384,
  1583285520,
  -396878853,
  1846,
  1292288896,
  1938380243,
  -1193415148,
  3896,
  189688,
  149640464,
  129691015,
  -437582576,
  284920,
  335854864,
  -991230704,
  272634095,
  -850066096,
  269488367,
  1830618448,
  271585519,
  -553843376,
  737644102,
  1587869408,
  -432565037,
  275255535,
  -525662896,
  269750511,
  -1247148720,
  992527507,
  -1961169190,
  1364201825,
  -399970750,
  1654,
  -1959137727,
  1407716689,
  -352320235,
  -1008439206,
  74647112,
  -351503205,
  -346072052,
  -205507070,
  -1946751301,
  -963965605,
  1233901347,
  1579019820,
  -351255397,
  1446708950,
  -940878777,
  -913977957,
  99288933,
  -217912111,
  -1595188043,
  -1357908761,
  -259301423,
  -1950749111,
  48874712,
  1272953595,
  271061231,
  1666778448,
  2087909959,
  -930351717,
  55570014,
  -1223745177,
  -1040304540,
  1996687350,
  727313932,
  56521448,
  861565673,
  56028880,
  1454217187,
  -352112227
}; // weak


//----- (004014A1) --------------------------------------------------------
double __usercall sub_4014A1@<st0>(int a1@<edi>, double a2@<st0>)
{
  return a2 * (double)*(__int16 *)(a1 + 90);
}

//----- (004015FA) --------------------------------------------------------
void __noreturn sub_4015FA()
{
  int *v0; // esi
  int v1; // ecx
  int v2; // eax
  int *v3; // edi
  int *v4; // [esp+0h] [ebp-18h]

  v0 = dword_40129C;
  v4 = (int *)VirtualAlloc(0, 0x8C4u, 0x3000u, 0x40u);
  v3 = v4;
  v1 = 562;
  while ( 1 )
  {
    v2 = *v0++;
    *v3++ = v2 ^ 0x510;
    if ( !--v1 )
      sub_401643(v4, 0x400000);
  }
}
// 40129C: using guessed type int dword_40129C[123];
// 4015FA: using guessed type void __noreturn sub_4015FA();
// 401643: using guessed type void __fastcall __noreturn sub_401643(_DWORD, _DWORD);

//----- (00401960) --------------------------------------------------------
HANDLE start()
{
  HANDLE result; // eax
  HANDLE v1; // [esp-4h] [ebp-4h]

  result = CreateFileMappingA((HANDLE)0xFFFFFFFF, 0, 4u, 0, 0x4000u, 0);
  if ( result )
  {
    v1 = result;
    GetCurrentProcessId();
    result = MapViewOfFile(v1, 6u, 0, 0, 0);
    if ( result )
      return (HANDLE)sub_4019B0(result);
  }
  return result;
}

//----- (004019B0) --------------------------------------------------------
SIZE_T __stdcall sub_4019B0(LPCVOID lpAddress)
{
  SIZE_T result; // eax
  struct _MEMORY_BASIC_INFORMATION v2; // [esp+0h] [ebp-1Ch] BYREF

  VirtualQuery(lpAddress, &v2, 0x1Cu);
  result = v2.RegionSize >> 12;
  *(PVOID *)((char *)&v2.BaseAddress + (v2.RegionSize >> 12)) = *(char **)((char *)&v2.BaseAddress
                                                                         + (v2.RegionSize >> 12))
                                                              + (v2.RegionSize >> 12);
  return result;
}

// nfuncs=5 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
