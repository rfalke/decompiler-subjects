/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

_DWORD start(); // weak
void __stdcall sub_401084(void *, const void *, unsigned int);
int sub_40109A();
char *__stdcall sub_4010F6(_DWORD *);
void sub_401164();
void __stdcall sub_4011EB(int a1);
BOOL sub_40126B();
void sub_401284();
void sub_4012A7();
void sub_4012D9();
char sub_4012FC();
void __stdcall sub_40130A(int);
char sub_401332();
void sub_401348();
DWORD __cdecl sub_40136C(void *);
DWORD __stdcall StartAddress(LPVOID lpThreadParameter); // idb
int (*sub_4013DA())(void);
int sub_401449();
DWORD __stdcall sub_401528(LPTHREAD_START_ROUTINE lpStartAddress);

//-------------------------------------------------------------------------
// Data declarations

// extern HANDLE (__stdcall *CreateThread)(LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId);
// extern FARPROC (__stdcall *GetProcAddress)(HMODULE hModule, LPCSTR lpProcName);
// extern BOOL (__stdcall *GetThreadContext)(HANDLE hThread, LPCONTEXT lpContext);
// extern LPVOID (__stdcall *HeapAlloc)(HANDLE hHeap, DWORD dwFlags, SIZE_T dwBytes);
// extern HANDLE (__stdcall *HeapCreate)(DWORD flOptions, SIZE_T dwInitialSize, SIZE_T dwMaximumSize);
// extern BOOL (__stdcall *HeapDestroy)(HANDLE hHeap);
// extern DWORD (__stdcall *ResumeThread)(HANDLE hThread);
// extern BOOL (__stdcall *SetThreadContext)(HANDLE hThread, const CONTEXT *lpContext);
// extern DWORD (__stdcall *SuspendThread)(HANDLE hThread);
// extern LPVOID (__stdcall *VirtualAlloc)(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
_UNKNOWN loc_40104C; // weak
char byte_401407 = 'é'; // weak
CONTEXT Context; // idb
_BYTE byte_4022CC[244]; // weak
int dword_4023C0; // weak
int dword_4023C4; // weak
int dword_4023C8; // weak
int dword_4023CC; // weak
SIZE_T dwBytes; // idb
int dword_4023D4; // weak
int dword_4023D8; // weak
int dword_4023DC; // weak
int dword_4023E0; // weak
int dword_4023E4; // weak
int dword_4023E8; // weak
int dword_4023EC; // weak
int dword_4023F0; // weak
HANDLE hHeap; // idb
HANDLE dword_4023F8; // idb
HANDLE hThread; // idb
HANDLE dword_402400; // idb
HMODULE hModule; // idb
int (__stdcall *dword_402408)(_DWORD); // weak
int (*dword_40240C)(void); // weak
char byte_402414; // weak


//----- (00401030) --------------------------------------------------------
#error "401047: call analysis failed (funcsize=12)"

//----- (00401084) --------------------------------------------------------
void __stdcall sub_401084(void *a1, const void *a2, unsigned int a3)
{
  qmemcpy(a1, a2, a3);
}

//----- (0040109A) --------------------------------------------------------
int sub_40109A()
{
  unsigned int v0; // edx
  unsigned int *v1; // ebx
  int v2; // edi
  int result; // eax
  unsigned __int32 v4; // esi

  v0 = dword_4023C4 % 0x20u;
  v1 = (unsigned int *)(4 * (dword_4023C4 / 0x20u) + dword_4023C8);
  v2 = dword_4023E0;
  result = 0;
  do
  {
    --v2;
    v4 = _byteswap_ulong(*v1) << v0 >> 31;
    if ( v4 )
      result += v4 << v2;
    if ( ++v0 == 32 )
    {
      ++v1;
      v0 = 0;
    }
  }
  while ( v2 );
  dword_4023C4 += dword_4023E0;
  return result;
}
// 4023C4: using guessed type int dword_4023C4;
// 4023C8: using guessed type int dword_4023C8;
// 4023E0: using guessed type int dword_4023E0;

//----- (004010F6) --------------------------------------------------------
char *__stdcall sub_4010F6(_DWORD *a1)
{
  char *v1; // ebx
  char *v2; // esi
  _DWORD *v3; // edi
  int v5; // [esp+1Ch] [ebp-4h]

  v1 = (char *)a1 + a1[15];
  dword_4023E4 = *((_DWORD *)v1 + 13);
  v5 = (unsigned __int8)v1[6];
  v2 = (char *)VirtualAlloc(*((LPVOID *)v1 + 13), *((_DWORD *)v1 + 20), 0x3000u, 0x40u);
  sub_401084(v2, a1, *((_DWORD *)v1 + 21));
  v3 = v1 + 248;
  do
  {
    sub_401084(&v2[v3[3]], (char *)a1 + v3[5], v3[4]);
    v3 += 10;
    --v5;
  }
  while ( v5 );
  return &v2[*((_DWORD *)v1 + 10)];
}
// 4023E4: using guessed type int dword_4023E4;

//----- (00401164) --------------------------------------------------------
void sub_401164()
{
  const void *v0; // esi
  _BYTE *v1; // edi
  SIZE_T v2; // ecx

  v0 = (const void *)(dword_4023C0 + 16520);
  dwBytes = *(_DWORD *)(dword_4023C0 + 16500);
  dword_4023D4 = 8 * dwBytes;
  dword_4023F0 = (int)HeapCreate(1u, 0, 0);
  dword_4023C8 = (int)HeapAlloc((HANDLE)dword_4023F0, 8u, dwBytes);
  dword_4023CC = dwBytes + dword_4023C8;
  sub_401084((void *)dword_4023C8, v0, dwBytes);
  v1 = (_BYTE *)dword_4023C8;
  v2 = dwBytes;
  do
  {
    *v1++ -= 51;
    --v2;
  }
  while ( v2 );
  ++dword_4023C8;
}
// 4023C0: using guessed type int dword_4023C0;
// 4023C8: using guessed type int dword_4023C8;
// 4023CC: using guessed type int dword_4023CC;
// 4023D4: using guessed type int dword_4023D4;
// 4023F0: using guessed type int dword_4023F0;

//----- (004011EB) --------------------------------------------------------
void __stdcall sub_4011EB(int a1)
{
  _DWORD *v1; // ebx
  _DWORD *v2; // esi
  FARPROC *v3; // edi
  HMODULE hModule; // [esp+0h] [ebp-4h]

  v1 = (_DWORD *)(a1 + *(_DWORD *)(a1 + *(_DWORD *)(a1 + 60) + 128));
  do
  {
    hModule = (HMODULE)dword_402408(a1 + v1[3]);
    v2 = (_DWORD *)(a1 + *v1);
    v3 = (FARPROC *)(a1 + v1[4]);
    do
      *v3++ = GetProcAddress(hModule, (LPCSTR)(a1 + *v2++ + 2));
    while ( *v2 );
    v1 += 5;
  }
  while ( v1[3] );
}
// 402408: using guessed type int (__stdcall *dword_402408)(_DWORD);

//----- (0040126B) --------------------------------------------------------
BOOL sub_40126B()
{
  HeapDestroy(hHeap);
  return HeapDestroy(dword_402400);
}

//----- (00401284) --------------------------------------------------------
void sub_401284()
{
  _BYTE *v0; // ebx
  int v1; // ecx

  v0 = (_BYTE *)dword_4023D8;
  v1 = 256;
  do
  {
    *v0 = 1;
    v0[1] = v1;
    v0 += 160;
    LOBYTE(v1) = v1 + 1;
  }
  while ( (_BYTE)v1 );
  dword_4023DC = v1;
}
// 4023D8: using guessed type int dword_4023D8;
// 4023DC: using guessed type int dword_4023DC;

//----- (004012A7) --------------------------------------------------------
void sub_4012A7()
{
  _BYTE *v0; // ebx
  unsigned int v1; // ecx

  v0 = (_BYTE *)(160 * dword_4023DC + dword_4023D8);
  v1 = byte_4022CC[0];
  *v0 = byte_4022CC[0];
  qmemcpy(v0 + 1, &byte_4022CC[1], v1);
  ++dword_4023DC;
  sub_4012D9();
}
// 4022CC: using guessed type _BYTE byte_4022CC[244];
// 4023D8: using guessed type int dword_4023D8;
// 4023DC: using guessed type int dword_4023DC;

//----- (004012D9) --------------------------------------------------------
void sub_4012D9()
{
  if ( dword_4023DC == 512 )
  {
    dword_4023DC = 256;
    dword_4023E0 = 9;
  }
}
// 4023DC: using guessed type int dword_4023DC;
// 4023E0: using guessed type int dword_4023E0;

//----- (004012FC) --------------------------------------------------------
char sub_4012FC()
{
  char result; // al

  result = byte_4022CC[1];
  byte_402414 = result;
  return result;
}
// 4022CC: using guessed type _BYTE byte_4022CC[244];
// 402414: using guessed type char byte_402414;

//----- (0040130A) --------------------------------------------------------
void __stdcall sub_40130A(int a1)
{
  qmemcpy(byte_4022CC, (const void *)(160 * a1 + dword_4023D8), *(unsigned __int8 *)(160 * a1 + dword_4023D8) + 1);
}
// 4022CC: using guessed type _BYTE byte_4022CC[244];
// 4023D8: using guessed type int dword_4023D8;

//----- (00401332) --------------------------------------------------------
char sub_401332()
{
  char result; // al

  ++byte_4022CC[0];
  result = byte_402414;
  byte_4022CC[byte_4022CC[0]] = byte_402414;
  return result;
}
// 4022CC: using guessed type _BYTE byte_4022CC[244];
// 402414: using guessed type char byte_402414;

//----- (00401348) --------------------------------------------------------
void sub_401348()
{
  void *v0; // edi

  v0 = (void *)(dword_4023EC + dword_4023E8);
  dword_4023EC += byte_4022CC[0];
  qmemcpy(v0, &byte_4022CC[1], byte_4022CC[0]);
}
// 4022CC: using guessed type _BYTE byte_4022CC[244];
// 4023E8: using guessed type int dword_4023E8;
// 4023EC: using guessed type int dword_4023EC;

//----- (0040136C) --------------------------------------------------------
DWORD __cdecl sub_40136C(void *a1)
{
  hThread = CreateThread(0, 0, StartAddress, 0, 4u, 0);
  dword_4023F8 = (HANDLE)dword_40240C();
  Context.ContextFlags = 65538;
  GetThreadContext(hThread, &Context);
  Context.Eax = (DWORD)&loc_40104C;
  SetThreadContext(hThread, &Context);
  ResumeThread(hThread);
  SuspendThread(dword_4023F8);
  return StartAddress(a1);
}
// 40240C: using guessed type int (*dword_40240C)(void);

//----- (004013DA) --------------------------------------------------------
int (*sub_4013DA())(void)
{
  HMODULE v0; // eax
  int (*result)(void); // eax

  v0 = (HMODULE)((int)NtCurrentTeb()->NtTib.ExceptionList->Handler & 0xFFFF0000);
  do
    v0 -= 0x4000;
  while ( *(_WORD *)v0 != 23117 );
  hModule = v0;
  dword_402408 = (int (__stdcall *)(_DWORD))GetProcAddress(v0, &byte_401407 + 1);
  result = GetProcAddress(hModule, "GetCurrentThread");
  dword_40240C = result;
  return result;
}
// 401407: using guessed type char byte_401407;
// 402408: using guessed type int (__stdcall *dword_402408)(_DWORD);
// 40240C: using guessed type int (*dword_40240C)(void);

//----- (00401449) --------------------------------------------------------
int sub_401449()
{
  int result; // eax
  int v1; // [esp+Ch] [ebp-8h]
  int v2; // [esp+10h] [ebp-4h]

  hHeap = HeapCreate(1u, 0, 0);
  dword_4023E8 = (int)HeapAlloc(hHeap, 8u, 0xEA60u);
  dword_402400 = HeapCreate(1u, 0, 0);
  dword_4023D8 = (int)HeapAlloc(dword_402400, 8u, 0xC35000u);
  sub_401284();
  dword_4023E0 = 9;
  v1 = sub_40109A();
  sub_40130A(v1);
  sub_401348();
  LOBYTE(result) = sub_4012FC();
  while ( dword_4023D4 - dword_4023C4 >= dword_4023E0 )
  {
    v2 = sub_40109A();
    if ( v2 <= dword_4023DC - 1 )
    {
      sub_40130A(v2);
    }
    else
    {
      sub_40130A(v1);
      sub_401332();
    }
    sub_401348();
    sub_4012FC();
    sub_40130A(v1);
    sub_401332();
    sub_4012A7();
    result = v2;
    v1 = v2;
  }
  return result;
}
// 4023C4: using guessed type int dword_4023C4;
// 4023D4: using guessed type int dword_4023D4;
// 4023D8: using guessed type int dword_4023D8;
// 4023DC: using guessed type int dword_4023DC;
// 4023E0: using guessed type int dword_4023E0;
// 4023E8: using guessed type int dword_4023E8;

//----- (00401528) --------------------------------------------------------
DWORD __stdcall sub_401528(LPTHREAD_START_ROUTINE lpStartAddress)
{
  void *v1; // eax

  CreateThread(0, 0, lpStartAddress, 0, 0, 0);
  v1 = (void *)dword_40240C();
  return SuspendThread(v1);
}
// 40240C: using guessed type int (*dword_40240C)(void);

// nfuncs=19 queued=18 decompiled=18 lumina nreq=0 worse=0 better=0
#error "There were 1 decompilation failure(s) on 18 function(s)"
