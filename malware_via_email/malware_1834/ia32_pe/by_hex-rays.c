/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

#define __thiscall __cdecl // Test compile in C mode

int __thiscall _ImageBase(void *this);
// int __usercall sub_400256@<eax>(int a1@<ebp>, _BYTE *a2@<edi>, _BYTE *a3@<esi>);
// __int64 __usercall sub_4002D2@<edx:eax>(char a1@<dl>, _BYTE *a2@<esi>);
int __fastcall sub_4002DC(_DWORD, _DWORD); // weak
// __int64 __usercall sub_4002DE@<edx:eax>(__int64 result@<edx:eax>, _BYTE *a2@<esi>);
// BOOL __stdcall VirtualProtect(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);

//-------------------------------------------------------------------------
// Data declarations

int dword_400094[30] =
{
  4176,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0
}; // weak
int _IMPORT_DESCRIPTOR_KERNEL32 = 0; // weak
__int16 word_412074 = 230; // weak
int dword_412078[24546]; // weak


//----- (00400000) --------------------------------------------------------
// write access to const memory has been detected, the output may be wrong!
// positive sp value has been detected, the output may be wrong!
int __thiscall _ImageBase(void *this)
{
  int *i; // esi
  int v2; // ecx
  int v3; // edi
  int v4; // ecx
  int *v5; // ecx
  int j; // edx
  int v7; // eax
  int v8; // eax
  int v9; // eax
  int *v11; // [esp-24h] [ebp-28h]
  int v12; // [esp-20h] [ebp-24h]
  _DWORD v13[2]; // [esp-4h] [ebp-8h] BYREF

  v13[0] = v13;
  ((void (__fastcall *)(void *, _DWORD, int, int, int))VirtualProtect)(this, v13[1], 0x400000, 4096, 4);
  dword_400094[0] = 40960;
  qmemcpy((char *)&dword_412078[7108] + 2, &_IMPORT_DESCRIPTOR_KERNEL32, 0x11074u);
  qmemcpy((char *)&dword_412078[24545] + 2, &word_412074, 2u);
  sub_400256(0x400000, &_IMPORT_DESCRIPTOR_KERNEL32, (_BYTE *)&dword_412078[8111] + 2);
  for ( i = dword_412078 + 20852; ; i += 5 )
  {
    v2 = i[3];
    if ( !v2 )
      JUMPOUT(0x403D1C);
    v3 = (*(int (__cdecl **)(int))((char *)&dword_412078[7118] + 2))(v2 + 0x400000);
    v4 = *i;
    if ( !*i )
      v4 = i[4];
    if ( !v4 )
      break;
    v5 = (int *)(v4 + 0x400000);
    for ( j = i[4] + 0x400000; ; j = (int)(v11 + 1) )
    {
      v7 = *v5;
      if ( !*v5 )
        break;
      if ( v7 >= 0 )
        v8 = v7 + 4194306;
      else
        v8 = (unsigned __int16)*v5;
      v9 = (*(int (__cdecl **)(int, int, int, int *))((char *)&dword_412078[7119] + 2))(v3, v8, j, v5);
      if ( !v9 )
        return -1;
      *v11 = v9;
      v5 = (int *)(v12 + 4);
    }
  }
  return -1;
}
// 400002: positive sp value 4 has been found
// 400195: write access to const memory at 400094 has been detected
// 40023A: variable 'v11' is possibly undefined
// 40023C: variable 'v12' is possibly undefined
// 400094: using guessed type int[30];
// 401000: using guessed type int _IMPORT_DESCRIPTOR_KERNEL32;
// 403750: using guessed type int[512];
// 412074: using guessed type __int16;
// 412078: using guessed type int[24546];

//----- (00400256) --------------------------------------------------------
int __usercall sub_400256@<eax>(int a1@<ebp>, _BYTE *a2@<edi>, _BYTE *a3@<esi>)
{
  __int64 v3; // rax
  int v4; // ebx
  __int64 v5; // rax
  int v6; // ecx
  unsigned int v7; // ecx
  char v8; // tt
  __int64 v9; // rax
  int v10; // ecx
  char v11; // cf

  BYTE4(v3) = 0x80;
  v4 = 0;
LABEL_2:
  *a2++ = *a3++;
  LOBYTE(v4) = 2;
  while ( 1 )
  {
    v3 = sub_4002D2(SBYTE4(v3), a3);
    if ( !v11 )
      goto LABEL_2;
    v5 = sub_4002D2(SBYTE4(v3), a3);
    if ( !v11 )
    {
      v9 = sub_4002DE(v5, a3);
      if ( v10 == v4 )
      {
        sub_4002DC(0, HIDWORD(v9));
LABEL_20:
        LODWORD(v3) = a1;
        LOBYTE(v4) = 1;
        goto LABEL_21;
      }
      ++a3;
      LODWORD(v3) = sub_4002DC(v9, HIDWORD(v9));
      if ( (unsigned int)v3 < 0x7D00 )
      {
        if ( BYTE1(v3) >= 5u )
        {
LABEL_18:
          ++v7;
          goto LABEL_19;
        }
        if ( (unsigned int)v3 > 0x7F )
        {
LABEL_19:
          a1 = v3;
          goto LABEL_20;
        }
      }
LABEL_17:
      ++v7;
      goto LABEL_18;
    }
    v3 = sub_4002D2(SBYTE4(v5), a3);
    if ( !v11 )
      break;
    LOBYTE(v4) = 2;
    do
    {
      v3 = sub_4002D2(SBYTE4(v3), a3);
      v8 = v11 + v3;
      v11 = __CFADD__(v11, (_BYTE)v3) | __CFADD__((_BYTE)v3, v11 + v3);
      LOBYTE(v3) = v3 + v8;
    }
    while ( !v11 );
    if ( (_BYTE)v3 )
    {
LABEL_21:
      qmemcpy(a2, &a2[-v3], v7);
      a2 += v7;
    }
    else
    {
      *a2++ = 0;
    }
  }
  LOBYTE(v3) = *a3++;
  v11 = v3 & 1;
  LODWORD(v3) = (unsigned int)v3 >> 1;
  if ( (_DWORD)v3 )
  {
    v7 = v6 + v11 + v6;
    goto LABEL_17;
  }
  return v3;
}
// 400260: variable 'v3' is possibly undefined
// 400265: variable 'v11' is possibly undefined
// 400291: variable 'v10' is possibly undefined
// 4002A1: variable 'v6' is possibly undefined
// 4002C1: variable 'v7' is possibly undefined
// 4002DC: using guessed type int __fastcall sub_4002DC(_DWORD, _DWORD);

//----- (004002D2) --------------------------------------------------------
__int64 __usercall sub_4002D2@<edx:eax>(char a1@<dl>, _BYTE *a2@<esi>)
{
  bool v2; // cf
  __int64 result; // rax

  v2 = __CFADD__(a1, a1);
  BYTE4(result) = 2 * a1;
  if ( !BYTE4(result) )
    BYTE4(result) = *a2 + v2 + *a2;
  return result;
}

//----- (004002DE) --------------------------------------------------------
__int64 __usercall sub_4002DE@<edx:eax>(__int64 result@<edx:eax>, _BYTE *a2@<esi>)
{
  __int64 v2; // rax
  char v3; // cf

  do
  {
    v2 = sub_4002D2(SBYTE4(result), a2);
    result = sub_4002D2(SBYTE4(v2), a2);
  }
  while ( v3 );
  return result;
}
// 4002EB: variable 'v3' is possibly undefined

// nfuncs=5 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
