/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// LPVOID __stdcall MapViewOfFile(HANDLE hFileMappingObject, DWORD dwDesiredAccess, DWORD dwFileOffsetHigh, DWORD dwFileOffsetLow, SIZE_T dwNumberOfBytesToMap);
// DWORD __stdcall GetCurrentProcessId();
// SIZE_T __stdcall VirtualQuery(LPCVOID lpAddress, PMEMORY_BASIC_INFORMATION lpBuffer, SIZE_T dwLength);
// LPVOID __stdcall VirtualAlloc(LPVOID lpAddress, SIZE_T dwSize, DWORD flAllocationType, DWORD flProtect);
// HANDLE __stdcall CreateFileMappingA(HANDLE hFile, LPSECURITY_ATTRIBUTES lpFileMappingAttributes, DWORD flProtect, DWORD dwMaximumSizeHigh, DWORD dwMaximumSizeLow, LPCSTR lpName);
// BOOL __stdcall VirtualFree(LPVOID lpAddress, SIZE_T dwSize, DWORD dwFreeType);
int sub_401159(); // weak
// double __usercall sub_4014A8@<st0>(int _EAX@<eax>, int a2@<ebx>, int a3@<ebp>, _DWORD *a4@<edi>, double a5@<st0>);
void __noreturn sub_401571(); // weak
int __fastcall sub_401583(_DWORD, _DWORD); // weak
HANDLE start();
SIZE_T __stdcall sub_40174D(LPCVOID lpAddress);


//----- (004014A8) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
double __usercall sub_4014A8@<st0>(int _EAX@<eax>, int a2@<ebx>, int a3@<ebp>, _DWORD *a4@<edi>, double a5@<st0>)
{
  int *v5; // edi
  double result; // st7
  int v7; // eax
  int v8; // [esp-4h] [ebp-4h]

  *a4 = _EAX;
  v5 = a4 + 1;
  *(_BYTE *)(a3 + 19) <<= v8;
  __asm { aaa }
  result = a5 * (double)*(int *)(a2 - 910241017);
  v7 = v8 ^ _EAX;
  LOBYTE(v7) = v7 ^ 0x91;
  if ( (_BYTE)v7 )
    JUMPOUT(0x40152E);
  *v5 = v7;
  return result;
}
// 4014AA: positive sp value 4 has been found
// 4014C4: control flows out of bounds to 40152E
// 4014AA: variable 'v8' is possibly undefined

//----- (00401571) --------------------------------------------------------
void __noreturn sub_401571()
{
  int *v0; // edi
  int (*v1)(); // esi
  int v2; // ecx
  int v3; // eax
  int *v4; // [esp+0h] [ebp-18h]

  v1 = sub_401159;
  v4 = (int *)VirtualAlloc(0, 0x8B4u, 0x3000u, 0x40u);
  v0 = v4;
  v2 = 558;
  do
  {
    v3 = *(_DWORD *)v1;
    v1 = (int (*)())((char *)v1 + 4);
    *v0++ = v3 ^ 0xDC;
    --v2;
  }
  while ( v2 );
  sub_401583(v4, 0x400000);
}
// 401159: using guessed type int sub_401159();
// 401571: using guessed type void __noreturn sub_401571();
// 401583: using guessed type int __fastcall sub_401583(_DWORD, _DWORD);

//----- (004016FD) --------------------------------------------------------
HANDLE start()
{
  HANDLE result; // eax
  void *v1; // [esp-4h] [ebp-4h]

  result = CreateFileMappingA((HANDLE)0xFFFFFFFF, 0, 4u, 0, 0x4000u, 0);
  if ( result )
  {
    v1 = result;
    GetCurrentProcessId();
    result = MapViewOfFile(v1, 6u, 0, 0, 0);
    if ( result )
      result = (HANDLE)sub_40174D(result);
  }
  return result;
}

//----- (0040174D) --------------------------------------------------------
SIZE_T __stdcall sub_40174D(LPCVOID lpAddress)
{
  SIZE_T result; // eax
  struct _MEMORY_BASIC_INFORMATION v2; // [esp+0h] [ebp-1Ch] BYREF

  VirtualQuery(lpAddress, &v2, 0x1Cu);
  result = v2.RegionSize >> 12;
  *(PVOID *)((char *)&v2.BaseAddress + (v2.RegionSize >> 12)) = *(char **)((char *)&v2.BaseAddress
                                                                         + (v2.RegionSize >> 12))
                                                              + (v2.RegionSize >> 12);
  return result;
}

// nfuncs=6 queued=4 decompiled=4 lumina nreq=0 worse=0 better=0
// ALL OK, 4 function(s) have been successfully decompiled
